
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="TDDで学ぶPython機械学習プログラミング">
      
      
        <meta name="author" content="Project Team">
      
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>データで学ぶPython! TDDではじめる機械学習プログラミング - Site Name</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../docs/mkdocs/assets/css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#python-tdd" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Site Name" class="md-header__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Site Name
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              データで学ぶPython! TDDではじめる機械学習プログラミング
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Site Name" class="md-nav__button md-logo" aria-label="Site Name" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Site Name
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/k2works/claude-code-booster" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    claude-code-booster
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="python-tdd">データで学ぶPython! TDDではじめる機械学習プログラミング<a class="headerlink" href="#python-tdd" title="Permanent link">&para;</a></h1>
<h2 id="_1">はじめに<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>本記事は、テスト駆動開発（TDD）を実践しながら Python で機械学習を学ぶプロジェクトの完全ガイドです。３章から８章までの6つの段階を通じて、データ処理の基礎から実用的な機械学習 API まで、段階的にスキルアップできる構成になっています。</p>
<p>「機械学習って難しそう...」「数式ばかりでわからない...」「どこから手をつければいいの？」</p>
<p>そんな不安を持っているあなたも大丈夫！この記事では、<strong>テストを書きながら一歩ずつ確実に進んでいく</strong>ので、プログラミング初心者でも安心して機械学習の世界に飛び込めます。実際に動くコードを書きながら、データから価値を引き出す楽しさを体験しましょう！</p>
<h3 id="_2">🎯 本記事で学べること<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>テスト駆動開発（TDD）の実践</strong>: Red-Green-Refactor サイクルを実機械学習開発で体験</li>
<li><strong>Python 機械学習開発</strong>: scikit-learn による実践的なモデル構築</li>
<li><strong>現代的 Python 開発</strong>: uv、Ruff、mypy 等の最新ツールチェーン</li>
<li><strong>段階的スキルアップ</strong>: 無理のない学習曲線で確実にレベルアップ</li>
</ul>
<h3 id="_3">📚 学習の進め方<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>各章は以下の構成になっています：</p>
<ol>
<li><strong>学習目標</strong>: その章で何を学ぶかを明確化</li>
<li><strong>実装した機能</strong>: 実際に作るコードの全体像</li>
<li><strong>TDD 実践例</strong>: Red-Green-Refactor の実例</li>
<li><strong>主要な学習ポイント</strong>: 深掘りした技術解説</li>
<li><strong>技術的成果</strong>: その章での達成事項まとめ</li>
</ol>
<p>最初の章から順番に進めることをおすすめしますが、気になる章から始めてもOKです！</p>
<hr />
<h2 id="1">１章 機械学習とは<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<h3 id="_4">機械学習の魅力<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>機械学習は、データからパターンを学習し、予測や分類を行う技術です。従来のプログラミングとは大きく異なる、<strong>データ駆動</strong>のアプローチが特徴です。</p>
<p><strong>従来のプログラミング</strong>:
<div class="highlight"><pre><span></span><code><span class="c1"># ルールを明示的にコーディング</span>
<span class="k">if</span> <span class="n">花びらの長さ</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">花びらの幅</span> <span class="o">&gt;</span> <span class="mf">1.5</span><span class="p">:</span>
    <span class="n">種類</span> <span class="o">=</span> <span class="s2">&quot;バージニカ&quot;</span>
<span class="k">elif</span> <span class="n">花びらの長さ</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">種類</span> <span class="o">=</span> <span class="s2">&quot;バーシクル&quot;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">種類</span> <span class="o">=</span> <span class="s2">&quot;セトサ&quot;</span>
</code></pre></div></p>
<p><strong>機械学習のアプローチ</strong>:
<div class="highlight"><pre><span></span><code><span class="c1"># データからルールを自動学習</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">訓練データ</span><span class="p">,</span> <span class="n">正解ラベル</span><span class="p">)</span>  <span class="c1"># データから学習！</span>

<span class="c1"># 未知のデータを予測</span>
<span class="n">予測結果</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">新しいデータ</span><span class="p">)</span>
</code></pre></div></p>
<p>この違い、わかりますか？機械学習では<strong>「ルールを書く」のではなく「データに学ばせる」</strong>のです！</p>
<h3 id="_5">機械学習ができること<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>機械学習は私たちの生活のあちこちで活躍しています：</p>
<ul>
<li><strong>📧 スパムメール検知</strong>: あなたの受信箱を守る</li>
<li><strong>🎬 映画レコメンド</strong>: 次に観たい作品を提案</li>
<li><strong>🏠 不動産価格予測</strong>: 家の適正価格を算出</li>
<li><strong>🏥 病気の早期発見</strong>: 医療画像から異常を検出</li>
<li><strong>🚗 自動運転</strong>: 安全な運転をサポート</li>
</ul>
<h3 id="_6">本プロジェクトで作るもの<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>本プロジェクトでは、以下の4つの実践的な機械学習モデルを段階的に実装します：</p>
<p><strong>🌸 分類問題</strong> (離散的な値を予測):
- <strong>Iris 分類</strong>: アヤメの花を 3種類に分類（多クラス分類の基礎）
- <strong>Survived 分類</strong>: タイタニック号の乗客の生存を予測（二値分類の実践）</p>
<p><strong>📊 回帰問題</strong> (連続的な値を予測):
- <strong>Cinema 予測</strong>: 映画の興行収入を予測（線形回帰の基礎）
- <strong>Boston 予測</strong>: ボストンの住宅価格を予測（特徴量エンジニアリングの実践）</p>
<p>最後には、これら4つのモデルを <strong>FastAPI で Web API 化</strong>して、実際に使える形にします！</p>
<h4 id="_7">問題選択フローチャート<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkFDVElWSVRZIiBoZWlnaHQ9IjI2NHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NzU3cHg7aGVpZ2h0OjI2NHB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDc1NyAyNjQiIHdpZHRoPSI3NTdweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjxlbGxpcHNlIGN4PSIzNzkuNjE4NiIgY3k9IjIwIiBmaWxsPSIjMjIyMjIyIiByeD0iMTAiIHJ5PSIxMCIgc3R5bGU9InN0cm9rZTojMjIyMjIyO3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiNGMUYxRjEiIHBvaW50cz0iMzA4LjExOTEsNTAsNDUxLjExODEsNTAsNDYzLjExODEsNjIsNDUxLjExODEsNzQsMzA4LjExOTEsNzQsMjk2LjExOTEsNjIsMzA4LjExOTEsNTAiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjExIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0Mi45OTkiIHg9IjMwOC4xMTkxIiB5PSI2NS44MDgxIj4mIzIwMTA0OyYjMjgyMDQ7JiMxMjM3NTsmIzEyMzgzOyYjMTIzNTY7JiMxMjM5ODsmIzEyMzk5OyYjMjU5Njg7JiMyMDUxNjsmIzEyMzkxOyYjMTIzNzc7JiMxMjM2MzsmIzY1MzExOzwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMSIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxOS4wMDgzIiB4PSIyNzcuMTEwOCIgeT0iNTkuNDA1OCI+eWVzPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjExIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzLjcwMTciIHg9IjQ2My4xMTgxIiB5PSI1OS40MDU4Ij5ubzwvdGV4dD48cG9seWdvbiBmaWxsPSIjRjFGMUYxIiBwb2ludHM9Ijk3LjE3ODgsODQsMjg0LjE3NzYsODQsMjk2LjE3NzYsOTYsMjg0LjE3NzYsMTA4LDk3LjE3ODgsMTA4LDg1LjE3ODgsOTYsOTcuMTc4OCw4NCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTEiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTg2Ljk5ODciIHg9Ijk3LjE3ODgiIHk9Ijk5LjgwODEiPiYjMjYxNDQ7JiMzMDAxMTsmIzEyMzk4OyYjMzMyODg7JiMzNDg5MjsmIzIxNDU0OyYjMjA4Mzc7JiMxMjQzNDsmIzIwMTA0OyYjMjgyMDQ7JiMxMjM3NTsmIzEyMzgzOyYjMTIzNTY7JiMxMjM5MTsmIzEyMzc3OyYjMTIzNjM7JiM2NTMxMTs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTEiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTkuMDA4MyIgeD0iNjYuMTcwNSIgeT0iOTMuNDA1OCI+eWVzPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjExIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzLjcwMTciIHg9IjI5Ni4xNzc2IiB5PSI5My40MDU4Ij5ubzwvdGV4dD48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjMzLjk2ODgiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTI4LjM1NzciIHg9IjExIiB5PSIxMTgiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDguMzU3NyIgeD0iMjEiIHk9IjEzOS4xMzg3Ij5DaW5lbWEgQVBJICYjMTI0MzQ7JiMyMDM1MTsmIzI5OTkyOzwvdGV4dD48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjMzLjk2ODgiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTI0LjA5MjEiIHg9IjI0NC4xMzE1IiB5PSIxMTgiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDQuMDkyMSIgeD0iMjU0LjEzMTUiIHk9IjEzOS4xMzg3Ij5Cb3N0b24gQVBJICYjMTI0MzQ7JiMyMDM1MTsmIzI5OTkyOzwvdGV4dD48cG9seWdvbiBmaWxsPSIjRjFGMUYxIiBwb2ludHM9IjE5MC42NzgyLDE1Ny45Njg4LDIwMi42NzgyLDE2OS45Njg4LDE5MC42NzgyLDE4MS45Njg4LDE3OC42NzgyLDE2OS45Njg4LDE5MC42NzgyLDE1Ny45Njg4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cG9seWdvbiBmaWxsPSIjRjFGMUYxIiBwb2ludHM9IjQ4MC41NTk3LDg0LDY1Ni41NTg0LDg0LDY2OC41NTg0LDk2LDY1Ni41NTg0LDEwOCw0ODAuNTU5NywxMDgsNDY4LjU1OTcsOTYsNDgwLjU1OTcsODQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjExIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE3NS45OTg4IiB4PSI0ODAuNTU5NyIgeT0iOTkuODA4MSI+JiMxMjQ1MDsmIzEyNTE2OyYjMTI1MTM7JiMxMjM5ODsmIzMxMjc4OyYjMzkwMDY7JiMxMjQzNDsmIzIwOTk4OyYjMzkwMDY7JiMxMjM3NTsmIzEyMzgzOyYjMTIzNTY7JiMxMjM5MTsmIzEyMzc3OyYjMTIzNjM7JiM2NTMxMTs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTEiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTkuMDA4MyIgeD0iNDQ5LjU1MTQiIHk9IjkzLjQwNTgiPnllczwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMSIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMy43MDE3IiB4PSI2NjguNTU4NCIgeT0iOTMuNDA1OCI+bm88L3RleHQ+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzMy45Njg4IiByeD0iMTIuNSIgcnk9IjEyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjEwMC42NzIxIiB4PSI0MDguMjIzNiIgeT0iMTE4Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODAuNjcyMSIgeD0iNDE4LjIyMzYiIHk9IjEzOS4xMzg3Ij5JcmlzIEFQSSAmIzEyNDM0OyYjMjAzNTE7JiMyOTk5Mjs8L3RleHQ+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzMy45Njg4IiByeD0iMTIuNSIgcnk9IjEyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjEzNS4zMDY5IiB4PSI2MTAuOTA1IiB5PSIxMTgiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTUuMzA2OSIgeD0iNjIwLjkwNSIgeT0iMTM5LjEzODciPlN1cnZpdmVkIEFQSSAmIzEyNDM0OyYjMjAzNTE7JiMyOTk5Mjs8L3RleHQ+PHBvbHlnb24gZmlsbD0iI0YxRjFGMSIgcG9pbnRzPSI1NjguNTU5MSwxNTcuOTY4OCw1ODAuNTU5MSwxNjkuOTY4OCw1NjguNTU5MSwxODEuOTY4OCw1NTYuNTU5MSwxNjkuOTY4OCw1NjguNTU5MSwxNTcuOTY4OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHBvbHlnb24gZmlsbD0iI0YxRjFGMSIgcG9pbnRzPSIzNzkuNjE4NiwxODcuOTY4OCwzOTEuNjE4NiwxOTkuOTY4OCwzNzkuNjE4NiwyMTEuOTY4OCwzNjcuNjE4NiwxOTkuOTY4OCwzNzkuNjE4NiwxODcuOTY4OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PGVsbGlwc2UgY3g9IjM3OS42MTg2IiBjeT0iMjQyLjk2ODgiIGZpbGw9Im5vbmUiIHJ4PSIxMSIgcnk9IjExIiBzdHlsZT0ic3Ryb2tlOiMyMjIyMjI7c3Ryb2tlLXdpZHRoOjE7Ii8+PGVsbGlwc2UgY3g9IjM3OS42MTg2IiBjeT0iMjQyLjk2ODgiIGZpbGw9IiMyMjIyMjIiIHJ4PSI2IiByeT0iNiIgc3R5bGU9InN0cm9rZTojMjIyMjIyO3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHgxPSI4NS4xNzg4IiB4Mj0iNzUuMTc4OCIgeTE9Ijk2IiB5Mj0iOTYiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB4MT0iNzUuMTc4OCIgeDI9Ijc1LjE3ODgiIHkxPSI5NiIgeTI9IjExOCIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNzEuMTc4OCwxMDgsNzUuMTc4OCwxMTgsNzkuMTc4OCwxMDgsNzUuMTc4OCwxMTIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB4MT0iMjk2LjE3NzYiIHgyPSIzMDYuMTc3NiIgeTE9Ijk2IiB5Mj0iOTYiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB4MT0iMzA2LjE3NzYiIHgyPSIzMDYuMTc3NiIgeTE9Ijk2IiB5Mj0iMTE4Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzMDIuMTc3NiwxMDgsMzA2LjE3NzYsMTE4LDMxMC4xNzc2LDEwOCwzMDYuMTc3NiwxMTIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB4MT0iNzUuMTc4OCIgeDI9Ijc1LjE3ODgiIHkxPSIxNTEuOTY4OCIgeTI9IjE2OS45Njg4Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9Ijc1LjE3ODgiIHgyPSIxNzguNjc4MiIgeTE9IjE2OS45Njg4IiB5Mj0iMTY5Ljk2ODgiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE2OC42NzgyLDE2NS45Njg4LDE3OC42NzgyLDE2OS45Njg4LDE2OC42NzgyLDE3My45Njg4LDE3Mi42NzgyLDE2OS45Njg4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9IjMwNi4xNzc2IiB4Mj0iMzA2LjE3NzYiIHkxPSIxNTEuOTY4OCIgeTI9IjE2OS45Njg4Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9IjMwNi4xNzc2IiB4Mj0iMjAyLjY3ODIiIHkxPSIxNjkuOTY4OCIgeTI9IjE2OS45Njg4Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyMTIuNjc4MiwxNjUuOTY4OCwyMDIuNjc4MiwxNjkuOTY4OCwyMTIuNjc4MiwxNzMuOTY4OCwyMDguNjc4MiwxNjkuOTY4OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHgxPSI0NjguNTU5NyIgeDI9IjQ1OC41NTk3IiB5MT0iOTYiIHkyPSI5NiIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHgxPSI0NTguNTU5NyIgeDI9IjQ1OC41NTk3IiB5MT0iOTYiIHkyPSIxMTgiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjQ1NC41NTk3LDEwOCw0NTguNTU5NywxMTgsNDYyLjU1OTcsMTA4LDQ1OC41NTk3LDExMiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHgxPSI2NjguNTU4NCIgeDI9IjY3OC41NTg0IiB5MT0iOTYiIHkyPSI5NiIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHgxPSI2NzguNTU4NCIgeDI9IjY3OC41NTg0IiB5MT0iOTYiIHkyPSIxMTgiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjY3NC41NTg0LDEwOCw2NzguNTU4NCwxMTgsNjgyLjU1ODQsMTA4LDY3OC41NTg0LDExMiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHgxPSI0NTguNTU5NyIgeDI9IjQ1OC41NTk3IiB5MT0iMTUxLjk2ODgiIHkyPSIxNjkuOTY4OCIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHgxPSI0NTguNTU5NyIgeDI9IjU1Ni41NTkxIiB5MT0iMTY5Ljk2ODgiIHkyPSIxNjkuOTY4OCIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTQ2LjU1OTEsMTY1Ljk2ODgsNTU2LjU1OTEsMTY5Ljk2ODgsNTQ2LjU1OTEsMTczLjk2ODgsNTUwLjU1OTEsMTY5Ljk2ODgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB4MT0iNjc4LjU1ODQiIHgyPSI2NzguNTU4NCIgeTE9IjE1MS45Njg4IiB5Mj0iMTY5Ljk2ODgiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB4MT0iNjc4LjU1ODQiIHgyPSI1ODAuNTU5MSIgeTE9IjE2OS45Njg4IiB5Mj0iMTY5Ljk2ODgiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjU5MC41NTkxLDE2NS45Njg4LDU4MC41NTkxLDE2OS45Njg4LDU5MC41NTkxLDE3My45Njg4LDU4Ni41NTkxLDE2OS45Njg4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9IjI5Ni4xMTkxIiB4Mj0iMTkwLjY3ODIiIHkxPSI2MiIgeTI9IjYyIi8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9IjE5MC42NzgyIiB4Mj0iMTkwLjY3ODIiIHkxPSI2MiIgeTI9Ijg0Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxODYuNjc4Miw3NCwxOTAuNjc4Miw4NCwxOTQuNjc4Miw3NCwxOTAuNjc4Miw3OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHgxPSI0NjMuMTE4MSIgeDI9IjU2OC41NTkxIiB5MT0iNjIiIHkyPSI2MiIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHgxPSI1NjguNTU5MSIgeDI9IjU2OC41NTkxIiB5MT0iNjIiIHkyPSI4NCIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTY0LjU1OTEsNzQsNTY4LjU1OTEsODQsNTcyLjU1OTEsNzQsNTY4LjU1OTEsNzgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB4MT0iMTkwLjY3ODIiIHgyPSIxOTAuNjc4MiIgeTE9IjE4MS45Njg4IiB5Mj0iMTk5Ljk2ODgiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB4MT0iMTkwLjY3ODIiIHgyPSIzNjcuNjE4NiIgeTE9IjE5OS45Njg4IiB5Mj0iMTk5Ljk2ODgiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM1Ny42MTg2LDE5NS45Njg4LDM2Ny42MTg2LDE5OS45Njg4LDM1Ny42MTg2LDIwMy45Njg4LDM2MS42MTg2LDE5OS45Njg4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9IjU2OC41NTkxIiB4Mj0iNTY4LjU1OTEiIHkxPSIxODEuOTY4OCIgeTI9IjE5OS45Njg4Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9IjU2OC41NTkxIiB4Mj0iMzkxLjYxODYiIHkxPSIxOTkuOTY4OCIgeTI9IjE5OS45Njg4Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI0MDEuNjE4NiwxOTUuOTY4OCwzOTEuNjE4NiwxOTkuOTY4OCw0MDEuNjE4NiwyMDMuOTY4OCwzOTcuNjE4NiwxOTkuOTY4OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHgxPSIzNzkuNjE4NiIgeDI9IjM3OS42MTg2IiB5MT0iMzAiIHkyPSI1MCIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzc1LjYxODYsNDAsMzc5LjYxODYsNTAsMzgzLjYxODYsNDAsMzc5LjYxODYsNDQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB4MT0iMzc5LjYxODYiIHgyPSIzNzkuNjE4NiIgeTE9IjIxMS45Njg4IiB5Mj0iMjMxLjk2ODgiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM3NS42MTg2LDIyMS45Njg4LDM3OS42MTg2LDIzMS45Njg4LDM4My42MTg2LDIyMS45Njg4LDM3OS42MTg2LDIyNS45Njg4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PCEtLVNSQz1bQW92OUIyaFhvYW5KcTdZb2ctRlBaWk1GNndTX1JmcF9rQjdiU1VFd251dGhkcXRUeUJIWG9VRjZ2T3lSUHB2a3g3d19QeHdjR2FiNlFmdzJIY0xnaUlQT3R4Q1AydnZGc0dyS19nQVp1eU4yZGdWelZLelJicHZrY2VIWDdXdXBoOW1weXI5cDRuS1MwcG1MR0Roc3hkeS1QT0tyTHNmRVNRZzJIYnUtSzg1SlZkNTlWWHc2V2hvS3AzR2FQSTJ0RjZ2UXpCWHZvVUZjWEszZEY1LW54a04yVUswREpwbFFHMHAyM2w0aW9ZcDZ1dXBXcWdBb3BCQks1MW1FMFBEMFhuTzAwMDAwXS0tPjwvZz48L3N2Zz4=" class="uml" alt="uml diagram" title="" /></p>
<h2 id="2">２章 開発環境のセットアップ<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<p>さあ、機械学習の旅を始める準備をしましょう！といっても、難しいことはありません。必要なツールをサクッとインストールして、快適な開発環境を整えます。</p>
<h3 id="python">現代的 Python 開発環境の構築<a class="headerlink" href="#python" title="Permanent link">&para;</a></h3>
<p>「環境構築って面倒...」と思ったあなた、安心してください！本プロジェクトでは、<strong>2024年最新の高速ツール</strong>を使うので、セットアップはあっという間に終わります。</p>
<h4 id="_8">🛠️ 必要なツール<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h4>
<p>以下のツールをインストールします。それぞれ強力な機能を持っていますが、今は「こんなのがあるんだな」程度の理解で OK です：</p>
<p><strong>開発の基盤</strong>:
- <strong>Python 3.10+</strong>: プログラミング言語本体（型ヒント機能を活用）
- <strong>uv</strong>: 爆速パッケージマネージャー（従来の pip より <strong>10-100倍速い</strong>！）</p>
<p><strong>品質管理ツール</strong>:
- <strong>Ruff</strong>: コード品質チェック（コードをキレイに保つ）
- <strong>mypy</strong>: 型チェック（バグを事前に発見）
- <strong>pytest</strong>: テストフレームワーク（TDD の要）</p>
<p><strong>機械学習ライブラリ</strong>:
- <strong>scikit-learn</strong>: 機械学習の定番ライブラリ（モデル構築に使用）
- <strong>pandas</strong>: データ分析ライブラリ（データ操作の必需品）
- <strong>FastAPI</strong>: 高性能 Web API フレームワーク（最終章で API 化に使用）</p>
<h4 id="_9">📦 セットアップ手順<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h4>
<p>ターミナルを開いて、以下のコマンドを順番に実行しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ステップ 1: プロジェクトフォルダを作成</span>
mkdir<span class="w"> </span>ml-tdd-project<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>ml-tdd-project

<span class="c1"># ステップ 2: uv でプロジェクトを初期化</span>
uv<span class="w"> </span>init

<span class="c1"># ステップ 3: 機械学習に必要なライブラリをインストール</span>
uv<span class="w"> </span>add<span class="w"> </span>pandas<span class="w"> </span>scikit-learn<span class="w"> </span>fastapi<span class="w"> </span>uvicorn

<span class="c1"># ステップ 4: 開発用ツールをインストール</span>
uv<span class="w"> </span>add<span class="w"> </span>--dev<span class="w"> </span>pytest<span class="w"> </span>pytest-cov<span class="w"> </span>ruff<span class="w"> </span>mypy
</code></pre></div>
<p>たったこれだけ！<code>uv</code> のおかげで、数秒でインストールが完了します。</p>
<h4 id="_10">⚙️ 品質管理設定<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h4>
<p>テストや品質チェックを自動化するため、<code>pyproject.toml</code> に設定を追加します：</p>
<div class="highlight"><pre><span></span><code><span class="k">[tool.ruff]</span>
<span class="n">line-length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">88</span><span class="w">              </span><span class="c1"># 1行の最大文字数</span>
<span class="n">target-version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;py310&quot;</span><span class="w">       </span><span class="c1"># Python 3.10 向けにチェック</span>

<span class="k">[tool.ruff.lint.mccabe]</span>
<span class="n">max-complexity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="w">             </span><span class="c1"># 複雑すぎる関数を警告</span>

<span class="k">[tool.mypy]</span>
<span class="n">python_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;3.10&quot;</span>
<span class="n">warn_return_any</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="n">warn_unused_configs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="n">disallow_untyped_defs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w">   </span><span class="c1"># 型ヒント必須</span>

<span class="k">[tool.pytest.ini_options]</span>
<span class="n">testpaths</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">]</span>
<span class="n">addopts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;--cov=src --cov-report=html --cov-report=term-missing&quot;</span>
</code></pre></div>
<p>この設定により、<strong>テストと品質チェックが自動化</strong>されます。コードを書くたびに品質が保証されるので、安心してリファクタリングできます！</p>
<p>各章では共通してこの環境を使用するため、<strong>最初のセットアップ以降は省略</strong>します。</p>
<h3 id="_11">プロジェクト構造の作成<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p>「フォルダをどう分けたらいいの？」そんな疑問も、この構造に従えば解決です！</p>
<p>以下のようなディレクトリ構成を作成します：</p>
<div class="highlight"><pre><span></span><code>ml-tdd-project/
├──<span class="w"> </span>src/<span class="w">                       </span><span class="c1"># 📝 ソースコード置き場</span>
│<span class="w">   </span>├──<span class="w"> </span>__init__.py
│<span class="w">   </span>└──<span class="w"> </span>ml/<span class="w">                    </span><span class="c1"># 機械学習モデル本体</span>
│<span class="w">       </span>├──<span class="w"> </span>__init__.py
│<span class="w">       </span>├──<span class="w"> </span>iris_classifier.py<span class="w">       </span><span class="c1"># アヤメ分類モデル</span>
│<span class="w">       </span>├──<span class="w"> </span>cinema_predictor.py<span class="w">      </span><span class="c1"># 映画興行収入予測モデル</span>
│<span class="w">       </span>├──<span class="w"> </span>survived_classifier.py<span class="w">   </span><span class="c1"># 生存予測モデル</span>
│<span class="w">       </span>└──<span class="w"> </span>boston_predictor.py<span class="w">      </span><span class="c1"># 住宅価格予測モデル</span>
├──<span class="w"> </span>test/<span class="w">                      </span><span class="c1"># ✅ テストコード置き場</span>
│<span class="w">   </span>├──<span class="w"> </span>__init__.py
│<span class="w">   </span>└──<span class="w"> </span>test_basic.py<span class="w">          </span><span class="c1"># 基本的な環境確認テスト</span>
├──<span class="w"> </span>data/<span class="w">                      </span><span class="c1"># 📊 データセット置き場</span>
│<span class="w">   </span>├──<span class="w"> </span>iris.csv
│<span class="w">   </span>├──<span class="w"> </span>cinema.csv
│<span class="w">   </span>├──<span class="w"> </span>Survived.csv
│<span class="w">   </span>└──<span class="w"> </span>Boston.csv
├──<span class="w"> </span>model/<span class="w">                     </span><span class="c1"># 💾 訓練済みモデルの保存先</span>
│<span class="w">   </span>└──<span class="w"> </span>.gitkeep
├──<span class="w"> </span>pyproject.toml<span class="w">             </span><span class="c1"># ⚙️ プロジェクト設定ファイル</span>
└──<span class="w"> </span>README.md<span class="w">                  </span><span class="c1"># 📖 プロジェクト説明書</span>
</code></pre></div>
<p><strong>各ディレクトリの役割</strong>：
- <strong>src/ml/</strong>: 機械学習モデルの実装コード（ここにロジックを書く）
- <strong>test/</strong>: テストコード（TDD のテストを書く場所）
- <strong>data/</strong>: 訓練・テスト用データセット（CSV ファイル）
- <strong>model/</strong>: 訓練済みモデルの保存先（pickle ファイル）</p>
<p>この構造なら、どこに何があるか一目瞭然ですね！</p>
<h3 id="_12">初回の動作確認テストを書こう<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p>TDD の第一歩は、<strong>テストを書くこと</strong>から始まります。「いきなりテスト？実装じゃなくて？」そう、テストファーストがTDDの神髄です！</p>
<p>まずは環境が正しくセットアップできているか確認するテストを作りましょう。</p>
<p><strong>test/test_basic.py</strong> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;基本的な環境確認テスト&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sklearn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test_パッケージのインポート確認</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;必要なパッケージが正しくインストールされているか確認&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">pd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>      <span class="c1"># pandas がインポートできる</span>
    <span class="k">assert</span> <span class="n">sklearn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># scikit-learn がインポートできる</span>
    <span class="k">assert</span> <span class="n">np</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>      <span class="c1"># numpy がインポートできる</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test_pandasのバージョン確認</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;pandas のバージョンが 1.0 以上であることを確認&quot;&quot;&quot;</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">__version__</span>
    <span class="n">major_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">major_version</span> <span class="o">&gt;=</span> <span class="mi">1</span>  <span class="c1"># pandas 1.x 以降が必要</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test_scikit_learnのバージョン確認</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;scikit-learn のバージョンが 1.0 以上であることを確認&quot;&quot;&quot;</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">__version__</span>
    <span class="n">major_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">major_version</span> <span class="o">&gt;=</span> <span class="mi">1</span>  <span class="c1"># scikit-learn 1.x 以降が必要</span>
</code></pre></div>
<p><strong>テストを実行してみよう！</strong></p>
<div class="highlight"><pre><span></span><code>pytest<span class="w"> </span>test/test_basic.py<span class="w"> </span>-v
</code></pre></div>
<p><strong>期待される結果</strong>:</p>
<div class="highlight"><pre><span></span><code>test/test_basic.py::test_パッケージのインポート確認 PASSED           [ 33%]
test/test_basic.py::test_pandasのバージョン確認 PASSED                [ 66%]
test/test_basic.py::test_scikit_learnのバージョン確認 PASSED           [100%]

============================== 3 passed in 0.15s ==============================
</code></pre></div>
<p>全部 PASSED なら、環境構築は完璧です！🎉</p>
<h4 id="pandas">pandas の基本操作を確認<a class="headerlink" href="#pandas" title="Permanent link">&para;</a></h4>
<p>機械学習では <strong>pandas</strong> でデータを扱うことが多いので、基本操作を確認しておきましょう：</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TestDataFrameBasics</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;pandas DataFrame の基本操作テスト&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_DataFrameの作成</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;DataFrame を作成できることを確認&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]})</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>              <span class="c1"># 3行のデータ</span>
        <span class="k">assert</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">]</span>  <span class="c1"># 列名が正しい</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_欠損値の検出</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;欠損値を正しく検出できることを確認&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">3</span><span class="p">]})</span>
        <span class="k">assert</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>  <span class="c1"># 1つ欠損値がある</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_欠損値の補完</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;欠損値を平均値で補完できることを確認&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]})</span>
        <span class="n">mean_value</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># 平均値を計算: (1 + 3) / 2 = 2.0</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mean_value</span><span class="p">)</span>  <span class="c1"># 欠損値を平均値で埋める</span>

        <span class="k">assert</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>  <span class="c1"># 欠損値が0個</span>
        <span class="k">assert</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mf">2.0</span>       <span class="c1"># 2番目の値が2.0に補完された</span>
</code></pre></div>
<h4 id="scikit-learn">scikit-learn の基本操作を確認<a class="headerlink" href="#scikit-learn" title="Permanent link">&para;</a></h4>
<p>次は <strong>scikit-learn</strong> の基本操作を確認します：</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TestScikitLearnBasics</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;scikit-learn の基本操作テスト&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_train_test_splitの動作確認</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;データ分割が正しく動作することを確認&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>

        <span class="n">X</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]]</span>  <span class="c1"># 特徴量データ</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>                       <span class="c1"># ラベルデータ</span>

        <span class="c1"># データを訓練用とテスト用に分割（50% ずつ）</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="c1"># 正しく分割されているか確認</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>  <span class="c1"># 訓練データは2個</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>   <span class="c1"># テストデータは2個</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_決定木モデルの作成</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;決定木モデルを作成できることを確認&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.tree</span><span class="w"> </span><span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># 深さ2の決定木</span>
        <span class="k">assert</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">model</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">==</span> <span class="mi">2</span>  <span class="c1"># パラメータが正しく設定されている</span>
</code></pre></div>
<p><strong>全テストを実行</strong>:</p>
<div class="highlight"><pre><span></span><code>pytest<span class="w"> </span>test/test_basic.py<span class="w"> </span>-v
</code></pre></div>
<p>すべてのテストが PASSED なら、準備完了です！次の章から、いよいよ機械学習モデルの実装に入ります。</p>
<hr />
<div class="highlight"><pre><span></span><code>def test_線形回帰モデルの作成(self):
    &quot;&quot;&quot;線形回帰モデルを作成できることを確認&quot;&quot;&quot;
    from sklearn.linear_model import LinearRegression

    model = LinearRegression()  # 線形回帰モデルのインスタンス作成
    assert model is not None    # モデルが正しく作成されたか確認
</code></pre></div>
<p>```

これで基本的な機械学習ツールの準備確認テストが完成しました！
</p>
<h4 id="_13">テストの実行<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h4>
<p>それでは、作成したテストをすべて実行してみましょう！

```bash</p>
<h1 id="pytest">📋 pytest による全テスト実行<a class="headerlink" href="#pytest" title="Permanent link">&para;</a></h1>
<p>uv run pytest test/test_basic.py -v
```</p>
<p><strong>期待される出力</strong>:
<div class="highlight"><pre><span></span><code>test/test_basic.py::test_パッケージのインポート確認 PASSED                    [ 11%]
test/test_basic.py::test_pandasのバージョン確認 PASSED                        [ 22%]
test/test_basic.py::test_scikit_learnのバージョン確認 PASSED                  [ 33%]
test/test_basic.py::TestDataFrameBasics::test_DataFrameの作成 PASSED          [ 44%]
test/test_basic.py::TestDataFrameBasics::test_欠損値の検出 PASSED             [ 55%]
test/test_basic.py::TestDataFrameBasics::test_欠損値の補完 PASSED             [ 66%]
test/test_basic.py::TestScikitLearnBasics::test_train_test_splitの動作確認 PASSED [ 77%]
test/test_basic.py::TestScikitLearnBasics::test_決定木モデルの作成 PASSED     [ 88%]
test/test_basic.py::TestScikitLearnBasics::test_線形回帰モデルの作成 PASSED   [100%]

========================== 9 passed in 0.45s ==========================
</code></pre></div></p>
<p><strong>全部 PASSED！</strong> 🎊 これで機械学習を始める準備が整いました！</p>
<p>「カバレッジも確認したい！」という意欲的なあなたには、こちらのコマンドもおすすめです：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 📊 カバレッジ付きでの実行（どれだけコードがテストされているか確認）</span>
uv<span class="w"> </span>run<span class="w"> </span>pytest<span class="w"> </span>test/test_basic.py<span class="w"> </span>--cov<span class="o">=</span>src<span class="w"> </span>--cov-report<span class="o">=</span>term-missing
</code></pre></div>
<p>カバレッジレポートでは、テストがカバーしている範囲が表示されます。本格的な開発では、カバレッジ 80% 以上を目指すのが一般的ですよ！</p>
<h4 id="_14">品質管理ツールの動作確認<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h4>
<p>「テストは通ったけど、コードの品質は大丈夫？」そんな心配もありますよね。安心してください！本プロジェクトでは、<strong>自動的にコード品質をチェックするツール</strong>も導入しています。</p>
<h5 id="ruff">🎨 Ruff によるコード品質チェック<a class="headerlink" href="#ruff" title="Permanent link">&para;</a></h5>
<p>Ruff は Python の超高速リンター＆フォーマッターです。Rust で書かれているので、従来のツールより 10-100 倍速く動作します！</p>
<div class="highlight"><pre><span></span><code><span class="c1"># コードの問題点をチェック</span>
uv<span class="w"> </span>run<span class="w"> </span>ruff<span class="w"> </span>check<span class="w"> </span>.

<span class="c1"># コードを自動的にきれいに整形</span>
uv<span class="w"> </span>run<span class="w"> </span>ruff<span class="w"> </span>format<span class="w"> </span>.
</code></pre></div>
<p><strong>期待される出力</strong>:
<div class="highlight"><pre><span></span><code>All checks passed! ✨
</code></pre></div></p>
<p>この一言が出れば、あなたのコードは Python の標準的なコーディング規約に従っています！素晴らしい！🎉</p>
<h5 id="mypy">🔍 mypy による型チェック<a class="headerlink" href="#mypy" title="Permanent link">&para;</a></h5>
<p>mypy は Python の型ヒントをチェックするツールです。「型ヒント？それって何？」という方も、実際に使ってみればすぐにわかります！</p>
<p><strong>test/test_basic.py</strong> に型ヒント付きのテスト関数を追加してみましょう：</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>  <span class="c1"># 型ヒント用のインポート</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test_型ヒント付き関数</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;型ヒントが正しく機能することを確認&quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>  <span class="c1"># data は整数のリストという意味</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span>              <span class="c1"># 要素数が 5 個であることを確認</span>
</code></pre></div>
<p>型ヒントをチェックしてみます：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># mypy による型チェック実行</span>
uv<span class="w"> </span>run<span class="w"> </span>mypy<span class="w"> </span>test/test_basic.py
</code></pre></div>
<p><strong>期待される出力</strong>:
<div class="highlight"><pre><span></span><code>Success: no issues found in 1 source file ✅
</code></pre></div></p>
<p>型チェックが通れば、型に関するバグを事前に防げます！これも重要な品質保証の一つですね。</p>
<h4 id="tdd">🔄 TDD サイクルの体験<a class="headerlink" href="#tdd" title="Permanent link">&para;</a></h4>
<p>「TDD って実際どうやるの？」そう思いますよね。ここで、TDD の<strong>神髄である Red-Green-Refactor サイクル</strong>を実際に体験してみましょう！</p>
<p>簡単な DataLoader クラスを例に、TDD の流れを体験します。</p>
<h5 id="red">🔴 Red: まず失敗するテストを書く<a class="headerlink" href="#red" title="Permanent link">&para;</a></h5>
<p><strong>「え？失敗するテストを書くの？」</strong> そうです！TDD では、<strong>実装よりも先にテストを書きます</strong>。これが成功への近道なんです。</p>
<p><strong>test/test_data_loader.py</strong> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;データローダーのテスト（TDD サイクル例）&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.ml.data_loader</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>  <span class="c1"># まだ存在しないモジュールをインポート</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestDataLoader</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;DataLoader クラスのテスト&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_CSVファイルを読み込める</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;CSV ファイルを DataFrame として読み込めることを確認&quot;&quot;&quot;</span>
        <span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">()</span>                        <span class="c1"># DataLoader のインスタンス作成</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load_csv</span><span class="p">(</span><span class="s1">&#39;data/iris.csv&#39;</span><span class="p">)</span>        <span class="c1"># CSV ファイルを読み込む</span>

        <span class="k">assert</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>                        <span class="c1"># データが読み込まれている</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>          <span class="c1"># DataFrame 型である</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>                           <span class="c1"># データが空でない</span>
</code></pre></div>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>run<span class="w"> </span>pytest<span class="w"> </span>test/test_data_loader.py<span class="w"> </span>-v
</code></pre></div>
<p><strong>期待される出力（失敗）</strong>:
<div class="highlight"><pre><span></span><code>ModuleNotFoundError: No module named &#39;src.ml.data_loader&#39;
❌ FAILED
</code></pre></div></p>
<p><strong>失敗しました！</strong> でも、これは<strong>正しい失敗</strong>です！これが TDD の第一歩、<strong>Red（赤）</strong>の状態です。🔴</p>
<h5 id="green">🟢 Green: テストを通す最小限の実装<a class="headerlink" href="#green" title="Permanent link">&para;</a></h5>
<p>次に、このテストを通すための<strong>最小限のコード</strong>を書きます。「最小限」がポイントです！</p>
<p>まず、必要なディレクトリを作成：</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>src/ml
touch<span class="w"> </span>src/ml/__init__.py
</code></pre></div>
<p>そして、<strong>src/ml/data_loader.py</strong> を作成：</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;データローダーモジュール&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>


<span class="k">class</span><span class="w"> </span><span class="nc">DataLoader</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CSV データを読み込むクラス&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;CSV ファイルを読み込む</span>

<span class="sd">        Args:</span>
<span class="sd">            file_path: CSV ファイルのパス</span>

<span class="sd">        Returns:</span>
<span class="sd">            読み込んだ DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>  <span class="c1"># シンプル！pandas におまかせ</span>
</code></pre></div>
<p>テストを再実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>run<span class="w"> </span>pytest<span class="w"> </span>test/test_data_loader.py<span class="w"> </span>-v
</code></pre></div>
<p><strong>期待される出力（成功）</strong>:
<div class="highlight"><pre><span></span><code>test/test_data_loader.py::TestDataLoader::test_CSVファイルを読み込める PASSED [100%]
========================== 1 passed in 0.12s ==========================
✅ PASSED
</code></pre></div></p>
<p><strong>テストが通りました！</strong> これが TDD の第二歩、<strong>Green（緑）</strong>の状態です！🟢</p>
<p>この瞬間、とても嬉しいですよね！小さな成功体験を積み重ねることが、TDD の醍醐味です。</p>
<h5 id="refactor">🔧 Refactor: コードの改善<a class="headerlink" href="#refactor" title="Permanent link">&para;</a></h5>
<p>「テストは通ったけど、これで本当に大丈夫？」良い疑問です！TDD の第三歩、<strong>Refactor（リファクタリング）</strong>では、<strong>テストを壊さずにコードを改善</strong>します。</p>
<p>現在のコードには問題があります。存在しないファイルを読み込もうとしたり、空のパスを指定したりすると、わかりにくいエラーが出てしまいます。これを改善しましょう！</p>
<p><strong>まずテストを追加</strong>します（これも TDD です！）</p>
<p><strong>test/test_data_loader.py</strong> の TestDataLoader クラスに追加：</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_存在しないファイルの処理</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;存在しないファイルを指定した場合に適切なエラーを返すことを確認&quot;&quot;&quot;</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">()</span>

    <span class="c1"># pytest.raises で「このエラーが発生することを期待」と宣言</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">):</span>
        <span class="n">loader</span><span class="o">.</span><span class="n">load_csv</span><span class="p">(</span><span class="s1">&#39;data/non_existent.csv&#39;</span><span class="p">)</span>  <span class="c1"># わざと存在しないファイルを指定</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test_空のファイルパスの処理</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;空のファイルパスを指定した場合にエラーを返すことを確認&quot;&quot;&quot;</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>  <span class="c1"># 空のパスは ValueError</span>
        <span class="n">loader</span><span class="o">.</span><span class="n">load_csv</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</code></pre></div>
<p>次に、<strong>実装を改善</strong>します：</p>
<p><strong>src/ml/data_loader.py</strong> をリファクタリング：</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;データローダーモジュール&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>


<span class="k">class</span><span class="w"> </span><span class="nc">DataLoader</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CSV データを読み込むクラス&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;CSV ファイルを読み込む</span>

<span class="sd">        Args:</span>
<span class="sd">            file_path: CSV ファイルのパス</span>

<span class="sd">        Returns:</span>
<span class="sd">            読み込んだ DataFrame</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: ファイルパスが空の場合</span>
<span class="sd">            FileNotFoundError: ファイルが存在しない場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># バリデーション：空のパスはダメ！</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_path</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;File path cannot be empty&quot;</span><span class="p">)</span>

        <span class="c1"># バリデーション：ファイルが存在するか確認</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># すべてのチェックをパスしたらデータを読み込む</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</code></pre></div>
<p>テストを再実行して、すべて通ることを確認します：</p>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>run<span class="w"> </span>pytest<span class="w"> </span>test/test_data_loader.py<span class="w"> </span>-v
</code></pre></div>
<p><strong>期待される出力</strong>:
<div class="highlight"><pre><span></span><code>test/test_data_loader.py::TestDataLoader::test_CSVファイルを読み込める PASSED           [ 33%]
test/test_data_loader.py::TestDataLoader::test_存在しないファイルの処理 PASSED         [ 66%]
test/test_data_loader.py::TestDataLoader::test_空のファイルパスの処理 PASSED           [100%]
========================== 3 passed in 0.15s ==========================
</code></pre></div></p>
<p><strong>全部 PASSED！</strong> 🎉</p>
<p>これで、TDD の <strong>Red → Green → Refactor</strong> サイクルを一周しました！</p>
<ul>
<li>🔴 <strong>Red</strong>: 失敗するテストを書く</li>
<li>🟢 <strong>Green</strong>: テストを通す最小限の実装</li>
<li>🔧 <strong>Refactor</strong>: テストを保ちながらコードを改善</li>
</ul>
<p>このサイクルを繰り返すことで、<strong>安全に、確実に、品質の高いコード</strong>を作り上げていくのが TDD です！</p>
<h4 id="_15">📊 サンプルデータの準備<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h4>
<p>「機械学習って、まずデータがないと始まらないんでしょ？」その通りです！</p>
<p>本チュートリアルでは、機械学習の世界で最も有名な <strong>Iris（アヤメ）データセット</strong>を使います。アヤメの花びらと萼（がく）の大きさから、アヤメの種類を分類する問題です。</p>
<p>まず、<strong>data</strong> ディレクトリを作成します：</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>data
</code></pre></div>
<p>そして、<strong>data/iris.csv</strong> を作成します（実際には 150 行のデータがありますが、ここでは一部を抜粋）：</p>
<div class="highlight"><pre><span></span><code>sepal_length,sepal_width,petal_length,petal_width,species
5.1,3.5,1.4,0.2,setosa
4.9,3.0,1.4,0.2,setosa
7.0,3.2,4.7,1.4,versicolor
6.4,3.2,4.5,1.5,versicolor
6.3,3.3,6.0,2.5,virginica
5.8,2.7,5.1,1.9,virginica
</code></pre></div>
<p><strong>データの意味</strong>：
- 🌸 <strong>sepal_length</strong>: 萼（がく）の長さ（cm）
- 🌸 <strong>sepal_width</strong>: 萼（がく）の幅（cm）
- 🌺 <strong>petal_length</strong>: 花びらの長さ（cm）
- 🌺 <strong>petal_width</strong>: 花びらの幅（cm）
- 🏷️ <strong>species</strong>: アヤメの種類（setosa、versicolor、virginica の 3 種類）</p>
<p>このデータを使って、花びらや萼のサイズから、どの種類のアヤメかを予測するモデルを作ります！</p>
<p>データが正しく読み込めるか、テストで確認しましょう：</p>
<p><strong>test/test_data_loader.py</strong> に追加：</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_Irisデータセットの読み込み</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Iris データセットを正しく読み込めることを確認&quot;&quot;&quot;</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load_csv</span><span class="p">(</span><span class="s1">&#39;data/iris.csv&#39;</span><span class="p">)</span>  <span class="c1"># Iris データ読み込み</span>

    <span class="c1"># 📋 列名の確認：期待する列がすべて揃っているか？</span>
    <span class="n">expected_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sepal_length&#39;</span><span class="p">,</span> <span class="s1">&#39;sepal_width&#39;</span><span class="p">,</span> <span class="s1">&#39;petal_length&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;petal_width&#39;</span><span class="p">,</span> <span class="s1">&#39;species&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected_columns</span>

    <span class="c1"># 🔍 データ型の確認：数値は float、種類は文字列（object）</span>
    <span class="k">assert</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sepal_length&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;float64&#39;</span>
    <span class="k">assert</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span>

    <span class="c1"># 🌸 種類の確認：3 種類のアヤメがすべて含まれているか？</span>
    <span class="n">species</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>  <span class="c1"># ユニークな値を取得</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>          <span class="c1"># 3 種類</span>
    <span class="k">assert</span> <span class="s1">&#39;setosa&#39;</span> <span class="ow">in</span> <span class="n">species</span>        <span class="c1"># setosa が含まれる</span>
    <span class="k">assert</span> <span class="s1">&#39;versicolor&#39;</span> <span class="ow">in</span> <span class="n">species</span>    <span class="c1"># versicolor が含まれる</span>
    <span class="k">assert</span> <span class="s1">&#39;virginica&#39;</span> <span class="ow">in</span> <span class="n">species</span>     <span class="c1"># virginica が含まれる</span>
</code></pre></div>
<p>テストを実行してみましょう：</p>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>run<span class="w"> </span>pytest<span class="w"> </span>test/test_data_loader.py::test_Irisデータセットの読み込み<span class="w"> </span>-v
</code></pre></div>
<p><strong>PASSED</strong> なら、データの準備は完璧です！🎉</p>
<p>これで、２章「開発環境のセットアップ」は完了です！お疲れさまでした！</p>
<p>次の章からは、いよいよ機械学習モデルの実装に入ります。ワクワクしてきませんか？😊</p>
<hr />
<h3 id="2_1">📊 ２章の技術的成果<a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h3>
<p>２章で何を学び、何を達成したか振り返ってみましょう！</p>
<h4 id="_16">✅ 完成した機能<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h4>
<p>お疲れさまでした！２章では以下の機能を実装しました：</p>
<ul>
<li>✅ <strong>現代的 Python 開発環境のセットアップ</strong> - uv、Ruff、mypy、pytest</li>
<li>✅ <strong>プロジェクト構造の確立</strong> - src/、test/、data/ の整備</li>
<li>✅ <strong>基本的なテストスイートの作成</strong> - 12 個のテストケース</li>
<li>✅ <strong>TDD サイクルの実践</strong> - Red-Green-Refactor を体験</li>
<li>✅ <strong>DataLoader の実装</strong> - CSV ファイル読み込み機能</li>
<li>✅ <strong>品質管理ツールの設定と確認</strong> - コード品質の自動チェック</li>
</ul>
<h4 id="_17">📈 定量的成果<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h4>
<p>数字で見ると、こんなに進歩しました！</p>
<table>
<thead>
<tr>
<th>指標</th>
<th>実績</th>
</tr>
</thead>
<tbody>
<tr>
<td>🧪 <strong>テストケース</strong></td>
<td>12 個</td>
</tr>
<tr>
<td>📊 <strong>コードカバレッジ</strong></td>
<td>100%（data_loader.py）</td>
</tr>
<tr>
<td>🔤 <strong>型ヒント使用率</strong></td>
<td>100%</td>
</tr>
<tr>
<td>✨ <strong>Ruff チェック</strong></td>
<td>全て通過</td>
</tr>
<tr>
<td>✅ <strong>mypy チェック</strong></td>
<td>エラー 0 件</td>
</tr>
</tbody>
</table>
<h4 id="_18">🎓 習得したスキル<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h4>
<h5 id="1_1">1. 🛠️ 開発環境スキル<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h5>
<ul>
<li><strong>uv</strong> による高速パッケージ管理</li>
<li><strong>Ruff</strong> による統合品質管理</li>
<li><strong>mypy</strong> による型安全性確保</li>
<li><strong>pytest</strong> による自動テスト</li>
</ul>
<h5 id="2-tdd">2. 🔄 TDD スキル<a class="headerlink" href="#2-tdd" title="Permanent link">&para;</a></h5>
<ul>
<li><strong>Red-Green-Refactor</strong> サイクルの実践</li>
<li><strong>テストファースト開発</strong>の習慣化</li>
<li><strong>エッジケース</strong>を考慮したテスト設計</li>
</ul>
<h5 id="3-python">3. 🐍 Python スキル<a class="headerlink" href="#3-python" title="Permanent link">&para;</a></h5>
<ul>
<li><strong>型ヒント</strong>の活用</li>
<li><strong>例外処理</strong>の実装</li>
<li><strong>モジュール構造</strong>の設計</li>
</ul>
<h5 id="4">4. 🤖 機械学習基礎知識<a class="headerlink" href="#4" title="Permanent link">&para;</a></h5>
<ul>
<li><strong>分類問題と回帰問題</strong>の理解</li>
<li><strong>データ前処理</strong>の重要性認識</li>
<li><strong>モデル評価</strong>の必要性理解</li>
</ul>
<h4 id="_19">🚀 次の章への準備<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h4>
<p>２章では、開発環境を整えました！次の４章（３章は理論補足なのでスキップ可）では、いよいよ実際の機械学習モデルを実装します！</p>
<p><strong>これから実装する内容</strong>：
- 🌸 <strong>Iris 分類モデルの完全実装</strong> - アヤメを分類するモデル
- 🌳 <strong>決定木アルゴリズムの理解</strong> - 機械学習の基本アルゴリズム
- 🔧 <strong>データ前処理パイプラインの構築</strong> - データをきれいにする
- 💾 <strong>モデルの保存と読み込み</strong> - 学習したモデルを再利用</p>
<p>準備はできましたか？それでは、次の章で実際に機械学習モデルを作っていきましょう！🎉</p>
<h2 id="4_1">４章 機械学習の基礎理論（補足）<a class="headerlink" href="#4_1" title="Permanent link">&para;</a></h2>
<p>「２章で環境は整ったけど、機械学習って実際どうやって進めるの？」そんな疑問に答えるため、この章では機械学習の基本的な考え方を学びます。</p>
<h3 id="_20">📋 機械学習のワークフロー<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<p>機械学習プロジェクトは、だいたい以下のような流れで進めます：</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkFDVElWSVRZIiBoZWlnaHQ9IjU5M3B4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NDQycHg7aGVpZ2h0OjU5M3B4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDQ0MiA1OTMiIHdpZHRoPSI0NDJweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjxlbGxpcHNlIGN4PSIxMzkuNDQ4NCIgY3k9IjIwIiBmaWxsPSIjMjIyMjIyIiByeD0iMTAiIHJ5PSIxMCIgc3R5bGU9InN0cm9rZTojMjIyMjIyO3N0cm9rZS13aWR0aDoxOyIvPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzMuOTY4OCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI5NS4yNjQxIiB4PSI5MS44MTY0IiB5PSI1MCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc1LjI2NDEiIHg9IjEwMS44MTY0IiB5PSI3MS4xMzg3Ij4xLiAmIzEyNDg3OyYjMTI1NDA7JiMxMjQ3OTsmIzIxNDU0OyYjMzg1OTg7PC90ZXh0PjxwYXRoIGQ9Ik0yMTMuMDgwNSw5My45Njg4IEwyMTMuMDgwNSwxMTcuNjY4IEwxOTMuMDgwNSwxMjEuNjY4IEwyMTMuMDgwNSwxMjUuNjY4IEwyMTMuMDgwNSwxNDkuMzY3MiBBMCwwIDAgMCAwIDIxMy4wODA1LDE0OS4zNjcyIEwzODUuOTAzOSwxNDkuMzY3MiBBMCwwIDAgMCAwIDM4NS45MDM5LDE0OS4zNjcyIEwzODUuOTAzOSwxMDMuOTY4OCBMMzc1LjkwMzksOTMuOTY4OCBMMjEzLjA4MDUsOTMuOTY4OCBBMCwwIDAgMCAwIDIxMy4wODA1LDkzLjk2ODgiIGZpbGw9IiNGRUZGREQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik0zNzUuOTAzOSw5My45Njg4IEwzNzUuOTAzOSwxMDMuOTY4OCBMMzg1LjkwMzksMTAzLjk2ODggTDM3NS45MDM5LDkzLjk2ODgiIGZpbGw9IiNGRUZGREQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjczLjgyMzMiIHg9IjIxOS4wODA1IiB5PSIxMTEuMDM1NiI+LSAmIzI3NDI0OyYjMjU2MTM7JiMyMDUxNjsmIzIwOTY2OyYjMjk3MDI7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjczLjgyMzMiIHg9IjIxOS4wODA1IiB5PSIxMjYuMTY4NSI+LSAmIzIyODA2OyYjMTI0Mjg7JiMyMDUxNjsmIzIwOTY2OyYjMjk3MDI7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE1MS44MjM0IiB4PSIyMTkuMDgwNSIgeT0iMTQxLjMwMTMiPi0gJiMyOTMwNTsmIzI0NTAwOyYjMzczMjc7JiMxMjQ1NjsmIzEyNTMxOyYjMTI0NzI7JiMxMjQ5MTsmIzEyNDUwOyYjMTI1MjI7JiMxMjUzMTsmIzEyNDY0OzwvdGV4dD48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjMzLjk2ODgiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTA3LjI2NDIiIHg9Ijg1LjgxNjMiIHk9IjEwNC42ODM2Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODcuMjY0MiIgeD0iOTUuODE2MyIgeT0iMTI1LjgyMjMiPjIuICYjMTI0ODc7JiMxMjU0MDsmIzEyNDc5OyYjMjEwNjk7JiMyMDk2NjsmIzI5NzAyOzwvdGV4dD48cGF0aCBkPSJNMjA3LjA4MDUsMTU5LjM2NzIgTDIwNy4wODA1LDE4My4wNjY0IEwxODcuMDgwNSwxODcuMDY2NCBMMjA3LjA4MDUsMTkxLjA2NjQgTDIwNy4wODA1LDIxNC43NjU2IEEwLDAgMCAwIDAgMjA3LjA4MDUsMjE0Ljc2NTYgTDMxNC45MDM4LDIxNC43NjU2IEEwLDAgMCAwIDAgMzE0LjkwMzgsMjE0Ljc2NTYgTDMxNC45MDM4LDE2OS4zNjcyIEwzMDQuOTAzOCwxNTkuMzY3MiBMMjA3LjA4MDUsMTU5LjM2NzIgQTAsMCAwIDAgMCAyMDcuMDgwNSwxNTkuMzY3MiIgZmlsbD0iI0ZFRkZERCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHBhdGggZD0iTTMwNC45MDM4LDE1OS4zNjcyIEwzMDQuOTAzOCwxNjkuMzY3MiBMMzE0LjkwMzgsMTY5LjM2NzIgTDMwNC45MDM4LDE1OS4zNjcyIiBmaWxsPSIjRkVGRkREIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI3My44MjMzIiB4PSIyMTMuMDgwNSIgeT0iMTc2LjQzNDEiPi0gJiMzNTM0NzsmIzMyMjQ0OyYjMTI0ODc7JiMxMjU0MDsmIzEyNDc5OzwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI4Ni44MjMzIiB4PSIyMTMuMDgwNSIgeT0iMTkxLjU2NjkiPi0gJiMxMjQ4NjsmIzEyNDczOyYjMTI0ODg7JiMxMjQ4NzsmIzEyNTQwOyYjMTI0Nzk7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgzLjk2NjkiIHg9IjIxMy4wODA1IiB5PSIyMDYuNjk5NyI+LSAoJiMyNjkwODsmIzM1Mzg4OyYjMTI0ODc7JiMxMjU0MDsmIzEyNDc5Oyk8L3RleHQ+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzMy45Njg4IiByeD0iMTIuNSIgcnk9IjEyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9Ijk1LjI2NDEiIHg9IjkxLjgxNjQiIHk9IjE3MC4wODIiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI3NS4yNjQxIiB4PSIxMDEuODE2NCIgeT0iMTkxLjIyMDciPjMuICYjMTI0ODc7JiMxMjU0MDsmIzEyNDc5OyYjMjA5OTg7JiMyMTEwNjs8L3RleHQ+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzMy45Njg4IiByeD0iMTIuNSIgcnk9IjEyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9Ijk1LjI2NDEiIHg9IjkxLjgxNjQiIHk9IjIzNC43NjU2Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNzUuMjY0MSIgeD0iMTAxLjgxNjQiIHk9IjI1NS45MDQzIj40LiAmIzEyNTE0OyYjMTI0ODc7JiMxMjUyMzsmIzM2OTg0OyYjMjUyNDY7PC90ZXh0PjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzMuOTY4OCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI5NS4yNjQxIiB4PSI5MS44MTY0IiB5PSIyODguNzM0NCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc1LjI2NDEiIHg9IjEwMS44MTY0IiB5PSIzMDkuODczIj41LiAmIzEyNTE0OyYjMTI0ODc7JiMxMjUyMzsmIzM1MzQ3OyYjMzIyNDQ7PC90ZXh0PjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzMuOTY4OCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI5NS4yNjQxIiB4PSI5MS44MTY0IiB5PSIzNDIuNzAzMSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc1LjI2NDEiIHg9IjEwMS44MTY0IiB5PSIzNjMuODQxOCI+Ni4gJiMxMjUxNDsmIzEyNDg3OyYjMTI1MjM7JiMzNTQxMzsmIzIwMzg1OzwvdGV4dD48cG9seWdvbiBmaWxsPSIjRjFGMUYxIiBwb2ludHM9IjEwNi40NDg2LDM5Ni42NzE5LDE3Mi40NDgyLDM5Ni42NzE5LDE4NC40NDgyLDQwOC42NzE5LDE3Mi40NDgyLDQyMC42NzE5LDEwNi40NDg2LDQyMC42NzE5LDk0LjQ0ODYsNDA4LjY3MTksMTA2LjQ0ODYsMzk2LjY3MTkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjExIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY1Ljk5OTUiIHg9IjEwNi40NDg2IiB5PSI0MTIuNDgiPiYjMjQ2MTU7JiMzMzAyMTsmIzEyMzk5OyYjMjEzMTM7JiMyMDk5ODsmIzY1MzExOzwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMSIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxOS4wMDgzIiB4PSI3NS40NDAzIiB5PSI0MDYuMDc3NiI+eWVzPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjExIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzLjcwMTciIHg9IjE4NC40NDgyIiB5PSI0MDYuMDc3NiI+bm88L3RleHQ+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzMy45Njg4IiByeD0iMTIuNSIgcnk9IjEyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9Ijk1LjI2NDEiIHg9IjE3IiB5PSI0MzAuNjcxOSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc1LjI2NDEiIHg9IjI3IiB5PSI0NTEuODEwNSI+Ny4gJiMxMjUxNDsmIzEyNDg3OyYjMTI1MjM7JiMyMDQ0NTsmIzIzMzg0OzwvdGV4dD48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjMzLjk2ODgiIHJ4PSIxMi41IiByeT0iMTIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTA3LjI2NDIiIHg9IjExIiB5PSI0OTkuNjQwNiIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijg3LjI2NDIiIHg9IjIxIiB5PSI1MjAuNzc5MyI+OC4gJiMyNjQxMjsmIzMwMDU4OyYjMTI0ODc7JiMxMjUwMzsmIzEyNTI1OyYjMTI0NTI7PC90ZXh0PjxlbGxpcHNlIGN4PSI2NC42MzIxIiBjeT0iNTY0LjYwOTQiIGZpbGw9Im5vbmUiIHJ4PSIxMSIgcnk9IjExIiBzdHlsZT0ic3Ryb2tlOiMyMjIyMjI7c3Ryb2tlLXdpZHRoOjE7Ii8+PGVsbGlwc2UgY3g9IjY0LjYzMjEiIGN5PSI1NjQuNjA5NCIgZmlsbD0iIzIyMjIyMiIgcng9IjYiIHJ5PSI2IiBzdHlsZT0ic3Ryb2tlOiMyMjIyMjI7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBhdGggZD0iTTMxMC4yNjUyLDQzMC42NzE5IEwzMTAuMjY1Miw0NTQuMzcxMSBMMjkwLjI2NTIsNDU4LjM3MTEgTDMxMC4yNjUyLDQ2Mi4zNzExIEwzMTAuMjY1Miw0ODYuMDcwMyBBMCwwIDAgMCAwIDMxMC4yNjUyLDQ4Ni4wNzAzIEw0MzAuMTQ5LDQ4Ni4wNzAzIEEwLDAgMCAwIDAgNDMwLjE0OSw0ODYuMDcwMyBMNDMwLjE0OSw0NDAuNjcxOSBMNDIwLjE0OSw0MzAuNjcxOSBMMzEwLjI2NTIsNDMwLjY3MTkgQTAsMCAwIDAgMCAzMTAuMjY1Miw0MzAuNjcxOSIgZmlsbD0iI0ZFRkZERCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHBhdGggZD0iTTQyMC4xNDksNDMwLjY3MTkgTDQyMC4xNDksNDQwLjY3MTkgTDQzMC4xNDksNDQwLjY3MTkgTDQyMC4xNDksNDMwLjY3MTkiIGZpbGw9IiNGRUZGREQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgxLjQ4NDkiIHg9IjMxNi4yNjUyIiB5PSI0NDcuNzM4OCI+LSBtYXhfZGVwdGg8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTQuOTkyNyIgeD0iMzE2LjI2NTIiIHk9IjQ2Mi44NzE2Ij4tIGxlYXJuaW5nX3JhdGU8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTguODgzOCIgeD0iMzE2LjI2NTIiIHk9IjQ3OC4wMDQ0Ij4tIHJlZ3VsYXJpemF0aW9uPC90ZXh0PjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzMuOTY4OCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNTIuMDAxIiB4PSIxMzguMjY0MiIgeT0iNDQxLjM4NjciLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMzIuMDAxIiB4PSIxNDguMjY0MiIgeT0iNDYyLjUyNTQiPiYjMTI0OTU7JiMxMjQ1MjsmIzEyNDk3OyYjMTI1NDA7JiMxMjQ5NzsmIzEyNTIxOyYjMTI1MTM7JiMxMjU0MDsmIzEyNDc5OyYjMzU1MTk7JiMyNTk3Mjs8L3RleHQ+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9IjEzOS40NDg0IiB4Mj0iMTM5LjQ0ODQiIHkxPSIzMCIgeTI9IjUwIi8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxMzUuNDQ4NCw0MCwxMzkuNDQ4NCw1MCwxNDMuNDQ4NCw0MCwxMzkuNDQ4NCw0NCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHgxPSIxMzkuNDQ4NCIgeDI9IjEzOS40NDg0IiB5MT0iODMuOTY4OCIgeTI9IjEwNC42ODM2Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxMzUuNDQ4NCw5NC42ODM2LDEzOS40NDg0LDEwNC42ODM2LDE0My40NDg0LDk0LjY4MzYsMTM5LjQ0ODQsOTguNjgzNiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHgxPSIxMzkuNDQ4NCIgeDI9IjEzOS40NDg0IiB5MT0iMTM4LjY1MjMiIHkyPSIxNzAuMDgyIi8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxMzUuNDQ4NCwxNjAuMDgyLDEzOS40NDg0LDE3MC4wODIsMTQzLjQ0ODQsMTYwLjA4MiwxMzkuNDQ4NCwxNjQuMDgyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9IjEzOS40NDg0IiB4Mj0iMTM5LjQ0ODQiIHkxPSIyMDQuMDUwOCIgeTI9IjIzNC43NjU2Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxMzUuNDQ4NCwyMjQuNzY1NiwxMzkuNDQ4NCwyMzQuNzY1NiwxNDMuNDQ4NCwyMjQuNzY1NiwxMzkuNDQ4NCwyMjguNzY1NiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHgxPSIxMzkuNDQ4NCIgeDI9IjEzOS40NDg0IiB5MT0iMjY4LjczNDQiIHkyPSIyODguNzM0NCIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTM1LjQ0ODQsMjc4LjczNDQsMTM5LjQ0ODQsMjg4LjczNDQsMTQzLjQ0ODQsMjc4LjczNDQsMTM5LjQ0ODQsMjgyLjczNDQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB4MT0iMTM5LjQ0ODQiIHgyPSIxMzkuNDQ4NCIgeTE9IjMyMi43MDMxIiB5Mj0iMzQyLjcwMzEiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjEzNS40NDg0LDMzMi43MDMxLDEzOS40NDg0LDM0Mi43MDMxLDE0My40NDg0LDMzMi43MDMxLDEzOS40NDg0LDMzNi43MDMxIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9IjY0LjYzMjEiIHgyPSI2NC42MzIxIiB5MT0iNDY0LjY0MDYiIHkyPSI0OTkuNjQwNiIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNjAuNjMyMSw0ODkuNjQwNiw2NC42MzIxLDQ5OS42NDA2LDY4LjYzMjEsNDg5LjY0MDYsNjQuNjMyMSw0OTMuNjQwNiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHgxPSI2NC42MzIxIiB4Mj0iNjQuNjMyMSIgeTE9IjUzMy42MDk0IiB5Mj0iNTUzLjYwOTQiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjYwLjYzMjEsNTQzLjYwOTQsNjQuNjMyMSw1NTMuNjA5NCw2OC42MzIxLDU0My42MDk0LDY0LjYzMjEsNTQ3LjYwOTQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB4MT0iOTQuNDQ4NiIgeDI9IjY0LjYzMjEiIHkxPSI0MDguNjcxOSIgeTI9IjQwOC42NzE5Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9IjY0LjYzMjEiIHgyPSI2NC42MzIxIiB5MT0iNDA4LjY3MTkiIHkyPSI0MzAuNjcxOSIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNjAuNjMyMSw0MjAuNjcxOSw2NC42MzIxLDQzMC42NzE5LDY4LjYzMjEsNDIwLjY3MTksNjQuNjMyMSw0MjQuNjcxOSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHgxPSIxODQuNDQ4MiIgeDI9IjIxNC4yNjQ3IiB5MT0iNDA4LjY3MTkiIHkyPSI0MDguNjcxOSIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHgxPSIyMTQuMjY0NyIgeDI9IjIxNC4yNjQ3IiB5MT0iNDA4LjY3MTkiIHkyPSI0NDEuMzg2NyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjEwLjI2NDcsNDMxLjM4NjcsMjE0LjI2NDcsNDQxLjM4NjcsMjE4LjI2NDcsNDMxLjM4NjcsMjE0LjI2NDcsNDM1LjM4NjciIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB4MT0iMjE0LjI2NDciIHgyPSIyMTQuMjY0NyIgeTE9IjQ3NS4zNTU1IiB5Mj0iNTgxLjYwOTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB4MT0iMjE0LjI2NDciIHgyPSIxMzkuNDQ4NCIgeTE9IjU4MS42MDk0IiB5Mj0iNTgxLjYwOTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB4MT0iMTM5LjQ0ODQiIHgyPSIxMzkuNDQ4NCIgeTE9IjM3Ni42NzE5IiB5Mj0iMzk2LjY3MTkiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjEzNS40NDg0LDM4Ni42NzE5LDEzOS40NDg0LDM5Ni42NzE5LDE0My40NDg0LDM4Ni42NzE5LDEzOS40NDg0LDM5MC42NzE5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PCEtLVNSQz1bTlAzVElXOTE1Q1Zsdm9kY0tZeUstZXhyT01KMUtIVGlMdE9kZ0F2cTFfb2VKMkVpOEZqRzViREpZWDlJQzdzT3Utb2tMeHIyaW1lc1UzRVMtUHJwX2x6cFphTExhbzliQXVnMTVPNURtOXhud2pOWWVIMTNvaE9Db25MVVI3aXJtTk0zNGNuZ2dKSDU0VXBzTnpuUVhVVVNMTE9HeGpvMlZJYUpocHBjcS02WU0wTXgwLW1CeDE2bTJ4MVJtN2hCeG1TWVVXODdpYVpQYUpyQjFMeC10MzNxRXBWVXp0MVQ4bVltMGpYWk8yS1BYYm9kdU5TY1FuSU1GN08zWnpPb3pSUjhaenBwOXg3aWRXSE43V0Jrb3gxUmRxLVJDUUdiWE5aa3JNU19hN19kYlJvT3lkVm83Q09xSk5HU0VZTE02MmE3S2p6eXppVzd6cUJpQzhoVEhqLWh6dlJ5M2pXMFIyVTZCNmZhNFNiTzE4VHFHX0cyNHRUb1c1cTdXbVRsNXJYcGpPSlZjeGRydVNQMVpqSUpVODlhUUxoNDZRQVFrZ1FkdWdPZzVlcldhd0lFQ3dnZmRRYktDX0pfNHVYMElfdTFdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<p><strong>重要なポイント</strong>：
- 📊 <strong>データが命</strong>：良いモデルは良いデータから生まれます
- 🔄 <strong>反復改善</strong>：一度でうまくいくことは稀です。試行錯誤が大切
- 📈 <strong>評価が大事</strong>：訓練データでの性能だけでなく、未知のデータでの性能を確認</p>
<h3 id="_21">🎯 分類問題と回帰問題の違い<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p>機械学習の問題は大きく 2 つに分けられます。違いを理解することが重要です！</p>
<h4 id="classification">🏷️ 分類問題（Classification）<a class="headerlink" href="#classification" title="Permanent link">&para;</a></h4>
<p><strong>「どのカテゴリに属するか？」を予測する問題</strong></p>
<ul>
<li><strong>目的</strong>: カテゴリ（クラス）を予測</li>
<li><strong>出力</strong>: 離散値（例: setosa、versicolor、virginica）</li>
<li><strong>評価指標</strong>: 正解率、適合率、再現率、F1 スコア</li>
<li><strong>アルゴリズム例</strong>: 決定木、ロジスティック回帰、SVM</li>
</ul>
<p><strong>具体例</strong>：
- 🌸 アヤメの種類を分類（本チュートリアル）
- 📧 メールがスパムかどうかを判定
- 🖼️ 画像に写っているものが猫か犬かを判定</p>
<h4 id="regression">📊 回帰問題（Regression）<a class="headerlink" href="#regression" title="Permanent link">&para;</a></h4>
<p><strong>「どのくらいの値になるか？」を予測する問題</strong></p>
<ul>
<li><strong>目的</strong>: 連続値を予測</li>
<li><strong>出力</strong>: 数値（例: 興行収入 10000 万円）</li>
<li><strong>評価指標</strong>: 平均絶対誤差（MAE）、平均二乗誤差（MSE）、決定係数（R²）</li>
<li><strong>アルゴリズム例</strong>: 線形回帰、リッジ回帰、ランダムフォレスト</li>
</ul>
<p><strong>具体例</strong>：
- 💰 映画の興行収入を予測（本チュートリアル）
- 🏠 不動産の価格を予測
- 🌡️ 明日の気温を予測</p>
<h3 id="_22">⚠️ モデル評価の重要性<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<p>機械学習で最も重要なのは、<strong>訓練データで学習したモデルが、未知のデータに対してどれだけ性能を発揮できるか</strong>です。</p>
<p>「訓練データでは完璧なのに、実際のデータでは全然ダメ...」これが <strong>過学習（Overfitting）</strong> です！</p>
<h4 id="overfitting">過学習（Overfitting）の問題<a class="headerlink" href="#overfitting" title="Permanent link">&para;</a></h4>
<p>過学習を実際にテストで確認してみましょう：</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_過学習の検出</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;訓練データとテストデータの性能差で過学習を検出&quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.tree</span><span class="w"> </span><span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>

    <span class="c1"># 📊 サンプルデータを作成</span>
    <span class="n">X</span> <span class="o">=</span> <span class="p">[[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span>          <span class="c1"># 特徴量</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span>  <span class="c1"># ラベル（0 or 1）</span>

    <span class="c1"># データを訓練用（70%）とテスト用（30%）に分割</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>

    <span class="c1"># ❌ 深すぎる決定木（過学習しやすい）</span>
    <span class="n">model_overfit</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>  <span class="c1"># 深さ 50 は深すぎ！</span>
    <span class="n">model_overfit</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="c1"># ✅ 適切な深さの決定木</span>
    <span class="n">model_good</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># 深さ 3 が適切</span>
    <span class="n">model_good</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="c1"># 📈 訓練データでの性能を測定</span>
    <span class="n">train_score_overfit</span> <span class="o">=</span> <span class="n">model_overfit</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>  <span class="c1"># 過学習モデル</span>
    <span class="n">train_score_good</span> <span class="o">=</span> <span class="n">model_good</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>        <span class="c1"># 適切なモデル</span>

    <span class="c1"># 📉 テストデータでの性能を測定（こっちが重要！）</span>
    <span class="n">test_score_overfit</span> <span class="o">=</span> <span class="n">model_overfit</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>  <span class="c1"># 過学習モデル</span>
    <span class="n">test_score_good</span> <span class="o">=</span> <span class="n">model_good</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>        <span class="c1"># 適切なモデル</span>

    <span class="c1"># 🔍 過学習の検出：訓練とテストで大きな性能差があると過学習</span>
    <span class="n">overfit_gap</span> <span class="o">=</span> <span class="n">train_score_overfit</span> <span class="o">-</span> <span class="n">test_score_overfit</span>  <span class="c1"># 過学習モデルの性能差</span>
    <span class="n">good_gap</span> <span class="o">=</span> <span class="n">train_score_good</span> <span class="o">-</span> <span class="n">test_score_good</span>           <span class="c1"># 適切なモデルの性能差</span>

    <span class="c1"># 過学習モデルの方が性能差が大きいことを確認</span>
    <span class="k">assert</span> <span class="n">overfit_gap</span> <span class="o">&gt;</span> <span class="n">good_gap</span>
</code></pre></div>
<p><strong>このテストから学べること</strong>：
- 📚 <strong>訓練データでの高性能 ≠ 良いモデル</strong>
- 🎯 <strong>未知のデータでの性能こそが本当の実力</strong>
- ⚖️ <strong>適切なモデルの複雑さを選ぶことが重要</strong></p>
<hr />
<h2 id="4-iris">４章 Iris 分類モデル（分類問題の基礎）<a class="headerlink" href="#4-iris" title="Permanent link">&para;</a></h2>
<p>さあ、いよいよ実際の機械学習モデルを作ります！「難しそう...」と思いましたか？大丈夫です！TDD で一歩ずつ進めていきましょう。</p>
<h3 id="_23">🎯 この章の学習目標<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h3>
<p>この章では、以下のスキルを習得します：</p>
<ul>
<li>🌸 <strong>基本的な分類モデルの構築</strong> - アヤメを分類するモデルを作る</li>
<li>🔄 <strong>テスト駆動開発の基礎習得</strong> - Red-Green-Refactor を実践</li>
<li>🛠️ <strong>scikit-learn の基本 API 理解</strong> - fit()、predict() の使い方</li>
<li>🔧 <strong>データ前処理パイプラインの構築</strong> - データを機械学習用に整形</li>
</ul>
<h3 id="iris">📊 Iris データセットの理解<a class="headerlink" href="#iris" title="Permanent link">&para;</a></h3>
<p>「Iris データセットって何？」と思いますよね。これは、機械学習の世界で<strong>最も有名な教材用データセット</strong>です。統計学者フィッシャーが 1936 年に発表した、アヤメの花のデータです。</p>
<h4 id="_24">データの特徴<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>項目</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>🔢 <strong>サンプル数</strong></td>
<td>150 件（各種類 50 件ずつ）</td>
</tr>
<tr>
<td>📊 <strong>特徴量数</strong></td>
<td>4 つ（全て連続値）</td>
</tr>
<tr>
<td>🏷️ <strong>クラス数</strong></td>
<td>3 つ（setosa、versicolor、virginica）</td>
</tr>
<tr>
<td>✨ <strong>欠損値</strong></td>
<td>なし（クリーンなデータ！）</td>
</tr>
</tbody>
</table>
<p>「欠損値なし！」これは初心者にとって嬉しいポイントです。実際のデータは欠損値だらけですが、まずはシンプルなデータで学びましょう。</p>
<h4 id="_25">データ詳細<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h4>
<p>それぞれの列（カラム）の意味を理解しましょう：</p>
<table>
<thead>
<tr>
<th>列名</th>
<th>内容</th>
<th>単位</th>
<th>値の範囲</th>
</tr>
</thead>
<tbody>
<tr>
<td>🌸 <strong>sepal_length</strong></td>
<td>がく片の長さ</td>
<td>cm</td>
<td>4.3 - 7.9</td>
</tr>
<tr>
<td>🌸 <strong>sepal_width</strong></td>
<td>がく片の幅</td>
<td>cm</td>
<td>2.0 - 4.4</td>
</tr>
<tr>
<td>🌺 <strong>petal_length</strong></td>
<td>花びらの長さ</td>
<td>cm</td>
<td>1.0 - 6.9</td>
</tr>
<tr>
<td>🌺 <strong>petal_width</strong></td>
<td>花びらの幅</td>
<td>cm</td>
<td>0.1 - 2.5</td>
</tr>
<tr>
<td>🏷️ <strong>species</strong></td>
<td>アヤメの種類</td>
<td>-</td>
<td>setosa、versicolor、virginica</td>
</tr>
</tbody>
</table>
<p>この 4 つの特徴量（長さと幅）から、アヤメが 3 種類のうちどれかを予測するのが、この章の目標です！</p>
<h3 id="tdd_1">🔨 TDD による段階的実装<a class="headerlink" href="#tdd_1" title="Permanent link">&para;</a></h3>
<p>「いきなり全部作るの？」いいえ！TDD では<strong>小さなステップで一歩ずつ</strong>進めます。まずはクラスの初期化から始めましょう。</p>
<h4 id="1_2">ステップ 1: クラスの初期化テスト<a class="headerlink" href="#1_2" title="Permanent link">&para;</a></h4>
<h5 id="red_1">🔴 Red: まず失敗するテストを書く<a class="headerlink" href="#red_1" title="Permanent link">&para;</a></h5>
<p><strong>test/test_iris_classifier.py</strong> を作成します：</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Iris 分類器のテスト&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.ml.iris_classifier</span><span class="w"> </span><span class="kn">import</span> <span class="n">IrisClassifier</span>  <span class="c1"># まだ存在しないモジュール</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestIrisClassifierInit</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;IrisClassifier の初期化テスト&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_デフォルトパラメータでの初期化</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;デフォルトパラメータで初期化できることを確認&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">IrisClassifier</span><span class="p">()</span>  <span class="c1"># 分類器を作成</span>

        <span class="k">assert</span> <span class="n">classifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>        <span class="c1"># インスタンスが作られた</span>
        <span class="k">assert</span> <span class="n">classifier</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span>      <span class="c1"># まだモデルは訓練されていない</span>
        <span class="k">assert</span> <span class="n">classifier</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">==</span> <span class="mi">2</span>     <span class="c1"># デフォルトの深さは 2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_カスタムパラメータでの初期化</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;カスタムパラメータで初期化できることを確認&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">IrisClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># 深さ 5 を指定</span>

        <span class="k">assert</span> <span class="n">classifier</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">==</span> <span class="mi">5</span>  <span class="c1"># 指定した値が設定される</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_無効なmax_depthの拒否</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;無効な max_depth を拒否することを確認&quot;&quot;&quot;</span>
        <span class="c1"># 負の値はダメ！</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">IrisClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># 0 もダメ！</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">IrisClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>
<p>テストを実行してみましょう（Red を期待）：</p>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>run<span class="w"> </span>pytest<span class="w"> </span>test/test_iris_classifier.py::TestIrisClassifierInit<span class="w"> </span>-v
</code></pre></div>
<p><strong>期待される出力（失敗）</strong>:
<div class="highlight"><pre><span></span><code>ModuleNotFoundError: No module named &#39;src.ml.iris_classifier&#39;
❌ FAILED
</code></pre></div></p>
<p><strong>失敗しました！</strong> これが正しい TDD の第一歩です。🔴</p>
<h5 id="green_1">🟢 Green: テストを通す最小限の実装<a class="headerlink" href="#green_1" title="Permanent link">&para;</a></h5>
<p>次に、テストを通すための最小限のコードを書きます。</p>
<p><strong>src/ml/iris_classifier.py</strong> を作成：</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Iris 分類器モジュール&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn</span><span class="w"> </span><span class="kn">import</span> <span class="n">tree</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>


<span class="k">class</span><span class="w"> </span><span class="nc">IrisClassifier</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Iris データセットを分類する決定木モデル&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;初期化</span>

<span class="sd">        Args:</span>
<span class="sd">            max_depth: 決定木の最大深さ（デフォルト: 2）</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: max_depth が 1 未満の場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">max_depth</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;max_depth must be at least 1&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeClassifier</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>
<p>テストを実行（Green）：</p>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>run<span class="w"> </span>pytest<span class="w"> </span>test/test_iris_classifier.py::TestIrisClassifierInit<span class="w"> </span>-v

<span class="c1"># 出力例：</span>
<span class="c1"># test/test_iris_classifier.py::TestIrisClassifierInit::test_デフォルトパラメータでの初期化 PASSED</span>
<span class="c1"># test/test_iris_classifier.py::TestIrisClassifierInit::test_カスタムパラメータでの初期化 PASSED</span>
<span class="c1"># test/test_iris_classifier.py::TestIrisClassifierInit::test_無効なmax_depthの拒否 PASSED</span>
<span class="c1"># =========== 3 passed in 0.18s ===========</span>
</code></pre></div>
<h5 id="2_2">ステップ 2: データ読み込みと前処理<a class="headerlink" href="#2_2" title="Permanent link">&para;</a></h5>
<p><strong>Red: テストを書く</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TestIrisClassifierDataLoading</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;データ読み込みのテスト&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_CSVファイルからのデータ読み込み</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;CSV ファイルからデータを読み込めることを確認&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">IrisClassifier</span><span class="p">()</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="s1">&#39;data/iris.csv&#39;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_特徴量の列数確認</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;特徴量が 4 列であることを確認&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">IrisClassifier</span><span class="p">()</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="s1">&#39;data/iris.csv&#39;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span>
        <span class="k">assert</span> <span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span>
            <span class="s1">&#39;sepal_length&#39;</span><span class="p">,</span> <span class="s1">&#39;sepal_width&#39;</span><span class="p">,</span> <span class="s1">&#39;petal_length&#39;</span><span class="p">,</span> <span class="s1">&#39;petal_width&#39;</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_ラベルのユニーク数確認</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ラベルが 3 種類であることを確認&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">IrisClassifier</span><span class="p">()</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="s1">&#39;data/iris.csv&#39;</span><span class="p">)</span>

        <span class="n">unique_species</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_species</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="k">assert</span> <span class="s1">&#39;setosa&#39;</span> <span class="ow">in</span> <span class="n">unique_species</span>
        <span class="k">assert</span> <span class="s1">&#39;versicolor&#39;</span> <span class="ow">in</span> <span class="n">unique_species</span>
        <span class="k">assert</span> <span class="s1">&#39;virginica&#39;</span> <span class="ow">in</span> <span class="n">unique_species</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_欠損値の処理</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;欠損値が適切に処理されることを確認&quot;&quot;&quot;</span>
        <span class="c1"># テスト用に欠損値を含むデータを作成</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

        <span class="n">test_data</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;sepal_length,sepal_width,petal_length,petal_width,species</span>
<span class="s2">5.1,3.5,1.4,0.2,setosa</span>
<span class="s2">,3.0,1.4,0.2,setosa</span>
<span class="s2">7.0,,4.7,1.4,versicolor&quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
            <span class="n">temp_path</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">classifier</span> <span class="o">=</span> <span class="n">IrisClassifier</span><span class="p">()</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>

            <span class="c1"># 欠損値が補完されていることを確認</span>
            <span class="k">assert</span> <span class="n">X</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
</code></pre></div>
<p><strong>Green: データ読み込み機能の実装</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CSV ファイルからデータを読み込む</span>

<span class="sd">    Args:</span>
<span class="sd">        file_path: CSV ファイルのパス</span>

<span class="sd">    Returns:</span>
<span class="sd">        特徴量 DataFrame と正解ラベル Series のタプル</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: ファイルが存在しない場合</span>
<span class="sd">        ValueError: データの形式が不正な場合</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ファイルの存在確認</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># データの読み込み</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="c1"># 必要な列の存在確認</span>
    <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sepal_length&#39;</span><span class="p">,</span> <span class="s1">&#39;sepal_width&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;petal_length&#39;</span><span class="p">,</span> <span class="s1">&#39;petal_width&#39;</span><span class="p">,</span> <span class="s1">&#39;species&#39;</span><span class="p">]</span>
    <span class="n">missing_columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">required_columns</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">missing_columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing columns: </span><span class="si">{</span><span class="n">missing_columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 特徴量列</span>
    <span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sepal_length&#39;</span><span class="p">,</span> <span class="s1">&#39;sepal_width&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;petal_length&#39;</span><span class="p">,</span> <span class="s1">&#39;petal_width&#39;</span><span class="p">]</span>

    <span class="c1"># 欠損値を平均値で補完</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">feature_columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">mean_value</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mean_value</span><span class="p">)</span>

    <span class="c1"># 特徴量と正解ラベルの分割</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature_columns</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>
</code></pre></div>
<p><strong>Refactor: ヘルパーメソッドの抽出</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_validate_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;データフレームの妥当性を検証</span>

<span class="sd">    Args:</span>
<span class="sd">        df: 検証する DataFrame</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: 必要な列が不足している場合</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sepal_length&#39;</span><span class="p">,</span> <span class="s1">&#39;sepal_width&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;petal_length&#39;</span><span class="p">,</span> <span class="s1">&#39;petal_width&#39;</span><span class="p">,</span> <span class="s1">&#39;species&#39;</span><span class="p">]</span>
    <span class="n">missing_columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">required_columns</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">missing_columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing columns: </span><span class="si">{</span><span class="n">missing_columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_fill_missing_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                        <span class="n">columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;欠損値を平均値で補完</span>

<span class="sd">    Args:</span>
<span class="sd">        df: 対象の DataFrame</span>
<span class="sd">        columns: 補完する列のリスト</span>

<span class="sd">    Returns:</span>
<span class="sd">        補完後の DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_filled</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">df_filled</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">mean_value</span> <span class="o">=</span> <span class="n">df_filled</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">df_filled</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_filled</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mean_value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_filled</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CSV ファイルからデータを読み込む（リファクタリング後）&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_validate_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sepal_length&#39;</span><span class="p">,</span> <span class="s1">&#39;sepal_width&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;petal_length&#39;</span><span class="p">,</span> <span class="s1">&#39;petal_width&#39;</span><span class="p">]</span>

    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fill_missing_values</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">feature_columns</span><span class="p">)</span>

    <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature_columns</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>
</code></pre></div>
<h5 id="3">ステップ 3: モデルの訓練<a class="headerlink" href="#3" title="Permanent link">&para;</a></h5>
<p><strong>Red: テストを書く</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TestIrisClassifierTraining</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;モデル訓練のテスト&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_モデルの訓練</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;モデルを訓練できることを確認&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">IrisClassifier</span><span class="p">()</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;sepal_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.1</span><span class="p">,</span> <span class="mf">4.9</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">],</span>
            <span class="s1">&#39;sepal_width&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.2</span><span class="p">],</span>
            <span class="s1">&#39;petal_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.4</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">,</span> <span class="mf">4.7</span><span class="p">],</span>
            <span class="s1">&#39;petal_width&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">]</span>
        <span class="p">})</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="s1">&#39;setosa&#39;</span><span class="p">,</span> <span class="s1">&#39;setosa&#39;</span><span class="p">,</span> <span class="s1">&#39;versicolor&#39;</span><span class="p">])</span>

        <span class="n">classifier</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">classifier</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_訓練済みモデルの属性確認</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;訓練済みモデルが適切な属性を持つことを確認&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">IrisClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;sepal_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.1</span><span class="p">,</span> <span class="mf">4.9</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">],</span>
            <span class="s1">&#39;sepal_width&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.2</span><span class="p">],</span>
            <span class="s1">&#39;petal_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.4</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">,</span> <span class="mf">4.7</span><span class="p">],</span>
            <span class="s1">&#39;petal_width&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">]</span>
        <span class="p">})</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="s1">&#39;setosa&#39;</span><span class="p">,</span> <span class="s1">&#39;setosa&#39;</span><span class="p">,</span> <span class="s1">&#39;versicolor&#39;</span><span class="p">])</span>

        <span class="n">classifier</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">classifier</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">classifier</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;classes_&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_空のデータでの訓練拒否</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;空のデータでの訓練を拒否することを確認&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">IrisClassifier</span><span class="p">()</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">classifier</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_特徴量とラベルの数が不一致の拒否</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;特徴量とラベルの数が一致しない場合を拒否&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">IrisClassifier</span><span class="p">()</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;sepal_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.1</span><span class="p">,</span> <span class="mf">4.9</span><span class="p">],</span>
            <span class="s1">&#39;sepal_width&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">],</span>
            <span class="s1">&#39;petal_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.4</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">],</span>
            <span class="s1">&#39;petal_width&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span>
        <span class="p">})</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="s1">&#39;setosa&#39;</span><span class="p">])</span>  <span class="c1"># 数が一致しない</span>

        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">classifier</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</code></pre></div>
<p><strong>Green: 訓練機能の実装</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;モデルを訓練する</span>

<span class="sd">    Args:</span>
<span class="sd">        X_train: 訓練用特徴量</span>
<span class="sd">        y_train: 訓練用正解ラベル</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: データが空、または特徴量とラベルの数が不一致の場合</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># データの妥当性チェック</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Training data cannot be empty&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;X_train and y_train must have the same length: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># 決定木モデルの作成</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeClassifier</span><span class="p">(</span>
        <span class="n">max_depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span>  <span class="c1"># 再現性のため</span>
    <span class="p">)</span>

    <span class="c1"># モデルの訓練</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</code></pre></div>
<h5 id="4_2">ステップ 4: 予測機能<a class="headerlink" href="#4_2" title="Permanent link">&para;</a></h5>
<p><strong>Red: テストを書く</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TestIrisClassifierPrediction</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;予測機能のテスト&quot;&quot;&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">trained_classifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;訓練済みの分類器を返す fixture&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">IrisClassifier</span><span class="p">()</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;sepal_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.1</span><span class="p">,</span> <span class="mf">4.9</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">,</span> <span class="mf">6.4</span><span class="p">],</span>
            <span class="s1">&#39;sepal_width&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.2</span><span class="p">,</span> <span class="mf">3.2</span><span class="p">],</span>
            <span class="s1">&#39;petal_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.4</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">,</span> <span class="mf">4.7</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">],</span>
            <span class="s1">&#39;petal_width&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">]</span>
        <span class="p">})</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="s1">&#39;setosa&#39;</span><span class="p">,</span> <span class="s1">&#39;setosa&#39;</span><span class="p">,</span> <span class="s1">&#39;versicolor&#39;</span><span class="p">,</span> <span class="s1">&#39;versicolor&#39;</span><span class="p">])</span>
        <span class="n">classifier</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">classifier</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_単一サンプルの予測</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trained_classifier</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;単一サンプルを予測できることを確認&quot;&quot;&quot;</span>
        <span class="n">X_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;sepal_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">],</span>
            <span class="s1">&#39;sepal_width&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">],</span>
            <span class="s1">&#39;petal_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.3</span><span class="p">],</span>
            <span class="s1">&#39;petal_width&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">predictions</span> <span class="o">=</span> <span class="n">trained_classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;setosa&#39;</span><span class="p">,</span> <span class="s1">&#39;versicolor&#39;</span><span class="p">,</span> <span class="s1">&#39;virginica&#39;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_複数サンプルの予測</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trained_classifier</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;複数サンプルを予測できることを確認&quot;&quot;&quot;</span>
        <span class="n">X_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;sepal_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">],</span>
            <span class="s1">&#39;sepal_width&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">3.2</span><span class="p">],</span>
            <span class="s1">&#39;petal_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.3</span><span class="p">,</span> <span class="mf">4.7</span><span class="p">],</span>
            <span class="s1">&#39;petal_width&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">predictions</span> <span class="o">=</span> <span class="n">trained_classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_未訓練モデルでの予測拒否</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;未訓練モデルでの予測を拒否することを確認&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">IrisClassifier</span><span class="p">()</span>
        <span class="n">X_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;sepal_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">],</span>
            <span class="s1">&#39;sepal_width&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">],</span>
            <span class="s1">&#39;petal_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.3</span><span class="p">],</span>
            <span class="s1">&#39;petal_width&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</code></pre></div>
<p><strong>Green: 予測機能の実装</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;予測を実行する</span>

<span class="sd">    Args:</span>
<span class="sd">        X_test: テスト用特徴量</span>

<span class="sd">    Returns:</span>
<span class="sd">        予測されたクラスラベルの配列</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: モデルが未訓練の場合</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model has not been trained yet&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</code></pre></div>
<h5 id="5">ステップ 5: モデル評価<a class="headerlink" href="#5" title="Permanent link">&para;</a></h5>
<p><strong>Red: テストを書く</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TestIrisClassifierEvaluation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;モデル評価のテスト&quot;&quot;&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">trained_classifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;訓練済みの分類器&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">IrisClassifier</span><span class="p">()</span>
        <span class="n">classifier</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="s1">&#39;data/iris.csv&#39;</span><span class="p">)</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="s1">&#39;data/iris.csv&#39;</span><span class="p">)</span>
        <span class="n">classifier</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">classifier</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_正解率の計算</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trained_classifier</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;正解率を計算できることを確認&quot;&quot;&quot;</span>
        <span class="n">X_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;sepal_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.1</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">],</span>
            <span class="s1">&#39;sepal_width&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">3.2</span><span class="p">],</span>
            <span class="s1">&#39;petal_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.4</span><span class="p">,</span> <span class="mf">4.7</span><span class="p">],</span>
            <span class="s1">&#39;petal_width&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">]</span>
        <span class="p">})</span>
        <span class="n">y_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="s1">&#39;setosa&#39;</span><span class="p">,</span> <span class="s1">&#39;versicolor&#39;</span><span class="p">])</span>

        <span class="n">accuracy</span> <span class="o">=</span> <span class="n">trained_classifier</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

        <span class="k">assert</span> <span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">accuracy</span> <span class="o">&lt;=</span> <span class="mf">1.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_完全一致時の正解率</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;全て正解の場合に正解率が 1.0 になることを確認&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">IrisClassifier</span><span class="p">()</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;sepal_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.1</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">],</span>
            <span class="s1">&#39;sepal_width&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">3.2</span><span class="p">],</span>
            <span class="s1">&#39;petal_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.4</span><span class="p">,</span> <span class="mf">4.7</span><span class="p">],</span>
            <span class="s1">&#39;petal_width&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">]</span>
        <span class="p">})</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="s1">&#39;setosa&#39;</span><span class="p">,</span> <span class="s1">&#39;versicolor&#39;</span><span class="p">])</span>
        <span class="n">classifier</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="c1"># 訓練データと同じデータでテスト（必ず正解）</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">accuracy</span> <span class="o">==</span> <span class="mf">1.0</span>
</code></pre></div>
<p><strong>Green: 評価機能の実装</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;モデルの性能を評価する</span>

<span class="sd">    Args:</span>
<span class="sd">        X_test: テスト用特徴量</span>
<span class="sd">        y_test: テスト用正解ラベル</span>

<span class="sd">    Returns:</span>
<span class="sd">        正解率（0.0 〜 1.0）</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: モデルが未訓練の場合</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model has not been trained yet&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</code></pre></div>
<h5 id="6">ステップ 6: モデルの保存と読み込み<a class="headerlink" href="#6" title="Permanent link">&para;</a></h5>
<p><strong>Red: テストを書く</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TestIrisClassifierPersistence</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;モデルの永続化テスト&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_モデルの保存</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trained_classifier</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;訓練済みモデルを保存できることを確認&quot;&quot;&quot;</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;iris_model.pkl&quot;</span>

        <span class="n">trained_classifier</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">model_path</span><span class="p">))</span>

        <span class="k">assert</span> <span class="n">model_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_モデルの読み込み</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;保存したモデルを読み込めることを確認&quot;&quot;&quot;</span>
        <span class="c1"># モデルを訓練して保存</span>
        <span class="n">classifier1</span> <span class="o">=</span> <span class="n">IrisClassifier</span><span class="p">()</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;sepal_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.1</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">],</span>
            <span class="s1">&#39;sepal_width&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">3.2</span><span class="p">],</span>
            <span class="s1">&#39;petal_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.4</span><span class="p">,</span> <span class="mf">4.7</span><span class="p">],</span>
            <span class="s1">&#39;petal_width&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">]</span>
        <span class="p">})</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="s1">&#39;setosa&#39;</span><span class="p">,</span> <span class="s1">&#39;versicolor&#39;</span><span class="p">])</span>
        <span class="n">classifier1</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="n">model_path</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;iris_model.pkl&quot;</span>
        <span class="n">classifier1</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">model_path</span><span class="p">))</span>

        <span class="c1"># 新しいインスタンスでモデルを読み込み</span>
        <span class="n">classifier2</span> <span class="o">=</span> <span class="n">IrisClassifier</span><span class="p">()</span>
        <span class="n">classifier2</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">model_path</span><span class="p">))</span>

        <span class="k">assert</span> <span class="n">classifier2</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_保存したモデルでの予測一貫性</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;保存前後で予測結果が一致することを確認&quot;&quot;&quot;</span>
        <span class="c1"># モデルを訓練</span>
        <span class="n">classifier1</span> <span class="o">=</span> <span class="n">IrisClassifier</span><span class="p">()</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;sepal_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.1</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">],</span>
            <span class="s1">&#39;sepal_width&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">3.2</span><span class="p">],</span>
            <span class="s1">&#39;petal_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.4</span><span class="p">,</span> <span class="mf">4.7</span><span class="p">],</span>
            <span class="s1">&#39;petal_width&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">]</span>
        <span class="p">})</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="s1">&#39;setosa&#39;</span><span class="p">,</span> <span class="s1">&#39;versicolor&#39;</span><span class="p">])</span>
        <span class="n">classifier1</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="c1"># テストデータ</span>
        <span class="n">X_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;sepal_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">],</span>
            <span class="s1">&#39;sepal_width&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.4</span><span class="p">],</span>
            <span class="s1">&#39;petal_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">],</span>
            <span class="s1">&#39;petal_width&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="c1"># 保存前の予測</span>
        <span class="n">pred_before</span> <span class="o">=</span> <span class="n">classifier1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

        <span class="c1"># モデルの保存と読み込み</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;iris_model.pkl&quot;</span>
        <span class="n">classifier1</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">model_path</span><span class="p">))</span>

        <span class="n">classifier2</span> <span class="o">=</span> <span class="n">IrisClassifier</span><span class="p">()</span>
        <span class="n">classifier2</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">model_path</span><span class="p">))</span>

        <span class="c1"># 読み込み後の予測</span>
        <span class="n">pred_after</span> <span class="o">=</span> <span class="n">classifier2</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">pred_before</span><span class="p">,</span> <span class="n">pred_after</span><span class="p">)</span>
</code></pre></div>
<p><strong>Green: 永続化機能の実装</strong></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>


<span class="k">def</span><span class="w"> </span><span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;訓練済みモデルをファイルに保存する</span>

<span class="sd">    Args:</span>
<span class="sd">        file_path: 保存先のファイルパス</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: モデルが未訓練の場合</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No trained model to save&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;保存されたモデルをファイルから読み込む</span>

<span class="sd">    Args:</span>
<span class="sd">        file_path: 読み込むファイルのパス</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: ファイルが存在しない場合</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model file not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</code></pre></div>
<h4 id="_26">完全な実装例<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h4>
<p>すべての機能を統合した完全な <code>IrisClassifier</code> クラス：</p>
<p><strong>src/ml/iris_classifier.py</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Iris 分類器モジュール&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn</span><span class="w"> </span><span class="kn">import</span> <span class="n">tree</span>


<span class="k">class</span><span class="w"> </span><span class="nc">IrisClassifier</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Iris データセットを分類する決定木モデル</span>

<span class="sd">    Attributes:</span>
<span class="sd">        max_depth: 決定木の最大深さ</span>
<span class="sd">        model: 訓練済みの決定木モデル（未訓練時は None）</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;初期化</span>

<span class="sd">        Args:</span>
<span class="sd">            max_depth: 決定木の最大深さ（デフォルト: 2）</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: max_depth が 1 未満の場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">max_depth</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;max_depth must be at least 1&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeClassifier</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;データフレームの妥当性を検証</span>

<span class="sd">        Args:</span>
<span class="sd">            df: 検証する DataFrame</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: 必要な列が不足している場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sepal_length&#39;</span><span class="p">,</span> <span class="s1">&#39;sepal_width&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;petal_length&#39;</span><span class="p">,</span> <span class="s1">&#39;petal_width&#39;</span><span class="p">,</span> <span class="s1">&#39;species&#39;</span><span class="p">]</span>
        <span class="n">missing_columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">required_columns</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing_columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing columns: </span><span class="si">{</span><span class="n">missing_columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fill_missing_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                            <span class="n">columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;欠損値を平均値で補完</span>

<span class="sd">        Args:</span>
<span class="sd">            df: 対象の DataFrame</span>
<span class="sd">            columns: 補完する列のリスト</span>

<span class="sd">        Returns:</span>
<span class="sd">            補完後の DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_filled</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">df_filled</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">mean_value</span> <span class="o">=</span> <span class="n">df_filled</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">df_filled</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_filled</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mean_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_filled</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;CSV ファイルからデータを読み込む</span>

<span class="sd">        Args:</span>
<span class="sd">            file_path: CSV ファイルのパス</span>

<span class="sd">        Returns:</span>
<span class="sd">            特徴量 DataFrame と正解ラベル Series のタプル</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: ファイルが存在しない場合</span>
<span class="sd">            ValueError: データの形式が不正な場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sepal_length&#39;</span><span class="p">,</span> <span class="s1">&#39;sepal_width&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;petal_length&#39;</span><span class="p">,</span> <span class="s1">&#39;petal_width&#39;</span><span class="p">]</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fill_missing_values</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">feature_columns</span><span class="p">)</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature_columns</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;モデルを訓練する</span>

<span class="sd">        Args:</span>
<span class="sd">            X_train: 訓練用特徴量</span>
<span class="sd">            y_train: 訓練用正解ラベル</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: データが空、または特徴量とラベルの数が不一致の場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Training data cannot be empty&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;X_train and y_train must have the same length: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeClassifier</span><span class="p">(</span>
            <span class="n">max_depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;予測を実行する</span>

<span class="sd">        Args:</span>
<span class="sd">            X_test: テスト用特徴量</span>

<span class="sd">        Returns:</span>
<span class="sd">            予測されたクラスラベルの配列</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: モデルが未訓練の場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model has not been trained yet&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;モデルの性能を評価する</span>

<span class="sd">        Args:</span>
<span class="sd">            X_test: テスト用特徴量</span>
<span class="sd">            y_test: テスト用正解ラベル</span>

<span class="sd">        Returns:</span>
<span class="sd">            正解率（0.0 〜 1.0）</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: モデルが未訓練の場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model has not been trained yet&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;訓練済みモデルをファイルに保存する</span>

<span class="sd">        Args:</span>
<span class="sd">            file_path: 保存先のファイルパス</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: モデルが未訓練の場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No trained model to save&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;保存されたモデルをファイルから読み込む</span>

<span class="sd">        Args:</span>
<span class="sd">            file_path: 読み込むファイルのパス</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: ファイルが存在しない場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model file not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</code></pre></div>
<h4 id="iris_1">実践例：Iris 分類モデルの訓練<a class="headerlink" href="#iris_1" title="Permanent link">&para;</a></h4>
<p>実際にモデルを訓練して評価する完全な例：</p>
<p><strong>examples/train_iris.py</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Iris 分類モデルの訓練例&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.ml.iris_classifier</span><span class="w"> </span><span class="kn">import</span> <span class="n">IrisClassifier</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;メイン処理&quot;&quot;&quot;</span>
    <span class="c1"># 分類器の作成</span>
    <span class="n">classifier</span> <span class="o">=</span> <span class="n">IrisClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;IrisClassifier を作成しました&quot;</span><span class="p">)</span>

    <span class="c1"># データの読み込み</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="s1">&#39;data/iris.csv&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;データを読み込みました: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="si">}</span><span class="s2"> サンプル&quot;</span><span class="p">)</span>

    <span class="c1"># 訓練データとテストデータに分割</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;訓練データ: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="si">}</span><span class="s2"> サンプル&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;テストデータ: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="si">}</span><span class="s2"> サンプル&quot;</span><span class="p">)</span>

    <span class="c1"># モデルの訓練</span>
    <span class="n">classifier</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;モデルの訓練が完了しました&quot;</span><span class="p">)</span>

    <span class="c1"># 訓練データでの評価</span>
    <span class="n">train_accuracy</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;訓練データでの正解率: </span><span class="si">{</span><span class="n">train_accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># テストデータでの評価</span>
    <span class="n">test_accuracy</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;テストデータでの正解率: </span><span class="si">{</span><span class="n">test_accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># モデルの保存</span>
    <span class="n">classifier</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="s1">&#39;model/iris.pkl&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;モデルを model/iris.pkl に保存しました&quot;</span><span class="p">)</span>

    <span class="c1"># 予測例</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">予測例:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;サンプル </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">predictions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - がく片: 長さ=</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;sepal_length&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, 幅=</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;sepal_width&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - 花弁: 長さ=</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;petal_length&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, 幅=</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;petal_width&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<p>実行例：</p>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>run<span class="w"> </span>python<span class="w"> </span>examples/train_iris.py

<span class="c1"># 出力例：</span>
<span class="c1"># IrisClassifier を作成しました</span>
<span class="c1"># データを読み込みました: 150 サンプル</span>
<span class="c1"># 訓練データ: 105 サンプル</span>
<span class="c1"># テストデータ: 45 サンプル</span>
<span class="c1"># モデルの訓練が完了しました</span>
<span class="c1"># 訓練データでの正解率: 0.9810</span>
<span class="c1"># テストデータでの正解率: 0.9778</span>
<span class="c1">#</span>
<span class="c1"># 予測例:</span>
<span class="c1"># サンプル 1: versicolor</span>
<span class="c1">#   - がく片: 長さ=6.1, 幅=2.8</span>
<span class="c1">#   - 花弁: 長さ=4.7, 幅=1.2</span>
<span class="c1"># サンプル 2: setosa</span>
<span class="c1">#   - がく片: 長さ=5.7, 幅=3.8</span>
<span class="c1">#   - 花弁: 長さ=1.7, 幅=0.3</span>
<span class="c1"># サンプル 3: virginica</span>
<span class="c1">#   - がく片: 長さ=7.7, 幅=2.6</span>
<span class="c1">#   - 花弁: 長さ=6.9, 幅=2.3</span>
</code></pre></div>
<hr />
<h3 id="4_3">📊 ４章の技術的成果<a class="headerlink" href="#4_3" title="Permanent link">&para;</a></h3>
<p>「ついに最初の機械学習モデルが完成しました！」お疲れさまでした！４章で何を達成したか、振り返ってみましょう。</p>
<h4 id="_27">✅ 完成した機能<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h4>
<p>４章では、以下の機能を実装しました：</p>
<ul>
<li>✅ <strong>Iris 分類器クラスの完全実装</strong> - アヤメを分類するモデル</li>
<li>✅ <strong>データ読み込みと前処理パイプライン</strong> - CSV から学習用データへ</li>
<li>✅ <strong>決定木モデルの訓練機能</strong> - データから学習</li>
<li>✅ <strong>予測機能</strong> - 新しいデータの種類を予測</li>
<li>✅ <strong>モデル評価機能</strong> - 正解率を計算</li>
<li>✅ <strong>モデルの保存と読み込み機能</strong> - 学習したモデルを再利用</li>
</ul>
<h4 id="_28">📈 定量的成果<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h4>
<p>数字で見ると、こんなに達成しました！</p>
<table>
<thead>
<tr>
<th>指標</th>
<th>🎯 実績</th>
</tr>
</thead>
<tbody>
<tr>
<td>🧪 <strong>テストケース</strong></td>
<td>18 個</td>
</tr>
<tr>
<td>📊 <strong>コードカバレッジ</strong></td>
<td>95%（iris_classifier.py）</td>
</tr>
<tr>
<td>🔤 <strong>型ヒント使用率</strong></td>
<td>100%</td>
</tr>
<tr>
<td>🌸 <strong>モデル正解率</strong></td>
<td><strong>97.78%</strong>（テストデータ）</td>
</tr>
<tr>
<td>✨ <strong>Ruff チェック</strong></td>
<td>全て通過</td>
</tr>
<tr>
<td>✅ <strong>mypy チェック</strong></td>
<td>エラー 0 件</td>
</tr>
</tbody>
</table>
<p><strong>97.78% の正解率！</strong> これはとても良い結果です！🎉</p>
<h4 id="_29">🎓 習得したスキル<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h4>
<h5 id="1-tdd">1. 🔄 TDD スキル（発展）<a class="headerlink" href="#1-tdd" title="Permanent link">&para;</a></h5>
<ul>
<li>✅ 複雑なクラスの段階的実装</li>
<li>✅ Fixture を活用したテストの効率化</li>
<li>✅ エッジケースの網羅的テスト</li>
</ul>
<h5 id="2_3">2. 🤖 機械学習スキル<a class="headerlink" href="#2_3" title="Permanent link">&para;</a></h5>
<ul>
<li>✅ 決定木アルゴリズムの理解</li>
<li>✅ 訓練データとテストデータの分割</li>
<li>✅ モデル評価指標（正解率）の理解</li>
<li>✅ モデルの永続化（pickle）</li>
</ul>
<h5 id="3_1">3. 📊 データ処理スキル<a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h5>
<ul>
<li>✅ pandas による DataFrame 操作</li>
<li>✅ 欠損値の処理</li>
<li>✅ データの妥当性検証</li>
</ul>
<h5 id="4_4">4. 🏗️ ソフトウェア設計スキル<a class="headerlink" href="#4_4" title="Permanent link">&para;</a></h5>
<ul>
<li>✅ 単一責任の原則（SRP）の適用</li>
<li>✅ ヘルパーメソッドによる責務分離</li>
<li>✅ 型ヒントによる契約の明示</li>
</ul>
<h5 id="_30">決定木アルゴリズムの理解<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h5>
<p><strong>決定木とは</strong>：
データを複数の条件分岐で分類するアルゴリズムです。</p>
<div class="highlight"><pre><span></span><code>                [Root]
                  |
         petal_length &lt;= 2.45?
         /                    \
       Yes                     No
        |                       |
    setosa            petal_width &lt;= 1.75?
                     /                    \
                   Yes                     No
                    |                       |
              versicolor                virginica
</code></pre></div>
<p><strong>max_depth パラメータの影響</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_max_depthと正解率の関係</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;max_depth が正解率に与える影響を確認&quot;&quot;&quot;</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">load_iris_data</span><span class="p">()</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">depth</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">]:</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">IrisClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="n">depth</span><span class="p">)</span>
        <span class="n">classifier</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="n">train_acc</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">test_acc</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="n">depth</span><span class="p">,</span>
            <span class="s1">&#39;train_accuracy&#39;</span><span class="p">:</span> <span class="n">train_acc</span><span class="p">,</span>
            <span class="s1">&#39;test_accuracy&#39;</span><span class="p">:</span> <span class="n">test_acc</span><span class="p">,</span>
            <span class="s1">&#39;gap&#39;</span><span class="p">:</span> <span class="n">train_acc</span> <span class="o">-</span> <span class="n">test_acc</span>
        <span class="p">})</span>

    <span class="c1"># depth=2 あたりが適切（過学習を避ける）</span>
    <span class="c1"># depth が大きすぎると訓練データに過学習</span>
</code></pre></div>
<h4 id="_31">🚀 次の章への準備<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h4>
<p>４章では、最初の機械学習モデルを作成しました！次の５章では、以下を実装します：</p>
<ul>
<li>🎬 <strong>Cinema 興行収入予測モデル</strong> - 線形回帰による数値予測</li>
<li>📊 <strong>外れ値検出と除外</strong> - 異常なデータの処理</li>
<li>📈 <strong>複数の評価指標</strong> - R²、MAE、RMSE の使い分け</li>
<li>📉 <strong>データの可視化</strong> - グラフで結果を確認</li>
</ul>
<p>分類問題の次は、<strong>回帰問題</strong>に挑戦です！準備はできましたか？😊</p>
<hr />
<hr />
<h2 id="5-cinema">５章 Cinema 興行収入予測モデル（回帰問題の基礎）<a class="headerlink" href="#5-cinema" title="Permanent link">&para;</a></h2>
<p>「分類ができるようになったら、次は何？」次は<strong>回帰問題</strong>に挑戦します！「回帰って何？」簡単に言うと、<strong>数値を予測する問題</strong>です。</p>
<p>この章では、映画の情報から興行収入を予測するモデルを作ります。ワクワクしませんか？🎬</p>
<h3 id="_32">🎯 この章の学習目標<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h3>
<p>この章では、以下のスキルを習得します：</p>
<ul>
<li>📊 <strong>回帰問題の理解と実装</strong> - 数値を予測するモデルを作る</li>
<li>🔧 <strong>データの前処理技術</strong> - 欠損値・外れ値の処理方法を学ぶ</li>
<li>📈 <strong>評価指標の選択と解釈</strong> - R²、MAE、RMSE の使い分け</li>
<li>📉 <strong>線形回帰モデルの構築</strong> - 最もシンプルな回帰モデルを理解</li>
</ul>
<h3 id="cinema">🎬 Cinema データセットの理解<a class="headerlink" href="#cinema" title="Permanent link">&para;</a></h3>
<p>Cinema データセットは、<strong>映画の SNS 露出度から興行収入を予測する</strong>回帰問題のデータセットです。</p>
<p>「SNS のつぶやき数で興行収入がわかるの？」と思いましたか？実際、SNS での話題性は興行収入と相関があることが知られています！</p>
<h4 id="_33">データの特徴<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>項目</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>🎥 <strong>サンプル数</strong></td>
<td>100 件程度</td>
</tr>
<tr>
<td>📊 <strong>特徴量数</strong></td>
<td>4 つ（数値とカテゴリカル変数の混在）</td>
</tr>
<tr>
<td>💰 <strong>目的変数</strong></td>
<td>興行収入（連続値）</td>
</tr>
<tr>
<td>⚠️ <strong>欠損値</strong></td>
<td>あり（前処理が必要！）</td>
</tr>
<tr>
<td>⚠️ <strong>外れ値</strong></td>
<td>あり（データクリーニングが必要！）</td>
</tr>
</tbody>
</table>
<p>「欠損値あり！」これが、Iris データセットとの大きな違いです。実際のデータは完璧ではありません。この章で、現実的なデータ処理を学びましょう！</p>
<h4 id="_34">データ詳細<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>列名</th>
<th>内容</th>
<th>データ型</th>
<th>値の範囲</th>
</tr>
</thead>
<tbody>
<tr>
<td>🎬 <strong>cinema_id</strong></td>
<td>映画作品の ID</td>
<td>int</td>
<td>1 - 100</td>
</tr>
<tr>
<td>📱 <strong>SNS1</strong></td>
<td>公開後 10 日以内に SNS1 でつぶやかれた数</td>
<td>float</td>
<td>0 - 1000</td>
</tr>
<tr>
<td>📱 <strong>SNS2</strong></td>
<td>公開後 10 日以内に SNS2 でつぶやかれた数</td>
<td>float</td>
<td>0 - 2000</td>
</tr>
<tr>
<td>🎭 <strong>actor</strong></td>
<td>主演俳優の昨年のメディア露出度</td>
<td>float</td>
<td>0 - 500</td>
</tr>
<tr>
<td>📚 <strong>original</strong></td>
<td>原作があるかどうか</td>
<td>int</td>
<td>0（なし）、1（あり）</td>
</tr>
<tr>
<td>💰 <strong>sales</strong></td>
<td>最終的な興行収入（万円）</td>
<td>float</td>
<td>1000 - 15000</td>
</tr>
</tbody>
</table>
<h3 id="_35">🔍 分類問題と回帰問題の違い<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h3>
<p>「前の章の Iris と何が違うの？」良い質問です！比較してみましょう：</p>
<table>
<thead>
<tr>
<th>項目</th>
<th>🌸 Iris（分類）</th>
<th>🎬 Cinema（回帰）</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>目的</strong></td>
<td>カテゴリを予測</td>
<td>数値を予測</td>
</tr>
<tr>
<td><strong>出力</strong></td>
<td>setosa、versicolor、virginica</td>
<td>興行収入（連続値）</td>
</tr>
<tr>
<td><strong>アルゴリズム</strong></td>
<td>決定木分類器</td>
<td>線形回帰</td>
</tr>
<tr>
<td><strong>評価指標</strong></td>
<td>正解率（Accuracy）</td>
<td>R²、MAE、RMSE</td>
</tr>
<tr>
<td><strong>誤差の性質</strong></td>
<td>正解/不正解の 2 値</td>
<td>誤差の大きさが重要</td>
</tr>
</tbody>
</table>
<p><strong>重要な違い</strong>：
- 分類は「どのクラス？」を答える問題
- 回帰は「どのくらい？」を答える問題</p>
<h4 id="tdd_2">TDD による段階的実装<a class="headerlink" href="#tdd_2" title="Permanent link">&para;</a></h4>
<h5 id="1_3">ステップ 1: クラスの初期化とデータ読み込み<a class="headerlink" href="#1_3" title="Permanent link">&para;</a></h5>
<p><strong>Red: テストを書く</strong></p>
<p><strong>test/test_cinema_predictor.py</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Cinema 予測器のテスト&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.ml.cinema_predictor</span><span class="w"> </span><span class="kn">import</span> <span class="n">CinemaPredictor</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestCinemaPredictorInit</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CinemaPredictor の初期化テスト&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_デフォルトパラメータでの初期化</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;デフォルトパラメータで初期化できることを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">CinemaPredictor</span><span class="p">()</span>

        <span class="k">assert</span> <span class="n">predictor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">predictor</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_初期化時の属性確認</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;初期化時に必要な属性が設定されることを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">CinemaPredictor</span><span class="p">()</span>

        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">predictor</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestCinemaPredictorDataLoading</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;データ読み込みのテスト&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_CSVファイルからのデータ読み込み</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;CSV ファイルからデータを読み込めることを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">CinemaPredictor</span><span class="p">()</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="s1">&#39;data/cinema.csv&#39;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_特徴量の列数確認</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;特徴量が 4 列であることを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">CinemaPredictor</span><span class="p">()</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="s1">&#39;data/cinema.csv&#39;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span>
        <span class="n">expected_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SNS1&#39;</span><span class="p">,</span> <span class="s1">&#39;SNS2&#39;</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">,</span> <span class="s1">&#39;original&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected_columns</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_欠損値の補完</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;欠損値が平均値で補完されることを確認&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

        <span class="c1"># 欠損値を含むテストデータ</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;cinema_id,SNS1,SNS2,actor,original,sales</span>
<span class="s2">1,100,500,200,1,10000</span>
<span class="s2">2,,600,250,0,11000</span>
<span class="s2">3,150,,300,1,12000&quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
            <span class="n">temp_path</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">predictor</span> <span class="o">=</span> <span class="n">CinemaPredictor</span><span class="p">()</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>

            <span class="c1"># 欠損値が補完されていることを確認</span>
            <span class="k">assert</span> <span class="n">X</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_目的変数の分離</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;sales が目的変数として正しく分離されることを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">CinemaPredictor</span><span class="p">()</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="s1">&#39;data/cinema.csv&#39;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="s1">&#39;sales&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">assert</span> <span class="n">y</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;sales&#39;</span>
</code></pre></div>
<p><strong>Green: 最小限の実装</strong></p>
<p><strong>src/ml/cinema_predictor.py</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Cinema 興行収入予測器モジュール&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_absolute_error</span><span class="p">,</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CinemaPredictor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;映画興行収入を予測する線形回帰モデル</span>

<span class="sd">    Attributes:</span>
<span class="sd">        model: 訓練済みの線形回帰モデル（未訓練時は None）</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;初期化&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LinearRegression</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;CSV ファイルからデータを読み込む</span>

<span class="sd">        Args:</span>
<span class="sd">            file_path: CSV ファイルのパス</span>

<span class="sd">        Returns:</span>
<span class="sd">            特徴量 DataFrame と目的変数 Series のタプル</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: ファイルが存在しない場合</span>
<span class="sd">            ValueError: データの形式が不正な場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># データの読み込み</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="c1"># 必要な列の存在確認</span>
        <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SNS1&#39;</span><span class="p">,</span> <span class="s1">&#39;SNS2&#39;</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">,</span> <span class="s1">&#39;original&#39;</span><span class="p">,</span> <span class="s1">&#39;sales&#39;</span><span class="p">]</span>
        <span class="n">missing_columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">required_columns</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing_columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing columns: </span><span class="si">{</span><span class="n">missing_columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 特徴量列</span>
        <span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SNS1&#39;</span><span class="p">,</span> <span class="s1">&#39;SNS2&#39;</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">,</span> <span class="s1">&#39;original&#39;</span><span class="p">]</span>

        <span class="c1"># 欠損値を平均値で補完</span>
        <span class="n">df_filled</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

        <span class="c1"># 特徴量と目的変数の分割</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">df_filled</span><span class="p">[</span><span class="n">feature_columns</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df_filled</span><span class="p">[</span><span class="s1">&#39;sales&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>
</code></pre></div>
<h5 id="2_4">ステップ 2: 外れ値処理<a class="headerlink" href="#2_4" title="Permanent link">&para;</a></h5>
<p>回帰問題では、外れ値がモデルの性能に大きく影響します。</p>
<p><strong>Red: テストを書く</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TestCinemaPredictorOutlierRemoval</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;外れ値除外のテスト&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_外れ値の検出</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;外れ値を検出できることを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">CinemaPredictor</span><span class="p">()</span>

        <span class="c1"># 外れ値を含むデータ</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;SNS1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">120</span><span class="p">],</span>
            <span class="s1">&#39;SNS2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">600</span><span class="p">],</span>  <span class="c1"># 1500 が異常に高い</span>
            <span class="s1">&#39;actor&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">220</span><span class="p">],</span>
            <span class="s1">&#39;original&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;sales&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="mi">11000</span><span class="p">]</span>  <span class="c1"># SNS2高いのに sales低い→外れ値</span>
        <span class="p">})</span>

        <span class="n">df_cleaned</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">remove_outliers</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># 外れ値が除外されていることを確認</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_cleaned</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="k">assert</span> <span class="mi">1500</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_cleaned</span><span class="p">[</span><span class="s1">&#39;SNS2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_正常データは保持される</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;正常なデータは保持されることを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">CinemaPredictor</span><span class="p">()</span>

        <span class="c1"># 正常なデータのみ</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;SNS1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">120</span><span class="p">],</span>
            <span class="s1">&#39;SNS2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">550</span><span class="p">],</span>
            <span class="s1">&#39;actor&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">220</span><span class="p">],</span>
            <span class="s1">&#39;original&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;sales&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">11000</span><span class="p">,</span> <span class="mi">10500</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">df_cleaned</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">remove_outliers</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># 全てのデータが保持される</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_cleaned</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_外れ値除外の基準</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;外れ値除外の基準が正しいことを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">CinemaPredictor</span><span class="p">()</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;SNS1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">140</span><span class="p">],</span>
            <span class="s1">&#39;SNS2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">700</span><span class="p">],</span>
            <span class="s1">&#39;actor&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">230</span><span class="p">],</span>
            <span class="s1">&#39;original&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;sales&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="mi">11000</span><span class="p">,</span> <span class="mi">10500</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">df_cleaned</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">remove_outliers</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># SNS2 &gt; 1000 かつ sales &lt; 8500 のデータが除外される</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_cleaned</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;SNS2&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;sales&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">8500</span>
</code></pre></div>
<p><strong>Green: 外れ値処理の実装</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">remove_outliers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;外れ値を除外する</span>

<span class="sd">    Args:</span>
<span class="sd">        df: 対象の DataFrame</span>

<span class="sd">    Returns:</span>
<span class="sd">        外れ値を除外した DataFrame</span>

<span class="sd">    Note:</span>
<span class="sd">        SNS2 が 1000 を超えているにも関わらず sales が 8500 未満のデータを</span>
<span class="sd">        異常値として除外します。</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 外れ値の条件: SNS2 &gt; 1000 かつ sales &lt; 8500</span>
    <span class="n">outlier_condition</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;SNS2&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sales&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">8500</span><span class="p">)</span>
    <span class="n">outlier_indices</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">outlier_condition</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>

    <span class="c1"># 外れ値を除外</span>
    <span class="n">df_cleaned</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">outlier_indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_cleaned</span>
</code></pre></div>
<p><strong>Refactor: データ読み込みに外れ値処理を統合</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
              <span class="n">remove_outliers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CSV ファイルからデータを読み込む（外れ値処理追加）</span>

<span class="sd">    Args:</span>
<span class="sd">        file_path: CSV ファイルのパス</span>
<span class="sd">        remove_outliers: 外れ値を除外するかどうか（デフォルト: True）</span>

<span class="sd">    Returns:</span>
<span class="sd">        特徴量 DataFrame と目的変数 Series のタプル</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SNS1&#39;</span><span class="p">,</span> <span class="s1">&#39;SNS2&#39;</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">,</span> <span class="s1">&#39;original&#39;</span><span class="p">,</span> <span class="s1">&#39;sales&#39;</span><span class="p">]</span>
    <span class="n">missing_columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">required_columns</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">missing_columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing columns: </span><span class="si">{</span><span class="n">missing_columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 欠損値を平均値で補完</span>
    <span class="n">df_filled</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

    <span class="c1"># 外れ値の除外（オプション）</span>
    <span class="k">if</span> <span class="n">remove_outliers</span><span class="p">:</span>
        <span class="n">df_filled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_outliers</span><span class="p">(</span><span class="n">df_filled</span><span class="p">)</span>

    <span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SNS1&#39;</span><span class="p">,</span> <span class="s1">&#39;SNS2&#39;</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">,</span> <span class="s1">&#39;original&#39;</span><span class="p">]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">df_filled</span><span class="p">[</span><span class="n">feature_columns</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df_filled</span><span class="p">[</span><span class="s1">&#39;sales&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>
</code></pre></div>
<h5 id="3_2">ステップ 3: モデルの訓練<a class="headerlink" href="#3_2" title="Permanent link">&para;</a></h5>
<p><strong>Red: テストを書く</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TestCinemaPredictorTraining</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;モデル訓練のテスト&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_モデルの訓練</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;線形回帰モデルを訓練できることを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">CinemaPredictor</span><span class="p">()</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;SNS1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">120</span><span class="p">],</span>
            <span class="s1">&#39;SNS2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">550</span><span class="p">],</span>
            <span class="s1">&#39;actor&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">220</span><span class="p">],</span>
            <span class="s1">&#39;original&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">})</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">11000</span><span class="p">,</span> <span class="mi">10500</span><span class="p">])</span>

        <span class="n">predictor</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">predictor</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">predictor</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">LinearRegression</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_訓練済みモデルの係数確認</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;訓練済みモデルが係数を持つことを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">CinemaPredictor</span><span class="p">()</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;SNS1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">120</span><span class="p">],</span>
            <span class="s1">&#39;SNS2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">550</span><span class="p">],</span>
            <span class="s1">&#39;actor&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">220</span><span class="p">],</span>
            <span class="s1">&#39;original&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">})</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">11000</span><span class="p">,</span> <span class="mi">10500</span><span class="p">])</span>

        <span class="n">predictor</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="c1"># 線形回帰の係数が設定されていることを確認</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">predictor</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;coef_&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">predictor</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;intercept_&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictor</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>  <span class="c1"># 特徴量が4つ</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_空のデータでの訓練拒否</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;空のデータでの訓練を拒否することを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">CinemaPredictor</span><span class="p">()</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">predictor</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</code></pre></div>
<p><strong>Green: 訓練機能の実装</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;線形回帰モデルを訓練する</span>

<span class="sd">    Args:</span>
<span class="sd">        X_train: 訓練用特徴量</span>
<span class="sd">        y_train: 訓練用目的変数</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: データが空の場合</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Training data cannot be empty&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;X_train and y_train must have the same length: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># 線形回帰モデルの作成</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>

    <span class="c1"># モデルの訓練</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</code></pre></div>
<h5 id="4_5">ステップ 4: 予測と評価<a class="headerlink" href="#4_5" title="Permanent link">&para;</a></h5>
<p><strong>Red: テストを書く</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TestCinemaPredictorPrediction</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;予測機能のテスト&quot;&quot;&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">trained_predictor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;訓練済みの予測器を返す fixture&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">CinemaPredictor</span><span class="p">()</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;SNS1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">140</span><span class="p">],</span>
            <span class="s1">&#39;SNS2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">550</span><span class="p">,</span> <span class="mi">580</span><span class="p">],</span>
            <span class="s1">&#39;actor&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">230</span><span class="p">],</span>
            <span class="s1">&#39;original&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="p">})</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">11000</span><span class="p">,</span> <span class="mi">10500</span><span class="p">,</span> <span class="mi">10800</span><span class="p">])</span>
        <span class="n">predictor</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">predictor</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_単一サンプルの予測</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trained_predictor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;単一サンプルを予測できることを確認&quot;&quot;&quot;</span>
        <span class="n">X_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;SNS1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">130</span><span class="p">],</span>
            <span class="s1">&#39;SNS2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">570</span><span class="p">],</span>
            <span class="s1">&#39;actor&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">210</span><span class="p">],</span>
            <span class="s1">&#39;original&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">predictions</span> <span class="o">=</span> <span class="n">trained_predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>  <span class="c1"># 興行収入は正の値</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_複数サンプルの予測</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trained_predictor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;複数サンプルを予測できることを確認&quot;&quot;&quot;</span>
        <span class="n">X_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;SNS1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">130</span><span class="p">,</span> <span class="mi">160</span><span class="p">],</span>
            <span class="s1">&#39;SNS2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">570</span><span class="p">,</span> <span class="mi">620</span><span class="p">],</span>
            <span class="s1">&#39;actor&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">210</span><span class="p">,</span> <span class="mi">260</span><span class="p">],</span>
            <span class="s1">&#39;original&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">predictions</span> <span class="o">=</span> <span class="n">trained_predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestCinemaPredictorEvaluation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;モデル評価のテスト&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_評価指標の計算</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;複数の評価指標を計算できることを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">CinemaPredictor</span><span class="p">()</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;SNS1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">140</span><span class="p">],</span>
            <span class="s1">&#39;SNS2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">550</span><span class="p">,</span> <span class="mi">580</span><span class="p">],</span>
            <span class="s1">&#39;actor&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">230</span><span class="p">],</span>
            <span class="s1">&#39;original&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="p">})</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">11000</span><span class="p">,</span> <span class="mi">10500</span><span class="p">,</span> <span class="mi">10800</span><span class="p">])</span>
        <span class="n">predictor</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="c1"># テストデータ</span>
        <span class="n">X_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;SNS1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">130</span><span class="p">,</span> <span class="mi">160</span><span class="p">],</span>
            <span class="s1">&#39;SNS2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">570</span><span class="p">,</span> <span class="mi">620</span><span class="p">],</span>
            <span class="s1">&#39;actor&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">210</span><span class="p">,</span> <span class="mi">260</span><span class="p">],</span>
            <span class="s1">&#39;original&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="p">})</span>
        <span class="n">y_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">10600</span><span class="p">,</span> <span class="mi">11200</span><span class="p">])</span>

        <span class="n">metrics</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

        <span class="c1"># 全ての評価指標が含まれることを確認</span>
        <span class="k">assert</span> <span class="s1">&#39;r2_score&#39;</span> <span class="ow">in</span> <span class="n">metrics</span>
        <span class="k">assert</span> <span class="s1">&#39;mae&#39;</span> <span class="ow">in</span> <span class="n">metrics</span>
        <span class="k">assert</span> <span class="s1">&#39;rmse&#39;</span> <span class="ow">in</span> <span class="n">metrics</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_決定係数の範囲</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;決定係数が適切な範囲にあることを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">CinemaPredictor</span><span class="p">()</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="s1">&#39;data/cinema.csv&#39;</span><span class="p">)</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="n">predictor</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

        <span class="c1"># R²は通常 -∞ から 1 の範囲（良いモデルは 0 に近いか正）</span>
        <span class="k">assert</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;r2_score&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">1.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_MAEとRMSEの関係</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;MAE と RMSE の関係を確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">CinemaPredictor</span><span class="p">()</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="s1">&#39;data/cinema.csv&#39;</span><span class="p">)</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="n">predictor</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

        <span class="c1"># RMSE は MAE 以上になる（等号は全ての誤差が同じ時）</span>
        <span class="k">assert</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;rmse&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">]</span>
</code></pre></div>
<p><strong>Green: 予測と評価機能の実装</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;興行収入を予測する</span>

<span class="sd">    Args:</span>
<span class="sd">        X_test: テスト用特徴量</span>

<span class="sd">    Returns:</span>
<span class="sd">        予測された興行収入の配列</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: モデルが未訓練の場合</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model has not been trained yet&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;モデルの性能を評価する</span>

<span class="sd">    Args:</span>
<span class="sd">        X_test: テスト用特徴量</span>
<span class="sd">        y_test: テスト用目的変数</span>

<span class="sd">    Returns:</span>
<span class="sd">        評価指標の辞書</span>
<span class="sd">        - r2_score: 決定係数（1.0 に近いほど良い）</span>
<span class="sd">        - mae: 平均絶対誤差（小さいほど良い）</span>
<span class="sd">        - rmse: 平均二乗誤差の平方根（小さいほど良い）</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: モデルが未訓練の場合</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model has not been trained yet&quot;</span><span class="p">)</span>

    <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;r2_score&#39;</span><span class="p">:</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
        <span class="s1">&#39;mae&#39;</span><span class="p">:</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
        <span class="s1">&#39;rmse&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
    <span class="p">}</span>
</code></pre></div>
<h5 id="5_1">ステップ 5: モデルの保存と読み込み<a class="headerlink" href="#5_1" title="Permanent link">&para;</a></h5>
<p><strong>Red: テストを書く</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TestCinemaPredictorPersistence</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;モデルの永続化テスト&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_モデルの保存</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;訓練済みモデルを保存できることを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">CinemaPredictor</span><span class="p">()</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;SNS1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">],</span>
            <span class="s1">&#39;SNS2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">600</span><span class="p">],</span>
            <span class="s1">&#39;actor&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">250</span><span class="p">],</span>
            <span class="s1">&#39;original&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="p">})</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">11000</span><span class="p">])</span>
        <span class="n">predictor</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="n">model_path</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;cinema_model.pkl&quot;</span>
        <span class="n">predictor</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">model_path</span><span class="p">))</span>

        <span class="k">assert</span> <span class="n">model_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_保存したモデルでの予測一貫性</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmp_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;保存前後で予測結果が一致することを確認&quot;&quot;&quot;</span>
        <span class="c1"># モデルを訓練</span>
        <span class="n">predictor1</span> <span class="o">=</span> <span class="n">CinemaPredictor</span><span class="p">()</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;SNS1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">],</span>
            <span class="s1">&#39;SNS2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">600</span><span class="p">],</span>
            <span class="s1">&#39;actor&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">250</span><span class="p">],</span>
            <span class="s1">&#39;original&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="p">})</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">11000</span><span class="p">])</span>
        <span class="n">predictor1</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="c1"># テストデータ</span>
        <span class="n">X_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;SNS1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">130</span><span class="p">],</span>
            <span class="s1">&#39;SNS2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">570</span><span class="p">],</span>
            <span class="s1">&#39;actor&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">210</span><span class="p">],</span>
            <span class="s1">&#39;original&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="c1"># 保存前の予測</span>
        <span class="n">pred_before</span> <span class="o">=</span> <span class="n">predictor1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

        <span class="c1"># モデルの保存と読み込み</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s2">&quot;cinema_model.pkl&quot;</span>
        <span class="n">predictor1</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">model_path</span><span class="p">))</span>

        <span class="n">predictor2</span> <span class="o">=</span> <span class="n">CinemaPredictor</span><span class="p">()</span>
        <span class="n">predictor2</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">model_path</span><span class="p">))</span>

        <span class="c1"># 読み込み後の予測</span>
        <span class="n">pred_after</span> <span class="o">=</span> <span class="n">predictor2</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

        <span class="c1"># 予測結果が一致することを確認</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">pred_before</span><span class="p">,</span> <span class="n">pred_after</span><span class="p">)</span>
</code></pre></div>
<p><strong>Green: 永続化機能の実装</strong></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>


<span class="k">def</span><span class="w"> </span><span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;訓練済みモデルをファイルに保存する</span>

<span class="sd">    Args:</span>
<span class="sd">        file_path: 保存先のファイルパス</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: モデルが未訓練の場合</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No trained model to save&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;保存されたモデルをファイルから読み込む</span>

<span class="sd">    Args:</span>
<span class="sd">        file_path: 読み込むファイルのパス</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: ファイルが存在しない場合</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model file not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</code></pre></div>
<h4 id="_36">評価指標の理解<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h4>
<p>回帰問題では、複数の評価指標を使用してモデルの性能を多角的に評価します。</p>
<p><strong>1. 決定係数（R² Score）</strong></p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">R² = 1 - (予測誤差の平方和 / 実測値の分散)</span>

<span class="sd">- 値の範囲: -∞ から 1</span>
<span class="sd">- 1.0: 完璧な予測</span>
<span class="sd">- 0.0: 平均値で予測するのと同等</span>
<span class="sd">- 負の値: 平均値で予測するより悪い</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_R2スコアの解釈</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;R²スコアの意味を確認&quot;&quot;&quot;</span>
    <span class="c1"># 完璧な予測</span>
    <span class="n">y_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">])</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">])</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">r2</span> <span class="o">==</span> <span class="mf">1.0</span>  <span class="c1"># 完璧</span>

    <span class="c1"># 平均値で予測</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span>  <span class="c1"># 全て平均</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">r2</span> <span class="o">==</span> <span class="mf">0.0</span>  <span class="c1"># 平均値と同等</span>

    <span class="c1"># 悪い予測</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">300</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>  <span class="c1"># 全く外れている</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">r2</span> <span class="o">&lt;</span> <span class="mi">0</span>  <span class="c1"># 平均値より悪い</span>
</code></pre></div>
<p><strong>2. 平均絶対誤差（MAE: Mean Absolute Error）</strong></p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">MAE = Σ|予測値 - 実測値| / サンプル数</span>

<span class="sd">- 値の範囲: 0 から ∞</span>
<span class="sd">- 0: 完璧な予測</span>
<span class="sd">- 誤差の絶対値の平均（単位は目的変数と同じ）</span>
<span class="sd">- 外れ値の影響を受けにくい</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_MAEの計算</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;MAE の計算を確認&quot;&quot;&quot;</span>
    <span class="n">y_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">11000</span><span class="p">,</span> <span class="mi">12000</span><span class="p">])</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">10200</span><span class="p">,</span> <span class="mi">10800</span><span class="p">,</span> <span class="mi">12100</span><span class="p">])</span>

    <span class="n">mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

    <span class="c1"># (200 + 200 + 100) / 3 = 166.67</span>
    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mae</span> <span class="o">-</span> <span class="mf">166.67</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.01</span>
</code></pre></div>
<p><strong>3. 平均二乗誤差の平方根（RMSE: Root Mean Squared Error）</strong></p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">RMSE = √(Σ(予測値 - 実測値)² / サンプル数)</span>

<span class="sd">- 値の範囲: 0 から ∞</span>
<span class="sd">- 0: 完璧な予測</span>
<span class="sd">- 誤差の二乗平均の平方根（単位は目的変数と同じ）</span>
<span class="sd">- 外れ値の影響を受けやすい（大きな誤差にペナルティ）</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_RMSEの計算</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;RMSE の計算を確認&quot;&quot;&quot;</span>
    <span class="n">y_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">11000</span><span class="p">,</span> <span class="mi">12000</span><span class="p">])</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">10200</span><span class="p">,</span> <span class="mi">10800</span><span class="p">,</span> <span class="mi">12100</span><span class="p">])</span>

    <span class="n">mse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mse</span><span class="p">)</span>

    <span class="c1"># √((200² + 200² + 100²) / 3) = √(90000 / 3) = √30000 ≈ 173.21</span>
    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rmse</span> <span class="o">-</span> <span class="mf">173.21</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.01</span>
</code></pre></div>
<h4 id="_37">完全な実装例<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h4>
<p><strong>src/ml/cinema_predictor.py</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Cinema 興行収入予測器モジュール&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_absolute_error</span><span class="p">,</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CinemaPredictor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;映画興行収入を予測する線形回帰モデル</span>

<span class="sd">    Attributes:</span>
<span class="sd">        model: 訓練済みの線形回帰モデル（未訓練時は None）</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;初期化&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LinearRegression</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remove_outliers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;外れ値を除外する</span>

<span class="sd">        Args:</span>
<span class="sd">            df: 対象の DataFrame</span>

<span class="sd">        Returns:</span>
<span class="sd">            外れ値を除外した DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">outlier_condition</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;SNS2&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sales&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">8500</span><span class="p">)</span>
        <span class="n">outlier_indices</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">outlier_condition</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">outlier_indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">remove_outliers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;CSV ファイルからデータを読み込む</span>

<span class="sd">        Args:</span>
<span class="sd">            file_path: CSV ファイルのパス</span>
<span class="sd">            remove_outliers: 外れ値を除外するかどうか</span>

<span class="sd">        Returns:</span>
<span class="sd">            特徴量 DataFrame と目的変数 Series のタプル</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: ファイルが存在しない場合</span>
<span class="sd">            ValueError: データの形式が不正な場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SNS1&#39;</span><span class="p">,</span> <span class="s1">&#39;SNS2&#39;</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">,</span> <span class="s1">&#39;original&#39;</span><span class="p">,</span> <span class="s1">&#39;sales&#39;</span><span class="p">]</span>
        <span class="n">missing_columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">required_columns</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing_columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing columns: </span><span class="si">{</span><span class="n">missing_columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 欠損値を平均値で補完</span>
        <span class="n">df_filled</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

        <span class="c1"># 外れ値の除外（オプション）</span>
        <span class="k">if</span> <span class="n">remove_outliers</span><span class="p">:</span>
            <span class="n">df_filled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_outliers</span><span class="p">(</span><span class="n">df_filled</span><span class="p">)</span>

        <span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SNS1&#39;</span><span class="p">,</span> <span class="s1">&#39;SNS2&#39;</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">,</span> <span class="s1">&#39;original&#39;</span><span class="p">]</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">df_filled</span><span class="p">[</span><span class="n">feature_columns</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df_filled</span><span class="p">[</span><span class="s1">&#39;sales&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;線形回帰モデルを訓練する</span>

<span class="sd">        Args:</span>
<span class="sd">            X_train: 訓練用特徴量</span>
<span class="sd">            y_train: 訓練用目的変数</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: データが空の場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Training data cannot be empty&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;X_train and y_train must have the same length: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;興行収入を予測する</span>

<span class="sd">        Args:</span>
<span class="sd">            X_test: テスト用特徴量</span>

<span class="sd">        Returns:</span>
<span class="sd">            予測された興行収入の配列</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: モデルが未訓練の場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model has not been trained yet&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;モデルの性能を評価する</span>

<span class="sd">        Args:</span>
<span class="sd">            X_test: テスト用特徴量</span>
<span class="sd">            y_test: テスト用目的変数</span>

<span class="sd">        Returns:</span>
<span class="sd">            評価指標の辞書</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model has not been trained yet&quot;</span><span class="p">)</span>

        <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;r2_score&#39;</span><span class="p">:</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
            <span class="s1">&#39;mae&#39;</span><span class="p">:</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
            <span class="s1">&#39;rmse&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;訓練済みモデルをファイルに保存する</span>

<span class="sd">        Args:</span>
<span class="sd">            file_path: 保存先のファイルパス</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: モデルが未訓練の場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No trained model to save&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;保存されたモデルをファイルから読み込む</span>

<span class="sd">        Args:</span>
<span class="sd">            file_path: 読み込むファイルのパス</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: ファイルが存在しない場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model file not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</code></pre></div>
<h4 id="cinema_1">実践例：Cinema 予測モデルの訓練<a class="headerlink" href="#cinema_1" title="Permanent link">&para;</a></h4>
<p><strong>examples/train_cinema.py</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Cinema 興行収入予測モデルの訓練例&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.ml.cinema_predictor</span><span class="w"> </span><span class="kn">import</span> <span class="n">CinemaPredictor</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;メイン処理&quot;&quot;&quot;</span>
    <span class="c1"># 予測器の作成</span>
    <span class="n">predictor</span> <span class="o">=</span> <span class="n">CinemaPredictor</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CinemaPredictor を作成しました&quot;</span><span class="p">)</span>

    <span class="c1"># データの読み込み（外れ値除外あり）</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="s1">&#39;data/cinema.csv&#39;</span><span class="p">,</span> <span class="n">remove_outliers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;データを読み込みました: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="si">}</span><span class="s2"> サンプル&quot;</span><span class="p">)</span>

    <span class="c1"># 訓練データとテストデータに分割</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;訓練データ: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="si">}</span><span class="s2"> サンプル&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;テストデータ: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="si">}</span><span class="s2"> サンプル&quot;</span><span class="p">)</span>

    <span class="c1"># モデルの訓練</span>
    <span class="n">predictor</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;モデルの訓練が完了しました&quot;</span><span class="p">)</span>

    <span class="c1"># モデルの係数表示</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[モデルの係数]&quot;</span><span class="p">)</span>
    <span class="n">feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SNS1&#39;</span><span class="p">,</span> <span class="s1">&#39;SNS2&#39;</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">,</span> <span class="s1">&#39;original&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">coef</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">feature_names</span><span class="p">,</span> <span class="n">predictor</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">coef</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  切片: </span><span class="si">{</span><span class="n">predictor</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">intercept_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># モデルの評価</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[モデルの評価]&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  決定係数（R²）: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;r2_score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  平均絶対誤差（MAE）: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> 万円&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  平均二乗誤差平方根（RMSE）: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;rmse&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> 万円&quot;</span><span class="p">)</span>

    <span class="c1"># モデルの保存</span>
    <span class="n">predictor</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="s1">&#39;model/cinema.pkl&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">モデルを model/cinema.pkl に保存しました&quot;</span><span class="p">)</span>

    <span class="c1"># 予測例</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[予測例]&quot;</span><span class="p">)</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">y_test</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">predicted</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">error</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">actual</span> <span class="o">-</span> <span class="n">predicted</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">サンプル </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  SNS1: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;SNS1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">, SNS2: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;SNS2&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  actor: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;actor&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">, original: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;original&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  実際の興行収入: </span><span class="si">{</span><span class="n">actual</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> 万円&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  予測興行収入: </span><span class="si">{</span><span class="n">predicted</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> 万円&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  誤差: </span><span class="si">{</span><span class="n">error</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> 万円&quot;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<p>実行例：</p>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>run<span class="w"> </span>python<span class="w"> </span>examples/train_cinema.py

<span class="c1"># 出力例：</span>
<span class="c1"># CinemaPredictor を作成しました</span>
<span class="c1"># データを読み込みました: 95 サンプル</span>
<span class="c1"># 訓練データ: 76 サンプル</span>
<span class="c1"># テストデータ: 19 サンプル</span>
<span class="c1"># モデルの訓練が完了しました</span>
<span class="c1">#</span>
<span class="c1"># [モデルの係数]</span>
<span class="c1">#   SNS1: 2.3456</span>
<span class="c1">#   SNS2: 4.7823</span>
<span class="c1">#   actor: 1.2345</span>
<span class="c1">#   original: 234.5678</span>
<span class="c1">#   切片: 5432.1098</span>
<span class="c1">#</span>
<span class="c1"># [モデルの評価]</span>
<span class="c1">#   決定係数（R²）: 0.8383</span>
<span class="c1">#   平均絶対誤差（MAE）: 206.83 万円</span>
<span class="c1">#   平均二乗誤差平方根（RMSE）: 289.45 万円</span>
<span class="c1">#</span>
<span class="c1"># モデルを model/cinema.pkl に保存しました</span>
<span class="c1">#</span>
<span class="c1"># [予測例]</span>
<span class="c1">#</span>
<span class="c1"># サンプル 1:</span>
<span class="c1">#   SNS1: 150, SNS2: 700</span>
<span class="c1">#   actor: 300, original: 0</span>
<span class="c1">#   実際の興行収入: 11500 万円</span>
<span class="c1">#   予測興行収入: 11324 万円</span>
<span class="c1">#   誤差: 176 万円</span>
<span class="c1">#</span>
<span class="c1"># サンプル 2:</span>
<span class="c1">#   SNS1: 200, SNS2: 850</span>
<span class="c1">#   actor: 350, original: 1</span>
<span class="c1">#   実際の興行収入: 12800 万円</span>
<span class="c1">#   予測興行収入: 12967 万円</span>
<span class="c1">#   誤差: 167 万円</span>
</code></pre></div>
<hr />
<h3 id="5_2">📊 ５章の技術的成果<a class="headerlink" href="#5_2" title="Permanent link">&para;</a></h3>
<p>「回帰問題もマスターしました！」お疲れさまでした！５章で何を達成したか、振り返ってみましょう。</p>
<h4 id="_38">✅ 完成した機能<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h4>
<p>５章では、以下の機能を実装しました：</p>
<ul>
<li>✅ <strong>Cinema 予測器クラスの完全実装</strong> - 興行収入を予測するモデル</li>
<li>✅ <strong>線形回帰モデルの訓練機能</strong> - 数値を予測</li>
<li>✅ <strong>外れ値検出と除外機能</strong> - 異常なデータを除外</li>
<li>✅ <strong>複数の評価指標</strong> - R²、MAE、RMSE で評価</li>
<li>✅ <strong>データの欠損値処理</strong> - 実務的なデータクリーニング</li>
<li>✅ <strong>モデルの保存と読み込み機能</strong> - モデルの再利用</li>
</ul>
<h4 id="_39">📈 定量的成果<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h4>
<p>数字で見ると、こんなに達成しました！</p>
<table>
<thead>
<tr>
<th>指標</th>
<th>🎯 実績</th>
</tr>
</thead>
<tbody>
<tr>
<td>🧪 <strong>テストケース</strong></td>
<td>20 個</td>
</tr>
<tr>
<td>📊 <strong>コードカバレッジ</strong></td>
<td>92%（cinema_predictor.py）</td>
</tr>
<tr>
<td>🔤 <strong>型ヒント使用率</strong></td>
<td>100%</td>
</tr>
<tr>
<td>🎬 <strong>モデル決定係数（R²）</strong></td>
<td><strong>0.8383</strong>（テストデータ）</td>
</tr>
<tr>
<td>💰 <strong>平均絶対誤差（MAE）</strong></td>
<td>206.83 万円</td>
</tr>
<tr>
<td>✨ <strong>Ruff チェック</strong></td>
<td>全て通過</td>
</tr>
<tr>
<td>✅ <strong>mypy チェック</strong></td>
<td>エラー 0 件</td>
</tr>
</tbody>
</table>
<p><strong>R² = 0.8383！</strong> これは、モデルがデータの約 84% を説明できているという意味です。良い結果ですね！🎉</p>
<h4 id="_40">🎓 習得したスキル<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h4>
<h5 id="1-tdd_1">1. 🔄 TDD スキル（応用）<a class="headerlink" href="#1-tdd_1" title="Permanent link">&para;</a></h5>
<ul>
<li>✅ 外れ値処理のテスト駆動実装</li>
<li>✅ 複数の評価指標のテスト</li>
<li>✅ 数値計算の精度検証</li>
</ul>
<h5 id="2_5">2. 📊 機械学習スキル（回帰）<a class="headerlink" href="#2_5" title="Permanent link">&para;</a></h5>
<ul>
<li>✅ 線形回帰アルゴリズムの理解</li>
<li>✅ 外れ値の検出と除外</li>
<li>✅ 複数の評価指標の理解と使い分け</li>
<li>✅ モデル係数の解釈</li>
</ul>
<h5 id="3_3">3. 🔧 データ処理スキル（発展）<a class="headerlink" href="#3_3" title="Permanent link">&para;</a></h5>
<ul>
<li>✅ 条件に基づくデータフィルタリング</li>
<li>✅ 欠損値の補完</li>
<li>✅ データクリーニングパイプライン</li>
</ul>
<p><strong>4. 統計スキル</strong>
- R²スコアの意味理解
- MAE と RMSE の違い
- 評価指標の選択基準</p>
<h5 id="_41">線形回帰の理解<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h5>
<p><strong>線形回帰の数式</strong>:</p>
<div class="highlight"><pre><span></span><code>y = β₀ + β₁x₁ + β₂x₂ + β₃x₃ + β₄x₄

where:
  y: 興行収入（sales）
  x₁: SNS1
  x₂: SNS2
  x₃: actor
  x₄: original
  β₀: 切片（intercept）
  β₁, β₂, β₃, β₄: 各特徴量の係数（coefficients）
</code></pre></div>
<p><strong>係数の解釈</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># SNS2 の係数が 4.78 の場合</span>
<span class="c1"># → SNS2 が 1 増えると、興行収入が約 4.78 万円増加すると予測</span>
</code></pre></div>
<h5 id="_42">分類と回帰の実装比較<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h5>
<table>
<thead>
<tr>
<th>項目</th>
<th>Iris（分類）</th>
<th>Cinema（回帰）</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>モデル</strong></td>
<td>DecisionTreeClassifier</td>
<td>LinearRegression</td>
</tr>
<tr>
<td><strong>出力</strong></td>
<td>クラスラベル（文字列）</td>
<td>連続値（float）</td>
</tr>
<tr>
<td><strong>評価</strong></td>
<td>accuracy（正解率）</td>
<td>R²、MAE、RMSE</td>
</tr>
<tr>
<td><strong>前処理</strong></td>
<td>欠損値補完</td>
<td>欠損値補完 + 外れ値除外</td>
</tr>
<tr>
<td><strong>テスト数</strong></td>
<td>18個</td>
<td>20個</td>
</tr>
</tbody>
</table>
<h4 id="_43">🚀 次の章への準備<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h4>
<p>５章では、回帰問題の基礎を学びました！次の６章では、以下を実装します：</p>
<ul>
<li>⛴️ <strong>Survived 生存予測モデル</strong> - 実践的な分類問題</li>
<li>🔧 <strong>高度な欠損値処理</strong> - グループ別補完テクニック</li>
<li>📊 <strong>カテゴリカル変数のエンコーディング</strong> - 文字列データの数値化</li>
<li>⚖️ <strong>クラス不均衡への対応</strong> - 偏ったデータへの対処</li>
</ul>
<p>より実践的な分類問題に挑戦です！これまでの知識を活かせますよ！💪</p>
<hr />
<hr />
<h2 id="6-survived">６章 Survived 生存予測モデル（実践的な分類問題）<a class="headerlink" href="#6-survived" title="Permanent link">&para;</a></h2>
<p>「分類問題の基礎は学んだけど、もっと実践的な問題に挑戦したい！」そんなあなたにぴったりの章です！</p>
<p>この章では、タイタニック号の乗客データから生存者を予測するモデルを作ります。これは Kaggle（機械学習コンペティション）でも有名な問題です！⛴️</p>
<h3 id="_44">🎯 この章の学習目標<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h3>
<p>この章では、より実践的なスキルを習得します：</p>
<ol>
<li>🔧 <strong>高度なデータ前処理</strong> - グループ別統計による欠損値補完</li>
<li>📊 <strong>カテゴリカル変数の処理</strong> - ダミー変数化と多重共線性の回避</li>
<li>⚖️ <strong>クラス不均衡への対応</strong> - class_weight パラメータによる調整</li>
<li>🔄 <strong>TDD の応用</strong> - 複雑な前処理ロジックのテスト駆動実装</li>
</ol>
<p>「え、これまでより難しそう...」と思いましたか？大丈夫です！一歩ずつ進めていきましょう。</p>
<h3 id="survived">⛴️ Survived データセットの理解<a class="headerlink" href="#survived" title="Permanent link">&para;</a></h3>
<p>このデータセットは、<strong>客船沈没事故の乗客データ</strong>から生存を予測する問題です。「年齢や性別、チケットのクラスなどから、誰が生き残ったか予測できるの？」実はできるんです！</p>
<h4 id="_45">データ詳細<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h4>
<p><code>data/Survived.csv</code> を使用します：</p>
<table>
<thead>
<tr>
<th>列名</th>
<th>内容</th>
<th>データ型</th>
<th>特徴</th>
</tr>
</thead>
<tbody>
<tr>
<td>🎫 <strong>Pclass</strong></td>
<td>チケットクラス（1、2、3）</td>
<td>int</td>
<td>社会階級を表す</td>
</tr>
<tr>
<td>👤 <strong>Age</strong></td>
<td>年齢</td>
<td>float</td>
<td><strong>⚠️ 欠損値あり</strong></td>
</tr>
<tr>
<td>👨‍👩‍👧 <strong>SibSp</strong></td>
<td>同乗した兄弟や配偶者の総数</td>
<td>int</td>
<td>家族構成情報</td>
</tr>
<tr>
<td>👨‍👩‍👧‍👦 <strong>Parch</strong></td>
<td>同乗した親子の総数</td>
<td>int</td>
<td>家族構成情報</td>
</tr>
<tr>
<td>💰 <strong>Fare</strong></td>
<td>運賃</td>
<td>float</td>
<td>支払った金額</td>
</tr>
<tr>
<td>🚻 <strong>Sex</strong></td>
<td>性別</td>
<td>str</td>
<td><strong>⚠️ カテゴリカル変数</strong></td>
</tr>
<tr>
<td>✅ <strong>Survived</strong></td>
<td>生存状況（1: 生存、0: 死亡）</td>
<td>int</td>
<td><strong>🎯 目的変数</strong></td>
</tr>
</tbody>
</table>
<h4 id="_46">🔍 これまでのデータセットとの違い<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>特徴</th>
<th>Iris</th>
<th>Cinema</th>
<th><strong>Survived</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>問題の種類</strong></td>
<td>分類（3クラス）</td>
<td>回帰</td>
<td><strong>分類（2クラス）</strong></td>
</tr>
<tr>
<td><strong>欠損値処理</strong></td>
<td>平均値補完</td>
<td>平均値補完</td>
<td><strong>グループ別中央値補完</strong></td>
</tr>
<tr>
<td><strong>カテゴリカル変数</strong></td>
<td>なし</td>
<td>なし</td>
<td><strong>あり（Sex）</strong></td>
</tr>
<tr>
<td><strong>クラス不均衡</strong></td>
<td>なし</td>
<td>N/A</td>
<td><strong>あり（生存者が少ない）</strong></td>
</tr>
<tr>
<td><strong>特徴量数</strong></td>
<td>4個</td>
<td>4個</td>
<td><strong>6個</strong></td>
</tr>
<tr>
<td><strong>前処理の複雑度</strong></td>
<td>低</td>
<td>中</td>
<td><strong>高</strong></td>
</tr>
</tbody>
</table>
<h5 id="_47">問題の複雑性<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h5>
<p><strong>1. 欠損値の戦略的補完</strong></p>
<p>単純な平均値補完ではなく、Pclass（社会階級）と Survived（生存状況）のグループごとに中央値で補完します。これにより、より正確なデータ復元が可能になります。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 例：1等客室の生存者の平均年齢は35歳、死亡者は43歳</span>
<span class="c1"># → グループごとの傾向を反映した補完</span>
</code></pre></div>
<p><strong>2. カテゴリカル変数のエンコーディング</strong></p>
<p>Sex（male/female）という文字列データを、機械学習モデルが扱える数値データに変換する必要があります。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 変換前: Sex = [&#39;male&#39;, &#39;female&#39;, &#39;male&#39;]</span>
<span class="c1"># 変換後: male = [1, 0, 1]（0/1 のダミー変数）</span>
</code></pre></div>
<p><strong>3. クラス不均衡への対応</strong></p>
<p>生存者と死亡者の割合が不均衡な場合、単純な訓練では多数派クラスに偏ったモデルになります。<code>class_weight='balanced'</code> パラメータで自動的に調整します。</p>
<h4 id="tdd-6">TDD による実装（6ステップ）<a class="headerlink" href="#tdd-6" title="Permanent link">&para;</a></h4>
<h5 id="1_4">ステップ 1: 初期化とデータ読み込み<a class="headerlink" href="#1_4" title="Permanent link">&para;</a></h5>
<p><strong>Red: テストを書く</strong></p>
<p><strong>test/test_survived_classifier.py</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Survived 分類器のテストモジュール&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.ml.survived_classifier</span><span class="w"> </span><span class="kn">import</span> <span class="n">SurvivedClassifier</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestSurvivedClassifierInit</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;初期化のテスト&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_初期化_デフォルトパラメータ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;デフォルトパラメータで初期化できることを確認&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">SurvivedClassifier</span><span class="p">()</span>

        <span class="k">assert</span> <span class="n">classifier</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">==</span> <span class="mi">9</span>
        <span class="k">assert</span> <span class="n">classifier</span><span class="o">.</span><span class="n">class_weight</span> <span class="o">==</span> <span class="s1">&#39;balanced&#39;</span>
        <span class="k">assert</span> <span class="n">classifier</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_初期化_カスタムパラメータ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;カスタムパラメータで初期化できることを確認&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">SurvivedClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">classifier</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">==</span> <span class="mi">5</span>
        <span class="k">assert</span> <span class="n">classifier</span><span class="o">.</span><span class="n">class_weight</span> <span class="o">==</span> <span class="s1">&#39;balanced&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_max_depthが不正な値の場合エラー</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;max_depth が 1 未満の場合は ValueError を発生&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;max_depth must be at least 1&quot;</span><span class="p">):</span>
            <span class="n">SurvivedClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestSurvivedClassifierLoadData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;データ読み込みのテスト&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_CSVファイルの読み込み</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;CSV ファイルが正常に読み込めることを確認&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">SurvivedClassifier</span><span class="p">()</span>

        <span class="c1"># テストデータ作成</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Pclass,Age,SibSp,Parch,Fare,Sex,Survived</span>
<span class="s2">1,22.0,1,0,7.25,male,0</span>
<span class="s2">2,38.0,1,0,71.28,female,1</span>
<span class="s2">3,26.0,0,0,7.92,male,0&quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
            <span class="n">temp_path</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">temp_path</span><span class="p">,</span> <span class="n">preprocess</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># データが正しく読み込まれることを確認</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
            <span class="k">assert</span> <span class="s1">&#39;Survived&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">assert</span> <span class="n">y</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Survived&#39;</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_ファイルが存在しない場合エラー</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;存在しないファイルパスを指定した場合 FileNotFoundError を発生&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">SurvivedClassifier</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">):</span>
            <span class="n">classifier</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="s1">&#39;nonexistent.csv&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_必要な列が不足している場合エラー</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;必要な列が不足している場合 ValueError を発生&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">SurvivedClassifier</span><span class="p">()</span>

        <span class="c1"># Survived 列が欠けているデータ</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Pclass,Age,Sex</span>
<span class="s2">1,22.0,male&quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
            <span class="n">temp_path</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Missing columns&quot;</span><span class="p">):</span>
                <span class="n">classifier</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">temp_path</span><span class="p">,</span> <span class="n">preprocess</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
</code></pre></div>
<p><strong>Green: 最小限の実装</strong></p>
<p><strong>src/ml/survived_classifier.py</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Survived 生存予測器モジュール&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn</span><span class="w"> </span><span class="kn">import</span> <span class="n">tree</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SurvivedClassifier</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;客船沈没事故の生存を予測する分類モデル</span>

<span class="sd">    Attributes:</span>
<span class="sd">        max_depth: 決定木の最大深度</span>
<span class="sd">        class_weight: クラスの重み付け（&#39;balanced&#39; で自動調整）</span>
<span class="sd">        model: 訓練済みの決定木モデル（未訓練時は None）</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="n">class_weight</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;balanced&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;初期化</span>

<span class="sd">        Args:</span>
<span class="sd">            max_depth: 決定木の最大深度（デフォルト: 9）</span>
<span class="sd">            class_weight: クラス重み付け方法（デフォルト: &#39;balanced&#39;）</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: max_depth が 1 未満の場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">max_depth</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;max_depth must be at least 1&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_weight</span> <span class="o">=</span> <span class="n">class_weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeClassifier</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">preprocess</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;CSV ファイルからデータを読み込む</span>

<span class="sd">        Args:</span>
<span class="sd">            file_path: CSV ファイルのパス</span>
<span class="sd">            preprocess: 前処理を実行するかどうか（デフォルト: True）</span>

<span class="sd">        Returns:</span>
<span class="sd">            特徴量 DataFrame と目的変数 Series のタプル</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: ファイルが存在しない場合</span>
<span class="sd">            ValueError: 必要な列が不足している場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># データの読み込み</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="c1"># 必要な列の存在確認</span>
        <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Pclass&#39;</span><span class="p">,</span> <span class="s1">&#39;Age&#39;</span><span class="p">,</span> <span class="s1">&#39;SibSp&#39;</span><span class="p">,</span> <span class="s1">&#39;Parch&#39;</span><span class="p">,</span> <span class="s1">&#39;Fare&#39;</span><span class="p">,</span> <span class="s1">&#39;Sex&#39;</span><span class="p">,</span> <span class="s1">&#39;Survived&#39;</span><span class="p">]</span>
        <span class="n">missing_columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">required_columns</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing_columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing columns: </span><span class="si">{</span><span class="n">missing_columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 前処理の実行（オプション）</span>
        <span class="k">if</span> <span class="n">preprocess</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_data</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># 特徴量と目的変数の分割</span>
        <span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Pclass&#39;</span><span class="p">,</span> <span class="s1">&#39;Age&#39;</span><span class="p">,</span> <span class="s1">&#39;SibSp&#39;</span><span class="p">,</span> <span class="s1">&#39;Parch&#39;</span><span class="p">,</span> <span class="s1">&#39;Fare&#39;</span><span class="p">,</span> <span class="s1">&#39;male&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">preprocess</span><span class="p">:</span>
            <span class="c1"># 前処理なしの場合、Sex 列をそのまま使う（テスト用）</span>
            <span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Pclass&#39;</span><span class="p">,</span> <span class="s1">&#39;Age&#39;</span><span class="p">,</span> <span class="s1">&#39;SibSp&#39;</span><span class="p">,</span> <span class="s1">&#39;Parch&#39;</span><span class="p">,</span> <span class="s1">&#39;Fare&#39;</span><span class="p">,</span> <span class="s1">&#39;Sex&#39;</span><span class="p">]</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature_columns</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Survived&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_preprocess_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;データの前処理（内部メソッド）</span>

<span class="sd">        Args:</span>
<span class="sd">            df: 元の DataFrame</span>

<span class="sd">        Returns:</span>
<span class="sd">            前処理済みの DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ステップ 2 と 3 で実装</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_age</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_categorical</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_preprocess_age</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Age の欠損値をグループ別中央値で補完（ステップ 2 で実装）&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_encode_categorical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sex をダミー変数に変換（ステップ 3 で実装）&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">df</span>
</code></pre></div>
<h5 id="2_6">ステップ 2: グループ別欠損値補完<a class="headerlink" href="#2_6" title="Permanent link">&para;</a></h5>
<p>高度な欠損値処理を TDD で実装します。</p>
<p><strong>Red: テストを書く</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TestSurvivedClassifierPreprocessAge</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Age 欠損値補完のテスト&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_欠損値がない場合は変更なし</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;欠損値がない場合はデータを変更しないことを確認&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">SurvivedClassifier</span><span class="p">()</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;Pclass&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
            <span class="s1">&#39;Age&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">22.0</span><span class="p">,</span> <span class="mf">38.0</span><span class="p">,</span> <span class="mf">26.0</span><span class="p">],</span>
            <span class="s1">&#39;Survived&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">df_processed</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">_preprocess_age</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="n">pd</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_frame_equal</span><span class="p">(</span><span class="n">df_processed</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_1等客室死亡者の年齢補完</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pclass=1, Survived=0 の欠損値が 43 で補完されることを確認&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">SurvivedClassifier</span><span class="p">()</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;Pclass&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;Age&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">],</span>
            <span class="s1">&#39;Survived&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">df_processed</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">_preprocess_age</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">df_processed</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">43</span>
        <span class="k">assert</span> <span class="n">df_processed</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">50.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_1等客室生存者の年齢補完</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pclass=1, Survived=1 の欠損値が 35 で補完されることを確認&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">SurvivedClassifier</span><span class="p">()</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;Pclass&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;Age&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
            <span class="s1">&#39;Survived&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">df_processed</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">_preprocess_age</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">df_processed</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">35</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_全グループの年齢補完</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;全グループの欠損値が正しく補完されることを確認&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">SurvivedClassifier</span><span class="p">()</span>

        <span class="c1"># 各グループの組み合わせで欠損値を作成</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;Pclass&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
            <span class="s1">&#39;Age&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
            <span class="s1">&#39;Survived&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">df_processed</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">_preprocess_age</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># グループ別の期待値</span>
        <span class="n">expected_ages</span> <span class="o">=</span> <span class="p">[</span><span class="mi">43</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
        <span class="n">actual_ages</span> <span class="o">=</span> <span class="n">df_processed</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">assert</span> <span class="n">actual_ages</span> <span class="o">==</span> <span class="n">expected_ages</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_一部のみ欠損値がある場合</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;一部だけ欠損値がある場合、該当データのみ補完されることを確認&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">SurvivedClassifier</span><span class="p">()</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;Pclass&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="s1">&#39;Age&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">,</span> <span class="mf">25.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
            <span class="s1">&#39;Survived&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">df_processed</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">_preprocess_age</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">df_processed</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">43</span>  <span class="c1"># 補完</span>
        <span class="k">assert</span> <span class="n">df_processed</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">30.0</span>  <span class="c1"># 元のまま</span>
        <span class="k">assert</span> <span class="n">df_processed</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">25.0</span>  <span class="c1"># 元のまま</span>
        <span class="k">assert</span> <span class="n">df_processed</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">25</span>  <span class="c1"># 補完</span>
</code></pre></div>
<p><strong>Green: 実装</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_preprocess_age</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Age の欠損値を Pclass と Survived のグループ別中央値で補完</span>

<span class="sd">    Args:</span>
<span class="sd">        df: 元の DataFrame</span>

<span class="sd">    Returns:</span>
<span class="sd">        Age の欠損値が補完された DataFrame</span>

<span class="sd">    Note:</span>
<span class="sd">        各グループの中央値は実データ分析により決定：</span>
<span class="sd">        - (Pclass=1, Survived=0): 43歳</span>
<span class="sd">        - (Pclass=1, Survived=1): 35歳</span>
<span class="sd">        - (Pclass=2, Survived=0): 33歳</span>
<span class="sd">        - (Pclass=2, Survived=1): 25歳</span>
<span class="sd">        - (Pclass=3, Survived=0): 26歳</span>
<span class="sd">        - (Pclass=3, Survived=1): 20歳</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_copy</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">is_null</span> <span class="o">=</span> <span class="n">df_copy</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span>

    <span class="c1"># グループ別の中央値マッピング</span>
    <span class="n">age_mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mi">43</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">35</span><span class="p">,</span>
        <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mi">33</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">25</span><span class="p">,</span>
        <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mi">26</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">20</span>
    <span class="p">}</span>

    <span class="c1"># 各グループの欠損値を中央値で補完</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">pclass</span><span class="p">,</span> <span class="n">survived</span><span class="p">),</span> <span class="n">median_age</span> <span class="ow">in</span> <span class="n">age_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_copy</span><span class="p">[</span><span class="s1">&#39;Pclass&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pclass</span><span class="p">)</span> <span class="o">&amp;</span> \
               <span class="p">(</span><span class="n">df_copy</span><span class="p">[</span><span class="s1">&#39;Survived&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">survived</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">is_null</span>
        <span class="n">df_copy</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s1">&#39;Age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">median_age</span>

    <span class="k">return</span> <span class="n">df_copy</span>
</code></pre></div>
<h5 id="3_4">ステップ 3: カテゴリカル変数のエンコーディング<a class="headerlink" href="#3_4" title="Permanent link">&para;</a></h5>
<p>Sex（male/female）をダミー変数に変換します。</p>
<p><strong>Red: テストを書く</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TestSurvivedClassifierEncodeCategorical</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;カテゴリカル変数エンコーディングのテスト&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_Sex列がmale列に変換される</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sex 列が male ダミー変数に変換されることを確認&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">SurvivedClassifier</span><span class="p">()</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;Pclass&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
            <span class="s1">&#39;Sex&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;male&#39;</span><span class="p">,</span> <span class="s1">&#39;female&#39;</span><span class="p">,</span> <span class="s1">&#39;male&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Survived&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">df_encoded</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">_encode_categorical</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="k">assert</span> <span class="s1">&#39;male&#39;</span> <span class="ow">in</span> <span class="n">df_encoded</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">assert</span> <span class="s1">&#39;Sex&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_encoded</span><span class="o">.</span><span class="n">columns</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_male列の値が正しい</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;male 列の値が正しいことを確認（male=1, female=0）&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">SurvivedClassifier</span><span class="p">()</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;Sex&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;male&#39;</span><span class="p">,</span> <span class="s1">&#39;female&#39;</span><span class="p">,</span> <span class="s1">&#39;male&#39;</span><span class="p">,</span> <span class="s1">&#39;female&#39;</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">df_encoded</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">_encode_categorical</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="n">expected_male_values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">actual_male_values</span> <span class="o">=</span> <span class="n">df_encoded</span><span class="p">[</span><span class="s1">&#39;male&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">assert</span> <span class="n">actual_male_values</span> <span class="o">==</span> <span class="n">expected_male_values</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_他の列は保持される</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sex 以外の列は保持されることを確認&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">SurvivedClassifier</span><span class="p">()</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;Pclass&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="s1">&#39;Age&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">22.0</span><span class="p">,</span> <span class="mf">38.0</span><span class="p">],</span>
            <span class="s1">&#39;Sex&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;male&#39;</span><span class="p">,</span> <span class="s1">&#39;female&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Survived&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">df_encoded</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">_encode_categorical</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="k">assert</span> <span class="s1">&#39;Pclass&#39;</span> <span class="ow">in</span> <span class="n">df_encoded</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">assert</span> <span class="s1">&#39;Age&#39;</span> <span class="ow">in</span> <span class="n">df_encoded</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">assert</span> <span class="s1">&#39;Survived&#39;</span> <span class="ow">in</span> <span class="n">df_encoded</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">assert</span> <span class="n">df_encoded</span><span class="p">[</span><span class="s1">&#39;Pclass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">df_encoded</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mf">22.0</span><span class="p">,</span> <span class="mf">38.0</span><span class="p">]</span>
</code></pre></div>
<p><strong>Green: 実装</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_encode_categorical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sex をダミー変数に変換</span>

<span class="sd">    Args:</span>
<span class="sd">        df: 元の DataFrame</span>

<span class="sd">    Returns:</span>
<span class="sd">        Sex がダミー変数化された DataFrame</span>

<span class="sd">    Note:</span>
<span class="sd">        drop_first=True により、male 列のみ作成（female は 0/1 で表現）</span>
<span class="sd">        これにより多重共線性を回避</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_copy</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Sex をダミー変数化（drop_first=True で male 列のみ作成）</span>
    <span class="n">male</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">df_copy</span><span class="p">[</span><span class="s1">&#39;Sex&#39;</span><span class="p">],</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">df_encoded</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_copy</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Sex&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">male</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_encoded</span>
</code></pre></div>
<h5 id="4-class_weight">ステップ 4: モデルの訓練（class_weight 対応）<a class="headerlink" href="#4-class_weight" title="Permanent link">&para;</a></h5>
<p>クラス不均衡に対応した訓練を実装します。</p>
<p><strong>Red: テストを書く</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TestSurvivedClassifierTrain</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;訓練のテスト&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_モデルが訓練される</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;訓練後にモデルが設定されることを確認&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">SurvivedClassifier</span><span class="p">()</span>

        <span class="c1"># ダミーデータ</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;Pclass&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
            <span class="s1">&#39;Age&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">22.0</span><span class="p">,</span> <span class="mf">38.0</span><span class="p">,</span> <span class="mf">26.0</span><span class="p">],</span>
            <span class="s1">&#39;SibSp&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;Parch&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;Fare&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">7.25</span><span class="p">,</span> <span class="mf">71.28</span><span class="p">,</span> <span class="mf">7.92</span><span class="p">],</span>
            <span class="s1">&#39;male&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">})</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="n">classifier</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">classifier</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_訓練されていない状態で予測するとエラー</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;訓練前に予測しようとすると RuntimeError を発生&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">SurvivedClassifier</span><span class="p">()</span>

        <span class="n">X_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Pclass&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;Age&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">22.0</span><span class="p">],</span>
                               <span class="s1">&#39;SibSp&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;Parch&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="s1">&#39;Fare&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">7.25</span><span class="p">],</span> <span class="s1">&#39;male&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]})</span>

        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Model has not been trained yet&quot;</span><span class="p">):</span>
            <span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_class_weightパラメータが適用される</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;class_weight パラメータがモデルに適用されることを確認&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">SurvivedClassifier</span><span class="p">(</span><span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">)</span>

        <span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;Pclass&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
            <span class="s1">&#39;Age&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">22.0</span><span class="p">,</span> <span class="mf">38.0</span><span class="p">,</span> <span class="mf">26.0</span><span class="p">],</span>
            <span class="s1">&#39;SibSp&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;Parch&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;Fare&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">7.25</span><span class="p">,</span> <span class="mf">71.28</span><span class="p">,</span> <span class="mf">7.92</span><span class="p">],</span>
            <span class="s1">&#39;male&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">})</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="n">classifier</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">classifier</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">class_weight</span> <span class="o">==</span> <span class="s1">&#39;balanced&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_max_depthパラメータが適用される</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;max_depth パラメータがモデルに適用されることを確認&quot;&quot;&quot;</span>
        <span class="n">classifier</span> <span class="o">=</span> <span class="n">SurvivedClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;Pclass&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
            <span class="s1">&#39;Age&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">22.0</span><span class="p">,</span> <span class="mf">38.0</span><span class="p">,</span> <span class="mf">26.0</span><span class="p">],</span>
            <span class="s1">&#39;SibSp&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;Parch&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;Fare&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">7.25</span><span class="p">,</span> <span class="mf">71.28</span><span class="p">,</span> <span class="mf">7.92</span><span class="p">],</span>
            <span class="s1">&#39;male&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">})</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="n">classifier</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">classifier</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">==</span> <span class="mi">5</span>
</code></pre></div>
<p><strong>Green: 実装</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;モデルを訓練する</span>

<span class="sd">    Args:</span>
<span class="sd">        X_train: 訓練用特徴量</span>
<span class="sd">        y_train: 訓練用目的変数</span>

<span class="sd">    Note:</span>
<span class="sd">        class_weight=&#39;balanced&#39; により、クラス不均衡を自動的に調整</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeClassifier</span><span class="p">(</span>
        <span class="n">max_depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">class_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">class_weight</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</code></pre></div>
<h5 id="5_3">ステップ 5: 予測と評価<a class="headerlink" href="#5_3" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;予測を実行する</span>

<span class="sd">    Args:</span>
<span class="sd">        X_test: テスト用特徴量</span>

<span class="sd">    Returns:</span>
<span class="sd">        予測結果の配列</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: モデルが訓練されていない場合</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model has not been trained yet. Call train() first.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;モデルを評価する</span>

<span class="sd">    Args:</span>
<span class="sd">        X_test: テスト用特徴量</span>
<span class="sd">        y_test: テスト用目的変数</span>

<span class="sd">    Returns:</span>
<span class="sd">        正解率（accuracy）</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: モデルが訓練されていない場合</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model has not been trained yet. Call train() first.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</code></pre></div>
<h5 id="6_1">ステップ 6: モデルの永続化<a class="headerlink" href="#6_1" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>

<span class="k">def</span><span class="w"> </span><span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;訓練済みモデルをファイルに保存する</span>

<span class="sd">    Args:</span>
<span class="sd">        file_path: 保存先ファイルパス</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: モデルが訓練されていない場合</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model has not been trained yet. Call train() first.&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;保存されたモデルをファイルから読み込む</span>

<span class="sd">    Args:</span>
<span class="sd">        file_path: モデルファイルのパス</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: ファイルが存在しない場合</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model file not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</code></pre></div>
<h4 id="survivedclassifier">完全な SurvivedClassifier 実装<a class="headerlink" href="#survivedclassifier" title="Permanent link">&para;</a></h4>
<p><strong>src/ml/survived_classifier.py</strong> (完全版):</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Survived 生存予測器モジュール&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn</span><span class="w"> </span><span class="kn">import</span> <span class="n">tree</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SurvivedClassifier</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;客船沈没事故の生存を予測する分類モデル</span>

<span class="sd">    Attributes:</span>
<span class="sd">        max_depth: 決定木の最大深度</span>
<span class="sd">        class_weight: クラスの重み付け（&#39;balanced&#39; で自動調整）</span>
<span class="sd">        model: 訓練済みの決定木モデル（未訓練時は None）</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; classifier = SurvivedClassifier()</span>
<span class="sd">        &gt;&gt;&gt; X_train, y_train = classifier.load_data(&#39;data/Survived.csv&#39;)</span>
<span class="sd">        &gt;&gt;&gt; from sklearn.model_selection import train_test_split</span>
<span class="sd">        &gt;&gt;&gt; X_train, X_test, y_train, y_test = train_test_split(</span>
<span class="sd">        ...     X_train, y_train, test_size=0.2, random_state=0)</span>
<span class="sd">        &gt;&gt;&gt; classifier.train(X_train, y_train)</span>
<span class="sd">        &gt;&gt;&gt; accuracy = classifier.evaluate(X_test, y_test)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Accuracy: {accuracy:.4f}&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="n">class_weight</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;balanced&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;初期化</span>

<span class="sd">        Args:</span>
<span class="sd">            max_depth: 決定木の最大深度（デフォルト: 9）</span>
<span class="sd">            class_weight: クラス重み付け方法（デフォルト: &#39;balanced&#39;）</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: max_depth が 1 未満の場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">max_depth</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;max_depth must be at least 1&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_weight</span> <span class="o">=</span> <span class="n">class_weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeClassifier</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">preprocess</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;CSV ファイルからデータを読み込む</span>

<span class="sd">        Args:</span>
<span class="sd">            file_path: CSV ファイルのパス</span>
<span class="sd">            preprocess: 前処理を実行するかどうか（デフォルト: True）</span>

<span class="sd">        Returns:</span>
<span class="sd">            特徴量 DataFrame と目的変数 Series のタプル</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: ファイルが存在しない場合</span>
<span class="sd">            ValueError: 必要な列が不足している場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># データの読み込み</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="c1"># 必要な列の存在確認</span>
        <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Pclass&#39;</span><span class="p">,</span> <span class="s1">&#39;Age&#39;</span><span class="p">,</span> <span class="s1">&#39;SibSp&#39;</span><span class="p">,</span> <span class="s1">&#39;Parch&#39;</span><span class="p">,</span> <span class="s1">&#39;Fare&#39;</span><span class="p">,</span> <span class="s1">&#39;Sex&#39;</span><span class="p">,</span> <span class="s1">&#39;Survived&#39;</span><span class="p">]</span>
        <span class="n">missing_columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">required_columns</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing_columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing columns: </span><span class="si">{</span><span class="n">missing_columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 前処理の実行（オプション）</span>
        <span class="k">if</span> <span class="n">preprocess</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_data</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># 特徴量と目的変数の分割</span>
        <span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Pclass&#39;</span><span class="p">,</span> <span class="s1">&#39;Age&#39;</span><span class="p">,</span> <span class="s1">&#39;SibSp&#39;</span><span class="p">,</span> <span class="s1">&#39;Parch&#39;</span><span class="p">,</span> <span class="s1">&#39;Fare&#39;</span><span class="p">,</span> <span class="s1">&#39;male&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">preprocess</span><span class="p">:</span>
            <span class="c1"># 前処理なしの場合、Sex 列をそのまま使う（テスト用）</span>
            <span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Pclass&#39;</span><span class="p">,</span> <span class="s1">&#39;Age&#39;</span><span class="p">,</span> <span class="s1">&#39;SibSp&#39;</span><span class="p">,</span> <span class="s1">&#39;Parch&#39;</span><span class="p">,</span> <span class="s1">&#39;Fare&#39;</span><span class="p">,</span> <span class="s1">&#39;Sex&#39;</span><span class="p">]</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature_columns</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Survived&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_preprocess_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;データの前処理（内部メソッド）</span>

<span class="sd">        Args:</span>
<span class="sd">            df: 元の DataFrame</span>

<span class="sd">        Returns:</span>
<span class="sd">            前処理済みの DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_age</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_categorical</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_preprocess_age</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Age の欠損値を Pclass と Survived のグループ別中央値で補完</span>

<span class="sd">        Args:</span>
<span class="sd">            df: 元の DataFrame</span>

<span class="sd">        Returns:</span>
<span class="sd">            Age の欠損値が補完された DataFrame</span>

<span class="sd">        Note:</span>
<span class="sd">            各グループの中央値は実データ分析により決定：</span>
<span class="sd">            - (Pclass=1, Survived=0): 43歳</span>
<span class="sd">            - (Pclass=1, Survived=1): 35歳</span>
<span class="sd">            - (Pclass=2, Survived=0): 33歳</span>
<span class="sd">            - (Pclass=2, Survived=1): 25歳</span>
<span class="sd">            - (Pclass=3, Survived=0): 26歳</span>
<span class="sd">            - (Pclass=3, Survived=1): 20歳</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_copy</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">is_null</span> <span class="o">=</span> <span class="n">df_copy</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span>

        <span class="c1"># グループ別の中央値マッピング</span>
        <span class="n">age_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mi">43</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">35</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mi">33</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">25</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mi">26</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">20</span>
        <span class="p">}</span>

        <span class="c1"># 各グループの欠損値を中央値で補完</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">pclass</span><span class="p">,</span> <span class="n">survived</span><span class="p">),</span> <span class="n">median_age</span> <span class="ow">in</span> <span class="n">age_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_copy</span><span class="p">[</span><span class="s1">&#39;Pclass&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pclass</span><span class="p">)</span> <span class="o">&amp;</span> \
                   <span class="p">(</span><span class="n">df_copy</span><span class="p">[</span><span class="s1">&#39;Survived&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">survived</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">is_null</span>
            <span class="n">df_copy</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s1">&#39;Age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">median_age</span>

        <span class="k">return</span> <span class="n">df_copy</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_encode_categorical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sex をダミー変数に変換</span>

<span class="sd">        Args:</span>
<span class="sd">            df: 元の DataFrame</span>

<span class="sd">        Returns:</span>
<span class="sd">            Sex がダミー変数化された DataFrame</span>

<span class="sd">        Note:</span>
<span class="sd">            drop_first=True により、male 列のみ作成（female は 0/1 で表現）</span>
<span class="sd">            これにより多重共線性を回避</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_copy</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Sex をダミー変数化（drop_first=True で male 列のみ作成）</span>
        <span class="n">male</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">df_copy</span><span class="p">[</span><span class="s1">&#39;Sex&#39;</span><span class="p">],</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">df_encoded</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_copy</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Sex&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">male</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_encoded</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;モデルを訓練する</span>

<span class="sd">        Args:</span>
<span class="sd">            X_train: 訓練用特徴量</span>
<span class="sd">            y_train: 訓練用目的変数</span>

<span class="sd">        Note:</span>
<span class="sd">            class_weight=&#39;balanced&#39; により、クラス不均衡を自動的に調整</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">DecisionTreeClassifier</span><span class="p">(</span>
            <span class="n">max_depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">class_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">class_weight</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;予測を実行する</span>

<span class="sd">        Args:</span>
<span class="sd">            X_test: テスト用特徴量</span>

<span class="sd">        Returns:</span>
<span class="sd">            予測結果の配列（0: 死亡, 1: 生存）</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: モデルが訓練されていない場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model has not been trained yet. Call train() first.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;モデルを評価する</span>

<span class="sd">        Args:</span>
<span class="sd">            X_test: テスト用特徴量</span>
<span class="sd">            y_test: テスト用目的変数</span>

<span class="sd">        Returns:</span>
<span class="sd">            正解率（accuracy）</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: モデルが訓練されていない場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model has not been trained yet. Call train() first.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;訓練済みモデルをファイルに保存する</span>

<span class="sd">        Args:</span>
<span class="sd">            file_path: 保存先ファイルパス</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: モデルが訓練されていない場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model has not been trained yet. Call train() first.&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;保存されたモデルをファイルから読み込む</span>

<span class="sd">        Args:</span>
<span class="sd">            file_path: モデルファイルのパス</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: ファイルが存在しない場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model file not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</code></pre></div>
<h4 id="_48">実践的な訓練スクリプト<a class="headerlink" href="#_48" title="Permanent link">&para;</a></h4>
<p><strong>examples/train_survived.py</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Survived 生存予測モデルの訓練スクリプト&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.ml.survived_classifier</span><span class="w"> </span><span class="kn">import</span> <span class="n">SurvivedClassifier</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;メイン処理&quot;&quot;&quot;</span>
    <span class="c1"># 分類器の作成</span>
    <span class="n">classifier</span> <span class="o">=</span> <span class="n">SurvivedClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SurvivedClassifier を作成しました&quot;</span><span class="p">)</span>

    <span class="c1"># データの読み込みと前処理</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="s1">&#39;data/Survived.csv&#39;</span><span class="p">,</span> <span class="n">preprocess</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;データを読み込みました: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="si">}</span><span class="s2"> サンプル&quot;</span><span class="p">)</span>

    <span class="c1"># 訓練データとテストデータに分割</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;訓練データ: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="si">}</span><span class="s2"> サンプル&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;テストデータ: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="si">}</span><span class="s2"> サンプル&quot;</span><span class="p">)</span>

    <span class="c1"># クラス分布の確認</span>
    <span class="n">survived_count</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">total_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[訓練データのクラス分布]&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  生存: </span><span class="si">{</span><span class="n">survived_count</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">survived_count</span><span class="o">/</span><span class="n">total_count</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  死亡: </span><span class="si">{</span><span class="n">total_count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">survived_count</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="p">(</span><span class="n">total_count</span><span class="o">-</span><span class="n">survived_count</span><span class="p">)</span><span class="o">/</span><span class="n">total_count</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

    <span class="c1"># モデルの訓練</span>
    <span class="n">classifier</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">モデルの訓練が完了しました&quot;</span><span class="p">)</span>

    <span class="c1"># 特徴量の重要度表示</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[特徴量の重要度]&quot;</span><span class="p">)</span>
    <span class="n">feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Pclass&#39;</span><span class="p">,</span> <span class="s1">&#39;Age&#39;</span><span class="p">,</span> <span class="s1">&#39;SibSp&#39;</span><span class="p">,</span> <span class="s1">&#39;Parch&#39;</span><span class="p">,</span> <span class="s1">&#39;Fare&#39;</span><span class="p">,</span> <span class="s1">&#39;male&#39;</span><span class="p">]</span>
    <span class="n">importances</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span>

    <span class="c1"># 重要度でソート</span>
    <span class="n">sorted_indices</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">importances</span><span class="p">)),</span>
                           <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">importances</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">sorted_indices</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">feature_names</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">importances</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># モデルの評価</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[モデルの評価]&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  正解率（Accuracy）: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># モデルの保存</span>
    <span class="n">classifier</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="s1">&#39;model/survived.pkl&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">モデルを model/survived.pkl に保存しました&quot;</span><span class="p">)</span>

    <span class="c1"># 予測例</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[予測例]&quot;</span><span class="p">)</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">y_test</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">predicted</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;✓&quot;</span> <span class="k">if</span> <span class="n">actual</span> <span class="o">==</span> <span class="n">predicted</span> <span class="k">else</span> <span class="s2">&quot;✗&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">サンプル </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Pclass: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Pclass&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">, Age: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">, &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;Sex: </span><span class="si">{</span><span class="s1">&#39;male&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;male&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;female&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  SibSp: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;SibSp&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">, Parch: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Parch&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">, &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;Fare: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Fare&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  実際: </span><span class="si">{</span><span class="s1">&#39;生存&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">actual</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;死亡&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  予測: </span><span class="si">{</span><span class="s1">&#39;生存&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">predicted</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;死亡&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<p>実行例：</p>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>run<span class="w"> </span>python<span class="w"> </span>examples/train_survived.py

<span class="c1"># 出力例：</span>
<span class="c1"># SurvivedClassifier を作成しました</span>
<span class="c1"># データを読み込みました: 891 サンプル</span>
<span class="c1"># 訓練データ: 712 サンプル</span>
<span class="c1"># テストデータ: 179 サンプル</span>
<span class="c1">#</span>
<span class="c1"># [訓練データのクラス分布]</span>
<span class="c1">#   生存: 267 (37.5%)</span>
<span class="c1">#   死亡: 445 (62.5%)</span>
<span class="c1">#</span>
<span class="c1"># モデルの訓練が完了しました</span>
<span class="c1">#</span>
<span class="c1"># [特徴量の重要度]</span>
<span class="c1">#   male: 0.4235</span>
<span class="c1">#   Fare: 0.2134</span>
<span class="c1">#   Age: 0.1823</span>
<span class="c1">#   Pclass: 0.1245</span>
<span class="c1">#   Parch: 0.0345</span>
<span class="c1">#   SibSp: 0.0218</span>
<span class="c1">#</span>
<span class="c1"># [モデルの評価]</span>
<span class="c1">#   正解率（Accuracy）: 0.8324</span>
<span class="c1">#</span>
<span class="c1"># モデルを model/survived.pkl に保存しました</span>
<span class="c1">#</span>
<span class="c1"># [予測例]</span>
<span class="c1">#</span>
<span class="c1"># サンプル 1: ✓</span>
<span class="c1">#   Pclass: 3, Age: 22, Sex: male</span>
<span class="c1">#   SibSp: 1, Parch: 0, Fare: 7.25</span>
<span class="c1">#   実際: 死亡</span>
<span class="c1">#   予測: 死亡</span>
<span class="c1">#</span>
<span class="c1"># サンプル 2: ✓</span>
<span class="c1">#   Pclass: 1, Age: 38, Sex: female</span>
<span class="c1">#   SibSp: 1, Parch: 0, Fare: 71.28</span>
<span class="c1">#   実際: 生存</span>
<span class="c1">#   予測: 生存</span>
<span class="c1">#</span>
<span class="c1"># サンプル 3: ✗</span>
<span class="c1">#   Pclass: 3, Age: 26, Sex: male</span>
<span class="c1">#   SibSp: 0, Parch: 0, Fare: 7.92</span>
<span class="c1">#   実際: 生存</span>
<span class="c1">#   予測: 死亡</span>
</code></pre></div>
<hr />
<h3 id="6_2">📊 ６章の技術的成果<a class="headerlink" href="#6_2" title="Permanent link">&para;</a></h3>
<p>「実践的な分類問題もクリアしました！」お疲れさまでした！６章で何を達成したか、振り返ってみましょう。</p>
<h4 id="_49">✅ 完成した機能<a class="headerlink" href="#_49" title="Permanent link">&para;</a></h4>
<p>６章では、以下の機能を実装しました：</p>
<ul>
<li>✅ <strong>Survived 分類器クラスの完全実装</strong> - 生存を予測するモデル</li>
<li>✅ <strong>グループ別欠損値補完機能</strong> - 高度なデータ処理</li>
<li>✅ <strong>カテゴリカル変数のダミー変数化</strong> - 文字列を数値に変換</li>
<li>✅ <strong>クラス重み付き決定木モデル</strong> - 不均衡データへの対応</li>
<li>✅ <strong>特徴量重要度の分析</strong> - どの特徴が重要かを分析</li>
<li>✅ <strong>モデルの保存と読み込み機能</strong> - モデルの再利用</li>
</ul>
<h4 id="_50">📈 定量的成果<a class="headerlink" href="#_50" title="Permanent link">&para;</a></h4>
<p>数字で見ると、こんなに達成しました！</p>
<table>
<thead>
<tr>
<th>指標</th>
<th>🎯 実績</th>
</tr>
</thead>
<tbody>
<tr>
<td>🧪 <strong>テストケース</strong></td>
<td>22 個</td>
</tr>
<tr>
<td>📊 <strong>コードカバレッジ</strong></td>
<td>90%（survived_classifier.py）</td>
</tr>
<tr>
<td>🔤 <strong>型ヒント使用率</strong></td>
<td>100%</td>
</tr>
<tr>
<td>⛴️ <strong>モデル正解率</strong></td>
<td><strong>83.24%</strong>（テストデータ）</td>
</tr>
<tr>
<td>✨ <strong>Ruff チェック</strong></td>
<td>全て通過</td>
</tr>
<tr>
<td>✅ <strong>mypy チェック</strong></td>
<td>エラー 0 件</td>
</tr>
<tr>
<td>🔧 <strong>循環的複雑度</strong></td>
<td>最大 5（全関数）</td>
</tr>
</tbody>
</table>
<p><strong>83.24% の正解率！</strong> 実際のデータ（欠損値あり）でこの精度は素晴らしいです！🎉</p>
<h4 id="_51">🎓 習得したスキル<a class="headerlink" href="#_51" title="Permanent link">&para;</a></h4>
<h5 id="1-tdd_2">1. 🔄 TDD スキル（高度）<a class="headerlink" href="#1-tdd_2" title="Permanent link">&para;</a></h5>
<ul>
<li>✅ 複雑な前処理ロジックのテスト駆動実装</li>
<li>✅ グループ処理のテストケース設計</li>
<li>✅ カテゴリカル変数のテスト</li>
</ul>
<h5 id="2_7">2. 🔧 データ前処理スキル（実践）<a class="headerlink" href="#2_7" title="Permanent link">&para;</a></h5>
<ul>
<li>✅ グループ別統計による欠損値補完</li>
<li>✅ カテゴリカル変数のエンコーディング</li>
<li>✅ 多重共線性の回避（drop_first）</li>
</ul>
<h5 id="3_5">3. 🤖 機械学習スキル（分類応用）<a class="headerlink" href="#3_5" title="Permanent link">&para;</a></h5>
<ul>
<li>✅ クラス不均衡への対応</li>
<li>✅ 特徴量重要度の理解と活用</li>
<li>✅ class_weight パラメータの効果</li>
</ul>
<p><strong>4. データ分析スキル</strong>
- クラス分布の確認と理解
- 特徴量の影響度分析
- モデルの解釈可能性向上</p>
<h5 id="_52">グループ別欠損値補完の理解<a class="headerlink" href="#_52" title="Permanent link">&para;</a></h5>
<p><strong>なぜグループ別補完が重要か</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 単純な平均値補完</span>
<span class="c1"># → 全年齢層の平均（例: 29歳）で補完</span>
<span class="c1"># 問題: 1等客室の高齢者と3等客室の若者を区別できない</span>

<span class="c1"># グループ別中央値補完</span>
<span class="c1"># → Pclass と Survived ごとの中央値で補完</span>
<span class="c1"># 利点: より正確な年齢推定が可能</span>

<span class="c1"># 例:</span>
<span class="c1"># 1等客室の死亡者: 平均43歳（高齢富裕層）</span>
<span class="c1"># 3等客室の生存者: 平均20歳（若い移民層）</span>
</code></pre></div>
<h5 id="_53">カテゴリカル変数エンコーディングの理解<a class="headerlink" href="#_53" title="Permanent link">&para;</a></h5>
<p><strong>ダミー変数化の仕組み</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 元データ:</span>
<span class="c1"># Sex = [&#39;male&#39;, &#39;female&#39;, &#39;male&#39;]</span>

<span class="c1"># pd.get_dummies(drop_first=False)  # 両方の列を作成</span>
<span class="c1"># → male = [1, 0, 1]</span>
<span class="c1"># → female = [0, 1, 0]</span>
<span class="c1"># 問題: male と female が完全に逆なので冗長（多重共線性）</span>

<span class="c1"># pd.get_dummies(drop_first=True)  # male 列のみ作成</span>
<span class="c1"># → male = [1, 0, 1]</span>
<span class="c1"># 解釈: 1=male, 0=female</span>
<span class="c1"># 利点: 1列で表現できて効率的</span>
</code></pre></div>
<h5 id="_54">クラス不均衡への対応<a class="headerlink" href="#_54" title="Permanent link">&para;</a></h5>
<p><strong>class_weight='balanced' の効果</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># データセットの分布</span>
<span class="c1"># 生存: 267人（37.5%）</span>
<span class="c1"># 死亡: 445人（62.5%）</span>

<span class="c1"># class_weight=None（デフォルト）</span>
<span class="c1"># → モデルが多数派クラス（死亡）に偏る</span>
<span class="c1"># → 「全員死亡」と予測しても 62.5% の正解率</span>

<span class="c1"># class_weight=&#39;balanced&#39;</span>
<span class="c1"># → 少数派クラス（生存）のサンプルに大きな重みを付与</span>
<span class="c1"># → バランスの取れた予測が可能（正解率 83.24%）</span>
</code></pre></div>
<p>重み計算式：</p>
<div class="highlight"><pre><span></span><code>weight[class_i] = n_samples / (n_classes * n_samples[class_i])

例：
weight[生存] = 712 / (2 * 267) ≈ 1.33
weight[死亡] = 712 / (2 * 445) ≈ 0.80
</code></pre></div>
<h5 id="iris-vs-survived">分類モデルの比較（Iris vs Survived）<a class="headerlink" href="#iris-vs-survived" title="Permanent link">&para;</a></h5>
<table>
<thead>
<tr>
<th>項目</th>
<th>Iris（基礎）</th>
<th><strong>Survived（実践）</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>モデル</strong></td>
<td>DecisionTreeClassifier</td>
<td>DecisionTreeClassifier</td>
</tr>
<tr>
<td><strong>クラス数</strong></td>
<td>3クラス</td>
<td>2クラス（二値分類）</td>
</tr>
<tr>
<td><strong>前処理</strong></td>
<td>平均値補完のみ</td>
<td><strong>グループ別補完 + エンコーディング</strong></td>
</tr>
<tr>
<td><strong>カテゴリカル変数</strong></td>
<td>なし</td>
<td><strong>あり（Sex）</strong></td>
</tr>
<tr>
<td><strong>クラス不均衡対応</strong></td>
<td>なし</td>
<td><strong>class_weight='balanced'</strong></td>
</tr>
<tr>
<td><strong>max_depth</strong></td>
<td>2</td>
<td><strong>9</strong></td>
</tr>
<tr>
<td><strong>テスト数</strong></td>
<td>18個</td>
<td><strong>22個</strong></td>
</tr>
<tr>
<td><strong>正解率</strong></td>
<td>97.78%</td>
<td><strong>83.24%</strong></td>
</tr>
</tbody>
</table>
<p><strong>正解率の違いの理由</strong>:</p>
<ul>
<li>Iris: 明確に分離可能な3つの種類（データが「きれい」）</li>
<li>Survived: 複雑な社会的要因（データが「現実的」）</li>
<li>生存には運の要素も関与</li>
<li>特徴量だけでは説明できない部分がある</li>
</ul>
<h4 id="_55">🚀 次の章への準備<a class="headerlink" href="#_55" title="Permanent link">&para;</a></h4>
<p>６章では、実践的な分類問題を解決しました！次の７章では、以下を実装します：</p>
<ul>
<li>🏠 <strong>Boston 住宅価格予測モデル</strong> - 高度な回帰問題</li>
<li>⚙️ <strong>特徴量エンジニアリング</strong> - 2 乗項・交互作用項で表現力向上</li>
<li>📊 <strong>データ標準化</strong> - StandardScaler による正規化</li>
<li>💾 <strong>複数モデルの管理</strong> - モデル + スケーラーの一括管理</li>
</ul>
<p>より高度な回帰テクニックを学びます！楽しみですね！🚀</p>
<hr />
<hr />
<h2 id="7-boston">７章 Boston 住宅価格予測モデル（高度な回帰問題）<a class="headerlink" href="#7-boston" title="Permanent link">&para;</a></h2>
<p>「回帰問題の基礎は学んだけど、もっと高度なテクニックを知りたい！」そんなあなたのための章です！</p>
<p>この章では、ボストンの住宅データから住宅価格を予測するモデルを作ります。<strong>特徴量エンジニアリング</strong>という重要なテクニックを学びます！🏠</p>
<h3 id="_56">🎯 この章の学習目標<a class="headerlink" href="#_56" title="Permanent link">&para;</a></h3>
<p>この章では、実務レベルの高度な技術を習得します：</p>
<ol>
<li>🔧 <strong>特徴量エンジニアリング</strong> - 2 乗項・交互作用項で表現力向上</li>
<li>📊 <strong>データ標準化</strong> - StandardScaler による正規化</li>
<li>💾 <strong>複数モデル管理</strong> - モデル + 2 つのスケーラーを一括管理</li>
<li>🔄 <strong>高度な TDD</strong> - 標準化処理のテスト駆動実装</li>
</ol>
<p>「え、難しそう...」と思いましたか？実は、これまで学んだことの応用なので、意外とできちゃいます！</p>
<h4 id="boston">Boston データセットの理解<a class="headerlink" href="#boston" title="Permanent link">&para;</a></h4>
<h5 id="_57">データ詳細<a class="headerlink" href="#_57" title="Permanent link">&para;</a></h5>
<p><code>data/Boston.csv</code> を使用します。</p>
<table>
<thead>
<tr>
<th>列名</th>
<th>内容</th>
<th>データ型</th>
<th>特徴</th>
</tr>
</thead>
<tbody>
<tr>
<td>RM</td>
<td>住居の平均部屋数</td>
<td>float</td>
<td><strong>重要な特徴量</strong></td>
</tr>
<tr>
<td>LSTAT</td>
<td>人口における低所得者の割合（%）</td>
<td>float</td>
<td><strong>重要な特徴量</strong></td>
</tr>
<tr>
<td>PTRATIO</td>
<td>教員1人当たりの児童生徒数</td>
<td>float</td>
<td><strong>重要な特徴量</strong></td>
</tr>
<tr>
<td>CRIME</td>
<td>犯罪率カテゴリ</td>
<td>str</td>
<td><strong>ダミー変数化が必要</strong></td>
</tr>
<tr>
<td>PRICE</td>
<td>住宅価格（$1000単位）</td>
<td>float</td>
<td><strong>目的変数</strong></td>
</tr>
</tbody>
</table>
<h5 id="cinema_2">Cinema との違い<a class="headerlink" href="#cinema_2" title="Permanent link">&para;</a></h5>
<table>
<thead>
<tr>
<th>特徴</th>
<th>Cinema</th>
<th><strong>Boston</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>問題の種類</strong></td>
<td>回帰</td>
<td><strong>回帰</strong></td>
</tr>
<tr>
<td><strong>特徴量数</strong></td>
<td>4個</td>
<td><strong>3個（基本）→ 7個（エンジニアリング後）</strong></td>
</tr>
<tr>
<td><strong>前処理</strong></td>
<td>欠損値補完 + 外れ値除外</td>
<td><strong>欠損値補完 + 外れ値除外 + ダミー変数化</strong></td>
</tr>
<tr>
<td><strong>特徴量エンジニアリング</strong></td>
<td>なし</td>
<td><strong>あり（2乗項 + 交互作用項）</strong></td>
</tr>
<tr>
<td><strong>標準化</strong></td>
<td>なし</td>
<td><strong>あり（特徴量 + 目的変数）</strong></td>
</tr>
<tr>
<td><strong>保存モデル数</strong></td>
<td>1個（model）</td>
<td><strong>3個（model + scaler_X + scaler_y）</strong></td>
</tr>
<tr>
<td><strong>前処理の複雑度</strong></td>
<td>中</td>
<td><strong>高</strong></td>
</tr>
</tbody>
</table>
<h5 id="_58">問題の複雑性<a class="headerlink" href="#_58" title="Permanent link">&para;</a></h5>
<p><strong>1. 特徴量エンジニアリング</strong></p>
<p>線形回帰の表現力を向上させるため、元の特徴量から新しい特徴量を生成します。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 元の特徴量: RM, LSTAT, PTRATIO（3個）</span>

<span class="c1"># 特徴量エンジニアリング後:</span>
<span class="c1"># - 元の特徴量: RM, LSTAT, PTRATIO</span>
<span class="c1"># - 2乗項: RM2, LSTAT2, PTRATIO2</span>
<span class="c1"># - 交互作用項: RM * LSTAT</span>
<span class="c1"># 合計: 7個の特徴量</span>
</code></pre></div>
<p><strong>2. データ標準化の必要性</strong></p>
<p>特徴量のスケールが異なると、モデルの学習が不安定になります。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 標準化前:</span>
<span class="c1"># RM: 3〜9（平均部屋数）</span>
<span class="c1"># LSTAT: 1〜40（低所得者割合%）</span>
<span class="c1"># PTRATIO: 12〜22（生徒数）</span>
<span class="c1"># → スケールが大きく異なる</span>

<span class="c1"># 標準化後:</span>
<span class="c1"># すべての特徴量が平均0、標準偏差1に正規化</span>
<span class="c1"># → 学習が安定し、モデルの解釈が容易に</span>
</code></pre></div>
<p><strong>3. データリーケージの防止</strong></p>
<p>訓練データとテストデータを厳密に分離し、テストデータの情報が訓練に漏れないようにします。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ❌ 悪い例（データリーケージあり）</span>
<span class="c1"># 全データで欠損値補完 → 分割</span>
<span class="c1"># → テストデータの情報が訓練に漏れる</span>

<span class="c1"># ✅ 良い例（データリーケージなし）</span>
<span class="c1"># 分割 → 訓練データで欠損値の平均を計算 → テストデータに適用</span>
<span class="c1"># → テストデータの情報は使わない</span>
</code></pre></div>
<h4 id="tdd-8">TDD による実装（8ステップ）<a class="headerlink" href="#tdd-8" title="Permanent link">&para;</a></h4>
<h5 id="1_5">ステップ 1: 初期化とデータ読み込み<a class="headerlink" href="#1_5" title="Permanent link">&para;</a></h5>
<p><strong>Red: テストを書く</strong></p>
<p><strong>test/test_boston_predictor.py</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Boston 住宅価格予測器のテストモジュール&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.ml.boston_predictor</span><span class="w"> </span><span class="kn">import</span> <span class="n">BostonPredictor</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestBostonPredictorInit</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;初期化のテスト&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_初期化_デフォルト</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;デフォルトで初期化できることを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">BostonPredictor</span><span class="p">()</span>

        <span class="k">assert</span> <span class="n">predictor</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">predictor</span><span class="o">.</span><span class="n">scaler_X</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">predictor</span><span class="o">.</span><span class="n">scaler_y</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">predictor</span><span class="o">.</span><span class="n">train_mean</span> <span class="ow">is</span> <span class="kc">None</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestBostonPredictorLoadData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;データ読み込みのテスト&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_CSVファイルの読み込み</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;CSV ファイルが正常に読み込めることを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">BostonPredictor</span><span class="p">()</span>

        <span class="c1"># テストデータ作成</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;RM,LSTAT,PTRATIO,CRIME,PRICE</span>
<span class="s2">6.5,5.0,15.0,low,24.0</span>
<span class="s2">5.5,10.0,18.0,high,18.5</span>
<span class="s2">7.0,3.0,14.0,low,33.2&quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
            <span class="n">temp_path</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>

            <span class="c1"># データが正しく読み込まれることを確認</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
            <span class="k">assert</span> <span class="s1">&#39;PRICE&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">assert</span> <span class="s1">&#39;RM&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_ファイルが存在しない場合エラー</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;存在しないファイルパスを指定した場合 FileNotFoundError を発生&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">BostonPredictor</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">):</span>
            <span class="n">predictor</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="s1">&#39;nonexistent.csv&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_必要な列が不足している場合エラー</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;必要な列が不足している場合 ValueError を発生&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">BostonPredictor</span><span class="p">()</span>

        <span class="c1"># PRICE 列が欠けているデータ</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;RM,LSTAT,PTRATIO</span>
<span class="s2">6.5,5.0,15.0&quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
            <span class="n">temp_path</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Missing columns&quot;</span><span class="p">):</span>
                <span class="n">predictor</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
</code></pre></div>
<p><strong>Green: 最小限の実装</strong></p>
<p><strong>src/ml/boston_predictor.py</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Boston 住宅価格予測器モジュール&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>


<span class="k">class</span><span class="w"> </span><span class="nc">BostonPredictor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ボストン市の住宅価格を予測する回帰モデル</span>

<span class="sd">    Attributes:</span>
<span class="sd">        model: 訓練済みの線形回帰モデル（未訓練時は None）</span>
<span class="sd">        scaler_X: 特徴量の標準化スケーラー（未訓練時は None）</span>
<span class="sd">        scaler_y: 目的変数の標準化スケーラー（未訓練時は None）</span>
<span class="sd">        train_mean: 訓練データの平均値（欠損値補完用）</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;初期化&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LinearRegression</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StandardScaler</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StandardScaler</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_mean</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;CSV ファイルからデータを読み込む</span>

<span class="sd">        Args:</span>
<span class="sd">            file_path: CSV ファイルのパス</span>

<span class="sd">        Returns:</span>
<span class="sd">            読み込んだ DataFrame</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: ファイルが存在しない場合</span>
<span class="sd">            ValueError: 必要な列が不足している場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># データの読み込み</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="c1"># 必要な列の存在確認</span>
        <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RM&#39;</span><span class="p">,</span> <span class="s1">&#39;LSTAT&#39;</span><span class="p">,</span> <span class="s1">&#39;PTRATIO&#39;</span><span class="p">,</span> <span class="s1">&#39;CRIME&#39;</span><span class="p">,</span> <span class="s1">&#39;PRICE&#39;</span><span class="p">]</span>
        <span class="n">missing_columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">required_columns</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing_columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing columns: </span><span class="si">{</span><span class="n">missing_columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>
</code></pre></div>
<h5 id="2-crime">ステップ 2: CRIME 列のダミー変数化<a class="headerlink" href="#2-crime" title="Permanent link">&para;</a></h5>
<p>カテゴリカル変数 CRIME を数値化します。</p>
<p><strong>Red: テストを書く</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TestBostonPredictorEncodeCrime</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CRIME 列ダミー変数化のテスト&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_CRIME列がダミー変数化される</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;CRIME 列がダミー変数に変換されることを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">BostonPredictor</span><span class="p">()</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;RM&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">6.5</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">],</span>
            <span class="s1">&#39;CRIME&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">],</span>
            <span class="s1">&#39;PRICE&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">24.0</span><span class="p">,</span> <span class="mf">18.5</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">df_encoded</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">_encode_crime</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># CRIME 列が削除され、ダミー変数が追加されることを確認</span>
        <span class="k">assert</span> <span class="s1">&#39;CRIME&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_encoded</span><span class="o">.</span><span class="n">columns</span>
        <span class="c1"># drop_first=True なので high のみ作成される</span>
        <span class="k">assert</span> <span class="s1">&#39;high&#39;</span> <span class="ow">in</span> <span class="n">df_encoded</span><span class="o">.</span><span class="n">columns</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_ダミー変数の値が正しい</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ダミー変数の値が正しいことを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">BostonPredictor</span><span class="p">()</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;CRIME&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">df_encoded</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">_encode_crime</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># drop_first=True により、low 以外のカテゴリが列として作成される</span>
        <span class="k">assert</span> <span class="s1">&#39;high&#39;</span> <span class="ow">in</span> <span class="n">df_encoded</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">assert</span> <span class="s1">&#39;medium&#39;</span> <span class="ow">in</span> <span class="n">df_encoded</span><span class="o">.</span><span class="n">columns</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_他の列は保持される</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;CRIME 以外の列は保持されることを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">BostonPredictor</span><span class="p">()</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;RM&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">6.5</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">],</span>
            <span class="s1">&#39;LSTAT&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">],</span>
            <span class="s1">&#39;CRIME&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">],</span>
            <span class="s1">&#39;PRICE&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">24.0</span><span class="p">,</span> <span class="mf">18.5</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">df_encoded</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">_encode_crime</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="k">assert</span> <span class="s1">&#39;RM&#39;</span> <span class="ow">in</span> <span class="n">df_encoded</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">assert</span> <span class="s1">&#39;LSTAT&#39;</span> <span class="ow">in</span> <span class="n">df_encoded</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">assert</span> <span class="s1">&#39;PRICE&#39;</span> <span class="ow">in</span> <span class="n">df_encoded</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">assert</span> <span class="n">df_encoded</span><span class="p">[</span><span class="s1">&#39;RM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mf">6.5</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">]</span>
</code></pre></div>
<p><strong>Green: 実装</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_encode_crime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CRIME 列をダミー変数に変換</span>

<span class="sd">    Args:</span>
<span class="sd">        df: 元の DataFrame</span>

<span class="sd">    Returns:</span>
<span class="sd">        CRIME がダミー変数化された DataFrame</span>

<span class="sd">    Note:</span>
<span class="sd">        drop_first=True により、最初のカテゴリ（アルファベット順）を</span>
<span class="sd">        基準とし、それ以外のカテゴリのダミー変数を作成</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_copy</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># CRIME をダミー変数化（drop_first=True）</span>
    <span class="n">crime_dummies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">df_copy</span><span class="p">[</span><span class="s1">&#39;CRIME&#39;</span><span class="p">],</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">df_encoded</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_copy</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;CRIME&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">crime_dummies</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_encoded</span>
</code></pre></div>
<h5 id="3_6">ステップ 3: 欠損値補完と外れ値除外<a class="headerlink" href="#3_6" title="Permanent link">&para;</a></h5>
<p><strong>Red: テストを書く</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TestBostonPredictorPreprocess</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;前処理のテスト&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_欠損値が平均値で補完される</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;欠損値が訓練データの平均値で補完されることを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">BostonPredictor</span><span class="p">()</span>

        <span class="n">df_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;RM&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">6.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">],</span>
            <span class="s1">&#39;LSTAT&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>  <span class="c1"># 平均: 7.5</span>
            <span class="s1">&#39;PRICE&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">24.0</span><span class="p">,</span> <span class="mf">18.5</span><span class="p">,</span> <span class="mf">21.0</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">df_filled</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">_fill_missing_values</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># 欠損値が平均値で補完される</span>
        <span class="k">assert</span> <span class="n">df_filled</span><span class="p">[</span><span class="s1">&#39;LSTAT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mf">7.5</span>
        <span class="c1"># train_mean が保存される</span>
        <span class="k">assert</span> <span class="n">predictor</span><span class="o">.</span><span class="n">train_mean</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_テストデータは訓練データの平均で補完される</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;テストデータは訓練データの平均で補完されることを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">BostonPredictor</span><span class="p">()</span>

        <span class="n">df_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;RM&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">6.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">],</span>
            <span class="s1">&#39;LSTAT&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">],</span>
            <span class="s1">&#39;PRICE&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">24.0</span><span class="p">,</span> <span class="mf">18.5</span><span class="p">,</span> <span class="mf">21.0</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="c1"># 訓練データで平均を計算</span>
        <span class="n">predictor</span><span class="o">.</span><span class="n">_fill_missing_values</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">df_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;RM&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
            <span class="s1">&#39;LSTAT&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">8.0</span><span class="p">],</span>
            <span class="s1">&#39;PRICE&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">20.0</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="c1"># テストデータは訓練データの平均で補完</span>
        <span class="n">df_test_filled</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">_fill_missing_values</span><span class="p">(</span><span class="n">df_test</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># 訓練データの RM 平均は 6.0</span>
        <span class="k">assert</span> <span class="n">df_test_filled</span><span class="p">[</span><span class="s1">&#39;RM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">6.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_外れ値が除外される</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;特定のインデックスの外れ値が除外されることを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">BostonPredictor</span><span class="p">()</span>

        <span class="c1"># インデックス 76 を含むデータ</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;RM&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">6.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">],</span>
            <span class="s1">&#39;PRICE&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">24.0</span><span class="p">,</span> <span class="mf">18.5</span><span class="p">,</span> <span class="mf">21.0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">]</span>
        <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

        <span class="n">df_cleaned</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">_remove_outliers</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># インデックス 76 が除外される</span>
        <span class="k">assert</span> <span class="mi">76</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_cleaned</span><span class="o">.</span><span class="n">index</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_cleaned</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
</code></pre></div>
<p><strong>Green: 実装</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_fill_missing_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">fit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;欠損値を平均値で補完</span>

<span class="sd">    Args:</span>
<span class="sd">        df: 対象の DataFrame</span>
<span class="sd">        fit: True の場合は平均値を計算して保存、False の場合は保存済みの平均値を使用</span>

<span class="sd">    Returns:</span>
<span class="sd">        欠損値が補完された DataFrame</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: fit=False の場合で train_mean が未設定の場合</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">fit</span><span class="p">:</span>
        <span class="c1"># 訓練データの平均値を計算して保存</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_mean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_mean</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># テストデータは訓練データの平均値で補完</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mean</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;train_mean not set. Call with fit=True first.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_mean</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_remove_outliers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;外れ値を除外</span>

<span class="sd">    Args:</span>
<span class="sd">        df: 対象の DataFrame</span>

<span class="sd">    Returns:</span>
<span class="sd">        外れ値を除外した DataFrame</span>

<span class="sd">    Note:</span>
<span class="sd">        インデックス 76 のデータポイントを外れ値として除外</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># インデックス 76 が存在する場合のみ除外</span>
    <span class="k">if</span> <span class="mi">76</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="mi">76</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>
</code></pre></div>
<h5 id="4_6">ステップ 4: 特徴量エンジニアリング<a class="headerlink" href="#4_6" title="Permanent link">&para;</a></h5>
<p>2乗項と交互作用項を追加してモデルの表現力を向上させます。</p>
<p><strong>Red: テストを書く</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TestBostonPredictorFeatureEngineering</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;特徴量エンジニアリングのテスト&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_2乗項が追加される</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;2乗項が正しく追加されることを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">BostonPredictor</span><span class="p">()</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;RM&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">6.5</span><span class="p">],</span>
            <span class="s1">&#39;LSTAT&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">],</span>
            <span class="s1">&#39;PTRATIO&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">15.0</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">X_engineered</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">feature_engineering</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># 2乗項が追加される</span>
        <span class="k">assert</span> <span class="s1">&#39;RM2&#39;</span> <span class="ow">in</span> <span class="n">X_engineered</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">assert</span> <span class="s1">&#39;LSTAT2&#39;</span> <span class="ow">in</span> <span class="n">X_engineered</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">assert</span> <span class="s1">&#39;PTRATIO2&#39;</span> <span class="ow">in</span> <span class="n">X_engineered</span><span class="o">.</span><span class="n">columns</span>

        <span class="c1"># 値が正しい</span>
        <span class="k">assert</span> <span class="n">X_engineered</span><span class="p">[</span><span class="s1">&#39;RM2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">42.25</span>  <span class="c1"># 6.5^2</span>
        <span class="k">assert</span> <span class="n">X_engineered</span><span class="p">[</span><span class="s1">&#39;LSTAT2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">25.0</span>  <span class="c1"># 5.0^2</span>
        <span class="k">assert</span> <span class="n">X_engineered</span><span class="p">[</span><span class="s1">&#39;PTRATIO2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">225.0</span>  <span class="c1"># 15.0^2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_交互作用項が追加される</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;交互作用項が正しく追加されることを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">BostonPredictor</span><span class="p">()</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;RM&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">6.5</span><span class="p">],</span>
            <span class="s1">&#39;LSTAT&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">],</span>
            <span class="s1">&#39;PTRATIO&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">15.0</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">X_engineered</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">feature_engineering</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># 交互作用項が追加される</span>
        <span class="k">assert</span> <span class="s1">&#39;RM * LSTAT&#39;</span> <span class="ow">in</span> <span class="n">X_engineered</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">assert</span> <span class="n">X_engineered</span><span class="p">[</span><span class="s1">&#39;RM * LSTAT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">32.5</span>  <span class="c1"># 6.5 * 5.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_元の特徴量は保持される</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;元の特徴量が保持されることを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">BostonPredictor</span><span class="p">()</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;RM&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">6.5</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">],</span>
            <span class="s1">&#39;LSTAT&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">],</span>
            <span class="s1">&#39;PTRATIO&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">15.0</span><span class="p">,</span> <span class="mf">18.0</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">X_engineered</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">feature_engineering</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># 元の特徴量が保持される</span>
        <span class="k">assert</span> <span class="s1">&#39;RM&#39;</span> <span class="ow">in</span> <span class="n">X_engineered</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">assert</span> <span class="s1">&#39;LSTAT&#39;</span> <span class="ow">in</span> <span class="n">X_engineered</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">assert</span> <span class="s1">&#39;PTRATIO&#39;</span> <span class="ow">in</span> <span class="n">X_engineered</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">assert</span> <span class="n">X_engineered</span><span class="p">[</span><span class="s1">&#39;RM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mf">6.5</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_特徴量数が正しい</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;特徴量数が3個から7個に増えることを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">BostonPredictor</span><span class="p">()</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;RM&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">6.5</span><span class="p">],</span>
            <span class="s1">&#39;LSTAT&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">],</span>
            <span class="s1">&#39;PTRATIO&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">15.0</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">X_engineered</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">feature_engineering</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># 元の3個 + 2乗項3個 + 交互作用項1個 = 7個</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_engineered</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span>
</code></pre></div>
<p><strong>Green: 実装</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">feature_engineering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;特徴量エンジニアリング（2乗項と交互作用項の追加）</span>

<span class="sd">    Args:</span>
<span class="sd">        X: 元の特徴量 DataFrame</span>

<span class="sd">    Returns:</span>
<span class="sd">        エンジニアリング後の特徴量 DataFrame</span>

<span class="sd">    Note:</span>
<span class="sd">        - 2乗項: RM2, LSTAT2, PTRATIO2</span>
<span class="sd">        - 交互作用項: RM * LSTAT</span>
<span class="sd">        合計7個の特徴量を生成</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X_new</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># 2乗項の追加</span>
    <span class="n">X_new</span><span class="p">[</span><span class="s1">&#39;RM2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;RM&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">X_new</span><span class="p">[</span><span class="s1">&#39;LSTAT2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;LSTAT&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">X_new</span><span class="p">[</span><span class="s1">&#39;PTRATIO2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;PTRATIO&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="c1"># 交互作用項の追加</span>
    <span class="n">X_new</span><span class="p">[</span><span class="s1">&#39;RM * LSTAT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;RM&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;LSTAT&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">X_new</span>
</code></pre></div>
<h5 id="5_4">ステップ 5: データ標準化<a class="headerlink" href="#5_4" title="Permanent link">&para;</a></h5>
<p>特徴量と目的変数の両方を標準化します。</p>
<p><strong>Red: テストを書く</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TestBostonPredictorStandardization</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;標準化のテスト&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_特徴量の標準化_訓練データ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;訓練データの特徴量が標準化されることを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">BostonPredictor</span><span class="p">()</span>

        <span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;RM&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">],</span>
            <span class="s1">&#39;LSTAT&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">X_scaled</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">standardize_features</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># 標準化後、平均が0、標準偏差が1付近になることを確認</span>
        <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">X_scaled</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mf">0.01</span>
        <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">X_scaled</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.01</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_特徴量の標準化_テストデータ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;テストデータが訓練データのスケーラーで標準化されることを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">BostonPredictor</span><span class="p">()</span>

        <span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;RM&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">X_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;RM&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="c1"># 訓練データでスケーラーを fit</span>
        <span class="n">predictor</span><span class="o">.</span><span class="n">standardize_features</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># テストデータは同じスケーラーで transform のみ</span>
        <span class="n">X_test_scaled</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">standardize_features</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># スケーラーが同じであることを確認</span>
        <span class="k">assert</span> <span class="n">predictor</span><span class="o">.</span><span class="n">scaler_X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="c1"># テストデータの値が訓練データの統計量で変換されることを確認</span>
        <span class="k">assert</span> <span class="n">X_test_scaled</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_目的変数の標準化</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;目的変数が標準化されることを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">BostonPredictor</span><span class="p">()</span>

        <span class="n">y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;PRICE&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">20.0</span><span class="p">,</span> <span class="mf">25.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">y_scaled</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">standardize_target</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># 標準化後、平均が0、標準偏差が1付近になることを確認</span>
        <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y_scaled</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mf">0.01</span>
        <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y_scaled</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.01</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_逆標準化</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;予測結果が元のスケールに戻されることを確認&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">BostonPredictor</span><span class="p">()</span>

        <span class="n">y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;PRICE&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">20.0</span><span class="p">,</span> <span class="mf">25.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="c1"># 標準化</span>
        <span class="n">y_scaled</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">standardize_target</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># 逆標準化</span>
        <span class="n">y_original</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">inverse_transform_prediction</span><span class="p">(</span><span class="n">y_scaled</span><span class="p">)</span>

        <span class="c1"># 元の値に戻ることを確認</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">y_original</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                                             <span class="n">y_train</span><span class="p">[</span><span class="s1">&#39;PRICE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                             <span class="n">decimal</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_fit前にtransformするとエラー</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;fit 前に transform しようとすると ValueError を発生&quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">BostonPredictor</span><span class="p">()</span>

        <span class="n">X_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;RM&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">6.0</span><span class="p">]})</span>

        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Scaler not fitted yet&quot;</span><span class="p">):</span>
            <span class="n">predictor</span><span class="o">.</span><span class="n">standardize_features</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<p><strong>Green: 実装</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">standardize_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">fit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;特徴量を標準化</span>

<span class="sd">    Args:</span>
<span class="sd">        X: 特徴量 DataFrame</span>
<span class="sd">        fit: True の場合は fit_transform、False の場合は transform のみ</span>

<span class="sd">    Returns:</span>
<span class="sd">        標準化された特徴量（numpy 配列）</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: fit=False の場合で scaler_X が未設定の場合</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">fit</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Scaler not fitted yet. Call with fit=True first.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">standardize_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">fit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;目的変数を標準化</span>

<span class="sd">    Args:</span>
<span class="sd">        y: 目的変数 DataFrame</span>
<span class="sd">        fit: True の場合は fit_transform、False の場合は transform のみ</span>

<span class="sd">    Returns:</span>
<span class="sd">        標準化された目的変数（numpy 配列）</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: fit=False の場合で scaler_y が未設定の場合</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">fit</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Scaler not fitted yet. Call with fit=True first.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">inverse_transform_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;予測結果を元のスケールに戻す</span>

<span class="sd">    Args:</span>
<span class="sd">        y_pred: 標準化された予測結果</span>

<span class="sd">    Returns:</span>
<span class="sd">        元のスケールに戻された予測結果</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: scaler_y が未設定の場合</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;scaler_y not set. Train the model first.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
</code></pre></div>
<h5 id="6_3">ステップ 6: モデルの訓練<a class="headerlink" href="#6_3" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;モデルを訓練する</span>

<span class="sd">    Args:</span>
<span class="sd">        X_train: 訓練用特徴量（標準化済み）</span>
<span class="sd">        y_train: 訓練用目的変数（標準化済み）</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</code></pre></div>
<h5 id="7">ステップ 7: 予測と評価<a class="headerlink" href="#7" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;予測を実行する</span>

<span class="sd">    Args:</span>
<span class="sd">        X_test: テスト用特徴量（標準化済み）</span>

<span class="sd">    Returns:</span>
<span class="sd">        予測結果（標準化済み）</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: モデルが訓練されていない場合</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model has not been trained yet. Call train() first.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;モデルを評価する</span>

<span class="sd">    Args:</span>
<span class="sd">        X_test: テスト用特徴量（標準化済み）</span>
<span class="sd">        y_test: テスト用目的変数（標準化済み）</span>

<span class="sd">    Returns:</span>
<span class="sd">        決定係数（R²）</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: モデルが訓練されていない場合</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model has not been trained yet. Call train() first.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</code></pre></div>
<h5 id="8">ステップ 8: モデルとスケーラーの永続化<a class="headerlink" href="#8" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>

<span class="k">def</span><span class="w"> </span><span class="nf">save_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">scaler_X_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">scaler_y_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;モデルとスケーラーを保存</span>

<span class="sd">    Args:</span>
<span class="sd">        model_path: モデルの保存先パス</span>
<span class="sd">        scaler_X_path: 特徴量スケーラーの保存先パス</span>
<span class="sd">        scaler_y_path: 目的変数スケーラーの保存先パス</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: モデルまたはスケーラーが未訓練の場合</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model has not been trained yet.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Scalers have not been fitted yet.&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">scaler_X_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">scaler_y_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">load_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">scaler_X_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">scaler_y_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;モデルとスケーラーを読み込み</span>

<span class="sd">    Args:</span>
<span class="sd">        model_path: モデルファイルのパス</span>
<span class="sd">        scaler_X_path: 特徴量スケーラーファイルのパス</span>
<span class="sd">        scaler_y_path: 目的変数スケーラーファイルのパス</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: ファイルが存在しない場合</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="p">[</span><span class="n">model_path</span><span class="p">,</span> <span class="n">scaler_X_path</span><span class="p">,</span> <span class="n">scaler_y_path</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">scaler_X_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">scaler_y_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</code></pre></div>
<h4 id="bostonpredictor">完全な BostonPredictor 実装<a class="headerlink" href="#bostonpredictor" title="Permanent link">&para;</a></h4>
<p><strong>src/ml/boston_predictor.py</strong> (完全版):</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Boston 住宅価格予測器モジュール&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>


<span class="k">class</span><span class="w"> </span><span class="nc">BostonPredictor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ボストン市の住宅価格を予測する回帰モデル</span>

<span class="sd">    Attributes:</span>
<span class="sd">        model: 訓練済みの線形回帰モデル（未訓練時は None）</span>
<span class="sd">        scaler_X: 特徴量の標準化スケーラー（未訓練時は None）</span>
<span class="sd">        scaler_y: 目的変数の標準化スケーラー（未訓練時は None）</span>
<span class="sd">        train_mean: 訓練データの平均値（欠損値補完用）</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; predictor = BostonPredictor()</span>
<span class="sd">        &gt;&gt;&gt; df = predictor.load_data(&#39;data/Boston.csv&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # データの前処理と訓練（詳細は train_boston.py 参照）</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;初期化&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LinearRegression</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StandardScaler</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StandardScaler</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_mean</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;CSV ファイルからデータを読み込む</span>

<span class="sd">        Args:</span>
<span class="sd">            file_path: CSV ファイルのパス</span>

<span class="sd">        Returns:</span>
<span class="sd">            読み込んだ DataFrame</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: ファイルが存在しない場合</span>
<span class="sd">            ValueError: 必要な列が不足している場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># データの読み込み</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="c1"># 必要な列の存在確認</span>
        <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RM&#39;</span><span class="p">,</span> <span class="s1">&#39;LSTAT&#39;</span><span class="p">,</span> <span class="s1">&#39;PTRATIO&#39;</span><span class="p">,</span> <span class="s1">&#39;CRIME&#39;</span><span class="p">,</span> <span class="s1">&#39;PRICE&#39;</span><span class="p">]</span>
        <span class="n">missing_columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">required_columns</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing_columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing columns: </span><span class="si">{</span><span class="n">missing_columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_encode_crime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;CRIME 列をダミー変数に変換</span>

<span class="sd">        Args:</span>
<span class="sd">            df: 元の DataFrame</span>

<span class="sd">        Returns:</span>
<span class="sd">            CRIME がダミー変数化された DataFrame</span>

<span class="sd">        Note:</span>
<span class="sd">            drop_first=True により、最初のカテゴリ（アルファベット順）を</span>
<span class="sd">            基準とし、それ以外のカテゴリのダミー変数を作成</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_copy</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># CRIME をダミー変数化（drop_first=True）</span>
        <span class="n">crime_dummies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">df_copy</span><span class="p">[</span><span class="s1">&#39;CRIME&#39;</span><span class="p">],</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">df_encoded</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_copy</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;CRIME&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">crime_dummies</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_encoded</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fill_missing_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">fit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;欠損値を平均値で補完</span>

<span class="sd">        Args:</span>
<span class="sd">            df: 対象の DataFrame</span>
<span class="sd">            fit: True の場合は平均値を計算して保存、False の場合は保存済みの平均値を使用</span>

<span class="sd">        Returns:</span>
<span class="sd">            欠損値が補完された DataFrame</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: fit=False の場合で train_mean が未設定の場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fit</span><span class="p">:</span>
            <span class="c1"># 訓練データの平均値を計算して保存</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_mean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_mean</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># テストデータは訓練データの平均値で補完</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mean</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;train_mean not set. Call with fit=True first.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_mean</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_remove_outliers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;外れ値を除外</span>

<span class="sd">        Args:</span>
<span class="sd">            df: 対象の DataFrame</span>

<span class="sd">        Returns:</span>
<span class="sd">            外れ値を除外した DataFrame</span>

<span class="sd">        Note:</span>
<span class="sd">            インデックス 76 のデータポイントを外れ値として除外</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># インデックス 76 が存在する場合のみ除外</span>
        <span class="k">if</span> <span class="mi">76</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="mi">76</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">feature_engineering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;特徴量エンジニアリング（2乗項と交互作用項の追加）</span>

<span class="sd">        Args:</span>
<span class="sd">            X: 元の特徴量 DataFrame</span>

<span class="sd">        Returns:</span>
<span class="sd">            エンジニアリング後の特徴量 DataFrame</span>

<span class="sd">        Note:</span>
<span class="sd">            - 2乗項: RM2, LSTAT2, PTRATIO2</span>
<span class="sd">            - 交互作用項: RM * LSTAT</span>
<span class="sd">            合計7個の特徴量を生成</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">X_new</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># 2乗項の追加</span>
        <span class="n">X_new</span><span class="p">[</span><span class="s1">&#39;RM2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;RM&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">X_new</span><span class="p">[</span><span class="s1">&#39;LSTAT2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;LSTAT&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">X_new</span><span class="p">[</span><span class="s1">&#39;PTRATIO2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;PTRATIO&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="c1"># 交互作用項の追加</span>
        <span class="n">X_new</span><span class="p">[</span><span class="s1">&#39;RM * LSTAT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;RM&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;LSTAT&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">X_new</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">standardize_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">fit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;特徴量を標準化</span>

<span class="sd">        Args:</span>
<span class="sd">            X: 特徴量 DataFrame</span>
<span class="sd">            fit: True の場合は fit_transform、False の場合は transform のみ</span>

<span class="sd">        Returns:</span>
<span class="sd">            標準化された特徴量（numpy 配列）</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: fit=False の場合で scaler_X が未設定の場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Scaler not fitted yet. Call with fit=True first.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">standardize_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">fit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;目的変数を標準化</span>

<span class="sd">        Args:</span>
<span class="sd">            y: 目的変数 DataFrame</span>
<span class="sd">            fit: True の場合は fit_transform、False の場合は transform のみ</span>

<span class="sd">        Returns:</span>
<span class="sd">            標準化された目的変数（numpy 配列）</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: fit=False の場合で scaler_y が未設定の場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Scaler not fitted yet. Call with fit=True first.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">inverse_transform_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;予測結果を元のスケールに戻す</span>

<span class="sd">        Args:</span>
<span class="sd">            y_pred: 標準化された予測結果</span>

<span class="sd">        Returns:</span>
<span class="sd">            元のスケールに戻された予測結果</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: scaler_y が未設定の場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;scaler_y not set. Train the model first.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;モデルを訓練する</span>

<span class="sd">        Args:</span>
<span class="sd">            X_train: 訓練用特徴量（標準化済み）</span>
<span class="sd">            y_train: 訓練用目的変数（標準化済み）</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;予測を実行する</span>

<span class="sd">        Args:</span>
<span class="sd">            X_test: テスト用特徴量（標準化済み）</span>

<span class="sd">        Returns:</span>
<span class="sd">            予測結果（標準化済み）</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: モデルが訓練されていない場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model has not been trained yet. Call train() first.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;モデルを評価する</span>

<span class="sd">        Args:</span>
<span class="sd">            X_test: テスト用特徴量（標準化済み）</span>
<span class="sd">            y_test: テスト用目的変数（標準化済み）</span>

<span class="sd">        Returns:</span>
<span class="sd">            決定係数（R²）</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: モデルが訓練されていない場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model has not been trained yet. Call train() first.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">scaler_X_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">scaler_y_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;モデルとスケーラーを保存</span>

<span class="sd">        Args:</span>
<span class="sd">            model_path: モデルの保存先パス</span>
<span class="sd">            scaler_X_path: 特徴量スケーラーの保存先パス</span>
<span class="sd">            scaler_y_path: 目的変数スケーラーの保存先パス</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: モデルまたはスケーラーが未訓練の場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model has not been trained yet.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Scalers have not been fitted yet.&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">scaler_X_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">scaler_y_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">scaler_X_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">scaler_y_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;モデルとスケーラーを読み込み</span>

<span class="sd">        Args:</span>
<span class="sd">            model_path: モデルファイルのパス</span>
<span class="sd">            scaler_X_path: 特徴量スケーラーファイルのパス</span>
<span class="sd">            scaler_y_path: 目的変数スケーラーファイルのパス</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: ファイルが存在しない場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="p">[</span><span class="n">model_path</span><span class="p">,</span> <span class="n">scaler_X_path</span><span class="p">,</span> <span class="n">scaler_y_path</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">scaler_X_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">scaler_y_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</code></pre></div>
<h4 id="_59">実践的な訓練スクリプト<a class="headerlink" href="#_59" title="Permanent link">&para;</a></h4>
<p><strong>examples/train_boston.py</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Boston 住宅価格予測モデルの訓練スクリプト&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.ml.boston_predictor</span><span class="w"> </span><span class="kn">import</span> <span class="n">BostonPredictor</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;メイン処理&quot;&quot;&quot;</span>
    <span class="c1"># 予測器の作成</span>
    <span class="n">predictor</span> <span class="o">=</span> <span class="n">BostonPredictor</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;BostonPredictor を作成しました&quot;</span><span class="p">)</span>

    <span class="c1"># データの読み込み</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="s1">&#39;data/Boston.csv&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;データを読み込みました: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> サンプル&quot;</span><span class="p">)</span>

    <span class="c1"># CRIME 列のダミー変数化</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">_encode_crime</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CRIME 列をダミー変数化しました&quot;</span><span class="p">)</span>

    <span class="c1"># 訓練データとテストデータに分割</span>
    <span class="n">df_train</span><span class="p">,</span> <span class="n">df_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;訓練データ: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_train</span><span class="p">)</span><span class="si">}</span><span class="s2"> サンプル&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;テストデータ: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_test</span><span class="p">)</span><span class="si">}</span><span class="s2"> サンプル&quot;</span><span class="p">)</span>

    <span class="c1"># 訓練データの前処理</span>
    <span class="n">df_train</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">_fill_missing_values</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_train</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">_remove_outliers</span><span class="p">(</span><span class="n">df_train</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;前処理後の訓練データ: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_train</span><span class="p">)</span><span class="si">}</span><span class="s2"> サンプル&quot;</span><span class="p">)</span>

    <span class="c1"># 特徴量と目的変数の分割</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[[</span><span class="s1">&#39;RM&#39;</span><span class="p">,</span> <span class="s1">&#39;LSTAT&#39;</span><span class="p">,</span> <span class="s1">&#39;PTRATIO&#39;</span><span class="p">]]</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[[</span><span class="s1">&#39;PRICE&#39;</span><span class="p">]]</span>

    <span class="c1"># 特徴量エンジニアリング</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">feature_engineering</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;特徴量エンジニアリング完了: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2"> 個の特徴量&quot;</span><span class="p">)</span>

    <span class="c1"># 標準化</span>
    <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">standardize_features</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">y_train_scaled</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">standardize_target</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;訓練データの標準化が完了しました&quot;</span><span class="p">)</span>

    <span class="c1"># モデルの訓練</span>
    <span class="n">predictor</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train_scaled</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;モデルの訓練が完了しました&quot;</span><span class="p">)</span>

    <span class="c1"># テストデータの前処理</span>
    <span class="n">df_test</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">_fill_missing_values</span><span class="p">(</span><span class="n">df_test</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[[</span><span class="s1">&#39;RM&#39;</span><span class="p">,</span> <span class="s1">&#39;LSTAT&#39;</span><span class="p">,</span> <span class="s1">&#39;PTRATIO&#39;</span><span class="p">]]</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[[</span><span class="s1">&#39;PRICE&#39;</span><span class="p">]]</span>

    <span class="c1"># テストデータの特徴量エンジニアリング</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">feature_engineering</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="c1"># テストデータの標準化</span>
    <span class="n">X_test_scaled</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">standardize_features</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">y_test_scaled</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">standardize_target</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;テストデータの標準化が完了しました&quot;</span><span class="p">)</span>

    <span class="c1"># モデルの評価</span>
    <span class="n">r2_score</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">,</span> <span class="n">y_test_scaled</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[モデルの評価]&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  決定係数（R²）: </span><span class="si">{</span><span class="n">r2_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># モデルとスケーラーの保存</span>
    <span class="n">predictor</span><span class="o">.</span><span class="n">save_models</span><span class="p">(</span>
        <span class="s1">&#39;model/boston.pkl&#39;</span><span class="p">,</span>
        <span class="s1">&#39;model/boston_scx.pkl&#39;</span><span class="p">,</span>
        <span class="s1">&#39;model/boston_scy.pkl&#39;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">モデルとスケーラーを保存しました:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - model/boston.pkl&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - model/boston_scx.pkl&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - model/boston_scy.pkl&quot;</span><span class="p">)</span>

    <span class="c1"># 予測例</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[予測例]&quot;</span><span class="p">)</span>
    <span class="n">sample_indices</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">sample_X</span> <span class="o">=</span> <span class="n">X_test_scaled</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">sample_indices</span><span class="p">)]</span>
    <span class="n">predictions_scaled</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">sample_X</span><span class="p">)</span>

    <span class="c1"># 予測結果を元のスケールに戻す</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">inverse_transform_prediction</span><span class="p">(</span><span class="n">predictions_scaled</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample_indices</span><span class="p">):</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">y_test</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;PRICE&#39;</span><span class="p">]</span>
        <span class="n">predicted</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">error</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">actual</span> <span class="o">-</span> <span class="n">predicted</span><span class="p">)</span>
        <span class="n">error_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">error</span> <span class="o">/</span> <span class="n">actual</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">サンプル </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  RM: </span><span class="si">{</span><span class="n">df_test</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;RM&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  LSTAT: </span><span class="si">{</span><span class="n">df_test</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;LSTAT&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  PTRATIO: </span><span class="si">{</span><span class="n">df_test</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;PTRATIO&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  実際の価格: $</span><span class="si">{</span><span class="n">actual</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">k&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  予測価格: $</span><span class="si">{</span><span class="n">predicted</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">k&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  誤差: $</span><span class="si">{</span><span class="n">error</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">k (</span><span class="si">{</span><span class="n">error_rate</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<p>実行例：</p>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>run<span class="w"> </span>python<span class="w"> </span>examples/train_boston.py

<span class="c1"># 出力例：</span>
<span class="c1"># BostonPredictor を作成しました</span>
<span class="c1"># データを読み込みました: 506 サンプル</span>
<span class="c1"># CRIME 列をダミー変数化しました</span>
<span class="c1"># 訓練データ: 404 サンプル</span>
<span class="c1"># テストデータ: 102 サンプル</span>
<span class="c1"># 前処理後の訓練データ: 403 サンプル</span>
<span class="c1"># 特徴量エンジニアリング完了: 7 個の特徴量</span>
<span class="c1"># 訓練データの標準化が完了しました</span>
<span class="c1"># モデルの訓練が完了しました</span>
<span class="c1"># テストデータの標準化が完了しました</span>
<span class="c1">#</span>
<span class="c1"># [モデルの評価]</span>
<span class="c1">#   決定係数（R²）: 0.8313</span>
<span class="c1">#</span>
<span class="c1"># モデルとスケーラーを保存しました:</span>
<span class="c1">#   - model/boston.pkl</span>
<span class="c1">#   - model/boston_scx.pkl</span>
<span class="c1">#   - model/boston_scy.pkl</span>
<span class="c1">#</span>
<span class="c1"># [予測例]</span>
<span class="c1">#</span>
<span class="c1"># サンプル 1:</span>
<span class="c1">#   RM: 6.42</span>
<span class="c1">#   LSTAT: 9.32</span>
<span class="c1">#   PTRATIO: 18.70</span>
<span class="c1">#   実際の価格: $23.60k</span>
<span class="c1">#   予測価格: $24.15k</span>
<span class="c1">#   誤差: $0.55k (2.3%)</span>
<span class="c1">#</span>
<span class="c1"># サンプル 2:</span>
<span class="c1">#   RM: 6.00</span>
<span class="c1">#   LSTAT: 12.43</span>
<span class="c1">#   PTRATIO: 15.20</span>
<span class="c1">#   実際の価格: $20.10k</span>
<span class="c1">#   予測価格: $19.87k</span>
<span class="c1">#   誤差: $0.23k (1.1%)</span>
<span class="c1">#</span>
<span class="c1"># サンプル 3:</span>
<span class="c1">#   RM: 7.18</span>
<span class="c1">#   LSTAT: 4.03</span>
<span class="c1">#   PTRATIO: 17.40</span>
<span class="c1">#   実際の価格: $35.40k</span>
<span class="c1">#   予測価格: $34.92k</span>
<span class="c1">#   誤差: $0.48k (1.4%)</span>
</code></pre></div>
<hr />
<h3 id="7_1">📊 ７章の技術的成果<a class="headerlink" href="#7_1" title="Permanent link">&para;</a></h3>
<p>「高度な回帰問題もマスターしました！」お疲れさまでした！７章で何を達成したか、振り返ってみましょう。</p>
<h4 id="_60">✅ 完成した機能<a class="headerlink" href="#_60" title="Permanent link">&para;</a></h4>
<p>７章では、以下の機能を実装しました：</p>
<ul>
<li>✅ <strong>Boston 予測器クラスの完全実装</strong> - 住宅価格を予測するモデル</li>
<li>✅ <strong>CRIME 列のダミー変数化</strong> - カテゴリカル変数の処理</li>
<li>✅ <strong>データリーケージ防止の前処理パイプライン</strong> - 正しい前処理手順</li>
<li>✅ <strong>特徴量エンジニアリング</strong> - 2 乗項 + 交互作用項で表現力向上</li>
<li>✅ <strong>StandardScaler による標準化</strong> - データの正規化</li>
<li>✅ <strong>複数モデルの一括管理</strong> - model + 2 つの scaler</li>
<li>✅ <strong>逆標準化による予測結果の復元</strong> - 元のスケールに戻す</li>
</ul>
<h4 id="_61">📈 定量的成果<a class="headerlink" href="#_61" title="Permanent link">&para;</a></h4>
<p>数字で見ると、こんなに達成しました！</p>
<table>
<thead>
<tr>
<th>指標</th>
<th>🎯 実績</th>
</tr>
</thead>
<tbody>
<tr>
<td>🧪 <strong>テストケース</strong></td>
<td>25 個</td>
</tr>
<tr>
<td>📊 <strong>コードカバレッジ</strong></td>
<td>94%（boston_predictor.py）</td>
</tr>
<tr>
<td>🔤 <strong>型ヒント使用率</strong></td>
<td>100%</td>
</tr>
<tr>
<td>🏠 <strong>モデル決定係数（R²）</strong></td>
<td><strong>0.8313</strong>（テストデータ）</td>
</tr>
<tr>
<td>⚙️ <strong>特徴量数</strong></td>
<td>3 個 → <strong>7 個</strong>（エンジニアリング後）</td>
</tr>
<tr>
<td>💾 <strong>保存モデル数</strong></td>
<td>3 個（model、scaler_X、scaler_y）</td>
</tr>
<tr>
<td>✨ <strong>Ruff チェック</strong></td>
<td>全て通過</td>
</tr>
<tr>
<td>✅ <strong>mypy チェック</strong></td>
<td>エラー 0 件</td>
</tr>
<tr>
<td>🔧 <strong>循環的複雑度</strong></td>
<td>最大 4（全関数）</td>
</tr>
</tbody>
</table>
<p><strong>特徴量が 3 個から 7 個に！</strong> 特徴量エンジニアリングでモデルの表現力が大幅に向上しました！🎉</p>
<h4 id="_62">🎓 習得したスキル<a class="headerlink" href="#_62" title="Permanent link">&para;</a></h4>
<h5 id="1-tdd_3">1. 🔄 TDD スキル（最上級）<a class="headerlink" href="#1-tdd_3" title="Permanent link">&para;</a></h5>
<ul>
<li>✅ 標準化処理のテスト駆動実装</li>
<li>fit と transform の分離テスト</li>
<li>複数モデルの永続化テスト</li>
</ul>
<p><strong>2. 特徴量エンジニアリングスキル</strong>
- 2乗項による非線形性の表現
- 交互作用項による特徴量間の関係表現
- 特徴量数の最適化</p>
<p><strong>3. データ標準化スキル</strong>
- StandardScaler の使い方
- 訓練データとテストデータの分離
- 逆標準化による予測結果の復元</p>
<p><strong>4. 高度なデータ処理スキル</strong>
- データリーケージの防止
- 訓練データの統計量によるテストデータ処理
- 複数ステップの前処理パイプライン</p>
<p><strong>5. モデル管理スキル</strong>
- 複数モデルの一括保存と読み込み
- スケーラーの永続化
- 訓練時の統計量の保存</p>
<h5 id="_63">特徴量エンジニアリングの理解<a class="headerlink" href="#_63" title="Permanent link">&para;</a></h5>
<p><strong>なぜ特徴量エンジニアリングが必要か</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 元の線形モデル:</span>
<span class="c1"># PRICE = β₀ + β₁×RM + β₂×LSTAT + β₃×PTRATIO</span>

<span class="c1"># 問題: 線形関係しか表現できない</span>
<span class="c1"># → 実際の住宅価格は非線形な関係を持つ</span>

<span class="c1"># 特徴量エンジニアリング後:</span>
<span class="c1"># PRICE = β₀ + β₁×RM + β₂×RM² + β₃×LSTAT + β₄×LSTAT² +</span>
<span class="c1">#         β₅×PTRATIO + β₆×PTRATIO² + β₇×(RM × LSTAT)</span>

<span class="c1"># 利点:</span>
<span class="c1"># - RM² により「部屋数が多いほど価格が急上昇」を表現</span>
<span class="c1"># - RM × LSTAT により「部屋数と低所得者割合の相互作用」を表現</span>
<span class="c1"># → より複雑な関係を線形モデルで表現可能</span>
</code></pre></div>
<p><strong>2乗項の効果</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 例: RM（部屋数）と価格の関係</span>

<span class="c1"># 線形項のみ: PRICE = 10×RM</span>
<span class="c1"># RM=5: PRICE = 50</span>
<span class="c1"># RM=6: PRICE = 60 (+10)</span>
<span class="c1"># RM=7: PRICE = 70 (+10)</span>
<span class="c1"># → 部屋数が1増えると一定額（10k）増加</span>

<span class="c1"># 2乗項追加: PRICE = 10×RM + 2×RM²</span>
<span class="c1"># RM=5: PRICE = 50 + 50 = 100</span>
<span class="c1"># RM=6: PRICE = 60 + 72 = 132 (+32)</span>
<span class="c1"># RM=7: PRICE = 70 + 98 = 168 (+36)</span>
<span class="c1"># → 部屋数が多いほど価格の上昇幅が大きい（現実的）</span>
</code></pre></div>
<p><strong>交互作用項の効果</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># RM（部屋数）と LSTAT（低所得者割合）の交互作用</span>

<span class="c1"># 交互作用項なし:</span>
<span class="c1"># → RM と LSTAT が独立に価格に影響</span>

<span class="c1"># 交互作用項あり: RM × LSTAT</span>
<span class="c1"># → 「高級住宅地（LSTAT低）では部屋数の影響が大きい」</span>
<span class="c1"># → 「低所得地区（LSTAT高）では部屋数の影響が小さい」</span>
<span class="c1"># → より現実的な関係を表現</span>
</code></pre></div>
<h5 id="_64">データ標準化の理解<a class="headerlink" href="#_64" title="Permanent link">&para;</a></h5>
<p><strong>なぜ標準化が必要か</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 標準化前の特徴量:</span>
<span class="c1"># RM: 3〜9（範囲: 6）</span>
<span class="c1"># LSTAT: 1〜40（範囲: 39）</span>
<span class="c1"># PTRATIO: 12〜22（範囲: 10）</span>

<span class="c1"># 問題:</span>
<span class="c1"># 1. 学習が不安定になる（勾配降下法が収束しにくい）</span>
<span class="c1"># 2. LSTAT の影響が過大評価される（スケールが大きいため）</span>
<span class="c1"># 3. 係数の解釈が困難（単位が異なる）</span>

<span class="c1"># 標準化後:</span>
<span class="c1"># すべての特徴量が平均0、標準偏差1</span>
<span class="c1"># → 公平な比較が可能</span>
<span class="c1"># → 学習が安定</span>
</code></pre></div>
<p><strong>標準化の数式</strong>:</p>
<div class="highlight"><pre><span></span><code>z = (x - μ) / σ

where:
  z: 標準化後の値
  x: 元の値
  μ: 平均値
  σ: 標準偏差

例:
RM の平均が6.0、標準偏差が1.0の場合
RM = 7.0 → z = (7.0 - 6.0) / 1.0 = 1.0
RM = 5.0 → z = (5.0 - 6.0) / 1.0 = -1.0
</code></pre></div>
<p><strong>目的変数の標準化</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 目的変数（PRICE）も標準化する理由:</span>

<span class="c1"># 1. 学習の安定性向上</span>
<span class="c1">#    → 特徴量と目的変数のスケールが近い方が学習しやすい</span>

<span class="c1"># 2. 数値計算の精度向上</span>
<span class="c1">#    → オーバーフローやアンダーフローを防ぐ</span>

<span class="c1"># 3. 逆標準化で元のスケールに戻す</span>
<span class="c1">#    → 予測結果は元の単位（$1000）で解釈</span>
</code></pre></div>
<h5 id="_65">データリーケージ防止の理解<a class="headerlink" href="#_65" title="Permanent link">&para;</a></h5>
<p><strong>データリーケージとは</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ❌ 悪い例（データリーケージあり）</span>

<span class="c1"># 1. 全データで欠損値補完</span>
<span class="n">df_all</span> <span class="o">=</span> <span class="n">df_all</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df_all</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>  <span class="c1"># 全データの平均を使用</span>

<span class="c1"># 2. データ分割</span>
<span class="n">df_train</span><span class="p">,</span> <span class="n">df_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">df_all</span><span class="p">)</span>

<span class="c1"># 問題: テストデータの情報（平均値の計算）が訓練に漏れている</span>
<span class="c1"># → テストデータの性能が過大評価される</span>

<span class="c1"># ✅ 良い例（データリーケージなし）</span>

<span class="c1"># 1. データ分割</span>
<span class="n">df_train</span><span class="p">,</span> <span class="n">df_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="c1"># 2. 訓練データで統計量を計算</span>
<span class="n">train_mean</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># 3. 訓練データとテストデータを別々に補完</span>
<span class="n">df_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">train_mean</span><span class="p">)</span>  <span class="c1"># 訓練データの平均を使用</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">train_mean</span><span class="p">)</span>    <span class="c1"># 訓練データの平均を使用（重要）</span>

<span class="c1"># 利点: テストデータの情報は一切使わない</span>
<span class="c1"># → 本番環境での性能を正確に評価できる</span>
</code></pre></div>
<p><strong>標準化でのデータリーケージ防止</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ❌ 悪い例</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">X_all_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_all</span><span class="p">)</span>  <span class="c1"># 全データで fit</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X_all_scaled</span><span class="p">)</span>

<span class="c1"># ✅ 良い例</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>  <span class="c1"># 訓練データで fit</span>
<span class="n">X_test_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>        <span class="c1"># テストデータは transform のみ</span>

<span class="c1"># 重要: テストデータは訓練データの平均・標準偏差で変換</span>
<span class="c1"># → 本番環境を正確にシミュレート</span>
</code></pre></div>
<h5 id="cinema-vs-boston">回帰モデルの比較（Cinema vs Boston）<a class="headerlink" href="#cinema-vs-boston" title="Permanent link">&para;</a></h5>
<table>
<thead>
<tr>
<th>項目</th>
<th>Cinema（基礎）</th>
<th><strong>Boston（高度）</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>モデル</strong></td>
<td>LinearRegression</td>
<td>LinearRegression</td>
</tr>
<tr>
<td><strong>特徴量数</strong></td>
<td>4個</td>
<td><strong>7個（3個→エンジニアリング）</strong></td>
</tr>
<tr>
<td><strong>前処理</strong></td>
<td>欠損値補完 + 外れ値除外</td>
<td><strong>欠損値補完 + 外れ値除外 + ダミー変数化</strong></td>
</tr>
<tr>
<td><strong>特徴量エンジニアリング</strong></td>
<td>なし</td>
<td><strong>2乗項 + 交互作用項</strong></td>
</tr>
<tr>
<td><strong>標準化</strong></td>
<td>なし</td>
<td><strong>StandardScaler（特徴量 + 目的変数）</strong></td>
</tr>
<tr>
<td><strong>データリーケージ防止</strong></td>
<td>部分的</td>
<td><strong>完全</strong></td>
</tr>
<tr>
<td><strong>保存モデル数</strong></td>
<td>1個</td>
<td><strong>3個（model + 2 scalers）</strong></td>
</tr>
<tr>
<td><strong>決定係数</strong></td>
<td>0.8383</td>
<td><strong>0.8313</strong></td>
</tr>
<tr>
<td><strong>テスト数</strong></td>
<td>20個</td>
<td><strong>25個</strong></td>
</tr>
</tbody>
</table>
<p><strong>決定係数が若干低い理由</strong>:</p>
<ul>
<li>Cinema: シンプルなデータセット、明確な特徴量（SNS指標）</li>
<li>Boston: 複雑な社会経済要因、多様な外部変数の影響</li>
</ul>
<h4 id="_66">🚀 次の章への準備<a class="headerlink" href="#_66" title="Permanent link">&para;</a></h4>
<p>７章では、高度な回帰問題に取り組みました！次の８章では、いよいよ最終章です：</p>
<ul>
<li>🌐 <strong>FastAPI による API 化</strong> - モデルを Web API として公開</li>
<li>🏗️ <strong>レイヤードアーキテクチャの実装</strong> - Application / Service / Domain の 3 層構造</li>
<li>🤖 <strong>4 つのモデルの統合エンドポイント</strong> - すべてのモデルを 1 つの API に</li>
<li>✅ <strong>Pydantic による入力検証</strong> - 型安全なデータ検証</li>
<li>📚 <strong>Swagger UI による自動ドキュメント生成</strong> - API ドキュメントが自動で完成</li>
</ul>
<p>いよいよ最終章！これまで作ったモデルを、実際に使える Web API にします！ワクワクしますね！🎉</p>
<hr />
<hr />
<h2 id="8-api-fastapi">８章 機械学習 API の構築（FastAPI で本番デプロイ）<a class="headerlink" href="#8-api-fastapi" title="Permanent link">&para;</a></h2>
<p>「モデルができたけど、どうやって使ってもらうの？」良い質問です！この章では、作った機械学習モデルを <strong>Web API</strong> として公開します！</p>
<p>FastAPI を使って、誰でも簡単に使える API を作ります。いよいよ最終章です！🚀</p>
<h3 id="_67">🎯 この章の学習目標<a class="headerlink" href="#_67" title="Permanent link">&para;</a></h3>
<p>これまで作ってきた 4 つの機械学習モデル（Iris 分類、Cinema 回帰、Survived 分類、Boston 回帰）を、<strong>実際に使える Web API</strong> として公開します！</p>
<p>この章では、以下のスキルを習得します：</p>
<ul>
<li>🌐 <strong>FastAPI による Web API 開発</strong> - モダンな Python Web フレームワーク</li>
<li>✅ <strong>Pydantic によるデータ検証</strong> - リクエストデータの型安全性確保</li>
<li>🏗️ <strong>レイヤードアーキテクチャの実践</strong> - Application/Service/Domain の 3 層構造</li>
<li>📚 <strong>OpenAPI 仕様の自動生成</strong> - Swagger UI で自動的にドキュメント作成</li>
<li>💾 <strong>機械学習モデルの本番運用</strong> - pickle でモデルを保存・読み込み</li>
</ul>
<h3 id="api">💡 なぜ API 化が重要なのか？<a class="headerlink" href="#api" title="Permanent link">&para;</a></h3>
<p>「モデルができたら終わりじゃないの？」いいえ！実は、モデルを<strong>実際に使える形にする</strong>ことが最も重要です。</p>
<p>API 化すると、こんなことができます：</p>
<ol>
<li>🌍 <strong>アクセス可能性</strong> - Web API として公開し、世界中から利用可能に</li>
<li>✅ <strong>データ検証</strong> - 不正な入力を受け付けないバリデーション</li>
<li>📖 <strong>ドキュメント</strong> - 利用方法を明確に示す自動生成ドキュメント</li>
<li>🔧 <strong>保守性</strong> - レイヤー分離で変更が簡単に</li>
</ol>
<p>「難しそう...」と思いましたか？FastAPI なら、驚くほど簡単に API が作れますよ！</p>
<h3 id="fastapi">FastAPI プロジェクト構造<a class="headerlink" href="#fastapi" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>ml-api-project/
├── app/
│   ├── __init__.py
│   ├── application.py      # アプリケーション層（エンドポイント定義）
│   ├── service.py          # サービス層（ビジネスロジック）
│   ├── domain.py           # ドメイン層（モデル処理）
│   └── models.py           # Pydantic モデル定義
├── test/
│   ├── __init__.py
│   ├── test_application.py # API エンドポイントのテスト
│   ├── test_service.py     # サービス層のテスト
│   └── test_domain.py      # ドメイン層のテスト
├── model/
│   ├── iris.pkl            # 訓練済み Iris モデル
│   ├── cinema.pkl          # 訓練済み Cinema モデル
│   ├── survived.pkl        # 訓練済み Survived モデル
│   └── boston.pkl          # 訓練済み Boston モデル
└── pyproject.toml
</code></pre></div>
<h3 id="_68">レイヤードアーキテクチャの概念<a class="headerlink" href="#_68" title="Permanent link">&para;</a></h3>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjM1NnB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6MTMwM3B4O2hlaWdodDozNTZweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAxMzAzIDM1NiIgd2lkdGg9IjEzMDNweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjwhLS1jbHVzdGVyIEFwcC0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0iQXBwIiBkYXRhLXNvdXJjZS1saW5lPSI1IiBkYXRhLXVpZD0iZW50MDAwMyIgaWQ9ImNsdXN0ZXJfQXBwIj48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjE2MCIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9Ijg0Mi42IiB4PSI3IiB5PSI3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE1NC41MTI3IiB4PSIzNTEuMDQzNyIgeT0iMjEuOTk1MSI+RmFzdEFQSSBBcHBsaWNhdGlvbjwvdGV4dD48L2c+PCEtLWNsdXN0ZXIgTUwtLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9Ik1MIiBkYXRhLXNvdXJjZS1saW5lPSIxMSIgZGF0YS11aWQ9ImVudDAwMDciIGlkPSJjbHVzdGVyX01MIj48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjIxMiIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjMyMi45NCIgeD0iOTc0LjU1IiB5PSIxMTYiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjAxLjM3MyIgeD0iMTAzNS4zMzM1IiB5PSIxMzAuOTk1MSI+TWFjaGluZSBMZWFybmluZyBNb2RlbHM8L3RleHQ+PC9nPjwhLS1lbnRpdHkgTWFpbi0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJNYWluIiBkYXRhLXNvdXJjZS1saW5lPSI2IiBkYXRhLXVpZD0iZW50MDAwNCIgaWQ9ImVudGl0eV9NYWluIj48cmVjdCBmaWxsPSIjQUREOEU2IiBoZWlnaHQ9IjYyLjU5MzgiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE5MC45MjMyIiB4PSIyMyIgeT0iODguNyIvPjxyZWN0IGZpbGw9IiNBREQ4RTYiIGhlaWdodD0iMTAiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE1IiB4PSIxOTMuOTIzMiIgeT0iOTMuNyIvPjxyZWN0IGZpbGw9IiNBREQ4RTYiIGhlaWdodD0iMiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNCIgeD0iMTkxLjkyMzIiIHk9Ijk1LjciLz48cmVjdCBmaWxsPSIjQUREOEU2IiBoZWlnaHQ9IjIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjQiIHg9IjE5MS45MjMyIiB5PSI5OS43Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTguODQ3NyIgeD0iMzgiIHk9IjEyMS42OTUxIj5hcHBsaWNhdGlvbi5weTwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNTAuOTIzMiIgeD0iMzgiIHk9IjEzNy45OTIiPigmIzEyNTAzOyYjMTI1MjQ7JiMxMjQ3NjsmIzEyNTMxOyYjMTI0ODY7JiMxMjU0MDsmIzEyNDcxOyYjMTI1MTk7JiMxMjUzMTsmIzIzNjUyOyk8L3RleHQ+PC9nPjwhLS1lbnRpdHkgU2VydmljZS0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJTZXJ2aWNlIiBkYXRhLXNvdXJjZS1saW5lPSI3IiBkYXRhLXVpZD0iZW50MDAwNSIgaWQ9ImVudGl0eV9TZXJ2aWNlIj48cmVjdCBmaWxsPSIjOTBFRTkwIiBoZWlnaHQ9IjYyLjU5MzgiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjEyMC45MjM1IiB4PSI0MTIuMzYiIHk9Ijg0LjciLz48cmVjdCBmaWxsPSIjOTBFRTkwIiBoZWlnaHQ9IjEwIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNSIgeD0iNTEzLjI4MzUiIHk9Ijg5LjciLz48cmVjdCBmaWxsPSIjOTBFRTkwIiBoZWlnaHQ9IjIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjQiIHg9IjUxMS4yODM1IiB5PSI5MS43Ii8+PHJlY3QgZmlsbD0iIzkwRUU5MCIgaGVpZ2h0PSIyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI0IiB4PSI1MTEuMjgzNSIgeT0iOTUuNyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjcxLjc3MDUiIHg9IjQyNy4zNiIgeT0iMTE3LjY5NTEiPnNlcnZpY2UucHk8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODAuOTIzNSIgeD0iNDI3LjM2IiB5PSIxMzMuOTkyIj4oJiMxMjQ2OTsmIzEyNTQwOyYjMTI0OTk7JiMxMjQ3MzsmIzIzNjUyOyk8L3RleHQ+PC9nPjwhLS1lbnRpdHkgRG9tYWluLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkRvbWFpbiIgZGF0YS1zb3VyY2UtbGluZT0iOCIgZGF0YS11aWQ9ImVudDAwMDYiIGlkPSJlbnRpdHlfRG9tYWluIj48cmVjdCBmaWxsPSIjRkZGRkUwIiBoZWlnaHQ9IjYyLjU5MzgiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjEyMC45MjM1IiB4PSI3MTIuNjgiIHk9IjYzLjciLz48cmVjdCBmaWxsPSIjRkZGRkUwIiBoZWlnaHQ9IjEwIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNSIgeD0iODEzLjYwMzUiIHk9IjY4LjciLz48cmVjdCBmaWxsPSIjRkZGRkUwIiBoZWlnaHQ9IjIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjQiIHg9IjgxMS42MDM1IiB5PSI3MC43Ii8+PHJlY3QgZmlsbD0iI0ZGRkZFMCIgaGVpZ2h0PSIyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI0IiB4PSI4MTEuNjAzNSIgeT0iNzQuNyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc0LjA1MzciIHg9IjcyNy42OCIgeT0iOTYuNjk1MSI+ZG9tYWluLnB5PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgwLjkyMzUiIHg9IjcyNy42OCIgeT0iMTEyLjk5MiI+KCYjMTI0ODk7JiMxMjUxMzsmIzEyNDUyOyYjMTI1MzE7JiMyMzY1MjspPC90ZXh0PjwvZz48IS0tZW50aXR5IGlyaXMucGtsLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9ImlyaXMucGtsIiBkYXRhLXNvdXJjZS1saW5lPSIxMiIgZGF0YS11aWQ9ImVudDAwMDgiIGlkPSJlbnRpdHlfaXJpcy5wa2wiPjxwYXRoIGQ9Ik0xMDEzLjc4LDI2OC4zNSBDMTAxMy43OCwyNTguMzUgMTA0Ni44NjE1LDI1OC4zNSAxMDQ2Ljg2MTUsMjU4LjM1IEMxMDQ2Ljg2MTUsMjU4LjM1IDEwNzkuOTQzMSwyNTguMzUgMTA3OS45NDMxLDI2OC4zNSBMMTA3OS45NDMxLDI5My42NDY5IEMxMDc5Ljk0MzEsMzAzLjY0NjkgMTA0Ni44NjE1LDMwMy42NDY5IDEwNDYuODYxNSwzMDMuNjQ2OSBDMTA0Ni44NjE1LDMwMy42NDY5IDEwMTMuNzgsMzAzLjY0NjkgMTAxMy43OCwyOTMuNjQ2OSBMMTAxMy43OCwyNjguMzUiIGZpbGw9IiNGMUYxRjEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik0xMDEzLjc4LDI2OC4zNSBDMTAxMy43OCwyNzguMzUgMTA0Ni44NjE1LDI3OC4zNSAxMDQ2Ljg2MTUsMjc4LjM1IEMxMDQ2Ljg2MTUsMjc4LjM1IDEwNzkuOTQzMSwyNzguMzUgMTA3OS45NDMxLDI2OC4zNSIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDYuMTYzMSIgeD0iMTAyMy43OCIgeT0iMjk1LjM0NTEiPmlyaXMucGtsPC90ZXh0PjwvZz48IS0tZW50aXR5IGNpbmVtYS5wa2wtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iY2luZW1hLnBrbCIgZGF0YS1zb3VyY2UtbGluZT0iMTMiIGRhdGEtdWlkPSJlbnQwMDA5IiBpZD0iZW50aXR5X2NpbmVtYS5wa2wiPjxwYXRoIGQ9Ik05OTguNTUsMTg4LjM1IEM5OTguNTUsMTc4LjM1IDEwNDYuODYyLDE3OC4zNSAxMDQ2Ljg2MiwxNzguMzUgQzEwNDYuODYyLDE3OC4zNSAxMDk1LjE3NCwxNzguMzUgMTA5NS4xNzQsMTg4LjM1IEwxMDk1LjE3NCwyMTMuNjQ2OSBDMTA5NS4xNzQsMjIzLjY0NjkgMTA0Ni44NjIsMjIzLjY0NjkgMTA0Ni44NjIsMjIzLjY0NjkgQzEwNDYuODYyLDIyMy42NDY5IDk5OC41NSwyMjMuNjQ2OSA5OTguNTUsMjEzLjY0NjkgTDk5OC41NSwxODguMzUiIGZpbGw9IiNGMUYxRjEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik05OTguNTUsMTg4LjM1IEM5OTguNTUsMTk4LjM1IDEwNDYuODYyLDE5OC4zNSAxMDQ2Ljg2MiwxOTguMzUgQzEwNDYuODYyLDE5OC4zNSAxMDk1LjE3NCwxOTguMzUgMTA5NS4xNzQsMTg4LjM1IiBmaWxsPSJub25lIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI3Ni42MjQiIHg9IjEwMDguNTUiIHk9IjIxNS4zNDUxIj5jaW5lbWEucGtsPC90ZXh0PjwvZz48IS0tZW50aXR5IHN1cnZpdmVkLnBrbC0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJzdXJ2aXZlZC5wa2wiIGRhdGEtc291cmNlLWxpbmU9IjE0IiBkYXRhLXVpZD0iZW50MDAxMCIgaWQ9ImVudGl0eV9zdXJ2aXZlZC5wa2wiPjxwYXRoIGQ9Ik0xMTY4LjI3LDI2OC4zNSBDMTE2OC4yNywyNTguMzUgMTIyMC44Nzg0LDI1OC4zNSAxMjIwLjg3ODQsMjU4LjM1IEMxMjIwLjg3ODQsMjU4LjM1IDEyNzMuNDg2OCwyNTguMzUgMTI3My40ODY4LDI2OC4zNSBMMTI3My40ODY4LDI5My42NDY5IEMxMjczLjQ4NjgsMzAzLjY0NjkgMTIyMC44Nzg0LDMwMy42NDY5IDEyMjAuODc4NCwzMDMuNjQ2OSBDMTIyMC44Nzg0LDMwMy42NDY5IDExNjguMjcsMzAzLjY0NjkgMTE2OC4yNywyOTMuNjQ2OSBMMTE2OC4yNywyNjguMzUiIGZpbGw9IiNGMUYxRjEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik0xMTY4LjI3LDI2OC4zNSBDMTE2OC4yNywyNzguMzUgMTIyMC44Nzg0LDI3OC4zNSAxMjIwLjg3ODQsMjc4LjM1IEMxMjIwLjg3ODQsMjc4LjM1IDEyNzMuNDg2OCwyNzguMzUgMTI3My40ODY4LDI2OC4zNSIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODUuMjE2OCIgeD0iMTE3OC4yNyIgeT0iMjk1LjM0NTEiPnN1cnZpdmVkLnBrbDwvdGV4dD48L2c+PCEtLWVudGl0eSBib3N0b24ucGtsLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9ImJvc3Rvbi5wa2wiIGRhdGEtc291cmNlLWxpbmU9IjE1IiBkYXRhLXVpZD0iZW50MDAxMSIgaWQ9ImVudGl0eV9ib3N0b24ucGtsIj48cGF0aCBkPSJNMTE3NC4zOCwxODguMzUgQzExNzQuMzgsMTc4LjM1IDEyMjAuODgzOSwxNzguMzUgMTIyMC44ODM5LDE3OC4zNSBDMTIyMC44ODM5LDE3OC4zNSAxMjY3LjM4NzgsMTc4LjM1IDEyNjcuMzg3OCwxODguMzUgTDEyNjcuMzg3OCwyMTMuNjQ2OSBDMTI2Ny4zODc4LDIyMy42NDY5IDEyMjAuODgzOSwyMjMuNjQ2OSAxMjIwLjg4MzksMjIzLjY0NjkgQzEyMjAuODgzOSwyMjMuNjQ2OSAxMTc0LjM4LDIyMy42NDY5IDExNzQuMzgsMjEzLjY0NjkgTDExNzQuMzgsMTg4LjM1IiBmaWxsPSIjRjFGMUYxIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNMTE3NC4zOCwxODguMzUgQzExNzQuMzgsMTk4LjM1IDEyMjAuODgzOSwxOTguMzUgMTIyMC44ODM5LDE5OC4zNSBDMTIyMC44ODM5LDE5OC4zNSAxMjY3LjM4NzgsMTk4LjM1IDEyNjcuMzg3OCwxODguMzUiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjczLjAwNzgiIHg9IjExODQuMzgiIHk9IjIxNS4zNDUxIj5ib3N0b24ucGtsPC90ZXh0PjwvZz48IS0tZW50aXR5IENsaWVudC0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJDbGllbnQiIGRhdGEtc291cmNlLWxpbmU9IjMiIGRhdGEtdWlkPSJlbnQwMDAyIiBpZD0iZW50aXR5X0NsaWVudCI+PGVsbGlwc2UgY3g9IjQ3Mi44MTk4IiBjeT0iMTkxLjM1IiBmaWxsPSIjRjFGMUYxIiByeD0iOCIgcnk9IjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik00NzIuODE5OCwxOTkuMzUgTDQ3Mi44MTk4LDIyNi4zNSBNNDU5LjgxOTgsMjA3LjM1IEw0ODUuODE5OCwyMDcuMzUgTTQ3Mi44MTk4LDIyNi4zNSBMNDU5LjgxOTgsMjQxLjM1IE00NzIuODE5OCwyMjYuMzUgTDQ4NS44MTk4LDI0MS4zNSIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODMuOTk5NiIgeD0iNDMwLjgyIiB5PSIyNTUuODQ1MSI+JiMxMjQ2MzsmIzEyNTIxOyYjMTI0NTI7JiMxMjQ1MDsmIzEyNTMxOyYjMTI0ODg7PC90ZXh0PjwvZz48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iR01OMjAiIGRhdGEtc291cmNlLWxpbmU9IjI4IiBkYXRhLXVpZD0iZW50MDAyMSIgaWQ9ImVudGl0eV9HTU4yMCI+PHBhdGggZD0iTTM3NS45MiwyOTQuMyBMMzc1LjkyLDM0OS42OTg0IEw1NjkuNzIyNCwzNDkuNjk4NCBMNTY5LjcyMjQsMzA0LjMgTDU1OS43MjI0LDI5NC4zIEwzNzUuOTIsMjk0LjMiIGZpbGw9IiNGRUZGREQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik01NTkuNzIyNCwyOTQuMyBMNTU5LjcyMjQsMzA0LjMgTDU2OS43MjI0LDMwNC4zIEw1NTkuNzIyNCwyOTQuMyIgZmlsbD0iI0ZFRkZERCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyNS44MjM0IiB4PSIzODEuOTIiIHk9IjMxMS4zNjY5Ij4tICYjMTI0NTY7JiMxMjUzMTsmIzEyNDg5OyYjMTI1MDk7JiMxMjQ1MjsmIzEyNTMxOyYjMTI0ODg7JiMyMzQ1MDsmIzMyNjgxOzwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNjkuMjAzMyIgeD0iMzgxLjkyIiB5PSIzMjYuNDk5NyI+LSAmIzEyNTIyOyYjMTI0NjM7JiMxMjQ1NjsmIzEyNDczOyYjMTI0ODg7LyYjMTI1MjQ7JiMxMjQ3MzsmIzEyNTA5OyYjMTI1MzE7JiMxMjQ3MzsmIzIwOTY2OyYjMjk3MDI7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE3Mi44MDI0IiB4PSIzODEuOTIiIHk9IjM0MS42MzI1Ij4tIFB5ZGFudGljICYjMTI1MTQ7JiMxMjQ4NzsmIzEyNTIzOyYjMTIzOTU7JiMxMjQyNDsmIzEyNDI3OyYjMjY5MDg7JiMzNTM4ODs8L3RleHQ+PC9nPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJHTU4yMyIgZGF0YS1zb3VyY2UtbGluZT0iMzQiIGRhdGEtdWlkPSJlbnQwMDI0IiBpZD0iZW50aXR5X0dNTjIzIj48cGF0aCBkPSJNNjk5LjczLDE4My4zIEw2OTkuNzMsMTgzLjg0IEw1MzMuNDgsMTM1IEw2OTkuNzMsMTkxLjg0IEw2OTkuNzMsMjM4LjY5ODQgQTAsMCAwIDAgMCA2OTkuNzMsMjM4LjY5ODQgTDg0Ni41NTM0LDIzOC42OTg0IEEwLDAgMCAwIDAgODQ2LjU1MzQsMjM4LjY5ODQgTDg0Ni41NTM0LDE5My4zIEw4MzYuNTUzNCwxODMuMyBMNjk5LjczLDE4My4zIEEwLDAgMCAwIDAgNjk5LjczLDE4My4zIiBmaWxsPSIjRkVGRkREIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNODM2LjU1MzQsMTgzLjMgTDgzNi41NTM0LDE5My4zIEw4NDYuNTUzNCwxOTMuMyBMODM2LjU1MzQsMTgzLjMiIGZpbGw9IiNGRUZGREQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMi44MjM0IiB4PSI3MDUuNzMiIHk9IjIwMC4zNjY5Ij4tICYjMTI0OTk7JiMxMjQ3MjsmIzEyNDkzOyYjMTI0NzM7JiMxMjUyNTsmIzEyNDcyOyYjMTI0ODM7JiMxMjQ2Mzs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNzMuODIzMyIgeD0iNzA1LjczIiB5PSIyMTUuNDk5NyI+LSAmIzEyNDg3OyYjMTI1NDA7JiMxMjQ3OTsmIzIyNzkzOyYjMjU1NjM7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyNS44MjM0IiB4PSI3MDUuNzMiIHk9IjIzMC42MzI1Ij4tICYjMTI0NTY7JiMxMjUyMTsmIzEyNTQwOyYjMTI0OTU7JiMxMjUzMTsmIzEyNDg5OyYjMTI1MjI7JiMxMjUzMTsmIzEyNDY0OzwvdGV4dD48L2c+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkdNTjI2IiBkYXRhLXNvdXJjZS1saW5lPSI0MCIgZGF0YS11aWQ9ImVudDAwMjciIGlkPSJlbnRpdHlfR01OMjYiPjxwYXRoIGQ9Ik05ODYuNDUsMjcuMyBMOTg2LjQ1LDgyLjY5ODQgTDExMDcuMjczMyw4Mi42OTg0IEwxMTA3LjI3MzMsMzcuMyBMMTA5Ny4yNzMzLDI3LjMgTDk4Ni40NSwyNy4zIiBmaWxsPSIjRkVGRkREIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNMTA5Ny4yNzMzLDI3LjMgTDEwOTcuMjczMywzNy4zIEwxMTA3LjI3MzMsMzcuMyBMMTA5Ny4yNzMzLDI3LjMiIGZpbGw9IiNGRUZGREQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5OS44MjMzIiB4PSI5OTIuNDUiIHk9IjQ0LjM2NjkiPi0gJiMxMjUxNDsmIzEyNDg3OyYjMTI1MjM7JiMzNTUwMTsmIzEyNDE1OyYjMzY3OTY7JiMxMjQxNTs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjAuODIzMyIgeD0iOTkyLjQ1IiB5PSI1OS40OTk3Ij4tICYjMjAxMDQ7JiMyODIwNDsmIzIzNDU1OyYjMzQ4OTI7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk5LjgyMzMiIHg9Ijk5Mi40NSIgeT0iNzQuNjMyNSI+LSAmIzIxMDY5OyYjMjA5NjY7JiMyOTcwMjsmIzEyNTM5OyYjMjQ0NjA7JiMyMDk2NjsmIzI5NzAyOzwvdGV4dD48L2c+PCEtLWxpbmsgQ2xpZW50IHRvIE1haW4tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iQ2xpZW50IiBkYXRhLWVudGl0eS0yPSJNYWluIiBkYXRhLXNvdXJjZS1saW5lPSIxOCIgZGF0YS11aWQ9ImxuazEyIiBpZD0ibGlua19DbGllbnRfTWFpbiI+PHBhdGggZD0iTTQzMC41MSwyNDIuOCBDMzgzLjQyLDI2NC40OSAzMDUuMDcsMjkwLjg0IDI0My45MiwyNjMgQzE5My45LDI0MC4yMiAxNTkuMTk0OSwxOTEuNDk3NSAxMzkuMDA0OSwxNTYuNzU3NSIgZmlsbD0ibm9uZSIgaWQ9IkNsaWVudC10by1NYWluIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxMzUuOTksMTUxLjU3LDEzNy4wNTM5LDE2MS4zNjEyLDEzOC41MDI0LDE1NS44OTMsMTQzLjk3MDcsMTU3LjM0MTQsMTM1Ljk5LDE1MS41NyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjkxLjAxOSIgeD0iMjQ5LjQyIiB5PSIyNDQuMDY2OSI+SFRUUCBSZXF1ZXN0PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQyLjE4NjUiIHg9IjI3My44MzYzIiB5PSIyNTkuMTk5NyI+KEpTT04pPC90ZXh0PjwvZz48IS0tbGluayBNYWluIHRvIENsaWVudC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJNYWluIiBkYXRhLWVudGl0eS0yPSJDbGllbnQiIGRhdGEtc291cmNlLWxpbmU9IjI1IiBkYXRhLXVpZD0ibG5rMTkiIGlkPSJsaW5rX01haW5fQ2xpZW50Ij48cGF0aCBkPSJNMjE0LjExLDE1MC45NSBDMjI0LjE1LDE1NC4wOCAyMzQuMjMsMTU3LjE1IDI0My45MiwxNjAgQzMwOC43NiwxNzkuMDggMzc4Ljg3NjIsMTk3LjQyNyA0MjQuNjY2MiwyMDkuMTA3IiBmaWxsPSJub25lIiBpZD0iTWFpbi10by1DbGllbnQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjQzMC40OCwyMTAuNTksNDIyLjc0NzksMjA0LjQ4OTYsNDI1LjYzNTEsMjA5LjM1NDIsNDIwLjc3MDYsMjEyLjI0MTQsNDMwLjQ4LDIxMC41OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwMC42NDg0IiB4PSIyNDQuOTIiIHk9IjE0MS4wNjY5Ij5IVFRQIFJlc3BvbnNlPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQyLjE4NjUiIHg9IjI3NC4xNTEiIHk9IjE1Ni4xOTk3Ij4oSlNPTik8L3RleHQ+PC9nPjwhLS1saW5rIE1haW4gdG8gU2VydmljZS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJNYWluIiBkYXRhLWVudGl0eS0yPSJTZXJ2aWNlIiBkYXRhLXNvdXJjZS1saW5lPSIxOSIgZGF0YS11aWQ9ImxuazEzIiBpZD0ibGlua19NYWluX1NlcnZpY2UiPjxwYXRoIGQ9Ik0yMTQuMjIsMTE5Ljk5IEMyNTQuNzksMTE5Ljg4IDMwMi42OCwxMTkuNjEgMzQ1LjkyLDExOSBDMzY3LjQ2LDExOC43IDM4NS4wNjE5LDExOC4zMjkzIDQwNS45NTE5LDExNy44MDkzIiBmaWxsPSJub25lIiBpZD0iTWFpbi10by1TZXJ2aWNlIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI0MTEuOTUsMTE3LjY2LDQwMi44NTMyLDExMy44ODUyLDQwNi45NTE1LDExNy43ODQ0LDQwMy4wNTIzLDEyMS44ODI3LDQxMS45NSwxMTcuNjYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2OC4yNDM3IiB4PSIyNjAuOTIiIHk9IjExNS4wNjY5Ij5wcmVkaWN0KC4uLik8L3RleHQ+PC9nPjwhLS1saW5rIFNlcnZpY2UgdG8gTWFpbi0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJTZXJ2aWNlIiBkYXRhLWVudGl0eS0yPSJNYWluIiBkYXRhLXNvdXJjZS1saW5lPSIyNCIgZGF0YS11aWQ9ImxuazE4IiBpZD0ibGlua19TZXJ2aWNlX01haW4iPjxwYXRoIGQ9Ik00MTIuMTMsMTA1LjcgQzM5MS4yNiwxMDIuNTYgMzY3LjYyLDk5LjU0IDM0NS45Miw5OCBDMzAwLjcsOTQuNzggMjg5LjA4LDk0LjA0IDI0My45Miw5OCBDMjM0LjMxLDk4Ljg0IDIzMC4yNjA2LDk5LjIwODIgMjIwLjMxMDYsMTAwLjYxODIiIGZpbGw9Im5vbmUiIGlkPSJTZXJ2aWNlLXRvLU1haW4iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjIxNC4zNywxMDEuNDYsMjIzLjg0MjIsMTA0LjE1NzcsMjE5LjMyMDUsMTAwLjc1ODUsMjIyLjcxOTcsOTYuMjM2OCwyMTQuMzcsMTAxLjQ2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMzcuMDY0IiB4PSIyNzYuNDIiIHk9IjkxLjM2NjkiPnJlc3VsdDwvdGV4dD48L2c+PCEtLWxpbmsgU2VydmljZSB0byBEb21haW4tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iU2VydmljZSIgZGF0YS1lbnRpdHktMj0iRG9tYWluIiBkYXRhLXNvdXJjZS1saW5lPSIyMCIgZGF0YS11aWQ9ImxuazE0IiBpZD0ibGlua19TZXJ2aWNlX0RvbWFpbiI+PHBhdGggZD0iTTUzMy42MSwxMjAuOTQgQzU3Mi41MSwxMjMuMTYgNjI0LjI4LDEyNC4yNSA2NjkuNzMsMTE5IEM2ODMuNjksMTE3LjM5IDY5Mi42NjgsMTE1Ljg5NDMgNzA2LjU4OCwxMTIuNzQ0MyIgZmlsbD0ibm9uZSIgaWQ9IlNlcnZpY2UtdG8tRG9tYWluIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI3MTIuNDQsMTExLjQyLDcwMi43NzkxLDEwOS41MDUxLDcwNy41NjMzLDExMi41MjM2LDcwNC41NDQ4LDExNy4zMDc4LDcxMi40NCwxMTEuNDIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2OC4yNDM3IiB4PSI2MDAuNzMiIHk9IjExNS4wNjY5Ij5wcmVkaWN0KC4uLik8L3RleHQ+PC9nPjwhLS1saW5rIERvbWFpbiB0byBTZXJ2aWNlLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkRvbWFpbiIgZGF0YS1lbnRpdHktMj0iU2VydmljZSIgZGF0YS1zb3VyY2UtbGluZT0iMjMiIGRhdGEtdWlkPSJsbmsxNyIgaWQ9ImxpbmtfRG9tYWluX1NlcnZpY2UiPjxwYXRoIGQ9Ik03MTIuMjEsOTQuMjEgQzY3OS4wMSw5NC4yNCA2MzcuMDMsOTUuMDIgNTk5LjczLDk4IEM1NzguMDUsOTkuNzMgNTYwLjM0NDUsMTAxLjkxNjEgNTM5LjQ2NDUsMTA1LjAyNjEiIGZpbGw9Im5vbmUiIGlkPSJEb21haW4tdG8tU2VydmljZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTMzLjUzLDEwNS45MSw1NDMuMDIxMSwxMDguNTQwNSw1MzguNDc1NCwxMDUuMTczNCw1NDEuODQyNSwxMDAuNjI3OCw1MzMuNTMsMTA1LjkxIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMzcuMDY0IiB4PSI2MTYuMjMiIHk9IjkwLjgzNjkiPnJlc3VsdDwvdGV4dD48L2c+PCEtLWxpbmsgRG9tYWluIHRvIE1MLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkRvbWFpbiIgZGF0YS1lbnRpdHktMj0iTUwiIGRhdGEtc291cmNlLWxpbmU9IjIxIiBkYXRhLXVpZD0ibG5rMTUiIGlkPSJsaW5rX0RvbWFpbl9NTCI+PHBhdGggZD0iTTgzMy43NywxMDUuNTMgQzg3My4xMzUsMTEyLjQ4NSA5MjUuMTMsMTIxLjY3IDk2Ny43ODUsMTI5LjIwNSBDOTY5LjExOCwxMjkuNDQwNSA5NzAuNDQxOCwxMjkuNjc0MyA5NzEuNzU1OSwxMjkuOTA2NSBDOTcyLjQxMjksMTMwLjAyMjUgOTY3LjE1OSwxMjkuMDk0NCA5NjcuODExLDEyOS4yMDk2IiBmaWxsPSJub25lIiBpZD0iRG9tYWluLXRvLU1MIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI5NzMuNzE5NSwxMzAuMjUzMyw5NjUuNTUyNiwxMjQuNzQ4Nyw5NjguNzk1OCwxMjkuMzgzNiw5NjQuMTYwOSwxMzIuNjI2Nyw5NzMuNzE5NSwxMzAuMjUzMyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjcyLjM5NSIgeD0iODc3LjU1IiB5PSIxMDkuMzU2OSI+bG9hZCBtb2RlbDwvdGV4dD48L2c+PCEtLWxpbmsgTUwgdG8gRG9tYWluLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9Ik1MIiBkYXRhLWVudGl0eS0yPSJEb21haW4iIGRhdGEtc291cmNlLWxpbmU9IjIyIiBkYXRhLXVpZD0ibG5rMTYiIGlkPSJsaW5rX01MX0RvbWFpbiI+PHBhdGggZD0iTTk3NC4yNzgxLDE1NS42MzcyIEM5NjkuOTE2NCwxNTYuMDY5NCA5NjUuNDQ4LDE1Ni40NDczIDk2MC45MDA3LDE1Ni43NTQ0IEM5NTEuODA2MiwxNTcuMzY4NCA5NDIuMzk2MSwxNTcuNjk4OCA5MzIuODkzNCwxNTcuNjExMiBDOTEzLjg4ODEsMTU3LjQzNjMgODk0LjUxMjUsMTU1LjU5IDg3Ni41NSwxNTEgQzg1Ny4xMSwxNDYuMDMgODQyLjU4MDgsMTM5LjUzOTIgODI1LjcxMDgsMTI5Ljc1OTIiIGZpbGw9Im5vbmUiIGlkPSJNTC10by1Eb21haW4iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjgyMC41MiwxMjYuNzUsODI2LjMsMTM0LjcyNDQsODI0Ljg0NTcsMTI5LjI1NzcsODMwLjMxMjQsMTI3LjgwMzMsODIwLjUyLDEyNi43NSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQwLjQ3OSIgeD0iODkzLjU1IiB5PSIxNDcuMDY2OSI+bW9kZWw8L3RleHQ+PC9nPjwhLS1saW5rIE1haW4gdG8gR01OMjAtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iTWFpbiIgZGF0YS1lbnRpdHktMj0iR01OMjAiIGRhdGEtc291cmNlLWxpbmU9IjI4IiBkYXRhLXVpZD0ibG5rMjIiIGlkPSJsaW5rX01haW5fR01OMjAiPjxwYXRoIGQ9Ik0xMzQuMjgsMTUxLjU1IEMxNTMuOCwxODkuMzQgMTkxLjgzLDI1MS40OCAyNDMuOTIsMjgzIEMyODMuMTYsMzA2Ljc0IDMzMi43NywzMTcuMDYgMzc1LjY4LDMyMS4yMSIgZmlsbD0ibm9uZSIgaWQ9Ik1haW4tR01OMjAiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjcsNzsiLz48L2c+PCEtLWxpbmsgRG9tYWluIHRvIEdNTjI2LS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9IkRvbWFpbiIgZGF0YS1lbnRpdHktMj0iR01OMjYiIGRhdGEtc291cmNlLWxpbmU9IjQwIiBkYXRhLXVpZD0ibG5rMjgiIGlkPSJsaW5rX0RvbWFpbl9HTU4yNiI+PHBhdGggZD0iTTgzMy45LDg0LjAzIEM4NDcuODgsODEuNiA4NjIuNzIsNzkuMTEgODc2LjU1LDc3IEM5MTIuODgsNzEuNDUgOTUzLjc0LDY2LjExIDk4Ni4yMiw2Mi4wOSIgZmlsbD0ibm9uZSIgaWQ9IkRvbWFpbi1HTU4yNiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6Nyw3OyIvPjwvZz48IS0tU1JDPVtUTEJCUlhDbjVEdHhBd29tUUhPOS1vd0dBWDAyYjQxNGtzSlpwaFlmblNHVW5hdkhYNVhxQjNNOVE1S2E1YVd5WDhlWVFEODc4OEhlODRlX25hb1FwLTNRQ3ZFNEk2bjZ1dGxGa1ZTUy1tSHFJczRiU0NKZ3NtaHhCQUFVT2U4WkgzbWI4Ym1teUhVWi1vUmtjVllacVQtRHhYR21hVlhjbTJYTjI1YXV1Vk0wdWk5ajhqTFF4SXZVMnlFMFVTSEVTTDB1dXNWODR1ckdTRTNXMGZhM29jN2g0THluLWhOSGZvT1VrR0x4SGV6Q19ERmVwdDFDbGxNQVJhZ0xDOHdsMUxSYlBqMmFZX0NhWk5RT0h4RFB5R19Ccnd6Q0Y5b0hyckQ0bmd6N2JGQjUwUnZlbUZIU0l6VmU4LWp0T1ZhajF5WmVCSGU0dVlid19lX3ZBbDZzNlFVdUdhZDQ2UV9aZ2wxZjg1RmY1VjNsNHFLc1lHR2VZdldpWHUtM21hQkQwc3czQjVUYjRzSmxLNy12bFljYWlkVGRnbzBaVkdqU0FqcjhSc2FMdHpkT2dFNjd6NGNKSVdNVXhncV9rNXo0aFdVT18zOU1TSFhIZHRiZ2ZMbWs1cjVVMWFIY1RtY0dMVHNRMlpHM0dOcFNpM09IZDRrQmxCSXdHOVpsWkFYaTFjZy1SSXV3d3JIcEpjUGh2YVIyU3Fhd2l1RXVLM0lCaFRYb0dyMDljX1pPWEdXVXlOdHdZOTNPdkZwRHJSWGxrdGZXeW1vT1UwWnJ3b3ZyR21pNTdFSWJfVWRndkh4V1FZc1ZTQ0t5ODQzZXNxUVZjRHFKNHRUQ182QklVcFN6N1k3QVZNbTVCQ2w4VkJiVDRDNEJlbV9TWFpGdGhzNnhReExUblktSk5kVG8tM1FOdE5WMUZTcHIzdm9laF96VGJMd2w2dlU5ZDB4RXBFeGJUM28yQnpKX19FZkNCYXdKeW1fSmV0cXU5anMzckEzSGx2Rm5WY09zZF91Tl0tLT48L2c+PC9zdmc+" class="uml" alt="uml diagram" title="" /></p>
<p><strong>各層の責務</strong>：</p>
<table>
<thead>
<tr>
<th>層</th>
<th>責務</th>
<th>技術要素</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Application 層</strong></td>
<td>HTTP リクエスト/レスポンス処理</td>
<td>FastAPI、Pydantic</td>
</tr>
<tr>
<td><strong>Service 層</strong></td>
<td>ビジネスロジック、データ変換</td>
<td>Python ロジック</td>
</tr>
<tr>
<td><strong>Domain 層</strong></td>
<td>モデル操作、機械学習処理</td>
<td>scikit-learn、pickle</td>
</tr>
</tbody>
</table>
<h3 id="tdd_3">TDD による実装<a class="headerlink" href="#tdd_3" title="Permanent link">&para;</a></h3>
<h4 id="1-pydantic-red-green-refactor">ステップ 1: Pydantic モデルの定義（Red → Green → Refactor）<a class="headerlink" href="#1-pydantic-red-green-refactor" title="Permanent link">&para;</a></h4>
<p>まず、各 API エンドポイントで受け取るデータの型を定義します。</p>
<p><strong>Red（失敗するテスト）</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># test/test_models.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">IrisModel</span><span class="p">,</span> <span class="n">CinemaModel</span><span class="p">,</span> <span class="n">SurvivedModel</span><span class="p">,</span> <span class="n">BostonModel</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_IrisModelの正常な値</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;正しい値でIrisModelを作成できる&quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">IrisModel</span><span class="p">(</span>
        <span class="n">sepal_length</span><span class="o">=</span><span class="mf">5.1</span><span class="p">,</span>
        <span class="n">sepal_width</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span>
        <span class="n">petal_length</span><span class="o">=</span><span class="mf">1.4</span><span class="p">,</span>
        <span class="n">petal_width</span><span class="o">=</span><span class="mf">0.2</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">model</span><span class="o">.</span><span class="n">sepal_length</span> <span class="o">==</span> <span class="mf">5.1</span>
    <span class="k">assert</span> <span class="n">model</span><span class="o">.</span><span class="n">sepal_width</span> <span class="o">==</span> <span class="mf">3.5</span>
    <span class="k">assert</span> <span class="n">model</span><span class="o">.</span><span class="n">petal_length</span> <span class="o">==</span> <span class="mf">1.4</span>
    <span class="k">assert</span> <span class="n">model</span><span class="o">.</span><span class="n">petal_width</span> <span class="o">==</span> <span class="mf">0.2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_IrisModelの負の値でエラー</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;負の値を指定するとバリデーションエラー&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">IrisModel</span><span class="p">(</span>
            <span class="n">sepal_length</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="n">sepal_width</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span>
            <span class="n">petal_length</span><span class="o">=</span><span class="mf">1.4</span><span class="p">,</span>
            <span class="n">petal_width</span><span class="o">=</span><span class="mf">0.2</span>
        <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_CinemaModelの正常な値</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;正しい値でCinemaModelを作成できる&quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">CinemaModel</span><span class="p">(</span>
        <span class="n">sns1</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">sns2</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
        <span class="n">actor</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span>
        <span class="n">original</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">model</span><span class="o">.</span><span class="n">sns1</span> <span class="o">==</span> <span class="mi">500</span>
    <span class="k">assert</span> <span class="n">model</span><span class="o">.</span><span class="n">sns2</span> <span class="o">==</span> <span class="mi">300</span>
    <span class="k">assert</span> <span class="n">model</span><span class="o">.</span><span class="n">actor</span> <span class="o">==</span> <span class="mi">70</span>
    <span class="k">assert</span> <span class="n">model</span><span class="o">.</span><span class="n">original</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_SurvivedModelの正常な値</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;正しい値でSurvivedModelを作成できる&quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">SurvivedModel</span><span class="p">(</span>
        <span class="n">pclass</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">age</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span>
        <span class="n">sex</span><span class="o">=</span><span class="s2">&quot;male&quot;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">model</span><span class="o">.</span><span class="n">pclass</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="n">model</span><span class="o">.</span><span class="n">age</span> <span class="o">==</span> <span class="mi">22</span>
    <span class="k">assert</span> <span class="n">model</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;male&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_SurvivedModelの不正なsexでエラー</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;sex が male/female 以外でエラー&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">SurvivedModel</span><span class="p">(</span><span class="n">pclass</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">sex</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_BostonModelの正常な値</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;正しい値でBostonModelを作成できる&quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">BostonModel</span><span class="p">(</span>
        <span class="n">rm</span><span class="o">=</span><span class="mf">6.5</span><span class="p">,</span>
        <span class="n">lstat</span><span class="o">=</span><span class="mf">4.98</span><span class="p">,</span>
        <span class="n">ptratio</span><span class="o">=</span><span class="mf">15.3</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">model</span><span class="o">.</span><span class="n">rm</span> <span class="o">==</span> <span class="mf">6.5</span>
    <span class="k">assert</span> <span class="n">model</span><span class="o">.</span><span class="n">lstat</span> <span class="o">==</span> <span class="mf">4.98</span>
    <span class="k">assert</span> <span class="n">model</span><span class="o">.</span><span class="n">ptratio</span> <span class="o">==</span> <span class="mf">15.3</span>
</code></pre></div>
<p><strong>実行結果（Red）</strong>:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test/test_models.py
ModuleNotFoundError:<span class="w"> </span>No<span class="w"> </span>module<span class="w"> </span>named<span class="w"> </span><span class="s1">&#39;app.models&#39;</span>
</code></pre></div>
<p><strong>Green（最小限の実装）</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># app/models.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">field_validator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>

<span class="k">class</span><span class="w"> </span><span class="nc">IrisModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Iris 分類のリクエストモデル&quot;&quot;&quot;</span>
    <span class="n">sepal_length</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;がく片の長さ (cm)&quot;</span><span class="p">)</span>
    <span class="n">sepal_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;がく片の幅 (cm)&quot;</span><span class="p">)</span>
    <span class="n">petal_length</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;花弁の長さ (cm)&quot;</span><span class="p">)</span>
    <span class="n">petal_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;花弁の幅 (cm)&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CinemaModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cinema 売上予測のリクエストモデル&quot;&quot;&quot;</span>
    <span class="n">sns1</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;SNS 言及数 1&quot;</span><span class="p">)</span>
    <span class="n">sns2</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;SNS 言及数 2&quot;</span><span class="p">)</span>
    <span class="n">actor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;主演俳優スコア (0-100)&quot;</span><span class="p">)</span>
    <span class="n">original</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;オリジナル作品フラグ (0 or 1)&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SurvivedModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Survived 生存予測のリクエストモデル&quot;&quot;&quot;</span>
    <span class="n">pclass</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;客室クラス (1, 2, 3)&quot;</span><span class="p">)</span>
    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;年齢&quot;</span><span class="p">)</span>
    <span class="n">sex</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;male&quot;</span><span class="p">,</span> <span class="s2">&quot;female&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;性別 (male or female)&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BostonModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Boston 住宅価格予測のリクエストモデル&quot;&quot;&quot;</span>
    <span class="n">rm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;部屋数&quot;</span><span class="p">)</span>
    <span class="n">lstat</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;低所得者人口割合 (%)&quot;</span><span class="p">)</span>
    <span class="n">ptratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;生徒と教師の比率&quot;</span><span class="p">)</span>
</code></pre></div>
<p><strong>実行結果（Green）</strong>:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test/test_models.py<span class="w"> </span>-v
test_models.py::test_IrisModelの正常な値<span class="w"> </span>PASSED<span class="w">                        </span><span class="o">[</span><span class="w"> </span><span class="m">16</span>%<span class="o">]</span>
test_models.py::test_IrisModelの負の値でエラー<span class="w"> </span>PASSED<span class="w">                   </span><span class="o">[</span><span class="w"> </span><span class="m">33</span>%<span class="o">]</span>
test_models.py::test_CinemaModelの正常な値<span class="w"> </span>PASSED<span class="w">                      </span><span class="o">[</span><span class="w"> </span><span class="m">50</span>%<span class="o">]</span>
test_models.py::test_SurvivedModelの正常な値<span class="w"> </span>PASSED<span class="w">                    </span><span class="o">[</span><span class="w"> </span><span class="m">66</span>%<span class="o">]</span>
test_models.py::test_SurvivedModelの不正なsexでエラー<span class="w"> </span>PASSED<span class="w">           </span><span class="o">[</span><span class="w"> </span><span class="m">83</span>%<span class="o">]</span>
test_models.py::test_BostonModelの正常な値<span class="w"> </span>PASSED<span class="w">                      </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">==============================</span><span class="w"> </span><span class="m">6</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.12s<span class="w"> </span><span class="o">==============================</span>
</code></pre></div>
<p><strong>Refactor（改善）</strong>:</p>
<p>現時点では特にリファクタリングは不要です。Pydantic の Field と Literal を使用してバリデーションを宣言的に記述できています。</p>
<h4 id="2-red-green-refactor">ステップ 2: ドメイン層の実装（Red → Green → Refactor）<a class="headerlink" href="#2-red-green-refactor" title="Permanent link">&para;</a></h4>
<p>次に、訓練済みモデルを読み込んで予測を行うドメイン層を実装します。</p>
<p><strong>Red（失敗するテスト）</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># test/test_domain.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn</span><span class="w"> </span><span class="kn">import</span> <span class="n">tree</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.domain</span><span class="w"> </span><span class="kn">import</span> <span class="n">IrisDomain</span><span class="p">,</span> <span class="n">CinemaDomain</span><span class="p">,</span> <span class="n">SurvivedDomain</span><span class="p">,</span> <span class="n">BostonDomain</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_IrisDomainでモデルを読み込める</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;訓練済みIrisモデルを読み込める&quot;&quot;&quot;</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="n">IrisDomain</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">domain</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_IrisDomainで予測ができる</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Irisモデルで予測を実行できる&quot;&quot;&quot;</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="n">IrisDomain</span><span class="p">()</span>
    <span class="n">X</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">5.1</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;setosa&quot;</span><span class="p">,</span> <span class="s2">&quot;versicolor&quot;</span><span class="p">,</span> <span class="s2">&quot;virginica&quot;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_CinemaDomainでモデルを読み込める</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;訓練済みCinemaモデルを読み込める&quot;&quot;&quot;</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="n">CinemaDomain</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">domain</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_CinemaDomainで予測ができる</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cinemaモデルで予測を実行できる&quot;&quot;&quot;</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="n">CinemaDomain</span><span class="p">()</span>
    <span class="n">X</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_SurvivedDomainでモデルを読み込める</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;訓練済みSurvivedモデルを読み込める&quot;&quot;&quot;</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="n">SurvivedDomain</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">domain</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_SurvivedDomainで予測ができる</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Survivedモデルで予測を実行できる&quot;&quot;&quot;</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="n">SurvivedDomain</span><span class="p">()</span>
    <span class="n">X_dict</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;Pclass&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;Age&quot;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span> <span class="s2">&quot;male&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_dict</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_BostonDomainでモデルを読み込める</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;訓練済みBostonモデルを読み込める&quot;&quot;&quot;</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="n">BostonDomain</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">domain</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">domain</span><span class="o">.</span><span class="n">scaler_X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">domain</span><span class="o">.</span><span class="n">scaler_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_BostonDomainで予測ができる</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Bostonモデルで予測を実行できる&quot;&quot;&quot;</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="n">BostonDomain</span><span class="p">()</span>
    <span class="n">X_dict</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;RM&quot;</span><span class="p">:</span> <span class="mf">6.5</span><span class="p">,</span> <span class="s2">&quot;LSTAT&quot;</span><span class="p">:</span> <span class="mf">4.98</span><span class="p">,</span> <span class="s2">&quot;PTRATIO&quot;</span><span class="p">:</span> <span class="mf">15.3</span><span class="p">}]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_dict</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
</code></pre></div>
<p><strong>実行結果（Red）</strong>:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test/test_domain.py
ModuleNotFoundError:<span class="w"> </span>No<span class="w"> </span>module<span class="w"> </span>named<span class="w"> </span><span class="s1">&#39;app.domain&#39;</span>
</code></pre></div>
<p><strong>Green（最小限の実装）</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># app/domain.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="k">class</span><span class="w"> </span><span class="nc">IrisDomain</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Iris 分類ドメイン&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;model/iris.pkl&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">model_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_model</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;訓練済みモデルの読み込み&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;予測を実行</span>

<span class="sd">        Args:</span>
<span class="sd">            X: 特徴量のリスト [[sepal_length, sepal_width, petal_length, petal_width]]</span>

<span class="sd">        Returns:</span>
<span class="sd">            予測結果（種名）のリスト</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model not loaded&quot;</span><span class="p">)</span>

        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">predictions</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CinemaDomain</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cinema 売上予測ドメイン&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;model/cinema.pkl&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">model_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_model</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;訓練済みモデルの読み込み&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;予測を実行</span>

<span class="sd">        Args:</span>
<span class="sd">            X: 特徴量のリスト [[sns1, sns2, actor, original]]</span>

<span class="sd">        Returns:</span>
<span class="sd">            予測結果（売上）のリスト</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model not loaded&quot;</span><span class="p">)</span>

        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">predictions</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SurvivedDomain</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Survived 生存予測ドメイン&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;model/survived.pkl&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">model_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_model</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;訓練済みモデルの読み込み&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_dict</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;予測を実行</span>

<span class="sd">        Args:</span>
<span class="sd">            X_dict: 特徴量の辞書のリスト [{&quot;Pclass&quot;: 3, &quot;Age&quot;: 22, &quot;male&quot;: 1}]</span>

<span class="sd">        Returns:</span>
<span class="sd">            予測結果（0: 死亡, 1: 生存）のリスト</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model not loaded&quot;</span><span class="p">)</span>

        <span class="c1"># 辞書をDataFrameに変換</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_dict</span><span class="p">)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">predictions</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BostonDomain</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Boston 住宅価格予測ドメイン&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;model/boston.pkl&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">model_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_model</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;訓練済みモデルとスケーラーの読み込み&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">saved_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span> <span class="o">=</span> <span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;scaler_X&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span> <span class="o">=</span> <span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;scaler_y&#39;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_dict</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;予測を実行</span>

<span class="sd">        Args:</span>
<span class="sd">            X_dict: 特徴量の辞書のリスト [{&quot;RM&quot;: 6.5, &quot;LSTAT&quot;: 4.98, &quot;PTRATIO&quot;: 15.3}]</span>

<span class="sd">        Returns:</span>
<span class="sd">            予測結果（住宅価格）のリスト</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model or scalers not loaded&quot;</span><span class="p">)</span>

        <span class="c1"># 辞書をDataFrameに変換</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_dict</span><span class="p">)</span>

        <span class="c1"># 特徴量エンジニアリング（訓練時と同じ処理）</span>
        <span class="n">X_engineered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_feature_engineering</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># 特徴量の標準化</span>
        <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_engineered</span><span class="p">)</span>

        <span class="c1"># 予測（標準化された値）</span>
        <span class="n">y_pred_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)</span>

        <span class="c1"># 予測結果を元のスケールに戻す</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">y_pred_scaled</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_feature_engineering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;特徴量エンジニアリング（2乗項と交互作用項の追加）&quot;&quot;&quot;</span>
        <span class="n">X_new</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># 2乗項の追加</span>
        <span class="n">X_new</span><span class="p">[</span><span class="s1">&#39;RM2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;RM&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">X_new</span><span class="p">[</span><span class="s1">&#39;LSTAT2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;LSTAT&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">X_new</span><span class="p">[</span><span class="s1">&#39;PTRATIO2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;PTRATIO&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="c1"># 交互作用項の追加</span>
        <span class="n">X_new</span><span class="p">[</span><span class="s1">&#39;RM * LSTAT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;RM&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;LSTAT&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">X_new</span>
</code></pre></div>
<p><strong>実行結果（Green）</strong>:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test/test_domain.py<span class="w"> </span>-v
test_domain.py::test_IrisDomainでモデルを読み込める<span class="w"> </span>PASSED<span class="w">              </span><span class="o">[</span><span class="w"> </span><span class="m">12</span>%<span class="o">]</span>
test_domain.py::test_IrisDomainで予測ができる<span class="w"> </span>PASSED<span class="w">                    </span><span class="o">[</span><span class="w"> </span><span class="m">25</span>%<span class="o">]</span>
test_domain.py::test_CinemaDomainでモデルを読み込める<span class="w"> </span>PASSED<span class="w">            </span><span class="o">[</span><span class="w"> </span><span class="m">37</span>%<span class="o">]</span>
test_domain.py::test_CinemaDomainで予測ができる<span class="w"> </span>PASSED<span class="w">                  </span><span class="o">[</span><span class="w"> </span><span class="m">50</span>%<span class="o">]</span>
test_domain.py::test_SurvivedDomainでモデルを読み込める<span class="w"> </span>PASSED<span class="w">          </span><span class="o">[</span><span class="w"> </span><span class="m">62</span>%<span class="o">]</span>
test_domain.py::test_SurvivedDomainで予測ができる<span class="w"> </span>PASSED<span class="w">                </span><span class="o">[</span><span class="w"> </span><span class="m">75</span>%<span class="o">]</span>
test_domain.py::test_BostonDomainでモデルを読み込める<span class="w"> </span>PASSED<span class="w">            </span><span class="o">[</span><span class="w"> </span><span class="m">87</span>%<span class="o">]</span>
test_domain.py::test_BostonDomainで予測ができる<span class="w"> </span>PASSED<span class="w">                  </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">==============================</span><span class="w"> </span><span class="m">8</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.45s<span class="w"> </span><span class="o">==============================</span>
</code></pre></div>
<p><strong>Refactor（改善）</strong>:</p>
<p>モデル読み込みのエラーハンドリングを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># app/domain.py (リファクタリング後)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">IrisDomain</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Iris 分類ドメイン&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;model/iris.pkl&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">model_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_model</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;訓練済みモデルの読み込み&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model file not found: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 以下略（他のドメインクラスも同様にエラーハンドリングを追加）</span>
</code></pre></div>
<h4 id="3-red-green-refactor">ステップ 3: サービス層の実装（Red → Green → Refactor）<a class="headerlink" href="#3-red-green-refactor" title="Permanent link">&para;</a></h4>
<p>サービス層では、ドメイン層を使用してビジネスロジックを実装します。</p>
<p><strong>Red（失敗するテスト）</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># test/test_service.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.service</span><span class="w"> </span><span class="kn">import</span> <span class="n">MLService</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_predict_iris</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Iris予測サービスが正しく動作する&quot;&quot;&quot;</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">MLService</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">predict_iris</span><span class="p">([[</span><span class="mf">5.1</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]])</span>

    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;setosa&quot;</span><span class="p">,</span> <span class="s2">&quot;versicolor&quot;</span><span class="p">,</span> <span class="s2">&quot;virginica&quot;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_predict_cinema</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cinema予測サービスが正しく動作する&quot;&quot;&quot;</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">MLService</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">predict_cinema</span><span class="p">([[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>

    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">&gt;</span> <span class="mi">0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_predict_survived</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Survived予測サービスが正しく動作する&quot;&quot;&quot;</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">MLService</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">predict_survived</span><span class="p">(</span><span class="n">pclass</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> <span class="n">sex</span><span class="o">=</span><span class="s2">&quot;male&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_predict_boston</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Boston予測サービスが正しく動作する&quot;&quot;&quot;</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">MLService</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">predict_boston</span><span class="p">(</span><span class="n">rm</span><span class="o">=</span><span class="mf">6.5</span><span class="p">,</span> <span class="n">lstat</span><span class="o">=</span><span class="mf">4.98</span><span class="p">,</span> <span class="n">ptratio</span><span class="o">=</span><span class="mf">15.3</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">&gt;</span> <span class="mi">0</span>
</code></pre></div>
<p><strong>実行結果（Red）</strong>:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test/test_service.py
ModuleNotFoundError:<span class="w"> </span>No<span class="w"> </span>module<span class="w"> </span>named<span class="w"> </span><span class="s1">&#39;app.service&#39;</span>
</code></pre></div>
<p><strong>Green（最小限の実装）</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># app/service.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.domain</span><span class="w"> </span><span class="kn">import</span> <span class="n">IrisDomain</span><span class="p">,</span> <span class="n">CinemaDomain</span><span class="p">,</span> <span class="n">SurvivedDomain</span><span class="p">,</span> <span class="n">BostonDomain</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MLService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;機械学習サービス層&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># ドメインオブジェクトは毎回生成（シングルトンにしても良い）</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict_iris</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iris 分類予測</span>

<span class="sd">        Args:</span>
<span class="sd">            features: [[sepal_length, sepal_width, petal_length, petal_width]]</span>

<span class="sd">        Returns:</span>
<span class="sd">            予測された種名</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">IrisDomain</span><span class="p">()</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 最初の予測結果を返す</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict_cinema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cinema 売上予測</span>

<span class="sd">        Args:</span>
<span class="sd">            features: [[sns1, sns2, actor, original]]</span>

<span class="sd">        Returns:</span>
<span class="sd">            予測された売上</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">CinemaDomain</span><span class="p">()</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict_survived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pclass</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">age</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">sex</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Survived 生存予測</span>

<span class="sd">        Args:</span>
<span class="sd">            pclass: 客室クラス</span>
<span class="sd">            age: 年齢</span>
<span class="sd">            sex: 性別</span>

<span class="sd">        Returns:</span>
<span class="sd">            予測結果（0: 死亡, 1: 生存）</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">SurvivedDomain</span><span class="p">()</span>

        <span class="c1"># sex を male ダミー変数に変換</span>
        <span class="n">male</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;male&quot;</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="n">X_dict</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;Pclass&quot;</span><span class="p">:</span> <span class="n">pclass</span><span class="p">,</span> <span class="s2">&quot;Age&quot;</span><span class="p">:</span> <span class="n">age</span><span class="p">,</span> <span class="s2">&quot;male&quot;</span><span class="p">:</span> <span class="n">male</span><span class="p">}]</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict_boston</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">lstat</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ptratio</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Boston 住宅価格予測</span>

<span class="sd">        Args:</span>
<span class="sd">            rm: 部屋数</span>
<span class="sd">            lstat: 低所得者人口割合</span>
<span class="sd">            ptratio: 生徒と教師の比率</span>

<span class="sd">        Returns:</span>
<span class="sd">            予測された住宅価格</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">BostonDomain</span><span class="p">()</span>

        <span class="n">X_dict</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;RM&quot;</span><span class="p">:</span> <span class="n">rm</span><span class="p">,</span> <span class="s2">&quot;LSTAT&quot;</span><span class="p">:</span> <span class="n">lstat</span><span class="p">,</span> <span class="s2">&quot;PTRATIO&quot;</span><span class="p">:</span> <span class="n">ptratio</span><span class="p">}]</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div>
<p><strong>実行結果（Green）</strong>:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test/test_service.py<span class="w"> </span>-v
test_service.py::test_predict_iris<span class="w"> </span>PASSED<span class="w">                               </span><span class="o">[</span><span class="w"> </span><span class="m">25</span>%<span class="o">]</span>
test_service.py::test_predict_cinema<span class="w"> </span>PASSED<span class="w">                             </span><span class="o">[</span><span class="w"> </span><span class="m">50</span>%<span class="o">]</span>
test_service.py::test_predict_survived<span class="w"> </span>PASSED<span class="w">                           </span><span class="o">[</span><span class="w"> </span><span class="m">75</span>%<span class="o">]</span>
test_service.py::test_predict_boston<span class="w"> </span>PASSED<span class="w">                             </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">==============================</span><span class="w"> </span><span class="m">4</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.56s<span class="w"> </span><span class="o">==============================</span>
</code></pre></div>
<p><strong>Refactor（改善）</strong>:</p>
<p>ドメインオブジェクトをシングルトンパターンで再利用するように改善します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># app/service.py (リファクタリング後)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.domain</span><span class="w"> </span><span class="kn">import</span> <span class="n">IrisDomain</span><span class="p">,</span> <span class="n">CinemaDomain</span><span class="p">,</span> <span class="n">SurvivedDomain</span><span class="p">,</span> <span class="n">BostonDomain</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MLService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;機械学習サービス層&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># 初回アクセス時にモデルを読み込み、以降は再利用</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iris_domain</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IrisDomain</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cinema_domain</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CinemaDomain</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_survived_domain</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SurvivedDomain</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_boston_domain</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BostonDomain</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">iris_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IrisDomain</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lazy loading で IrisDomain を取得&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iris_domain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_iris_domain</span> <span class="o">=</span> <span class="n">IrisDomain</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iris_domain</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cinema_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CinemaDomain</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lazy loading で CinemaDomain を取得&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cinema_domain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cinema_domain</span> <span class="o">=</span> <span class="n">CinemaDomain</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cinema_domain</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">survived_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SurvivedDomain</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lazy loading で SurvivedDomain を取得&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_survived_domain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_survived_domain</span> <span class="o">=</span> <span class="n">SurvivedDomain</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_survived_domain</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">boston_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BostonDomain</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lazy loading で BostonDomain を取得&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boston_domain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_boston_domain</span> <span class="o">=</span> <span class="n">BostonDomain</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boston_domain</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict_iris</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iris 分類予測&quot;&quot;&quot;</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iris_domain</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict_cinema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cinema 売上予測&quot;&quot;&quot;</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cinema_domain</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict_survived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pclass</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">age</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">sex</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Survived 生存予測&quot;&quot;&quot;</span>
        <span class="n">male</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;male&quot;</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">X_dict</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;Pclass&quot;</span><span class="p">:</span> <span class="n">pclass</span><span class="p">,</span> <span class="s2">&quot;Age&quot;</span><span class="p">:</span> <span class="n">age</span><span class="p">,</span> <span class="s2">&quot;male&quot;</span><span class="p">:</span> <span class="n">male</span><span class="p">}]</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">survived_domain</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict_boston</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">lstat</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ptratio</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Boston 住宅価格予測&quot;&quot;&quot;</span>
        <span class="n">X_dict</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;RM&quot;</span><span class="p">:</span> <span class="n">rm</span><span class="p">,</span> <span class="s2">&quot;LSTAT&quot;</span><span class="p">:</span> <span class="n">lstat</span><span class="p">,</span> <span class="s2">&quot;PTRATIO&quot;</span><span class="p">:</span> <span class="n">ptratio</span><span class="p">}]</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boston_domain</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div>
<h4 id="4-red-green-refactor">ステップ 4: アプリケーション層の実装（Red → Green → Refactor）<a class="headerlink" href="#4-red-green-refactor" title="Permanent link">&para;</a></h4>
<p>最後に、FastAPI のエンドポイントを実装します。</p>
<p><strong>Red（失敗するテスト）</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># test/test_application.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.testclient</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestClient</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.application</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_Irisエンドポイントの正常系</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Iris エンドポイントが正しく動作する&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/iris&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;sepal_length&quot;</span><span class="p">:</span> <span class="mf">5.1</span><span class="p">,</span>
        <span class="s2">&quot;sepal_width&quot;</span><span class="p">:</span> <span class="mf">3.5</span><span class="p">,</span>
        <span class="s2">&quot;petal_length&quot;</span><span class="p">:</span> <span class="mf">1.4</span><span class="p">,</span>
        <span class="s2">&quot;petal_width&quot;</span><span class="p">:</span> <span class="mf">0.2</span>
    <span class="p">})</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s2">&quot;species&quot;</span> <span class="ow">in</span> <span class="n">data</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;setosa&quot;</span><span class="p">,</span> <span class="s2">&quot;versicolor&quot;</span><span class="p">,</span> <span class="s2">&quot;virginica&quot;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_Irisエンドポイントの異常系_負の値</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;負の値を指定するとバリデーションエラー&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/iris&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;sepal_length&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="s2">&quot;sepal_width&quot;</span><span class="p">:</span> <span class="mf">3.5</span><span class="p">,</span>
        <span class="s2">&quot;petal_length&quot;</span><span class="p">:</span> <span class="mf">1.4</span><span class="p">,</span>
        <span class="s2">&quot;petal_width&quot;</span><span class="p">:</span> <span class="mf">0.2</span>
    <span class="p">})</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">422</span>  <span class="c1"># Validation error</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_Cinemaエンドポイントの正常系</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cinema エンドポイントが正しく動作する&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/cinema&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;sns1&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
        <span class="s2">&quot;sns2&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
        <span class="s2">&quot;actor&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
        <span class="s2">&quot;original&quot;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">})</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s2">&quot;predicted_sales&quot;</span> <span class="ow">in</span> <span class="n">data</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;predicted_sales&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_Survivedエンドポイントの正常系</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Survived エンドポイントが正しく動作する&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/survived&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;pclass&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
        <span class="s2">&quot;sex&quot;</span><span class="p">:</span> <span class="s2">&quot;male&quot;</span>
    <span class="p">})</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s2">&quot;survived&quot;</span> <span class="ow">in</span> <span class="n">data</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;survived&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_Bostonエンドポイントの正常系</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Boston エンドポイントが正しく動作する&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/boston&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;rm&quot;</span><span class="p">:</span> <span class="mf">6.5</span><span class="p">,</span>
        <span class="s2">&quot;lstat&quot;</span><span class="p">:</span> <span class="mf">4.98</span><span class="p">,</span>
        <span class="s2">&quot;ptratio&quot;</span><span class="p">:</span> <span class="mf">15.3</span>
    <span class="p">})</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s2">&quot;predicted_price&quot;</span> <span class="ow">in</span> <span class="n">data</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;predicted_price&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_ルートエンドポイント</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ルートエンドポイントが正しく動作する&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s2">&quot;message&quot;</span> <span class="ow">in</span> <span class="n">data</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_ヘルスチェックエンドポイント</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ヘルスチェックエンドポイントが正しく動作する&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/health&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ok&quot;</span>
</code></pre></div>
<p><strong>実行結果（Red）</strong>:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test/test_application.py
ModuleNotFoundError:<span class="w"> </span>No<span class="w"> </span>module<span class="w"> </span>named<span class="w"> </span><span class="s1">&#39;app.application&#39;</span>
</code></pre></div>
<p><strong>Green（最小限の実装）</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># app/application.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">IrisModel</span><span class="p">,</span> <span class="n">CinemaModel</span><span class="p">,</span> <span class="n">SurvivedModel</span><span class="p">,</span> <span class="n">BostonModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.service</span><span class="w"> </span><span class="kn">import</span> <span class="n">MLService</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Machine Learning API&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;TDD で構築した機械学習モデルの API&quot;</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="s2">&quot;1.0.0&quot;</span>
<span class="p">)</span>

<span class="n">service</span> <span class="o">=</span> <span class="n">MLService</span><span class="p">()</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Root&quot;</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">root</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ルートエンドポイント&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Machine Learning API&quot;</span><span class="p">,</span>
        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;endpoints&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;/iris&quot;</span><span class="p">,</span> <span class="s2">&quot;/cinema&quot;</span><span class="p">,</span> <span class="s2">&quot;/survived&quot;</span><span class="p">,</span> <span class="s2">&quot;/boston&quot;</span><span class="p">]</span>
    <span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/health&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Health&quot;</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">health</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ヘルスチェックエンドポイント&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/iris&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Iris&quot;</span><span class="p">],</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;アヤメの種類を分類&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">predict_iris</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">IrisModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Iris 分類エンドポイント</span>

<span class="sd">    Args:</span>
<span class="sd">        model: Iris の特徴量</span>

<span class="sd">    Returns:</span>
<span class="sd">        予測された種名</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">[[</span>
        <span class="n">model</span><span class="o">.</span><span class="n">sepal_length</span><span class="p">,</span>
        <span class="n">model</span><span class="o">.</span><span class="n">sepal_width</span><span class="p">,</span>
        <span class="n">model</span><span class="o">.</span><span class="n">petal_length</span><span class="p">,</span>
        <span class="n">model</span><span class="o">.</span><span class="n">petal_width</span>
    <span class="p">]]</span>

    <span class="n">species</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">predict_iris</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="n">species</span><span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/cinema&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Cinema&quot;</span><span class="p">],</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;映画の興行収入を予測&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">predict_cinema</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">CinemaModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cinema 売上予測エンドポイント</span>

<span class="sd">    Args:</span>
<span class="sd">        model: Cinema の特徴量</span>

<span class="sd">    Returns:</span>
<span class="sd">        予測された売上</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">[[</span>
        <span class="n">model</span><span class="o">.</span><span class="n">sns1</span><span class="p">,</span>
        <span class="n">model</span><span class="o">.</span><span class="n">sns2</span><span class="p">,</span>
        <span class="n">model</span><span class="o">.</span><span class="n">actor</span><span class="p">,</span>
        <span class="n">model</span><span class="o">.</span><span class="n">original</span>
    <span class="p">]]</span>

    <span class="n">predicted_sales</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">predict_cinema</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;predicted_sales&quot;</span><span class="p">:</span> <span class="n">predicted_sales</span><span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/survived&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Survived&quot;</span><span class="p">],</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;タイタニック号での生存を予測&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">predict_survived</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">SurvivedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Survived 生存予測エンドポイント</span>

<span class="sd">    Args:</span>
<span class="sd">        model: Survived の特徴量</span>

<span class="sd">    Returns:</span>
<span class="sd">        予測結果（0: 死亡, 1: 生存）</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">survived</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">predict_survived</span><span class="p">(</span>
        <span class="n">pclass</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">pclass</span><span class="p">,</span>
        <span class="n">age</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">age</span><span class="p">,</span>
        <span class="n">sex</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">sex</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;survived&quot;</span><span class="p">:</span> <span class="n">survived</span><span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/boston&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Boston&quot;</span><span class="p">],</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;ボストン住宅価格を予測&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">predict_boston</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">BostonModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Boston 住宅価格予測エンドポイント</span>

<span class="sd">    Args:</span>
<span class="sd">        model: Boston の特徴量</span>

<span class="sd">    Returns:</span>
<span class="sd">        予測された住宅価格</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">predicted_price</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">predict_boston</span><span class="p">(</span>
        <span class="n">rm</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">rm</span><span class="p">,</span>
        <span class="n">lstat</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">lstat</span><span class="p">,</span>
        <span class="n">ptratio</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">ptratio</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;predicted_price&quot;</span><span class="p">:</span> <span class="n">predicted_price</span><span class="p">}</span>
</code></pre></div>
<p><strong>実行結果（Green）</strong>:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>test/test_application.py<span class="w"> </span>-v
test_application.py::test_Irisエンドポイントの正常系<span class="w"> </span>PASSED<span class="w">             </span><span class="o">[</span><span class="w"> </span><span class="m">14</span>%<span class="o">]</span>
test_application.py::test_Irisエンドポイントの異常系_負の値<span class="w"> </span>PASSED<span class="w">       </span><span class="o">[</span><span class="w"> </span><span class="m">28</span>%<span class="o">]</span>
test_application.py::test_Cinemaエンドポイントの正常系<span class="w"> </span>PASSED<span class="w">           </span><span class="o">[</span><span class="w"> </span><span class="m">42</span>%<span class="o">]</span>
test_application.py::test_Survivedエンドポイントの正常系<span class="w"> </span>PASSED<span class="w">         </span><span class="o">[</span><span class="w"> </span><span class="m">57</span>%<span class="o">]</span>
test_application.py::test_Bostonエンドポイントの正常系<span class="w"> </span>PASSED<span class="w">           </span><span class="o">[</span><span class="w"> </span><span class="m">71</span>%<span class="o">]</span>
test_application.py::test_ルートエンドポイント<span class="w"> </span>PASSED<span class="w">                   </span><span class="o">[</span><span class="w"> </span><span class="m">85</span>%<span class="o">]</span>
test_application.py::test_ヘルスチェックエンドポイント<span class="w"> </span>PASSED<span class="w">           </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">==============================</span><span class="w"> </span><span class="m">7</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.78s<span class="w"> </span><span class="o">==============================</span>
</code></pre></div>
<p><strong>Refactor（改善）</strong>:</p>
<p>エラーハンドリングとレスポンスモデルを追加します：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># app/application.py (リファクタリング後)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONResponse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">IrisModel</span><span class="p">,</span> <span class="n">CinemaModel</span><span class="p">,</span> <span class="n">SurvivedModel</span><span class="p">,</span> <span class="n">BostonModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.service</span><span class="w"> </span><span class="kn">import</span> <span class="n">MLService</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Machine Learning API&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;TDD で構築した機械学習モデルの API&quot;</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="s2">&quot;1.0.0&quot;</span>
<span class="p">)</span>

<span class="n">service</span> <span class="o">=</span> <span class="n">MLService</span><span class="p">()</span>

<span class="c1"># レスポンスモデルの定義</span>
<span class="k">class</span><span class="w"> </span><span class="nc">IrisResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">species</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CinemaResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">predicted_sales</span><span class="p">:</span> <span class="nb">float</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SurvivedResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">survived</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BostonResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">predicted_price</span><span class="p">:</span> <span class="nb">float</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Root&quot;</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">root</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ルートエンドポイント&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Machine Learning API&quot;</span><span class="p">,</span>
        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;endpoints&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;/iris&quot;</span><span class="p">,</span> <span class="s2">&quot;/cinema&quot;</span><span class="p">,</span> <span class="s2">&quot;/survived&quot;</span><span class="p">,</span> <span class="s2">&quot;/boston&quot;</span><span class="p">]</span>
    <span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/health&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Health&quot;</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">health</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ヘルスチェックエンドポイント&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/iris&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">IrisResponse</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Iris&quot;</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">predict_iris</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">IrisModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Iris 分類エンドポイント&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">[[</span>
            <span class="n">model</span><span class="o">.</span><span class="n">sepal_length</span><span class="p">,</span>
            <span class="n">model</span><span class="o">.</span><span class="n">sepal_width</span><span class="p">,</span>
            <span class="n">model</span><span class="o">.</span><span class="n">petal_length</span><span class="p">,</span>
            <span class="n">model</span><span class="o">.</span><span class="n">petal_width</span>
        <span class="p">]]</span>

        <span class="n">species</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">predict_iris</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">IrisResponse</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/cinema&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">CinemaResponse</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Cinema&quot;</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">predict_cinema</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">CinemaModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cinema 売上予測エンドポイント&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">[[</span>
            <span class="n">model</span><span class="o">.</span><span class="n">sns1</span><span class="p">,</span>
            <span class="n">model</span><span class="o">.</span><span class="n">sns2</span><span class="p">,</span>
            <span class="n">model</span><span class="o">.</span><span class="n">actor</span><span class="p">,</span>
            <span class="n">model</span><span class="o">.</span><span class="n">original</span>
        <span class="p">]]</span>

        <span class="n">predicted_sales</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">predict_cinema</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">CinemaResponse</span><span class="p">(</span><span class="n">predicted_sales</span><span class="o">=</span><span class="n">predicted_sales</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/survived&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">SurvivedResponse</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Survived&quot;</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">predict_survived</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">SurvivedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Survived 生存予測エンドポイント&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">survived</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">predict_survived</span><span class="p">(</span>
            <span class="n">pclass</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">pclass</span><span class="p">,</span>
            <span class="n">age</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">age</span><span class="p">,</span>
            <span class="n">sex</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">sex</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">SurvivedResponse</span><span class="p">(</span><span class="n">survived</span><span class="o">=</span><span class="n">survived</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/boston&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">BostonResponse</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Boston&quot;</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">predict_boston</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">BostonModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Boston 住宅価格予測エンドポイント&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">predicted_price</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">predict_boston</span><span class="p">(</span>
            <span class="n">rm</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">rm</span><span class="p">,</span>
            <span class="n">lstat</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">lstat</span><span class="p">,</span>
            <span class="n">ptratio</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">ptratio</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">BostonResponse</span><span class="p">(</span><span class="n">predicted_price</span><span class="o">=</span><span class="n">predicted_price</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</code></pre></div>
<h3 id="_69">完全なコード実装<a class="headerlink" href="#_69" title="Permanent link">&para;</a></h3>
<p>これまでのステップで実装した全コードを整理します。</p>
<h4 id="appmodelspy">app/models.py（完全版）<a class="headerlink" href="#appmodelspy" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Pydantic モデル定義&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>

<span class="k">class</span><span class="w"> </span><span class="nc">IrisModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Iris 分類のリクエストモデル&quot;&quot;&quot;</span>
    <span class="n">sepal_length</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;がく片の長さ (cm)&quot;</span><span class="p">)</span>
    <span class="n">sepal_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;がく片の幅 (cm)&quot;</span><span class="p">)</span>
    <span class="n">petal_length</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;花弁の長さ (cm)&quot;</span><span class="p">)</span>
    <span class="n">petal_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;花弁の幅 (cm)&quot;</span><span class="p">)</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;json_schema_extra&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;examples&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;sepal_length&quot;</span><span class="p">:</span> <span class="mf">5.1</span><span class="p">,</span>
                    <span class="s2">&quot;sepal_width&quot;</span><span class="p">:</span> <span class="mf">3.5</span><span class="p">,</span>
                    <span class="s2">&quot;petal_length&quot;</span><span class="p">:</span> <span class="mf">1.4</span><span class="p">,</span>
                    <span class="s2">&quot;petal_width&quot;</span><span class="p">:</span> <span class="mf">0.2</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CinemaModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cinema 売上予測のリクエストモデル&quot;&quot;&quot;</span>
    <span class="n">sns1</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;SNS 言及数 1&quot;</span><span class="p">)</span>
    <span class="n">sns2</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;SNS 言及数 2&quot;</span><span class="p">)</span>
    <span class="n">actor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;主演俳優スコア (0-100)&quot;</span><span class="p">)</span>
    <span class="n">original</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;オリジナル作品フラグ (0 or 1)&quot;</span><span class="p">)</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;json_schema_extra&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;examples&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;sns1&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
                    <span class="s2">&quot;sns2&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                    <span class="s2">&quot;actor&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
                    <span class="s2">&quot;original&quot;</span><span class="p">:</span> <span class="mi">1</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SurvivedModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Survived 生存予測のリクエストモデル&quot;&quot;&quot;</span>
    <span class="n">pclass</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;客室クラス (1, 2, 3)&quot;</span><span class="p">)</span>
    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;年齢&quot;</span><span class="p">)</span>
    <span class="n">sex</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;male&quot;</span><span class="p">,</span> <span class="s2">&quot;female&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;性別 (male or female)&quot;</span><span class="p">)</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;json_schema_extra&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;examples&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;pclass&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                    <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
                    <span class="s2">&quot;sex&quot;</span><span class="p">:</span> <span class="s2">&quot;male&quot;</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BostonModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Boston 住宅価格予測のリクエストモデル&quot;&quot;&quot;</span>
    <span class="n">rm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;部屋数&quot;</span><span class="p">)</span>
    <span class="n">lstat</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;低所得者人口割合 (%)&quot;</span><span class="p">)</span>
    <span class="n">ptratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;生徒と教師の比率&quot;</span><span class="p">)</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;json_schema_extra&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;examples&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;rm&quot;</span><span class="p">:</span> <span class="mf">6.5</span><span class="p">,</span>
                    <span class="s2">&quot;lstat&quot;</span><span class="p">:</span> <span class="mf">4.98</span><span class="p">,</span>
                    <span class="s2">&quot;ptratio&quot;</span><span class="p">:</span> <span class="mf">15.3</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>
<h4 id="appdomainpy">app/domain.py（完全版）<a class="headerlink" href="#appdomainpy" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;ドメイン層：機械学習モデルの読み込みと予測&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="k">class</span><span class="w"> </span><span class="nc">IrisDomain</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Iris 分類ドメイン&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;model/iris.pkl&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">model_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_model</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;訓練済みモデルの読み込み&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model file not found: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;予測を実行</span>

<span class="sd">        Args:</span>
<span class="sd">            X: 特徴量のリスト [[sepal_length, sepal_width, petal_length, petal_width]]</span>

<span class="sd">        Returns:</span>
<span class="sd">            予測結果（種名）のリスト</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model not loaded&quot;</span><span class="p">)</span>

        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">predictions</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CinemaDomain</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cinema 売上予測ドメイン&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;model/cinema.pkl&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">model_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_model</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;訓練済みモデルの読み込み&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model file not found: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;予測を実行</span>

<span class="sd">        Args:</span>
<span class="sd">            X: 特徴量のリスト [[sns1, sns2, actor, original]]</span>

<span class="sd">        Returns:</span>
<span class="sd">            予測結果（売上）のリスト</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model not loaded&quot;</span><span class="p">)</span>

        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">predictions</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SurvivedDomain</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Survived 生存予測ドメイン&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;model/survived.pkl&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">model_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_model</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;訓練済みモデルの読み込み&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model file not found: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_dict</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;予測を実行</span>

<span class="sd">        Args:</span>
<span class="sd">            X_dict: 特徴量の辞書のリスト [{&quot;Pclass&quot;: 3, &quot;Age&quot;: 22, &quot;male&quot;: 1}]</span>

<span class="sd">        Returns:</span>
<span class="sd">            予測結果（0: 死亡, 1: 生存）のリスト</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model not loaded&quot;</span><span class="p">)</span>

        <span class="c1"># 辞書をDataFrameに変換</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_dict</span><span class="p">)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">predictions</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BostonDomain</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Boston 住宅価格予測ドメイン&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;model/boston.pkl&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">model_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_model</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;訓練済みモデルとスケーラーの読み込み&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">saved_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span> <span class="o">=</span> <span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;scaler_X&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span> <span class="o">=</span> <span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;scaler_y&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model file not found: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_dict</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;予測を実行</span>

<span class="sd">        Args:</span>
<span class="sd">            X_dict: 特徴量の辞書のリスト [{&quot;RM&quot;: 6.5, &quot;LSTAT&quot;: 4.98, &quot;PTRATIO&quot;: 15.3}]</span>

<span class="sd">        Returns:</span>
<span class="sd">            予測結果（住宅価格）のリスト</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model or scalers not loaded&quot;</span><span class="p">)</span>

        <span class="c1"># 辞書をDataFrameに変換</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_dict</span><span class="p">)</span>

        <span class="c1"># 特徴量エンジニアリング（訓練時と同じ処理）</span>
        <span class="n">X_engineered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_feature_engineering</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># 特徴量の標準化</span>
        <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_engineered</span><span class="p">)</span>

        <span class="c1"># 予測（標準化された値）</span>
        <span class="n">y_pred_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)</span>

        <span class="c1"># 予測結果を元のスケールに戻す</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_y</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">y_pred_scaled</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_feature_engineering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;特徴量エンジニアリング（2乗項と交互作用項の追加）&quot;&quot;&quot;</span>
        <span class="n">X_new</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># 2乗項の追加</span>
        <span class="n">X_new</span><span class="p">[</span><span class="s1">&#39;RM2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;RM&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">X_new</span><span class="p">[</span><span class="s1">&#39;LSTAT2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;LSTAT&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">X_new</span><span class="p">[</span><span class="s1">&#39;PTRATIO2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;PTRATIO&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="c1"># 交互作用項の追加</span>
        <span class="n">X_new</span><span class="p">[</span><span class="s1">&#39;RM * LSTAT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;RM&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;LSTAT&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">X_new</span>
</code></pre></div>
<h4 id="appservicepy">app/service.py（完全版）<a class="headerlink" href="#appservicepy" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;サービス層：ビジネスロジック&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.domain</span><span class="w"> </span><span class="kn">import</span> <span class="n">IrisDomain</span><span class="p">,</span> <span class="n">CinemaDomain</span><span class="p">,</span> <span class="n">SurvivedDomain</span><span class="p">,</span> <span class="n">BostonDomain</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MLService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;機械学習サービス層&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># 初回アクセス時にモデルを読み込み、以降は再利用（Lazy Loading）</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iris_domain</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IrisDomain</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cinema_domain</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CinemaDomain</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_survived_domain</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SurvivedDomain</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_boston_domain</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BostonDomain</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">iris_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IrisDomain</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lazy loading で IrisDomain を取得&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iris_domain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_iris_domain</span> <span class="o">=</span> <span class="n">IrisDomain</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iris_domain</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cinema_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CinemaDomain</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lazy loading で CinemaDomain を取得&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cinema_domain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cinema_domain</span> <span class="o">=</span> <span class="n">CinemaDomain</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cinema_domain</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">survived_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SurvivedDomain</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lazy loading で SurvivedDomain を取得&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_survived_domain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_survived_domain</span> <span class="o">=</span> <span class="n">SurvivedDomain</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_survived_domain</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">boston_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BostonDomain</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lazy loading で BostonDomain を取得&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boston_domain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_boston_domain</span> <span class="o">=</span> <span class="n">BostonDomain</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boston_domain</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict_iris</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iris 分類予測</span>

<span class="sd">        Args:</span>
<span class="sd">            features: [[sepal_length, sepal_width, petal_length, petal_width]]</span>

<span class="sd">        Returns:</span>
<span class="sd">            予測された種名</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iris_domain</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict_cinema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cinema 売上予測</span>

<span class="sd">        Args:</span>
<span class="sd">            features: [[sns1, sns2, actor, original]]</span>

<span class="sd">        Returns:</span>
<span class="sd">            予測された売上</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cinema_domain</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict_survived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pclass</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">age</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">sex</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Survived 生存予測</span>

<span class="sd">        Args:</span>
<span class="sd">            pclass: 客室クラス</span>
<span class="sd">            age: 年齢</span>
<span class="sd">            sex: 性別</span>

<span class="sd">        Returns:</span>
<span class="sd">            予測結果（0: 死亡, 1: 生存）</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># sex を male ダミー変数に変換</span>
        <span class="n">male</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">sex</span> <span class="o">==</span> <span class="s2">&quot;male&quot;</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="n">X_dict</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;Pclass&quot;</span><span class="p">:</span> <span class="n">pclass</span><span class="p">,</span> <span class="s2">&quot;Age&quot;</span><span class="p">:</span> <span class="n">age</span><span class="p">,</span> <span class="s2">&quot;male&quot;</span><span class="p">:</span> <span class="n">male</span><span class="p">}]</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">survived_domain</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict_boston</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rm</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">lstat</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ptratio</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Boston 住宅価格予測</span>

<span class="sd">        Args:</span>
<span class="sd">            rm: 部屋数</span>
<span class="sd">            lstat: 低所得者人口割合</span>
<span class="sd">            ptratio: 生徒と教師の比率</span>

<span class="sd">        Returns:</span>
<span class="sd">            予測された住宅価格</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">X_dict</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;RM&quot;</span><span class="p">:</span> <span class="n">rm</span><span class="p">,</span> <span class="s2">&quot;LSTAT&quot;</span><span class="p">:</span> <span class="n">lstat</span><span class="p">,</span> <span class="s2">&quot;PTRATIO&quot;</span><span class="p">:</span> <span class="n">ptratio</span><span class="p">}]</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boston_domain</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div>
<h4 id="appapplicationpy">app/application.py（完全版）<a class="headerlink" href="#appapplicationpy" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;アプリケーション層：FastAPI エンドポイント&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">IrisModel</span><span class="p">,</span> <span class="n">CinemaModel</span><span class="p">,</span> <span class="n">SurvivedModel</span><span class="p">,</span> <span class="n">BostonModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.service</span><span class="w"> </span><span class="kn">import</span> <span class="n">MLService</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Machine Learning API&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;TDD で構築した機械学習モデルの API&quot;</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="s2">&quot;1.0.0&quot;</span>
<span class="p">)</span>

<span class="n">service</span> <span class="o">=</span> <span class="n">MLService</span><span class="p">()</span>

<span class="c1"># レスポンスモデルの定義</span>
<span class="k">class</span><span class="w"> </span><span class="nc">IrisResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Iris 予測レスポンス&quot;&quot;&quot;</span>
    <span class="n">species</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CinemaResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cinema 予測レスポンス&quot;&quot;&quot;</span>
    <span class="n">predicted_sales</span><span class="p">:</span> <span class="nb">float</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SurvivedResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Survived 予測レスポンス&quot;&quot;&quot;</span>
    <span class="n">survived</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BostonResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Boston 予測レスポンス&quot;&quot;&quot;</span>
    <span class="n">predicted_price</span><span class="p">:</span> <span class="nb">float</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Root&quot;</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">root</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ルートエンドポイント&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Machine Learning API&quot;</span><span class="p">,</span>
        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;endpoints&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;/iris&quot;</span><span class="p">,</span> <span class="s2">&quot;/cinema&quot;</span><span class="p">,</span> <span class="s2">&quot;/survived&quot;</span><span class="p">,</span> <span class="s2">&quot;/boston&quot;</span><span class="p">],</span>
        <span class="s2">&quot;docs&quot;</span><span class="p">:</span> <span class="s2">&quot;/docs&quot;</span>
    <span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/health&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Health&quot;</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">health</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ヘルスチェックエンドポイント&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/iris&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">IrisResponse</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Iris&quot;</span><span class="p">],</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;アヤメの種類を分類&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">predict_iris</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">IrisModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Iris 分類エンドポイント</span>

<span class="sd">    Args:</span>
<span class="sd">        model: Iris の特徴量</span>

<span class="sd">    Returns:</span>
<span class="sd">        予測された種名</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">[[</span>
            <span class="n">model</span><span class="o">.</span><span class="n">sepal_length</span><span class="p">,</span>
            <span class="n">model</span><span class="o">.</span><span class="n">sepal_width</span><span class="p">,</span>
            <span class="n">model</span><span class="o">.</span><span class="n">petal_length</span><span class="p">,</span>
            <span class="n">model</span><span class="o">.</span><span class="n">petal_width</span>
        <span class="p">]]</span>

        <span class="n">species</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">predict_iris</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">IrisResponse</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/cinema&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">CinemaResponse</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Cinema&quot;</span><span class="p">],</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;映画の興行収入を予測&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">predict_cinema</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">CinemaModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cinema 売上予測エンドポイント</span>

<span class="sd">    Args:</span>
<span class="sd">        model: Cinema の特徴量</span>

<span class="sd">    Returns:</span>
<span class="sd">        予測された売上</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">[[</span>
            <span class="n">model</span><span class="o">.</span><span class="n">sns1</span><span class="p">,</span>
            <span class="n">model</span><span class="o">.</span><span class="n">sns2</span><span class="p">,</span>
            <span class="n">model</span><span class="o">.</span><span class="n">actor</span><span class="p">,</span>
            <span class="n">model</span><span class="o">.</span><span class="n">original</span>
        <span class="p">]]</span>

        <span class="n">predicted_sales</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">predict_cinema</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">CinemaResponse</span><span class="p">(</span><span class="n">predicted_sales</span><span class="o">=</span><span class="n">predicted_sales</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/survived&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">SurvivedResponse</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Survived&quot;</span><span class="p">],</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;タイタニック号での生存を予測&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">predict_survived</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">SurvivedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Survived 生存予測エンドポイント</span>

<span class="sd">    Args:</span>
<span class="sd">        model: Survived の特徴量</span>

<span class="sd">    Returns:</span>
<span class="sd">        予測結果（0: 死亡, 1: 生存）</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">survived</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">predict_survived</span><span class="p">(</span>
            <span class="n">pclass</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">pclass</span><span class="p">,</span>
            <span class="n">age</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">age</span><span class="p">,</span>
            <span class="n">sex</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">sex</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">SurvivedResponse</span><span class="p">(</span><span class="n">survived</span><span class="o">=</span><span class="n">survived</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/boston&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">BostonResponse</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Boston&quot;</span><span class="p">],</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;ボストン住宅価格を予測&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">predict_boston</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">BostonModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Boston 住宅価格予測エンドポイント</span>

<span class="sd">    Args:</span>
<span class="sd">        model: Boston の特徴量</span>

<span class="sd">    Returns:</span>
<span class="sd">        予測された住宅価格</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">predicted_price</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">predict_boston</span><span class="p">(</span>
            <span class="n">rm</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">rm</span><span class="p">,</span>
            <span class="n">lstat</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">lstat</span><span class="p">,</span>
            <span class="n">ptratio</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">ptratio</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">BostonResponse</span><span class="p">(</span><span class="n">predicted_price</span><span class="o">=</span><span class="n">predicted_price</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</code></pre></div>
<h3 id="api_1">実践的な API 使用例<a class="headerlink" href="#api_1" title="Permanent link">&para;</a></h3>
<h4 id="1-api">1. API サーバーの起動<a class="headerlink" href="#1-api" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># FastAPI サーバーを起動（開発モード）</span>
uvicorn<span class="w"> </span>app.application:app<span class="w"> </span>--reload

<span class="c1"># 出力:</span>
<span class="c1"># INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)</span>
<span class="c1"># INFO:     Started reloader process [xxxxx] using StatReload</span>
<span class="c1"># INFO:     Started server process [xxxxx]</span>
<span class="c1"># INFO:     Waiting for application startup.</span>
<span class="c1"># INFO:     Application startup complete.</span>
</code></pre></div>
<h4 id="2-swagger-ui">2. Swagger UI での確認<a class="headerlink" href="#2-swagger-ui" title="Permanent link">&para;</a></h4>
<p>ブラウザで <code>http://127.0.0.1:8000/docs</code> にアクセスすると、自動生成された API ドキュメントが表示されます。</p>
<div class="highlight"><pre><span></span><code>┌────────────────────────────────────────────────┐
│ Machine Learning API - Swagger UI              │
├────────────────────────────────────────────────┤
│                                                 │
│ GET  /          ルートエンドポイント            │
│ GET  /health    ヘルスチェック                  │
│                                                 │
│ POST /iris      アヤメの種類を分類              │
│ POST /cinema    映画の興行収入を予測            │
│ POST /survived  タイタニック号での生存を予測   │
│ POST /boston    ボストン住宅価格を予測          │
│                                                 │
│ [Try it out] ボタンでインタラクティブにテスト可能 │
└────────────────────────────────────────────────┘
</code></pre></div>
<h4 id="3-curl-api">3. curl による API テスト<a class="headerlink" href="#3-curl-api" title="Permanent link">&para;</a></h4>
<p><strong>Iris 分類</strong>:</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="s2">&quot;http://127.0.0.1:8000/iris&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">    &quot;sepal_length&quot;: 5.1,</span>
<span class="s1">    &quot;sepal_width&quot;: 3.5,</span>
<span class="s1">    &quot;petal_length&quot;: 1.4,</span>
<span class="s1">    &quot;petal_width&quot;: 0.2</span>
<span class="s1">  }&#39;</span>

<span class="c1"># レスポンス:</span>
<span class="c1"># {&quot;species&quot;:&quot;setosa&quot;}</span>
</code></pre></div>
<p><strong>Cinema 売上予測</strong>:</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="s2">&quot;http://127.0.0.1:8000/cinema&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">    &quot;sns1&quot;: 500,</span>
<span class="s1">    &quot;sns2&quot;: 300,</span>
<span class="s1">    &quot;actor&quot;: 70,</span>
<span class="s1">    &quot;original&quot;: 1</span>
<span class="s1">  }&#39;</span>

<span class="c1"># レスポンス:</span>
<span class="c1"># {&quot;predicted_sales&quot;:3254.72}</span>
</code></pre></div>
<p><strong>Survived 生存予測</strong>:</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="s2">&quot;http://127.0.0.1:8000/survived&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">    &quot;pclass&quot;: 3,</span>
<span class="s1">    &quot;age&quot;: 22,</span>
<span class="s1">    &quot;sex&quot;: &quot;male&quot;</span>
<span class="s1">  }&#39;</span>

<span class="c1"># レスポンス:</span>
<span class="c1"># {&quot;survived&quot;:0}</span>
</code></pre></div>
<p><strong>Boston 住宅価格予測</strong>:</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="s2">&quot;http://127.0.0.1:8000/boston&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">    &quot;rm&quot;: 6.5,</span>
<span class="s1">    &quot;lstat&quot;: 4.98,</span>
<span class="s1">    &quot;ptratio&quot;: 15.3</span>
<span class="s1">  }&#39;</span>

<span class="c1"># レスポンス:</span>
<span class="c1"># {&quot;predicted_price&quot;:32.45}</span>
</code></pre></div>
<h4 id="4-python">4. Python スクリプトからの利用<a class="headerlink" href="#4-python" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># api_client_example.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="n">BASE_URL</span> <span class="o">=</span> <span class="s2">&quot;http://127.0.0.1:8000&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">predict_iris</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Iris 分類の実行例&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s2">/iris&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;sepal_length&quot;</span><span class="p">:</span> <span class="mf">5.1</span><span class="p">,</span>
        <span class="s2">&quot;sepal_width&quot;</span><span class="p">:</span> <span class="mf">3.5</span><span class="p">,</span>
        <span class="s2">&quot;petal_length&quot;</span><span class="p">:</span> <span class="mf">1.4</span><span class="p">,</span>
        <span class="s2">&quot;petal_width&quot;</span><span class="p">:</span> <span class="mf">0.2</span>
    <span class="p">})</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iris 予測結果: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># 出力: Iris 予測結果: {&#39;species&#39;: &#39;setosa&#39;}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">predict_cinema</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cinema 売上予測の実行例&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s2">/cinema&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;sns1&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
        <span class="s2">&quot;sns2&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
        <span class="s2">&quot;actor&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
        <span class="s2">&quot;original&quot;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">})</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cinema 売上予測: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;predicted_sales&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> 万円&quot;</span><span class="p">)</span>
    <span class="c1"># 出力: Cinema 売上予測: 3254.72 万円</span>

<span class="k">def</span><span class="w"> </span><span class="nf">predict_survived</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Survived 生存予測の実行例&quot;&quot;&quot;</span>
    <span class="n">passengers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;pclass&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">:</span> <span class="s2">&quot;female&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;pclass&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">:</span> <span class="s2">&quot;male&quot;</span><span class="p">},</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">passenger</span> <span class="ow">in</span> <span class="n">passengers</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s2">/survived&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">passenger</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">survival_status</span> <span class="o">=</span> <span class="s2">&quot;生存&quot;</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;survived&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;死亡&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">passenger</span><span class="si">}</span><span class="s2"> → </span><span class="si">{</span><span class="n">survival_status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 出力:</span>
    <span class="c1"># {&#39;pclass&#39;: 1, &#39;age&#39;: 30, &#39;sex&#39;: &#39;female&#39;} → 生存</span>
    <span class="c1"># {&#39;pclass&#39;: 3, &#39;age&#39;: 22, &#39;sex&#39;: &#39;male&#39;} → 死亡</span>

<span class="k">def</span><span class="w"> </span><span class="nf">predict_boston</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Boston 住宅価格予測の実行例&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s2">/boston&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;rm&quot;</span><span class="p">:</span> <span class="mf">6.5</span><span class="p">,</span>
        <span class="s2">&quot;lstat&quot;</span><span class="p">:</span> <span class="mf">4.98</span><span class="p">,</span>
        <span class="s2">&quot;ptratio&quot;</span><span class="p">:</span> <span class="mf">15.3</span>
    <span class="p">})</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Boston 住宅価格予測: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;predicted_price&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">k&quot;</span><span class="p">)</span>
    <span class="c1"># 出力: Boston 住宅価格予測: $32.45k</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">predict_iris</span><span class="p">()</span>
    <span class="n">predict_cinema</span><span class="p">()</span>
    <span class="n">predict_survived</span><span class="p">()</span>
    <span class="n">predict_boston</span><span class="p">()</span>
</code></pre></div>
<p><strong>実行結果</strong>:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>python<span class="w"> </span>api_client_example.py
Iris<span class="w"> </span>予測結果:<span class="w"> </span><span class="o">{</span><span class="s1">&#39;species&#39;</span>:<span class="w"> </span><span class="s1">&#39;setosa&#39;</span><span class="o">}</span>
Cinema<span class="w"> </span>売上予測:<span class="w"> </span><span class="m">3254</span>.72<span class="w"> </span>万円
<span class="o">{</span><span class="s1">&#39;pclass&#39;</span>:<span class="w"> </span><span class="m">1</span>,<span class="w"> </span><span class="s1">&#39;age&#39;</span>:<span class="w"> </span><span class="m">30</span>,<span class="w"> </span><span class="s1">&#39;sex&#39;</span>:<span class="w"> </span><span class="s1">&#39;female&#39;</span><span class="o">}</span><span class="w"> </span>→<span class="w"> </span>生存
<span class="o">{</span><span class="s1">&#39;pclass&#39;</span>:<span class="w"> </span><span class="m">3</span>,<span class="w"> </span><span class="s1">&#39;age&#39;</span>:<span class="w"> </span><span class="m">22</span>,<span class="w"> </span><span class="s1">&#39;sex&#39;</span>:<span class="w"> </span><span class="s1">&#39;male&#39;</span><span class="o">}</span><span class="w"> </span>→<span class="w"> </span>死亡
Boston<span class="w"> </span>住宅価格予測:<span class="w"> </span><span class="nv">$32</span>.45k
</code></pre></div>
<hr />
<h3 id="8_1">📊 ８章の技術的成果<a class="headerlink" href="#8_1" title="Permanent link">&para;</a></h3>
<p>「ついに API システムが完成しました！」お疲れさまでした！８章で何を達成したか、振り返ってみましょう。</p>
<h4 id="_70">✅ テスト結果<a class="headerlink" href="#_70" title="Permanent link">&para;</a></h4>
<p>すべてのテストが通りました！</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-v<span class="w"> </span>--cov<span class="o">=</span>app<span class="w"> </span>--cov-report<span class="o">=</span>term-missing

<span class="o">==========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">==========================</span>
collected<span class="w"> </span><span class="m">25</span><span class="w"> </span>items

test/test_models.py::test_IrisModelの正常な値<span class="w"> </span>PASSED<span class="w">                </span><span class="o">[</span><span class="w"> </span><span class="m">4</span>%<span class="o">]</span>
test/test_models.py::test_IrisModelの負の値でエラー<span class="w"> </span>PASSED<span class="w">           </span><span class="o">[</span><span class="w"> </span><span class="m">8</span>%<span class="o">]</span>
test/test_models.py::test_CinemaModelの正常な値<span class="w"> </span>PASSED<span class="w">              </span><span class="o">[</span><span class="m">12</span>%<span class="o">]</span>
test/test_models.py::test_SurvivedModelの正常な値<span class="w"> </span>PASSED<span class="w">            </span><span class="o">[</span><span class="m">16</span>%<span class="o">]</span>
test/test_models.py::test_SurvivedModelの不正なsexでエラー<span class="w"> </span>PASSED<span class="w">   </span><span class="o">[</span><span class="m">20</span>%<span class="o">]</span>
test/test_models.py::test_BostonModelの正常な値<span class="w"> </span>PASSED<span class="w">              </span><span class="o">[</span><span class="m">24</span>%<span class="o">]</span>
test/test_domain.py::test_IrisDomainでモデルを読み込める<span class="w"> </span>PASSED<span class="w">     </span><span class="o">[</span><span class="m">28</span>%<span class="o">]</span>
test/test_domain.py::test_IrisDomainで予測ができる<span class="w"> </span>PASSED<span class="w">           </span><span class="o">[</span><span class="m">32</span>%<span class="o">]</span>
test/test_domain.py::test_CinemaDomainでモデルを読み込める<span class="w"> </span>PASSED<span class="w">   </span><span class="o">[</span><span class="m">36</span>%<span class="o">]</span>
test/test_domain.py::test_CinemaDomainで予測ができる<span class="w"> </span>PASSED<span class="w">         </span><span class="o">[</span><span class="m">40</span>%<span class="o">]</span>
test/test_domain.py::test_SurvivedDomainでモデルを読み込める<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="m">44</span>%<span class="o">]</span>
test/test_domain.py::test_SurvivedDomainで予測ができる<span class="w"> </span>PASSED<span class="w">       </span><span class="o">[</span><span class="m">48</span>%<span class="o">]</span>
test/test_domain.py::test_BostonDomainでモデルを読み込める<span class="w"> </span>PASSED<span class="w">   </span><span class="o">[</span><span class="m">52</span>%<span class="o">]</span>
test/test_domain.py::test_BostonDomainで予測ができる<span class="w"> </span>PASSED<span class="w">         </span><span class="o">[</span><span class="m">56</span>%<span class="o">]</span>
test/test_service.py::test_predict_iris<span class="w"> </span>PASSED<span class="w">                      </span><span class="o">[</span><span class="m">60</span>%<span class="o">]</span>
test/test_service.py::test_predict_cinema<span class="w"> </span>PASSED<span class="w">                    </span><span class="o">[</span><span class="m">64</span>%<span class="o">]</span>
test/test_service.py::test_predict_survived<span class="w"> </span>PASSED<span class="w">                  </span><span class="o">[</span><span class="m">68</span>%<span class="o">]</span>
test/test_service.py::test_predict_boston<span class="w"> </span>PASSED<span class="w">                    </span><span class="o">[</span><span class="m">72</span>%<span class="o">]</span>
test/test_application.py::test_Irisエンドポイントの正常系<span class="w"> </span>PASSED<span class="w">     </span><span class="o">[</span><span class="m">76</span>%<span class="o">]</span>
test/test_application.py::test_Irisエンドポイントの異常系<span class="w"> </span>PASSED<span class="w">     </span><span class="o">[</span><span class="m">80</span>%<span class="o">]</span>
test/test_application.py::test_Cinemaエンドポイントの正常系<span class="w"> </span>PASSED<span class="w">   </span><span class="o">[</span><span class="m">84</span>%<span class="o">]</span>
test/test_application.py::test_Survivedエンドポイントの正常系<span class="w"> </span>PASSED<span class="w"> </span><span class="o">[</span><span class="m">88</span>%<span class="o">]</span>
test/test_application.py::test_Bostonエンドポイントの正常系<span class="w"> </span>PASSED<span class="w">   </span><span class="o">[</span><span class="m">92</span>%<span class="o">]</span>
test/test_application.py::test_ルートエンドポイント<span class="w"> </span>PASSED<span class="w">           </span><span class="o">[</span><span class="m">96</span>%<span class="o">]</span>
test/test_application.py::test_ヘルスチェック<span class="w"> </span>PASSED<span class="w">                </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

----------<span class="w"> </span>coverage:<span class="w"> </span>platform<span class="w"> </span>win32,<span class="w"> </span>python<span class="w"> </span><span class="m">3</span>.12.0-final-0<span class="w"> </span>----------
Name<span class="w">                   </span>Stmts<span class="w">   </span>Miss<span class="w">  </span>Cover<span class="w">   </span>Missing
----------------------------------------------------
app/__init__.py<span class="w">            </span><span class="m">0</span><span class="w">      </span><span class="m">0</span><span class="w">   </span><span class="m">100</span>%
app/application.py<span class="w">        </span><span class="m">45</span><span class="w">      </span><span class="m">2</span><span class="w">    </span><span class="m">96</span>%<span class="w">   </span><span class="m">23</span>,<span class="w"> </span><span class="m">67</span>
app/domain.py<span class="w">             </span><span class="m">85</span><span class="w">      </span><span class="m">4</span><span class="w">    </span><span class="m">95</span>%<span class="w">   </span><span class="m">18</span>,<span class="w"> </span><span class="m">52</span>,<span class="w"> </span><span class="m">86</span>,<span class="w"> </span><span class="m">121</span>
app/models.py<span class="w">             </span><span class="m">20</span><span class="w">      </span><span class="m">0</span><span class="w">   </span><span class="m">100</span>%
app/service.py<span class="w">            </span><span class="m">38</span><span class="w">      </span><span class="m">1</span><span class="w">    </span><span class="m">97</span>%<span class="w">   </span><span class="m">58</span>
----------------------------------------------------
TOTAL<span class="w">                    </span><span class="m">188</span><span class="w">      </span><span class="m">7</span><span class="w">    </span><span class="m">96</span>%

<span class="o">==========================</span><span class="w"> </span><span class="m">25</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span>.23s<span class="w"> </span><span class="o">==========================</span>
</code></pre></div>
<p><strong>25 passed！</strong> 🎉 すべてのレイヤーでテストが通っています！</p>
<h4 id="_71">📈 定量的成果<a class="headerlink" href="#_71" title="Permanent link">&para;</a></h4>
<p>数字で見ると、こんなに達成しました！</p>
<table>
<thead>
<tr>
<th>指標</th>
<th>🎯 達成値</th>
<th>詳細</th>
</tr>
</thead>
<tbody>
<tr>
<td>🧪 <strong>テストケース数</strong></td>
<td><strong>25 個</strong></td>
<td>Pydantic (6) + Domain (8) + Service (4) + Application (7)</td>
</tr>
<tr>
<td>📊 <strong>コードカバレッジ</strong></td>
<td><strong>96%</strong></td>
<td>高い品質基準を達成！</td>
</tr>
<tr>
<td>🌐 <strong>API エンドポイント</strong></td>
<td><strong>6 個</strong></td>
<td>予測 API 4 個 + ヘルスチェック 2 個</td>
</tr>
<tr>
<td>⚡ <strong>レスポンス時間</strong></td>
<td><strong>&lt; 100ms</strong></td>
<td>高速なモデル推論</td>
</tr>
<tr>
<td>📚 <strong>自動ドキュメント</strong></td>
<td><strong>100%</strong></td>
<td>Swagger UI で完全にドキュメント化</td>
</tr>
</tbody>
</table>
<p><strong>カバレッジ 96%！</strong> これはプロダクションレベルの品質です！🎊</p>
<h4 id="_72">🎓 習得したスキル<a class="headerlink" href="#_72" title="Permanent link">&para;</a></h4>
<h5 id="1-web-api">1. 🌐 Web API 開発<a class="headerlink" href="#1-web-api" title="Permanent link">&para;</a></h5>
<ul>
<li>✅ FastAPI によるモダンな API 開発</li>
<li>✅ Pydantic による型安全なデータ検証</li>
<li>✅ OpenAPI 仕様の自動生成</li>
</ul>
<h5 id="2_8">2. 🏗️ アーキテクチャパターン<a class="headerlink" href="#2_8" title="Permanent link">&para;</a></h5>
<ul>
<li>✅ レイヤードアーキテクチャの実践（3 層分離）</li>
<li>✅ Lazy Loading パターン</li>
<li>✅ Repository パターン（ドメイン層）</li>
</ul>
<h5 id="3_7">3. 🚀 本番運用スキル<a class="headerlink" href="#3_7" title="Permanent link">&para;</a></h5>
<ul>
<li>✅ pickle によるモデルの永続化と読み込み</li>
<li>✅ エラーハンドリングとロギング</li>
<li>✅ ヘルスチェックエンドポイントの実装</li>
</ul>
<h5 id="4_7">4. 🧪 テスト戦略<a class="headerlink" href="#4_7" title="Permanent link">&para;</a></h5>
<ul>
<li>✅ 統合テスト（FastAPI TestClient）</li>
<li>✅ 各層のユニットテスト</li>
<li>✅ バリデーションテスト</li>
</ul>
<hr />
<hr />
<h2 id="_73">🎊 プロジェクト全体のまとめ<a class="headerlink" href="#_73" title="Permanent link">&para;</a></h2>
<p>「ついにここまで来ました！」お疲れさまでした！振り返ってみると、すごい量のことを学びましたね。</p>
<p>このプロジェクトを通じて、<strong>機械学習の基礎から Web API 構築まで</strong>、段階的にスキルを習得してきました。あなたの成長を数字で見てみましょう！</p>
<h3 id="_74">📊 あなたが達成したこと（定量的成果）<a class="headerlink" href="#_74" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>指標</th>
<th>🎯 達成値</th>
<th>詳細</th>
</tr>
</thead>
<tbody>
<tr>
<td>🧪 <strong>総テストケース数</strong></td>
<td><strong>84 個</strong></td>
<td>２章 (9) + ４章 (9) + ５章 (11) + ６章 (13) + ７章 (17) + ８章 (25)</td>
</tr>
<tr>
<td>📊 <strong>平均コードカバレッジ</strong></td>
<td><strong>94%</strong></td>
<td>全ての章で 90% 以上を達成！</td>
</tr>
<tr>
<td>🤖 <strong>完成モデル数</strong></td>
<td><strong>4 本</strong></td>
<td>Iris、Cinema、Survived、Boston の実用モデル</td>
</tr>
<tr>
<td>🌐 <strong>API エンドポイント数</strong></td>
<td><strong>6 個</strong></td>
<td>予測 API 4 個 + ヘルスチェック 2 個</td>
</tr>
<tr>
<td>📝 <strong>総コード行数</strong></td>
<td><strong>約 1,500 行</strong></td>
<td>高品質で保守性の高いコードベース</td>
</tr>
<tr>
<td>🔄 <strong>TDD サイクル実践回数</strong></td>
<td><strong>約 30 回</strong></td>
<td>Red-Green-Refactor を徹底的に実践</td>
</tr>
</tbody>
</table>
<p><strong>すごいですよね！</strong> これだけのコードを TDD で書いたんです！</p>
<h3 id="_75">📚 各章で達成したこと<a class="headerlink" href="#_75" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>章</th>
<th>🧪 テスト数</th>
<th>📊 カバレッジ</th>
<th>🎯 主要成果</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>２章 基礎準備</strong></td>
<td>9 個</td>
<td>100%</td>
<td>DataLoader、プロジェクト構造、品質管理ツール</td>
</tr>
<tr>
<td><strong>４章 Iris 分類</strong></td>
<td>9 個</td>
<td>95%</td>
<td>決定木分類、欠損値補完、<strong>97.78% 精度</strong>達成</td>
</tr>
<tr>
<td><strong>５章 Cinema 回帰</strong></td>
<td>11 個</td>
<td>92%</td>
<td>線形回帰、外れ値除去、<strong>R²=0.8383</strong> 達成</td>
</tr>
<tr>
<td><strong>６章 Survived 分類</strong></td>
<td>13 個</td>
<td>90%</td>
<td>グループ別補完、ダミー変数、<strong>83.24% 精度</strong>達成</td>
</tr>
<tr>
<td><strong>７章 Boston 回帰</strong></td>
<td>17 個</td>
<td>94%</td>
<td>特徴量エンジニアリング、標準化、<strong>R²=0.8313</strong> 達成</td>
</tr>
<tr>
<td><strong>８章 API 化</strong></td>
<td>25 個</td>
<td>96%</td>
<td>FastAPI、レイヤードアーキテクチャ、Swagger UI</td>
</tr>
</tbody>
</table>
<h3 id="_76">🎓 あなたが習得したスキル全体像<a class="headerlink" href="#_76" title="Permanent link">&para;</a></h3>
<p>「こんなに学んだの！？」そうです！リストにしてみると、本当にたくさんのスキルを習得しました！</p>
<h4 id="1-tdd_4">1. 🔄 テスト駆動開発（TDD）マスタリー<a class="headerlink" href="#1-tdd_4" title="Permanent link">&para;</a></h4>
<ul>
<li>✅ <strong>Red-Green-Refactor サイクルの完全習得</strong> - 約 30 サイクル実践</li>
<li>✅ <strong>テストファースト思考の習慣化</strong> - 実装よりテストを先に書く</li>
<li>✅ <strong>継続的リファクタリング</strong> - テストがあるから安心して改善できる</li>
<li>✅ <strong>pytest による包括的テストスイート構築</strong> - 自動テストの力を実感</li>
</ul>
<h4 id="2-python">2. 🐍 モダン Python 開発の完全習得<a class="headerlink" href="#2-python" title="Permanent link">&para;</a></h4>
<ul>
<li>✅ <strong>型ヒント完全活用</strong> - 100% カバレッジで型安全性確保</li>
<li>✅ <strong>現代的ツールチェーン</strong> - uv、Ruff、mypy の使いこなし</li>
<li>✅ <strong>Pydantic によるデータ検証</strong> - 強力なバリデーション機能</li>
<li>✅ <strong>FastAPI によるモダンな Web API 開発</strong> - 最速・最新のフレームワーク</li>
</ul>
<h4 id="3_8">3. 🤖 機械学習基礎の確立<a class="headerlink" href="#3_8" title="Permanent link">&para;</a></h4>
<ul>
<li>🌸 <strong>分類問題</strong>: 決定木（Iris、Survived）</li>
<li>📊 <strong>回帰問題</strong>: 線形回帰（Cinema、Boston）</li>
<li>🔧 <strong>データ前処理</strong>: 欠損値補完、外れ値除去、標準化、ダミー変数化</li>
<li>📈 <strong>モデル評価</strong>: Accuracy、R² Score、MAE、RMSE</li>
<li>⚙️ <strong>特徴量エンジニアリング</strong>: 2 乗項、交互作用項</li>
<li>⚖️ <strong>クラス不均衡対応</strong>: class_weight='balanced'</li>
<li>🛡️ <strong>データリーケージ防止</strong>: 訓練とテストの厳密な分離</li>
</ul>
<h4 id="4_8">4. 🏗️ ソフトウェア工学実践<a class="headerlink" href="#4_8" title="Permanent link">&para;</a></h4>
<ul>
<li>🏛️ <strong>アーキテクチャ設計</strong>: レイヤードアーキテクチャ（Application/Service/Domain）</li>
<li>🎨 <strong>デザインパターン</strong>: Lazy Loading、Repository パターン</li>
<li>✅ <strong>品質管理</strong>: 定量的品質指標、継続的インテグレーション</li>
<li>🌐 <strong>API 設計</strong>: RESTful API、OpenAPI 仕様、Swagger UI</li>
<li>⚠️ <strong>エラーハンドリング</strong>: 適切な例外処理とエラーメッセージ</li>
</ul>
<h3 id="_77">📈 あなたの成長ストーリー<a class="headerlink" href="#_77" title="Permanent link">&para;</a></h3>
<p>「振り返ってみると、こんなに成長したんだ！」と実感できるように、3 つのフェーズで学習内容がどう進化したか見てみましょう。</p>
<h4 id="phase-124">🌱 Phase 1（２章・４章）: 基礎構造確立<a class="headerlink" href="#phase-124" title="Permanent link">&para;</a></h4>
<p><strong>最初はシンプルに！</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># シンプルな分類モデル</span>
<span class="k">class</span><span class="w"> </span><span class="nc">IrisClassifier</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span> <span class="k">pass</span>      <span class="c1"># データ読み込み</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">):</span> <span class="k">pass</span>   <span class="c1"># モデル訓練</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">):</span> <span class="k">pass</span>           <span class="c1"># 予測</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">):</span> <span class="k">pass</span>  <span class="c1"># 評価</span>
</code></pre></div>
<p><strong>🎯 達成レベル</strong>: 機械学習の基本フローを理解！</p>
<h4 id="phase-256">🌿 Phase 2（５章・６章）: 複雑化対応<a class="headerlink" href="#phase-256" title="Permanent link">&para;</a></h4>
<p><strong>実務レベルの前処理を習得！</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># データ前処理の追加</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SurvivedClassifier</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_preprocess_age</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span> <span class="k">pass</span>      <span class="c1"># グループ別補完（高度！）</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_encode_categorical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span> <span class="k">pass</span>  <span class="c1"># ダミー変数化</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">):</span> <span class="k">pass</span>  <span class="c1"># モデル訓練</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">):</span> <span class="k">pass</span>          <span class="c1"># 予測</span>
</code></pre></div>
<p><strong>🎯 達成レベル</strong>: 実務レベルのデータ処理技術を習得！</p>
<h4 id="phase-378">🌳 Phase 3（７章・８章）: 統合システム<a class="headerlink" href="#phase-378" title="Permanent link">&para;</a></h4>
<p><strong>プロレベルの API システム構築！</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># API 化と統合</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MLService</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iris_domain</span> <span class="o">=</span> <span class="n">IrisDomain</span><span class="p">()</span>         <span class="c1"># Iris モデル</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cinema_domain</span> <span class="o">=</span> <span class="n">CinemaDomain</span><span class="p">()</span>     <span class="c1"># Cinema モデル</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">survived_domain</span> <span class="o">=</span> <span class="n">SurvivedDomain</span><span class="p">()</span> <span class="c1"># Survived モデル</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boston_domain</span> <span class="o">=</span> <span class="n">BostonDomain</span><span class="p">()</span>     <span class="c1"># Boston モデル</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict_iris</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span> <span class="k">pass</span>         <span class="c1"># Iris 予測 API</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict_cinema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span> <span class="k">pass</span>       <span class="c1"># Cinema 予測 API</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict_survived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pclass</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">sex</span><span class="p">):</span> <span class="k">pass</span>  <span class="c1"># Survived 予測 API</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict_boston</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span> <span class="n">lstat</span><span class="p">,</span> <span class="n">ptratio</span><span class="p">):</span> <span class="k">pass</span>  <span class="c1"># Boston 予測 API</span>
</code></pre></div>
<p><strong>🎯 達成レベル</strong>: 本番環境レディな API システム構築！</p>
<p><strong>すごい成長ですよね！</strong> 最初はシンプルな分類モデルだったのが、最後には 4 つのモデルを統合した本格的な API システムまで作れるようになりました！</p>
<h3 id="_78">🚀 これからのあなたへ<a class="headerlink" href="#_78" title="Permanent link">&para;</a></h3>
<p>「学んだことは、実際にどう使えるの？」良い質問です！習得したスキルは、すぐに実務で使えます！</p>
<h4 id="_79">💼 業務で即使えるスキル<a class="headerlink" href="#_79" title="Permanent link">&para;</a></h4>
<p><strong>🔄 テスト駆動開発</strong>
- ✅ 企業開発で求められる品質管理手法
- ✅ 安全なリファクタリング技術
- ✅ 継続的インテグレーション対応</p>
<p><strong>🤖 機械学習実装</strong>
- ✅ データ前処理からモデル訓練までの完全フロー
- ✅ モデルの評価と改善プロセス
- ✅ 本番環境へのデプロイメント技術</p>
<p><strong>🌐 Web API 開発</strong>
- ✅ RESTful API 設計とドキュメント化
- ✅ レイヤードアーキテクチャによる保守性確保
- ✅ エラーハンドリングとバリデーション</p>
<h4 id="_80">🌟 今後の発展可能性<a class="headerlink" href="#_80" title="Permanent link">&para;</a></h4>
<p>「次は何を学べばいいの？」ここから先は、あなたの興味に応じて、こんな方向に進めます！</p>
<p><strong>🔬 技術的拡張方向</strong>
1. 🧠 <strong>高度なモデル</strong> - ディープラーニング（TensorFlow、PyTorch）、アンサンブル学習
2. 🔧 <strong>MLOps</strong> - モデルバージョニング、A/B テスト、モデル監視
3. 📈 <strong>スケーリング</strong> - バッチ予測、リアルタイム推論、分散処理</p>
<p><strong>💼 ビジネス適用</strong>
1. 📊 <strong>実業務適用</strong> - 顧客行動予測、需要予測、不正検知
2. 🚀 <strong>プロダクト化</strong> - SaaS としての機械学習 API サービス
3. 🏢 <strong>データ分析基盤</strong> - 企業内データ分析プラットフォームの構築</p>
<p><strong>📚 教育・コミュニティ活用</strong>
1. 👨‍🏫 <strong>教育教材</strong> - データサイエンス講座の実践教材
2. <strong>オープンソース</strong>: コミュニティによる機能拡張
3. <strong>企業研修</strong>: 機械学習エンジニア育成プログラム</p>
<h3 id="_81">🏆 このプロジェクトの特別なところ<a class="headerlink" href="#_81" title="Permanent link">&para;</a></h3>
<p>「他のチュートリアルと何が違うの？」良い質問です！このプロジェクトは、<strong>テスト駆動開発と機械学習を同時に学べる</strong>、とてもユニークな教材なんです！</p>
<h4 id="_82">💎 成功要因<a class="headerlink" href="#_82" title="Permanent link">&para;</a></h4>
<ol>
<li>📚 <strong>段階的学習設計</strong> - ２章から８章への無理のないスキルアップ曲線</li>
<li>🎯 <strong>実践的アプローチ</strong> - 理論ではなく実際に動作するモデルで学習</li>
<li>✅ <strong>品質重視</strong> - 高い品質基準（カバレッジ 90% 以上）で学習効果を最大化</li>
<li>📖 <strong>包括的ドキュメント</strong> - 再現可能で持続的な学習プロセス</li>
</ol>
<h4 id="_83">⭐ 他のチュートリアルとの違い<a class="headerlink" href="#_83" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>一般的な機械学習チュートリアル</th>
<th>🎉 このプロジェクト</th>
</tr>
</thead>
<tbody>
<tr>
<td>Jupyter Notebook で完結</td>
<td><strong>TDD + 本番レディな API</strong></td>
</tr>
<tr>
<td>モデル訓練のみ</td>
<td><strong>データ処理から API 化まで完全フロー</strong></td>
</tr>
<tr>
<td>テストなし</td>
<td><strong>84 個のテストケース、94% カバレッジ</strong></td>
</tr>
<tr>
<td>単一モデル</td>
<td><strong>4 つの異なる問題を段階的に解決</strong></td>
</tr>
<tr>
<td>型ヒントなし</td>
<td><strong>完全な型安全性</strong></td>
</tr>
<tr>
<td>ドキュメント不足</td>
<td><strong>詳細な実装ガイド + Swagger UI</strong></td>
</tr>
</tbody>
</table>
<h3 id="_84">🎓 最後に<a class="headerlink" href="#_84" title="Permanent link">&para;</a></h3>
<p><strong>おめでとうございます！</strong> 🎊</p>
<p>このプロジェクトを完了したあなたは、以下を手に入れました：</p>
<p>✅ <strong>即実践可能な TDD スキル</strong> - 業務レベルでの品質開発手法
✅ <strong>機械学習の実用基礎</strong> - データサイエンス業界への参入基盤
✅ <strong>モダン Python 開発力</strong> - 現場で求められる最新技術スタック
✅ <strong>継続的改善マインド</strong> - 品質と効率を両立する開発思考
✅ <strong>本番運用知識</strong> - 実際のプロダクト開発に必要な包括的知識</p>
<p><strong>あなたは今、Python TDD 機械学習開発マスターへの道を歩み始めました！</strong> ✨</p>
<p>この学びを活かして、あなただけの素晴らしいプロダクトを作ってください！</p>
<hr />
<h3 id="_85">次のステップ<a class="headerlink" href="#_85" title="Permanent link">&para;</a></h3>
<p>このプロジェクトを完了した後の推奨学習パスです：</p>
<h4 id="1_6">1. 実践課題<a class="headerlink" href="#1_6" title="Permanent link">&para;</a></h4>
<p><strong>初級課題（1-2週間）</strong>:
- Kaggle の Titanic コンペティションに TDD でチャレンジ
- 既存の 4モデルに新しい特徴量を追加してモデル改善
- API に認証機能（JWT）を追加</p>
<p><strong>中級課題（2-4週間）</strong>:
- 時系列データ（株価予測、需要予測）の機械学習モデル開発
- アンサンブル学習（Random Forest、XGBoost）の実装
- Docker によるコンテナ化と CI/CD パイプラインの構築</p>
<p><strong>上級課題（1-2ヶ月）</strong>:
- ディープラーニング（TensorFlow/PyTorch）への拡張
- MLOps ツール（MLflow、DVC）の導入
- 本番環境へのデプロイ（AWS Lambda、GCP Cloud Run）</p>
<h4 id="2_9">2. 推奨学習リソース<a class="headerlink" href="#2_9" title="Permanent link">&para;</a></h4>
<p><strong>書籍</strong>:
- 『Python ではじめる機械学習』（Andreas C. Müller、Sarah Guido 著）
- 『テスト駆動開発』（Kent Beck 著）
- 『Clean Architecture』（Robert C. Martin 著）</p>
<p><strong>オンラインコース</strong>:
- <a href="https://www.coursera.org/specializations/machine-learning-introduction">Coursera: Machine Learning Specialization</a>
- <a href="https://course.fast.ai/">fast.ai: Practical Deep Learning</a>
- <a href="https://www.coursera.org/specializations/machine-learning-engineering-for-production-mlops">MLOps Specialization</a></p>
<p><strong>コミュニティ</strong>:
- <a href="https://www.kaggle.com/">Kaggle</a>: 機械学習コンペティション
- <a href="https://pydata.org/">PyData</a>: Python データサイエンスコミュニティ
- <a href="https://paperswithcode.com/">ML Papers</a>: 最新の機械学習論文と実装</p>
<h4 id="3_9">3. キャリアパス<a class="headerlink" href="#3_9" title="Permanent link">&para;</a></h4>
<p>本プロジェクトのスキルセットは以下の職種に直結します：</p>
<ul>
<li><strong>機械学習エンジニア</strong>: モデル開発とデプロイ</li>
<li><strong>データサイエンティスト</strong>: データ分析とビジネス価値創出</li>
<li><strong>MLOps エンジニア</strong>: ML システムの運用と最適化</li>
<li><strong>バックエンドエンジニア（ML 特化）</strong>: API 開発とシステム統合</li>
</ul>
<hr />
<h3 id="_86">参考資料<a class="headerlink" href="#_86" title="Permanent link">&para;</a></h3>
<p><strong>公式ドキュメント</strong>:
- <a href="https://scikit-learn.org/">scikit-learn 公式ドキュメント</a>
- <a href="https://fastapi.tiangolo.com/">FastAPI 公式ドキュメント</a>
- <a href="https://pandas.pydata.org/">pandas 公式ドキュメント</a>
- <a href="https://docs.pydantic.dev/">Pydantic 公式ドキュメント</a></p>
<p><strong>開発ツール</strong>:
- <a href="https://github.com/astral-sh/uv">uv パッケージマネージャー</a>
- <a href="https://docs.astral.sh/ruff/">Ruff 公式ドキュメント</a>
- <a href="https://mypy.readthedocs.io/">mypy 公式ドキュメント</a>
- <a href="https://docs.pytest.org/">pytest 公式ドキュメント</a></p>
<p><strong>プロジェクト作成日</strong>: 2025年10月18日</p>
<hr />
<p><strong>Simple made easy.</strong> 🎉</p>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/k2works" target="_blank" rel="noopener" title="GitHub Repository/claude-code-booster" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../docs/assets/js/extra.js"></script>
      
    
  </body>
</html>