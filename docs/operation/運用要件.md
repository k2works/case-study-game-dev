# 運用要件定義

## 概要

ぷよぷよゲームの開発から本番運用まで、継続的な品質向上とスムーズな運用を実現するための要件を定義します。

## CI/CDパイプライン設計

```plantuml
@startuml "CI/CDパイプライン"

|開発者|
start
:コード変更;
:git commit;
:git push;

|GitHub|
:Pull Request作成;

|GitHub Actions|
:依存関係インストール;
:リント実行;
:型チェック;
:単体テスト実行;
:統合テスト実行;
:ビルド実行;
:カバレッジレポート;

if (全チェック合格?) then (yes)
  |レビュアー|
  :コードレビュー;
  
  if (承認?) then (yes)
    |GitHub|
    :mainブランチにマージ;
    
    |GitHub Actions|
    :本番ビルド作成;
    :E2Eテスト実行;
    :Vercelへデプロイ;
    :デプロイ完了通知;
  else (no)
    :修正依頼;
    stop
  endif
else (no)
  :エラー通知;
  stop
endif

|本番環境|
:アプリケーション公開;
stop

@enduml
```

### GitHub Actions設定

```yaml
# .github/workflows/ci.yml
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        run: npm run lint
      
      - name: Run type check
        run: npm run type-check
      
      - name: Run tests
        run: npm run test:ci
      
      - name: Build application
        run: npm run build
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3

  deploy:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
```

## 環境構成

### 環境一覧

| 環境 | 用途 | URL | 自動デプロイ |
|------|------|-----|-------------|
| Local | 開発 | http://localhost:5173 | - |
| Preview | PR確認 | https://pr-*.vercel.app | PR作成時 |
| Staging | 統合テスト | https://staging.puyo.app | developマージ時 |
| Production | 本番 | https://puyo.app | mainマージ時 |

### 環境変数管理

```typescript
// 環境変数定義
interface EnvConfig {
  NODE_ENV: 'development' | 'staging' | 'production';
  VITE_API_URL: string;
  VITE_GA_ID?: string;
  VITE_SENTRY_DSN?: string;
}

// .env.example
NODE_ENV=development
VITE_API_URL=http://localhost:3000
VITE_GA_ID=
VITE_SENTRY_DSN=
```

## 監視・観測戦略

### アプリケーション監視

```plantuml
@startuml "監視アーキテクチャ"

actor User
cloud "本番環境" {
  node "Vercel" {
    component "ぷよぷよApp"
  }
}

cloud "監視サービス" {
  database "Google Analytics" as GA
  database "Sentry" as Sentry
  database "Vercel Analytics" as VA
}

User --> ぷよぷよApp : プレイ
ぷよぷよApp --> GA : ユーザー行動
ぷよぷよApp --> Sentry : エラー情報
ぷよぷよApp --> VA : パフォーマンス

@enduml
```

### 監視項目

| カテゴリ | 項目 | ツール | アラート条件 |
|---------|------|--------|-------------|
| パフォーマンス | FPS | Web Vitals | < 30 FPS |
| パフォーマンス | 応答時間 | Vercel Analytics | > 3秒 |
| エラー | JSエラー | Sentry | エラー率 > 1% |
| 利用状況 | DAU/MAU | Google Analytics | - |
| 可用性 | アップタイム | Vercel | < 99.9% |

### ログ収集

```typescript
// ログ設定
class Logger {
  error(message: string, context?: any) {
    console.error(message, context);
    Sentry.captureException(new Error(message), { extra: context });
  }
  
  warn(message: string, context?: any) {
    console.warn(message, context);
    if (process.env.NODE_ENV === 'production') {
      Sentry.captureMessage(message, 'warning');
    }
  }
  
  info(message: string, context?: any) {
    console.info(message, context);
  }
}
```

## デプロイメント手順

### 自動デプロイフロー

```plantuml
@startuml "デプロイフロー"

start
:mainブランチへpush/merge;

:GitHub Actions起動;

:テストスイート実行;
if (テスト成功?) then (yes)
  :本番ビルド作成;
  :Vercelへデプロイ;
  :ヘルスチェック;
  
  if (正常動作?) then (yes)
    :デプロイ完了;
    :Slack通知;
  else (no)
    :ロールバック;
    :エラー通知;
  endif
else (no)
  :デプロイ中止;
  :エラー通知;
endif

stop

@enduml
```

### 手動デプロイ手順

```bash
# 1. 最新のmainブランチを取得
git checkout main
git pull origin main

# 2. ビルドとテスト
npm install
npm run test
npm run build

# 3. Vercelデプロイ
vercel --prod

# 4. 動作確認
# https://puyo.app にアクセスして確認
```

## 運用手順書

### 日次運用

| 時刻 | 作業内容 | 担当 |
|------|---------|------|
| 09:00 | 監視ダッシュボード確認 | 運用担当 |
| 09:30 | エラーログ確認・対応 | 開発担当 |
| 17:00 | 日次レポート作成 | 運用担当 |

### 週次運用

- パフォーマンスレポート分析
- セキュリティアップデート確認
- 依存関係の更新

### 月次運用

- 利用統計レポート作成
- インフラコスト分析
- キャパシティプランニング

## インシデント対応

### インシデントレベル

| レベル | 定義 | 対応時間 | 例 |
|--------|------|----------|-----|
| Critical | サービス停止 | 30分以内 | アプリが起動しない |
| High | 主要機能障害 | 2時間以内 | ゲームプレイ不可 |
| Medium | 一部機能障害 | 24時間以内 | スコア表示異常 |
| Low | 軽微な不具合 | 1週間以内 | UIの軽微なずれ |

### 対応フロー

```plantuml
@startuml "インシデント対応"

start
:インシデント検知;
:レベル判定;

switch (レベル)
case (Critical)
  :即時対応開始;
  :影響範囲確認;
  :暫定対応;
  :根本原因調査;
case (High)
  :2時間以内に対応;
  :回避策検討;
case (Medium/Low)
  :次回リリースで対応;
endswitch

:対応実施;
:動作確認;
:インシデントレポート作成;
:再発防止策検討;

stop

@enduml
```

## バックアップ・復旧計画

### バックアップ対象

| 対象 | 頻度 | 保持期間 | 保存先 |
|------|------|----------|--------|
| ソースコード | 即時 | 永続 | GitHub |
| 環境設定 | 変更時 | 30日 | GitHub Secrets |
| ユーザーデータ | - | - | ローカルストレージ |

### 災害復旧手順

1. **サービス停止時**
   ```bash
   # Vercelの別リージョンへ再デプロイ
   vercel --prod --regions sfo1
   ```

2. **データ喪失時**
   - ユーザーデータ: ローカルストレージのため復旧不要
   - アプリケーション: GitHubから再デプロイ

3. **セキュリティインシデント**
   - 即座にアクセス制限
   - 影響範囲の調査
   - パッチ適用とredeployment

## 開発フロー（Git Flow）

```plantuml
@startuml "Git Flow"

state "main" as main #LightBlue
state "develop" as develop #LightGreen
state "feature/*" as feature #Yellow
state "release/*" as release #Orange
state "hotfix/*" as hotfix #Pink

[*] --> main
main --> develop : ブランチ作成
develop --> feature : 機能開発
feature --> develop : マージ
develop --> release : リリース準備
release --> main : リリース
release --> develop : バックマージ
main --> hotfix : 緊急修正
hotfix --> main : 修正リリース
hotfix --> develop : バックマージ

@enduml
```

### ブランチ戦略

| ブランチ | 用途 | マージ先 | 命名規則 |
|---------|------|----------|----------|
| main | 本番環境 | - | main |
| develop | 開発統合 | main | develop |
| feature/* | 機能開発 | develop | feature/機能名 |
| release/* | リリース準備 | main, develop | release/バージョン |
| hotfix/* | 緊急修正 | main, develop | hotfix/修正内容 |

### コミットメッセージ規約

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type:**

- feat: 新機能
- fix: バグ修正
- docs: ドキュメント
- style: フォーマット
- refactor: リファクタリング
- test: テスト
- chore: ビルド・補助ツール

**例:**
```
feat(game): 連鎖ボーナス計算の実装

4連鎖以上で特別ボーナスが付与される機能を追加
- 連鎖数に応じた倍率計算
- アニメーション演出の追加

Closes #123
```