# テスト戦略

## 概要

ぷよぷよゲームプロジェクトのテスト戦略について説明します。TDD（テスト駆動開発）開発サイクルを基盤とし、ピラミッド形のテスト戦略を採用します。テストライブラリには、Viteエコシステムとの親和性が高く、関数型プログラミングに適したVitest + React Testing Libraryの組み合わせを使用します。

## テスト戦略の基本方針

### TDD開発サイクル

```plantuml
@startuml "TDD開発サイクル"
start

:TODOリスト作成;

repeat
  :失敗テスト作成 (Red);
  note right
    - テストを先に書く
    - テストが失敗することを確認
    - 必要最小限のテストケース
  end note
  
  :最小実装 (Green);
  note right
    - テストが通る最小限のコード
    - 品質より速度優先
    - 動作確認が目標
  end note
  
  :リファクタリング (Refactor);
  note right
    - コードの重複除去
    - 設計の改善
    - テストが通り続けることを確認
  end note
  
  :品質チェック;
  note right
    - ESLint実行
    - TypeScriptエラーチェック
    - ビルド確認
  end note
  
  if (品質OK?) then (yes)
    :コミット;
  else (no)
    :修正;
  endif

repeat while (TODO完了?)

stop
@enduml
```

## テストピラミッド戦略

```plantuml
@startuml "テストピラミッド"
!define UNIT_COLOR #90EE90
!define INTEGRATION_COLOR #FFD700
!define E2E_COLOR #FF6347

skinparam shadowing false

package "E2E Tests (少数・高価値)" E2E_COLOR {
  [ユーザーシナリオテスト]
  [ブラウザ自動化テスト]
  [クロスブラウザテスト]
}

package "Integration Tests (中程度)" INTEGRATION_COLOR {
  [コンポーネント統合テスト]
  [サービス層テスト]
  [API統合テスト]
  [ストレージ統合テスト]
}

package "Unit Tests (多数・高速)" UNIT_COLOR {
  [ドメインモデルテスト]
  [純粋関数テスト]
  [コンポーネントテスト]
  [ユーティリティテスト]
}

[E2E Tests (少数・高価値)] --> [Integration Tests (中程度)]
[Integration Tests (中程度)] --> [Unit Tests (多数・高速)]

note right of [Unit Tests (多数・高速)]
  - 高速実行（<1秒）
  - 外部依存なし
  - テストケース数: 200+
  - カバレッジ目標: 90%+
end note

note right of [Integration Tests (中程度)]
  - 中程度実行時間（<30秒）
  - モック/スタブ活用
  - テストケース数: 50+
  - カバレッジ目標: 70%+
end note

note right of [E2E Tests (少数・高価値)]
  - 低速実行（<5分）
  - 実ブラウザ使用
  - テストケース数: 10+
  - 重要ユースケースカバー
end note
@enduml
```

## レイヤー別テスト戦略

### ドメイン層テスト

```plantuml
@startuml "ドメイン層テスト戦略"
package "ドメインモデル" {
  class Game {
    +start(): Game
    +handleInput(): Game
    +updateGameLoop(): Game
  }
  
  class Field {
    +placePuyo(): Field
    +applyGravity(): Field
    +detectErasableGroups(): PuyoGroup[]
  }
  
  class ChainProcessor {
    +processChain(): ChainResult
    +calculateScore(): number
  }
}

package "ドメインテスト" {
  class GameTest {
    +ゲーム開始時の状態が正しいこと()
    +入力処理により状態が適切に変化すること()
    +ゲームオーバー判定が正しく動作すること()
  }
  
  class FieldTest {
    +ぷよ配置が正しく行われること()
    +重力適用により適切に落下すること()
    +消去対象グループの検出が正確であること()
  }
  
  class ChainProcessorTest {
    +連鎖検出が正確に動作すること()
    +スコア計算が正しいこと()
    +全消しボーナスが適用されること()
  }
}

GameTest --> Game
FieldTest --> Field  
ChainProcessorTest --> ChainProcessor
@enduml
```

**対象:**

- ドメインモデル（Game, Field, Puyo, Chain）
- ドメインサービス（ChainDetection, ScoreCalculation）
- 値オブジェクト（Position, Score）

**テスト方針:**

- 外部依存なしの純粋なユニットテスト
- 不変条件の検証
- ビジネスルールの詳細な検証
- 境界値テストの実施

### アプリケーション層テスト

```plantuml
@startuml "アプリケーション層テスト戦略"
package "アプリケーションサービス" {
  class GameService {
    +startGame(): Game
    +handleInput(): Game
    +updateGameState(): Game
  }
  
  class ScoreService {
    +updateScore(): Score
    +saveHighScore(): void
  }
}

package "モック/スタブ" {
  class MockStoragePort {
    +save(): void
    +load(): any
  }
  
  class MockAnimationPort {
    +playAnimation(): void
  }
}

package "統合テスト" {
  class GameServiceTest {
    +ゲーム開始により適切に初期化されること()
    +入力処理が正しく連携されること()
    +状態変更時にイベントが発生すること()
  }
  
  class ScoreServiceTest {
    +スコア更新が正しく保存されること()
    +ハイスコア判定が適切であること()
  }
}

GameServiceTest --> GameService
GameServiceTest --> MockStoragePort
ScoreServiceTest --> ScoreService
@enduml
```

**対象:**

- アプリケーションサービス
- ポートとアダプターの統合
- ドメインイベントの発行

**テスト方針:**

- モック/スタブによる外部依存の分離
- ユースケースレベルでの統合テスト
- イベント発行の検証

### プレゼンテーション層テスト

```plantuml
@startuml "プレゼンテーション層テスト戦略"
package "Reactコンポーネント" {
  class GameComponent {
    +render(): JSX.Element
    +handleKeyPress(): void
  }
  
  class GameBoardComponent {
    +renderField(): JSX.Element
    +renderPuyo(): JSX.Element
  }
}

package "コンポーネントテスト" {
  class GameComponentTest {
    +初期状態で正しくレンダリングされること()
    +キー入力により適切な処理が呼ばれること()
    +ゲーム状態に応じて表示が変わること()
  }
  
  class GameBoardComponentTest {
    +フィールドが正しく描画されること()
    +ぷよが適切な位置に表示されること()
    +アニメーションが正しく再生されること()
  }
}

GameComponentTest --> GameComponent
GameBoardComponentTest --> GameBoardComponent
@enduml
```

**対象:**

- Reactコンポーネント
- ユーザー入力処理
- 描画ロジック

**テスト方針:**

- Vitest + React Testing Libraryによるコンポーネントテスト
- ユーザー体験重視のテスト設計
- アクセシビリティを考慮した検証
- 実装詳細ではなくユーザー操作のシミュレーション

### インフラストラクチャ層テスト

```plantuml
@startuml "インフラストラクチャ層テスト戦略"
package "アダプター" {
  class LocalStorageAdapter {
    +save(): void
    +load(): any
  }
  
  class AnimationService {
    +playAnimation(): void
    +stopAnimation(): void
  }
}

package "統合テスト" {
  class StorageAdapterTest {
    +データの保存と読み込みが正しく動作すること()
    +不正なデータへの対応が適切であること()
  }
  
  class AnimationServiceTest {
    +アニメーションが正しく再生されること()
    +パフォーマンスが要件を満たすこと()
  }
}

StorageAdapterTest --> LocalStorageAdapter
AnimationServiceTest --> AnimationService
@enduml
```

**対象:**

- 外部システムとの統合
- ブラウザAPIの利用
- パフォーマンス検証

**テスト方針:**

- 実際の外部システムとの統合テスト
- エラーハンドリングの検証
- パフォーマンステスト

## E2Eテスト戦略

### 主要ユーザーシナリオ

```plantuml
@startuml "E2Eテストシナリオ"
start

:ブラウザ起動;
:ゲームページにアクセス;

partition "基本ゲームプレイフロー" {
  :新しいゲーム開始;
  :ぷよ操作（移動・回転）;
  :ぷよ落下・固定;
  :消去・連鎖発生;
  :スコア更新確認;
  :ゲームオーバーまで継続;
  :結果画面表示;
}

partition "機能テスト" {
  :ポーズ機能動作確認;
  :リスタート機能確認;
  :設定変更動作確認;
  :音響動作確認;
}

partition "レスポンシブテスト" {
  :デスクトップ表示確認;
  :タブレット表示確認;
  :モバイル表示確認;
  :画面回転対応確認;
}

:テスト結果記録;
stop
@enduml
```

### クロスブラウザテスト

| ブラウザ | バージョン | 優先度 | 対象機能 |
|----------|------------|---------|----------|
| Chrome | 90+ | 高 | 全機能 |
| Firefox | 88+ | 高 | 全機能 |
| Safari | 14+ | 中 | 基本機能 |
| Edge | 90+ | 中 | 基本機能 |

## パフォーマンステスト

### パフォーマンス要件

```plantuml
@startuml "パフォーマンステスト"
package "パフォーマンス目標" {
  [60FPS以上でのゲーム動作]
  [初回ロード時間5秒以内]
  [メモリ使用量100MB以下]
  [入力遅延16ms以内]
}

package "測定指標" {
  [Frame Rate測定]
  [Load Time測定]
  [Memory Usage監視]
  [Input Lag測定]
}

package "最適化検証" {
  [アニメーション最適化効果]
  [メモリリーク検出]
  [バンドルサイズ最適化]
}

[60FPS以上でのゲーム動作] --> [Frame Rate測定]
[初回ロード時間5秒以内] --> [Load Time測定]
[メモリ使用量100MB以下] --> [Memory Usage監視]
[入力遅延16ms以内] --> [Input Lag測定]

[Frame Rate測定] --> [アニメーション最適化効果]
[Memory Usage監視] --> [メモリリーク検出]
@enduml
```

### パフォーマンステストツール

- **Lighthouse:** Web Vitals測定
- **Chrome DevTools:** 詳細パフォーマンス分析
- **Web Vitals Extension:** リアルタイム監視
- **Bundle Analyzer:** バンドルサイズ分析

## テストデータ管理

### テストデータ戦略

```plantuml
@startuml "テストデータ管理"
package "テストデータ種類" {
  [基本ケースデータ]
  [境界値データ]
  [異常値データ]
  [パフォーマンステストデータ]
}

package "データ生成手法" {
  [手動作成データ]
  [プログラム生成データ]
  [ランダムデータ]
  [実データからの抽出]
}

package "データ管理" {
  [バージョン管理]
  [テスト環境別管理]
  [データクリーンアップ]
}

[基本ケースデータ] --> [手動作成データ]
[境界値データ] --> [プログラム生成データ]
[異常値データ] --> [ランダムデータ]
[パフォーマンステストデータ] --> [実データからの抽出]

[手動作成データ] --> [バージョン管理]
[プログラム生成データ] --> [テスト環境別管理]
@enduml
```

### テストデータビルダーパターン

```typescript
class GameTestDataBuilder {
  private game: Game;
  
  constructor() {
    this.game = this.createDefaultGame();
  }
  
  withField(pattern: string[][]): GameTestDataBuilder {
    const field = FieldFactory.createFromPattern(pattern);
    this.game = this.game.withField(field);
    return this;
  }
  
  withScore(score: number): GameTestDataBuilder {
    this.game = this.game.withScore(new Score(score, 0));
    return this;
  }
  
  build(): Game {
    return this.game;
  }
}

// 使用例
const gameWithChain = new GameTestDataBuilder()
  .withField([
    ['.', '.', '.', '.', '.', '.'],
    ['.', '.', '.', '.', '.', '.'],
    ['R', 'R', 'R', '.', '.', '.'],
    ['R', 'G', 'G', 'G', '.', '.'],
  ])
  .withScore(1000)
  .build();
```

## CI/CDにおけるテスト実行

### テスト実行フロー

```plantuml
@startuml "CI/CDテスト実行フロー"
start

:コード変更;
:Gitプッシュ;

partition "GitHub Actions" {
  :テスト環境セットアップ;
  
  parallel
    :Unit Tests実行;
    note right: 約30秒
  and
    :Integration Tests実行;  
    note right: 約2分
  and
    :Lint & TypeScript実行;
    note right: 約15秒
  end parallel
  
  if (全テスト通過?) then (yes)
    :E2E Tests実行;
    note right: 約5分
    
    if (E2Eテスト通過?) then (yes)
      :ビルド実行;
      :成功通知;
    else (no)
      :E2E失敗通知;
      stop
    endif
  else (no)
    :失敗通知;
    stop
  endif
}

:デプロイ準備完了;
stop
@enduml
```

### テスト環境設定

```yaml
# .github/workflows/test.yml
name: Test Suite with Vitest

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18, 20]
        browser: [chrome, firefox]
    
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run unit tests with Vitest
        run: npm run test:unit
        
      - name: Run integration tests with Vitest
        run: npm run test:integration
        
      - name: Generate coverage report
        run: npm run test:coverage
        
      - name: Run E2E tests
        run: npm run test:e2e:${{ matrix.browser }}
        
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/coverage-final.json
```

## テスト品質指標

### カバレッジ目標

| レイヤー | Statement | Branch | Function | Line |
|----------|-----------|---------|----------|------|
| ドメイン層 | 95%+ | 90%+ | 95%+ | 95%+ |
| アプリケーション層 | 85%+ | 80%+ | 90%+ | 85%+ |
| プレゼンテーション層 | 70%+ | 65%+ | 75%+ | 70%+ |
| インフラストラクチャ層 | 60%+ | 55%+ | 65%+ | 60%+ |
| **全体** | **80%+** | **75%+** | **85%+** | **80%+** |

### 品質ゲート

```plantuml
@startuml "品質ゲート"
start

:テスト実行完了;

if (カバレッジ目標達成?) then (no)
  :品質ゲート失敗;
  stop
endif

if (全テスト通過?) then (no)
  :品質ゲート失敗;
  stop  
endif

if (Lint/TypeScriptエラーなし?) then (no)
  :品質ゲート失敗;
  stop
endif

if (パフォーマンス要件達成?) then (no)
  :品質ゲート失敗;
  stop
endif

:品質ゲート通過;
:デプロイ可能;
stop
@enduml
```

## テストの保守とメンテナンス

### テスト改善サイクル

```plantuml
@startuml "テスト改善サイクル"
start

:テスト実行;
:結果分析;

if (フレーキーテストあり?) then (yes)
  :テスト安定化;
endif

if (実行時間長すぎ?) then (yes)
  :テスト最適化;
endif

if (カバレッジ不足?) then (yes)
  :テスト追加;
endif

if (重複テストあり?) then (yes)
  :テスト整理;
endif

:テスト改善完了;
stop
@enduml
```

### テストドキュメンテーション

- **テスト計画書:** 全体的なテスト戦略と方針
- **テストケース仕様:** 各テストの詳細仕様
- **テスト実行ログ:** CI/CDでの実行履歴
- **不具合レポート:** テスト失敗時の詳細分析

## まとめ

このテスト戦略により以下を実現：

1. **品質保証:** TDDサイクルによる高品質なコード
2. **効率性:** ピラミッド型による効率的なテスト実行
3. **信頼性:** 包括的なテストカバレッジ
4. **自動化:** CI/CDによる継続的な品質チェック
5. **保守性:** テストコードの継続的改善
6. **透明性:** 品質指標の可視化と監視