# ユースケース詳細

## ユースケース1: ゲームを開始する

**アクター**: プレイヤー

**事前条件**: 

- ゲームアプリケーションが読み込まれている
- ゲームが開始されていない状態、またはゲームオーバー状態

**トリガー**: プレイヤーが「新しいゲーム」ボタンをクリック、またはリセットキー（R）を押下

**主な流れ**:

1. システムがゲーム状態を初期化する
2. システムが6列×13行のゲームフィールドを生成する
3. システムがスコアを0に設定する
4. システムが最初のぷよペアを生成する（ランダムな色）
5. システムがぷよペアを初期位置（列2、行1）に配置する
6. システムがゲームループを開始する
7. システムが画面を描画する

**事後条件**: 

- ゲームが開始状態になる
- プレイヤーがぷよを操作可能になる
- スコアが表示される

**例外処理**: なし

---

## ユースケース2: ぷよを移動する

**アクター**: プレイヤー

**事前条件**: 

- ゲームが開始されている
- 落下中のぷよペアが存在する
- ゲームオーバーでない

**トリガー**: プレイヤーが左右矢印キーまたはA/Dキーを押下

**主な流れ**:

1. システムが入力キーを検出する
2. システムが移動先の座標を計算する
3. システムが移動可能かどうかを判定する
   - フィールドの境界内か
   - 移動先に他のぷよがないか
4. 移動可能な場合、システムがぷよの位置を更新する
5. システムが画面を更新する

**代替フロー**:

- 3a. 移動不可能な場合
  1. システムが移動を無視する
  2. 現在の位置を維持する

**事後条件**: 

- ぷよが新しい位置に移動する（移動可能な場合）
- または、現在の位置を維持する（移動不可能な場合）

---

## ユースケース3: ぷよを回転する

**アクター**: プレイヤー

**事前条件**: 

- ゲームが開始されている
- 落下中のぷよペアが存在する
- ゲームオーバーでない

**トリガー**: プレイヤーが上矢印キー、W、スペース、またはXキーを押下

**主な流れ**:

1. システムが入力キーを検出する
2. システムが回転方向を決定する（時計回り/反時計回り）
3. システムが回転後の各ぷよの位置を計算する
4. システムが回転可能かどうかを判定する
   - 回転後の位置がフィールド内か
   - 回転後の位置に他のぷよがないか
5. 回転可能な場合、システムがぷよの位置を更新する
6. システムが画面を更新する

**代替フロー**:

- 4a. 回転不可能だが壁キックが可能な場合
  1. システムが壁キック処理を実行する
  2. 左または右に1マス移動して回転を試行する
  3. 移動後回転が可能な場合、位置を更新する
- 4b. 回転不可能な場合
  1. システムが回転を無視する
  2. 現在の位置と向きを維持する

**事後条件**: 

- ぷよが新しい向きに回転する（回転可能な場合）
- または、現在の向きを維持する（回転不可能な場合）

---

## ユースケース4: ぷよを高速落下させる

**アクター**: プレイヤー

**事前条件**: 

- ゲームが開始されている
- 落下中のぷよペアが存在する
- ゲームオーバーでない

**トリガー**: プレイヤーが下矢印キーまたはSキーを押下

**主な流れ**:

1. システムが入力キーを検出する
2. システムが高速落下モードを有効化する
3. システムが落下タイマーを短縮する（通常の1/10）
4. プレイヤーがキーを離すまで高速落下を継続する
5. キーが離された場合、通常の落下速度に戻る

**代替フロー**:

- 3a. 着地した場合
  1. 高速落下を終了する
  2. 着地処理を実行する

**事後条件**: 

- ぷよが高速で落下する（キー押下中）
- または、通常速度で落下する（キー離上後）

---

## ユースケース5: ぷよを消去する

**アクター**: システム

**事前条件**: 

- ゲームが開始されている
- フィールドにぷよが配置されている
- ぷよが着地した状態

**トリガー**: ぷよペアが着地した

**主な流れ**:

1. システムが全フィールドをスキャンする
2. システムが隣接する同じ色のぷよをグループ化する（深度優先探索）
3. システムが4つ以上のグループを特定する
4. 消去グループが存在する場合：
   a. 消去対象のぷよをマークする
   b. 消去されるぷよの数を計算する
   c. スコアを計算・加算する
   d. ぷよを消去する
   e. 上にあるぷよを落下させる
   f. 再度消去判定を実行する（連鎖処理）
5. 消去グループが存在しない場合、新しいぷよペアを生成する

**代替フロー**: なし

**事後条件**: 

- 消去対象のぷよが削除される
- スコアが更新される
- 上のぷよが落下する
- 連鎖が発生する可能性がある

---

## ユースケース6: 連鎖反応を処理する

**アクター**: システム

**事前条件**: 

- ぷよの消去処理が完了した
- 上のぷよが落下した

**トリガー**: 落下後に新たな消去可能なグループが形成された

**主な流れ**:

1. システムが連鎖カウントを増加させる
2. システムが新たな消去処理を実行する
3. システムが連鎖ボーナスを計算する
4. システムがスコアに連鎖ボーナスを適用する
5. システムが再度落下処理を実行する
6. 連鎖が継続する場合、手順1に戻る
7. 連鎖が終了した場合、新しいぷよペアを生成する

**代替フロー**: なし

**事後条件**: 

- 連鎖が処理される
- 連鎖ボーナスがスコアに適用される
- すべての連鎖が終了した後、新しいぷよが生成される

---

## ユースケース7: 全消しボーナスを判定する

**アクター**: システム

**事前条件**: 

- ぷよの消去処理が完了した

**トリガー**: 消去処理の結果、フィールドが空になった

**主な流れ**:

1. システムがフィールド上にぷよが残っているかチェックする
2. ぷよが残っていない場合、全消しボーナス（2000点）をスコアに加算する
3. システムが全消し演出を表示する（オプション）

**代替フロー**: 

- 2a. ぷよが残っている場合
  1. 全消しボーナスは適用されない

**事後条件**: 

- 全消しボーナスがスコアに加算される（該当する場合）

---

## ユースケース8: ゲームオーバーを判定する

**アクター**: システム

**事前条件**: 

- ゲームが開始されている

**トリガー**: 新しいぷよペアを生成しようとした

**主な流れ**:

1. システムが初期位置（列2、行1）をチェックする
2. 初期位置にぷよが配置されている場合、ゲームオーバーと判定する
3. システムがゲームオーバー画面を表示する
4. システムが最終スコアを表示する
5. システムが「もう一度」ボタンを表示する
6. システムがプレイヤーの入力を無効化する

**代替フロー**:

- 2a. 初期位置が空いている場合
  1. 新しいぷよペアを生成する
  2. ゲームを継続する

**事後条件**: 

- ゲームオーバー状態になる
- プレイヤーの操作が無効化される
- リスタートが可能になる

---

## ユースケース9: スコアを表示・更新する

**アクター**: システム

**事前条件**: 

- ゲームが開始されている

**トリガー**: ぷよが消去された、または全消しボーナスが発生した

**主な流れ**:

1. システムがスコア増加分を計算する
   - 基本点: 消去されたぷよの数 × 10
   - 連鎖ボーナス: 連鎖数に応じた倍率
   - 全消しボーナス: 2000点（該当する場合）
2. システムが現在のスコアに加算する
3. システムが画面のスコア表示を更新する

**代替フロー**: なし

**事後条件**: 

- スコアが更新される
- 画面表示が最新のスコアを反映する

---

## ユースケース10: ユーザー入力を処理する

**アクター**: プレイヤー

**事前条件**: 

- ゲームが開始されている
- ゲームオーバーでない

**トリガー**: プレイヤーがキーを押下またはタッチ操作を実行

**主な流れ**:

1. システムが入力イベントを検出する
2. システムが入力の種類を判定する
   - 移動（左右矢印、A/D）
   - 回転（上矢印、W、スペース、X）
   - 高速落下（下矢印、S）
   - リセット（R）
3. システムが対応するアクションを実行する
4. システムが画面を更新する

**代替フロー**:
- 2a. 無効な入力の場合
  1. システムが入力を無視する

**事後条件**: 
- 有効な入力に対してゲーム状態が更新される

---

## システムユースケース: ゲームループ

**アクター**: システム

**事前条件**: 

- ゲームが開始されている

**トリガー**: ゲーム開始

**主な流れ**:

1. システムがゲーム状態を初期化する
2. システムが以下の処理を繰り返し実行する：
   a. ユーザー入力を処理する
   b. ゲーム状態を更新する（ぷよの落下等）
   c. 衝突判定を実行する
   d. 消去判定を実行する
   e. 画面を描画する
   f. フレーム遅延を実行する
3. ゲームオーバーになるまで手順2を継続する

**代替フロー**: なし

**事後条件**: 

- ゲームが継続的に動作する
- プレイヤーの操作に応答する