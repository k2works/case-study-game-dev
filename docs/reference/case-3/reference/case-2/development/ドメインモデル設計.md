# ドメインモデル設計

## 概要

ぷよぷよゲームのドメインモデルを定義します。ドメイン駆動設計（DDD）の原則に従い、ビジネスロジックを適切にモデル化します。

## ドメインの境界

### ゲームコア（Game Core）
ぷよぷよゲームの中核となるドメイン

**責務:**
- ゲーム状態の管理
- ぷよの操作と移動
- 消去・連鎖ロジック
- スコア計算

## エンティティ設計

### Game（ゲームエンティティ）
```plantuml
@startuml "Gameエンティティ"
class Game <<Entity>> {
  - field: GameField
  - currentPuyo: PuyoPair | null
  - score: number
  - chainCount: number
  - state: GameState
  --
  + constructor(field: GameField)
  + movePuyo(direction: string): boolean
  + rotatePuyo(): boolean
  + generateNewPuyo(): void
  + processClearAndGravity(): void
  + checkGameOver(): boolean
  + restart(): void
  + getScore(): number
  + getState(): GameState
}

note right of Game::movePuyo
  ぷよペアを指定方向に移動
  移動可能な場合のみtrueを返す
end note

note right of Game::processClearAndGravity
  連鎖処理の中核メソッド
  消去→重力→連鎖判定を繰り返す
end note

@enduml
```

**ビジネスルール:**
- ゲームは一つのGameFieldを持つ
- 同時に操作できるPuyoPairは最大1つ
- 連鎖は自動的に処理される
- ゲームオーバー時は新しいぷよ生成を停止

### GameField（フィールドエンティティ）
```plantuml
@startuml "GameFieldエンティティ"
class GameField <<Entity>> {
  - grid: (Puyo | null)[][]
  - readonly width: number = 6
  - readonly height: number = 13
  --
  + constructor()
  + canPlace(puyo: Puyo, x: number, y: number): boolean
  + placePuyo(puyo: Puyo, x: number, y: number): void
  + getPuyo(x: number, y: number): Puyo | null
  + findConnectedPuyos(x: number, y: number, color: PuyoColor): Puyo[]
  + findErasableGroups(): Puyo[][]
  + clearConnectedPuyos(puyos: Puyo[]): void
  + applyGravity(): void
  + isEmpty(): boolean
  + clear(): void
}

note right of GameField::findConnectedPuyos
  深度優先探索（DFS）で
  同色の隣接ぷよを検出
end note

note right of GameField::applyGravity
  列ごとにぷよを下に詰める
  空のセルがある限り繰り返す
end note

@enduml
```

**ビジネスルール:**
- フィールドサイズは6列×13行（固定）
- 座標系は左上が(0,0)、右下が(5,12)
- 同色4つ以上の接続で消去対象
- 重力は列単位で適用

## 値オブジェクト設計

### PuyoPair（ぷよペア値オブジェクト）
```plantuml
@startuml "PuyoPair値オブジェクト"
class PuyoPair <<Value Object>> {
  - readonly mainPuyo: Puyo
  - readonly subPuyo: Puyo
  - readonly x: number
  - readonly y: number
  --
  + constructor(mainPuyo: Puyo, subPuyo: Puyo, x: number, y: number)
  + rotate(): PuyoPair
  + moveLeft(): PuyoPair
  + moveRight(): PuyoPair
  + moveDown(): PuyoPair
  + getPositions(): Position[]
  + equals(other: PuyoPair): boolean
}

note right of PuyoPair::rotate
  時計回りに90度回転
  mainPuyoを軸とする
  新しいPuyoPairインスタンスを返す
end note

note right of PuyoPair::getPositions
  mainPuyoとsubPuyoの座標を
  Positionの配列で返す
end note

@enduml
```

**不変性の保証:**
- 全てのプロパティはreadonly
- 操作メソッドは新しいインスタンスを返す
- 等価性はすべてのプロパティで判定

### Puyo（ぷよ値オブジェクト）
```plantuml
@startuml "Puyo値オブジェクト"
class Puyo <<Value Object>> {
  - readonly color: PuyoColor
  - readonly x: number
  - readonly y: number
  --
  + constructor(color: PuyoColor, x: number, y: number)
  + move(x: number, y: number): Puyo
  + equals(other: Puyo): boolean
  + toString(): string
}

note right of Puyo::move
  新しい座標で
  新しいPuyoインスタンスを作成
end note

@enduml
```

**ビジネスルール:**
- 色は5種類（RED, BLUE, GREEN, YELLOW, PURPLE）
- 座標は0以上の整数
- 同一色・同一座標のぷよは等価

## 列挙型設計

### PuyoColor（ぷよの色）
```plantuml
@startuml "PuyoColor列挙型"
enum PuyoColor {
  RED
  BLUE
  GREEN
  YELLOW
  PURPLE
  --
  + static getRandomColor(): PuyoColor
  + static getAllColors(): PuyoColor[]
}

note right of PuyoColor::getRandomColor
  ランダムに色を選択
  ゲーム初期化時に使用
end note

@enduml
```

### GameState（ゲーム状態）
```plantuml
@startuml "GameState列挙型"
enum GameState {
  PLAYING
  GAME_OVER
  --
  + isPlayable(): boolean
  + canAcceptInput(): boolean
}

note right of GameState::isPlayable
  ゲームの操作が可能かを判定
  PLAYING時のみtrue
end note

@enduml
```

## ドメインサービス設計

### PuyoGeneratorService（ぷよ生成サービス）
```plantuml
@startuml "PuyoGeneratorService"
class PuyoGeneratorService <<Domain Service>> {
  + generateRandomPuyoPair(): PuyoPair
  + generateRandomPuyo(): Puyo
  + generatePuyoAt(color: PuyoColor, x: number, y: number): Puyo
}

note right of PuyoGeneratorService::generateRandomPuyoPair
  ランダムな色のPuyoPairを生成
  初期位置(2, 0)に配置
end note

@enduml
```

### ScoreCalculationService（スコア計算サービス）
```plantuml
@startuml "ScoreCalculationService"
class ScoreCalculationService <<Domain Service>> {
  + calculateBaseScore(puyoCount: number): number
  + calculateChainBonus(chainCount: number): number
  + calculateZenkeshiBonus(): number
  + calculateTotalScore(puyoCount: number, chainCount: number, isZenkeshi: boolean): number
}

note right of ScoreCalculationService::calculateTotalScore
  基本スコア + 連鎖ボーナス + 全消しボーナス
  連鎖ボーナス = 基本スコア × 2^(n-1)
  全消しボーナス = 2000点
end note

@enduml
```

## ドメインイベント設計

### PuyoErasedEvent（ぷよ消去イベント）
```plantuml
@startuml "PuyoErasedEvent"
class PuyoErasedEvent <<Domain Event>> {
  - readonly erasedPuyos: Puyo[]
  - readonly chainCount: number
  - readonly timestamp: Date
  --
  + constructor(erasedPuyos: Puyo[], chainCount: number)
  + getErasedCount(): number
  + getChainCount(): number
}
```

### ChainCompletedEvent（連鎖完了イベント）
```plantuml
@startuml "ChainCompletedEvent"
class ChainCompletedEvent <<Domain Event>> {
  - readonly totalChainCount: number
  - readonly totalScore: number
  - readonly isZenkeshi: boolean
  - readonly timestamp: Date
  --
  + constructor(totalChainCount: number, totalScore: number, isZenkeshi: boolean)
}
```

## 集約設計

### Game集約
```plantuml
@startuml "Game集約"
package "Game Aggregate" {
  class Game <<Aggregate Root>> {
    - field: GameField
    - currentPuyo: PuyoPair | null
    - score: number
    - chainCount: number
    - state: GameState
  }
  
  class GameField {
    - grid: (Puyo | null)[][]
  }
  
  class PuyoPair {
    - mainPuyo: Puyo
    - subPuyo: Puyo
  }
  
  class Puyo {
    - color: PuyoColor
    - x: number
    - y: number
  }
}

Game *-- GameField : contains
Game *-- PuyoPair : controls
GameField *-- Puyo : holds
PuyoPair *-- Puyo : composed of

@enduml
```

**集約の境界:**
- Gameが集約ルート
- 外部からはGameを通じてのみアクセス
- GameField、PuyoPair、Puyoは内部要素

## ドメインルール

### 1. ぷよ移動ルール
- ぷよペアは左右・下方向に移動可能
- フィールド境界を超えた移動は無効
- 他のぷよとの衝突時は移動不可
- 着地時は次のぷよペアを自動生成

### 2. ぷよ回転ルール
- 時計回り90度回転のみ
- mainPuyoを軸として回転
- 壁際では1マスまでキック処理
- 回転不可能時は現状維持

### 3. ぷよ消去ルール
- 同色4つ以上の隣接で消去
- 4方向の隣接のみ有効（斜めは無効）
- 消去は深度優先探索で判定
- 消去後は重力が自動適用

### 4. 連鎖ルール
- 重力適用後に新たな消去パターンがあれば連鎖
- 連鎖数は累積でカウント
- 連鎖ボーナス = 2^(連鎖数-1)
- 連鎖が終了するまで新しいぷよは生成されない

### 5. スコアルール
- 基本スコア = 消去ぷよ数 × 10点
- 連鎖ボーナス = 基本スコア × 連鎖倍率
- 全消しボーナス = 2000点（固定）
- 総スコア = 基本スコア + 連鎖ボーナス + 全消しボーナス

### 6. ゲームオーバールール
- 新しいぷよペアが初期位置(2,0)に配置不可能
- ゲームオーバー時は操作入力を無効化
- リスタート時は全状態を初期化

## 不変条件

### Game集約の不変条件
1. フィールドサイズは常に6×13
2. スコアは0以上の整数
3. 連鎖カウントは0以上の整数
4. 操作中のぷよペアは最大1つ
5. ゲームオーバー時は新しいぷよ生成禁止

### GameFieldの不変条件
1. グリッドの範囲外アクセス禁止
2. 同一座標に複数のぷよ配置禁止
3. 空のセルはnull、ぷよがある場合はPuyoインスタンス
4. 重力適用後は下詰め状態を維持

### PuyoPair/Puyoの不変条件
1. 座標は0以上の整数
2. 色は定義された5色のいずれか
3. インスタンス生成後の状態変更禁止（不変性）
4. 等価性は全プロパティで判定