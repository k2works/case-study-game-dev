# アプリケーションアーキテクチャ

## 概要

本ぷよぷよゲームは、**ドメイン駆動設計（DDD）**を採用し、ビジネスロジックを中心とした3層アーキテクチャで構成されています。
テスト駆動開発（TDD）により高品質で保守性の高いコードベースを実現しています。

## アーキテクチャ方針

### 設計原則

- **関心の分離**: 各層が明確な責務を持つ
- **依存関係逆転**: 上位層が下位層の抽象に依存
- **単一責任**: 各クラスが単一の責務を持つ
- **開放閉鎖**: 拡張に開き、修正に閉じる

### テスト戦略

- **ユニットテスト**: 各コンポーネントの独立したテスト
- **統合テスト**: 層間の連携テスト
- **E2Eテスト**: エンドツーエンドの動作確認

## 全体アーキテクチャ

```plantuml
@startuml
!theme plain

package "プレゼンテーション層" {
  [main.ts] 
  [HTML/CSS]
}

package "アプリケーション層" {
  [GameController]
}

package "インフラストラクチャ層" {
  package "入力" {
    [InputHandler]
  }
  package "描画" {
    [GameRenderer]
  }
}

package "ドメイン層" {
  package "モデル" {
    [Game]
    [GameField]
    [Puyo]
    [PuyoPair]
    [GameState]
  }
}

[main.ts] --> [GameController]
[GameController] --> [InputHandler]
[GameController] --> [GameRenderer]
[GameController] --> [Game]
[GameRenderer] --> [Game]
[Game] --> [GameField]
[Game] --> [PuyoPair]
[PuyoPair] --> [Puyo]
[Game] --> [GameState]

@enduml
```

## 層別詳細設計

### ドメイン層

**責務**: ビジネスロジックとルールの実装

```plantuml
@startuml
!theme plain

package "ドメイン層" {
  class Game {
    -field: GameField
    -currentPuyo: PuyoPair | null
    -state: GameState
    -score: number
    -chainCount: number
    +start(): void
    +update(): void
    +movePuyo(dx: number, dy: number): boolean
    +rotatePuyo(): boolean
    +processClearAndGravity(): void
    +checkGameOver(): void
    +restart(): void
  }

  class GameField {
    -cells: (PuyoColor | null)[][]
    -width: number = 6
    -height: number = 12
    +getCell(x: number, y: number): PuyoColor | null
    +setCell(x: number, y: number, color: PuyoColor | null): void
    +isValidPosition(x: number, y: number): boolean
    +clearConnectedPuyos(): number
    +applyGravity(): void
    +isEmpty(): boolean
  }

  class PuyoPair {
    +main: Puyo
    +sub: Puyo
    +rotate(): PuyoPair
    +move(dx: number, dy: number): PuyoPair
    +getPositions(): Position[]
  }

  class Puyo {
    +position: Position
    +color: PuyoColor
  }

  enum GameState {
    READY
    PLAYING
    PAUSED
    GAME_OVER
  }

  enum PuyoColor {
    RED
    BLUE
    GREEN
    YELLOW
    PURPLE
  }

  Game *-- GameField
  Game *-- PuyoPair
  Game *-- GameState
  PuyoPair *-- Puyo
  Puyo *-- PuyoColor
}
@enduml
```

### アプリケーション層

**責務**: ユースケースの実行とドメインとインフラの調整

```plantuml
@startuml
!theme plain

package "アプリケーション層" {
  class GameController {
    -game: Game
    -inputHandler: InputHandler
    -renderer: GameRenderer
    -isRunning: boolean
    +start(): void
    +stop(): void
    +update(): void
    +reset(): void
    -handleInput(): void
    -render(): void
  }
}

package "ドメイン層" {
  class Game
}

package "インフラストラクチャ層" {
  class InputHandler
  class GameRenderer
}

GameController --> Game
GameController --> InputHandler
GameController --> GameRenderer
@enduml
```

### インフラストラクチャ層

**責務**: 技術的な実装詳細（入出力、描画等）

```plantuml
@startuml
!theme plain

package "インフラストラクチャ層" {
  package "入力" {
    class InputHandler {
      -keysPressed: Set<string>
      -keysJustPressed: Set<string>
      +isKeyPressed(key: string): boolean
      +isKeyJustPressed(key: string): boolean
      +update(): void
      -setupEventListeners(): void
    }
  }

  package "描画" {
    class GameRenderer {
      -canvas: HTMLCanvasElement
      -context: CanvasRenderingContext2D
      -cellSize: number = 32
      -fieldOffsetX: number
      -fieldOffsetY: number = 40
      +render(game: Game): void
      -renderField(field: GameField): void
      -renderCurrentPuyo(puyo: PuyoPair): void
      -renderScore(score: number): void
      -renderChainCount(count: number): void
      -renderGameOver(score: number): void
    }
  }
}
@enduml
```

## データフロー

### ゲームループのデータフロー

```plantuml
@startuml
!theme plain

participant Main
participant GameController
participant InputHandler
participant Game
participant GameRenderer

loop "ゲームループ (60FPS)"
  Main -> GameController: update()
  GameController -> InputHandler: 入力チェック
  InputHandler --> GameController: キー状態
  GameController -> Game: 入力に基づく操作
  Game -> Game: ゲーム状態更新
  GameController -> GameRenderer: render(game)
  GameRenderer -> Game: 状態取得
  Game --> GameRenderer: ゲーム状態
  GameRenderer -> GameRenderer: Canvas描画
end
@enduml
```

### ぷよ消去・連鎖のデータフロー

```plantuml
@startuml
!theme plain

participant Game
participant GameField

Game -> GameField: clearConnectedPuyos()
GameField -> GameField: 隣接同色ぷよ検索
GameField -> GameField: 4つ以上のグループ特定
GameField -> GameField: ぷよ消去実行
GameField --> Game: 消去数を返却
Game -> Game: スコア計算
Game -> GameField: applyGravity()
GameField -> GameField: 重力適用
GameField --> Game: 完了通知
Game -> Game: 連鎖判定
alt 連鎖継続
  Game -> Game: 再帰的に消去処理
else 連鎖終了
  Game -> Game: 連鎖リセット
end
@enduml
```

## 技術仕様

### 実行環境

| 項目 | 仕様 |
|------|------|
| ランタイム | ブラウザ（モダンブラウザ対応） |
| 描画 | HTML5 Canvas API |
| フレームレート | 60 FPS |
| 解像度 | 320x480 px |

### パフォーマンス特性

| 項目 | 仕様 |
|------|------|
| ゲームループ | requestAnimationFrame |
| 描画最適化 | 差分描画（全体再描画） |
| メモリ使用量 | 軽量（配列ベース状態管理） |
| レスポンス性 | リアルタイム入力処理 |

### テスト構成

```plantuml
@startuml
!theme plain

package "テスト層" {
  package "ユニットテスト" {
    [Game.test.ts]
    [GameField.test.ts]
    [Puyo.test.ts]
    [InputHandler.test.ts]
    [GameRenderer.test.ts]
  }
  
  package "統合テスト" {
    [GameController.test.ts]
    [ゲームループ.test.ts]
  }
  
  package "E2Eテスト" {
    [ゲーム操作.test.ts]
    [スコアシステム.test.ts]
  }
}

package "対象システム" {
  [ドメイン層]
  [アプリケーション層]
  [インフラ層]
}

[ユニットテスト] --> [ドメイン層]
[ユニットテスト] --> [インフラ層]
[統合テスト] --> [アプリケーション層]
[E2Eテスト] --> [対象システム]
@enduml
```

## 拡張性・保守性

### 新機能追加パターン

1. **新しいぷよタイプ**: PuyoColor列挙型に追加
2. **新しいゲームモード**: GameState追加またはStrategyパターン
3. **新しい入力方式**: InputHandler拡張
4. **新しい描画効果**: GameRenderer拡張

### 変更影響範囲の制限

- **ドメイン変更**: アプリケーション層以下に影響
- **UI変更**: インフラ層のみに影響
- **入力方式変更**: InputHandlerのみに影響
- **描画変更**: GameRendererのみに影響

## セキュリティ考慮事項

### 入力検証

- キー入力の妥当性チェック
- ゲーム状態の整合性検証
- 不正な操作の防止

### データ保護

- ローカルストレージは使用せず
- ネットワーク通信なし
- クライアントサイドのみの実行

## まとめ

本アーキテクチャにより以下を実現：

- **高い保守性**: 明確な層分離と責務分担
- **優れたテスタビリティ**: 各層の独立したテスト
- **拡張性**: 新機能の追加が容易
- **パフォーマンス**: 効率的なゲームループと描画
- **型安全性**: TypeScriptによる静的型チェック