# å®Ÿè£…

## æ¦‚è¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ ã®å®Ÿè£…è©³ç´°ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºï¼ˆTDDï¼‰ã®Red-Green-Refactorã‚µã‚¤ã‚¯ãƒ«ã«å¾“ã„ã€8ã¤ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é€šã˜ã¦æ®µéšçš„ã«æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

## å®Ÿè£…ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

### ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºï¼ˆTDDï¼‰ã‚µã‚¤ã‚¯ãƒ«

```plantuml
@startuml "TDDã‚µã‚¤ã‚¯ãƒ«"
!theme plain

state "Red" as RED #lightcoral
state "Green" as GREEN #lightgreen  
state "Refactor" as REFACTOR #lightblue

[*] --> RED : å¤±æ•—ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’æ›¸ã
RED --> GREEN : æœ€å°é™ã®å®Ÿè£…
GREEN --> REFACTOR : ã‚³ãƒ¼ãƒ‰ã‚’æ”¹å–„
REFACTOR --> RED : æ¬¡ã®æ©Ÿèƒ½
REFACTOR --> [*] : ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†

note right of RED : ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ\nä»•æ§˜ã®æ˜ç¢ºåŒ–
note right of GREEN : å‹•ä½œã™ã‚‹ã‚³ãƒ¼ãƒ‰\næœ€çŸ­è·é›¢ã®å®Ÿè£…
note right of REFACTOR : ãã‚Œã„ãªã‚³ãƒ¼ãƒ‰\nè¨­è¨ˆã®æ”¹å–„

@enduml
```

### ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºãƒ—ãƒ­ã‚»ã‚¹

```plantuml
@startuml "ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºãƒ—ãƒ­ã‚»ã‚¹"
!theme plain

start
:ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç”»;
:TODOãƒªã‚¹ãƒˆä½œæˆ;

repeat
  :TODOé¸æŠ;
  
  repeat
    :å¤±æ•—ãƒ†ã‚¹ãƒˆä½œæˆ (Red);
    :æœ€å°å®Ÿè£… (Green);
    :ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚° (Refactor);
    :å“è³ªãƒã‚§ãƒƒã‚¯;
    if (å“è³ªOK?) then (yes)
      :ã‚³ãƒŸãƒƒãƒˆ;
    else (no)
      :ä¿®æ­£;
    endif
  repeat while (TODOå®Œäº†?)
  
repeat while (å…¨TODOå®Œäº†?)

:ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒ“ãƒ¥ãƒ¼;
:ãµã‚Šã‹ãˆã‚Š;
stop

@enduml
```

## ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åˆ¥å®Ÿè£…è©³ç´°

### ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³1: ã‚²ãƒ¼ãƒ é–‹å§‹ã®å®Ÿè£…

#### å®Ÿè£…æˆ¦ç•¥
- **ã‚¤ãƒ³ã‚µã‚¤ãƒ‰ã‚¢ã‚¦ãƒˆã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**: ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰å®Ÿè£…é–‹å§‹
- **ä»®å®Ÿè£…**: æœ€å°é™ã®ã‚³ãƒ¼ãƒ‰ã§ãƒ†ã‚¹ãƒˆã‚’é€šã™
- **ä¸‰è§’æ¸¬é‡**: è¤‡æ•°ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã§ä¸€èˆ¬åŒ–

#### æ ¸å¿ƒå®Ÿè£…

**Game.tsï¼ˆåˆæœŸç‰ˆï¼‰**
```typescript
export class Game {
  private field: number[][]
  private currentPuyo: Puyo | null = null
  
  constructor() {
    // 6åˆ—x12è¡Œã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’åˆæœŸåŒ–
    this.field = Array(12).fill(null).map(() => Array(6).fill(0))
    this.generateNewPuyo()
  }
  
  private generateNewPuyo(): void {
    // ä»®å®Ÿè£…: å›ºå®šä½ç½®ã«å›ºå®šè‰²ã®ã·ã‚ˆã‚’ç”Ÿæˆ
    this.currentPuyo = new Puyo(2, 1, 1)
  }
}
```

**ãƒ†ã‚¹ãƒˆä¾‹**
```typescript
describe('Game', () => {
  it('ã‚²ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒ6åˆ—12è¡Œã§åˆæœŸåŒ–ã•ã‚Œã‚‹ã“ã¨', () => {
    const game = new Game()
    const field = game.getField()
    
    expect(field).toHaveLength(12)
    expect(field[0]).toHaveLength(6)
  })
  
  it('æ–°ã—ã„ã·ã‚ˆãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨', () => {
    const game = new Game()
    
    expect(game.getCurrentPuyo()).not.toBeNull()
    expect(game.getCurrentPuyo()?.x).toBe(2)
    expect(game.getCurrentPuyo()?.y).toBe(1)
  })
})
```

#### ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æˆæœ
- **ãƒ¡ã‚½ãƒƒãƒ‰ã®æŠ½å‡º**: å‰å‡¦ç†ã®å…±é€šåŒ–ï¼ˆbeforeEachï¼‰
- **å¤‰æ•°åã®å¤‰æ›´**: ã‚ˆã‚Šæ„å‘³ã®ã‚ã‚‹åå‰ã¸ã®å¤‰æ›´
- **å‹å®‰å…¨æ€§ã®å‘ä¸Š**: TypeScriptã®å‹å®šç¾©æ´»ç”¨

### ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³2: ã·ã‚ˆã®ç§»å‹•ã®å®Ÿè£…

#### å®Ÿè£…æˆ¦ç•¥
- **æ˜ç™½ãªå®Ÿè£…**: ç§»å‹•ãƒ­ã‚¸ãƒƒã‚¯ã®ç›´æ¥å®Ÿè£…
- **æ™‚é–“ç®¡ç†**: deltaTimeã«ã‚ˆã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆç‹¬ç«‹

#### æ ¸å¿ƒå®Ÿè£…

**æ™‚é–“ãƒ™ãƒ¼ã‚¹ã®è½ä¸‹å‡¦ç†**
```typescript
export class Game {
  private dropTimer = 0
  private dropInterval = 1000 // 1ç§’ã”ã¨ã«è½ä¸‹
  
  update(deltaTime: number): void {
    if (!this.currentPuyo) return
    
    this.dropTimer += deltaTime
    if (this.dropTimer >= this.dropInterval) {
      if (this.canMoveTo(this.currentPuyo.x, this.currentPuyo.y + 1)) {
        this.currentPuyo.moveTo(this.currentPuyo.x, this.currentPuyo.y + 1)
      } else {
        this.fixPuyo()
        this.generateNewPuyo()
      }
      this.dropTimer = 0
    }
  }
}
```

**è¡çªåˆ¤å®šã®å®Ÿè£…**
```typescript
private canMoveTo(x: number, y: number): boolean {
  // å¢ƒç•Œãƒã‚§ãƒƒã‚¯
  if (x < 0 || x >= this.width || y < 0 || y >= this.height) {
    return false
  }
  
  // æ—¢å­˜ã·ã‚ˆã¨ã®è¡çªãƒã‚§ãƒƒã‚¯
  return this.field[y][x] === 0
}
```

#### ãƒ†ã‚¹ãƒˆä¾‹
```typescript
describe('ã·ã‚ˆã®ç§»å‹•', () => {
  it('å·¦çŸ¢å°ã‚­ãƒ¼ã§ã·ã‚ˆãŒå·¦ã«ç§»å‹•ã™ã‚‹ã“ã¨', () => {
    const game = new Game()
    const initialX = game.getCurrentPuyo()!.x
    
    game.handleInput('ArrowLeft')
    
    expect(game.getCurrentPuyo()!.x).toBe(initialX - 1)
  })
  
  it('ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å·¦ç«¯ã§å·¦ã«ç§»å‹•ã§ããªã„ã“ã¨', () => {
    const game = new Game()
    // ã·ã‚ˆã‚’å·¦ç«¯ã«ç§»å‹•
    game.getCurrentPuyo()!.moveTo(0, 1)
    
    game.handleInput('ArrowLeft')
    
    expect(game.getCurrentPuyo()!.x).toBe(0) // ç§»å‹•ã—ãªã„
  })
})
```

### ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³3: ã·ã‚ˆã®é«˜é€Ÿè½ä¸‹ã®å®Ÿè£…

#### å®Ÿè£…æˆ¦ç•¥
- **çŠ¶æ…‹ç®¡ç†**: ã‚­ãƒ¼ã®æŠ¼ä¸‹çŠ¶æ…‹ã‚’Setã§ç®¡ç†
- **ã‚¿ã‚¤ãƒãƒ¼åˆ†é›¢**: é€šå¸¸è½ä¸‹ã¨é«˜é€Ÿè½ä¸‹ã®ç‹¬ç«‹ç®¡ç†

#### æ ¸å¿ƒå®Ÿè£…

**ã‚­ãƒ¼çŠ¶æ…‹ç®¡ç†**
```typescript
export class Game {
  private keysPressed: Set<string> = new Set()
  private fastDropTimer = 0
  private fastDropInterval = 50 // é«˜é€Ÿè½ä¸‹ã¯50msã”ã¨
  
  handleKeyDown(key: string): void {
    this.keysPressed.add(key)
  }
  
  handleKeyUp(key: string): void {
    this.keysPressed.delete(key)
    
    // é«˜é€Ÿè½ä¸‹ã‚­ãƒ¼ãŒé›¢ã•ã‚ŒãŸå ´åˆã¯ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
    if (key === 'ArrowDown') {
      this.fastDropTimer = 0
    }
  }
}
```

**é«˜é€Ÿè½ä¸‹å‡¦ç†**
```typescript
private updateWithTime(deltaTime: number): void {
  if (!this.currentPuyo) return
  
  // é«˜é€Ÿè½ä¸‹å‡¦ç†
  if (this.keysPressed.has('ArrowDown')) {
    this.fastDropTimer += deltaTime
    if (this.fastDropTimer >= this.fastDropInterval) {
      if (this.canMoveTo(this.currentPuyo.x, this.currentPuyo.y + 1)) {
        this.currentPuyo.moveTo(this.currentPuyo.x, this.currentPuyo.y + 1)
      } else {
        this.puyoLanded = true
      }
      this.fastDropTimer = 0
    }
    return
  }
  
  // é€šå¸¸ã®è½ä¸‹å‡¦ç†
  this.dropTimer += deltaTime
  if (this.dropTimer >= this.dropInterval) {
    // ... é€šå¸¸è½ä¸‹ãƒ­ã‚¸ãƒƒã‚¯
  }
}
```

### ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³4: ã·ã‚ˆã®å›è»¢ã®å®Ÿè£…

#### å®Ÿè£…æˆ¦ç•¥
- **ãƒšã‚¢ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ**: è»¸-è¡›æ˜Ÿæ§‹é€ ã®å°å…¥
- **çŠ¶æ…‹ãƒ‘ã‚¿ãƒ¼ãƒ³**: å›è»¢çŠ¶æ…‹ã«ã‚ˆã‚‹ä½ç½®è¨ˆç®—
- **å£ã‚­ãƒƒã‚¯**: å®Ÿéš›ã®ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ ã«è¿‘ã„æ“ä½œæ„Ÿ

#### æ ¸å¿ƒå®Ÿè£…

**PuyoPairã‚¯ãƒ©ã‚¹**
```typescript
export class PuyoPair {
  public axis: Puyo      // è»¸ã·ã‚ˆ
  public satellite: Puyo // è¡›æ˜Ÿã·ã‚ˆ
  public rotation = 0    // å›è»¢çŠ¶æ…‹ï¼ˆ0-3ï¼‰
  
  constructor(x: number, y: number) {
    this.axis = new Puyo(x, y, this.generateRandomColor())
    this.satellite = new Puyo(x, y - 1, this.generateRandomColor())
  }
  
  rotate(): void {
    this.rotation = (this.rotation + 1) % 4
    this.updateSatellitePosition()
  }
  
  updateSatellitePosition(): void {
    const offsets = [
      { x: 0, y: -1 }, // ä¸Š
      { x: 1, y: 0 },  // å³  
      { x: 0, y: 1 },  // ä¸‹
      { x: -1, y: 0 }  // å·¦
    ]
    const offset = offsets[this.rotation]
    this.satellite.moveTo(
      this.axis.x + offset.x,
      this.axis.y + offset.y
    )
  }
}
```

**å£ã‚­ãƒƒã‚¯å‡¦ç†**
```typescript
private tryWallKickPuyoPair(): boolean {
  const wallKickOffsets = [
    { x: -1, y: 0 }, // å·¦ã«1ãƒã‚¹
    { x: 1, y: 0 },  // å³ã«1ãƒã‚¹
    { x: 0, y: -1 }, // ä¸Šã«1ãƒã‚¹
  ]
  
  for (const offset of wallKickOffsets) {
    const testX = this.currentPuyoPair.axis.x + offset.x
    const testY = this.currentPuyoPair.axis.y + offset.y
    
    if (this.canRotateAt(testX, testY)) {
      this.currentPuyoPair.moveTo(testX, testY)
      return true
    }
  }
  
  return false
}
```

### ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³5: ã·ã‚ˆã®æ¶ˆå»ã®å®Ÿè£…

#### å®Ÿè£…æˆ¦ç•¥
- **DFSæ¢ç´¢**: éš£æ¥ã™ã‚‹åŒè‰²ã·ã‚ˆã®åŠ¹ç‡çš„ãªæ¤œå‡º
- **è²¬å‹™åˆ†é›¢**: æ¢ç´¢ãƒ»åˆ¤å®šãƒ»æ¶ˆå»ãƒ»é‡åŠ›ã®åˆ†é›¢
- **å¾ªç’°çš„è¤‡é›‘åº¦åˆ¶é™**: ãƒ¡ã‚½ãƒƒãƒ‰åˆ†å‰²ã«ã‚ˆã‚‹å¯èª­æ€§å‘ä¸Š

#### æ ¸å¿ƒå®Ÿè£…

**DFSæ¢ç´¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **
```typescript
export class GameField {
  findConnectedPuyos(startX: number, startY: number, targetColor: number): Position[] {
    const visited: boolean[][] = this.createVisitedArray()
    const connected: Position[] = []
    
    this.dfsSearch(startX, startY, targetColor, visited, connected)
    return connected
  }
  
  private dfsSearch(
    x: number, y: number, targetColor: number,
    visited: boolean[][], connected: Position[]
  ): void {
    // å¢ƒç•Œãƒã‚§ãƒƒã‚¯ã¨è¨ªå•æ¸ˆã¿ãƒã‚§ãƒƒã‚¯
    if (!this.isValidPosition(x, y) || visited[y][x]) return
    if (this.field[y][x] !== targetColor) return
    
    // ç¾åœ¨ä½ç½®ã‚’ãƒãƒ¼ã‚¯
    visited[y][x] = true
    connected.push({ x, y })
    
    // 4æ–¹å‘ã«å†å¸°æ¢ç´¢
    this.dfsSearch(x + 1, y, targetColor, visited, connected)
    this.dfsSearch(x - 1, y, targetColor, visited, connected)
    this.dfsSearch(x, y + 1, targetColor, visited, connected)
    this.dfsSearch(x, y - 1, targetColor, visited, connected)
  }
}
```

**æ¶ˆå»å‡¦ç†ã®å®Ÿè£…**
```typescript
erasePuyos(): number {
  const erasableGroups = this.findErasableGroups()
  let totalErased = 0
  
  for (const group of erasableGroups) {
    for (const pos of group) {
      this.field[pos.y][pos.x] = 0
      totalErased++
    }
  }
  
  return totalErased
}

private findErasableGroups(): Position[][] {
  const erasableGroups: Position[][] = []
  const processed: boolean[][] = this.createVisitedArray()
  
  for (let y = 0; y < this.height; y++) {
    for (let x = 0; x < this.width; x++) {
      if (this.shouldCheckPosition(x, y, processed)) {
        const connected = this.findConnectedPuyos(x, y, this.field[y][x])
        if (connected.length >= 4) {
          erasableGroups.push(connected)
          this.markAsProcessed(connected, processed)
        }
      }
    }
  }
  
  return erasableGroups
}
```

### ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³6: é€£é–åå¿œã®å®Ÿè£…

#### å®Ÿè£…æˆ¦ç•¥
- **é€£é–ãƒ«ãƒ¼ãƒ—**: æ¶ˆå»ãŒç¶šãé™ã‚Šç¹°ã‚Šè¿”ã—å‡¦ç†
- **ã‚¹ã‚³ã‚¢è¨ˆç®—**: é€£é–ãƒœãƒ¼ãƒŠã‚¹ã®æ®µéšçš„é©ç”¨
- **UIçµ±åˆ**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¹ã‚³ã‚¢æ›´æ–°

#### æ ¸å¿ƒå®Ÿè£…

**é€£é–å‡¦ç†ã‚¨ãƒ³ã‚¸ãƒ³**
```typescript
export class GameLogic {
  processChain(): { totalScore: number; chainCount: number } {
    let chainCount = 0
    let totalScore = 0
    
    // é€£é–å‡¦ç†ï¼šæ¶ˆå»ã§ãã‚‹ã·ã‚ˆãŒã‚ã‚‹é™ã‚Šç¹°ã‚Šè¿”ã™
    while (true) {
      const erasedCount = this.gameField.erasePuyos()
      
      if (erasedCount === 0) break // æ¶ˆå»ã•ã‚Œã‚‹ã·ã‚ˆãŒãªã„å ´åˆã¯é€£é–çµ‚äº†
      
      chainCount++
      const erasureScore = ScoreCalculator.calculateErasureScore(erasedCount, chainCount)
      totalScore += erasureScore
      
      this.gameField.applyGravity() // é‡åŠ›å‡¦ç†ã‚’å®Ÿè¡Œ
    }
    
    // å…¨æ¶ˆã—ãƒœãƒ¼ãƒŠã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
    totalScore += this.checkZenkeshiBonus()
    
    return { totalScore, chainCount }
  }
}
```

**ã‚¹ã‚³ã‚¢è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ **
```typescript
export class ScoreCalculator {
  private static readonly CHAIN_BONUS_TABLE = [1, 2, 4, 8, 16, 32, 64, 128]
  
  static calculateErasureScore(erasedCount: number, chainCount: number): number {
    const baseScore = erasedCount * 10
    const chainBonus = this.getChainBonus(chainCount)
    return baseScore * chainBonus
  }
  
  static getChainBonus(chainCount: number): number {
    const index = chainCount - 1
    return index < this.CHAIN_BONUS_TABLE.length 
      ? this.CHAIN_BONUS_TABLE[index]
      : 256 // 8é€£é–ä»¥é™ã¯å›ºå®š
  }
}
```

### ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³7: å…¨æ¶ˆã—ãƒœãƒ¼ãƒŠã‚¹ã®å®Ÿè£…

#### å®Ÿè£…æˆ¦ç•¥
- **çŠ¶æ…‹åˆ¤å®š**: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ç©ºçŠ¶æ…‹æ¤œå‡º
- **ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½**: æ¼”å‡ºã¨ãƒ­ã‚¸ãƒƒã‚¯ã®ç–çµåˆ
- **UIæ¼”å‡º**: ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³

#### æ ¸å¿ƒå®Ÿè£…

**å…¨æ¶ˆã—åˆ¤å®š**
```typescript
export class GameField {
  isAllClear(): boolean {
    for (let y = 0; y < this.height; y++) {
      for (let x = 0; x < this.width; x++) {
        if (this.field[y][x] !== 0) {
          return false
        }
      }
    }
    return true
  }
}
```

**æ¼”å‡ºã‚·ã‚¹ãƒ†ãƒ **
```typescript
export class GameController {
  private showZenkeshiAnimation(): void {
    this.zenkeshiOverlay.classList.remove('hidden')
    this.zenkeshiOverlay.classList.add('show')
    
    // 3ç§’å¾Œã«æ¼”å‡ºã‚’éè¡¨ç¤º
    window.setTimeout(() => {
      this.hideZenkeshiAnimation()
    }, 3000)
  }
}
```

**CSSæ¼”å‡º**
```css
.zenkeshi-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
  background-size: 400% 400%;
  animation: gradientShift 2s ease infinite;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.zenkeshi-message {
  background: rgba(255, 255, 255, 0.9);
  padding: 2rem;
  border-radius: 20px;
  text-align: center;
  animation: slideIn 0.5s ease-out;
}
```

### ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³8: ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã®å®Ÿè£…

#### å®Ÿè£…æˆ¦ç•¥
- **ç”Ÿæˆåˆ¤å®š**: æ–°ã·ã‚ˆã®é…ç½®å¯èƒ½æ€§ãƒã‚§ãƒƒã‚¯
- **çŠ¶æ…‹ç®¡ç†**: ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®é©åˆ‡ãªé·ç§»
- **ãƒªã‚¹ã‚¿ãƒ¼ãƒˆæ©Ÿèƒ½**: å®Œå…¨ãªçŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ

#### æ ¸å¿ƒå®Ÿè£…

**ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®š**
```typescript
private generateNewPuyoPair(): void {
  // åˆæœŸä½ç½®ã«é…ç½®å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
  if (!this.canPuyoPairSpawn(2, 1)) {
    this.gameState = GameState.GAME_OVER
    this.currentPuyoPair = null
    
    // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ¼”å‡ºã‚’ãƒˆãƒªã‚¬ãƒ¼
    if (this.gameOverCallback) {
      this.gameOverCallback()
    }
    return
  }
  
  this.currentPuyoPair = new PuyoPair(2, 1)
}

private canPuyoPairSpawn(axisX: number, axisY: number): boolean {
  const tempPair = new PuyoPair(axisX, axisY)
  const positions = tempPair.getPositions()
  
  // è»¸ã¨è¡›æ˜Ÿã®ä¸¡æ–¹ãŒé…ç½®å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
  return positions.every(pos => this.canMoveTo(pos.x, pos.y))
}
```

**å®Œå…¨ãƒªã‚¹ã‚¿ãƒ¼ãƒˆæ©Ÿèƒ½**
```typescript
public restart(): void {
  // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
  this.gameField.clear()
  
  // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
  this.gameState = GameState.PLAYING
  this.score = 0
  this.chainCount = 0
  this.puyoLanded = false
  
  // ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
  this.dropTimer = 0
  this.fastDropTimer = 0
  
  // ã‚­ãƒ¼çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
  this.keysPressed.clear()
  
  // æ–°ã—ã„ã·ã‚ˆãƒšã‚¢ã‚’ç”Ÿæˆ
  this.generateNewPuyoPair()
}
```

## ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å®Ÿè£…è©³ç´°

### Phase 4: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¸ã®å¤§è¦æ¨¡ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°

#### ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æˆ¦ç•¥
- **æ®µéšçš„ç§»è¡Œ**: æ—¢å­˜æ©Ÿèƒ½ã‚’å£Šã•ãªã„å®‰å…¨ãªå¤‰æ›´
- **ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ†é›¢**: è²¬å‹™ã®æ˜ç¢ºåŒ–ã¨ä¾å­˜é–¢ä¿‚ã®æ•´ç†
- **ãƒ†ã‚¹ãƒˆç¶­æŒ**: 121å€‹ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’å…¨ã¦ç¶­æŒ

#### å®Ÿè£…æ‰‹é †

**Step 1: ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã®æŠ½å‡º**
```typescript
// 654è¡Œã®MonolithicãªGameã‚¯ãƒ©ã‚¹ã‹ã‚‰åˆ†é›¢

// GameField.ts - ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç®¡ç†ã®è²¬å‹™
export class GameField {
  private field: number[][] = Array(12).fill(null).map(() => Array(6).fill(0))
  // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ“ä½œãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç§»è¡Œ
}

// GameLogic.ts - é€£é–å‡¦ç†ã®è²¬å‹™  
export class GameLogic {
  constructor(private gameField: GameField) {}
  // é€£é–é–¢é€£ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç§»è¡Œ
}

// ScoreCalculator.ts - ã‚¹ã‚³ã‚¢è¨ˆç®—ã®è²¬å‹™
export class ScoreCalculator {
  // é™çš„ãƒ¡ã‚½ãƒƒãƒ‰ã¨ã—ã¦ã‚¹ã‚³ã‚¢è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç§»è¡Œ
}
```

**Step 2: ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ†é›¢ã®å®Ÿè£…**
```typescript
// presentation/GameController.ts
export class GameController {
  private game: Game
  private renderer: GameRenderer
  private inputHandler: InputHandler
  
  constructor() {
    this.setupEventListeners()
    this.startGameLoop() 
  }
}

// infrastructure/GameRenderer.ts
export class GameRenderer {
  render(game: Game): void {
    this.drawField(game)
    this.drawCurrentPuyo(game)
  }
}

// infrastructure/InputHandler.ts  
export class InputHandler {
  private keysPressed: Set<string> = new Set()
  
  setKeyHandler(key: string, handler: () => void): void {
    this.keyHandlers.set(key, handler)
  }
}
```

**Step 3: main.tsã®ç°¡ç´ åŒ–**
```typescript
// Before: 235è¡Œ
import './style.css'
import { Game } from './Game'
// ... å¤§é‡ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¨ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã‚³ãƒ¼ãƒ‰

// After: 42è¡Œ  
import './style.css'
import { GameController } from './presentation/GameController'

document.querySelector<HTMLDivElement>('#app')!.innerHTML = `
  <!-- HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ -->
`

// GameControllerã‚’åˆæœŸåŒ–ï¼ˆå…¨ã¦ã®å‡¦ç†ã‚’å§”è­²ï¼‰
new GameController()
```

#### å¾ªç’°çš„è¤‡é›‘åº¦ã®æ”¹å–„

**Beforeï¼ˆè¤‡é›‘åº¦8ï¼‰:**
```typescript
private handleInput(): void {
  if (this.inputHandler.isKeyJustPressed('KeyR') && this.game.getState() === GameState.GAME_OVER) {
    this.game.restart()
    return
  }
  
  if (this.game.getState() === GameState.PLAYING) {
    if (this.inputHandler.isKeyJustPressed('ArrowLeft')) {
      this.game.movePuyo(-1, 0)
    }
    if (this.inputHandler.isKeyJustPressed('ArrowRight')) {
      this.game.movePuyo(1, 0)
    }
    if (this.inputHandler.isKeyPressed('ArrowDown')) {
      this.game.movePuyo(0, 1)
    }
    if (this.inputHandler.isKeyJustPressed('ArrowUp')) {
      this.game.rotatePuyo()
    }
  }
}
```

**Afterï¼ˆå„ãƒ¡ã‚½ãƒƒãƒ‰è¤‡é›‘åº¦1-3ï¼‰:**
```typescript
private handleInput(): void {
  this.handleGameOverInput()
  this.handleGamePlayInput()
}

private handleGameOverInput(): void {
  if (this.inputHandler.isKeyJustPressed('KeyR') && this.game.getState() === GameState.GAME_OVER) {
    this.game.restart()
  }
}

private handleGamePlayInput(): void {
  if (this.game.getState() === GameState.PLAYING) {
    this.handleMovementInput()
    this.handleRotationInput()
  }
}

private handleMovementInput(): void {
  if (this.inputHandler.isKeyJustPressed('ArrowLeft')) {
    this.game.movePuyo(-1, 0)
  }
  if (this.inputHandler.isKeyJustPressed('ArrowRight')) {
    this.game.movePuyo(1, 0)
  }
  if (this.inputHandler.isKeyPressed('ArrowDown')) {
    this.game.movePuyo(0, 1)
  }
}

private handleRotationInput(): void {
  if (this.inputHandler.isKeyJustPressed('ArrowUp')) {
    this.game.rotatePuyo()
  }
}
```

## å“è³ªç®¡ç†ã®å®Ÿè£…

### è‡ªå‹•åŒ–ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

```bash
# package.json scripts
{
  "scripts": {
    "test": "vitest run",
    "test:watch": "vitest",
    "test:coverage": "c8 vitest run",
    "lint": "eslint . --ext .ts,.tsx",
    "lint:fix": "eslint . --ext .ts,.tsx --fix",
    "format": "prettier --write .",
    "format:check": "prettier --check .",
    "check": "gulp checkAndFix"
  }
}
```

### Gulpã‚¿ã‚¹ã‚¯ãƒ©ãƒ³ãƒŠãƒ¼

```javascript
// gulpfile.js
export const checkAndFix = series(lintFix, format, test)

export function guard() {
  console.log('ğŸ” Guard is watching for file changes...')
  watch('src/**/*.ts', series(lintFix, format, test))
  watch('**/*.test.ts', series(test))
}
```

### ESLintè¨­å®š

```javascript
// eslint.config.js
export default [
  {
    files: ['**/*.ts', '**/*.tsx'],
    rules: {
      // å¾ªç’°çš„è¤‡é›‘åº¦ã®åˆ¶é™
      'complexity': ['error', { max: 7 }],
      '@typescript-eslint/no-unused-vars': 'warn',
      'prettier/prettier': 'error',
    },
  }
]
```

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã®å®Ÿè£…

### ãƒ¡ãƒ¢ãƒªç®¡ç†

```typescript
export class GameController {
  public destroy(): void {
    this.stopGameLoop()
    this.inputHandler.destroy()
    // ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ã®ãŸã‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  }
}

export class InputHandler {
  public destroy(): void {
    document.removeEventListener('keydown', this.handleKeyDown)
    document.removeEventListener('keyup', this.handleKeyUp)
    this.keysPressed.clear()
    this.keyHandlers.clear()
  }
}
```

### ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æœ€é©åŒ–

```typescript
export class GameRenderer {
  private readonly CELL_SIZE = 40
  private readonly colors = ['', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7']
  
  public render(game: Game): void {
    // å¿…è¦ãªéƒ¨åˆ†ã®ã¿å†æç”»
    this.drawField(game)
    this.drawCurrentPuyo(game)
  }
  
  private drawPuyoCell(x: number, y: number, color: number): void {
    // åŠ¹ç‡çš„ãªå††æç”»
    const centerX = x * this.CELL_SIZE + this.CELL_SIZE / 2
    const centerY = y * this.CELL_SIZE + this.CELL_SIZE / 2
    const radius = (this.CELL_SIZE - 6) / 2
    
    this.ctx.fillStyle = this.colors[color] || '#999'
    this.ctx.beginPath()
    this.ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI)
    this.ctx.fill()
  }
}
```

## ãƒ†ã‚¹ãƒˆå®Ÿè£…ã®è©³ç´°

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®åˆ†é¡

```plantuml
@startuml "ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹åˆ†é¡"
!theme plain

package "121å€‹ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹" {
  
  package "åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ" {
    [ã‚²ãƒ¼ãƒ åˆæœŸåŒ–: 5å€‹]
    [ã·ã‚ˆç§»å‹•: 12å€‹] 
    [ã·ã‚ˆå›è»¢: 8å€‹]
    [é«˜é€Ÿè½ä¸‹: 4å€‹]
  }
  
  package "ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯" {
    [æ¶ˆå»åˆ¤å®š: 15å€‹]
    [é€£é–å‡¦ç†: 20å€‹]
    [é‡åŠ›å‡¦ç†: 18å€‹]
    [ã‚¹ã‚³ã‚¢è¨ˆç®—: 12å€‹]
  }
  
  package "ã‚²ãƒ¼ãƒ çŠ¶æ…‹" {
    [ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼: 8å€‹]
    [ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ: 6å€‹]
    [å…¨æ¶ˆã—: 7å€‹]
  }
  
  package "ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹" {
    [å¢ƒç•Œæ¡ä»¶: 6å€‹]
  }
}

@enduml
```

### ä»£è¡¨çš„ãªãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

**DFSæ¢ç´¢ã®ãƒ†ã‚¹ãƒˆ**
```typescript
describe('DFSæ¢ç´¢ã«ã‚ˆã‚‹éš£æ¥ã·ã‚ˆã®æ¤œå‡º', () => {
  it('Lå­—å‹ã«é…ç½®ã•ã‚ŒãŸåŒè‰²ã·ã‚ˆã‚’æ­£ã—ãæ¤œå‡ºã™ã‚‹ã“ã¨', () => {
    // Arrange
    const gameField = new GameField()
    /*
      é…ç½®ãƒ‘ã‚¿ãƒ¼ãƒ³:
      [1][1][0]
      [0][1][0]
      [0][1][0]
    */
    gameField.setPuyo(0, 9, 1)
    gameField.setPuyo(1, 9, 1)
    gameField.setPuyo(1, 10, 1)
    gameField.setPuyo(1, 11, 1)
    
    // Act
    const connected = gameField.findConnectedPuyos(0, 9, 1)
    
    // Assert
    expect(connected).toHaveLength(4)
    expect(connected).toContainEqual({ x: 0, y: 9 })
    expect(connected).toContainEqual({ x: 1, y: 9 })
    expect(connected).toContainEqual({ x: 1, y: 10 })
    expect(connected).toContainEqual({ x: 1, y: 11 })
  })
})
```

**é€£é–å‡¦ç†ã®çµ±åˆãƒ†ã‚¹ãƒˆ**
```typescript
describe('é€£é–å‡¦ç†ã®çµ±åˆãƒ†ã‚¹ãƒˆ', () => {
  it('2é€£é–ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨', () => {
    // Arrange: 2é€£é–ãŒç™ºç”Ÿã™ã‚‹é…ç½®ã‚’ä½œæˆ
    const game = new Game()
    // è¤‡é›‘ãªé…ç½®ãƒ­ã‚¸ãƒƒã‚¯...
    
    // Act
    const chainResult = game.processChain()
    
    // Assert
    expect(chainResult.chainCount).toBe(2)
    expect(chainResult.totalScore).toBe(60) // 1é€£é–(40ç‚¹) + 2é€£é–(20ç‚¹)
  })
})
```

## ã¾ã¨ã‚

### å®Ÿè£…æˆæœ

#### é‡çš„æˆæœ
- **ã‚³ãƒ¼ãƒ‰è¡Œæ•°**: ç·è¨ˆ2,000+è¡Œï¼ˆãƒ†ã‚¹ãƒˆå«ã‚€ï¼‰
- **ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹**: 121å€‹ï¼ˆ100%æˆåŠŸï¼‰
- **ã‚³ãƒŸãƒƒãƒˆæ•°**: 50+å›
- **ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: 8å›å®Œèµ°

#### è³ªçš„æˆæœ
- **å¾ªç’°çš„è¤‡é›‘åº¦**: å…¨ãƒ¡ã‚½ãƒƒãƒ‰7ä»¥ä¸‹
- **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸**: åŒ…æ‹¬çš„ãªãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
- **ã‚³ãƒ¼ãƒ‰å“è³ª**: ESLintãƒ»Prettierå®Œå…¨æº–æ‹ 
- **å‹å®‰å…¨æ€§**: TypeScriptå³å¯†ãƒ¢ãƒ¼ãƒ‰

#### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æˆæœ
- **ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ†é›¢**: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å®Ÿç¾
- **è²¬å‹™åˆ†é›¢**: SOLIDåŸå‰‡ã®é©ç”¨
- **ä¿å®ˆæ€§**: å¤‰æ›´ã®å½±éŸ¿ç¯„å›²ã‚’é™å®š
- **æ‹¡å¼µæ€§**: æ–°æ©Ÿèƒ½è¿½åŠ ã®å®¹æ˜“ã•

### å­¦ç¿’ä¾¡å€¤

#### æŠ€è¡“çš„ã‚¹ã‚­ãƒ«
1. **TDD**: Red-Green-Refactorã‚µã‚¤ã‚¯ãƒ«ã®ç¿’å¾—
2. **è¨­è¨ˆ**: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨SOLIDåŸå‰‡ã®å®Ÿè·µ
3. **ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **: DFSæ¢ç´¢ã€é‡åŠ›å‡¦ç†ã®å®Ÿè£…
4. **TypeScript**: å‹å®‰å…¨æ€§ã‚’æ´»ç”¨ã—ãŸé–‹ç™º

#### ãƒ—ãƒ­ã‚»ã‚¹ã‚¹ã‚­ãƒ«
1. **ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™º**: æ®µéšçš„ãªæ©Ÿèƒ½å®Ÿè£…
2. **å“è³ªç®¡ç†**: è‡ªå‹•åŒ–ã«ã‚ˆã‚‹ç¶™ç¶šçš„å“è³ªä¿è¨¼
3. **ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°**: æ—¢å­˜æ©Ÿèƒ½ã‚’ä¿æŒã—ãŸæ§‹é€ æ”¹å–„
4. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–**: é–‹ç™ºéç¨‹ã®ä½“ç³»çš„è¨˜éŒ²

ã“ã®å®Ÿè£…ã«ã‚ˆã‚Šã€**å¤‰æ›´ã‚’æ¥½ã«å®‰å…¨ã«ã§ãã¦å½¹ã«ç«‹ã¤ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢**ã¨ã„ã†ç›®æ¨™ã‚’é”æˆã—ã€å®Ÿè·µçš„ãªé–‹ç™ºã‚¹ã‚­ãƒ«ã‚’èº«ã«ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚