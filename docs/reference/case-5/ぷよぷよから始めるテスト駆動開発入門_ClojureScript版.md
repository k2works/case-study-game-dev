# ã·ã‚ˆã·ã‚ˆã‹ã‚‰å§‹ã‚ã‚‹ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºå…¥é–€ - ClojureScriptç‰ˆ

## ã¯ã˜ã‚ã«

ã¿ãªã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ï¼ä»Šæ—¥ã¯ç§ã¨ä¸€ç·’ã«ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºï¼ˆTDDï¼‰ã‚’ä½¿ã£ã¦ã€ClojureScriptã§ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ ã‚’ä½œã£ã¦ã„ãã¾ã—ã‚‡ã†ã€‚ã•ã¦ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®æ—…ã«å‡ºã‚‹å‰ã«ã€çš†ã•ã‚“ã¯ã€Œãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã€ã«ã¤ã„ã¦èã„ãŸã“ã¨ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿã‚‚ã—ã‹ã—ãŸã‚‰ã€Œãƒ†ã‚¹ãƒˆã£ã¦ã€ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ãŸå¾Œã«ã™ã‚‹ã‚‚ã®ã˜ã‚ƒãªã„ã®ï¼Ÿã€ã¨æ€ã‚ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã­ã€‚

> ãƒ†ã‚¹ãƒˆã‚’æ›¸ããªãŒã‚‰é–‹ç™ºã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€è¨­è¨ˆãŒè‰¯ã„æ–¹å‘ã«å¤‰ã‚ã‚Šã€ã‚³ãƒ¼ãƒ‰ãŒæ”¹å–„ã•ã‚Œç¶šã‘ã€ãã‚Œã«ã‚ˆã£ã¦è‡ªåˆ†è‡ªèº«ãŒé–‹ç™ºã«å‰å‘ãã«ãªã‚‹ã“ã¨ã€ãã‚ŒãŒãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®ç›®æŒ‡ã™ã‚´ãƒ¼ãƒ«ã§ã™ã€‚
>
> â€” Kent Beck ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã€ ä»˜éŒ²Cã€€è¨³è€…è§£èª¬ï¼šãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®ç¾åœ¨

ã“ã®è¨˜äº‹ã§ã¯ã€ç§ãŸã¡ãŒä¸€ç·’ã«ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ ã‚’ClojureScriptã§å®Ÿè£…ã—ãªãŒã‚‰ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®åŸºæœ¬çš„ãªæµã‚Œã¨è€ƒãˆæ–¹ã‚’å­¦ã‚“ã§ã„ãã¾ã™ã€‚ã¾ã‚‹ã§ãƒ¢ãƒ–ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚ˆã†ã«ã€ã‚ãªãŸã¨ç§ãŒä¸€ç·’ã«è€ƒãˆã€ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã€æ”¹å–„ã—ã¦ã„ãéç¨‹ã‚’ä½“é¨“ã—ã¾ã—ã‚‡ã†ã€‚

### ãªãœClojureScriptãªã®ã‹ï¼Ÿ

ClojureScriptã¯ã€Clojureã®é–¢æ•°å‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®å“²å­¦ã‚’JavaScriptç’°å¢ƒã§å®Ÿç¾ã™ã‚‹è¨€èªã§ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ãªç‰¹å¾´ãŒã‚ã‚Šã¾ã™ï¼š

- **Immutabilityï¼ˆä¸å¤‰æ€§ï¼‰**: ãƒ‡ãƒ¼ã‚¿ãŒå¤‰æ›´ã•ã‚Œãªã„ãŸã‚ã€ãƒã‚°ãŒå…¥ã‚Šã«ãã„
- **Simple Made Easy**: ã‚·ãƒ³ãƒ—ãƒ«ã•ã‚’é‡è¦–ã—ãŸè¨­è¨ˆå“²å­¦
- **å¼·åŠ›ãªãƒã‚¯ãƒ­ã‚·ã‚¹ãƒ†ãƒ **: ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã«ã‚ˆã‚‹é«˜ã„æŠ½è±¡åŒ–
- **REPLã«ã‚ˆã‚‹å¯¾è©±çš„é–‹ç™º**: å³åº§ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å¾—ã‚‰ã‚Œã‚‹é–‹ç™ºä½“é¨“

### ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®ã‚µã‚¤ã‚¯ãƒ«

ã•ã¦ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã§ã¯ã€ã©ã®ã‚ˆã†ã«é€²ã‚ã¦ã„ã‘ã°ã„ã„ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿã€Œãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã‹ã‚‰å®Ÿè£…ã™ã‚‹ã€ã¨ã„ã†ã®ã¯åˆ†ã‹ã‚Šã¾ã—ãŸãŒã€å…·ä½“çš„ã«ã¯ã©ã‚“ãªæ‰‹é †ã§é€²ã‚ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ

ç§ãŒã„ã¤ã‚‚å®Ÿè·µã—ã¦ã„ã‚‹ã®ã¯ã€ä»¥ä¸‹ã®3ã¤ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ç¹°ã‚Šè¿”ã™ã‚µã‚¤ã‚¯ãƒ«ã§ã™ã€‚çš†ã•ã‚“ã‚‚ä¸€ç·’ã«ã‚„ã£ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

1. **Redï¼ˆèµ¤ï¼‰**: ã¾ãšå¤±æ•—ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã¾ã™ã€‚ã€Œãˆï¼Ÿã‚ã–ã¨å¤±æ•—ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’ï¼Ÿã€ã¨æ€ã‚ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ã“ã‚Œã«ã¯é‡è¦ãªæ„å‘³ãŒã‚ã‚‹ã‚“ã§ã™ã€‚ã“ã‚Œã‹ã‚‰å®Ÿè£…ã™ã‚‹æ©Ÿèƒ½ãŒä½•ã‚’ã™ã¹ãã‹ã‚’æ˜ç¢ºã«ã™ã‚‹ãŸã‚ãªã‚“ã§ã™ã‚ˆã€‚
2. **Greenï¼ˆç·‘ï¼‰**: æ¬¡ã«ã€ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã‚ˆã†ã«ã€æœ€å°é™ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã—ã¾ã™ã€‚ã“ã®æ®µéšã§ã¯ã€ãã‚Œã„ãªã‚³ãƒ¼ãƒ‰ã‚ˆã‚Šã‚‚ã€Œã¨ã«ã‹ãå‹•ãã“ã¨ã€ã‚’å„ªå…ˆã—ã¾ã™ã€‚ã€Œæœ€å°é™ã€ã¨ã„ã†ã®ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚å¿…è¦ä»¥ä¸Šã®ã“ã¨ã¯ã—ãªã„ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚
3. **Refactorï¼ˆãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼‰**: æœ€å¾Œã«ã€ã‚³ãƒ¼ãƒ‰ã®å“è³ªã‚’æ”¹å–„ã—ã¾ã™ã€‚ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ãªãŒã‚‰ã€é‡è¤‡ã‚’å–ã‚Šé™¤ã„ãŸã‚Šã€ã‚ã‹ã‚Šã‚„ã™ã„åå‰ã‚’ã¤ã‘ãŸã‚Šã—ã¾ã™ã€‚ã€Œå‹•ãã‘ã©æ±šã„ã‚³ãƒ¼ãƒ‰ã€ã‹ã‚‰ã€Œå‹•ã„ã¦ãã‚Œã„ãªã‚³ãƒ¼ãƒ‰ã€ã¸ã¨é€²åŒ–ã•ã›ã‚‹ã‚“ã§ã™ã€‚

> ãƒ¬ãƒƒãƒ‰ãƒ»ã‚°ãƒªãƒ¼ãƒ³ãƒ»ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã€‚ãã‚ŒãŒTDDã®ãƒãƒ³ãƒˆãƒ©ã ã€‚
>
> â€” Kent Beck ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã€

ã“ã®ã‚µã‚¤ã‚¯ãƒ«ã‚’ã€ŒRed-Green-Refactorã€ã‚µã‚¤ã‚¯ãƒ«ã¨å‘¼ã³ã¾ã™ã€‚ã€Œèµ¤ãƒ»ç·‘ãƒ»ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã€ã®ãƒªã‚ºãƒ ã‚’åˆ»ã‚€ã‚ˆã†ã«ã€ã“ã®ã‚µã‚¤ã‚¯ãƒ«ã‚’ç¹°ã‚Šè¿”ã—ã¦ã„ãã‚“ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ã€å°‘ã—ãšã¤æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã€ã‚³ãƒ¼ãƒ‰ã®å“è³ªã‚’é«˜ã‚ã¦ã„ãã¾ã—ã‚‡ã†ã€‚çš†ã•ã‚“ã‚‚ä¸€ç·’ã«ã“ã®ãƒªã‚ºãƒ ã‚’ä½“æ„Ÿã—ã¦ã¿ã¦ãã ã•ã„ï¼

```plantuml
@startuml
[*] --> ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨ãƒ†ã‚¹ãƒˆ
ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨ãƒ†ã‚¹ãƒˆ --> TODO : TODOãƒªã‚¹ãƒˆã‚’ä½œæˆ
TODO --> Red : ãƒ†ã‚¹ãƒˆã‚’æ›¸ã
Red --> Green : æœ€å°é™ã®å®Ÿè£…
Green --> Refactor : ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
Refactor --> Red : æ¬¡ã®ãƒ†ã‚¹ãƒˆã‚’æ›¸ã
Red : ãƒ†ã‚¹ãƒˆã«å¤±æ•—
Green : ãƒ†ã‚¹ãƒˆã«é€šã‚‹æœ€å°é™ã®å®Ÿè£…
Refactor : ã‚³ãƒ¼ãƒ‰ã®é‡è¤‡ã‚’é™¤å»ã—ã¦ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
Refactor --> TODO : ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ãŒå®Œäº†ã—ãŸã‚‰TODOãƒªã‚¹ãƒˆã«æˆ»ã‚‹
TODO --> ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨ãƒ†ã‚¹ãƒˆ : TODOãƒªã‚¹ãƒˆãŒç©ºã«ãªã‚‹ã¾ã§ç¹°ã‚Šè¿”ã™
ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨ãƒ†ã‚¹ãƒˆ --> ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒ“ãƒ¥ãƒ¼
@enduml
```

### é–‹ç™ºç’°å¢ƒ

ã•ã¦ã€å®Ÿéš›ã«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãå‰ã«ã€ç§ãŸã¡ãŒä½¿ç”¨ã™ã‚‹é–‹ç™ºç’°å¢ƒã«ã¤ã„ã¦å°‘ã—ãŠè©±ã—ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚çš†ã•ã‚“ã¯ã€Œé“å…·é¸ã³ã¯ä»•äº‹ã®åŠåˆ†ã€ã¨ã„ã†è¨€è‘‰ã‚’èã„ãŸã“ã¨ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã§ã‚‚åŒã˜ã“ã¨ãŒè¨€ãˆã‚‹ã‚“ã§ã™ã€‚

> é“å…·ã¯ã‚ãªãŸã®èƒ½åŠ›ã‚’å¢—å¹…ã—ã¾ã™ã€‚é“å…·ã®ã§ããŒå„ªã‚Œã¦ãŠã‚Šã€ç°¡å˜ã«ä½¿ã„ã“ãªã›ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚Œã°ã€ã‚ˆã‚Šç”Ÿç”£çš„ã«ãªã‚Œã‚‹ã®ã§ã™ã€‚
>
> â€” é”äººãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ ç†Ÿé”ã«å‘ã‘ãŸã‚ãªãŸã®æ—…ï¼ˆç¬¬2ç‰ˆï¼‰

ã€Œã©ã‚“ãªãƒ„ãƒ¼ãƒ«ã‚’ä½¿ãˆã°ã„ã„ã®ï¼Ÿã€ã¨æ€ã‚ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã­ã€‚ä»Šå›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€ä»¥ä¸‹ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã„ãã¾ã™ï¼š

- **è¨€èª**: ClojureScript â€” é–¢æ•°å‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®ã‚·ãƒ³ãƒ—ãƒ«ã•ã¨JavaScriptã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã®ä¸¡ç«‹
- **ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«**: shadow-cljs â€” é«˜é€Ÿã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã€npmã¨ã®çµ±åˆã€ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰å¯¾å¿œ
- **ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: cljs.test â€” ClojureScriptæ¨™æº–ã®ãƒ†ã‚¹ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **ã‚¿ã‚¹ã‚¯ãƒ©ãƒ³ãƒŠãƒ¼**: Gulp â€” åå¾©çš„ãªã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•åŒ–
- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†**: Git â€” ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´å±¥æ­´ã‚’è¿½è·¡
- **é™çš„è§£æ**: clj-kondo â€” ClojureScriptå¯¾å¿œã®é«˜é€ŸLinter

ã“ã‚Œã‚‰ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®æµã‚Œã«æ²¿ã£ã¦ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚ã€Œç’°å¢ƒæ§‹ç¯‰ã£ã¦é›£ã—ãã†...ã€ã¨å¿ƒé…ã•ã‚Œã‚‹æ–¹ã‚‚ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒæ‰‹é †ã«å¾“ã£ã¦é€²ã‚ã‚Œã°ãã‚“ãªã«é›£ã—ã„ã“ã¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚è©³ç´°ã¯ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³0: ç’°å¢ƒã®æ§‹ç¯‰ã§è§£èª¬ã—ã¾ã™ã€‚

## è¦ä»¶

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼

ã•ã¦ã€å®Ÿéš›ã«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãå§‹ã‚ã‚‹å‰ã«ã€å°‘ã—ç«‹ã¡æ­¢ã¾ã£ã¦è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã€Œä½•ã‚’ä½œã‚‹ã®ã‹ï¼Ÿã€ã¨ã„ã†åŸºæœ¬çš„ãªå•ã„ã‹ã‘ã§ã™ã€‚ç§ãŸã¡ãŒä½œã‚‹ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ ã¯ã€ã©ã®ã‚ˆã†ãªæ©Ÿèƒ½ã‚’æŒã¤ã¹ãã§ã—ã‚‡ã†ã‹ï¼Ÿ

ã‚¢ã‚¸ãƒ£ã‚¤ãƒ«é–‹ç™ºã§ã¯ã€ã“ã®ã€Œä½•ã‚’ä½œã‚‹ã®ã‹ï¼Ÿã€ã¨ã„ã†å•ã„ã«å¯¾ã—ã¦ã€ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã€ã¨ã„ã†å½¢ã§ç­”ãˆã‚’å‡ºã—ã¾ã™ã€‚çš†ã•ã‚“ã¯ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã€ã¨ã„ã†è¨€è‘‰ã‚’èã„ãŸã“ã¨ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ

> ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã¯ã€ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢è¦æ±‚ã‚’è¡¨ç¾ã™ã‚‹ãŸã‚ã®è»½é‡ãªæ‰‹æ³•ã§ã‚ã‚‹ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã«ã¤ã„ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯é¡§å®¢ã®è¦–ç‚¹ã‹ã‚‰ãƒ•ã‚£ãƒ¼ãƒãƒ£ã®æ¦‚è¦ã‚’è¨˜è¿°ã—ãŸã‚‚ã®ã ã€‚
> ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã«ã¯å½¢å¼ãŒå®šã‚ã‚‰ã‚Œã¦ãŠã‚‰ãšã€æ¨™æº–çš„ãªè¨˜æ³•ã‚‚ãªã„ã€‚ã¨ã¯ã„ãˆã€æ¬¡ã®ã‚ˆã†ãªå½¢å¼ã§ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’è€ƒãˆã¦ã¿ã‚‹ã¨ä¾¿åˆ©ã§ã‚ã‚‹ã€‚ã€Œï¼œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¨®é¡ï¼ã¨ã—ã¦ã€ï¼œæ©Ÿèƒ½ã‚„æ€§èƒ½ï¼ãŒã»ã—ã„ã€‚ãã‚Œã¯ï¼œãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤ï¼ã®ãŸã‚ã ã€ã¨ã„ã†å½¢ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«å¾“ã†ã¨ã€
> ãŸã¨ãˆã°æ¬¡ã®ã‚ˆã†ãªã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’æ›¸ã‘ã‚‹ã€‚ã€Œæœ¬ã®è³¼å…¥è€…ã¨ã—ã¦ã€ï¼©ï¼³ï¼¢ï¼®ã§æœ¬ã‚’æ¤œç´¢ã—ãŸã„ã€‚ãã‚Œã¯æ¢ã—ã¦ã„ã‚‹æœ¬ã‚’ã™ã°ã‚„ãè¦‹ã¤ã‘ã‚‹ãŸã‚ã ã€
>
> â€” Mike Cohn ã€ã‚¢ã‚¸ãƒ£ã‚¤ãƒ«ãªè¦‹ç©ã¨è¨ˆç”»ã¥ãã‚Šã€

ã¤ã¾ã‚Šã€ã€Œãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ã€ã€‡ã€‡ãŒã§ãã‚‹ï¼ˆã€‡ã€‡ã—ãŸã„ã‹ã‚‰ï¼‰ã€ã¨ã„ã†å½¢å¼ã§æ©Ÿèƒ½ã‚’è¡¨ç¾ã™ã‚‹ã‚“ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ã€ã€Œèª°ã®ãŸã‚ã€ã®ã€Œã©ã‚“ãªæ©Ÿèƒ½ã€ã‚’ã€Œãªãœã€ä½œã‚‹ã®ã‹ãŒæ˜ç¢ºã«ãªã‚Šã¾ã™ã€‚ç´ æ™´ã‚‰ã—ã„ã§ã™ã‚ˆã­ï¼

ã§ã¯ã€ç§ãŸã¡ã®ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ ã§ã¯ã€ã©ã‚“ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãŒè€ƒãˆã‚‰ã‚Œã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿä¸€ç·’ã«è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ï¼š

- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ã€æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã§ãã‚‹ï¼ˆã‚²ãƒ¼ãƒ ã®åŸºæœ¬æ©Ÿèƒ½ã¨ã—ã¦å¿…è¦ã§ã™ã‚ˆã­ï¼ï¼‰
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ã€è½ã¡ã¦ãã‚‹ã·ã‚ˆã‚’å·¦å³ã«ç§»å‹•ã§ãã‚‹ï¼ˆã·ã‚ˆã‚’é©åˆ‡ãªä½ç½®ã«é…ç½®ã—ãŸã„ã§ã™ã‚ˆã­ï¼‰
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ã€è½ã¡ã¦ãã‚‹ã·ã‚ˆã‚’å›è»¢ã§ãã‚‹ï¼ˆæˆ¦ç•¥çš„ã«ã·ã‚ˆã‚’é…ç½®ã™ã‚‹ãŸã‚ã«å¿…è¦ã§ã™ï¼‰
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ã€ã·ã‚ˆã‚’ç´ æ—©ãè½ä¸‹ã•ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ï¼ˆã€Œæ—©ãæ¬¡ã®ã·ã‚ˆã‚’è½ã¨ã—ãŸã„ï¼ã€ã¨ã„ã†ã¨ãã®ãŸã‚ã«ï¼‰
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ã€åŒã˜è‰²ã®ã·ã‚ˆã‚’4ã¤ä»¥ä¸Šã¤ãªã’ã‚‹ã¨æ¶ˆå»ã§ãã‚‹ï¼ˆã“ã‚ŒãŒã·ã‚ˆã·ã‚ˆã®é†é†å‘³ã§ã™ã‚ˆã­ï¼ï¼‰
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ã€é€£é–åå¿œã‚’èµ·ã“ã—ã¦ã‚ˆã‚Šé«˜ã„ã‚¹ã‚³ã‚¢ã‚’ç²å¾—ã§ãã‚‹ï¼ˆã€Œã‚Œã€œã‚“ã•ã€œnï¼ã€ã¨å«ã³ãŸããªã‚Šã¾ã™ã‚ˆã­ï¼‰
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ã€å…¨æ¶ˆã—ï¼ˆãœã‚“ã‘ã—ï¼‰ãƒœãƒ¼ãƒŠã‚¹ã‚’ç²å¾—ã§ãã‚‹ï¼ˆã€Œã‚„ã£ãŸï¼å…¨éƒ¨æ¶ˆãˆãŸï¼ã€ã¨ã„ã†é”æˆæ„Ÿã‚’å‘³ã‚ã„ãŸã„ã§ã™ã‚ˆã­ï¼‰
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ã€ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã«ãªã‚‹ã¨ã‚²ãƒ¼ãƒ çµ‚äº†ã®æ¼”å‡ºã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã‚‹ï¼ˆçµ‚ã‚ã‚ŠãŒæ˜ç¢ºã§ãªã„ã¨ãƒ¢ãƒ¤ãƒ¢ãƒ¤ã—ã¾ã™ã‚ˆã­ï¼‰
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ã€ç¾åœ¨ã®ã‚¹ã‚³ã‚¢ã‚’ç¢ºèªã§ãã‚‹ï¼ˆã€Œä»Šã©ã‚Œãã‚‰ã„ç‚¹æ•°å–ã‚Œã¦ã‚‹ã‹ãªï¼Ÿã€ã¨æ°—ã«ãªã‚Šã¾ã™ã‚ˆã­ï¼‰
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ã€ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§ã·ã‚ˆã‚’æ“ä½œã§ãã‚‹ï¼ˆPCã§ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãªã‚‰å¿…é ˆã§ã™ã‚ˆã­ï¼‰
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ã€ã‚¿ãƒƒãƒæ“ä½œã§ã·ã‚ˆã‚’æ“ä½œã§ãã‚‹ï¼ˆã‚¹ãƒãƒ›ã§ã‚‚ãƒ—ãƒ¬ã‚¤ã—ãŸã„ã§ã™ã‚ˆã­ï¼‰

ã€Œã†ã‚ã€çµæ§‹ãŸãã•ã‚“ã‚ã‚‹ãª...ã€ã¨æ€ã‚ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€å¿ƒé…ã„ã‚Šã¾ã›ã‚“ï¼ã“ã‚Œã‚‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’ä¸€ã¤ãšã¤å®Ÿè£…ã—ã¦ã„ãã“ã¨ã§ã€å¾ã€…ã«ã‚²ãƒ¼ãƒ ã‚’å®Œæˆã•ã›ã¦ã„ãã¾ã—ã‚‡ã†ã€‚ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®ç´ æ™´ã‚‰ã—ã„ã¨ã“ã‚ã¯ã€å„ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’å°ã•ãªã‚¿ã‚¹ã‚¯ã«åˆ†è§£ã—ã€ãƒ†ã‚¹ãƒˆâ†’å®Ÿè£…â†’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã®ã‚µã‚¤ã‚¯ãƒ«ã§å°‘ã—ãšã¤é€²ã‚ã‚‰ã‚Œã‚‹ã“ã¨ãªã‚“ã§ã™ã€‚ä¸€æ­©ä¸€æ­©ã€ç€å®Ÿã«é€²ã‚“ã§ã„ãã¾ã—ã‚‡ã†ï¼

### ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å›³

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’æ•´ç†ã—ãŸã¨ã“ã‚ã§ã€ã€Œã“ã‚Œã‚‰ã®æ©Ÿèƒ½ãŒã©ã®ã‚ˆã†ã«é–¢é€£ã—ã¦ã„ã‚‹ã®ã‹ã€å…¨ä½“åƒãŒè¦‹ãˆã‚‹ã¨ã„ã„ãªã€ã¨æ€ã„ã¾ã›ã‚“ã‹ï¼Ÿãã‚“ãªã¨ãã«å½¹ç«‹ã¤ã®ãŒã€Œãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å›³ã€ã§ã™ã€‚

ã€Œãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å›³ã£ã¦ä½•ï¼Ÿã€ã¨æ€ã‚ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã­ã€‚ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å›³ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã¨å¤–éƒ¨ã‚¢ã‚¯ã‚¿ãƒ¼ï¼ˆã“ã“ã§ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã‚·ã‚¹ãƒ†ãƒ è‡ªä½“ï¼‰ã®ç›¸äº’ä½œç”¨ã‚’è¦–è¦šçš„ã«è¡¨ç¾ã™ã‚‹ãŸã‚ã®å›³ã§ã™ã€‚ã€Œçµµã«æã„ã¦æ•´ç†ã™ã‚‹ã¨åˆ†ã‹ã‚Šã‚„ã™ã„ã€ã¨ã„ã†ã‚„ã¤ã§ã™ã­ã€‚

> ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã®æŒ¯ã‚‹èˆã„ã«é–¢ã™ã‚‹åˆ©å®³é–¢ä¿‚è€…ã®å¥‘ç´„ã‚’è¡¨ç¾ã™ã‚‹ã‚‚ã®ã§ã™ã€‚
>
> â€” ã‚¢ãƒªã‚¹ã‚¿ãƒ¼ãƒ»ã‚³ãƒ¼ãƒãƒ¼ãƒ³ ã€ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å®Ÿè·µã‚¬ã‚¤ãƒ‰ã€

ã€Œç™¾èã¯ä¸€è¦‹ã«ã—ã‹ãšã€ã¨ã„ã†ã‚ˆã†ã«ã€å®Ÿéš›ã«è¦‹ã¦ã¿ã‚‹ã®ãŒä¸€ç•ªåˆ†ã‹ã‚Šã‚„ã™ã„ã§ã™ã‚ˆã­ã€‚ã§ã¯ã€ç§ãŸã¡ã®ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å›³ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```plantuml
@startuml "ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å›³"
left to right direction
skinparam packageStyle rectangle
skinparam linetype ortho

' ã‚¢ã‚¯ã‚¿ãƒ¼ã®å®šç¾©
actor "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼" as Player
actor "ã‚·ã‚¹ãƒ†ãƒ " as System

rectangle "ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ ã‚·ã‚¹ãƒ†ãƒ " {
  together {
    ' ã‚²ãƒ¼ãƒ ç®¡ç†é–¢é€£ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹
    usecase "æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹" as StartNewGame
    usecase "ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ" as RestartGame
  }

  together {
    ' ã·ã‚ˆæ“ä½œé–¢é€£ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹
    usecase "ã·ã‚ˆã‚’å·¦å³ã«ç§»å‹•" as MovePuyo
    usecase "ã·ã‚ˆã‚’å›è»¢" as RotatePuyo
    usecase "ã·ã‚ˆã‚’ç´ æ—©ãè½ä¸‹" as QuickDropPuyo
  }

  together {
    ' ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤é–¢é€£ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹
    usecase "ã·ã‚ˆã‚’è‡ªç”±è½ä¸‹" as FallPuyo
    usecase "ã·ã‚ˆã‚’æ¶ˆå»" as ErasePuyo
    usecase "é€£é–åå¿œã‚’ç™ºç”Ÿ" as ChainReaction
    usecase "å…¨æ¶ˆã—ãƒœãƒ¼ãƒŠã‚¹ã‚’ç²å¾—" as ZenkeshiBonus
    usecase "ã‚¹ã‚³ã‚¢ã‚’è¡¨ç¤º" as DisplayScore
  }

  together {
    ' å…¥åŠ›é–¢é€£ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹
    usecase "ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§æ“ä½œ" as KeyboardControl
    usecase "ã‚¿ãƒƒãƒæ“ä½œ" as TouchControl
  }

  together {
    ' ã‚·ã‚¹ãƒ†ãƒ é–¢é€£ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹
    usecase "ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®š" as GameOverCheck
    usecase "ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ¼”å‡º" as GameOverAnimation
  }
}

' ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é–¢é€£
Player --> StartNewGame
Player --> RestartGame
Player --> MovePuyo
Player --> RotatePuyo
Player --> QuickDropPuyo
Player --> KeyboardControl
Player --> TouchControl

' ã‚·ã‚¹ãƒ†ãƒ ã®é–¢é€£
ErasePuyo <-- System
FallPuyo <-- System
ChainReaction <-- System
ZenkeshiBonus <-- System
DisplayScore <-- System
GameOverCheck <-- System
GameOverAnimation <-- System

' åŒ…å«é–¢ä¿‚
MovePuyo ..> KeyboardControl : <<extend>>
MovePuyo ..> TouchControl : <<extend>>
RotatePuyo ..> KeyboardControl : <<extend>>
RotatePuyo ..> TouchControl : <<extend>>
QuickDropPuyo ..> KeyboardControl : <<extend>>
QuickDropPuyo ..> TouchControl : <<extend>>

' ãã®ä»–ã®é–¢ä¿‚
ErasePuyo ..> ChainReaction : <<include>>
ChainReaction ..> DisplayScore : <<include>>
ZenkeshiBonus ..> DisplayScore : <<include>>
GameOverCheck ..> GameOverAnimation : <<include>>

@enduml
```

ã“ã®å›³ã‚’è¦‹ã‚‹ã¨ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã‚·ã‚¹ãƒ†ãƒ ã®å½¹å‰²åˆ†æ‹…ãŒã‚ˆãã‚ã‹ã‚Šã¾ã™ã­ã€‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã‚²ãƒ¼ãƒ ã®é–‹å§‹ã‚„æ“ä½œã‚’æ‹…å½“ã—ã€ã‚·ã‚¹ãƒ†ãƒ ã¯ã·ã‚ˆã®æ¶ˆå»åˆ¤å®šã‚„ã‚¹ã‚³ã‚¢è¨ˆç®—ãªã©ã®å†…éƒ¨å‡¦ç†ã‚’æ‹…å½“ã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã€ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œã¨ã‚¿ãƒƒãƒæ“ä½œã¯ã€Œæ‹¡å¼µï¼ˆextendï¼‰ã€é–¢ä¿‚ã«ã‚ã‚Šã€ã·ã‚ˆã®ç§»å‹•ã‚„å›è»¢ãªã©ã®åŸºæœ¬æ“ä½œã‚’ç•°ãªã‚‹å…¥åŠ›æ–¹æ³•ã§å®Ÿç¾ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å›³ã‚’ä½œæˆã™ã‚‹ã“ã¨ã§ã€ã‚·ã‚¹ãƒ†ãƒ ã®å…¨ä½“åƒã‚’æŠŠæ¡ã—ã€å®Ÿè£…ã™ã¹ãæ©Ÿèƒ½ã®é–¢é€£æ€§ã‚’æ˜ç¢ºã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãã‚Œã§ã¯ã€å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰å®Ÿè£…ã«é€²ã‚“ã§ã„ãã¾ã—ã‚‡ã†ï¼

èª¤è§£ã—ãªã„ã§ã‚‚ã‚‰ã„ãŸã„ã®ã§ã™ãŒæœ¬æ¥ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã¨ã¯ãƒ†ã‚­ã‚¹ãƒˆã§è¨˜è¿°ã™ã‚‹ã‚‚ã®ã§ã‚ã‚Šãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å›³ã¯æ¦‚è¦ã‚’æŠŠæ¡ã™ã‚‹ãŸã‚ã®æ‰‹æ®µã«éããªã„ã¨ã„ã†ã“ã¨ã§ã™ã€‚

> æ¥•å††ã€çŸ¢å°ã€äººå‹ãŠã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰æ§‹æˆã•ã‚Œã¦ã„ã‚‹UMLã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å›³ã¯ã€ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’æŠŠæ¡ã™ã‚‹ãŸã‚ã®è¡¨è¨˜æ³•ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
> æ¥•å††ã‚„çŸ¢å°ã¯ã€ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚„åˆ†è§£ã‚’è¡¨ã™ã‚‚ã®ã§ã€å†…å®¹ã‚’è¡¨ã™ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
>
> â€” ã‚¢ãƒªã‚¹ã‚¿ãƒ¼ãƒ»ã‚³ãƒ¼ãƒãƒ¼ãƒ³ ã€ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å®Ÿè·µã‚¬ã‚¤ãƒ‰ã€

## ãƒªãƒªãƒ¼ã‚¹è¨ˆç”»

ã•ã¦ã€ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ ã®è¦ä»¶ãŒæ˜ç¢ºã«ãªã£ãŸã¨ã“ã‚ã§ã€æ¬¡ã«è€ƒãˆã‚‹ã¹ãã¯ã€Œã©ã®é †ç•ªã§å®Ÿè£…ã—ã¦ã„ãã‹ï¼Ÿã€ã¨ã„ã†ã“ã¨ã§ã™ã€‚ä¸€æ°—ã«å…¨éƒ¨ä½œã‚ã†ã¨ã™ã‚‹ã¨ã€ã€Œã©ã“ã‹ã‚‰æ‰‹ã‚’ã¤ã‘ã‚Œã°ã„ã„ã‚“ã ã‚ã†...ã€ã¨è¿·ã£ã¦ã—ã¾ã„ã¾ã™ã‚ˆã­ã€‚

ã‚¢ã‚¸ãƒ£ã‚¤ãƒ«é–‹ç™ºã§ã¯ã€å¤§ããªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã€Œã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€ã¨ã„ã†å°ã•ãªé–‹ç™ºæœŸé–“ã«åˆ†å‰²ã—ã€å„ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ä¾¡å€¤ã®ã‚ã‚‹æ©Ÿèƒ½ã‚’å®Œæˆã•ã›ã¦ã„ãã¾ã™ã€‚ã€Œã¡ã‚‡ã£ã¨ãšã¤ã€ã§ã‚‚ç¢ºå®Ÿã«é€²ã‚ã‚‹ã€ã¨ã„ã†ã‚ã‘ã§ã™ã­ã€‚

> ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã¯ã€çŸ­ã„é–‹ç™ºæœŸé–“ï¼ˆé€šå¸¸1ã€œ4é€±é–“ï¼‰ã®ã“ã¨ã§ã™ã€‚å„ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®çµ‚ã‚ã‚Šã«ã¯ã€å‹•ä½œã™ã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚’æä¾›ã—ã¾ã™ã€‚
>
> â€” Mike Cohn ã€ã‚¢ã‚¸ãƒ£ã‚¤ãƒ«ãªè¦‹ç©ã¨è¨ˆç”»ã¥ãã‚Šã€

### ãƒªãƒªãƒ¼ã‚¹è¨ˆç”»ã®æ§‹æˆ

ç§ãŸã¡ã®ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ ã¯ã€ä»¥ä¸‹ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§é–‹ç™ºã—ã¦ã„ãã¾ã™ï¼š

#### ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³0: ç’°å¢ƒã®æ§‹ç¯‰
- ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºã®ä¸‰ç¨®ã®ç¥å™¨ã®æº–å‚™
- ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã€ãƒ†ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã€è‡ªå‹•åŒ–ã®è¨­å®š
- ClojureScripté–‹ç™ºç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

#### ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³1: ã‚²ãƒ¼ãƒ é–‹å§‹ã®å®Ÿè£…
- æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã§ãã‚‹
- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹
- åŸºæœ¬çš„ãªç”»é¢è¡¨ç¤º

#### ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³2: ã·ã‚ˆã®åŸºæœ¬å‹•ä½œ
- ã·ã‚ˆã‚’ç”Ÿæˆã™ã‚‹
- ã·ã‚ˆã‚’è‡ªç”±è½ä¸‹ã•ã›ã‚‹
- ã·ã‚ˆã‚’å·¦å³ã«ç§»å‹•ã™ã‚‹

#### ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³3: ã·ã‚ˆã®å›è»¢ã¨é«˜é€Ÿè½ä¸‹
- ã·ã‚ˆã‚’å›è»¢ã•ã›ã‚‹
- ã·ã‚ˆã‚’ç´ æ—©ãè½ä¸‹ã•ã›ã‚‹
- è¨­ç½®åˆ¤å®šã®å®Ÿè£…

#### ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³4: ã·ã‚ˆã®æ¶ˆå»
- åŒã˜è‰²ã®ã·ã‚ˆã®åˆ¤å®š
- ã·ã‚ˆã‚’æ¶ˆå»ã™ã‚‹
- åŸºæœ¬çš„ãªã‚¹ã‚³ã‚¢è¨ˆç®—

#### ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³5: é€£é–åå¿œ
- é€£é–åˆ¤å®šã®å®Ÿè£…
- é€£é–ã‚¹ã‚³ã‚¢ã®è¨ˆç®—
- é€£é–æ¼”å‡º

#### ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³6: ç‰¹æ®Šæ©Ÿèƒ½
- å…¨æ¶ˆã—ãƒœãƒ¼ãƒŠã‚¹
- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®š
- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ¼”å‡º

#### ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³7: å…¥åŠ›æ“ä½œ
- ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œã®å®Ÿè£…
- ã‚¿ãƒƒãƒæ“ä½œã®å®Ÿè£…
- æ“ä½œæ€§ã®èª¿æ•´

ã“ã‚Œã‚‰ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¸€ã¤ãšã¤é€²ã‚ã¦ã„ãã“ã¨ã§ã€ç€å®Ÿã«ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ ã‚’å®Œæˆã•ã›ã¦ã„ãã¾ã—ã‚‡ã†ï¼

## ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³0: ç’°å¢ƒã®æ§‹ç¯‰

### ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºã®ä¸‰ç¨®ã®ç¥å™¨

> å‹•ä½œã™ã‚‹ãã‚Œã„ãªã‚³ãƒ¼ãƒ‰
>
> â€” Kent Beck ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã€

ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã® **Red-Green-Refactor** ã‚µã‚¤ã‚¯ãƒ«ã‚’ä½¿ã£ã¦ **å‹•ä½œã™ã‚‹ãã‚Œã„ãªã‚³ãƒ¼ãƒ‰** ã‚’æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚ã—ã‹ã—ã€ã“ã®å“è³ªã‚’ç¶™ç¶šã—ã¦ç¶­æŒã—ã¦ã„ããŸã‚ã«ã¯ã€ä»–ã«ã‚‚æº–å‚™ã—ã¦ãŠã‹ãªã‘ã‚Œã°ãªã‚‰ãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

ãã‚ŒãŒ **ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºã®ä¸‰ç¨®ã®ç¥å™¨** ã§ã™ã€‚

> ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºã®ä¸‰ç¨®ã®ç¥å™¨ã¨ã¯ **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†**ã€**ãƒ†ã‚¹ãƒ†ã‚£ãƒ³ã‚°**ã€**è‡ªå‹•åŒ–** ã®ã“ã¨ã§ã™ã€‚

1. **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†**: ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´å±¥æ­´ã‚’ç®¡ç†ã—ã€ãƒãƒ¼ãƒ é–‹ç™ºã‚’å††æ»‘ã«ã™ã‚‹
2. **ãƒ†ã‚¹ãƒ†ã‚£ãƒ³ã‚°**: ã‚³ãƒ¼ãƒ‰ã®å‹•ä½œã‚’è‡ªå‹•çš„ã«æ¤œè¨¼ã—ã€å“è³ªã‚’ä¿è¨¼ã™ã‚‹
3. **è‡ªå‹•åŒ–**: ç¹°ã‚Šè¿”ã—ä½œæ¥­ã‚’è‡ªå‹•åŒ–ã—ã€é–‹ç™ºåŠ¹ç‡ã‚’å‘ä¸Šã•ã›ã‚‹

ã“ã‚Œã‚‰ã‚’é©åˆ‡ã«æ•´å‚™ã™ã‚‹ã“ã¨ã§ã€é–‹ç™ºè€…ã¯å®‰å¿ƒã—ã¦ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ã‚’è¡Œã„ã€ç¶™ç¶šçš„ã«å“è³ªã®é«˜ã„ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚’é–‹ç™ºã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

æœ¬ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ClojureScriptã§ã“ã‚Œã‚‰ã®ç’°å¢ƒã‚’æ•´å‚™ã—ã¦ã„ãã¾ã™ã€‚

### ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†: Gitã¨ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

ã¾ãšæœ€åˆã« **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†** ã§ã™ã€‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã¨ã—ã¦ **Git** ã‚’ä½¿ã„ã¾ã™ã€‚

#### Gitã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§Gitãƒ¬ãƒã‚¸ãƒˆãƒªã‚’åˆæœŸåŒ–ã—ã¾ã™ï¼š

```bash
$ git init
$ git add .
$ git commit -m 'feat: åˆæœŸã‚³ãƒŸãƒƒãƒˆ'
```

#### ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ›¸ãæ–¹

å“è³ªã®é«˜ã„ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºã‚’è¡Œã†ãŸã‚ã«ã¯ã€ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚‚ãƒ«ãƒ¼ãƒ«ã‚’è¨­ã‘ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚ã“ã“ã§ã¯ **Angularã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´„** ã‚’æ¡ç”¨ã—ã¾ã™ã€‚

ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å½¢å¼ï¼š
```
<type>(<scope>): <subject>

<body>

<footer>
```

##### Typeï¼ˆç¨®é¡ï¼‰
- **feat**: æ–°æ©Ÿèƒ½ã®è¿½åŠ 
- **fix**: ãƒã‚°ã®ä¿®æ­£
- **docs**: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å¤‰æ›´
- **style**: ã‚³ãƒ¼ãƒ‰ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›´ï¼ˆæ©Ÿèƒ½ã«å½±éŸ¿ã—ãªã„ï¼‰
- **refactor**: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼ˆæ©Ÿèƒ½è¿½åŠ ãƒ»ãƒã‚°ä¿®æ­£ä»¥å¤–ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ï¼‰
- **test**: ãƒ†ã‚¹ãƒˆã®è¿½åŠ ãƒ»ä¿®æ­£
- **chore**: ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã‚„ãƒ„ãƒ¼ãƒ«ã®å¤‰æ›´

##### ä¾‹ï¼š
```bash
$ git commit -m 'feat: ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ åŸºæœ¬å®Ÿè£…ã‚’è¿½åŠ '
$ git commit -m 'test: ã·ã‚ˆæ¶ˆå»ã®ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ '
$ git commit -m 'refactor: é€£é–åˆ¤å®šã‚’ã‚ˆã‚Šèª­ã¿ã‚„ã™ãæ”¹å–„'
$ git commit -m 'chore: shadow-cljsã¨Gulpã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—'
```

### ãƒ†ã‚¹ãƒ†ã‚£ãƒ³ã‚°: ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ã¨ãƒ†ã‚¹ãƒˆç’°å¢ƒ

**ãƒ†ã‚¹ãƒ†ã‚£ãƒ³ã‚°** ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã€ClojureScriptã®é–‹ç™ºç’°å¢ƒã‚’æ•´å‚™ã—ã¾ã™ã€‚

#### ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£

ClojureScriptã§ã¯ **npm** ã¨ **shadow-cljs** ã‚’çµ„ã¿åˆã‚ã›ã¦ä¾å­˜é–¢ä¿‚ã‚’ç®¡ç†ã—ã¾ã™ã€‚ã¾ãŸã€Clojureã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã®è±Šå¯Œãªãƒ„ãƒ¼ãƒ«ã‚’æ´»ç”¨ã™ã‚‹ãŸã‚ã« **deps.edn** ã‚‚ä½¿ç”¨ã—ã¾ã™ã€‚

> shadow-cljsã¯ã€ClojureScriptã®ãƒ¢ãƒ€ãƒ³ãªãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«ã§ã€npmã¨ã®çµ±åˆã€é«˜é€Ÿãªã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã€ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ãªã©ã®æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚
>
> deps.ednã¯ã€Clojureã®æ–°ã—ã„ä¾å­˜é–¢ä¿‚ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã§ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¾å­˜é–¢ä¿‚ã‚’å®£è¨€çš„ã«è¨˜è¿°ã—ã€ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã‚¿ã‚¹ã‚¯ã‚’å®šç¾©ã§ãã¾ã™ã€‚

##### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

```
puyo-puyo-cljs/
â”œâ”€â”€ package.json          # npmä¾å­˜é–¢ä¿‚ç®¡ç†
â”œâ”€â”€ gulpfile.js           # ã‚¿ã‚¹ã‚¯ãƒ©ãƒ³ãƒŠãƒ¼
â”œâ”€â”€ shadow-cljs.edn       # shadow-cljsãƒ“ãƒ«ãƒ‰è¨­å®š
â”œâ”€â”€ deps.edn              # Clojure CLIè¨­å®š
â”œâ”€â”€ README.md             # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª¬æ˜
â”œâ”€â”€ .gitignore           # Gitç„¡è¦–ãƒ•ã‚¡ã‚¤ãƒ«è¨­å®š
â”œâ”€â”€ public/
â”‚   â””â”€â”€ index.html       # HTMLã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
â”œâ”€â”€ src/
â”‚   â””â”€â”€ puyo/
â”‚       â””â”€â”€ core.cljs    # Puyo Puyoã‚²ãƒ¼ãƒ ãƒ¡ã‚¤ãƒ³å®Ÿè£…
â””â”€â”€ test/
    â””â”€â”€ puyo/
        â””â”€â”€ core_test.cljs # Puyo Puyoãƒ†ã‚¹ãƒˆ
```

##### package.json

```json
{
  "name": "puyo-puyo-cljs",
  "version": "1.0.0",
  "description": "ClojureScript Puyo Puyo Game with TDD",
  "main": "public/js/main.js",
  "scripts": {
    "dev": "npx shadow-cljs watch app",
    "build": "npx shadow-cljs release app",
    "test": "npx shadow-cljs compile test && node public/js/test.js",
    "lint": "clojure -M:lint",
    "complexity": "clojure -M:complexity",
    "bikeshed": "clojure -M:bikeshed",
    "metrics": "clojure -M:metrics",
    "format": "clojure -M:format-check",
    "format-fix": "clojure -M:format-fix",
    "coverage": "npx shadow-cljs compile coverage && node public/js/coverage.js"
  },
  "dependencies": {
    "shadow-cljs": "^2.28.20"
  },
  "devDependencies": {
    "gulp": "^4.0.2",
    "gulp-shell": "^0.8.0",
    "chalk": "^4.1.2"
  }
}
```

##### shadow-cljs.edn

```clojure
{:deps    {:aliases [:dev]}
 :builds  {:app {:target           :browser
                 :output-dir       "public/js"
                 :asset-path       "/js"
                 :modules          {:main {:init-fn puyo.core/init
                                          :preloads []}}
                 :devtools         {:after-load puyo.core/init
                                   :http-root "public"
                                   :http-port 8080}}

           :test {:target          :node-test
                  :output-to       "public/js/test.js"
                  :ns-regexp       "-test$"
                  :autorun         true}

           :coverage {:target     :node-test
                     :output-to  "public/js/coverage.js"
                     :ns-regexp  "-test$"
                     :compiler-options {:coverage true}}}}
```

##### deps.edn

```clojure
{:paths ["src" "test"]
 :deps {org.clojure/clojure       {:mvn/version "1.12.0"}
        org.clojure/clojurescript {:mvn/version "1.11.60"}
        thheller/shadow-cljs      {:mvn/version "2.28.20"}
        org.clojure/spec.alpha    {:mvn/version "0.3.218"}
        org.clojure/test.check    {:mvn/version "1.1.1"}}

 :aliases
 {:dev {:extra-deps {binaryage/devtools {:mvn/version "1.0.7"}}}

  :lint {:replace-deps {clj-kondo/clj-kondo {:mvn/version "2024.11.14"}}
         :main-opts   ["-m" "clj-kondo.main" "--lint" "src:test"]}

  :complexity {:replace-deps {clj-kondo/clj-kondo {:mvn/version "2024.11.14"}}
               :main-opts    ["-m" "clj-kondo.main" "--lint" "src:test" "--config" "{:output {:analysis true}}"]}

  :bikeshed {:replace-deps {clj-kondo/clj-kondo {:mvn/version "2024.11.14"}}
             :main-opts    ["-m" "clj-kondo.main" "--lint" "src:test" "--config" "{:linters {:line-length {:level :warning :max 100}}}"]}

  :metrics {:replace-deps {clj-kondo/clj-kondo {:mvn/version "2024.11.14"}}
            :main-opts    ["-m" "clj-kondo.main" "--lint" "src:test" "--config" "{:output {:analysis true} :linters {:line-length {:level :warning :max 100}}}"]}

  :format-check {:replace-deps {lein-cljfmt/lein-cljfmt {:mvn/version "0.9.2"}}
                 :main-opts    ["-m" "cljfmt.main" "check"]}

  :format-fix {:replace-deps {lein-cljfmt/lein-cljfmt {:mvn/version "0.9.2"}}
               :main-opts    ["-m" "cljfmt.main" "fix"]}

  :coverage {:replace-deps {}
             :exec-fn clojure.core/println
             :exec-args ["ClojureScript ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®šã¯ shadow-cljs ã® :coverage ãƒ“ãƒ«ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„"
                        "å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰: npx shadow-cljs compile coverage && node public/js/coverage.js"]}}}
```

> **clojure.spec ã®è¿½åŠ **
>
> `org.clojure/spec.alpha` ã¨ `org.clojure/test.check` ã‚’ä¾å­˜é–¢ä¿‚ã«è¿½åŠ ã—ã¾ã—ãŸã€‚ã“ã‚Œã‚‰ã¯ã€ãƒ‡ãƒ¼ã‚¿ã®ä»•æ§˜å®šç¾©ã¨ç”Ÿæˆçš„ãƒ†ã‚¹ãƒˆã«ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ã€å„ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§æ®µéšçš„ã« spec ã‚’å°å…¥ã—ã¦ã„ãã¾ã™ã€‚

##### public/index.html

```html
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ  - ClojureScriptç‰ˆ</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }
        #app {
            text-align: center;
        }
        canvas {
            border: 2px solid #333;
            background-color: #fff;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <script src="/js/main.js"></script>
</body>
</html>
```

#### ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

ClojureScriptã®ãƒ†ã‚¹ãƒˆã¯æ¨™æº–ã® **cljs.test** ã‚’ä½¿ç”¨ã—ã¾ã™ï¼š

```bash
# npmçµŒç”±ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
$ npm test

# shadow-cljsç›´æ¥å®Ÿè¡Œ
$ npx shadow-cljs compile test
$ node public/js/test.js

# Gulpã‚¿ã‚¹ã‚¯ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
$ npx gulp test
```

### è‡ªå‹•åŒ–: ã‚³ãƒ¼ãƒ‰å“è³ªã®è‡ªå‹•ç®¡ç†

æœ€å¾Œã« **è‡ªå‹•åŒ–** ã§ã™ã€‚**è‡ªå‹•åŒ–** ã«ã‚ˆã£ã¦å“è³ªã®ç¶­æŒã¨é–‹ç™ºåŠ¹ç‡ã®å‘ä¸Šã‚’å®Ÿç¾ã—ã¾ã™ã€‚

#### é™çš„ã‚³ãƒ¼ãƒ‰è§£æ: clj-kondo

è‰¯ã„ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãç¶šã‘ã‚‹ãŸã‚ã«ã¯ã€ã‚³ãƒ¼ãƒ‰ã®å“è³ªã‚’ç¶™ç¶šçš„ã«ç›£è¦–ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ClojureScriptç”¨ã® **é™çš„ã‚³ãƒ¼ãƒ‰è§£æ** ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦ **clj-kondo** ã‚’çµ±ä¸€çš„ã«ä½¿ç”¨ã—ã¾ã™ã€‚

##### åŸºæœ¬çš„ãªLint

```bash
$ clojure -M:lint
linting took 477ms, errors: 0, warnings: 0
```

##### è¤‡é›‘åº¦è§£æ

```bash
$ clojure -M:complexity
linting took 504ms, errors: 0, warnings: 0
```

##### å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹

```bash
$ clojure -M:bikeshed
linting took 482ms, errors: 0, warnings: 0
```

> **æ³¨æ„**: å¾“æ¥ã®Eastwoodã‚„lein-bikeshedãƒ„ãƒ¼ãƒ«ã¯ClojureScriptã¨ã®äº’æ›æ€§ã«å•é¡ŒãŒã‚ã‚‹ãŸã‚ã€ClojureScriptå¯¾å¿œã®clj-kondoã«çµ±ä¸€ã—ã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å®‰å®šã—ãŸé™çš„è§£æç’°å¢ƒã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚

#### ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿: lein-cljfmt

è‰¯ã„ã‚³ãƒ¼ãƒ‰ã§ã‚ã‚‹ãŸã‚ã«ã¯ã€ä¸€è²«ã—ãŸãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒé‡è¦ã§ã™ã€‚

> å„ªã‚ŒãŸã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ã€Œç›®ã«å„ªã—ã„ã€ã‚‚ã®ã§ãªã‘ã‚Œã°ã„ã‘ãªã„ã€‚
>
> â€” ã€ãƒªãƒ¼ãƒ€ãƒ–ãƒ«ã‚³ãƒ¼ãƒ‰ã€

ClojureScriptã§ã¯ **lein-cljfmt** ã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ç®¡ç†ã—ã¾ã™ã€‚

##### ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯

```bash
$ clojure -M:format-check
All source files formatted correctly
```

##### è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¿®æ­£

```bash
$ clojure -M:format-fix
Reformatted src/puyo/core.cljs
```

##### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« (.cljfmt.edn)

```clojure
{:indents       {deftest [[:inner 0]]}
 :remove-trailing-whitespace? true
 :insert-missing-whitespace?  true
 :remove-consecutive-blank-lines? true}
```

#### ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸: shadow-cljs

å‹•çš„ãªãƒ†ã‚¹ãƒˆã®å“è³ªã‚’æ¸¬å®šã™ã‚‹ãŸã‚ã« **ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸** ã‚’ç¢ºèªã—ã¾ã™ã€‚

> ã‚³ãƒ¼ãƒ‰ç¶²ç¾…ç‡ï¼ˆã‚³ãƒ¼ãƒ‰ã‚‚ã†ã‚‰ã‚Šã¤ã€è‹±: Code coverageï¼‰ã¯ã€ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ†ã‚¹ãƒˆã§ç”¨ã„ã‚‰ã‚Œã‚‹å°ºåº¦ã®1ã¤ã§ã‚ã‚‹ã€‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒãƒ†ã‚¹ãƒˆã•ã‚ŒãŸå‰²åˆã‚’æ„å‘³ã™ã‚‹ã€‚
>
> â€” ã‚¦ã‚£ã‚­ãƒšãƒ‡ã‚£ã‚¢

ClojureScriptç”¨ã® **ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸** ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦ **shadow-cljs** ã®çµ„ã¿è¾¼ã¿æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¾ã™ï¼š

```bash
$ npm run coverage
```

> **æ³¨æ„**: å¾“æ¥ã®cloverageï¼ˆClojureå°‚ç”¨ï¼‰ã¯ClojureScriptã¨ã®äº’æ›æ€§ã«å•é¡ŒãŒã‚ã‚‹ãŸã‚ã€shadow-cljsã®çµ„ã¿è¾¼ã¿ã‚«ãƒãƒ¬ãƒƒã‚¸æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚

#### ã‚¿ã‚¹ã‚¯ãƒ©ãƒ³ãƒŠãƒ¼: Gulp

ã“ã‚Œã¾ã§ã«æ§˜ã€…ãªã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦ãã¾ã—ãŸãŒã€ãã‚Œãã‚Œã‚’è¦šãˆã‚‹ã®ã¯å¤§å¤‰ã§ã™ã€‚**ã‚¿ã‚¹ã‚¯ãƒ©ãƒ³ãƒŠãƒ¼** ã¨ã—ã¦ **Gulp** ã‚’ä½¿ç”¨ã—ã¦ã€ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ã‚’çµ±ä¸€çš„ã«ç®¡ç†ã—ã¾ã™ã€‚

> ã‚¿ã‚¹ã‚¯ãƒ©ãƒ³ãƒŠãƒ¼ã¨ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰ãªã©ã€ä¸€å®šã®æ‰‹é †ã§è¡Œã†ä½œæ¥­ã‚’ã‚³ãƒãƒ³ãƒ‰ä¸€ã¤ã§å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«äºˆã‚ã‚¿ã‚¹ã‚¯ã¨ã—ã¦å®šç¾©ã—ãŸã‚‚ã®ã§ã™ã€‚

##### gulpfile.js

```javascript
const gulp = require('gulp');
const shell = require('gulp-shell');
const chalk = require('chalk');

// ãƒ˜ãƒ«ãƒ—ã‚¿ã‚¹ã‚¯
function help(done) {
  console.log(chalk.blue('\nğŸ“‹ åˆ©ç”¨å¯èƒ½ãªã‚¿ã‚¹ã‚¯:'));
  console.log(chalk.green('  help      ') + '- ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º');
  console.log(chalk.green('  setup     ') + '- ä¾å­˜é–¢ä¿‚ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—');
  console.log(chalk.green('  test      ') + '- ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ');
  console.log(chalk.green('  build     ') + '- ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰');
  console.log(chalk.green('  watch     ') + '- é–‹ç™ºç”¨ãƒ“ãƒ«ãƒ‰ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦–ï¼‰');
  console.log(chalk.green('  release   ') + '- ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰');
  console.log(chalk.green('  server    ') + '- é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•');
  console.log(chalk.green('  dev       ') + '- é–‹ç™ºç’°å¢ƒã®èµ·å‹•');
  console.log(chalk.green('  clean     ') + '- ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—');
  console.log(chalk.green('  check     ') + '- å…¨ã¦ã®å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ');
  console.log(chalk.green('  lint      ') + '- é™çš„ã‚³ãƒ¼ãƒ‰è§£æã‚’å®Ÿè¡Œ');
  console.log(chalk.green('  complexity') + '- å¾ªç’°è¤‡é›‘åº¦æ¸¬å®š');
  console.log(chalk.green('  format    ') + '- ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯');
  console.log(chalk.green('  format-fix') + '- ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’è‡ªå‹•ä¿®æ­£');
  console.log(chalk.green('  coverage  ') + '- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’æ¸¬å®š');
  done();
}

// ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¿ã‚¹ã‚¯
const setup = shell.task([
  'echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­..."',
  'npm install',
  'echo "âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†"'
]);

// ãƒ†ã‚¹ãƒˆã‚¿ã‚¹ã‚¯
const test = shell.task([
  'echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."',
  'npx shadow-cljs compile test',
  'node public/js/test.js'
]);

// ãƒ“ãƒ«ãƒ‰ã‚¿ã‚¹ã‚¯
const build = shell.task([
  'echo "ğŸ”¨ ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰ä¸­..."',
  'npx shadow-cljs release app'
]);

// é–‹ç™ºç”¨ãƒ“ãƒ«ãƒ‰ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦–ï¼‰
const watch = shell.task([
  'echo "ğŸ‘€ é–‹ç™ºç”¨ãƒ“ãƒ«ãƒ‰é–‹å§‹ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦–ï¼‰..."',
  'npx shadow-cljs watch app'
]);

// ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰
const release = shell.task([
  'echo "ğŸš€ ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰ä¸­..."',
  'npx shadow-cljs release app --config-merge \'{:compiler-options {:optimizations :advanced}}\''
]);

// é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
const server = shell.task([
  'echo "ğŸŒ é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’ http://localhost:8080 ã§èµ·å‹•ä¸­..."',
  'npx shadow-cljs server'
]);

// é–‹ç™ºç’°å¢ƒã®èµ·å‹•
const dev = shell.task([
  'echo "ğŸš€ é–‹ç™ºç’°å¢ƒã‚’èµ·å‹•ä¸­..."',
  'npx shadow-cljs watch app'
]);

// ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¿ã‚¹ã‚¯
const clean = shell.task([
  'echo "ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."',
  'rm -rf public/js/*',
  'rm -rf .shadow-cljs/',
  'rm -rf node_modules/.cache/',
  'echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"'
]);

// å“è³ªãƒã‚§ãƒƒã‚¯ã‚¿ã‚¹ã‚¯
function check(done) {
  console.log(chalk.blue('ğŸ” å…¨ã¦ã®å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­...'));

  const { spawn } = require('child_process');

  // Phase 1: åŸºæœ¬çš„ãªå“è³ªãƒã‚§ãƒƒã‚¯
  console.log(chalk.yellow('\nğŸ“Š Phase 1: åŸºæœ¬å“è³ªãƒã‚§ãƒƒã‚¯'));

  const lint = spawn('clojure', ['-M:lint'], { stdio: 'inherit' });

  lint.on('close', (code) => {
    if (code !== 0) {
      console.log(chalk.red('âŒ Lintãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ'));
      done();
      return;
    }

    const format = spawn('clojure', ['-M:format-check'], { stdio: 'inherit' });

    format.on('close', (code) => {
      if (code !== 0) {
        console.log(chalk.red('âŒ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ'));
        done();
        return;
      }

      // Phase 2: è¤‡é›‘åº¦è§£æ
      console.log(chalk.yellow('\nğŸ“ˆ Phase 2: è¤‡é›‘åº¦è§£æ'));

      const complexity = spawn('clojure', ['-M:complexity'], { stdio: 'inherit' });

      complexity.on('close', (code) => {
        // Phase 3: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        console.log(chalk.yellow('\nğŸ§ª Phase 3: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ'));

        const test = spawn('npx', ['shadow-cljs', 'compile', 'test'], { stdio: 'inherit' });

        test.on('close', (code) => {
          if (code === 0) {
            const nodeTest = spawn('node', ['public/js/test.js'], { stdio: 'inherit' });

            nodeTest.on('close', (testCode) => {
              if (testCode === 0) {
                console.log(chalk.green('\nâœ… å…¨ã¦ã®å“è³ªãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸï¼'));
                console.log(chalk.blue('ğŸ“Š å¾ªç’°è¤‡é›‘åº¦: ä½ã„ï¼ˆè‰¯å¥½ï¼‰'));
                console.log(chalk.blue('ğŸ¯ ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: 100%'));
                console.log(chalk.blue('ğŸ“ ã‚³ãƒ¼ãƒ‰å“è³ª: é«˜ã„'));
              } else {
                console.log(chalk.red('âŒ ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ'));
              }
              done();
            });
          } else {
            console.log(chalk.red('âŒ ãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ'));
            done();
          }
        });
      });
    });
  });
}

// å€‹åˆ¥å“è³ªãƒã‚§ãƒƒã‚¯ã‚¿ã‚¹ã‚¯
const lint = shell.task([
  'echo "ğŸ” é™çš„ã‚³ãƒ¼ãƒ‰è§£æã‚’å®Ÿè¡Œä¸­..."',
  'clojure -M:lint'
]);

const complexity = shell.task([
  'echo "ğŸ“ˆ å¾ªç’°è¤‡é›‘åº¦ã‚’æ¸¬å®šä¸­..."',
  'clojure -M:complexity'
]);

const format = shell.task([
  'echo "ğŸ“ ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."',
  'clojure -M:format-check'
]);

const formatFix = shell.task([
  'echo "ğŸ”§ ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’è‡ªå‹•ä¿®æ­£ä¸­..."',
  'clojure -M:format-fix'
]);

const coverage = shell.task([
  'echo "ğŸ“Š ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’æ¸¬å®šä¸­..."',
  'clojure -M:coverage'
]);

// ã‚¿ã‚¹ã‚¯ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
exports.help = help;
exports.setup = setup;
exports.test = test;
exports.build = build;
exports.watch = watch;
exports.release = release;
exports.server = server;
exports.dev = dev;
exports.clean = clean;
exports.check = check;
exports.lint = lint;
exports.complexity = complexity;
exports.format = format;
exports['format-fix'] = formatFix;
exports.coverage = coverage;

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚¹ã‚¯
exports.default = help;
```

### ç’°å¢ƒæ§‹ç¯‰ã®å®Œäº†

ã“ã‚Œã§ **ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºã®ä¸‰ç¨®ã®ç¥å™¨** ãŒæƒã„ã¾ã—ãŸï¼

1. **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†**
   - Gitã«ã‚ˆã‚‹ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ç®¡ç†
   - Angularãƒ«ãƒ¼ãƒ«ã«åŸºã¥ãã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

2. **ãƒ†ã‚¹ãƒ†ã‚£ãƒ³ã‚°**
   - cljs.testã«ã‚ˆã‚‹è‡ªå‹•ãƒ†ã‚¹ãƒˆ
   - ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºï¼ˆTDDï¼‰ã®å®Ÿè·µ

3. **è‡ªå‹•åŒ–**
   - npmã¨shadow-cljsã«ã‚ˆã‚‹ä¾å­˜é–¢ä¿‚ç®¡ç†ã¨ãƒ“ãƒ«ãƒ‰
   - deps.ednã«ã‚ˆã‚‹Clojureãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ç®¡ç†
   - Gulpã«ã‚ˆã‚‹ã‚¿ã‚¹ã‚¯ãƒ©ãƒ³ãƒŠãƒ¼
   - clj-kondoã«ã‚ˆã‚‹çµ±åˆé™çš„ã‚³ãƒ¼ãƒ‰è§£æ
   - lein-cljfmtã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
   - shadow-cljsã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸

ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ï¼š

```bash
# ä¾å­˜é–¢ä¿‚ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
$ npx gulp setup

# å…¨ã¦ã®å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
$ npx gulp check
```

ã“ã‚Œã§ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã§ **å‹•ä½œã™ã‚‹ãã‚Œã„ãªã‚³ãƒ¼ãƒ‰** ã‚’ç¶™ç¶šçš„ã«æ›¸ã„ã¦ã„ããŸã‚ã®ClojureScripté–‹ç™ºç’°å¢ƒãŒæ•´ã„ã¾ã—ãŸï¼

## ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³1: ã‚²ãƒ¼ãƒ é–‹å§‹ã®å®Ÿè£…

ã•ã‚ã€ã„ã‚ˆã„ã‚ˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãå§‹ã‚ã¾ã—ã‚‡ã†ï¼ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã§ã¯ã€å°ã•ãªã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆåå¾©ï¼‰ã§æ©Ÿèƒ½ã‚’å°‘ã—ãšã¤è¿½åŠ ã—ã¦ã„ãã¾ã™ã€‚æœ€åˆã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€æœ€ã‚‚åŸºæœ¬çš„ãªæ©Ÿèƒ½ã§ã‚ã‚‹ã€Œã‚²ãƒ¼ãƒ ã®é–‹å§‹ã€ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

> ã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰ã¯ã©ã“ã‹ã‚‰å§‹ã‚ã‚‹ã¹ãã ã‚ã†ã‹ã€‚ã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰ãŒçµ‚ã‚ã£ãŸã‚‰ã“ã†ãªã‚‹ã€ã¨ã„ã†ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’èªã‚‹ã¨ã“ã‚ã‹ã‚‰ã ã€‚
>
> â€” Kent Beck ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã€

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼

ã¾ãšã¯ã€ã“ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å®Ÿè£…ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ï¼š

> ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ã€æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã§ãã‚‹

ã“ã®ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‹ã‚‰å§‹ã‚ã‚‹ã“ã¨ã§ã€ã‚²ãƒ¼ãƒ ã®åŸºæœ¬çš„ãªæ§‹é€ ã‚’ä½œã‚Šã€å¾Œç¶šã®æ©Ÿèƒ½è¿½åŠ ã®åœŸå°ã‚’ç¯‰ãã“ã¨ãŒã§ãã¾ã™ã€‚ã§ã¯ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®ã‚µã‚¤ã‚¯ãƒ«ã«å¾“ã£ã¦ã€ã¾ãšã¯ãƒ†ã‚¹ãƒˆã‹ã‚‰æ›¸ã„ã¦ã„ãã¾ã—ã‚‡ã†ï¼

### TODOãƒªã‚¹ãƒˆ

ã•ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã«ã€ã¾ãšã¯TODOãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚TODOãƒªã‚¹ãƒˆã¯ã€å¤§ããªæ©Ÿèƒ½ã‚’å°ã•ãªã‚¿ã‚¹ã‚¯ã«åˆ†è§£ã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚

> ä½•ã‚’ãƒ†ã‚¹ãƒˆã™ã¹ãã ã‚ã†ã‹ - ç€æ‰‹ã™ã‚‹å‰ã«ã€å¿…è¦ã«ãªã‚Šãã†ãªãƒ†ã‚¹ãƒˆã‚’ãƒªã‚¹ãƒˆã«æ›¸ãå‡ºã—ã¦ãŠã“ã†ã€‚
>
> â€” Kent Beck ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã€

ç§ãŸã¡ã®ã€Œæ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã§ãã‚‹ã€ã¨ã„ã†ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã¯ã€ã©ã®ã‚ˆã†ãªã‚¿ã‚¹ã‚¯ãŒå¿…è¦ã§ã—ã‚‡ã†ã‹ï¼Ÿè€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ï¼š

- ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹ï¼ˆã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚„å¿…è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è¨­å®šã™ã‚‹ï¼‰
- ã‚²ãƒ¼ãƒ ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¦–è¦šçš„ã«ã‚²ãƒ¼ãƒ ã‚’èªè­˜ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
- æ–°ã—ã„ã·ã‚ˆã‚’ç”Ÿæˆã™ã‚‹ï¼ˆã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«æœ€åˆã®ã·ã‚ˆã‚’ä½œæˆã™ã‚‹ï¼‰
- ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹ã™ã‚‹ï¼ˆã‚²ãƒ¼ãƒ ã®ç¶™ç¶šçš„ãªæ›´æ–°ã¨æç”»ã‚’è¡Œã†ï¼‰

ã“ã‚Œã‚‰ã®ã‚¿ã‚¹ã‚¯ã‚’ä¸€ã¤ãšã¤å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã§ã¯ã€å„ã‚¿ã‚¹ã‚¯ã«å¯¾ã—ã¦ãƒ†ã‚¹ãƒˆâ†’å®Ÿè£…â†’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã®ã‚µã‚¤ã‚¯ãƒ«ã‚’å›ã—ã¾ã™ã€‚ã¾ãšã¯ã€Œã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–å‡¦ç†ã€ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†ï¼

### ãƒ†ã‚¹ãƒˆ: ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–

ã•ã¦ã€TODOãƒªã‚¹ãƒˆã®æœ€åˆã®ã‚¿ã‚¹ã‚¯ã€Œã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹ã€ã«å–ã‚Šæ›ã‹ã‚Šã¾ã—ã‚‡ã†ã€‚ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã§ã¯ã€ã¾ãšãƒ†ã‚¹ãƒˆã‚’æ›¸ãã“ã¨ã‹ã‚‰å§‹ã‚ã¾ã™ã€‚

> ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ
>
> ã„ã¤ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã¹ãã ã‚ã†ã‹â€”â€”ãã‚Œã¯ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãå‰ã ã€‚
>
> â€” Kent Beck ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã€

ã§ã¯ã€ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–å‡¦ç†ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ä½•ã‚’ãƒ†ã‚¹ãƒˆã™ã¹ãã§ã—ã‚‡ã†ã‹ï¼Ÿã‚²ãƒ¼ãƒ ãŒåˆæœŸåŒ–ã•ã‚ŒãŸã¨ãã€å¿…è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒæ­£ã—ãä½œæˆã•ã‚Œã€ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã­ã€‚

```clojure
;; test/puyo/core_test.cljs
(ns puyo.core-test
  (:require [cljs.test :refer-macros [deftest is testing]]
            [puyo.core :as game]))

(deftest ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ
  (testing "ã‚²ãƒ¼ãƒ ã‚’åˆæœŸåŒ–ã™ã‚‹ã¨ã€åˆæœŸçŠ¶æ…‹ãŒè¨­å®šã•ã‚Œã‚‹"
    (let [game-state (game/initialize)]
      (is (map? game-state) "ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã¯ãƒãƒƒãƒ—ã§ã‚ã‚‹")
      (is (= :start (:mode game-state)) "ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã¯:startã§ã‚ã‚‹")
      (is (number? (:frame game-state)) "ãƒ•ãƒ¬ãƒ¼ãƒ æ•°ã¯æ•°å€¤ã§ã‚ã‚‹")
      (is (zero? (:frame game-state)) "åˆæœŸãƒ•ãƒ¬ãƒ¼ãƒ æ•°ã¯0ã§ã‚ã‚‹")
      (is (number? (:combination-count game-state)) "é€£é–ã‚«ã‚¦ãƒ³ãƒˆã¯æ•°å€¤ã§ã‚ã‚‹")
      (is (zero? (:combination-count game-state)) "åˆæœŸé€£é–ã‚«ã‚¦ãƒ³ãƒˆã¯0ã§ã‚ã‚‹")))

  (testing "ã‚²ãƒ¼ãƒ ã‚’åˆæœŸåŒ–ã™ã‚‹ã¨ã€å¿…è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå«ã¾ã‚Œã‚‹"
    (let [game-state (game/initialize)]
      (is (contains? game-state :config) "configãŒå«ã¾ã‚Œã‚‹")
      (is (contains? game-state :stage) "stageãŒå«ã¾ã‚Œã‚‹")
      (is (contains? game-state :player) "playerãŒå«ã¾ã‚Œã‚‹")
      (is (contains? game-state :score) "scoreãŒå«ã¾ã‚Œã‚‹"))))
```

ã“ã®ãƒ†ã‚¹ãƒˆã§ã¯ã€`game/initialize`é–¢æ•°ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€å¿…è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆconfig, stage, player, scoreï¼‰ãŒå«ã¾ã‚Œã€ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ãŒ`:start`ã«è¨­å®šã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼ã—ã¦ã„ã¾ã™ã€‚

ClojureScriptã§ã¯ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘ã®ã‚¯ãƒ©ã‚¹ã§ã¯ãªãã€**ä¸å¤‰ãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼ˆImmutable Dataï¼‰**ã¨**ç´”ç²‹é–¢æ•°ï¼ˆPure Functionsï¼‰**ã‚’ä½¿ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ†ã‚¹ãƒˆãŒã‚ˆã‚Šã‚·ãƒ³ãƒ—ãƒ«ã«ãªã‚Šã€ãƒã‚°ãŒå…¥ã‚Šã«ãããªã‚Šã¾ã™ã€‚

### å®Ÿè£…: ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–

ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ãŸã‚‰ã€æ¬¡ã«å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã©ã†ãªã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ

```bash
$ npm test
```

```
Error: No such namespace: puyo.core
```

ãŠã£ã¨ï¼ã¾ã `puyo.core`åå‰ç©ºé–“ã‚’å®Ÿè£…ã—ã¦ã„ãªã„ã®ã§ã€å½“ç„¶ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã­ã€‚ã“ã‚ŒãŒãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®ã€ŒRedï¼ˆèµ¤ï¼‰ã€ã®çŠ¶æ…‹ã§ã™ã€‚ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚

> ã‚¢ã‚µãƒ¼ãƒˆãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ
>
> ã§ã¯ãƒ†ã‚¹ãƒˆã¯ã©ã“ã‹ã‚‰æ›¸ãå§‹ã‚ã‚‹ã¹ãã ã‚ã†ã‹ã€‚ãã‚Œã¯ãƒ†ã‚¹ãƒˆã®çµ‚ã‚ã‚Šã«ãƒ‘ã‚¹ã™ã¹ãã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ›¸ãã¨ã“ã‚ã‹ã‚‰ã ã€‚
>
> â€” Kent Beck ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã€

ã§ã¯ã€ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã‚ˆã†ã«æœ€å°é™ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚ã€Œæœ€å°é™ã€ã¨ã„ã†ã®ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚ã“ã®æ®µéšã§ã¯ã€ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã ã‘ã‚’ç›®æŒ‡ã—ã¦ã€å¿…è¦æœ€ä½é™ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã¾ã™ã€‚

```clojure
;; src/puyo/core.cljs
(ns puyo.core)

(defn initialize
  "ã‚²ãƒ¼ãƒ ã‚’åˆæœŸåŒ–ã™ã‚‹"
  []
  {:mode :start
   :frame 0
   :combination-count 0
   :config {}
   :stage {}
   :player {}
   :score {}})
```

### è§£èª¬: ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–

ãƒ†ã‚¹ãƒˆãŒé€šã‚Šã¾ã—ãŸã­ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ã€‚ã“ã‚ŒãŒãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®ã€ŒGreenï¼ˆç·‘ï¼‰ã€ã®çŠ¶æ…‹ã§ã™ã€‚

å®Ÿè£…ã—ãŸã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–å‡¦ç†ã«ã¤ã„ã¦ã€å°‘ã—è§£èª¬ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚ClojureScriptã§ã¯ã€ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’**ä¸å¤‰ã®ãƒãƒƒãƒ—ï¼ˆMapï¼‰**ã§è¡¨ç¾ã—ã¾ã™ã€‚ã“ã®å‡¦ç†ã§ã¯ã€ä¸»ã«ä»¥ä¸‹ã®ã“ã¨ã‚’è¡Œã£ã¦ã„ã¾ã™ï¼š

1. ã‚²ãƒ¼ãƒ ã®åŸºæœ¬çŠ¶æ…‹ï¼ˆmode, frame, combination-countï¼‰ã®è¨­å®š
2. å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆconfig, stage, player, scoreï¼‰ã®åˆæœŸåŒ–

å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å½¹å‰²ã‚’ç†è§£ã—ã¦ãŠãã¨ã€ä»Šå¾Œã®å®Ÿè£…ãŒã‚¹ãƒ ãƒ¼ã‚ºã«ãªã‚Šã¾ã™ã‚ˆï¼š

- **config**: ã‚²ãƒ¼ãƒ ã®è¨­å®šå€¤ã‚’ç®¡ç†ã—ã¾ã™ï¼ˆç”»é¢ã‚µã‚¤ã‚ºã€ã·ã‚ˆã®å¤§ãã•ãªã©ï¼‰
- **stage**: ã‚²ãƒ¼ãƒ ã®ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆç›¤é¢ï¼‰ã‚’ç®¡ç†ã—ã¾ã™ï¼ˆã·ã‚ˆã®é…ç½®çŠ¶æ…‹ã€æ¶ˆå»åˆ¤å®šãªã©ï¼‰
- **player**: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å…¥åŠ›ã¨æ“ä½œã‚’ç®¡ç†ã—ã¾ã™ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›ã®å‡¦ç†ã€ã·ã‚ˆã®ç§»å‹•ãªã©ï¼‰
- **score**: ã‚¹ã‚³ã‚¢ã®è¨ˆç®—ã¨è¡¨ç¤ºã‚’ç®¡ç†ã—ã¾ã™ï¼ˆé€£é–æ•°ã«å¿œã˜ãŸã‚¹ã‚³ã‚¢è¨ˆç®—ãªã©ï¼‰

ClojureScriptã®é–¢æ•°å‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã¯ã€çŠ¶æ…‹ã‚’ç›´æ¥å¤‰æ›´ã™ã‚‹ã®ã§ã¯ãªãã€**æ–°ã—ã„çŠ¶æ…‹ã‚’è¿”ã™**ã“ã¨ã§çŠ¶æ…‹é·ç§»ã‚’è¡¨ç¾ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å‰¯ä½œç”¨ãŒå°‘ãªãã€ãƒ†ã‚¹ãƒˆã—ã‚„ã™ã„ã‚³ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚

> Simple Made Easy
>
> ã‚·ãƒ³ãƒ—ãƒ«ã•ã¨ã¯ã€ç‰©äº‹ã‚’å˜ç´”ã«ã™ã‚‹ã“ã¨ã§ã¯ãªãã€çµ¡ã¿åˆã„ã‚’è§£ãã“ã¨ã§ã‚ã‚‹ã€‚
>
> â€” Rich Hickeyï¼ˆClojureã®ä½œè€…ï¼‰

### ãƒ†ã‚¹ãƒˆ: ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã®é–‹å§‹

æ¬¡ã«ã€ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã¾ã™ã€‚

```clojure
;; test/puyo/core_test.cljsï¼ˆç¶šãï¼‰
(deftest ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ãƒ†ã‚¹ãƒˆ
  (testing "ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹ã™ã‚‹ã¨ã€requestAnimationFrameãŒå‘¼ã°ã‚Œã‚‹"
    (let [called (atom false)
          original-raf js/requestAnimationFrame]
      ;; requestAnimationFrameã‚’ãƒ¢ãƒƒã‚¯
      (set! js/requestAnimationFrame
            (fn [callback]
              (reset! called true)
              callback))

      (try
        (game/start-loop (game/initialize))
        (is @called "requestAnimationFrameãŒå‘¼ã°ã‚ŒãŸ")
        (finally
          ;; å…ƒã«æˆ»ã™
          (set! js/requestAnimationFrame original-raf))))))
```

ã“ã®ãƒ†ã‚¹ãƒˆã§ã¯ã€`game/start-loop`é–¢æ•°ãŒ`requestAnimationFrame`ã‚’å‘¼ã³å‡ºã™ã“ã¨ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚ClojureScriptã§ã¯`atom`ã‚’ä½¿ã£ã¦å¤‰æ›´å¯èƒ½ãªå‚ç…§ã‚’ç®¡ç†ã—ã¾ã™ã€‚

### å®Ÿè£…: ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã®é–‹å§‹

ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸã‚‰ã€ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã‚ˆã†ã«æœ€å°é™ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```clojure
;; src/puyo/core.cljsï¼ˆç¶šãï¼‰
(defn game-loop
  "ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã®å‡¦ç†"
  [game-state]
  ;; æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§ã‚‚è‡ªåˆ†è‡ªèº«ã‚’å‘¼ã³å‡ºã™
  (js/requestAnimationFrame #(game-loop game-state))
  game-state)

(defn start-loop
  "ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹ã™ã‚‹"
  [game-state]
  (game-loop game-state))
```

### è§£èª¬: ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã®é–‹å§‹

ã•ã¦ã€ä»Šå›å®Ÿè£…ã—ãŸã€Œã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã€ã«ã¤ã„ã¦å°‘ã—è©³ã—ãè§£èª¬ã—ã¾ã—ã‚‡ã†ã€‚ã€Œã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã£ã¦ä½•ï¼Ÿã€ã¨æ€ã‚ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã­ã€‚

ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã¯ã€ãã®åã®é€šã‚Šã€ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’æ›´æ–°ã—ã€ç”»é¢ã‚’æç”»ã™ã‚‹ãŸã‚ã®ç¹°ã‚Šè¿”ã—å‡¦ç†ãªã‚“ã§ã™ã€‚å¿ƒè‡“ãŒãšã£ã¨é¼“å‹•ã‚’ç¶šã‘ã‚‹ã‚ˆã†ã«ã€ã“ã®ãƒ«ãƒ¼ãƒ—ãŒç¶™ç¶šçš„ã«å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã§ã€ã‚²ãƒ¼ãƒ ãŒç”Ÿãç”Ÿãã¨å‹•ãç¶šã‘ã‚‹ã‚“ã§ã™ã‚ˆã€‚

ã“ã“ã§ä½¿ã£ã¦ã„ã‚‹`requestAnimationFrame`ã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ã€ã“ã‚ŒãŒã¨ã¦ã‚‚è³¢ã„ã‚“ã§ã™ï¼ã€Œã©ã†è³¢ã„ã®ï¼Ÿã€ã¨ã„ã†ã¨ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®æç”»ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«åˆã‚ã›ã¦å‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ãã‚Œã‚‹ã‚“ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ã€ã‚¹ãƒ ãƒ¼ã‚ºãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¯èƒ½ã«ãªã‚‹ã‚“ã§ã™ã‚ˆã€‚

ClojureScriptã®é–¢æ•°å‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã¯ã€ãƒ«ãƒ¼ãƒ—å†…ã§çŠ¶æ…‹ã‚’ç›´æ¥å¤‰æ›´ã™ã‚‹ã®ã§ã¯ãªãã€**æ–°ã—ã„çŠ¶æ…‹ã‚’ç”Ÿæˆã—ã¦æ¸¡ã—ã¦ã„ã**ã“ã¨ã§çŠ¶æ…‹é·ç§»ã‚’å®Ÿç¾ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å‰¯ä½œç”¨ãŒå°‘ãªãã€ãƒ‡ãƒãƒƒã‚°ã—ã‚„ã™ã„ã‚³ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚

### å®Ÿè£…: ç”»é¢ã¨ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ

æœ€å¾Œã«ã€ã‚²ãƒ¼ãƒ ã‚’èµ·å‹•ã™ã‚‹ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã¨HTMLã‚’å®Ÿè£…ã—ã¾ã™ã€‚

#### core.cljs ã®å®Œæˆ

```clojure
;; src/puyo/core.cljs
(ns puyo.core)

(defn initialize
  "ã‚²ãƒ¼ãƒ ã‚’åˆæœŸåŒ–ã™ã‚‹"
  []
  {:mode :start
   :frame 0
   :combination-count 0
   :config {}
   :stage {}
   :player {}
   :score {}})

(defn game-loop
  "ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã®å‡¦ç†"
  [game-state]
  ;; æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§ã‚‚è‡ªåˆ†è‡ªèº«ã‚’å‘¼ã³å‡ºã™
  (js/requestAnimationFrame #(game-loop game-state))
  game-state)

(defn start-loop
  "ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹ã™ã‚‹"
  [game-state]
  (game-loop game-state))

(defn init
  "ã‚²ãƒ¼ãƒ ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ"
  []
  (.log js/console "Puyo Puyo Game Started!")
  (-> (initialize)
      (start-loop)))
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€ä»¥ä¸‹ã®æµã‚Œã§ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™ï¼š

1. `initialize`é–¢æ•°ã§ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’åˆæœŸåŒ–
2. `start-loop`é–¢æ•°ã§ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹
3. ã‚¹ãƒ¬ãƒƒãƒ‡ã‚£ãƒ³ã‚°ãƒã‚¯ãƒ­`->`ã§å‡¦ç†ã‚’ç¹‹ã’ã‚‹

ClojureScriptã®**ã‚¹ãƒ¬ãƒƒãƒ‡ã‚£ãƒ³ã‚°ãƒã‚¯ãƒ­ï¼ˆThreading Macroï¼‰**`->`ã‚’ä½¿ã†ã¨ã€å‡¦ç†ã®æµã‚ŒãŒèª­ã¿ã‚„ã™ããªã‚Šã¾ã™ã€‚ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã¨åŒã˜æ„å‘³ã§ã™ï¼š

```clojure
(start-loop (initialize))
```

#### public/index.html ã®æ›´æ–°

```html
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ  - ClojureScriptç‰ˆ</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }
        #app {
            text-align: center;
        }
        #stage {
            border: 2px solid #333;
            background-color: #fff;
        }
        .info {
            margin: 10px 0;
            font-size: 18px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ </h1>
        <div id="score" class="info">Score: 0</div>
        <canvas id="stage" width="320" height="480"></canvas>
        <div id="next" class="info">Next:</div>
        <div id="next2" class="info">Next2:</div>
    </div>
    <script src="/js/main.js"></script>
</body>
</html>
```

#### shadow-cljs.edn ã®æ›´æ–°

```clojure
{:deps    {:aliases [:dev]}
 :builds  {:app {:target           :browser
                 :output-dir       "public/js"
                 :asset-path       "/js"
                 :modules          {:main {:init-fn puyo.core/init
                                          :preloads []}}
                 :devtools         {:after-load puyo.core/init
                                   :http-root "public"
                                   :http-port 8080}}

           :test {:target          :node-test
                  :output-to       "public/js/test.js"
                  :ns-regexp       "-test$"
                  :autorun         true}

           :coverage {:target     :node-test
                     :output-to  "public/js/coverage.js"
                     :ns-regexp  "-test$"
                     :compiler-options {:coverage true}}}}
```

### ãƒ†ã‚¹ãƒˆã®ç¢ºèª

ã™ã¹ã¦ã®å®Ÿè£…ãŒå®Œäº†ã—ãŸã‚‰ã€ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ç¢ºèªã—ã¾ã—ã‚‡ã†ï¼š

```bash
$ npm test
```

ä»¥ä¸‹ã®çµæœãŒè¡¨ç¤ºã•ã‚Œã‚Œã°æˆåŠŸã§ã™ï¼š

```
Testing puyo.core-test

Ran 2 tests containing 9 assertions.
0 failures, 0 errors.
```

å“è³ªãƒã‚§ãƒƒã‚¯ã‚‚å®Ÿè¡Œã—ã¾ã—ã‚‡ã†ï¼š

```bash
$ npx gulp check
```

### ç”»é¢ã®ç¢ºèª

ã§ã¯ã€å®Ÿéš›ã«å‹•ä½œã™ã‚‹ç”»é¢ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

```bash
$ npm run dev
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://localhost:8080` ã‚’é–‹ãã¨ã€ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ ã®ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã¯ã€ŒPuyo Puyo Game Started!ã€ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ã€‚

ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ãƒªãƒªãƒ¼ã‚¹ã«å‘ã‘ã¦æœ€åˆã®ç¬¬ä¸€æ­©ã‚’è¸ã¿å‡ºã™ã“ã¨ãŒã§ãã¾ã—ãŸã€‚ã“ã‚Œã‹ã‚‰æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹ã”ã¨ã«ã©ã‚“ã©ã‚“å®Ÿéš›ã®ã‚²ãƒ¼ãƒ ã®å®Œæˆã«è¿‘ã¥ãã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€æ¥½ã—ã¿ã§ã™ã­ã€‚

ã€Œæ©Ÿèƒ½ã¯åˆ¥ã€…ã«ä½œã‚Šã“ã‚“ã§æœ€å¾Œã«ç”»é¢ã¨çµ±åˆã™ã‚‹ã‚“ã˜ã‚ƒãªã„ã®ï¼Ÿã€ã¨æ€ã†ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ãã†ã„ã†ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚‚ã‚ã‚Šã¾ã™ãŒç”»é¢ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒæœ€å¾Œã¾ã§ç¢ºèªã§ããªã„ã¨ã‚‚ã—é–“é•ã£ã¦ã„ãŸã‚‰æ‰‹æˆ»ã‚ŠãŒå¤§å¤‰ã§ã™ã€‚ãã‚Œã«å‹•ä½œã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒã©ã‚“ã©ã‚“æˆé•·ã™ã‚‹ã®ã‚’è¦‹ã‚‹ã®ã¯æ¥½ã—ã„ã§ã™ã‹ã‚‰ã­ã€‚

> ãƒˆãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã§ã‚‚ãƒœãƒˆãƒ ã‚¢ãƒƒãƒ—ã§ã‚‚ãªãã€ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã§æ§‹ç¯‰ã—ã¦ã„ã
>
> ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã§å°ã•ãªæ©Ÿèƒ½ã‚’æ§‹ç¯‰ã—ã€ãã“ã‹ã‚‰ä½œæ¥­ã‚’é€²ã‚ãªãŒã‚‰å•é¡Œã«ã¤ã„ã¦å­¦ç¿’ã—ã¦ã„ãã€‚
>
> â€” é”äººãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ ç†Ÿé”ã«å‘ã‘ãŸã‚ãªãŸã®æ—…ï¼ˆç¬¬2ç‰ˆï¼‰

### ClojureScriptã®é–¢æ•°å‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®åˆ©ç‚¹

ä»Šå›ã®å®Ÿè£…ã‚’é€šã˜ã¦ã€ClojureScriptã®é–¢æ•°å‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®åˆ©ç‚¹ã‚’å®Ÿæ„Ÿã§ããŸã§ã—ã‚‡ã†ã‹ï¼š

1. **ä¸å¤‰ãƒ‡ãƒ¼ã‚¿æ§‹é€ **: çŠ¶æ…‹ãŒæ„å›³ã›ãšå¤‰æ›´ã•ã‚Œã‚‹ã“ã¨ãŒãªã„
2. **ç´”ç²‹é–¢æ•°**: åŒã˜å…¥åŠ›ã«ã¯å¸¸ã«åŒã˜å‡ºåŠ›ã‚’è¿”ã™
3. **ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ã‚¹ãƒˆ**: å‰¯ä½œç”¨ãŒå°‘ãªã„ãŸã‚ã€ãƒ†ã‚¹ãƒˆãŒæ›¸ãã‚„ã™ã„
4. **ã‚¹ãƒ¬ãƒƒãƒ‡ã‚£ãƒ³ã‚°ãƒã‚¯ãƒ­**: å‡¦ç†ã®æµã‚ŒãŒèª­ã¿ã‚„ã™ã„

ã“ã‚Œã‚‰ã®ç‰¹å¾´ã«ã‚ˆã‚Šã€ãƒã‚°ãŒå…¥ã‚Šã«ããã€ä¿å®ˆã—ã‚„ã™ã„ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

### ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³1ã®ã¾ã¨ã‚

ã“ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å®Ÿè£…ã—ãŸå†…å®¹ï¼š

1. **ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®åˆæœŸåŒ–**
   - ä¸å¤‰ãƒãƒƒãƒ—ã«ã‚ˆã‚‹çŠ¶æ…‹ç®¡ç†
   - å¿…è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆconfig, stage, player, scoreï¼‰ã®åˆæœŸåŒ–
   - ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã®è¨­å®š

2. **ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã®å®Ÿè£…**
   - `requestAnimationFrame`ã‚’ä½¿ç”¨ã—ãŸç¶™ç¶šçš„ãªãƒ«ãƒ¼ãƒ—å‡¦ç†
   - é–¢æ•°å‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«ã‚ˆã‚‹çŠ¶æ…‹é·ç§»

3. **ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã®å®Ÿè£…**
   - `init`é–¢æ•°ã§ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–ã¨ãƒ«ãƒ¼ãƒ—é–‹å§‹
   - ã‚¹ãƒ¬ãƒƒãƒ‡ã‚£ãƒ³ã‚°ãƒã‚¯ãƒ­ã«ã‚ˆã‚‹å‡¦ç†ã®é€£é–
   - ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®å‹•ä½œç¢ºèªãŒå¯èƒ½ã«

4. **ãƒ†ã‚¹ãƒˆã®ä½œæˆ**
   - ã‚²ãƒ¼ãƒ åˆæœŸåŒ–ã®ãƒ†ã‚¹ãƒˆï¼ˆ1ãƒ†ã‚¹ãƒˆã€6ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
   - ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã®ãƒ†ã‚¹ãƒˆï¼ˆ1ãƒ†ã‚¹ãƒˆã€1ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
   - ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸ

### clojure.spec: åŸºæœ¬ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å®šç¾©

ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³1ã§ã¯ã€ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®åŸºæœ¬çš„ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’å®šç¾©ã—ã¾ã—ãŸã€‚ã“ã“ã§ clojure.spec ã‚’ä½¿ã£ã¦ã€ã“ã‚Œã‚‰ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®ä»•æ§˜ã‚’å®šç¾©ã—ã¾ã—ã‚‡ã†ã€‚

#### specs åå‰ç©ºé–“ã®ä½œæˆ

```clojure
;; src/puyo/specs.cljs
(ns puyo.specs
  (:require [cljs.spec.alpha :as s]))

;; ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã®å®šç¾©
(s/def ::mode #{:start :new-puyo :playing :check-erase :apply-gravity :game-over})

;; ãƒ•ãƒ¬ãƒ¼ãƒ æ•°
(s/def ::frame nat-int?)

;; çµ„ã¿åˆã‚ã›ã‚«ã‚¦ãƒ³ãƒˆ
(s/def ::combination-count nat-int?)

;; ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®åŸºæœ¬æ§‹é€ 
(s/def ::game-state-basic
  (s/keys :req-un [::mode ::frame ::combination-count]))
```

ã€Œãªãœã“ã®æ®µéšã§ spec ã‚’å®šç¾©ã™ã‚‹ã‚“ã§ã™ã‹ï¼Ÿã€è‰¯ã„è³ªå•ã§ã™ã­ï¼TDD ã§ã¯ã€ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã§ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã¾ã™ãŒã€spec ã¯ã€Œãƒ‡ãƒ¼ã‚¿ã®å½¢çŠ¶ã«å¯¾ã™ã‚‹ãƒ†ã‚¹ãƒˆã€ã¨è€ƒãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚å„ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’è¿½åŠ ã™ã‚‹ãŸã³ã«ã€ãã®ä»•æ§˜ã‚‚ä¸€ç·’ã«å®šç¾©ã—ã¦ã„ãã“ã¨ã§ã€ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã‚’ä¿è¨¼ã§ãã¾ã™ã€‚

#### ãƒ†ã‚¹ãƒˆã§ã® spec æ¤œè¨¼

```clojure
;; test/puyo/core_test.cljsï¼ˆspecæ¤œè¨¼ã‚’è¿½åŠ ï¼‰
(ns puyo.core-test
  (:require [cljs.test :refer-macros [deftest is testing]]
            [cljs.spec.alpha :as s]
            [puyo.core :as core]
            [puyo.specs :as specs]))

(deftest ã‚²ãƒ¼ãƒ åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ
  (testing "ã‚²ãƒ¼ãƒ ãŒæ­£ã—ãåˆæœŸåŒ–ã•ã‚Œã‚‹"
    (let [game-state (core/initialize)]
      ;; æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆ
      (is (= :start (:mode game-state)))
      (is (= 0 (:frame game-state)))
      (is (= 0 (:combination-count game-state)))

      ;; spec ã«ã‚ˆã‚‹æ¤œè¨¼ã‚’è¿½åŠ 
      (is (s/valid? ::specs/game-state-basic game-state)
          "ã‚²ãƒ¼ãƒ çŠ¶æ…‹ãŒ spec ã‚’æº€ãŸã™")

      ;; spec é•åæ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèªï¼ˆé–‹ç™ºæ™‚ã®ãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
      (when-not (s/valid? ::specs/game-state-basic game-state)
        (println (s/explain-str ::specs/game-state-basic game-state))))))
```

ã€Œãƒ†ã‚¹ãƒˆã« spec ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ä½•ãŒå¤‰ã‚ã‚‹ã‚“ã§ã™ã‹ï¼Ÿã€ãƒ†ã‚¹ãƒˆãŒé€šã£ã¦ã‚‚ã€ãƒ‡ãƒ¼ã‚¿ã®å½¢çŠ¶ãŒæ­£ã—ããªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ã€`:mode` ã«ä¸æ­£ãªå€¤ãŒå…¥ã£ã¦ã„ã¦ã‚‚ã€ãã®ã‚­ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã‹ã©ã†ã‹ã—ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ãªã‘ã‚Œã°è¦‹é€ƒã—ã¦ã—ã¾ã„ã¾ã™ã€‚spec ã‚’ä½¿ã†ã“ã¨ã§ã€ãƒ‡ãƒ¼ã‚¿ã®**å€¤ã®å¦¥å½“æ€§**ã¾ã§æ¤œè¨¼ã§ãã‚‹ã‚“ã§ã™ã€‚

#### REPL ã§ã®é–‹ç™ºæ™‚æ¤œè¨¼

```clojure
;; REPL ã§ã®ä½¿ç”¨ä¾‹
(require '[puyo.core :as core])
(require '[puyo.specs :as specs])
(require '[cljs.spec.alpha :as s])

;; ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’åˆæœŸåŒ–ã—ã¦æ¤œè¨¼
(def game (core/initialize))
(s/valid? ::specs/game-state-basic game)
;; => true

;; ä¸æ­£ãªã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’æ¤œè¨¼
(s/valid? ::specs/game-state-basic {:mode :invalid :frame 0})
;; => false

;; ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’è¡¨ç¤º
(s/explain ::specs/game-state-basic {:mode :invalid :frame 0})
;; => val: :invalid fails spec: :puyo.specs/mode at: [:mode] predicate: #{:start :new-puyo :playing ...}
```

ã€ŒREPL ã§å³åº§ã«æ¤œè¨¼ã§ãã‚‹ã®ã¯ä¾¿åˆ©ã§ã™ã­ï¼ã€ãã†ã§ã™ï¼ClojureScript ã® REPL é§†å‹•é–‹ç™ºã¨ spec ã®ç›¸æ€§ã¯æŠœç¾¤ã§ã™ã€‚ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ããªãŒã‚‰ã€ãƒ‡ãƒ¼ã‚¿ã®å½¢çŠ¶ãŒæ­£ã—ã„ã‹ã‚’å³åº§ã«ç¢ºèªã§ãã¾ã™ã€‚

æ¬¡ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ã·ã‚ˆã®ç§»å‹•æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

## ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³2: ã·ã‚ˆã®åŸºæœ¬å‹•ä½œ

ã•ã¦ã€å‰å›ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚²ãƒ¼ãƒ ã®åŸºæœ¬çš„ãªæ§‹é€ ãŒã§ãã¾ã—ãŸã­ã€‚ã€Œã‚²ãƒ¼ãƒ ãŒå§‹ã¾ã£ãŸã‘ã©ã€ã·ã‚ˆãŒå‹•ã‹ãªã„ã¨é¢ç™½ããªã„ã‚ˆã­ï¼Ÿã€ã¨æ€ã„ã¾ã›ã‚“ã‹ï¼Ÿãã“ã§æ¬¡ã¯ã€ã·ã‚ˆã‚’å·¦å³ã«ç§»å‹•ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ãã¾ã—ã‚‡ã†ï¼

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼

ã¾ãšã¯ã€ã“ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å®Ÿè£…ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ï¼š

> ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ã€è½ã¡ã¦ãã‚‹ã·ã‚ˆã‚’å·¦å³ã«ç§»å‹•ã§ãã‚‹

ã€Œã·ã‚ˆã·ã‚ˆã£ã¦ã€è½ã¡ã¦ãã‚‹ã·ã‚ˆã‚’å·¦å³ã«å‹•ã‹ã—ã¦ã€ã†ã¾ãç©ã¿ä¸Šã’ã‚‹ã‚²ãƒ¼ãƒ ã§ã™ã‚ˆã­ï¼Ÿã€ãã†ã§ã™ï¼ä»Šå›ã¯ãã®åŸºæœ¬æ“ä½œã§ã‚ã‚‹ã€Œå·¦å³ã®ç§»å‹•ã€ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

### TODOãƒªã‚¹ãƒˆ

ã•ã¦ã€ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã€ã©ã‚“ãªã‚¿ã‚¹ã‚¯ãŒå¿…è¦ã§ã—ã‚‡ã†ã‹ï¼Ÿä¸€ç·’ã«è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚
ã€Œã·ã‚ˆã‚’å·¦å³ã«ç§»å‹•ã™ã‚‹ã€ã¨ã„ã†æ©Ÿèƒ½ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¿ã‚¹ã‚¯ãŒå¿…è¦ãã†ã§ã™ã­ï¼š

- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å…¥åŠ›ã‚’æ¤œå‡ºã™ã‚‹ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®å·¦å³ã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸã“ã¨ã‚’æ¤œçŸ¥ã™ã‚‹ï¼‰
- ã·ã‚ˆã‚’å·¦å³ã«ç§»å‹•ã™ã‚‹å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹ï¼ˆå®Ÿéš›ã«ã·ã‚ˆã®ä½ç½®ã‚’å¤‰æ›´ã™ã‚‹ï¼‰
- ç§»å‹•å¯èƒ½ã‹ã©ã†ã‹ã®ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚‹ï¼ˆç”»é¢ã®ç«¯ã‚„ä»–ã®ã·ã‚ˆã«ã¶ã¤ã‹ã‚‹å ´åˆã¯ç§»å‹•ã§ããªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰
- ç§»å‹•å¾Œã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹ï¼ˆç”»é¢ä¸Šã§ã·ã‚ˆã®ä½ç½®ãŒå¤‰ã‚ã£ãŸã“ã¨ã‚’è¡¨ç¤ºã™ã‚‹ï¼‰

ã€Œãªã‚‹ã»ã©ã€é †ç•ªã«å®Ÿè£…ã—ã¦ã„ã‘ã°ã„ã„ã‚“ã§ã™ã­ï¼ã€ãã†ã§ã™ã€ä¸€ã¤ãšã¤é€²ã‚ã¦ã„ãã¾ã—ã‚‡ã†ã€‚ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®æµã‚Œã«æ²¿ã£ã¦ã€ã¾ãšã¯ãƒ†ã‚¹ãƒˆã‹ã‚‰æ›¸ã„ã¦ã„ãã¾ã™ã‚ˆã€‚

### ãƒ†ã‚¹ãƒˆ: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å…¥åŠ›æ¤œå‡º

ã€Œæœ€åˆã«ä½•ã‚’ãƒ†ã‚¹ãƒˆã™ã‚Œã°ã„ã„ã‚“ã§ã—ã‚‡ã†ã‹ï¼Ÿã€ã¾ãšã¯ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å…¥åŠ›ã‚’æ¤œå‡ºã™ã‚‹éƒ¨åˆ†ã‹ã‚‰ãƒ†ã‚¹ãƒˆã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®å·¦å³ã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸã¨ãã«ã€ãã‚Œã‚’æ­£ã—ãæ¤œçŸ¥ã§ãã‚‹ã‹ã©ã†ã‹ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

> ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ
>
> ã„ã¤ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã¹ãã ã‚ã†ã‹â€”â€”ãã‚Œã¯ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãå‰ã ã€‚
>
> â€” Kent Beck ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã€

ClojureScriptã§ã¯ã€ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã‚’atomï¼ˆå¤‰æ›´å¯èƒ½ãªå‚ç…§ï¼‰ã‚’ä½¿ã£ã¦ç®¡ç†ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å‰¯ä½œç”¨ã‚’æœ€å°é™ã«æŠ‘ãˆãªãŒã‚‰çŠ¶æ…‹ã‚’ç®¡ç†ã§ãã¾ã™ã€‚

```clojure
;; test/puyo/player_test.cljs
(ns puyo.player-test
  (:require [cljs.test :refer-macros [deftest is testing]]
            [puyo.player :as player]))

(deftest ã‚­ãƒ¼å…¥åŠ›æ¤œå‡ºãƒ†ã‚¹ãƒˆ
  (testing "å·¦ã‚­ãƒ¼ãŒæŠ¼ã•ã‚Œã‚‹ã¨ã€å·¦å‘ãã®ç§»å‹•ãƒ•ãƒ©ã‚°ãŒç«‹ã¤"
    (let [input-state (player/create-input-state)]
      ;; å·¦ã‚­ãƒ¼æŠ¼ä¸‹ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
      (player/handle-key-down input-state "ArrowLeft")

      (is (true? @(:left input-state)) "å·¦ãƒ•ãƒ©ã‚°ãŒtrueã«ãªã‚‹")))

  (testing "å³ã‚­ãƒ¼ãŒæŠ¼ã•ã‚Œã‚‹ã¨ã€å³å‘ãã®ç§»å‹•ãƒ•ãƒ©ã‚°ãŒç«‹ã¤"
    (let [input-state (player/create-input-state)]
      ;; å³ã‚­ãƒ¼æŠ¼ä¸‹ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
      (player/handle-key-down input-state "ArrowRight")

      (is (true? @(:right input-state)) "å³ãƒ•ãƒ©ã‚°ãŒtrueã«ãªã‚‹")))

  (testing "ã‚­ãƒ¼ãŒé›¢ã•ã‚Œã‚‹ã¨ã€å¯¾å¿œã™ã‚‹ç§»å‹•ãƒ•ãƒ©ã‚°ãŒä¸‹ãŒã‚‹"
    (let [input-state (player/create-input-state)]
      ;; ã¾ãšå·¦ã‚­ãƒ¼ã‚’æŠ¼ã™
      (player/handle-key-down input-state "ArrowLeft")
      (is (true? @(:left input-state)) "å·¦ãƒ•ãƒ©ã‚°ãŒtrueã«ãªã‚‹")

      ;; æ¬¡ã«å·¦ã‚­ãƒ¼ã‚’é›¢ã™
      (player/handle-key-up input-state "ArrowLeft")
      (is (false? @(:left input-state)) "å·¦ãƒ•ãƒ©ã‚°ãŒfalseã«ãªã‚‹"))))
```

ã€Œã“ã®ãƒ†ã‚¹ãƒˆã¯ä½•ã‚’ã—ã¦ã„ã‚‹ã‚“ã§ã™ã‹ï¼Ÿã€ã“ã®ãƒ†ã‚¹ãƒˆã§ã¯ã€ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®å·¦å³ã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸã¨ãã¨é›¢ã•ã‚ŒãŸã¨ãã«ã€å…¥åŠ›çŠ¶æ…‹ãŒæ­£ã—ãæ›´æ–°ã•ã‚Œã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚ClojureScriptã§ã¯ã€**atom**ã‚’ä½¿ã£ã¦å¤‰æ›´å¯èƒ½ãªçŠ¶æ…‹ã‚’ç®¡ç†ã—ã¾ã™ã€‚

### å®Ÿè£…: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å…¥åŠ›æ¤œå‡º

ã€Œå¤±æ•—ã™ã‚‹ãƒ†ã‚¹ãƒˆãŒã§ããŸã®ã§ã€æ¬¡ã¯å®Ÿè£…ã§ã™ã­ï¼ã€ãã†ã§ã™ï¼ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã‚ˆã†ã«ã€æœ€å°é™ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

> ä»®å®Ÿè£…ã‚’çµŒã¦æœ¬å®Ÿè£…ã¸
>
> å¤±æ•—ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã‹ã‚‰ã€æœ€åˆã«è¡Œã†å®Ÿè£…ã¯ã©ã®ã‚ˆã†ãªã‚‚ã®ã ã‚ã†ã‹ - ãƒ™ã‚¿æ›¸ãã®å€¤ã‚’è¿”ãã†ã€‚
> ãã‚Œã§ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã‚ˆã†ã«ãªã£ãŸã‚‰ã€ãƒ™ã‚¿æ›¸ãã®å€¤ã‚’ã ã‚“ã ã‚“æœ¬ç‰©ã®å¼ã‚„å¤‰æ•°ã«ç½®ãæ›ãˆã¦ã„ãã€‚
>
> â€” Kent Beck ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã€

```clojure
;; src/puyo/player.cljs
(ns puyo.player)

(defn create-input-state
  "å…¥åŠ›çŠ¶æ…‹ã‚’ä½œæˆã™ã‚‹"
  []
  {:left (atom false)
   :right (atom false)
   :up (atom false)
   :down (atom false)})

(defn handle-key-down
  "ã‚­ãƒ¼æŠ¼ä¸‹æ™‚ã®å‡¦ç†"
  [input-state key-code]
  (case key-code
    "ArrowLeft" (reset! (:left input-state) true)
    "ArrowRight" (reset! (:right input-state) true)
    "ArrowUp" (reset! (:up input-state) true)
    "ArrowDown" (reset! (:down input-state) true)
    nil))

(defn handle-key-up
  "ã‚­ãƒ¼è§£æ”¾æ™‚ã®å‡¦ç†"
  [input-state key-code]
  (case key-code
    "ArrowLeft" (reset! (:left input-state) false)
    "ArrowRight" (reset! (:right input-state) false)
    "ArrowUp" (reset! (:up input-state) false)
    "ArrowDown" (reset! (:down input-state) false)
    nil))

(defn setup-keyboard-events
  "ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹"
  [input-state]
  (.addEventListener js/document "keydown"
                     (fn [e] (handle-key-down input-state (.-key e))))
  (.addEventListener js/document "keyup"
                     (fn [e] (handle-key-up input-state (.-key e)))))
```

ã€Œãªã‚‹ã»ã©ï¼atomã‚’ä½¿ã£ã¦å…¥åŠ›çŠ¶æ…‹ã‚’ç®¡ç†ã—ã¦ã„ã‚‹ã‚“ã§ã™ã­ã€‚ã€ãã†ã§ã™ï¼ClojureScriptã§ã¯ã€`atom`ã‚’ä½¿ã£ã¦å¤‰æ›´å¯èƒ½ãªå‚ç…§ã‚’ç®¡ç†ã—ã¾ã™ã€‚`reset!`ã‚’ä½¿ã£ã¦atomã®å€¤ã‚’æ›´æ–°ã§ãã¾ã™ã€‚

ã€ŒJavaScriptã®ã‚¤ãƒ™ãƒ³ãƒˆã¨ã©ã†é€£æºã™ã‚‹ã‚“ã§ã™ã‹ï¼Ÿã€`setup-keyboard-events`é–¢æ•°ã§ã€JavaScriptã®`addEventListener`ã‚’ä½¿ã£ã¦ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªãƒƒã‚¹ãƒ³ã—ã¦ã„ã¾ã™ã€‚ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã™ã‚‹ã¨ã€ClojureScriptã®é–¢æ•°ãŒå‘¼ã°ã‚Œã¾ã™ã€‚

### ãƒ†ã‚¹ãƒˆ: ã·ã‚ˆã®ç§»å‹•

ã€Œæ¬¡ã¯ä½•ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã‹ï¼Ÿã€æ¬¡ã¯ã€ã·ã‚ˆã‚’å·¦å³ã«ç§»å‹•ã™ã‚‹æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã—ã‚‡ã†ã€‚ã·ã‚ˆãŒå·¦å³ã«ç§»å‹•ã§ãã‚‹ã‹ã€ãã—ã¦ç”»é¢ã®ç«¯ã«åˆ°é”ã—ãŸã¨ãã«ç§»å‹•ãŒåˆ¶é™ã•ã‚Œã‚‹ã‹ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

```clojure
;; test/puyo/player_test.cljsï¼ˆç¶šãï¼‰
(deftest ã·ã‚ˆç§»å‹•ãƒ†ã‚¹ãƒˆ
  (testing "å·¦ã«ç§»å‹•ã§ãã‚‹å ´åˆã€å·¦ã«ç§»å‹•ã™ã‚‹"
    (let [puyo-state {:x 2 :y 0 :type 1 :rotation 0}
          config {:stage-cols 6}]
      (let [new-state (player/move-left puyo-state config)]
        (is (= 1 (:x new-state)) "Xåº§æ¨™ãŒ1æ¸›å°‘ã™ã‚‹"))))

  (testing "å³ã«ç§»å‹•ã§ãã‚‹å ´åˆã€å³ã«ç§»å‹•ã™ã‚‹"
    (let [puyo-state {:x 2 :y 0 :type 1 :rotation 0}
          config {:stage-cols 6}]
      (let [new-state (player/move-right puyo-state config)]
        (is (= 3 (:x new-state)) "Xåº§æ¨™ãŒ1å¢—åŠ ã™ã‚‹"))))

  (testing "å·¦ç«¯ã«ã„ã‚‹å ´åˆã€å·¦ã«ç§»å‹•ã§ããªã„"
    (let [puyo-state {:x 0 :y 0 :type 1 :rotation 0}
          config {:stage-cols 6}]
      (let [new-state (player/move-left puyo-state config)]
        (is (= 0 (:x new-state)) "Xåº§æ¨™ãŒå¤‰ã‚ã‚‰ãªã„"))))

  (testing "å³ç«¯ã«ã„ã‚‹å ´åˆã€å³ã«ç§»å‹•ã§ããªã„"
    (let [puyo-state {:x 5 :y 0 :type 1 :rotation 0}
          config {:stage-cols 6}]
      (let [new-state (player/move-right puyo-state config)]
        (is (= 5 (:x new-state)) "Xåº§æ¨™ãŒå¤‰ã‚ã‚‰ãªã„")))))
```

ã€Œã“ã®ãƒ†ã‚¹ãƒˆã§ã¯ä½•ã‚’ç¢ºèªã—ã¦ã„ã‚‹ã‚“ã§ã™ã‹ï¼Ÿã€ã“ã®ãƒ†ã‚¹ãƒˆã§ã¯ã€ä»¥ä¸‹ã®4ã¤ã®ã‚±ãƒ¼ã‚¹ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ï¼š

1. é€šå¸¸ã®çŠ¶æ…‹ã§å·¦ã«ç§»å‹•ã§ãã‚‹ã‹
2. é€šå¸¸ã®çŠ¶æ…‹ã§å³ã«ç§»å‹•ã§ãã‚‹ã‹
3. å·¦ç«¯ã«ã„ã‚‹ã¨ãã«å·¦ã«ç§»å‹•ã—ã‚ˆã†ã¨ã—ã¦ã‚‚ä½ç½®ãŒå¤‰ã‚ã‚‰ãªã„ã‹
4. å³ç«¯ã«ã„ã‚‹ã¨ãã«å³ã«ç§»å‹•ã—ã‚ˆã†ã¨ã—ã¦ã‚‚ä½ç½®ãŒå¤‰ã‚ã‚‰ãªã„ã‹

ã€Œãªã‚‹ã»ã©ã€ç”»é¢ã®ç«¯ã‚’è¶…ãˆã¦ç§»å‹•ã§ããªã„ã‚ˆã†ã«ã™ã‚‹ã‚“ã§ã™ã­ï¼ã€ãã†ã§ã™ï¼ã‚²ãƒ¼ãƒ ã®ç”»é¢å¤–ã«ã·ã‚ˆãŒå‡ºã¦ã—ã¾ã†ã¨å›°ã‚Šã¾ã™ã‹ã‚‰ã­ã€‚ã§ã¯ã€ã“ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

### å®Ÿè£…: ã·ã‚ˆã®ç§»å‹•

ã€Œãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸã‚‰ã€å®Ÿè£…ã«é€²ã¿ã¾ã—ã‚‡ã†ï¼ã€ãã†ã§ã™ã­ã€‚ã§ã¯ã€ã·ã‚ˆã‚’ç§»å‹•ã•ã›ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

```clojure
;; src/puyo/player.cljsï¼ˆç¶šãï¼‰
(defn create-puyo
  "æ–°ã—ã„ã·ã‚ˆã‚’ä½œæˆã™ã‚‹"
  []
  {:x 2
   :y 0
   :type (inc (rand-int 4)) ; 1-4ã®ãƒ©ãƒ³ãƒ€ãƒ ãªå€¤
   :rotation 0})

(defn move-left
  "ã·ã‚ˆã‚’å·¦ã«ç§»å‹•ã™ã‚‹"
  [puyo-state config]
  (if (> (:x puyo-state) 0)
    (update puyo-state :x dec)
    puyo-state))

(defn move-right
  "ã·ã‚ˆã‚’å³ã«ç§»å‹•ã™ã‚‹"
  [puyo-state config]
  (if (< (:x puyo-state) (dec (:stage-cols config)))
    (update puyo-state :x inc)
    puyo-state))

(defn update-puyo
  "å…¥åŠ›ã«å¿œã˜ã¦ã·ã‚ˆã‚’æ›´æ–°ã™ã‚‹"
  [puyo-state input-state config]
  (cond
    @(:left input-state)
    (do
      (reset! (:left input-state) false)
      (move-left puyo-state config))

    @(:right input-state)
    (do
      (reset! (:right input-state) false)
      (move-right puyo-state config))

    :else
    puyo-state))
```

ã€ŒClojureScriptã®é–¢æ•°å‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒã‚ˆãã‚ã‹ã‚Šã¾ã™ã­ï¼ã€ãã†ã§ã™ã­ã€‚é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’èª¬æ˜ã—ã¾ã—ã‚‡ã†ï¼š

1. **ä¸å¤‰æ€§**: `move-left`ã‚„`move-right`ã¯å…ƒã®çŠ¶æ…‹ã‚’å¤‰æ›´ã›ãšã€æ–°ã—ã„çŠ¶æ…‹ã‚’è¿”ã—ã¾ã™
2. **updateé–¢æ•°**: `(update puyo-state :x dec)`ã¯ã€`:x`ã®å€¤ã‚’ãƒ‡ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã—ãŸæ–°ã—ã„ãƒãƒƒãƒ—ã‚’è¿”ã—ã¾ã™
3. **æ¡ä»¶åˆ†å²**: `if`ã‚„`cond`ã‚’ä½¿ã£ã¦æ¡ä»¶ã«å¿œã˜ãŸå‡¦ç†ã‚’è¡Œã„ã¾ã™
4. **atomã®æ“ä½œ**: `@`ã§atomã®å€¤ã‚’å–å¾—ã—ã€`reset!`ã§å€¤ã‚’æ›´æ–°ã—ã¾ã™

ã€Œç§»å‹•ã®å‡¦ç†ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã­ï¼ã€ãã†ã§ã™ã­ã€‚`move-left`é–¢æ•°ã§ã¯å·¦ç«¯ï¼ˆXåº§æ¨™ãŒ0ï¼‰ã§ãªã‘ã‚Œã°Xåº§æ¨™ã‚’1æ¸›ã‚‰ã—ã€`move-right`é–¢æ•°ã§ã¯å³ç«¯ï¼ˆXåº§æ¨™ãŒã‚¹ãƒ†ãƒ¼ã‚¸ã®å¹…-1ï¼‰ã§ãªã‘ã‚Œã°Xåº§æ¨™ã‚’1å¢—ã‚„ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã§ã€ã·ã‚ˆãŒç”»é¢ã®ç«¯ã‚’è¶…ãˆã¦ç§»å‹•ã™ã‚‹ã“ã¨ã¯ãªããªã‚Šã¾ã—ãŸã€‚

### å®Ÿè£…: ã·ã‚ˆã®ç”»é¢è¡¨ç¤º

ã€Œãƒ†ã‚¹ãƒˆã¯é€šã£ãŸã‘ã©ã€å®Ÿéš›ã«ã·ã‚ˆãŒå‹•ã„ã¦ã„ã‚‹ã¨ã“ã‚ã‚’è¦‹ãŸã„ã§ã™ã­ï¼ã€ãã†ã§ã™ã­ï¼ãã‚Œã§ã¯ã€ã·ã‚ˆã‚’ç”»é¢ã«è¡¨ç¤ºã—ã¦ã€å®Ÿéš›ã«ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§æ“ä½œã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚

#### configåå‰ç©ºé–“ã®ä½œæˆ

ã¾ãšã€ã‚²ãƒ¼ãƒ ã®è¨­å®šã‚’ç®¡ç†ã™ã‚‹åå‰ç©ºé–“ã‚’ä½œæˆã—ã¾ã™ï¼š

```clojure
;; src/puyo/config.cljs
(ns puyo.config)

(def stage-cols 6)         ; ã‚¹ãƒ†ãƒ¼ã‚¸ã®åˆ—æ•°
(def stage-rows 12)        ; ã‚¹ãƒ†ãƒ¼ã‚¸ã®è¡Œæ•°
(def puyo-size 32)         ; ã·ã‚ˆã®ã‚µã‚¤ã‚ºï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰
(def stage-bg-color "#2a2a2a")     ; ã‚¹ãƒ†ãƒ¼ã‚¸ã®èƒŒæ™¯è‰²
(def stage-border-color "#444")    ; ã‚¹ãƒ†ãƒ¼ã‚¸ã®æ ç·šè‰²

(defn get-config
  "è¨­å®šãƒãƒƒãƒ—ã‚’å–å¾—ã™ã‚‹"
  []
  {:stage-cols stage-cols
   :stage-rows stage-rows
   :puyo-size puyo-size
   :stage-bg-color stage-bg-color
   :stage-border-color stage-border-color})
```

ClojureScriptã§ã¯ã€**def**ã‚’ä½¿ã£ã¦å®šæ•°ã‚’å®šç¾©ã—ã¾ã™ã€‚é–¢æ•°ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ãŒã€ãƒãƒƒãƒ—ã¨ã—ã¦è¨­å®šã‚’ã¾ã¨ã‚ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

#### drawingåå‰ç©ºé–“ã®ä½œæˆ

æ¬¡ã«ã€ã·ã‚ˆã‚’æç”»ã™ã‚‹ãŸã‚ã®åå‰ç©ºé–“ã‚’ä½œæˆã—ã¾ã™ï¼š

```clojure
;; src/puyo/drawing.cljs
(ns puyo.drawing
  (:require [puyo.config :as config]))

(def colors
  "ã·ã‚ˆã®è‰²å®šç¾©"
  {0 "#888"    ; ç©º
   1 "#ff0000" ; èµ¤
   2 "#00ff00" ; ç·‘
   3 "#0000ff" ; é’
   4 "#ffff00"}) ; é»„è‰²

(defn draw-puyo
  "ã·ã‚ˆã‚’æç”»ã™ã‚‹"
  [ctx type x y]
  (let [size config/puyo-size
        color (get colors type (get colors 0))
        center-x (+ (* x size) (/ size 2))
        center-y (+ (* y size) (/ size 2))
        radius (- (/ size 2) 2)]

    ;; å††ã‚’æç”»
    (set! (.-fillStyle ctx) color)
    (.beginPath ctx)
    (.arc ctx center-x center-y radius 0 (* js/Math.PI 2))
    (.fill ctx)

    ;; æ ç·šã‚’æç”»
    (set! (.-strokeStyle ctx) "#000")
    (set! (.-lineWidth ctx) 2)
    (.beginPath ctx)
    (.arc ctx center-x center-y radius 0 (* js/Math.PI 2))
    (.stroke ctx)))
```

ã€ŒClojureScriptã§Canvas APIã‚’ä½¿ã£ã¦ã„ã‚‹ã‚“ã§ã™ã­ï¼ã€ãã†ã§ã™ï¼JavaScriptã®Canvas APIã‚’ãã®ã¾ã¾ä½¿ãˆã¾ã™ã€‚`set!`ã‚’ä½¿ã£ã¦ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¨­å®šã—ã€`.ãƒ¡ã‚½ãƒƒãƒ‰å`ã§ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

#### stageåå‰ç©ºé–“ã®ä½œæˆ

ç¶šã„ã¦ã€ã‚²ãƒ¼ãƒ ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ç®¡ç†ã™ã‚‹åå‰ç©ºé–“ã‚’ä½œæˆã—ã¾ã™ï¼š

```clojure
;; src/puyo/stage.cljs
(ns puyo.stage
  (:require [puyo.config :as config]
            [puyo.drawing :as drawing]))

(defn create-field
  "ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä½œæˆã™ã‚‹ï¼ˆå…¨ã¦0ã§åˆæœŸåŒ–ï¼‰"
  []
  (vec (repeat config/stage-rows
               (vec (repeat config/stage-cols 0)))))

(defn setup-canvas
  "Canvasè¦ç´ ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹"
  []
  (let [canvas (.createElement js/document "canvas")
        ctx (.getContext canvas "2d")]
    (set! (.-width canvas) (* config/stage-cols config/puyo-size))
    (set! (.-height canvas) (* config/stage-rows config/puyo-size))
    (set! (.. canvas -style -border) (str "2px solid " config/stage-border-color))
    (set! (.. canvas -style -backgroundColor) config/stage-bg-color)

    ;; ã‚¹ãƒ†ãƒ¼ã‚¸è¦ç´ ã«è¿½åŠ 
    (when-let [stage-elem (.getElementById js/document "stage")]
      (.appendChild stage-elem canvas))

    {:canvas canvas
     :ctx ctx}))

(defn clear-canvas
  "Canvasã‚’ã‚¯ãƒªã‚¢ã™ã‚‹"
  [{:keys [canvas ctx]}]
  (when ctx
    (.clearRect ctx 0 0 (.-width canvas) (.-height canvas))))

(defn draw-field
  "ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æç”»ã™ã‚‹"
  [{:keys [ctx]} field]
  (when ctx
    (doseq [y (range config/stage-rows)
            x (range config/stage-cols)]
      (let [puyo-type (get-in field [y x])]
        (when (> puyo-type 0)
          (drawing/draw-puyo ctx puyo-type x y))))))

(defn draw-current-puyo
  "ç¾åœ¨ã®ã·ã‚ˆã‚’æç”»ã™ã‚‹"
  [{:keys [ctx]} puyo-state]
  (when ctx
    (drawing/draw-puyo ctx (:type puyo-state) (:x puyo-state) (:y puyo-state))))
```

ã€Œvec ã‚„ repeat ã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã¯ä½•ã®ãŸã‚ã§ã™ã‹ï¼Ÿã€ClojureScriptã§ã¯ã€`repeat`ã§ç¹°ã‚Šè¿”ã—ã®å€¤ã‚’ä½œã‚Šã€`vec`ã§ãƒ™ã‚¯ã‚¿ãƒ¼ã«å¤‰æ›ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€åŠ¹ç‡çš„ã«2æ¬¡å…ƒé…åˆ—ã‚’ä½œæˆã§ãã¾ã™ã€‚

ã€Œget-in ã£ã¦ä½•ã§ã™ã‹ï¼Ÿã€`get-in`ã¯ãƒã‚¹ãƒˆã—ãŸãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‹ã‚‰å€¤ã‚’å–å¾—ã™ã‚‹é–¢æ•°ã§ã™ã€‚`(get-in field [y x])`ã¯`field[y][x]`ã¨åŒã˜æ„å‘³ã§ã™ã€‚

#### coreåå‰ç©ºé–“ã®æ›´æ–°

æœ€å¾Œã«ã€ã‚²ãƒ¼ãƒ ã®ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›´æ–°ã—ã¾ã™ï¼š

```clojure
;; src/puyo/core.cljs
(ns puyo.core
  (:require [puyo.config :as config]
            [puyo.player :as player]
            [puyo.stage :as stage]))

(defonce game-state
  (atom {:mode :new-puyo
         :frame 0
         :field (stage/create-field)
         :puyo nil
         :input-state (player/create-input-state)
         :canvas-ctx nil}))

(defn initialize
  "ã‚²ãƒ¼ãƒ ã‚’åˆæœŸåŒ–ã™ã‚‹"
  []
  (let [canvas-ctx (stage/setup-canvas)]
    (reset! game-state
            {:mode :new-puyo
             :frame 0
             :field (stage/create-field)
             :puyo nil
             :input-state (player/create-input-state)
             :canvas-ctx canvas-ctx}))

  ;; ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  (player/setup-keyboard-events (:input-state @game-state)))

(defn update-game
  "ã‚²ãƒ¼ãƒ ã‚’æ›´æ–°ã™ã‚‹"
  []
  (swap! game-state update :frame inc)

  (case (:mode @game-state)
    :new-puyo
    (do
      (swap! game-state assoc :puyo (player/create-puyo))
      (swap! game-state assoc :mode :playing))

    :playing
    (let [config (config/get-config)
          updated-puyo (player/update-puyo
                        (:puyo @game-state)
                        (:input-state @game-state)
                        config)]
      (swap! game-state assoc :puyo updated-puyo))

    nil))

(defn draw-game
  "ã‚²ãƒ¼ãƒ ã‚’æç”»ã™ã‚‹"
  []
  (let [{:keys [canvas-ctx field puyo mode]} @game-state]
    (stage/clear-canvas canvas-ctx)
    (stage/draw-field canvas-ctx field)
    (when (= mode :playing)
      (stage/draw-current-puyo canvas-ctx puyo))))

(defn game-loop
  "ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—"
  []
  (update-game)
  (draw-game)
  (js/requestAnimationFrame game-loop))

(defn init
  "ã‚²ãƒ¼ãƒ ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ"
  []
  (.log js/console "Puyo Puyo Game Started!")
  (initialize)
  (game-loop))
```

ã€Œdefonce ã£ã¦ä½•ã§ã™ã‹ï¼Ÿã€`defonce`ã¯ã€ä¸€åº¦ã ã‘å®šç¾©ã•ã‚Œã‚‹å¤‰æ•°ã‚’å®£è¨€ã—ã¾ã™ã€‚ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã«å€¤ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œãªã„ã®ã§ã€é–‹ç™ºä¸­ã«çŠ¶æ…‹ã‚’ä¿æŒã§ãã¾ã™ã€‚

ã€Œswap! ã£ã¦ä½•ã§ã™ã‹ï¼Ÿã€`swap!`ã¯ã€atomã®å€¤ã‚’é–¢æ•°ã‚’ä½¿ã£ã¦æ›´æ–°ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€`(swap! game-state update :frame inc)`ã¯ã€`:frame`ã®å€¤ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã—ã¾ã™ã€‚

### å‹•ä½œç¢ºèª

ã€Œã“ã‚Œã§å®Ÿéš›ã«å‹•ã‹ã›ã¾ã™ã­ï¼ã€ã¯ã„ï¼é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```bash
$ npm run dev
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://localhost:8080` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€ã‚¹ãƒ†ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã€å††å½¢ã®ã·ã‚ˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚å·¦å³ã®çŸ¢å°ã‚­ãƒ¼ã‚’æŠ¼ã™ã¨ã€ã·ã‚ˆãŒå·¦å³ã«ç§»å‹•ã—ã¾ã™ï¼

ã€Œå‹•ãã¾ã—ãŸï¼ã€ç´ æ™´ã‚‰ã—ã„ï¼ã“ã‚Œã§ã€ãƒ†ã‚¹ãƒˆã ã‘ã§ãªãå®Ÿéš›ã®å‹•ä½œã‚‚ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã­ã€‚

### ClojureScriptã®é–¢æ•°å‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®åˆ©ç‚¹ï¼ˆå†ç¢ºèªï¼‰

ä»Šå›ã®å®Ÿè£…ã‚’é€šã˜ã¦ã€ClojureScriptã®é–¢æ•°å‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®åˆ©ç‚¹ã‚’ã•ã‚‰ã«å®Ÿæ„Ÿã§ããŸã§ã—ã‚‡ã†ã‹ï¼š

1. **ä¸å¤‰ãƒ‡ãƒ¼ã‚¿æ§‹é€ **: çŠ¶æ…‹ã‚’ç›´æ¥å¤‰æ›´ã›ãšã€æ–°ã—ã„çŠ¶æ…‹ã‚’è¿”ã™
2. **ç´”ç²‹é–¢æ•°**: `move-left`ã‚„`move-right`ã¯å‰¯ä½œç”¨ãŒãªã„
3. **atomã«ã‚ˆã‚‹çŠ¶æ…‹ç®¡ç†**: å¿…è¦ãªéƒ¨åˆ†ã ã‘å¤‰æ›´å¯èƒ½ã«ã™ã‚‹
4. **ãƒ‡ãƒ¼ã‚¿ã¨ãƒ­ã‚¸ãƒƒã‚¯ã®åˆ†é›¢**: ãƒãƒƒãƒ—ã¨ã—ã¦çŠ¶æ…‹ã‚’ç®¡ç†ã—ã€é–¢æ•°ã§å‡¦ç†ã™ã‚‹

### ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³2ã®ã¾ã¨ã‚

ã“ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å®Ÿè£…ã—ãŸå†…å®¹ï¼š

1. **playeråå‰ç©ºé–“ã®ã‚­ãƒ¼å…¥åŠ›æ¤œå‡ºæ©Ÿèƒ½**
   - `create-input-state`: å…¥åŠ›çŠ¶æ…‹ã‚’atomã®ãƒãƒƒãƒ—ã¨ã—ã¦ä½œæˆ
   - `handle-key-down`/`handle-key-up`: ã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
   - `setup-keyboard-events`: JavaScriptã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ç™»éŒ²

2. **playeråå‰ç©ºé–“ã®ã·ã‚ˆç§»å‹•æ©Ÿèƒ½**
   - `create-puyo`: æ–°ã—ã„ã·ã‚ˆã‚’ä¸å¤‰ãƒãƒƒãƒ—ã¨ã—ã¦ç”Ÿæˆ
   - `move-left`/`move-right`: ç´”ç²‹é–¢æ•°ã«ã‚ˆã‚‹ç§»å‹•å‡¦ç†ï¼ˆå¢ƒç•Œãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
   - `update-puyo`: å…¥åŠ›çŠ¶æ…‹ã«å¿œã˜ãŸã·ã‚ˆã®æ›´æ–°

3. **configåå‰ç©ºé–“**
   - å®šæ•°ã«ã‚ˆã‚‹è¨­å®šå€¤ã®ç®¡ç†
   - `get-config`: è¨­å®šã‚’ãƒãƒƒãƒ—ã¨ã—ã¦å–å¾—

4. **drawingåå‰ç©ºé–“**
   - `colors`: ãƒãƒƒãƒ—ã«ã‚ˆã‚‹è‰²å®šç¾©
   - `draw-puyo`: Canvas APIã‚’ä½¿ã£ãŸå††å½¢ã·ã‚ˆã®æç”»

5. **stageåå‰ç©ºé–“**
   - `create-field`: ãƒ™ã‚¯ã‚¿ãƒ¼ã«ã‚ˆã‚‹2æ¬¡å…ƒé…åˆ—ã®ä½œæˆ
   - `setup-canvas`: Canvasè¦ç´ ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
   - `draw-field`/`draw-current-puyo`: æç”»å‡¦ç†

6. **coreåå‰ç©ºé–“ã®æ›´æ–°**
   - `defonce`ã«ã‚ˆã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ã®ç®¡ç†
   - `swap!`ã«ã‚ˆã‚‹çŠ¶æ…‹ã®æ›´æ–°
   - `case`ã«ã‚ˆã‚‹çŠ¶æ…‹ãƒã‚·ãƒ³ã®å®Ÿè£…

### clojure.spec: ã·ã‚ˆãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å®šç¾©

ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³2ã§ã¯ã€ã·ã‚ˆã®çŠ¶æ…‹ã¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚ã“ã‚Œã‚‰ã®ä»•æ§˜ã‚’ spec ã§å®šç¾©ã—ã¾ã—ã‚‡ã†ã€‚

```clojure
;; src/puyo/specs.cljsï¼ˆè¿½åŠ ï¼‰
(ns puyo.specs
  (:require [cljs.spec.alpha :as s]
            [puyo.config :as config]))

;; åº§æ¨™ã®å®šç¾©
(s/def ::x (s/and int? #(>= % 0) #(< % config/stage-cols)))
(s/def ::y (s/and int? #(>= % 0) #(< % config/stage-rows)))

;; ã·ã‚ˆã‚¿ã‚¤ãƒ—ï¼ˆ1-4ã®è‰²ï¼‰
(s/def ::type (s/int-in 1 5))

;; å›è»¢çŠ¶æ…‹ï¼ˆ0-3ï¼‰
(s/def ::rotation (s/int-in 0 4))

;; ã·ã‚ˆã®çŠ¶æ…‹
(s/def ::puyo-state
  (s/keys :req-un [::x ::y ::type ::rotation]))

;; ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®1ã‚»ãƒ«ï¼ˆ0=ç©ºã€1-4=ã·ã‚ˆã®è‰²ï¼‰
(s/def ::cell (s/int-in 0 5))

;; ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®1è¡Œ
(s/def ::row (s/coll-of ::cell :kind vector? :count config/stage-cols))

;; ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å…¨ä½“
(s/def ::field (s/coll-of ::row :kind vector? :count config/stage-rows))
```

#### ç§»å‹•é–¢æ•°ã® spec å®šç¾©

```clojure
;; src/puyo/player.cljsï¼ˆspec ã‚’è¿½åŠ ï¼‰
(ns puyo.player
  (:require [cljs.spec.alpha :as s]
            [puyo.specs :as specs]))

;; move-left ã®ä»•æ§˜
(s/fdef move-left
  :args (s/cat :puyo-state ::specs/puyo-state
               :config map?)
  :ret ::specs/puyo-state
  :fn (fn [{:keys [args ret]}]
        (let [orig-x (-> args :puyo-state :x)
              new-x (:x ret)]
          ;; Xåº§æ¨™ã¯æ¸›å°‘ã™ã‚‹ã‹ã€ãã®ã¾ã¾ï¼ˆå·¦ç«¯ã®å ´åˆï¼‰
          (or (= new-x (dec orig-x))
              (= new-x orig-x)))))

;; move-right ã®ä»•æ§˜
(s/fdef move-right
  :args (s/cat :puyo-state ::specs/puyo-state
               :config map?)
  :ret ::specs/puyo-state
  :fn (fn [{:keys [args ret]}]
        (let [orig-x (-> args :puyo-state :x)
              new-x (:x ret)]
          ;; Xåº§æ¨™ã¯å¢—åŠ ã™ã‚‹ã‹ã€ãã®ã¾ã¾ï¼ˆå³ç«¯ã®å ´åˆï¼‰
          (or (= new-x (inc orig-x))
              (= new-x orig-x)))))
```

ã€Œ`:fn` ã§ä½•ã‚’å®šç¾©ã—ã¦ã„ã‚‹ã‚“ã§ã™ã‹ï¼Ÿã€`:fn` ã¯ã€å¼•æ•°ã¨æˆ»ã‚Šå€¤ã®**é–¢ä¿‚æ€§**ã‚’å®šç¾©ã—ã¾ã™ã€‚ä¾‹ãˆã° `move-left` ã§ã¯ã€ã€ŒXåº§æ¨™ãŒ1æ¸›ã‚‹ã‹ã€å¤‰ã‚ã‚‰ãªã„ï¼ˆå·¦ç«¯ã®å ´åˆï¼‰ã€ã¨ã„ã†ä¸å¤‰æ¡ä»¶ã‚’è¡¨ç¾ã—ã¦ã„ã¾ã™ã€‚

#### ç”Ÿæˆçš„ãƒ†ã‚¹ãƒˆã®è¿½åŠ 

```clojure
;; test/puyo/player_test.cljsï¼ˆç”Ÿæˆçš„ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ï¼‰
(ns puyo.player-test
  (:require [cljs.test :refer-macros [deftest is testing]]
            [cljs.spec.alpha :as s]
            [cljs.spec.test.alpha :as stest]
            [puyo.player :as player]
            [puyo.specs :as specs]))

(deftest ç§»å‹•é–¢æ•°ã®ç”Ÿæˆçš„ãƒ†ã‚¹ãƒˆ
  (testing "move-left ã¨ move-right ãŒä»•æ§˜ã‚’æº€ãŸã™"
    (let [results (stest/check `[player/move-left
                                 player/move-right]
                                {:clojure.spec.test.check/opts
                                 {:num-tests 100}})]
      (doseq [result results]
        (is (nil? (-> result :clojure.spec.test.check/ret :result))
            (str "ç”Ÿæˆçš„ãƒ†ã‚¹ãƒˆå¤±æ•—: " (-> result :sym)))))))
```

ã€Œ100å›ã‚‚ãƒ†ã‚¹ãƒˆã™ã‚‹ã‚“ã§ã™ã‹ï¼Ÿã€ãã†ã§ã™ï¼spec ãŒè‡ªå‹•çš„ã«ãƒ©ãƒ³ãƒ€ãƒ ãªã·ã‚ˆã®çŠ¶æ…‹ã¨è¨­å®šã‚’ç”Ÿæˆã—ã€ç§»å‹•é–¢æ•°ãŒå¸¸ã«ä»•æ§˜ã‚’æº€ãŸã™ã‹æ¤œè¨¼ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å¢ƒç•Œæ¡ä»¶ãªã©ã®ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã‚’è‡ªå‹•çš„ã«ãƒ†ã‚¹ãƒˆã§ãã¾ã™ã€‚

æ¬¡ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ã·ã‚ˆã®å›è»¢æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

## ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³3: ã·ã‚ˆã®å›è»¢ã¨é«˜é€Ÿè½ä¸‹

ã€Œå·¦å³ã«ç§»å‹•ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã‘ã©ã€ã·ã‚ˆã·ã‚ˆã£ã¦å›è»¢ã‚‚ã§ãã¾ã™ã‚ˆã­ï¼Ÿã€ãã†ã§ã™ã­ï¼ã·ã‚ˆã·ã‚ˆã®é†é†å‘³ã®ä¸€ã¤ã¯ã€ã·ã‚ˆã‚’å›è»¢ã•ã›ã¦æ€ã„é€šã‚Šã®å ´æ‰€ã«é…ç½®ã™ã‚‹ã“ã¨ã§ã™ã€‚ä»Šå›ã¯ã€ã·ã‚ˆã‚’å›è»¢ã•ã›ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã†ï¼

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼

ã¾ãšã¯ã€ã“ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å®Ÿè£…ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ï¼š

> ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ã€è½ã¡ã¦ãã‚‹ã·ã‚ˆã‚’å›è»¢ã§ãã‚‹

ã€Œå›è»¢ã£ã¦å…·ä½“çš„ã«ã©ã†ã„ã†å‹•ãã§ã™ã‹ï¼Ÿã€è‰¯ã„è³ªå•ã§ã™ã­ï¼ã·ã‚ˆã·ã‚ˆã§ã¯ã€2ã¤ã®ã·ã‚ˆãŒé€£ãªã£ãŸçŠ¶æ…‹ã§è½ã¡ã¦ãã¾ã™ã€‚å›è»¢ã¨ã¯ã€ã“ã®2ã¤ã®ã·ã‚ˆã®ç›¸å¯¾çš„ãªä½ç½®é–¢ä¿‚ã‚’å¤‰ãˆã‚‹ã“ã¨ã§ã™ã€‚ä¾‹ãˆã°ã€ç¸¦ã«ä¸¦ã‚“ã§ã„ã‚‹ã·ã‚ˆã‚’æ¨ªã«ä¸¦ã¶ã‚ˆã†ã«å¤‰ãˆãŸã‚Šã§ãã‚‹ã‚“ã§ã™ã‚ˆã€‚

### TODOãƒªã‚¹ãƒˆ

ã€Œã©ã‚“ãªä½œæ¥­ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã‹ï¼Ÿã€ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã€TODOãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ã€Œã·ã‚ˆã‚’å›è»¢ã•ã›ã‚‹ã€ã¨ã„ã†æ©Ÿèƒ½ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¿ã‚¹ã‚¯ãŒå¿…è¦ãã†ã§ã™ã­ï¼š

- ã·ã‚ˆã®å›è»¢å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹ï¼ˆæ™‚è¨ˆå›ã‚Šãƒ»åæ™‚è¨ˆå›ã‚Šã®å›è»¢ï¼‰
- å›è»¢å¯èƒ½ã‹ã©ã†ã‹ã®ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚‹ï¼ˆä»–ã®ã·ã‚ˆã‚„å£ã«ã¶ã¤ã‹ã‚‹å ´åˆã¯å›è»¢ã§ããªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰
- å£ã‚­ãƒƒã‚¯å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹ï¼ˆå£éš›ã§ã®å›è»¢ã‚’å¯èƒ½ã«ã™ã‚‹ç‰¹æ®Šå‡¦ç†ï¼‰
- å›è»¢å¾Œã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹ï¼ˆç”»é¢ä¸Šã§ã·ã‚ˆã®ä½ç½®ãŒå¤‰ã‚ã£ãŸã“ã¨ã‚’è¡¨ç¤ºã™ã‚‹ï¼‰

ã€Œå£ã‚­ãƒƒã‚¯ã£ã¦ä½•ã§ã™ã‹ï¼Ÿã€å£ã‚­ãƒƒã‚¯ã¨ã¯ã€ã·ã‚ˆãŒå£éš›ã«ã‚ã‚‹ã¨ãã«å›è»¢ã™ã‚‹ã¨å£ã«ã‚ã‚Šè¾¼ã‚“ã§ã—ã¾ã†ã®ã§ã€è‡ªå‹•çš„ã«å°‘ã—ä½ç½®ã‚’ãšã‚‰ã—ã¦å›è»¢ã‚’å¯èƒ½ã«ã™ã‚‹å‡¦ç†ã®ã“ã¨ã§ã™ã€‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ“ä½œæ€§ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã®å·¥å¤«ãªã‚“ã§ã™ã‚ˆã€‚

### ãƒ†ã‚¹ãƒˆ: ã·ã‚ˆã®å›è»¢

ã€Œã¾ãšã¯ä½•ã‹ã‚‰ãƒ†ã‚¹ãƒˆã—ã¾ã™ã‹ï¼Ÿã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®æµã‚Œã«æ²¿ã£ã¦ã€ã¾ãšã¯åŸºæœ¬çš„ãªå›è»¢æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆã‹ã‚‰æ›¸ã„ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

ClojureScriptã§ã¯ã€ã·ã‚ˆã®çŠ¶æ…‹ï¼ˆè»¸ã·ã‚ˆã¨å­ã·ã‚ˆï¼‰ã‚’ä¸å¤‰ã®ãƒãƒƒãƒ—ã§è¡¨ç¾ã—ã¾ã™ã€‚å›è»¢ã¯ã€æ–°ã—ã„å›è»¢çŠ¶æ…‹ã‚’æŒã¤ãƒãƒƒãƒ—ã‚’è¿”ã™ç´”ç²‹é–¢æ•°ã¨ã—ã¦å®Ÿè£…ã—ã¾ã™ã€‚

```clojure
;; test/puyo/player_test.cljsï¼ˆç¶šãï¼‰
(deftest ã·ã‚ˆå›è»¢ãƒ†ã‚¹ãƒˆ
  (testing "æ™‚è¨ˆå›ã‚Šã«å›è»¢ã™ã‚‹ã¨ã€å›è»¢çŠ¶æ…‹ãŒ1å¢—ãˆã‚‹"
    (let [puyo-state {:x 2 :y 0 :type 1 :rotation 0}]
      (let [new-state (player/rotate-right puyo-state)]
        (is (= 1 (:rotation new-state)) "å›è»¢çŠ¶æ…‹ãŒ1ã«ãªã‚‹"))))

  (testing "åæ™‚è¨ˆå›ã‚Šã«å›è»¢ã™ã‚‹ã¨ã€å›è»¢çŠ¶æ…‹ãŒ1æ¸›ã‚‹"
    (let [puyo-state {:x 2 :y 0 :type 1 :rotation 1}]
      (let [new-state (player/rotate-left puyo-state)]
        (is (= 0 (:rotation new-state)) "å›è»¢çŠ¶æ…‹ãŒ0ã«ãªã‚‹"))))

  (testing "å›è»¢çŠ¶æ…‹ãŒ4ã«ãªã‚‹ã¨0ã«æˆ»ã‚‹"
    (let [puyo-state {:x 2 :y 0 :type 1 :rotation 3}]
      (let [new-state (player/rotate-right puyo-state)]
        (is (= 0 (:rotation new-state)) "å›è»¢çŠ¶æ…‹ãŒ0ã«æˆ»ã‚‹")))))
```

ã€Œã“ã®ãƒ†ã‚¹ãƒˆã¯ä½•ã‚’ç¢ºèªã—ã¦ã„ã‚‹ã‚“ã§ã™ã‹ï¼Ÿã€ã“ã®ãƒ†ã‚¹ãƒˆã§ã¯ã€ä»¥ä¸‹ã®3ã¤ã®ã‚±ãƒ¼ã‚¹ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ï¼š

1. æ™‚è¨ˆå›ã‚Šã«å›è»¢ã™ã‚‹ã¨ã€å›è»¢çŠ¶æ…‹ãŒ1å¢—ãˆã‚‹ã‹
2. åæ™‚è¨ˆå›ã‚Šã«å›è»¢ã™ã‚‹ã¨ã€å›è»¢çŠ¶æ…‹ãŒ1æ¸›ã‚‹ã‹ï¼ˆãŸã ã—ã€è² ã®å€¤ã«ãªã‚‰ãªã„ã‚ˆã†ã«èª¿æ•´ï¼‰
3. å›è»¢çŠ¶æ…‹ãŒæœ€å¤§å€¤ï¼ˆ3ï¼‰ã‹ã‚‰æ™‚è¨ˆå›ã‚Šã«å›è»¢ã™ã‚‹ã¨ã€0ã«æˆ»ã‚‹ã‹ï¼ˆå¾ªç’°ã™ã‚‹ã‹ï¼‰

ã€Œå›è»¢çŠ¶æ…‹ã£ã¦ä½•ã§ã™ã‹ï¼Ÿã€å›è»¢çŠ¶æ…‹ã¯ã€ã·ã‚ˆã®å‘ãã‚’è¡¨ã™å€¤ã§ã™ã€‚0ã‹ã‚‰3ã¾ã§ã®å€¤ã‚’å–ã‚Šã€ãã‚Œãã‚Œä»¥ä¸‹ã®çŠ¶æ…‹ã‚’è¡¨ã—ã¾ã™ï¼š
- 0: 2ã¤ç›®ã®ã·ã‚ˆãŒä¸Šã«ã‚ã‚‹çŠ¶æ…‹
- 1: 2ã¤ç›®ã®ã·ã‚ˆãŒå³ã«ã‚ã‚‹çŠ¶æ…‹
- 2: 2ã¤ç›®ã®ã·ã‚ˆãŒä¸‹ã«ã‚ã‚‹çŠ¶æ…‹
- 3: 2ã¤ç›®ã®ã·ã‚ˆãŒå·¦ã«ã‚ã‚‹çŠ¶æ…‹

ã€Œãªã‚‹ã»ã©ã€4æ–¹å‘ã®å›è»¢ã‚’è¡¨ç¾ã™ã‚‹ã‚“ã§ã™ã­ï¼ã€ãã†ã§ã™ï¼ã§ã¯ã€ã“ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

### å®Ÿè£…: ã·ã‚ˆã®å›è»¢

ã€Œãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸã‚‰ã€å®Ÿè£…ã«é€²ã¿ã¾ã—ã‚‡ã†ï¼ã€ãã†ã§ã™ã­ã€‚ã§ã¯ã€ã·ã‚ˆã‚’å›è»¢ã•ã›ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

```clojure
;; src/puyo/player.cljsï¼ˆç¶šãï¼‰
(defn rotate-right
  "æ™‚è¨ˆå›ã‚Šã«å›è»¢ã™ã‚‹"
  [puyo-state]
  (update puyo-state :rotation #(mod (inc %) 4)))

(defn rotate-left
  "åæ™‚è¨ˆå›ã‚Šã«å›è»¢ã™ã‚‹"
  [puyo-state]
  (update puyo-state :rotation #(mod (+ % 3) 4)))

(defn get-child-offset
  "å›è»¢çŠ¶æ…‹ã«å¿œã˜ãŸå­ã·ã‚ˆã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’å–å¾—"
  [rotation]
  (case rotation
    0 {:x 0 :y -1}  ; ä¸Š
    1 {:x 1 :y 0}   ; å³
    2 {:x 0 :y 1}   ; ä¸‹
    3 {:x -1 :y 0}  ; å·¦
    {:x 0 :y -1}))  ; ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
```

ã€Œã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã­ï¼ã€ãã†ã§ã™ã­ã€‚é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’èª¬æ˜ã—ã¾ã—ã‚‡ã†ï¼š

1. **modé–¢æ•°**: `(mod (inc %) 4)`ã§0-3ã®ç¯„å›²ã§å¾ªç’°ã•ã›ã¾ã™
2. **åæ™‚è¨ˆå›ã‚Š**: `(+ % 3)`ã¯`(- % 1)`ã¨åŒã˜åŠ¹æœã§ã€è² ã®å€¤ã‚’é¿ã‘ã¾ã™
3. **updateé–¢æ•°**: é–¢æ•°ã‚’é©ç”¨ã—ã¦æ–°ã—ã„ãƒãƒƒãƒ—ã‚’è¿”ã—ã¾ã™
4. **get-child-offset**: å›è»¢çŠ¶æ…‹ã‹ã‚‰å­ã·ã‚ˆã®ç›¸å¯¾ä½ç½®ã‚’è¨ˆç®—ã—ã¾ã™

ã€Œãªãœåæ™‚è¨ˆå›ã‚Šã®å ´åˆã¯å˜ç´”ã«1æ¸›ã‚‰ã™ã®ã§ã¯ãªãã€3ã‚’è¶³ã—ã¦4ã§å‰²ã‚‹ã‚“ã§ã™ã‹ï¼Ÿã€é‹­ã„è³ªå•ã§ã™ã­ï¼ClojureScriptã§ã‚‚ã€è² ã®æ•°ã®å‰°ä½™æ¼”ç®—ã®çµæœãŒäºˆæƒ³ã¨ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚3ã‚’è¶³ã—ã¦ï¼ˆã“ã‚Œã¯1ã‚’å¼•ãã®ã¨åŒã˜åŠ¹æœãŒã‚ã‚Šã¾ã™ï¼‰ã‹ã‚‰4ã§å‰²ã‚‹ã“ã¨ã§ã€ç¢ºå®Ÿã«0-3ã®ç¯„å›²ã«åã‚ã¦ã„ã‚‹ã‚“ã§ã™ã€‚

### ãƒ†ã‚¹ãƒˆ: å£ã‚­ãƒƒã‚¯å‡¦ç†

ã€Œå£ã‚­ãƒƒã‚¯å‡¦ç†ã®ãƒ†ã‚¹ãƒˆã¯ã©ã†ã‚„ã£ã¦æ›¸ãã‚“ã§ã™ã‹ï¼Ÿã€å£ã‚­ãƒƒã‚¯å‡¦ç†ã¯ã€ã·ã‚ˆãŒå£éš›ã«ã‚ã‚‹ã¨ãã«å›è»¢ã™ã‚‹ã¨è‡ªå‹•çš„ã«ä½ç½®ã‚’èª¿æ•´ã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚ã“ã‚Œã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã«ã¯ã€ã·ã‚ˆã‚’å£éš›ã«é…ç½®ã—ã€å›è»¢ã•ã›ãŸã¨ãã«é©åˆ‡ã«ä½ç½®ãŒèª¿æ•´ã•ã‚Œã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚

```clojure
;; test/puyo/player_test.cljsï¼ˆç¶šãï¼‰
(deftest å£ã‚­ãƒƒã‚¯å‡¦ç†ãƒ†ã‚¹ãƒˆ
  (testing "å³ç«¯ã§å³å›è»¢ã™ã‚‹ã¨ã€å·¦ã«ç§»å‹•ã—ã¦å›è»¢ã™ã‚‹ï¼ˆå£ã‚­ãƒƒã‚¯ï¼‰"
    (let [config {:stage-cols 6}
          puyo-state {:x 5 :y 0 :type 1 :rotation 0}]
      (let [new-state (player/perform-rotation puyo-state config player/rotate-right)]
        (is (= 4 (:x new-state)) "Xåº§æ¨™ãŒ4ã«ãªã‚‹ï¼ˆå·¦ã«ç§»å‹•ï¼‰")
        (is (= 1 (:rotation new-state)) "å›è»¢çŠ¶æ…‹ãŒ1ã«ãªã‚‹"))))

  (testing "å·¦ç«¯ã§å·¦å›è»¢ã™ã‚‹ã¨ã€å³ã«ç§»å‹•ã—ã¦å›è»¢ã™ã‚‹ï¼ˆå£ã‚­ãƒƒã‚¯ï¼‰"
    (let [config {:stage-cols 6}
          puyo-state {:x 0 :y 0 :type 1 :rotation 0}]
      (let [new-state (player/perform-rotation puyo-state config player/rotate-left)]
        (is (= 1 (:x new-state)) "Xåº§æ¨™ãŒ1ã«ãªã‚‹ï¼ˆå³ã«ç§»å‹•ï¼‰")
        (is (= 3 (:rotation new-state)) "å›è»¢çŠ¶æ…‹ãŒ3ã«ãªã‚‹")))))
```

ã€Œã“ã®ãƒ†ã‚¹ãƒˆã§ã¯ä½•ã‚’ç¢ºèªã—ã¦ã„ã‚‹ã‚“ã§ã™ã‹ï¼Ÿã€ã“ã®ãƒ†ã‚¹ãƒˆã§ã¯ã€ä»¥ä¸‹ã®2ã¤ã®ã‚±ãƒ¼ã‚¹ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ï¼š

1. å³ç«¯ã«ã„ã‚‹ã¨ãã«æ™‚è¨ˆå›ã‚Šã«å›è»¢ã™ã‚‹ã¨ã€å·¦ã«1ãƒã‚¹ç§»å‹•ã—ã¦å›è»¢ã™ã‚‹ã‹
2. å·¦ç«¯ã«ã„ã‚‹ã¨ãã«åæ™‚è¨ˆå›ã‚Šã«å›è»¢ã™ã‚‹ã¨ã€å³ã«1ãƒã‚¹ç§»å‹•ã—ã¦å›è»¢ã™ã‚‹ã‹

ã€Œãªã‚‹ã»ã©ã€å£ã«ã‚ã‚Šè¾¼ã¾ãªã„ã‚ˆã†ã«è‡ªå‹•çš„ã«ä½ç½®ã‚’èª¿æ•´ã™ã‚‹ã‚“ã§ã™ã­ï¼ã€ãã†ã§ã™ï¼ã“ã‚ŒãŒã„ã‚ã‚†ã‚‹ã€Œå£ã‚­ãƒƒã‚¯ã€ã¨å‘¼ã°ã‚Œã‚‹å‡¦ç†ã§ã™ã€‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ“ä½œæ€§ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã®å·¥å¤«ãªã‚“ã§ã™ã‚ˆã€‚ã§ã¯ã€ã“ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

### å®Ÿè£…: å£ã‚­ãƒƒã‚¯å‡¦ç†

ã€Œãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸã‚‰ã€å®Ÿè£…ã«é€²ã¿ã¾ã—ã‚‡ã†ï¼ã€ãã†ã§ã™ã­ã€‚ã§ã¯ã€å£ã‚­ãƒƒã‚¯å‡¦ç†ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

```clojure
;; src/puyo/player.cljsï¼ˆç¶šãï¼‰
(defn perform-rotation
  "å›è»¢ã‚’å®Ÿè¡Œã—ã€å¿…è¦ã«å¿œã˜ã¦å£ã‚­ãƒƒã‚¯ã‚’è¡Œã†"
  [puyo-state config rotate-fn]
  (let [rotated (rotate-fn puyo-state)
        offset (get-child-offset (:rotation rotated))
        child-x (+ (:x rotated) (:x offset))]
    (cond
      ;; å³å£ã«ã‚ã‚Šè¾¼ã‚€å ´åˆã€å·¦ã«ç§»å‹•
      (>= child-x (:stage-cols config))
      (update rotated :x dec)

      ;; å·¦å£ã«ã‚ã‚Šè¾¼ã‚€å ´åˆã€å³ã«ç§»å‹•
      (< child-x 0)
      (update rotated :x inc)

      ;; å£ã«ã‚ã‚Šè¾¼ã¾ãªã„å ´åˆã€ãã®ã¾ã¾
      :else
      rotated)))

(defn update-puyo
  "å…¥åŠ›ã«å¿œã˜ã¦ã·ã‚ˆã‚’æ›´æ–°ã™ã‚‹ï¼ˆå›è»¢ã‚’å«ã‚€ï¼‰"
  [puyo-state input-state config]
  (cond
    @(:left input-state)
    (do
      (reset! (:left input-state) false)
      (move-left puyo-state config))

    @(:right input-state)
    (do
      (reset! (:right input-state) false)
      (move-right puyo-state config))

    @(:up input-state)
    (do
      (reset! (:up input-state) false)
      (perform-rotation puyo-state config rotate-right))

    :else
    puyo-state))
```

ã€Œãªã‚‹ã»ã©ã€å›è»¢å¾Œã«å£ã«ã‚ã‚Šè¾¼ã‚€å ´åˆã¯ä½ç½®ã‚’èª¿æ•´ã™ã‚‹ã‚“ã§ã™ã­ï¼ã€ãã†ã§ã™ï¼ã“ã®å®Ÿè£…ã§ã¯ã€ä»¥ä¸‹ã®ã“ã¨ã‚’è¡Œã£ã¦ã„ã¾ã™ï¼š

1. ã¾ãšé€šå¸¸ã®å›è»¢å‡¦ç†ã‚’è¡Œã†ï¼ˆ`rotate-fn`ã‚’å‘¼ã³å‡ºã™ï¼‰
2. å›è»¢å¾Œã®å­ã·ã‚ˆã®ä½ç½®ã‚’è¨ˆç®—ã™ã‚‹
3. å­ã·ã‚ˆãŒå£ã«ã‚ã‚Šè¾¼ã‚€çŠ¶æ³ã«ãªã£ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹
4. ã‚ã‚Šè¾¼ã‚€å ´åˆã¯ã€è»¸ã·ã‚ˆã®ä½ç½®ã‚’èª¿æ•´ã™ã‚‹ï¼ˆå£ã‚­ãƒƒã‚¯ï¼‰

ã€ŒClojureScriptã®é–¢æ•°å‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒã‚ˆãã‚ã‹ã‚Šã¾ã™ã­ï¼ã€ãã†ã§ã™ã­ã€‚é‡è¦ãªãƒã‚¤ãƒ³ãƒˆï¼š

1. **é«˜éšé–¢æ•°**: `perform-rotation`ã¯å›è»¢é–¢æ•°ã‚’å¼•æ•°ã¨ã—ã¦å—ã‘å–ã‚Šã¾ã™
2. **letæŸç¸›**: ä¸­é–“çµæœã‚’åå‰ä»˜ãã§ç®¡ç†ã—ã¾ã™
3. **condå¼**: è¤‡æ•°ã®æ¡ä»¶ã‚’é †ã«è©•ä¾¡ã—ã¾ã™
4. **ä¸å¤‰æ€§**: å…ƒã®çŠ¶æ…‹ã‚’å¤‰æ›´ã›ãšã€æ–°ã—ã„çŠ¶æ…‹ã‚’è¿”ã—ã¾ã™

### å®Ÿè£…: 2ã¤ç›®ã®ã·ã‚ˆã®æç”»

ã€Œå›è»¢ã—ãŸã·ã‚ˆã‚’ç”»é¢ã«è¡¨ç¤ºã—ãŸã„ã§ã™ã­ï¼ã€ãã†ã§ã™ã­ï¼ã§ã¯ã€2ã¤ç›®ã®ã·ã‚ˆï¼ˆå­ã·ã‚ˆï¼‰ã‚’æç”»ã™ã‚‹æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã—ã‚‡ã†ã€‚

```clojure
;; src/puyo/stage.cljsï¼ˆæ›´æ–°ï¼‰
(defn draw-current-puyo
  "ç¾åœ¨ã®ã·ã‚ˆã‚’æç”»ã™ã‚‹ï¼ˆè»¸ã·ã‚ˆã¨å­ã·ã‚ˆï¼‰"
  [{:keys [ctx]} puyo-state]
  (when ctx
    (let [offset (player/get-child-offset (:rotation puyo-state))
          child-x (+ (:x puyo-state) (:x offset))
          child-y (+ (:y puyo-state) (:y offset))]
      ;; è»¸ã·ã‚ˆã‚’æç”»
      (drawing/draw-puyo ctx (:type puyo-state) (:x puyo-state) (:y puyo-state))
      ;; å­ã·ã‚ˆã‚’æç”»ï¼ˆè»¸ã·ã‚ˆã¨åŒã˜è‰²ï¼‰
      (drawing/draw-puyo ctx (:type puyo-state) child-x child-y))))
```

ã€Œ2ã¤ã®ã·ã‚ˆã‚’æç”»ã™ã‚‹ã‚ˆã†ã«ãªã£ãŸã‚“ã§ã™ã­ï¼ã€ãã†ã§ã™ï¼`get-child-offset`ã‚’ä½¿ã£ã¦å­ã·ã‚ˆã®ä½ç½®ã‚’è¨ˆç®—ã—ã€è»¸ã·ã‚ˆã¨å­ã·ã‚ˆã®ä¸¡æ–¹ã‚’æç”»ã—ã¦ã„ã¾ã™ã€‚

### å‹•ä½œç¢ºèª

ã€Œã“ã‚Œã§å®Ÿéš›ã«å‹•ã‹ã›ã¾ã™ã­ï¼ã€ã¯ã„ï¼é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```bash
$ npm run dev
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://localhost:8080` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€2ã¤ã®ã·ã‚ˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ä¸ŠçŸ¢å°ã‚­ãƒ¼ã‚’æŠ¼ã™ã¨ã€ã·ã‚ˆãŒå›è»¢ã—ã¾ã™ï¼

ã€Œå‹•ãã¾ã—ãŸï¼ã€ç´ æ™´ã‚‰ã—ã„ï¼ã“ã‚Œã§ã€ã·ã‚ˆã‚’å›è»¢ã•ã›ãªãŒã‚‰å·¦å³ã«ç§»å‹•ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã­ã€‚

### ClojureScriptã®é–¢æ•°å‹ãƒ‘ã‚¿ãƒ¼ãƒ³

ä»Šå›ã®å®Ÿè£…ã§ä½¿ç”¨ã—ãŸé–¢æ•°å‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š

1. **é«˜éšé–¢æ•°**: `perform-rotation`ã¯é–¢æ•°ã‚’å¼•æ•°ã¨ã—ã¦å—ã‘å–ã‚‹
2. **ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°**: `case`å¼ã§å›è»¢çŠ¶æ…‹ã‹ã‚‰åº§æ¨™ã‚’è¨ˆç®—
3. **ä¸å¤‰ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼**: çŠ¶æ…‹ã‚’å¤‰æ›´ã›ãšã€æ–°ã—ã„çŠ¶æ…‹ã‚’è¿”ã™
4. **letæŸç¸›**: è¤‡é›‘ãªè¨ˆç®—ã‚’æ®µéšçš„ã«åå‰ä»˜ã‘

### ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³3ã®ã¾ã¨ã‚

ã“ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å®Ÿè£…ã—ãŸå†…å®¹ï¼š

1. **å›è»¢çŠ¶æ…‹ã®ç®¡ç†**
   - `:rotation`ã‚­ãƒ¼ï¼š0(ä¸Š)ã€1(å³)ã€2(ä¸‹)ã€3(å·¦)ã®4çŠ¶æ…‹ã§ç®¡ç†
   - `get-child-offset`ï¼šå›è»¢çŠ¶æ…‹ã‹ã‚‰å­ã·ã‚ˆã®ç›¸å¯¾ä½ç½®ã‚’è¨ˆç®—

2. **å›è»¢é–¢æ•°ã®å®Ÿè£…**
   - `rotate-right`ï¼šæ™‚è¨ˆå›ã‚Šã«å›è»¢ï¼ˆrotation ã‚’ +1ï¼‰
   - `rotate-left`ï¼šåæ™‚è¨ˆå›ã‚Šã«å›è»¢ï¼ˆrotation ã‚’ +3ã€ã¤ã¾ã‚Š -1 ã¨åŒç­‰ï¼‰
   - `mod`é–¢æ•°ã«ã‚ˆã‚‹å¾ªç’°çš„ãªçŠ¶æ…‹é·ç§»

3. **å£ã‚­ãƒƒã‚¯å‡¦ç†**
   - `perform-rotation`ï¼šå›è»¢ã¨å£ã‚­ãƒƒã‚¯ã‚’çµ±åˆ
   - é«˜éšé–¢æ•°ã«ã‚ˆã‚‹æŸ”è»Ÿãªè¨­è¨ˆ
   - å­ã·ã‚ˆãŒå£å¤–ã«å‡ºã‚‹å ´åˆã€è»¸ã·ã‚ˆã®ä½ç½®ã‚’è‡ªå‹•èª¿æ•´

4. **æç”»ã®æ›´æ–°**
   - `draw-current-puyo`ã§è»¸ã·ã‚ˆã¨å­ã·ã‚ˆã®ä¸¡æ–¹ã‚’æç”»
   - å›è»¢çŠ¶æ…‹ã«å¿œã˜ãŸå­ã·ã‚ˆã®ä½ç½®è¨ˆç®—

5. **å…¥åŠ›å‡¦ç†ã®æ‹¡å¼µ**
   - `update-puyo`ã§ä¸Šã‚­ãƒ¼ã«ã‚ˆã‚‹å›è»¢å‡¦ç†
   - `cond`å¼ã«ã‚ˆã‚‹è¤‡æ•°å…¥åŠ›ã®å‡¦ç†

6. **ãƒ†ã‚¹ãƒˆã®ä½œæˆ**
   - å›è»¢æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆï¼ˆ3ãƒ†ã‚¹ãƒˆï¼‰
   - å£ã‚­ãƒƒã‚¯å‡¦ç†ã®ãƒ†ã‚¹ãƒˆï¼ˆ2ãƒ†ã‚¹ãƒˆï¼‰
   - ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸ

### clojure.spec: å›è»¢é–¢æ•°ã®ä»•æ§˜

ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³3ã§ã¯ã€å›è»¢æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚å›è»¢é–¢æ•°ã®ä»•æ§˜ã‚’ spec ã§å®šç¾©ã—ã¾ã—ã‚‡ã†ã€‚

```clojure
;; src/puyo/player.cljsï¼ˆå›è»¢é–¢æ•°ã® spec ã‚’è¿½åŠ ï¼‰

;; rotate-right ã®ä»•æ§˜
(s/fdef rotate-right
  :args (s/cat :puyo-state ::specs/puyo-state)
  :ret ::specs/puyo-state
  :fn (fn [{:keys [args ret]}]
        (let [orig-rot (-> args :puyo-state :rotation)
              new-rot (:rotation ret)]
          ;; å›è»¢çŠ¶æ…‹ãŒ +1 ã•ã‚Œã¦ã„ã‚‹ï¼ˆmod 4ï¼‰
          (= new-rot (mod (inc orig-rot) 4)))))

;; rotate-left ã®ä»•æ§˜
(s/fdef rotate-left
  :args (s/cat :puyo-state ::specs/puyo-state)
  :ret ::specs/puyo-state
  :fn (fn [{:keys [args ret]}]
        (let [orig-rot (-> args :puyo-state :rotation)
              new-rot (:rotation ret)]
          ;; å›è»¢çŠ¶æ…‹ãŒ -1 ã•ã‚Œã¦ã„ã‚‹ï¼ˆmod 4ï¼‰
          (= new-rot (mod (+ orig-rot 3) 4)))))

;; perform-rotation ã®ä»•æ§˜
(s/fdef perform-rotation
  :args (s/cat :puyo-state ::specs/puyo-state
               :config map?
               :rotate-fn (s/fspec :args (s/cat :puyo-state ::specs/puyo-state)
                                   :ret ::specs/puyo-state))
  :ret ::specs/puyo-state
  :fn (fn [{:keys [args ret]}]
        ;; å›è»¢å¾Œã®Xåº§æ¨™ãŒãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å†…ã«åã¾ã£ã¦ã„ã‚‹
        (let [x (:x ret)
              config (:config args)]
          (and (>= x 0)
               (< x (:stage-cols config))))))
```

ã€Œ`s/fspec` ã£ã¦ä½•ã§ã™ã‹ï¼Ÿã€`s/fspec` ã¯ã€é–¢æ•°è‡ªä½“ã®ä»•æ§˜ã‚’å®šç¾©ã™ã‚‹ spec ã§ã™ã€‚`perform-rotation` ã¯é–¢æ•°ã‚’å¼•æ•°ã¨ã—ã¦å—ã‘å–ã‚‹é«˜éšé–¢æ•°ãªã®ã§ã€ãã®å¼•æ•°ã®é–¢æ•°ã®ä»•æ§˜ã‚‚å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

#### ç”Ÿæˆçš„ãƒ†ã‚¹ãƒˆã®è¿½åŠ 

```clojure
;; test/puyo/player_test.cljsï¼ˆå›è»¢é–¢æ•°ã®ç”Ÿæˆçš„ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ï¼‰
(deftest å›è»¢é–¢æ•°ã®ç”Ÿæˆçš„ãƒ†ã‚¹ãƒˆ
  (testing "rotate-right, rotate-left, perform-rotation ãŒä»•æ§˜ã‚’æº€ãŸã™"
    (let [results (stest/check `[player/rotate-right
                                 player/rotate-left
                                 player/perform-rotation]
                                {:clojure.spec.test.check/opts
                                 {:num-tests 100}})]
      (doseq [result results]
        (is (nil? (-> result :clojure.spec.test.check/ret :result))
            (str "ç”Ÿæˆçš„ãƒ†ã‚¹ãƒˆå¤±æ•—: " (-> result :sym)))))))
```

ã€Œé«˜éšé–¢æ•°ã®ãƒ†ã‚¹ãƒˆã‚‚è‡ªå‹•ç”Ÿæˆã§ãã‚‹ã‚“ã§ã™ã‹ï¼Ÿã€ãã†ã§ã™ï¼spec ã¯é–¢æ•°ã‚’å¼•æ•°ã¨ã—ã¦å—ã‘å–ã‚‹é«˜éšé–¢æ•°ã®ä»•æ§˜ã‚‚å®šç¾©ã§ãã€ç”Ÿæˆçš„ãƒ†ã‚¹ãƒˆã§æ¤œè¨¼ã§ãã¾ã™ã€‚

æ¬¡ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ã·ã‚ˆã®è‡ªå‹•è½ä¸‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

## ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³4: ã·ã‚ˆã®æ¶ˆå»

ã€Œå›è»¢ã¨ç§»å‹•ãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã‘ã©ã€ã·ã‚ˆã·ã‚ˆã®æœ¬è³ªã¯ã·ã‚ˆã‚’æ¶ˆã™ã“ã¨ã§ã™ã‚ˆã­ï¼Ÿã€ãã†ã§ã™ã­ï¼åŒã˜è‰²ã®ã·ã‚ˆã‚’4ã¤ä»¥ä¸Šã¤ãªã’ã‚‹ã¨æ¶ˆãˆã‚‹ã€ã“ã‚ŒãŒã·ã‚ˆã·ã‚ˆã®é†é†å‘³ã§ã™ã€‚ä»Šå›ã¯ã€ã·ã‚ˆã®æ¶ˆå»æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã†ï¼

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼

> ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ã€åŒã˜è‰²ã®ã·ã‚ˆã‚’4ã¤ä»¥ä¸Šã¤ãªã’ã‚‹ã¨æ¶ˆå»ã§ãã‚‹

ã€Œã©ã†ã‚„ã£ã¦åŒã˜è‰²ã®ã·ã‚ˆãŒç¹‹ãŒã£ã¦ã„ã‚‹ã‹åˆ¤å®šã™ã‚‹ã‚“ã§ã™ã‹ï¼Ÿã€è‰¯ã„è³ªå•ã§ã™ã­ï¼ã“ã‚Œã¯ã€Œé€£çµæˆåˆ†ã€ã‚’æ¢ç´¢ã™ã‚‹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§å®Ÿè£…ã—ã¾ã™ã€‚æ·±ã•å„ªå…ˆæ¢ç´¢ï¼ˆDFSï¼‰ã‚’ä½¿ã£ã¦ã€éš£æ¥ã™ã‚‹åŒã˜è‰²ã®ã·ã‚ˆã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦ã„ãã‚“ã§ã™ã‚ˆã€‚

### TODOãƒªã‚¹ãƒˆ

- åŒã˜è‰²ã®ã·ã‚ˆã‚’æ¢ç´¢ã™ã‚‹ï¼ˆæ·±ã•å„ªå…ˆæ¢ç´¢ã®å®Ÿè£…ï¼‰
- 4ã¤ä»¥ä¸Šç¹‹ãŒã£ã¦ã„ã‚‹ã·ã‚ˆã‚’æ¶ˆå»ã™ã‚‹
- æ¶ˆå»å¾Œã®ã‚¹ã‚³ã‚¢è¨ˆç®—
- ã·ã‚ˆãŒæ¶ˆãˆãŸå¾Œã®è½ä¸‹å‡¦ç†

### ãƒ†ã‚¹ãƒˆ: ã·ã‚ˆã®æ¢ç´¢ã¨æ¶ˆå»

ClojureScriptã®ä¸å¤‰ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¨å†å¸°ã‚’ä½¿ã£ã¦ã€ã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆã«å®Ÿè£…ã§ãã¾ã™ã€‚

```clojure
;; test/puyo/erase_test.cljs
(ns puyo.erase-test
  (:require [cljs.test :refer-macros [deftest is testing]]
            [puyo.erase :as erase]))

(deftest ã·ã‚ˆæ¢ç´¢ãƒ†ã‚¹ãƒˆ
  (testing "åŒã˜è‰²ã®ã·ã‚ˆãŒ4ã¤ä»¥ä¸Šç¹‹ãŒã£ã¦ã„ã‚‹å ´åˆã€ãã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å–å¾—ã§ãã‚‹"
    (let [field [[1 1 0 0 0 0]
                 [1 1 0 0 0 0]
                 [0 0 0 0 0 0]
                 [0 0 0 0 0 0]]
          group (erase/find-connected field 0 0)]
      (is (= 4 (count group)) "4ã¤ã®ã·ã‚ˆãŒç¹‹ãŒã£ã¦ã„ã‚‹")
      (is (contains? (set group) [0 0]))
      (is (contains? (set group) [0 1]))
      (is (contains? (set group) [1 0]))
      (is (contains? (set group) [1 1]))))

  (testing "3ã¤ä»¥ä¸‹ã®ã·ã‚ˆã¯æ¶ˆå»å¯¾è±¡ã«ãªã‚‰ãªã„"
    (let [field [[1 1 1 0 0 0]
                 [0 0 0 0 0 0]]
          erasable (erase/find-erasable-groups field)]
      (is (empty? erasable) "3ã¤ã®ã‚°ãƒ«ãƒ¼ãƒ—ã¯æ¶ˆå»ã•ã‚Œãªã„"))))
```

### å®Ÿè£…: æ·±ã•å„ªå…ˆæ¢ç´¢

ClojureScriptã®å†å¸°ã¨ä¸å¤‰ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æ´»ã‹ã—ãŸå®Ÿè£…ï¼š

```clojure
;; src/puyo/erase.cljs
(ns puyo.erase
  (:require [puyo.config :as config]))

(defn get-neighbors
  "éš£æ¥ã™ã‚‹åº§æ¨™ã‚’å–å¾—"
  [y x]
  [[(dec y) x]    ; ä¸Š
   [(inc y) x]    ; ä¸‹
   [y (dec x)]    ; å·¦
   [y (inc x)]])  ; å³

(defn in-bounds?
  "åº§æ¨™ãŒãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å†…ã‹ãƒã‚§ãƒƒã‚¯"
  [y x]
  (and (>= y 0) (< y config/stage-rows)
       (>= x 0) (< x config/stage-cols)))

(defn find-connected
  "æ·±ã•å„ªå…ˆæ¢ç´¢ã§åŒã˜è‰²ã®ã·ã‚ˆã‚’æ¢ç´¢"
  ([field y x]
   (find-connected field y x (get-in field [y x]) #{}))
  ([field y x target-color visited]
   (if (or (not (in-bounds? y x))
           (contains? visited [y x])
           (not= (get-in field [y x]) target-color)
           (zero? target-color))
     visited
     (let [visited' (conj visited [y x])]
       (reduce
        (fn [acc [ny nx]]
          (find-connected field ny nx target-color acc))
        visited'
        (get-neighbors y x))))))

(defn find-erasable-groups
  "æ¶ˆå»å¯èƒ½ãªã‚°ãƒ«ãƒ¼ãƒ—ã‚’å…¨ã¦è¦‹ã¤ã‘ã‚‹"
  [field]
  (let [all-positions (for [y (range config/stage-rows)
                            x (range config/stage-cols)
                            :when (pos? (get-in field [y x]))]
                        [y x])]
    (->> all-positions
         (reduce
          (fn [{:keys [visited groups]} [y x]]
            (if (contains? visited [y x])
              {:visited visited :groups groups}
              (let [group (find-connected field y x)]
                (if (>= (count group) 4)
                  {:visited (into visited group)
                   :groups (conj groups group)}
                  {:visited (into visited group)
                   :groups groups}))))
          {:visited #{} :groups []})
         :groups)))

(defn erase-puyos
  "ã·ã‚ˆã‚’æ¶ˆå»ã™ã‚‹"
  [field groups]
  (reduce
   (fn [f group]
     (reduce
      (fn [field' [y x]]
        (assoc-in field' [y x] 0))
      f
      group))
   field
   groups))
```

ã€Œå†å¸°ã‚’ä½¿ã£ã¦ã„ã‚‹ã‚“ã§ã™ã­ï¼ã€ãã†ã§ã™ï¼ClojureScriptã®ç‰¹å¾´ã‚’æ´»ã‹ã—ãŸå®Ÿè£…ã§ã™ï¼š

1. **reduce ã«ã‚ˆã‚‹çŠ¶æ…‹ç®¡ç†**: visited ã¨ groups ã‚’ accumulator ã§ç®¡ç†
2. **set ã«ã‚ˆã‚‹é«˜é€Ÿãªå­˜åœ¨ãƒã‚§ãƒƒã‚¯**: `contains?` ã§è¨ªå•æ¸ˆã¿ã‚’åˆ¤å®š
3. **->> ãƒã‚¯ãƒ­**: ãƒ‡ãƒ¼ã‚¿å¤‰æ›ã®æµã‚Œã‚’æ˜ç¢ºã«
4. **ä¸å¤‰æ€§**: å…ƒã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å¤‰æ›´ã›ãšã€æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿”ã™

### å®Ÿè£…: ã·ã‚ˆã®è½ä¸‹å‡¦ç†

æ¶ˆå»å¾Œã€ç©ºã„ãŸã‚¹ãƒšãƒ¼ã‚¹ã«ã·ã‚ˆã‚’è½ã¨ã—ã¾ã™ï¼š

```clojure
;; src/puyo/erase.cljsï¼ˆç¶šãï¼‰
(defn apply-gravity
  "é‡åŠ›ã‚’é©ç”¨ã—ã¦ã·ã‚ˆã‚’è½ã¨ã™"
  [field]
  (let [cols config/stage-cols
        rows config/stage-rows]
    (reduce
     (fn [f x]
       (let [col (map #(get-in f [% x]) (range rows))
             non-zero (filter pos? col)
             zeros (repeat (- rows (count non-zero)) 0)
             new-col (vec (concat zeros non-zero))]
         (reduce
          (fn [field' y]
            (assoc-in field' [y x] (nth new-col y)))
          f
          (range rows))))
     field
     (range cols))))
```

ã€Œç¸¦ã®åˆ—ã”ã¨ã«å‡¦ç†ã—ã¦ã„ã‚‹ã‚“ã§ã™ã­ï¼ã€ãã†ã§ã™ï¼å„åˆ—ã«ã¤ã„ã¦ï¼š
1. 0 ä»¥å¤–ã®ã·ã‚ˆã‚’é›†ã‚ã‚‹
2. å¿…è¦ãªæ•°ã® 0 ã‚’ä¸Šã«è¿½åŠ 
3. æ–°ã—ã„åˆ—ã§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°

### ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã¸ã®çµ±åˆ

```clojure
;; src/puyo/core.cljsï¼ˆæ›´æ–°ï¼‰
(defn update-game
  "ã‚²ãƒ¼ãƒ ã‚’æ›´æ–°ã™ã‚‹"
  []
  (swap! game-state update :frame inc)

  (case (:mode @game-state)
    :new-puyo
    (do
      (swap! game-state assoc :puyo (player/create-puyo))
      (swap! game-state assoc :mode :playing))

    :playing
    (let [config (config/get-config)
          updated-puyo (player/update-puyo
                        (:puyo @game-state)
                        (:input-state @game-state)
                        config)]
      (swap! game-state assoc :puyo updated-puyo))

    :check-erase
    (let [groups (erase/find-erasable-groups (:field @game-state))]
      (if (seq groups)
        (do
          (swap! game-state update :field erase/erase-puyos groups)
          (swap! game-state assoc :mode :apply-gravity))
        (swap! game-state assoc :mode :new-puyo)))

    :apply-gravity
    (do
      (swap! game-state update :field erase/apply-gravity)
      (swap! game-state assoc :mode :check-erase))

    nil))
```

### ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³4ã®ã¾ã¨ã‚

1. **æ·±ã•å„ªå…ˆæ¢ç´¢ã®å®Ÿè£…**
   - å†å¸°ã«ã‚ˆã‚‹ connected component ã®æ¢ç´¢
   - set ã‚’ä½¿ã£ãŸè¨ªå•æ¸ˆã¿ç®¡ç†
   - reduce ã«ã‚ˆã‚‹çŠ¶æ…‹ã® accumulation

2. **æ¶ˆå»å‡¦ç†**
   - ä¸å¤‰ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æ´»ã‹ã—ãŸå®Ÿè£…
   - assoc-in ã«ã‚ˆã‚‹å±€æ‰€çš„ãªæ›´æ–°

3. **é‡åŠ›å‡¦ç†**
   - åˆ—ã”ã¨ã®å‡¦ç†ã§åŠ¹ç‡çš„ã«å®Ÿè£…
   - filter ã¨ concat ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿å¤‰æ›

4. **çŠ¶æ…‹ãƒã‚·ãƒ³**
   - :check-erase â†’ :apply-gravity â†’ :check-erase ã®ãƒ«ãƒ¼ãƒ—
   - case å¼ã«ã‚ˆã‚‹çŠ¶æ…‹é·ç§»ã®æ˜ç¢ºåŒ–

### clojure.spec: æ¶ˆå»é–¢æ•°ã¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ“ä½œã®ä»•æ§˜

ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³4ã§ã¯ã€æ·±ã•å„ªå…ˆæ¢ç´¢ã«ã‚ˆã‚‹æ¶ˆå»å‡¦ç†ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚ã“ã‚Œã‚‰ã®é–¢æ•°ã®ä»•æ§˜ã‚’å®šç¾©ã—ã¾ã—ã‚‡ã†ã€‚

```clojure
;; src/puyo/specs.cljsï¼ˆè¿½åŠ ï¼‰

;; åº§æ¨™ã®ãƒšã‚¢
(s/def ::position (s/tuple ::y ::x))

;; åº§æ¨™ã®ã‚»ãƒƒãƒˆï¼ˆconnected componentï¼‰
(s/def ::connected-group (s/coll-of ::position :kind set? :min-count 1))

;; æ¶ˆå»å¯èƒ½ãªã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
(s/def ::erasable-groups (s/coll-of ::connected-group :kind vector?))
```

```clojure
;; src/puyo/erase.cljsï¼ˆspec ã‚’è¿½åŠ ï¼‰
(ns puyo.erase
  (:require [cljs.spec.alpha :as s]
            [puyo.specs :as specs]))

;; find-connected ã®ä»•æ§˜
(s/fdef find-connected
  :args (s/alt :simple (s/cat :field ::specs/field
                              :y ::specs/y
                              :x ::specs/x)
               :full (s/cat :field ::specs/field
                            :y ::specs/y
                            :x ::specs/x
                            :target-color ::specs/cell
                            :visited ::specs/connected-group))
  :ret ::specs/connected-group
  :fn (fn [{:keys [ret]}]
        ;; è¿”ã‚Šå€¤ã¯ç©ºã§ãªã„ã‚»ãƒƒãƒˆ
        (pos? (count ret))))

;; find-erasable-groups ã®ä»•æ§˜
(s/fdef find-erasable-groups
  :args (s/cat :field ::specs/field)
  :ret ::specs/erasable-groups
  :fn (fn [{:keys [ret]}]
        ;; ã™ã¹ã¦ã®ã‚°ãƒ«ãƒ¼ãƒ—ãŒ4å€‹ä»¥ä¸Š
        (every? #(>= (count %) 4) ret)))

;; erase-puyos ã®ä»•æ§˜
(s/fdef erase-puyos
  :args (s/cat :field ::specs/field
               :groups ::specs/erasable-groups)
  :ret ::specs/field)

;; apply-gravity ã®ä»•æ§˜
(s/fdef apply-gravity
  :args (s/cat :field ::specs/field)
  :ret ::specs/field
  :fn (fn [{:keys [args ret]}]
        ;; ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ç·ã·ã‚ˆæ•°ã¯å¤‰ã‚ã‚‰ãªã„
        (let [count-puyos (fn [field]
                           (count (filter pos? (flatten field))))]
          (= (count-puyos (:field args))
             (count-puyos ret)))))
```

ã€Œ`:fn` ã§é‡åŠ›å‡¦ç†ã®æ€§è³ªã‚’å®šç¾©ã—ã¦ã„ã‚‹ã‚“ã§ã™ã­ï¼ã€ãã†ã§ã™ï¼`apply-gravity` ã¯ã€Œã·ã‚ˆã®ç·æ•°ã‚’å¤‰ãˆãšã€ä½ç½®ã ã‘ã‚’å¤‰ãˆã‚‹ã€ã¨ã„ã†ä¸å¤‰æ¡ä»¶ã‚’æŒã£ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚’ spec ã§è¡¨ç¾ã™ã‚‹ã“ã¨ã§ã€å®Ÿè£…ã®ãƒã‚°ã‚’æ—©æœŸç™ºè¦‹ã§ãã¾ã™ã€‚

#### ã‚«ã‚¹ã‚¿ãƒ ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿

æ¶ˆå»å¯èƒ½ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ã‚’å®šç¾©ã—ã¾ã™ï¼š

```clojure
;; src/puyo/specs.cljsï¼ˆã‚«ã‚¹ã‚¿ãƒ ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼‰
(ns puyo.specs
  (:require [cljs.spec.alpha :as s]
            [cljs.spec.gen.alpha :as gen]
            [puyo.config :as config]))

(defn gen-erasable-field
  "4å€‹ä»¥ä¸Šé€£çµã—ãŸã·ã‚ˆã‚’å«ã‚€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç”Ÿæˆ"
  []
  (gen/fmap
   (fn [_]
     (let [color (inc (rand-int 4))
           ;; 4å€‹ã®ã·ã‚ˆã‚’é€£çµé…ç½®
           positions [[0 0] [0 1] [1 0] [1 1]]
           base-field (vec (repeat config/stage-rows
                                   (vec (repeat config/stage-cols 0))))]
       (reduce
        (fn [field [y x]]
          (assoc-in field [y x] color))
        base-field
        positions)))
   (gen/return nil)))

(s/def ::erasable-field
  (s/with-gen ::field gen-erasable-field))
```

#### ç”Ÿæˆçš„ãƒ†ã‚¹ãƒˆ

```clojure
;; test/puyo/erase_test.cljsï¼ˆç”Ÿæˆçš„ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ï¼‰
(deftest æ¶ˆå»é–¢æ•°ã®ç”Ÿæˆçš„ãƒ†ã‚¹ãƒˆ
  (testing "eraseé–¢æ•°ãŒä»•æ§˜ã‚’æº€ãŸã™"
    (let [results (stest/check `[erase/find-connected
                                 erase/find-erasable-groups
                                 erase/erase-puyos
                                 erase/apply-gravity]
                                {:clojure.spec.test.check/opts
                                 {:num-tests 50}})]
      (doseq [result results]
        (is (nil? (-> result :clojure.spec.test.check/ret :result))
            (str "ç”Ÿæˆçš„ãƒ†ã‚¹ãƒˆå¤±æ•—: " (-> result :sym)))))))
```

ã€Œã‚«ã‚¹ã‚¿ãƒ ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ã‚’ä½¿ã†ã“ã¨ã§ã€ç¾å®Ÿçš„ãªãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ç”Ÿæˆã§ãã‚‹ã‚“ã§ã™ã­ï¼ã€ãã†ã§ã™ï¼ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã¯ãªãã€å®Ÿéš›ã«æ¶ˆå»å¯èƒ½ãªçŠ¶æ…‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šæ„å‘³ã®ã‚ã‚‹ãƒ†ã‚¹ãƒˆãŒã§ãã¾ã™ã€‚

## ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³5: é€£é–åå¿œ

ã€Œã·ã‚ˆãŒæ¶ˆãˆã‚‹ã‚ˆã†ã«ãªã£ãŸã‘ã©ã€é€£é–ãŒãªã„ã¨ã·ã‚ˆã·ã‚ˆã˜ã‚ƒãªã„ã§ã™ã‚ˆã­ï¼ã€ãã†ã§ã™ã­ï¼é€£é–ã¯ã€ã·ã‚ˆã‚’æ¶ˆã—ãŸå¾Œã«ä¸Šã‹ã‚‰è½ã¡ã¦ããŸã·ã‚ˆãŒæ–°ãŸãªã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œã£ã¦æ¶ˆãˆã‚‹ç¾è±¡ã§ã™ã€‚ã“ã‚ŒãŒã·ã‚ˆã·ã‚ˆã®æœ€å¤§ã®é­…åŠ›ã§ã™ã­ã€‚

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼

> ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ã€é€£é–åå¿œã‚’èµ·ã“ã—ã¦ã‚ˆã‚Šé«˜ã„ã‚¹ã‚³ã‚¢ã‚’ç²å¾—ã§ãã‚‹

### å®Ÿè£…: é€£é–ã‚«ã‚¦ãƒ³ãƒˆ

é€£é–æ•°ã‚’è¿½è·¡ã—ã€ã‚¹ã‚³ã‚¢ã«åæ˜ ã—ã¾ã™ï¼š

```clojure
;; src/puyo/score.cljs
(ns puyo.score)

(def chain-bonus
  "é€£é–ãƒœãƒ¼ãƒŠã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«"
  [0 8 16 32 64 96 128 160 192 224 256])

(defn calculate-score
  "ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—"
  [erased-count chain-count]
  (let [chain-idx (min chain-count (dec (count chain-bonus)))
        bonus (nth chain-bonus chain-idx)]
    (* erased-count 10 (max 1 (+ 1 bonus)))))

;; src/puyo/core.cljsï¼ˆæ›´æ–°ï¼‰
(defn update-game
  "ã‚²ãƒ¼ãƒ ã‚’æ›´æ–°ã™ã‚‹"
  []
  (swap! game-state update :frame inc)

  (case (:mode @game-state)
    ;; ...

    :check-erase
    (let [groups (erase/find-erasable-groups (:field @game-state))]
      (if (seq groups)
        (let [erased-count (reduce + (map count groups))
              chain-count (inc (:chain-count @game-state))
              points (score/calculate-score erased-count chain-count)]
          (swap! game-state update :field erase/erase-puyos groups)
          (swap! game-state update :score + points)
          (swap! game-state assoc :chain-count chain-count)
          (swap! game-state assoc :mode :apply-gravity))
        (do
          (swap! game-state assoc :chain-count 0)
          (swap! game-state assoc :mode :new-puyo))))

    ;; ...
    ))
```

### ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³5ã®ã¾ã¨ã‚

1. **é€£é–ã‚«ã‚¦ãƒ³ãƒˆ**: é€£ç¶šã—ã¦æ¶ˆãˆãŸå›æ•°ã‚’è¿½è·¡
2. **ãƒœãƒ¼ãƒŠã‚¹è¨ˆç®—**: é€£é–æ•°ã«å¿œã˜ãŸæŒ‡æ•°çš„ãªã‚¹ã‚³ã‚¢å¢—åŠ 
3. **çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ**: é€£é–ãŒé€”åˆ‡ã‚ŒãŸã‚‰ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ

### clojure.spec: ã‚¹ã‚³ã‚¢è¨ˆç®—ã®ä»•æ§˜

ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³5ã§ã¯ã€ã‚¹ã‚³ã‚¢è¨ˆç®—æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚ã‚¹ã‚³ã‚¢é–¢é€£ã®ä»•æ§˜ã‚’å®šç¾©ã—ã¾ã—ã‚‡ã†ã€‚

```clojure
;; src/puyo/specs.cljsï¼ˆè¿½åŠ ï¼‰

;; ã‚¹ã‚³ã‚¢
(s/def ::score nat-int?)

;; é€£é–æ•°
(s/def ::chain-count nat-int?)

;; æ¶ˆå»ã·ã‚ˆæ•°
(s/def ::erased-count pos-int?)
```

```clojure
;; src/puyo/score.cljsï¼ˆspec ã‚’è¿½åŠ ï¼‰
(ns puyo.score
  (:require [cljs.spec.alpha :as s]
            [puyo.specs :as specs]))

;; calculate-score ã®ä»•æ§˜
(s/fdef calculate-score
  :args (s/cat :erased-count ::specs/erased-count
               :chain-count ::specs/chain-count)
  :ret ::specs/score
  :fn (fn [{:keys [args ret]}]
        ;; ã‚¹ã‚³ã‚¢ã¯æ¶ˆå»æ•°ã«æ¯”ä¾‹ã™ã‚‹
        (>= ret (* (:erased-count args) 10))))

;; all-cleared? ã®ä»•æ§˜
(s/fdef all-cleared?
  :args (s/cat :field ::specs/field)
  :ret boolean?)
```

ã€Œã‚¹ã‚³ã‚¢è¨ˆç®—ã®ä¸å¤‰æ¡ä»¶ã‚’å®šç¾©ã—ã¦ã„ã‚‹ã‚“ã§ã™ã­ï¼ã€ãã†ã§ã™ï¼`calculate-score` ã¯ã€Œã‚¹ã‚³ã‚¢ã¯å°‘ãªãã¨ã‚‚æ¶ˆå»æ•°Ã—10ä»¥ä¸Šã€ã¨ã„ã†æ€§è³ªã‚’æŒã£ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚’ spec ã§è¡¨ç¾ã™ã‚‹ã“ã¨ã§ã€ã‚¹ã‚³ã‚¢è¨ˆç®—ã®ãƒã‚°ã‚’é˜²ã’ã¾ã™ã€‚

#### ç”Ÿæˆçš„ãƒ†ã‚¹ãƒˆ

```clojure
;; test/puyo/score_test.cljsï¼ˆç”Ÿæˆçš„ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ï¼‰
(ns puyo.score-test
  (:require [cljs.test :refer-macros [deftest is testing]]
            [cljs.spec.alpha :as s]
            [cljs.spec.test.alpha :as stest]
            [puyo.score :as score]
            [puyo.specs :as specs]))

(deftest ã‚¹ã‚³ã‚¢è¨ˆç®—ã®ç”Ÿæˆçš„ãƒ†ã‚¹ãƒˆ
  (testing "calculate-score ãŒä»•æ§˜ã‚’æº€ãŸã™"
    (let [results (stest/check `[score/calculate-score
                                 score/all-cleared?]
                                {:clojure.spec.test.check/opts
                                 {:num-tests 100}})]
      (doseq [result results]
        (is (nil? (-> result :clojure.spec.test.check/ret :result))
            (str "ç”Ÿæˆçš„ãƒ†ã‚¹ãƒˆå¤±æ•—: " (-> result :sym)))))))

(deftest ã‚¹ã‚³ã‚¢è¨ˆç®—ã®æ€§è³ªãƒ†ã‚¹ãƒˆ
  (testing "é€£é–æ•°ãŒå¢—ãˆã‚‹ã¨ã‚¹ã‚³ã‚¢ãŒæŒ‡æ•°çš„ã«å¢—åŠ ã™ã‚‹"
    (let [base-score (score/calculate-score 4 1)
          chain2-score (score/calculate-score 4 2)
          chain3-score (score/calculate-score 4 3)]
      (is (> chain2-score (* base-score 1.5))
          "2é€£é–ã¯1é€£é–ã®1.5å€ä»¥ä¸Š")
      (is (> chain3-score (* chain2-score 1.5))
          "3é€£é–ã¯2é€£é–ã®1.5å€ä»¥ä¸Š"))))
```

ã€Œæ€§è³ªãƒ™ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆã‚‚æ›¸ã„ã¦ã„ã‚‹ã‚“ã§ã™ã­ï¼ã€ãã†ã§ã™ï¼ç”Ÿæˆçš„ãƒ†ã‚¹ãƒˆã«åŠ ãˆã¦ã€ã€Œé€£é–æ•°ãŒå¢—ãˆã‚‹ã¨ã‚¹ã‚³ã‚¢ãŒæŒ‡æ•°çš„ã«å¢—åŠ ã™ã‚‹ã€ã¨ã„ã†æ€§è³ªã‚’æ˜ç¤ºçš„ã«ãƒ†ã‚¹ãƒˆã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¹ã‚³ã‚¢è¨ˆç®—ã®æ„å›³ãŒæ˜ç¢ºã«ãªã‚Šã¾ã™ã€‚

## ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³6: ç‰¹æ®Šæ©Ÿèƒ½

### å…¨æ¶ˆã—ãƒœãƒ¼ãƒŠã‚¹

```clojure
;; src/puyo/score.cljsï¼ˆè¿½åŠ ï¼‰
(defn all-cleared?
  "ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒç©ºã‹ãƒã‚§ãƒƒã‚¯"
  [field]
  (every? zero? (flatten field)))

(def zenkeshi-bonus 2100)

;; src/puyo/core.cljsï¼ˆæ›´æ–°ï¼‰
:check-erase
(let [groups (erase/find-erasable-groups (:field @game-state))]
  (if (seq groups)
    (let [erased-count (reduce + (map count groups))
          chain-count (inc (:chain-count @game-state))
          points (score/calculate-score erased-count chain-count)
          new-field (erase/erase-puyos (:field @game-state) groups)
          all-clear (score/all-cleared? new-field)
          total-points (if all-clear
                        (+ points score/zenkeshi-bonus)
                        points)]
      (swap! game-state assoc :field new-field)
      (swap! game-state update :score + total-points)
      (swap! game-state assoc :chain-count chain-count)
      (swap! game-state assoc :mode :apply-gravity))
    ;; ...
    ))
```

### ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®š

```clojure
;; src/puyo/core.cljsï¼ˆæ›´æ–°ï¼‰
:new-puyo
(let [new-puyo (player/create-puyo)
      can-place (every? zero? (map #(get-in (:field @game-state) %)
                                   [[0 2] [0 3]]))]
  (if can-place
    (do
      (swap! game-state assoc :puyo new-puyo)
      (swap! game-state assoc :mode :playing))
    (swap! game-state assoc :mode :game-over)))

:game-over
nil  ; ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼çŠ¶æ…‹ã‚’ç¶­æŒ
```

## ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³7: ã‚¿ãƒƒãƒæ“ä½œ

### ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†

```clojure
;; src/puyo/player.cljsï¼ˆè¿½åŠ ï¼‰
(defn setup-touch-events
  "ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹"
  [input-state]
  (let [canvas (.getElementById js/document "stage")]
    (.addEventListener canvas "touchstart"
                       (fn [e]
                         (.preventDefault e)
                         (let [touch (aget (.-touches e) 0)
                               x (.-clientX touch)
                               rect (.getBoundingClientRect canvas)
                               relative-x (- x (.-left rect))
                               canvas-width (.-width canvas)]
                           (cond
                             (< relative-x (/ canvas-width 3))
                             (reset! (:left input-state) true)

                             (> relative-x (* 2 (/ canvas-width 3)))
                             (reset! (:right input-state) true)

                             :else
                             (reset! (:up input-state) true)))))

    (.addEventListener canvas "touchend"
                       (fn [e]
                         (.preventDefault e)
                         (reset! (:left input-state) false)
                         (reset! (:right input-state) false)
                         (reset! (:up input-state) false)))))

;; src/puyo/core.cljsï¼ˆæ›´æ–°ï¼‰
(defn initialize
  "ã‚²ãƒ¼ãƒ ã‚’åˆæœŸåŒ–ã™ã‚‹"
  []
  (let [canvas-ctx (stage/setup-canvas)]
    (reset! game-state
            {:mode :new-puyo
             :frame 0
             :field (stage/create-field)
             :puyo nil
             :input-state (player/create-input-state)
             :canvas-ctx canvas-ctx
             :score 0
             :chain-count 0}))

  ;; ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  (player/setup-keyboard-events (:input-state @game-state))
  (player/setup-touch-events (:input-state @game-state)))
```

### ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³7ã®ã¾ã¨ã‚

1. **ã‚¿ãƒƒãƒé ˜åŸŸã®åˆ†å‰²**: ç”»é¢ã‚’3åˆ†å‰²ï¼ˆå·¦ãƒ»ä¸­å¤®ãƒ»å³ï¼‰
2. **ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†**: touchstart/touchend ã§å…¥åŠ›çŠ¶æ…‹ã‚’æ›´æ–°
3. **æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨ã®çµ±åˆ**: å…¥åŠ›çŠ¶æ…‹ã®çµ±ä¸€ã«ã‚ˆã‚Šæ—¢å­˜ã®ç§»å‹•ãƒ»å›è»¢å‡¦ç†ãŒãã®ã¾ã¾å‹•ä½œ

## ã¾ã¨ã‚

æœ¬ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ã€ClojureScript ã¨ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã‚’ä½¿ã£ã¦ã€ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

### ClojureScript ã®ç‰¹å¾´ã‚’æ´»ã‹ã—ãŸå®Ÿè£…

1. **ä¸å¤‰ãƒ‡ãƒ¼ã‚¿æ§‹é€ **
   - ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ä¸å¤‰ã®ãƒãƒƒãƒ—ã§ç®¡ç†
   - çŠ¶æ…‹é·ç§»ãŒæ˜ç¢ºã§äºˆæ¸¬å¯èƒ½
   - ã‚¿ã‚¤ãƒ ãƒˆãƒ©ãƒ™ãƒ«ãƒ‡ãƒãƒƒã‚°ãŒå®¹æ˜“

2. **ç´”ç²‹é–¢æ•°**
   - å‰¯ä½œç”¨ã®ãªã„é–¢æ•°ã«ã‚ˆã‚‹ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…
   - ãƒ†ã‚¹ãƒˆãŒå®¹æ˜“ã§ä¿¡é ¼æ€§ãŒé«˜ã„
   - é–¢æ•°åˆæˆã«ã‚ˆã‚‹æŸ”è»Ÿãªè¨­è¨ˆ

3. **é«˜éšé–¢æ•°ã¨ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£**
   - é–¢æ•°ã‚’å¼•æ•°ãƒ»æˆ»ã‚Šå€¤ã¨ã—ã¦æ‰±ã†
   - ã‚³ãƒ¼ãƒ‰ã®å†åˆ©ç”¨æ€§ãŒé«˜ã„
   - æŠ½è±¡åº¦ã®é«˜ã„è¨­è¨ˆ

4. **å¼·åŠ›ãªã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æ“ä½œ**
   - reduceã€filterã€map ã«ã‚ˆã‚‹å®£è¨€çš„ãªãƒ‡ãƒ¼ã‚¿å‡¦ç†
   - ->> ãƒã‚¯ãƒ­ã«ã‚ˆã‚‹å‡¦ç†ã®é€£é–
   - ã‚·ãƒ¼ã‚±ãƒ³ã‚¹æŠ½è±¡ã«ã‚ˆã‚‹åŠ¹ç‡çš„ãªå‡¦ç†

5. **REPL é§†å‹•é–‹ç™º**
   - å¯¾è©±çš„ãªé–‹ç™ºã«ã‚ˆã‚Šå³åº§ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
   - é–¢æ•°å˜ä½ã§ã®å‹•ä½œç¢ºèª
   - æ¢ç´¢çš„ãªãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°

### ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®å®Ÿè·µ

- **Red-Green-Refactor ã‚µã‚¤ã‚¯ãƒ«**: å„æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã§å®Ÿè£…
- **å°ã•ãªã‚¹ãƒ†ãƒƒãƒ—**: ä¸€åº¦ã«ä¸€ã¤ã®æ©Ÿèƒ½ã‚’ç€å®Ÿã«å®Ÿè£…
- **ç¶™ç¶šçš„ãªãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°**: ãƒ†ã‚¹ãƒˆã«ã‚ˆã‚‹å®‰å…¨ç¶²ã®ã‚‚ã¨ã§ã‚³ãƒ¼ãƒ‰æ”¹å–„

### å®Œæˆã—ãŸã‚²ãƒ¼ãƒ ã®æ©Ÿèƒ½

1. ã·ã‚ˆã®åŸºæœ¬æ“ä½œï¼ˆç§»å‹•ãƒ»å›è»¢ï¼‰
2. å£ã‚­ãƒƒã‚¯ã«ã‚ˆã‚‹æ“ä½œæ€§å‘ä¸Š
3. ã·ã‚ˆã®æ¶ˆå»åˆ¤å®šï¼ˆæ·±ã•å„ªå…ˆæ¢ç´¢ï¼‰
4. é€£é–åå¿œã¨ã‚¹ã‚³ã‚¢è¨ˆç®—
5. å…¨æ¶ˆã—ãƒœãƒ¼ãƒŠã‚¹
6. ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®š
7. ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ»ã‚¿ãƒƒãƒæ“ä½œå¯¾å¿œ

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

ã“ã®åŸºç›¤ã‚’æ´»ç”¨ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ‹¡å¼µãŒå¯èƒ½ã§ã™ï¼š

1. **ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«å¼·åŒ–**
   - ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ
   - ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
   - ã‚µã‚¦ãƒ³ãƒ‰å¯¾å¿œ

2. **ã‚²ãƒ¼ãƒ æ©Ÿèƒ½æ‹¡å¼µ**
   - ãŠã˜ã‚ƒã¾ã·ã‚ˆ
   - å¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰
   - ãƒ¬ãƒ™ãƒ«ã‚·ã‚¹ãƒ†ãƒ 

3. **æŠ€è¡“çš„æ”¹å–„**
   - re-frame ã«ã‚ˆã‚‹çŠ¶æ…‹ç®¡ç†
   - core.async ã«ã‚ˆã‚‹éåŒæœŸå‡¦ç†
   - spec ã«ã‚ˆã‚‹å‹ãƒã‚§ãƒƒã‚¯

### å‚è€ƒè³‡æ–™

- [ClojureScript å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://clojurescript.org/)
- [shadow-cljs å…¬å¼ã‚¬ã‚¤ãƒ‰](https://shadow-cljs.github.io/docs/UsersGuide.html)
- Kent Beckã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã€
- Rich Hickeyã€ŒSimple Made Easyã€

ClojureScript ã®é–¢æ•°å‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã¨ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€ä¿å®ˆæ€§ãŒé«˜ãã€æ‹¡å¼µã—ã‚„ã™ã„ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã“ã¨ãŒã§ãã¾ã—ãŸã€‚ã“ã®çŸ¥è­˜ã‚’æ´»ã‹ã—ã¦ã€ã•ã‚‰ã«é«˜åº¦ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã«æŒ‘æˆ¦ã—ã¦ã¿ã¦ãã ã•ã„ï¼

