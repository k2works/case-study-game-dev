---
title: ã·ã‚ˆã·ã‚ˆã‹ã‚‰å§‹ã‚ã‚‹ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™º (Elixir Phoenix LiveViewç‰ˆ)
description: ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®æ‰‹æ³•ã‚’ç”¨ã„ã¦Phoenix LiveViewã§ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ ã‚’å®Ÿè£…ã™ã‚‹éç¨‹ã‚’è§£èª¬
published: true
date: 2025-10-14T00:00:00.000Z
tags: tdd, elixir, phoenix, liveview, ã·ã‚ˆã·ã‚ˆ
editor: markdown
dateCreated: 2025-10-14T00:00:00.000Z
---

# ã·ã‚ˆã·ã‚ˆã‹ã‚‰å§‹ã‚ã‚‹ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™º (Elixir Phoenix LiveViewç‰ˆ)

## ã¯ã˜ã‚ã«

ã¿ãªã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ï¼ä»Šæ—¥ã¯ç§ã¨ä¸€ç·’ã«ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºï¼ˆTDDï¼‰ã‚’ä½¿ã£ã¦ã€Elixir Phoenix LiveViewã§ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ ã‚’ä½œã£ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

> ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã¨ã¯ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®æ‰‹æ³•ã®ä¸€ç¨®ã§ã€ã€Œãƒ†ã‚¹ãƒˆãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã€ã®åŸå‰‡ã«å¾“ã„ã€å®Ÿè£…å‰ã«ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã“ã¨ã§ã€ã‚³ãƒ¼ãƒ‰ã®å“è³ªã‚’é«˜ã‚ã€è¨­è¨ˆã‚’æ”¹å–„ã—ã¦ã„ãé–‹ç™ºæ‰‹æ³•ã§ã™ã€‚
>
> â€” Kent Beck ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã€

ã“ã®è¨˜äº‹ã§ã¯ã€ç§ãŸã¡ãŒä¸€ç·’ã«ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ ã‚’å®Ÿè£…ã—ãªãŒã‚‰ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®åŸºæœ¬çš„ãªæµã‚Œã¨è€ƒãˆæ–¹ã€ãã—ã¦Phoenix LiveViewã®å¼·åŠ›ãªæ©Ÿèƒ½ã‚’å­¦ã‚“ã§ã„ãã¾ã™ã€‚

### ãªãœPhoenix LiveViewãªã®ã‹ï¼Ÿ

Phoenix LiveViewã¯ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã€JavaScriptã‚’ã»ã¨ã‚“ã©æ›¸ã‹ãšã«å®Ÿè£…ã§ãã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚ä»¥ä¸‹ã®ç‰¹å¾´ãŒã‚ã‚Šã¾ã™ï¼š

- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§**: WebSocketã‚’ä½¿ã£ãŸåŒæ–¹å‘é€šä¿¡
- **ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°**: ã‚µãƒ¼ãƒãƒ¼å´ã§HTMLã‚’ç”Ÿæˆã—ã€å·®åˆ†ã®ã¿ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€ä¿¡
- **çŠ¶æ…‹ç®¡ç†ã®ç°¡æ½”ã•**: ã‚µãƒ¼ãƒãƒ¼å´ã§çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®è¤‡é›‘ãªçŠ¶æ…‹ç®¡ç†ãŒä¸è¦
- **é«˜ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: Elixirã®ä¸¦è¡Œå‡¦ç†ã¨Erlang VMã®åŠ›
- **ãƒ†ã‚¹ãƒˆã®ã—ã‚„ã™ã•**: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ã¨ã—ã¦çµ±ä¸€çš„ã«ãƒ†ã‚¹ãƒˆå¯èƒ½

ã·ã‚ˆã·ã‚ˆã®ã‚ˆã†ãªã‚²ãƒ¼ãƒ ã¯ã€çŠ¶æ…‹ã®æ›´æ–°ãŒé »ç¹ã«ç™ºç”Ÿã—ã¾ã™ã€‚LiveViewã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ã¨çŠ¶æ…‹ç®¡ç†ã®ç°¡æ½”ã•ã¯ã€ã“ã®ã‚ˆã†ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«æœ€é©ã§ã™ã€‚

### ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®ã‚µã‚¤ã‚¯ãƒ«

ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã§ã¯ã€ä»¥ä¸‹ã®3ã¤ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ç¹°ã‚Šè¿”ã™ã‚µã‚¤ã‚¯ãƒ«ã§é–‹ç™ºã‚’é€²ã‚ã¾ã™ï¼š

1. **Redï¼ˆèµ¤ï¼‰**: ã¾ãšå¤±æ•—ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã¾ã™
2. **Greenï¼ˆç·‘ï¼‰**: ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã‚ˆã†ã«ã€æœ€å°é™ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã—ã¾ã™
3. **Refactorï¼ˆãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼‰**: ã‚³ãƒ¼ãƒ‰ã®å“è³ªã‚’æ”¹å–„ã—ã¾ã™

> ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®ãƒªã‚ºãƒ ï¼šèµ¤ã€ç·‘ã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã€‚ã¾ãšå¤±æ•—ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’æ›¸ãï¼ˆèµ¤ï¼‰ã€æ¬¡ã«ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼ˆç·‘ï¼‰ã€ãã—ã¦é‡è¤‡ã‚’é™¤å»ã™ã‚‹ï¼ˆãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼‰ã€‚
>
> â€” Kent Beck ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã€

```plantuml
@startuml
[*] --> ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨ãƒ†ã‚¹ãƒˆ
ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨ãƒ†ã‚¹ãƒˆ --> TODO : TODOãƒªã‚¹ãƒˆã‚’ä½œæˆ
TODO --> Red : ãƒ†ã‚¹ãƒˆã‚’æ›¸ã
Red --> Green : æœ€å°é™ã®å®Ÿè£…
Green --> Refactor : ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
Refactor --> Red : æ¬¡ã®ãƒ†ã‚¹ãƒˆã‚’æ›¸ã
Red : ãƒ†ã‚¹ãƒˆã«å¤±æ•—
Green : ãƒ†ã‚¹ãƒˆã«é€šã‚‹æœ€å°é™ã®å®Ÿè£…
Refactor : ã‚³ãƒ¼ãƒ‰ã®é‡è¤‡ã‚’é™¤å»ã—ã¦ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
Refactor --> TODO : ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ãŒå®Œäº†ã—ãŸã‚‰TODOãƒªã‚¹ãƒˆã«æˆ»ã‚‹
TODO --> ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨ãƒ†ã‚¹ãƒˆ : TODOãƒªã‚¹ãƒˆãŒç©ºã«ãªã‚‹ã¾ã§ç¹°ã‚Šè¿”ã™
ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨ãƒ†ã‚¹ãƒˆ --> ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒ“ãƒ¥ãƒ¼
@enduml
```

## ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³0: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã‚’å§‹ã‚ã‚‹å‰ã«ã€ã¾ãšé–‹ç™ºç’°å¢ƒã‚’æ•´ãˆã¾ã—ã‚‡ã†ã€‚ã“ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€Phoenix LiveViewãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã€é–‹ç™ºã«å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã‚’æº–å‚™ã—ã¾ã™ã€‚

### å‰ææ¡ä»¶

ä»¥ä¸‹ã®ãƒ„ãƒ¼ãƒ«ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

- **Elixir 1.14ä»¥ä¸Š**: `elixir --version`ã§ç¢ºèª
- **Erlang/OTP 25ä»¥ä¸Š**: `erl -version`ã§ç¢ºèª
- **PostgreSQL**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã—ã¦ä½¿ç”¨ï¼ˆé–‹ç™ºç”¨ï¼‰
- **Node.js**: ã‚¢ã‚»ãƒƒãƒˆç®¡ç†ã«ä½¿ç”¨

### ã‚¹ãƒ†ãƒƒãƒ—1: Phoenixãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

ã¾ãšã€Phoenix Frameworkã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ï¼š

```bash
# Phoenixã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
mix archive.install hex phx_new
```

æ¬¡ã«ã€æ–°ã—ã„Phoenixãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ï¼š

```bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
mix phx.new puyo_puyo --live

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd puyo_puyo

# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
mix deps.get

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
mix ecto.setup
```

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®èª¬æ˜**:
- `--live`: LiveViewã®ã‚µãƒãƒ¼ãƒˆã‚’å«ã‚ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã—ã¾ã™

### ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆã®ç¢ºèª

ä½œæˆã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ§‹æˆã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ï¼š

```
puyo_puyo/
â”œâ”€â”€ assets/              # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ã‚»ãƒƒãƒˆ (CSS, JS)
â”œâ”€â”€ config/              # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
â”‚   â”œâ”€â”€ config.exs       # å…±é€šè¨­å®š
â”‚   â”œâ”€â”€ dev.exs          # é–‹ç™ºç’°å¢ƒè¨­å®š
â”‚   â”œâ”€â”€ prod.exs         # æœ¬ç•ªç’°å¢ƒè¨­å®š
â”‚   â””â”€â”€ test.exs         # ãƒ†ã‚¹ãƒˆç’°å¢ƒè¨­å®š
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ puyo_puyo/       # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”‚   â”œâ”€â”€ application.ex
â”‚   â”‚   â”œâ”€â”€ repo.ex      # Ectoãƒªãƒã‚¸ãƒˆãƒª
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ puyo_puyo_web/   # Webãƒ¬ã‚¤ãƒ¤ãƒ¼
â”‚       â”œâ”€â”€ components/  # Phoenixã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚       â”œâ”€â”€ controllers/ # ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼
â”‚       â”œâ”€â”€ live/        # LiveViewãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”‚       â”œâ”€â”€ endpoint.ex  # HTTPã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
â”‚       â”œâ”€â”€ router.ex    # ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
â”‚       â””â”€â”€ ...
â”œâ”€â”€ priv/
â”‚   â””â”€â”€ repo/
â”‚       â””â”€â”€ migrations/  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
â”œâ”€â”€ test/                # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
â”‚   â”œâ”€â”€ puyo_puyo/
â”‚   â”œâ”€â”€ puyo_puyo_web/
â”‚   â”œâ”€â”€ support/
â”‚   â””â”€â”€ test_helper.exs
â”œâ”€â”€ mix.exs              # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®šç¾©ã¨ä¾å­˜é–¢ä¿‚
â””â”€â”€ mix.lock             # ä¾å­˜é–¢ä¿‚ã®ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«
```

### ã‚¹ãƒ†ãƒƒãƒ—3: é–‹ç™ºãƒ„ãƒ¼ãƒ«ã®è¿½åŠ 

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«é–‹ç™ºæ”¯æ´ãƒ„ãƒ¼ãƒ«ã‚’è¿½åŠ ã—ã¾ã™ã€‚`mix.exs`ã‚’ç·¨é›†ã—ã¦ã€ä¾å­˜é–¢ä¿‚ã‚’è¿½åŠ ã—ã¾ã™ï¼š

```elixir
defmodule PuyoPuyo.MixProject do
  use Mix.Project

  def project do
    [
      app: :puyo_puyo,
      version: "0.1.0",
      elixir: "~> 1.14",
      elixirc_paths: elixirc_paths(Mix.env()),
      start_permanent: Mix.env() == :prod,
      aliases: aliases(),
      deps: deps(),

      # ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®è¨­å®š
      test_coverage: [tool: ExCoveralls],
      preferred_cli_env: [
        coveralls: :test,
        "coveralls.detail": :test,
        "coveralls.html": :test
      ]
    ]
  end

  # çœç•¥...

  defp deps do
    [
      {:phoenix, "~> 1.7.10"},
      {:phoenix_ecto, "~> 4.4"},
      {:ecto_sql, "~> 3.10"},
      {:postgrex, ">= 0.0.0"},
      {:phoenix_html, "~> 3.3"},
      {:phoenix_live_reload, "~> 1.2", only: :dev},
      {:phoenix_live_view, "~> 0.20.1"},
      {:floki, ">= 0.30.0", only: :test},
      {:phoenix_live_dashboard, "~> 0.8.2"},
      {:esbuild, "~> 0.8", runtime: Mix.env() == :dev},
      {:tailwind, "~> 0.2.0", runtime: Mix.env() == :dev},
      {:swoosh, "~> 1.3"},
      {:finch, "~> 0.13"},
      {:telemetry_metrics, "~> 0.6"},
      {:telemetry_poller, "~> 1.0"},
      {:gettext, "~> 0.20"},
      {:jason, "~> 1.2"},
      {:dns_cluster, "~> 0.1.1"},
      {:plug_cowboy, "~> 2.5"},

      # é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«
      {:credo, "~> 1.7", only: [:dev, :test], runtime: false},
      {:excoveralls, "~> 0.18", only: :test},
      {:mix_test_watch, "~> 1.0", only: [:dev, :test], runtime: false},
      {:dialyxir, "~> 1.4", only: [:dev], runtime: false}
    ]
  end

  # çœç•¥...
end
```

**è¿½åŠ ã—ãŸãƒ„ãƒ¼ãƒ«**:
- **Credo**: é™çš„ã‚³ãƒ¼ãƒ‰è§£æãƒ„ãƒ¼ãƒ«ï¼ˆã‚³ãƒ¼ãƒ‰ã®å“è³ªãƒã‚§ãƒƒã‚¯ï¼‰
- **ExCoveralls**: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ„ãƒ¼ãƒ«ï¼ˆã©ã‚Œã ã‘ãƒ†ã‚¹ãƒˆã•ã‚Œã¦ã„ã‚‹ã‹ã‚’æ¸¬å®šï¼‰
- **mix_test_watch**: ãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦–ãƒ„ãƒ¼ãƒ«ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´æ™‚ã«è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼‰
- **Dialyxir**: å‹è§£æãƒ„ãƒ¼ãƒ«ï¼ˆå‹ã‚¨ãƒ©ãƒ¼ã®æ¤œå‡ºï¼‰

ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ï¼š

```bash
mix deps.get
```

### ã‚¹ãƒ†ãƒƒãƒ—4: Credoã®è¨­å®š

Credoã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ã‚’è¨­å®šã—ã¾ã™ï¼š

```bash
mix credo gen.config
```

ç”Ÿæˆã•ã‚ŒãŸ `.credo.exs` ãƒ•ã‚¡ã‚¤ãƒ«ã§ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åˆã‚ã›ãŸãƒ«ãƒ¼ãƒ«ã‚’èª¿æ•´ã§ãã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¨­å®šã§ã‚‚ååˆ†ã«æ©Ÿèƒ½ã—ã¾ã™ã€‚

### ã‚¹ãƒ†ãƒƒãƒ—5: ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã®è¨­å®š

Elixirã«ã¯æ¨™æº–ã§ `mix format` ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚`.formatter.exs` ãƒ•ã‚¡ã‚¤ãƒ«ã§è¨­å®šã‚’ç¢ºèªã—ã¾ã™ï¼š

```elixir
# .formatter.exs
[
  import_deps: [:ecto, :ecto_sql, :phoenix],
  subdirectories: ["priv/*/migrations"],
  plugins: [Phoenix.LiveView.HTMLFormatter],
  inputs: ["*.{heex,ex,exs}", "{config,lib,test}/**/*.{heex,ex,exs}", "priv/*/seeds.exs"]
]
```

### ã‚¹ãƒ†ãƒƒãƒ—6: é–‹ç™ºç”¨ã‚¿ã‚¹ã‚¯ã®ä½œæˆ

é–‹ç™ºåŠ¹ç‡ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã€ã‚«ã‚¹ã‚¿ãƒ Mixã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¾ã™ã€‚

`lib/mix/tasks/check.ex` ã‚’ä½œæˆï¼š

```elixir
defmodule Mix.Tasks.Check do
  @moduledoc """
  é–‹ç™ºæ™‚ã®åŸºæœ¬ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã‚¿ã‚¹ã‚¯ã§ã™ã€‚

  ä»¥ä¸‹ã®ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š
  - mix format --check-formatted (ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯)
  - mix credo --strict (é™çš„è§£æ)
  - mix test (ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ)
  """

  use Mix.Task

  @shortdoc "åŸºæœ¬çš„ãªã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯"

  def run(_args) do
    Mix.shell().info("==> åŸºæœ¬ãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹ã—ã¾ã™")

    # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
    Mix.shell().info("\n==> ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯")
    Mix.Task.run("format", ["--check-formatted"])
    Mix.shell().info("âœ“ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯ å®Œäº†")

    # é™çš„è§£æ
    Mix.shell().info("\n==> é™çš„è§£æ")
    Mix.Task.run("credo", ["--strict"])
    Mix.shell().info("âœ“ é™çš„è§£æ å®Œäº†")

    # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    Mix.shell().info("\n==> ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ")
    Mix.Task.run("test", [])
    Mix.shell().info("âœ“ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ å®Œäº†")

    Mix.shell().info("\nğŸ‰ åŸºæœ¬ãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸï¼")
  end
end
```

### ã‚¹ãƒ†ãƒƒãƒ—7: å‹•ä½œç¢ºèª

ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒæ­£ã—ãã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ï¼š

```bash
mix phx.server
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://localhost:4000` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€Phoenixã®ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

### ã‚¹ãƒ†ãƒƒãƒ—8: é–‹ç™ºã‚¬ã‚¤ãƒ‰ã®ä½œæˆ

ãƒãƒ¼ãƒ é–‹ç™ºã®ãŸã‚ã€é–‹ç™ºæ‰‹é †ã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–ã—ã¾ã™ã€‚

`DEVELOPMENT.md` ã‚’ä½œæˆï¼š

```markdown
# é–‹ç™ºã‚¬ã‚¤ãƒ‰

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

\`\`\`bash
# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
mix deps.get

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
mix ecto.setup

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ã‚»ãƒƒãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
cd assets && npm install && cd ..
\`\`\`

## ä½¿ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰

### åŸºæœ¬ã‚³ãƒãƒ³ãƒ‰
- `mix phx.server` - ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
- `mix test` - ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
- `mix format` - ã‚³ãƒ¼ãƒ‰æ•´å½¢
- `mix credo` - é™çš„è§£æ
- `mix coveralls.html` - ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

### çµ±åˆã‚³ãƒãƒ³ãƒ‰
- `mix check` - åŸºæœ¬ãƒã‚§ãƒƒã‚¯ (format, credo, test)

### è‡ªå‹•åŒ–
- `mix test.watch` - ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´æ™‚ã®è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

## é–‹ç™ºãƒ•ãƒ­ãƒ¼

1. **ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã**
2. **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**: `mix format`
3. **ãƒã‚§ãƒƒã‚¯**: `mix check`
4. **ã‚³ãƒŸãƒƒãƒˆ**

## ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´„

Angularã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´„ã«å¾“ã„ã¾ã™ï¼š

\`\`\`
<type>(<scope>): <subject>
\`\`\`

**ä¸»è¦ãªã‚¿ã‚¤ãƒ—**:
- `feat`: æ–°æ©Ÿèƒ½ã®è¿½åŠ 
- `fix`: ãƒã‚°ã®ä¿®æ­£
- `docs`: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã¿ã®å¤‰æ›´
- `test`: ãƒ†ã‚¹ãƒˆã®è¿½åŠ ã‚„ä¿®æ­£
- `refactor`: ãƒã‚°ä¿®æ­£ã‚„æ©Ÿèƒ½è¿½åŠ ä»¥å¤–ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´
- `chore`: ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã‚„ãƒ„ãƒ¼ãƒ«ã®å¤‰æ›´

## å“è³ªåŸºæº–

- **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**: Elixiræ¨™æº–ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã«æº–æ‹ 
- **é™çš„è§£æ**: Credoã®ãƒ«ãƒ¼ãƒ«ã‚’ã‚¯ãƒªã‚¢
- **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸**: 80%ä»¥ä¸Šã‚’ç›®æ¨™
- **å…¨ãƒ†ã‚¹ãƒˆ**: ãƒ‘ã‚¹ã™ã‚‹ã“ã¨
```

### ã‚¹ãƒ†ãƒƒãƒ—9: åˆå›ã‚³ãƒŸãƒƒãƒˆ

Gitãƒªãƒã‚¸ãƒˆãƒªã‚’åˆæœŸåŒ–ã—ã€åˆå›ã‚³ãƒŸãƒƒãƒˆã‚’ä½œæˆã—ã¾ã™ï¼š

```bash
# Gitãƒªãƒã‚¸ãƒˆãƒªã®åˆæœŸåŒ–ï¼ˆã¾ã ã®å ´åˆï¼‰
git init

# .gitignoreã®ç¢ºèªï¼ˆPhoenixãŒè‡ªå‹•ç”Ÿæˆï¼‰
# å¿…è¦ã«å¿œã˜ã¦è¿½åŠ è¨­å®š

# ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
git add -A

# åˆå›ã‚³ãƒŸãƒƒãƒˆ
git commit -m "chore: Phoenix LiveViewãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

- Phoenix 1.7ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
- LiveViewã‚µãƒãƒ¼ãƒˆã®æœ‰åŠ¹åŒ–
- é–‹ç™ºãƒ„ãƒ¼ãƒ«ã®è¿½åŠ ï¼ˆCredo, ExCoveralls, mix_test_watch, Dialyxirï¼‰
- ã‚«ã‚¹ã‚¿ãƒ Mixã‚¿ã‚¹ã‚¯ï¼ˆmix checkï¼‰ã®ä½œæˆ
- é–‹ç™ºã‚¬ã‚¤ãƒ‰ï¼ˆDEVELOPMENT.mdï¼‰ã®ä½œæˆ
- é–‹ç™ºç’°å¢ƒã®æ•´å‚™å®Œäº†"
```

### ã‚¹ãƒ†ãƒƒãƒ—10: åŸºæœ¬ãƒã‚§ãƒƒã‚¯ã®å®Ÿè¡Œ

ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ãŸã®ã§ã€åŸºæœ¬ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š

```bash
mix check
```

ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

### ã¾ã¨ã‚

ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³0ã§ä»¥ä¸‹ã‚’é”æˆã—ã¾ã—ãŸï¼š

#### å¾—ã‚‰ã‚ŒãŸã‚‚ã®

1. **Phoenix LiveViewãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—**
   - LiveViewå¯¾å¿œã®Phoenix 1.7ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®šã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒ
   - ã‚¢ã‚»ãƒƒãƒˆç®¡ç†ã®è¨­å®š

2. **é–‹ç™ºãƒ„ãƒ¼ãƒ«ã®æ•´å‚™**
   - Credoï¼ˆé™çš„ã‚³ãƒ¼ãƒ‰è§£æï¼‰
   - ExCoverallsï¼ˆãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ï¼‰
   - mix_test_watchï¼ˆè‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼‰
   - Dialyxirï¼ˆå‹è§£æï¼‰

3. **é–‹ç™ºãƒ•ãƒ­ãƒ¼ã®ç¢ºç«‹**
   - ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã®è¨­å®š
   - çµ±åˆãƒã‚§ãƒƒã‚¯ã‚¿ã‚¹ã‚¯ï¼ˆmix checkï¼‰
   - ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´„
   - é–‹ç™ºã‚¬ã‚¤ãƒ‰ã®ä½œæˆ

4. **ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®æº–å‚™**
   - ExUnitãƒ†ã‚¹ãƒˆç’°å¢ƒ
   - LiveViewãƒ†ã‚¹ãƒˆã®ã‚µãƒãƒ¼ãƒˆ
   - ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®šç’°å¢ƒ

#### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

```
puyo_puyo/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ mix/
â”‚   â”‚   â””â”€â”€ tasks/
â”‚   â”‚       â””â”€â”€ check.ex          # çµ±åˆãƒã‚§ãƒƒã‚¯ã‚¿ã‚¹ã‚¯
â”‚   â”œâ”€â”€ puyo_puyo/                # ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤
â”‚   â””â”€â”€ puyo_puyo_web/            # Webå±¤ï¼ˆLiveViewï¼‰
â”œâ”€â”€ test/                         # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ config/                       # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ .credo.exs                    # Credoè¨­å®š
â”œâ”€â”€ .formatter.exs                # ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿è¨­å®š
â”œâ”€â”€ mix.exs                       # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®šç¾©
â”œâ”€â”€ DEVELOPMENT.md                # é–‹ç™ºã‚¬ã‚¤ãƒ‰
â””â”€â”€ README.md                     # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª¬æ˜
```

#### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

é–‹ç™ºç’°å¢ƒãŒæ•´ã„ã¾ã—ãŸã€‚æ¬¡ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ä»¥ä¸‹ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ï¼š

- **ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³1**: ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–ã¨LiveViewã®åŸºæœ¬æ§‹é€ 
- **ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³2**: ã‚¹ãƒ†ãƒ¼ã‚¸ã®å®Ÿè£…ï¼ˆç›¤é¢ã®è¡¨ç¤ºã¨ç®¡ç†ï¼‰
- **ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³3**: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å®Ÿè£…ï¼ˆã·ã‚ˆã®ç§»å‹•ã¨å›è»¢ï¼‰
- **ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³4**: ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã®å®Ÿè£…ï¼ˆé‡åŠ›ã¨è½ä¸‹ï¼‰
- **ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³5**: æ¶ˆå»åˆ¤å®šã®å®Ÿè£…ï¼ˆåŒè‰²4ã¤ä»¥ä¸Šã®åˆ¤å®šï¼‰
- **ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³6**: é€£é–åå¿œã®å®Ÿè£…ï¼ˆé€£é–ã¨ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼‰
- **ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³7**: ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã®å®Ÿè£…ï¼ˆçµ‚äº†åˆ¤å®šã¨æ¼”å‡ºï¼‰

ã“ã‚Œã‚‰ã‚’ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®ã‚µã‚¤ã‚¯ãƒ«ã«å¾“ã£ã¦ã€ä¸€ã¤ãšã¤å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã†ï¼

Elixir Phoenix LiveViewã®ä¸–ç•Œã§ã€Œå‹•ä½œã™ã‚‹ãã‚Œã„ãªã‚³ãƒ¼ãƒ‰ã€ã‚’æ›¸ãå§‹ã‚ã‚‹æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚é–‹ç™ºã‚’æ¥½ã—ã‚“ã§ãã ã•ã„ï¼

---

## ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³1: ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–ã¨LiveViewã®åŸºæœ¬æ§‹é€ 

ã•ã‚ã€ã„ã‚ˆã„ã‚ˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãå§‹ã‚ã¾ã—ã‚‡ã†ï¼ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã§ã¯ã€å°ã•ãªã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆåå¾©ï¼‰ã§æ©Ÿèƒ½ã‚’å°‘ã—ãšã¤è¿½åŠ ã—ã¦ã„ãã¾ã™ã€‚æœ€åˆã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€æœ€ã‚‚åŸºæœ¬çš„ãªæ©Ÿèƒ½ã§ã‚ã‚‹ã€Œã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–ã€ã¨LiveViewã®åŸºæœ¬æ§‹é€ ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

> ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã¨ã¯ã€ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚’å°ã•ãªæ©Ÿèƒ½å˜ä½ã§ç¹°ã‚Šè¿”ã—é–‹ç™ºã—ã¦ã„ãæ‰‹æ³•ã§ã™ã€‚å„ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§è¨ˆç”»ã€è¨­è¨ˆã€å®Ÿè£…ã€ãƒ†ã‚¹ãƒˆã€è©•ä¾¡ã®ã‚µã‚¤ã‚¯ãƒ«ã‚’å›ã™ã“ã¨ã§ã€ãƒªã‚¹ã‚¯ã‚’æ—©æœŸã«ç™ºè¦‹ã—ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å¾—ãªãŒã‚‰é–‹ç™ºã‚’é€²ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
>
> â€” Craig Larman ã€ã‚¢ã‚¸ãƒ£ã‚¤ãƒ«é–‹ç™ºã¨ã‚¹ã‚¯ãƒ©ãƒ ã€

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼

ã¾ãšã¯ã€ã“ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å®Ÿè£…ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ï¼š

> ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ã€æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã§ãã‚‹

ã“ã®ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‹ã‚‰å§‹ã‚ã‚‹ã“ã¨ã§ã€ã‚²ãƒ¼ãƒ ã®åŸºæœ¬çš„ãªæ§‹é€ ã‚’ä½œã‚Šã€å¾Œç¶šã®æ©Ÿèƒ½è¿½åŠ ã®åœŸå°ã‚’ç¯‰ãã“ã¨ãŒã§ãã¾ã™ã€‚ã§ã¯ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®ã‚µã‚¤ã‚¯ãƒ«ã«å¾“ã£ã¦ã€ã¾ãšã¯ãƒ†ã‚¹ãƒˆã‹ã‚‰æ›¸ã„ã¦ã„ãã¾ã—ã‚‡ã†ï¼

### TODOãƒªã‚¹ãƒˆ

ã•ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã«ã€ã¾ãšã¯TODOãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚TODOãƒªã‚¹ãƒˆã¯ã€å¤§ããªæ©Ÿèƒ½ã‚’å°ã•ãªã‚¿ã‚¹ã‚¯ã«åˆ†è§£ã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚

> TODOãƒªã‚¹ãƒˆã¯ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®é‡è¦ãªãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®ä¸€ã¤ã§ã™ã€‚å®Ÿè£…å‰ã«å¿…è¦ãªã‚¿ã‚¹ã‚¯ã‚’æ˜ç¢ºã«ã™ã‚‹ã“ã¨ã§ã€é–‹ç™ºã®æ–¹å‘æ€§ã‚’ä¿ã¡ã€ä½•ã‚‚è¦‹è½ã¨ã•ãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚
>
> â€” Kent Beck ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã€

ç§ãŸã¡ã®ã€Œæ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã§ãã‚‹ã€ã¨ã„ã†ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã¯ã€ã©ã®ã‚ˆã†ãªã‚¿ã‚¹ã‚¯ãŒå¿…è¦ã§ã—ã‚‡ã†ã‹ï¼Ÿè€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ï¼š

- LiveViewãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹ï¼ˆã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹LiveViewãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
- ã‚²ãƒ¼ãƒ ã®åˆæœŸçŠ¶æ…‹ã‚’å®šç¾©ã™ã‚‹ï¼ˆã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã€ã‚¹ã‚³ã‚¢ã€ã‚¹ãƒ†ãƒ¼ã‚¸æƒ…å ±ãªã©ï¼‰
- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¦–è¦šçš„ã«ã‚²ãƒ¼ãƒ ã‚’èªè­˜ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
- ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¨­å®šã™ã‚‹ï¼ˆ`/game`ãƒ‘ã‚¹ã§ã‚²ãƒ¼ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰

ã“ã‚Œã‚‰ã®ã‚¿ã‚¹ã‚¯ã‚’ä¸€ã¤ãšã¤å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã§ã¯ã€å„ã‚¿ã‚¹ã‚¯ã«å¯¾ã—ã¦ãƒ†ã‚¹ãƒˆâ†’å®Ÿè£…â†’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã®ã‚µã‚¤ã‚¯ãƒ«ã‚’å›ã—ã¾ã™ã€‚ã¾ãšã¯ã€ŒLiveViewãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆã€ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†ï¼

### ãƒ†ã‚¹ãƒˆ: LiveViewãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ

ã•ã¦ã€TODOãƒªã‚¹ãƒˆã®æœ€åˆã®ã‚¿ã‚¹ã‚¯ã€ŒLiveViewãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹ã€ã«å–ã‚Šæ›ã‹ã‚Šã¾ã—ã‚‡ã†ã€‚ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã§ã¯ã€ã¾ãšãƒ†ã‚¹ãƒˆã‚’æ›¸ãã“ã¨ã‹ã‚‰å§‹ã‚ã¾ã™ã€‚

> ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ
>
> ã„ã¤ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã¹ãã ã‚ã†ã‹â€”â€”ãã‚Œã¯ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãå‰ã ã€‚
>
> â€” Kent Beck ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã€

ã§ã¯ã€LiveViewãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®åˆæœŸåŒ–ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã¿ã¾ã—ã‚‡ã†ã€‚LiveViewãƒ†ã‚¹ãƒˆã§ã¯ã€`mount/3`ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒæ­£ã—ãå‹•ä½œã—ã€å¿…è¦ãªçŠ¶æ…‹ãŒè¨­å®šã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

```elixir
# test/puyo_puyo_web/live/game_live_test.exs
defmodule PuyoPuyoWeb.GameLiveTest do
  use PuyoPuyoWeb.ConnCase

  import Phoenix.LiveViewTest

  describe "GameLive" do
    test "mounts successfully", %{conn: conn} do
      {:ok, _view, html} = live(conn, "/game")
      assert html =~ "ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ "
    end

    test "initializes game state on mount", %{conn: conn} do
      {:ok, view, _html} = live(conn, "/game")

      # LiveViewã®çŠ¶æ…‹ã‚’å–å¾—
      assert has_element?(view, "#game-container")

      # åˆæœŸçŠ¶æ…‹ã®ç¢ºèª
      # mode: :start (ã‚²ãƒ¼ãƒ é–‹å§‹çŠ¶æ…‹)
      # score: 0 (ã‚¹ã‚³ã‚¢ã¯0)
      # chain: 0 (é€£é–æ•°ã¯0)
    end

    test "displays game board", %{conn: conn} do
      {:ok, view, _html} = live(conn, "/game")

      # ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
      assert has_element?(view, "#game-board")
    end

    test "displays score information", %{conn: conn} do
      {:ok, view, _html} = live(conn, "/game")

      # ã‚¹ã‚³ã‚¢æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
      assert has_element?(view, "#score")
      assert has_element?(view, "#chain")
    end
  end
end
```

ã“ã®ãƒ†ã‚¹ãƒˆã§ã¯ã€`GameLive`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒæ­£ã—ããƒã‚¦ãƒ³ãƒˆã•ã‚Œã€å¿…è¦ãªåˆæœŸçŠ¶æ…‹ãŒè¨­å®šã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚

### å®Ÿè£…: LiveViewãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ

ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ãŸã‚‰ã€æ¬¡ã«å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã©ã†ãªã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ

```bash
mix test test/puyo_puyo_web/live/game_live_test.exs
```

```
Error: cannot find module PuyoPuyoWeb.GameLive
```

ãŠã£ã¨ï¼ã¾ã `GameLive`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å®Ÿè£…ã—ã¦ã„ãªã„ã®ã§ã€å½“ç„¶ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã­ã€‚ã“ã‚ŒãŒãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®ã€ŒRedï¼ˆèµ¤ï¼‰ã€ã®çŠ¶æ…‹ã§ã™ã€‚ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚

> å¤±æ•—ã™ã‚‹ãƒ†ã‚¹ãƒˆ
>
> ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰å®Ÿè£…ã«å–ã‚Šæ›ã‹ã‚ã†ã€‚ãã†ã™ã‚Œã°ã€ãƒ†ã‚¹ãƒˆãŒæ­£ã—ãæ©Ÿèƒ½ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã€‚
>
> â€” Kent Beck ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã€

ã§ã¯ã€ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã‚ˆã†ã«æœ€å°é™ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚ã€Œæœ€å°é™ã€ã¨ã„ã†ã®ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚ã“ã®æ®µéšã§ã¯ã€ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã ã‘ã‚’ç›®æŒ‡ã—ã¦ã€å¿…è¦æœ€ä½é™ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã¾ã™ã€‚

```elixir
# lib/puyo_puyo_web/live/game_live.ex
defmodule PuyoPuyoWeb.GameLive do
  use PuyoPuyoWeb, :live_view

  @moduledoc """
  ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ ã®LiveViewãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
  """

  # ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã®å®šç¾©
  @type game_mode :: :start | :check_fall | :fall | :check_erase | :erasing | :new_puyo | :playing | :game_over

  # ã‚²ãƒ¼ãƒ è¨­å®š
  @stage_rows 12
  @stage_cols 6
  @puyo_size 32

  @impl true
  def mount(_params, _session, socket) do
    # ã‚²ãƒ¼ãƒ ã®åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
    socket =
      socket
      |> assign(:mode, :start)
      |> assign(:score, 0)
      |> assign(:chain, 0)
      |> assign(:stage_rows, @stage_rows)
      |> assign(:stage_cols, @stage_cols)
      |> assign(:puyo_size, @puyo_size)
      |> assign(:board, init_board())

    {:ok, socket}
  end

  @impl true
  def render(assigns) do
    ~H"""
    <div id="game-container" class="flex gap-8 p-8">
      <div id="game-board" class="relative bg-gray-100 border-2 border-gray-800 rounded-lg">
        <div class="grid" style={"grid-template-columns: repeat(#{@stage_cols}, #{@puyo_size}px);"}>
          <%= for row <- 0..(@stage_rows - 1) do %>
            <%= for col <- 0..(@stage_cols - 1) do %>
              <div
                class="border border-gray-300"
                style={"width: #{@puyo_size}px; height: #{@puyo_size}px;"}
              >
                <%= render_puyo(@board[row][col]) %>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>

      <div id="info-panel" class="bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-bold mb-4">ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ </h2>

        <div class="mb-4">
          <h3 class="text-lg font-semibold">ã‚¹ã‚³ã‚¢</h3>
          <p id="score" class="text-3xl font-bold text-blue-600"><%= @score %></p>
        </div>

        <div class="mb-4">
          <h3 class="text-lg font-semibold">é€£é–æ•°</h3>
          <p id="chain" class="text-3xl font-bold text-red-600"><%= @chain %></p>
        </div>

        <div class="mt-6 text-sm text-gray-600">
          <h3 class="font-semibold mb-2">æ“ä½œæ–¹æ³•</h3>
          <ul class="space-y-1">
            <li>â† â†’: ç§»å‹•</li>
            <li>â†‘: å›è»¢</li>
            <li>â†“: é«˜é€Ÿè½ä¸‹</li>
          </ul>
        </div>
      </div>
    </div>
    """
  end

  # ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆé–¢æ•°

  # ç©ºã®ãƒœãƒ¼ãƒ‰ã‚’åˆæœŸåŒ–
  defp init_board do
    for row <- 0..(@stage_rows - 1), into: %{} do
      {row, for(col <- 0..(@stage_cols - 1), into: %{}, do: {col, 0})}
    end
  end

  # ã·ã‚ˆã®æç”»ï¼ˆ0ã¯ç©ºã€1-4ã¯ã·ã‚ˆã®ç¨®é¡ï¼‰
  defp render_puyo(0), do: nil
  defp render_puyo(type) when type in 1..4 do
    color = puyo_color(type)
    assigns = %{color: color}

    ~H"""
    <div class="w-full h-full rounded-full" style={"background-color: #{@color}; border: 2px solid rgba(0,0,0,0.2);"}></div>
    """
  end

  # ã·ã‚ˆã®è‰²ã‚’è¿”ã™
  defp puyo_color(1), do: "#FF0000"  # èµ¤
  defp puyo_color(2), do: "#00FF00"  # ç·‘
  defp puyo_color(3), do: "#0000FF"  # é’
  defp puyo_color(4), do: "#FFFF00"  # é»„
end
```

### ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®è¨­å®š

LiveViewãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆã—ãŸã‚‰ã€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¨­å®šã—ã¦ã€`/game`ãƒ‘ã‚¹ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```elixir
# lib/puyo_puyo_web/router.ex
defmodule PuyoPuyoWeb.Router do
  use PuyoPuyoWeb, :router

  # æ—¢å­˜ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³...

  scope "/", PuyoPuyoWeb do
    pipe_through :browser

    get "/", PageController, :home

    # ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ ã®ãƒ«ãƒ¼ãƒˆ
    live "/game", GameLive
  end

  # æ—¢å­˜ã®ã‚¹ã‚³ãƒ¼ãƒ—...
end
```

### è§£èª¬: LiveViewã®åˆæœŸåŒ–

ãƒ†ã‚¹ãƒˆãŒé€šã‚Šã¾ã—ãŸã­ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ã€‚ã“ã‚ŒãŒãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®ã€ŒGreenï¼ˆç·‘ï¼‰ã€ã®çŠ¶æ…‹ã§ã™ã€‚

> ãƒ†ã‚¹ãƒˆãŒé€šã£ãŸã‚‰ã€æ¬¡ã¯ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã ã€‚ã§ã‚‚ã€ãã®å‰ã«å°‘ã—ç«‹ã¡æ­¢ã¾ã£ã¦ã€ä»Šæ›¸ã„ãŸã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦è€ƒãˆã¦ã¿ã‚ˆã†ã€‚
>
> â€” Martin Fowler ã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã€

å®Ÿè£…ã—ãŸLiveViewãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã¤ã„ã¦ã€å°‘ã—è§£èª¬ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

#### Phoenix LiveViewã®ä»•çµ„ã¿

Phoenix LiveViewã¯ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§HTMLã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã€WebSocketã‚’é€šã˜ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«å·®åˆ†ã ã‘ã‚’é€ä¿¡ã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚ä¸»ãªç‰¹å¾´ã¯ï¼š

1. **ã‚µãƒ¼ãƒãƒ¼å´ã§çŠ¶æ…‹ç®¡ç†**: `socket.assigns`ã«çŠ¶æ…‹ã‚’ä¿å­˜
2. **è‡ªå‹•çš„ãªå·®åˆ†æ›´æ–°**: çŠ¶æ…‹ãŒå¤‰ã‚ã‚‹ã¨ã€å¤‰æ›´ã•ã‚ŒãŸéƒ¨åˆ†ã ã‘ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€ä¿¡ã•ã‚Œã‚‹
3. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡**: WebSocketã«ã‚ˆã‚‹åŒæ–¹å‘é€šä¿¡

#### mount/3ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯

```elixir
def mount(_params, _session, socket) do
  socket =
    socket
    |> assign(:mode, :start)
    |> assign(:score, 0)
    |> assign(:chain, 0)
    # ...
  {:ok, socket}
end
```

`mount/3`ã¯ã€LiveViewãŒåˆæœŸåŒ–ã•ã‚Œã‚‹ã¨ãã«å‘¼ã°ã‚Œã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ã™ã€‚ã“ã“ã§ï¼š

- **ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰**: `:start`ï¼ˆã‚²ãƒ¼ãƒ é–‹å§‹çŠ¶æ…‹ï¼‰
- **ã‚¹ã‚³ã‚¢**: `0`
- **é€£é–æ•°**: `0`
- **ãƒœãƒ¼ãƒ‰**: ç©ºã®ãƒœãƒ¼ãƒ‰ï¼ˆ12è¡Œ Ã— 6åˆ—ï¼‰

ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™ã€‚

#### render/1é–¢æ•°

```elixir
def render(assigns) do
  ~H"""
  <div id="game-container">
    ...
  </div>
  """
end
```

`render/1`é–¢æ•°ã¯ã€LiveViewã®UIã‚’å®šç¾©ã—ã¾ã™ã€‚`~H`ã‚·ã‚¸ãƒ«ã¯ã€HEExãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆHTML + Elixirï¼‰ã‚’è¡¨ã—ã¾ã™ã€‚

ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã¯ï¼š

- **ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰**: ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§6Ã—12ã®ã‚»ãƒ«ã‚’è¡¨ç¤º
- **æƒ…å ±ãƒ‘ãƒãƒ«**: ã‚¹ã‚³ã‚¢ã€é€£é–æ•°ã€æ“ä½œæ–¹æ³•ã‚’è¡¨ç¤º

#### çŠ¶æ…‹ã®ç®¡ç†

LiveViewã§ã¯ã€`assign/3`é–¢æ•°ã‚’ä½¿ã£ã¦çŠ¶æ…‹ã‚’ç®¡ç†ã—ã¾ã™ï¼š

```elixir
socket = assign(socket, :score, 100)
```

çŠ¶æ…‹ãŒå¤‰æ›´ã•ã‚Œã‚‹ã¨ã€LiveViewã¯è‡ªå‹•çš„ã«`render/1`ã‚’å†å®Ÿè¡Œã—ã€å¤‰æ›´ã•ã‚ŒãŸéƒ¨åˆ†ã ã‘ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€ä¿¡ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€åŠ¹ç‡çš„ãªãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ãŒå®Ÿç¾ã•ã‚Œã¾ã™ã€‚

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨ç¢ºèª

å®Ÿè£…ãŒå®Œäº†ã—ãŸã®ã§ã€ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```bash
mix test test/puyo_puyo_web/live/game_live_test.exs
```

ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚ã¾ãŸã€ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```bash
mix phx.server
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://localhost:4000/game` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ã¨ã‚¹ã‚³ã‚¢æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚

### ã‚³ãƒŸãƒƒãƒˆ

æ©Ÿèƒ½ãŒå®Œæˆã—ãŸã®ã§ã€ã‚³ãƒŸãƒƒãƒˆã—ã¾ã—ã‚‡ã†ï¼š

```bash
git add -A
git commit -m "feat: ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–ã¨LiveViewã®åŸºæœ¬æ§‹é€ ã‚’å®Ÿè£…

- GameLiveãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ
- mount/3ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ã®åˆæœŸçŠ¶æ…‹è¨­å®š
- HEExãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä½œæˆï¼ˆã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ã€æƒ…å ±ãƒ‘ãƒãƒ«ï¼‰
- ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®è¨­å®šï¼ˆ/gameï¼‰
- LiveViewãƒ†ã‚¹ãƒˆã®ä½œæˆ
- ç©ºã®ãƒœãƒ¼ãƒ‰ï¼ˆ12è¡Œ Ã— 6åˆ—ï¼‰ã®è¡¨ç¤º
- ã‚¹ã‚³ã‚¢ã¨é€£é–æ•°ã®è¡¨ç¤º

ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³1å®Œäº†"
```

### ã¾ã¨ã‚

ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³1ã§ä»¥ä¸‹ã‚’é”æˆã—ã¾ã—ãŸï¼š

#### å¾—ã‚‰ã‚ŒãŸã‚‚ã®

1. **LiveViewã®åŸºæœ¬æ§‹é€ **
   - GameLiveãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ
   - mount/3ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ã®åˆæœŸåŒ–
   - HEExãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ã‚ˆã‚‹ç”»é¢è¡¨ç¤º

2. **ã‚²ãƒ¼ãƒ ã®åˆæœŸçŠ¶æ…‹**
   - ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ï¼ˆ:startï¼‰
   - ã‚¹ã‚³ã‚¢ï¼ˆ0ï¼‰
   - é€£é–æ•°ï¼ˆ0ï¼‰
   - ç©ºã®ãƒœãƒ¼ãƒ‰ï¼ˆ12è¡Œ Ã— 6åˆ—ï¼‰

3. **ç”»é¢è¡¨ç¤º**
   - ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰
   - ã‚¹ã‚³ã‚¢ã¨é€£é–æ•°ã®æƒ…å ±ãƒ‘ãƒãƒ«
   - æ“ä½œæ–¹æ³•ã®è¡¨ç¤º

4. **ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**
   - `/game`ãƒ‘ã‚¹ã§ã‚²ãƒ¼ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

5. **ãƒ†ã‚¹ãƒˆã®ä½œæˆ**
   - LiveViewãƒ†ã‚¹ãƒˆã«ã‚ˆã‚‹å‹•ä½œç¢ºèª
   - ãƒã‚¦ãƒ³ãƒˆã€åˆæœŸåŒ–ã€è¡¨ç¤ºã®ãƒ†ã‚¹ãƒˆ

#### Phoenix LiveViewã®åˆ©ç‚¹

ä»Šå›ã®å®Ÿè£…ã§ã€Phoenix LiveViewã®ä»¥ä¸‹ã®åˆ©ç‚¹ã‚’ä½“æ„Ÿã§ãã¾ã—ãŸï¼š

1. **ã‚·ãƒ³ãƒ—ãƒ«ãªçŠ¶æ…‹ç®¡ç†**: ã‚µãƒ¼ãƒãƒ¼å´ã§çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®è¤‡é›‘ãªçŠ¶æ…‹ç®¡ç†ãŒä¸è¦
2. **è‡ªå‹•çš„ãªæ›´æ–°**: çŠ¶æ…‹ãŒå¤‰ã‚ã‚‹ã¨ã€è‡ªå‹•çš„ã«ç”»é¢ãŒæ›´æ–°ã•ã‚Œã‚‹
3. **çµ±ä¸€çš„ãªãƒ†ã‚¹ãƒˆ**: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ã¨ã—ã¦çµ±ä¸€çš„ã«ãƒ†ã‚¹ãƒˆå¯èƒ½
4. **å°‘ãªã„JavaScript**: JavaScriptã‚’ã»ã¨ã‚“ã©æ›¸ã‹ãšã«ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªUIã‚’å®Ÿè£…

#### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

åŸºæœ¬çš„ãªæ§‹é€ ãŒã§ãã¾ã—ãŸã€‚æ¬¡ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ä»¥ä¸‹ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ï¼š

- **ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³2**: ã‚¹ãƒ†ãƒ¼ã‚¸ã®å®Ÿè£…ï¼ˆã·ã‚ˆã®é…ç½®ã¨ç®¡ç†ï¼‰
- **ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³3**: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å®Ÿè£…ï¼ˆã·ã‚ˆã®ç§»å‹•ã¨å›è»¢ï¼‰
- **ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³4**: ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã®å®Ÿè£…ï¼ˆé‡åŠ›ã¨è½ä¸‹ï¼‰

ã“ã‚Œã‚‰ã‚’ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®ã‚µã‚¤ã‚¯ãƒ«ã«å¾“ã£ã¦ã€ä¸€ã¤ãšã¤å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã†ï¼

---

## ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³2: ã‚¹ãƒ†ãƒ¼ã‚¸ã®å®Ÿè£…

ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³1ã§åŸºæœ¬çš„ãªæ§‹é€ ãŒã§ãã¾ã—ãŸã€‚æ¬¡ã¯ã€ã‚²ãƒ¼ãƒ ã®ä¸­æ ¸ã¨ãªã‚‹ã€Œã‚¹ãƒ†ãƒ¼ã‚¸ã€ã®å®Ÿè£…ã§ã™ã€‚ã‚¹ãƒ†ãƒ¼ã‚¸ã¯ã€ã·ã‚ˆã®é…ç½®ã€æ¶ˆå»åˆ¤å®šã€è½ä¸‹å‡¦ç†ãªã©ã€ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ ã®é‡è¦ãªãƒ­ã‚¸ãƒƒã‚¯ã‚’æ‹…å½“ã—ã¾ã™ã€‚

> ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«
>
> ãƒ‰ãƒ¡ã‚¤ãƒ³é§†å‹•è¨­è¨ˆã§ã¯ã€ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã¨ã—ã¦åˆ†é›¢ã—ã¾ã™ã€‚ã‚²ãƒ¼ãƒ ã«ãŠã„ã¦ã¯ã€ã‚¹ãƒ†ãƒ¼ã‚¸ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã€ã‚¹ã‚³ã‚¢ãªã©ãŒãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã«ã‚ãŸã‚Šã¾ã™ã€‚ã“ã‚Œã‚‰ã‚’Webãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆLiveViewï¼‰ã‹ã‚‰åˆ†é›¢ã™ã‚‹ã“ã¨ã§ã€ãƒ†ã‚¹ãƒˆã—ã‚„ã™ãã€ä¿å®ˆã—ã‚„ã™ã„ã‚³ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚
>
> â€” Eric Evans ã€ãƒ‰ãƒ¡ã‚¤ãƒ³é§†å‹•è¨­è¨ˆã€

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼

ã“ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å®Ÿè£…ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ï¼š

> ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ã€ã‚¹ãƒ†ãƒ¼ã‚¸ä¸Šã®ã·ã‚ˆã‚’ç®¡ç†ã—ã€åŒã˜è‰²ã®ã·ã‚ˆãŒ4ã¤ä»¥ä¸Šã¤ãªãŒã£ãŸã‚‰æ¶ˆå»ã§ãã‚‹

ã“ã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã«ã¯ã€ã„ãã¤ã‹ã®æ©Ÿèƒ½ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼š

1. ã·ã‚ˆã®é…ç½®ã¨å–å¾—
2. åŒã˜è‰²ã®ã·ã‚ˆã®æ¥ç¶šåˆ¤å®šï¼ˆ4ã¤ä»¥ä¸Šï¼‰
3. ã·ã‚ˆã®æ¶ˆå»
4. æ¶ˆå»å¾Œã®è½ä¸‹

ãã‚Œã§ã¯ã€ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã‚’ä¸€ã¤ãšã¤ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã§å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã†ï¼

### TODOãƒªã‚¹ãƒˆ

> TODOãƒªã‚¹ãƒˆã¯ã€å¤§ããªå•é¡Œã‚’å°ã•ãªå•é¡Œã«åˆ†å‰²ã™ã‚‹ãŸã‚ã®å¼·åŠ›ãªãƒ„ãƒ¼ãƒ«ã§ã™ã€‚è¤‡é›‘ãªå•é¡Œã«ç›´é¢ã—ãŸã¨ãã€ãã‚Œã‚’ç®¡ç†å¯èƒ½ãªå°ã•ãªã‚¿ã‚¹ã‚¯ã«åˆ†è§£ã™ã‚‹ã“ã¨ã§ã€ä¸€æ­©ä¸€æ­©ç¢ºå®Ÿã«å‰é€²ã§ãã¾ã™ã€‚
>
> â€” Kent Beck ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã€

ã€Œã‚¹ãƒ†ãƒ¼ã‚¸ã®å®Ÿè£…ã€ã¨ã„ã†ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®ã‚¿ã‚¹ã‚¯ãŒå¿…è¦ã§ã™ï¼š

- Stageãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹ï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤ï¼‰
- ã·ã‚ˆã®é…ç½®ãƒ»å–å¾—æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹
- æ¶ˆå»åˆ¤å®šã‚’å®Ÿè£…ã™ã‚‹ï¼ˆDFSã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼‰
- ã·ã‚ˆã®æ¶ˆå»å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹
- è½ä¸‹å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹
- é‡åŠ›ã‚’é©ç”¨ã™ã‚‹å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹
- GameLiveã¨çµ±åˆã™ã‚‹

ã“ã‚Œã‚‰ã®ã‚¿ã‚¹ã‚¯ã‚’ä¸€ã¤ãšã¤å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚ã¾ãšã¯ã€Œã·ã‚ˆã®é…ç½®ãƒ»å–å¾—ã€ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†ï¼

### ãƒ†ã‚¹ãƒˆ: ã·ã‚ˆã®é…ç½®ã¨å–å¾—

ã¾ãšã€ã‚¹ãƒ†ãƒ¼ã‚¸ä¸Šã«ã·ã‚ˆã‚’é…ç½®ã—ã€å–å¾—ã™ã‚‹æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

```elixir
# test/puyo_puyo/stage_test.exs
defmodule PuyoPuyo.StageTest do
  use ExUnit.Case, async: true

  alias PuyoPuyo.Stage

  describe "Stage.new/1" do
    test "creates a new stage with default dimensions" do
      stage = Stage.new([])

      assert stage.rows == 12
      assert stage.cols == 6
    end

    test "creates a new stage with custom dimensions" do
      stage = Stage.new(rows: 10, cols: 8)

      assert stage.rows == 10
      assert stage.cols == 8
    end

    test "initializes board with all zeros" do
      stage = Stage.new([])

      # ã™ã¹ã¦ã®ã‚»ãƒ«ãŒ0ï¼ˆç©ºï¼‰ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
      for row <- 0..(stage.rows - 1) do
        for col <- 0..(stage.cols - 1) do
          assert Stage.get_puyo(stage, col, row) == 0
        end
      end
    end
  end

  describe "Stage.set_puyo/4 and Stage.get_puyo/3" do
    setup do
      {:ok, stage: Stage.new([])}
    end

    test "sets and gets a puyo at specified position", %{stage: stage} do
      # ã·ã‚ˆã‚’è¨­å®šï¼ˆx=1, y=10, type=1 [èµ¤]ï¼‰
      stage = Stage.set_puyo(stage, 1, 10, 1)

      # ã·ã‚ˆã‚’å–å¾—ã—ã¦ç¢ºèª
      assert Stage.get_puyo(stage, 1, 10) == 1
    end

    test "returns 0 for empty cell", %{stage: stage} do
      # ç©ºã®ã‚»ãƒ«ã‚’å–å¾—
      assert Stage.get_puyo(stage, 0, 0) == 0
    end

    test "returns 0 for out of bounds position", %{stage: stage} do
      # ç¯„å›²å¤–ã®åº§æ¨™ã‚’æŒ‡å®š
      assert Stage.get_puyo(stage, -1, 0) == 0
      assert Stage.get_puyo(stage, 0, -1) == 0
      assert Stage.get_puyo(stage, 100, 0) == 0
      assert Stage.get_puyo(stage, 0, 100) == 0
    end
  end
end
```

### å®Ÿè£…: Stage ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨å¤±æ•—ã—ã¾ã™ï¼ˆRedï¼‰ã€‚ã§ã¯ã€ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã‚ˆã†ã«æœ€å°é™ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã—ã¾ã—ã‚‡ã†ï¼ˆGreenï¼‰ã€‚

```elixir
# lib/puyo_puyo/stage.ex
defmodule PuyoPuyo.Stage do
  @moduledoc """
  ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ç®¡ç†ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

  ã‚¹ãƒ†ãƒ¼ã‚¸ã¯12è¡ŒÃ—6åˆ—ã®ãƒœãƒ¼ãƒ‰ã§æ§‹æˆã•ã‚Œã€ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ï¼š
  - ã·ã‚ˆã®é…ç½®ã¨å–å¾—
  - æ¶ˆå»åˆ¤å®šï¼ˆ4ã¤ä»¥ä¸Šã®åŒè‰²ã·ã‚ˆã®æ¥ç¶šåˆ¤å®šï¼‰
  - ã·ã‚ˆã®æ¶ˆå»
  - è½ä¸‹å‡¦ç†ï¼ˆé‡åŠ›ï¼‰
  """

  @type t :: %__MODULE__{
          rows: non_neg_integer(),
          cols: non_neg_integer(),
          board: %{non_neg_integer() => %{non_neg_integer() => non_neg_integer()}}
        }

  defstruct [:rows, :cols, :board]

  @default_rows 12
  @default_cols 6

  @doc """
  æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã™

  ## Options
    * `:rows` - ã‚¹ãƒ†ãƒ¼ã‚¸ã®è¡Œæ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 12ï¼‰
    * `:cols` - ã‚¹ãƒ†ãƒ¼ã‚¸ã®åˆ—æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 6ï¼‰

  ## Examples

      iex> stage = PuyoPuyo.Stage.new([])
      iex> stage.rows
      12
      iex> stage.cols
      6

  """
  @spec new(keyword()) :: t()
  def new(opts) do
    rows = Keyword.get(opts, :rows, @default_rows)
    cols = Keyword.get(opts, :cols, @default_cols)

    # ãƒœãƒ¼ãƒ‰ã‚’åˆæœŸåŒ–ï¼ˆã™ã¹ã¦0ã§åŸ‹ã‚ã‚‹ï¼‰
    board =
      for row <- 0..(rows - 1), into: %{} do
        {row, for(col <- 0..(cols - 1), into: %{}, do: {col, 0})}
      end

    %__MODULE__{rows: rows, cols: cols, board: board}
  end

  @doc """
  æŒ‡å®šã—ãŸä½ç½®ã®ã·ã‚ˆã‚’å–å¾—ã—ã¾ã™

  ç¯„å›²å¤–ã®åº§æ¨™ã‚’æŒ‡å®šã—ãŸå ´åˆã¯0ï¼ˆç©ºï¼‰ã‚’è¿”ã—ã¾ã™

  ## Examples

      iex> stage = PuyoPuyo.Stage.new([])
      iex> stage = PuyoPuyo.Stage.set_puyo(stage, 1, 10, 1)
      iex> PuyoPuyo.Stage.get_puyo(stage, 1, 10)
      1

  """
  @spec get_puyo(t(), non_neg_integer(), non_neg_integer()) :: non_neg_integer()
  def get_puyo(%__MODULE__{board: board, rows: rows, cols: cols}, x, y) do
    # ç¯„å›²å¤–ãƒã‚§ãƒƒã‚¯
    if x < 0 or x >= cols or y < 0 or y >= rows do
      0
    else
      board[y][x]
    end
  end

  @doc """
  æŒ‡å®šã—ãŸä½ç½®ã«ã·ã‚ˆã‚’è¨­å®šã—ã¾ã™

  æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’è¿”ã—ã¾ã™ï¼ˆä¸å¤‰ãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼‰

  ## Examples

      iex> stage = PuyoPuyo.Stage.new([])
      iex> stage = PuyoPuyo.Stage.set_puyo(stage, 1, 10, 1)
      iex> PuyoPuyo.Stage.get_puyo(stage, 1, 10)
      1

  """
  @spec set_puyo(t(), non_neg_integer(), non_neg_integer(), non_neg_integer()) :: t()
  def set_puyo(%__MODULE__{board: board} = stage, x, y, puyo_type) do
    # æŒ‡å®šã—ãŸä½ç½®ã®ã·ã‚ˆã‚’æ›´æ–°
    updated_row = Map.put(board[y], x, puyo_type)
    updated_board = Map.put(board, y, updated_row)

    %{stage | board: updated_board}
  end
end
```

### è§£èª¬: Elixirã®ä¸å¤‰ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

å®Ÿè£…ã—ãŸStageãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã¤ã„ã¦ã€ã„ãã¤ã‹é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’è§£èª¬ã—ã¾ã™ã€‚

#### æ§‹é€ ä½“ã®å®šç¾©

```elixir
defstruct [:rows, :cols, :board]
```

Elixirã®æ§‹é€ ä½“ã¯ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…ã§`defstruct`ã‚’ä½¿ã£ã¦å®šç¾©ã—ã¾ã™ã€‚æ§‹é€ ä½“ã¯ã€ç‰¹å®šã®æ§‹é€ ã‚’æŒã¤ãƒãƒƒãƒ—ã§ã™ã€‚

#### ä¸å¤‰ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

```elixir
def set_puyo(%__MODULE__{board: board} = stage, x, y, puyo_type) do
  updated_row = Map.put(board[y], x, puyo_type)
  updated_board = Map.put(board, y, updated_row)
  %{stage | board: updated_board}
end
```

Elixirã§ã¯ã€ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒä¸å¤‰ï¼ˆimmutableï¼‰ã§ã™ã€‚`set_puyo/4`ã¯å…ƒã®ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’å¤‰æ›´ã›ãšã€æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’è¿”ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šï¼š

1. **äºˆæ¸¬å¯èƒ½æ€§**: é–¢æ•°ãŒå…ƒã®ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã—ãªã„ãŸã‚ã€ãƒã‚°ãŒæ¸›ã‚‹
2. **ä¸¦è¡Œå‡¦ç†ã®å®‰å…¨æ€§**: ãƒ‡ãƒ¼ã‚¿ç«¶åˆãŒç™ºç”Ÿã—ãªã„
3. **ãƒ†ã‚¹ãƒˆã®ã—ã‚„ã™ã•**: å‰¯ä½œç”¨ãŒãªã„ãŸã‚ã€ãƒ†ã‚¹ãƒˆãŒå®¹æ˜“

#### ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°

```elixir
def get_puyo(%__MODULE__{board: board, rows: rows, cols: cols}, x, y)
```

é–¢æ•°ã®å¼•æ•°ã§ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã‚’ä½¿ã†ã“ã¨ã§ã€æ§‹é€ ä½“ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

å®Ÿè£…ãŒå®Œäº†ã—ãŸã®ã§ã€ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```bash
mix test test/puyo_puyo/stage_test.exs
```

ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ï¼ˆGreenï¼‰ã€‚

### ãƒ†ã‚¹ãƒˆ: æ¶ˆå»åˆ¤å®š

æ¬¡ã«ã€åŒã˜è‰²ã®ã·ã‚ˆãŒ4ã¤ä»¥ä¸Šã¤ãªãŒã£ã¦ã„ã‚‹ã‹ã‚’åˆ¤å®šã™ã‚‹æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

```elixir
# test/puyo_puyo/stage_test.exsï¼ˆç¶šãï¼‰
describe "Stage.check_erase/1" do
  setup do
    {:ok, stage: Stage.new([])}
  end

  test "detects 4 connected puyos as erasable", %{stage: stage} do
    # 2Ã—2ã®æ­£æ–¹å½¢ã«èµ¤ã·ã‚ˆã‚’é…ç½®
    stage =
      stage
      |> Stage.set_puyo(1, 10, 1)
      |> Stage.set_puyo(2, 10, 1)
      |> Stage.set_puyo(1, 11, 1)
      |> Stage.set_puyo(2, 11, 1)

    # æ¶ˆå»åˆ¤å®š
    {erase_count, _positions} = Stage.check_erase(stage)

    # 4ã¤ã®ã·ã‚ˆãŒæ¶ˆå»å¯¾è±¡ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    assert erase_count == 4
  end

  test "does not erase different colored puyos", %{stage: stage} do
    # å¸‚æ¾æ¨¡æ§˜ã«èµ¤ã¨ç·‘ã®ã·ã‚ˆã‚’é…ç½®
    stage =
      stage
      |> Stage.set_puyo(1, 10, 1)  # èµ¤
      |> Stage.set_puyo(2, 10, 2)  # ç·‘
      |> Stage.set_puyo(1, 11, 2)  # ç·‘
      |> Stage.set_puyo(2, 11, 1)  # èµ¤

    # æ¶ˆå»åˆ¤å®š
    {erase_count, positions} = Stage.check_erase(stage)

    # æ¶ˆå»å¯¾è±¡ãŒãªã„ã“ã¨ã‚’ç¢ºèª
    assert erase_count == 0
    assert positions == []
  end

  test "does not erase 3 or fewer connected puyos", %{stage: stage} do
    # Lå­—å‹ã«èµ¤ã·ã‚ˆã‚’3ã¤é…ç½®
    stage =
      stage
      |> Stage.set_puyo(1, 10, 1)
      |> Stage.set_puyo(2, 10, 1)
      |> Stage.set_puyo(1, 11, 1)

    # æ¶ˆå»åˆ¤å®š
    {erase_count, positions} = Stage.check_erase(stage)

    # æ¶ˆå»å¯¾è±¡ãŒãªã„ã“ã¨ã‚’ç¢ºèª
    assert erase_count == 0
    assert positions == []
  end

  test "detects vertical line of 4 puyos", %{stage: stage} do
    # ç¸¦ã«4ã¤ã®èµ¤ã·ã‚ˆã‚’é…ç½®
    stage =
      stage
      |> Stage.set_puyo(1, 8, 1)
      |> Stage.set_puyo(1, 9, 1)
      |> Stage.set_puyo(1, 10, 1)
      |> Stage.set_puyo(1, 11, 1)

    # æ¶ˆå»åˆ¤å®š
    {erase_count, _positions} = Stage.check_erase(stage)

    # 4ã¤ã®ã·ã‚ˆãŒæ¶ˆå»å¯¾è±¡ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    assert erase_count == 4
  end

  test "detects horizontal line of 4 puyos", %{stage: stage} do
    # æ¨ªã«4ã¤ã®èµ¤ã·ã‚ˆã‚’é…ç½®
    stage =
      stage
      |> Stage.set_puyo(1, 10, 1)
      |> Stage.set_puyo(2, 10, 1)
      |> Stage.set_puyo(3, 10, 1)
      |> Stage.set_puyo(4, 10, 1)

    # æ¶ˆå»åˆ¤å®š
    {erase_count, _positions} = Stage.check_erase(stage)

    # 4ã¤ã®ã·ã‚ˆãŒæ¶ˆå»å¯¾è±¡ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    assert erase_count == 4
  end
end
```

### å®Ÿè£…: æ¶ˆå»åˆ¤å®šï¼ˆæ·±ã•å„ªå…ˆæ¢ç´¢ï¼‰

æ¶ˆå»åˆ¤å®šã«ã¯ã€æ·±ã•å„ªå…ˆæ¢ç´¢ï¼ˆDFS: Depth-First Searchï¼‰ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€æ¥ç¶šã—ã¦ã„ã‚‹ã·ã‚ˆã‚’å†å¸°çš„ã«æ¢ç´¢ã™ã‚‹åŠ¹ç‡çš„ãªæ–¹æ³•ã§ã™ã€‚

```elixir
# lib/puyo_puyo/stage.exï¼ˆç¶šãï¼‰
@doc """
æ¶ˆå»åˆ¤å®šã‚’è¡Œã„ã¾ã™

4ã¤ä»¥ä¸Šæ¥ç¶šã—ã¦ã„ã‚‹åŒè‰²ã®ã·ã‚ˆã‚’æ¤œå‡ºã—ã¾ã™ã€‚
æ·±ã•å„ªå…ˆæ¢ç´¢ï¼ˆDFSï¼‰ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ä½¿ç”¨ã—ã¦ã€æ¥ç¶šã—ã¦ã„ã‚‹ã·ã‚ˆã‚’æ¢ç´¢ã—ã¾ã™ã€‚

## Returns

  {æ¶ˆå»ã™ã‚‹ã·ã‚ˆã®æ•°, æ¶ˆå»ã™ã‚‹ã·ã‚ˆã®ä½ç½®ãƒªã‚¹ãƒˆ}

## Examples

    iex> stage = PuyoPuyo.Stage.new([])
    iex> stage = stage
    ...> |> PuyoPuyo.Stage.set_puyo(1, 10, 1)
    ...> |> PuyoPuyo.Stage.set_puyo(2, 10, 1)
    ...> |> PuyoPuyo.Stage.set_puyo(1, 11, 1)
    ...> |> PuyoPuyo.Stage.set_puyo(2, 11, 1)
    iex> {count, _positions} = PuyoPuyo.Stage.check_erase(stage)
    iex> count
    4

"""
@spec check_erase(t()) :: {non_neg_integer(), [{non_neg_integer(), non_neg_integer()}]}
def check_erase(%__MODULE__{rows: rows, cols: cols} = stage) do
  # è¨ªå•æ¸ˆã¿ã‚»ãƒ«ã‚’è¨˜éŒ²ã™ã‚‹MapSet
  visited = MapSet.new()
  # æ¶ˆå»å¯¾è±¡ã®ã·ã‚ˆã®ä½ç½®ã‚’è¨˜éŒ²ã™ã‚‹ãƒªã‚¹ãƒˆ
  erase_positions = []

  # å…¨ã‚»ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
  {_visited, erase_positions} =
    Enum.reduce(0..(rows - 1), {visited, erase_positions}, fn row, {visited_acc, erase_acc} ->
      Enum.reduce(0..(cols - 1), {visited_acc, erase_acc}, fn col, {visited_inner, erase_inner} ->
        puyo_type = get_puyo(stage, col, row)
        position = {col, row}

        # ã·ã‚ˆãŒã‚ã‚Šã€ã¾ã è¨ªå•ã—ã¦ã„ãªã„å ´åˆ
        if puyo_type > 0 and not MapSet.member?(visited_inner, position) do
          # æ¥ç¶šã—ã¦ã„ã‚‹ã·ã‚ˆã‚’æ¢ç´¢
          {visited_after_search, connected} = search_connected(stage, col, row, puyo_type, visited_inner)

          # 4ã¤ä»¥ä¸Šæ¥ç¶šã—ã¦ã„ã‚‹å ´åˆã¯æ¶ˆå»å¯¾è±¡ã«è¿½åŠ 
          if length(connected) >= 4 do
            {visited_after_search, erase_inner ++ connected}
          else
            {visited_after_search, erase_inner}
          end
        else
          {visited_inner, erase_inner}
        end
      end)
    end)

  {length(erase_positions), erase_positions}
end

# æ·±ã•å„ªå…ˆæ¢ç´¢ã§æ¥ç¶šã—ã¦ã„ã‚‹ã·ã‚ˆã‚’æ¢ç´¢
@spec search_connected(t(), non_neg_integer(), non_neg_integer(), non_neg_integer(), MapSet.t()) ::
        {MapSet.t(), [{non_neg_integer(), non_neg_integer()}]}
defp search_connected(stage, x, y, puyo_type, visited) do
  position = {x, y}

  # è¨ªå•æ¸ˆã¿ã«ãƒãƒ¼ã‚¯
  visited = MapSet.put(visited, position)
  connected = [position]

  # 4æ–¹å‘ã‚’æ¢ç´¢
  directions = [{1, 0}, {-1, 0}, {0, 1}, {0, -1}]

  Enum.reduce(directions, {visited, connected}, fn {dx, dy}, {visited_acc, connected_acc} ->
    next_x = x + dx
    next_y = y + dy
    next_position = {next_x, next_y}

    # ç¯„å›²å†…ã€åŒã˜è‰²ã€æœªè¨ªå•ã®å ´åˆã¯å†å¸°çš„ã«æ¢ç´¢
    if get_puyo(stage, next_x, next_y) == puyo_type and not MapSet.member?(visited_acc, next_position) do
      {visited_after_recursion, connected_from_recursion} = search_connected(stage, next_x, next_y, puyo_type, visited_acc)
      {visited_after_recursion, connected_acc ++ connected_from_recursion}
    else
      {visited_acc, connected_acc}
    end
  end)
end
```

### è§£èª¬: æ·±ã•å„ªå…ˆæ¢ç´¢ï¼ˆDFSï¼‰

æ·±ã•å„ªå…ˆæ¢ç´¢ã¯ã€ã‚°ãƒ©ãƒ•ã‚„æœ¨æ§‹é€ ã®æ¢ç´¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ä¸€ã¤ã§ã™ã€‚ã·ã‚ˆã·ã‚ˆã®æ¶ˆå»åˆ¤å®šã§ã¯ã€åŒã˜è‰²ã®ã·ã‚ˆãŒæ¥ç¶šã—ã¦ã„ã‚‹ã‹ã‚’èª¿ã¹ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™ã€‚

#### ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®æµã‚Œ

1. **å…¨ã‚»ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯**: ãƒœãƒ¼ãƒ‰ä¸Šã®ã™ã¹ã¦ã®ã‚»ãƒ«ã‚’é †ç•ªã«èª¿ã¹ã¾ã™
2. **æœªè¨ªå•ã®ã·ã‚ˆã‚’ç™ºè¦‹**: ã·ã‚ˆãŒã‚ã‚Šã€ã¾ã è¨ªå•ã—ã¦ã„ãªã„ã‚»ãƒ«ã‚’è¦‹ã¤ã‘ã¾ã™
3. **æ¥ç¶šæ¢ç´¢é–‹å§‹**: ãã®ã·ã‚ˆã¨åŒã˜è‰²ã§æ¥ç¶šã—ã¦ã„ã‚‹ã·ã‚ˆã‚’å†å¸°çš„ã«æ¢ç´¢ã—ã¾ã™
4. **4æ–¹å‘ã‚’ãƒã‚§ãƒƒã‚¯**: å„ã·ã‚ˆã‹ã‚‰ä¸Šä¸‹å·¦å³ã®4æ–¹å‘ã‚’èª¿ã¹ã¾ã™
5. **åŒè‰²ã‹ã¤æœªè¨ªå•**: åŒã˜è‰²ã§æœªè¨ªå•ã®ã·ã‚ˆãŒã‚ã‚Œã°ã€å†å¸°çš„ã«æ¢ç´¢ã‚’ç¶šã‘ã¾ã™
6. **æ¥ç¶šæ•°åˆ¤å®š**: æ¥ç¶šã—ã¦ã„ã‚‹ã·ã‚ˆãŒ4ã¤ä»¥ä¸Šãªã‚‰ã€æ¶ˆå»å¯¾è±¡ã¨ã—ã¦è¨˜éŒ²ã—ã¾ã™

#### è¨ªå•æ¸ˆã¿ç®¡ç†

```elixir
visited = MapSet.new()
visited = MapSet.put(visited, position)
```

`MapSet`ã‚’ä½¿ã£ã¦è¨ªå•æ¸ˆã¿ã®ã‚»ãƒ«ã‚’ç®¡ç†ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šï¼š

- **é‡è¤‡æ¢ç´¢ã®é˜²æ­¢**: åŒã˜ã‚»ãƒ«ã‚’ä½•åº¦ã‚‚è¨ªå•ã—ãªã„
- **åŠ¹ç‡çš„ãªæ¤œç´¢**: O(1)ã®æ™‚é–“ã§è¨ªå•æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯ã§ãã‚‹

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

å®Ÿè£…ãŒå®Œäº†ã—ãŸã®ã§ã€ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```bash
mix test test/puyo_puyo/stage_test.exs
```

ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ï¼ˆGreenï¼‰ã€‚

### ãƒ†ã‚¹ãƒˆ: ã·ã‚ˆã®æ¶ˆå»ã¨è½ä¸‹

æ¬¡ã«ã€ã·ã‚ˆã®æ¶ˆå»ã¨è½ä¸‹å‡¦ç†ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

```elixir
# test/puyo_puyo/stage_test.exsï¼ˆç¶šãï¼‰
describe "Stage.erase_puyos/2" do
  setup do
    {:ok, stage: Stage.new([])}
  end

  test "erases puyos at specified positions", %{stage: stage} do
    # ã‚¹ãƒ†ãƒ¼ã‚¸ã«ã·ã‚ˆã‚’é…ç½®
    stage =
      stage
      |> Stage.set_puyo(1, 10, 1)
      |> Stage.set_puyo(2, 10, 1)
      |> Stage.set_puyo(1, 11, 1)
      |> Stage.set_puyo(2, 11, 1)

    # æ¶ˆå»åˆ¤å®š
    {_count, positions} = Stage.check_erase(stage)

    # æ¶ˆå»å®Ÿè¡Œ
    stage = Stage.erase_puyos(stage, positions)

    # ã·ã‚ˆãŒæ¶ˆå»ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    assert Stage.get_puyo(stage, 1, 10) == 0
    assert Stage.get_puyo(stage, 2, 10) == 0
    assert Stage.get_puyo(stage, 1, 11) == 0
    assert Stage.get_puyo(stage, 2, 11) == 0
  end
end

describe "Stage.fall/1" do
  setup do
    {:ok, stage: Stage.new([])}
  end

  test "makes puyos fall after erasure", %{stage: stage} do
    # ã‚¹ãƒ†ãƒ¼ã‚¸ã«ã·ã‚ˆã‚’é…ç½®
    # ä¸‹ã«èµ¤ã·ã‚ˆ4ã¤ï¼ˆ2Ã—2ï¼‰ã€ãã®ä¸Šã®åˆ—(x=2)ã«ç·‘ã·ã‚ˆ2ã¤
    stage =
      stage
      |> Stage.set_puyo(1, 10, 1)  # èµ¤
      |> Stage.set_puyo(2, 10, 1)  # èµ¤
      |> Stage.set_puyo(1, 11, 1)  # èµ¤
      |> Stage.set_puyo(2, 11, 1)  # èµ¤
      |> Stage.set_puyo(2, 8, 2)   # ç·‘
      |> Stage.set_puyo(2, 9, 2)   # ç·‘

    # æ¶ˆå»åˆ¤å®šã¨å®Ÿè¡Œ
    {_count, positions} = Stage.check_erase(stage)
    stage = Stage.erase_puyos(stage, positions)

    # è½ä¸‹å‡¦ç†
    stage = Stage.fall(stage)

    # ä¸Šã«ã‚ã£ãŸç·‘ã·ã‚ˆãŒè½ä¸‹ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    assert Stage.get_puyo(stage, 2, 10) == 2
    assert Stage.get_puyo(stage, 2, 11) == 2
  end
end
```

### å®Ÿè£…: ã·ã‚ˆã®æ¶ˆå»ã¨è½ä¸‹

```elixir
# lib/puyo_puyo/stage.exï¼ˆç¶šãï¼‰
@doc """
æŒ‡å®šã—ãŸä½ç½®ã®ã·ã‚ˆã‚’æ¶ˆå»ã—ã¾ã™

## Examples

    iex> stage = PuyoPuyo.Stage.new([])
    iex> stage = stage |> PuyoPuyo.Stage.set_puyo(1, 10, 1)
    iex> stage = PuyoPuyo.Stage.erase_puyos(stage, [{1, 10}])
    iex> PuyoPuyo.Stage.get_puyo(stage, 1, 10)
    0

"""
@spec erase_puyos(t(), [{non_neg_integer(), non_neg_integer()}]) :: t()
def erase_puyos(stage, positions) do
  Enum.reduce(positions, stage, fn {x, y}, stage_acc ->
    set_puyo(stage_acc, x, y, 0)
  end)
end

@doc """
ã·ã‚ˆã‚’è½ä¸‹ã•ã›ã¾ã™

å„åˆ—ã§ã€ä¸‹ã‹ã‚‰ä¸Šã«å‘ã‹ã£ã¦ã·ã‚ˆã‚’ãƒã‚§ãƒƒã‚¯ã—ã€
ä¸‹ã«ç©ºããŒã‚ã‚‹å ´åˆã¯è½ä¸‹ã•ã›ã¾ã™ã€‚

## Examples

    iex> stage = PuyoPuyo.Stage.new([])
    iex> stage = stage
    ...> |> PuyoPuyo.Stage.set_puyo(1, 5, 1)
    ...> |> PuyoPuyo.Stage.set_puyo(1, 10, 0)
    iex> stage = PuyoPuyo.Stage.fall(stage)
    iex> PuyoPuyo.Stage.get_puyo(stage, 1, 11)
    1

"""
@spec fall(t()) :: t()
def fall(%__MODULE__{rows: rows, cols: cols} = stage) do
  # å„åˆ—ã‚’å‡¦ç†
  Enum.reduce(0..(cols - 1), stage, fn col, stage_acc ->
    # ä¸‹ã‹ã‚‰ä¸Šã«å‘ã‹ã£ã¦å‡¦ç†
    Enum.reduce((rows - 2)..0, stage_acc, fn row, stage_inner ->
      puyo_type = get_puyo(stage_inner, col, row)

      if puyo_type > 0 do
        # ç¾åœ¨ã®ã·ã‚ˆã®ä¸‹ãŒç©ºã„ã¦ã„ã‚‹å ´åˆã€è½ä¸‹ã•ã›ã‚‹
        fall_puyo_in_column(stage_inner, col, row, puyo_type)
      else
        stage_inner
      end
    end)
  end)
end

# æŒ‡å®šã—ãŸåˆ—ã®ã·ã‚ˆã‚’å¯èƒ½ãªé™ã‚Šè½ä¸‹ã•ã›ã‚‹
@spec fall_puyo_in_column(t(), non_neg_integer(), non_neg_integer(), non_neg_integer()) :: t()
defp fall_puyo_in_column(%__MODULE__{rows: rows} = stage, col, start_row, puyo_type) do
  # è½ä¸‹å…ˆã‚’æ¢ã™
  fall_to_row =
    Enum.reduce_while((start_row + 1)..(rows - 1), start_row, fn row, _acc ->
      if get_puyo(stage, col, row) == 0 do
        {:cont, row}
      else
        {:halt, row - 1}
      end
    end)

  # è½ä¸‹å…ˆãŒç•°ãªã‚‹å ´åˆã¯ç§»å‹•
  if fall_to_row != start_row do
    stage
    |> set_puyo(col, fall_to_row, puyo_type)
    |> set_puyo(col, start_row, 0)
  else
    stage
  end
end
```

### è§£èª¬: ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ¼”ç®—å­

Elixirã§ã¯ã€ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ¼”ç®—å­ï¼ˆ`|>`ï¼‰ã‚’ä½¿ã£ã¦ã€é–¢æ•°å‘¼ã³å‡ºã—ã‚’é€£é–ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```elixir
stage
|> set_puyo(col, fall_to_row, puyo_type)
|> set_puyo(col, start_row, 0)
```

ã“ã‚Œã¯ä»¥ä¸‹ã¨åŒã˜æ„å‘³ã§ã™ï¼š

```elixir
stage2 = set_puyo(stage, col, fall_to_row, puyo_type)
stage3 = set_puyo(stage2, col, start_row, 0)
```

ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ¼”ç®—å­ã‚’ä½¿ã†ã“ã¨ã§ï¼š

1. **å¯èª­æ€§ã®å‘ä¸Š**: ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›ã®æµã‚ŒãŒæ˜ç¢ºã«ãªã‚‹
2. **å¤‰æ•°ã®å‰Šæ¸›**: ä¸­é–“å¤‰æ•°ã‚’å®šç¾©ã™ã‚‹å¿…è¦ãŒãªã„
3. **é–¢æ•°å‹ã‚¹ã‚¿ã‚¤ãƒ«**: ãƒ‡ãƒ¼ã‚¿å¤‰æ›ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¨ã—ã¦è¡¨ç¾ã§ãã‚‹

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

å®Ÿè£…ãŒå®Œäº†ã—ãŸã®ã§ã€ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```bash
mix test test/puyo_puyo/stage_test.exs
```

ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ï¼ˆGreenï¼‰ã€‚

### ãƒ†ã‚¹ãƒˆ: é‡åŠ›ã®é©ç”¨

æœ€å¾Œã«ã€1ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã«1ãƒã‚¹ãšã¤ã·ã‚ˆã‚’è½ä¸‹ã•ã›ã‚‹ã€Œé‡åŠ›ã€æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

```elixir
# test/puyo_puyo/stage_test.exsï¼ˆç¶šãï¼‰
describe "Stage.apply_gravity/1" do
  setup do
    {:ok, stage: Stage.new([])}
  end

  test "makes floating puyo fall one row", %{stage: stage} do
    # æµ®ã„ã¦ã„ã‚‹é’ã·ã‚ˆã‚’é…ç½®ï¼ˆä¸‹ã«ç©ºããŒã‚ã‚‹ï¼‰
    stage = Stage.set_puyo(stage, 4, 2, 2)

    # é‡åŠ›ã‚’é©ç”¨
    {has_fallen, stage} = Stage.apply_gravity(stage)

    # é’ã·ã‚ˆãŒ1ãƒã‚¹è½ã¡ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    assert has_fallen == true
    assert Stage.get_puyo(stage, 4, 2) == 0
    assert Stage.get_puyo(stage, 4, 3) == 2
  end

  test "returns false when no puyo falls", %{stage: stage} do
    # ã™ã¹ã¦ã®ã·ã‚ˆãŒæ”¯ãˆã‚‰ã‚Œã¦ã„ã‚‹çŠ¶æ…‹
    stage =
      stage
      |> Stage.set_puyo(2, 11, 1)
      |> Stage.set_puyo(3, 11, 2)

    # é‡åŠ›ã‚’é©ç”¨
    {has_fallen, _stage} = Stage.apply_gravity(stage)

    # ä½•ã‚‚è½ã¡ã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª
    assert has_fallen == false
  end

  test "makes multiple floating puyos fall", %{stage: stage} do
    # è¤‡æ•°ã®æµ®ã„ã¦ã„ã‚‹ã·ã‚ˆã‚’é…ç½®
    stage =
      stage
      |> Stage.set_puyo(1, 1, 1)
      |> Stage.set_puyo(2, 2, 2)
      |> Stage.set_puyo(3, 3, 3)

    # é‡åŠ›ã‚’é©ç”¨
    {has_fallen, stage} = Stage.apply_gravity(stage)

    # å…¨ã¦ã®ã·ã‚ˆãŒ1ãƒã‚¹è½ã¡ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    assert has_fallen == true
    assert Stage.get_puyo(stage, 1, 1) == 0
    assert Stage.get_puyo(stage, 1, 2) == 1
    assert Stage.get_puyo(stage, 2, 2) == 0
    assert Stage.get_puyo(stage, 2, 3) == 2
    assert Stage.get_puyo(stage, 3, 3) == 0
    assert Stage.get_puyo(stage, 3, 4) == 3
  end

  test "stops puyo at bottom", %{stage: stage} do
    # æœ€ä¸‹æ®µã®1ã¤ä¸Šã«ã·ã‚ˆã‚’é…ç½®
    stage = Stage.set_puyo(stage, 2, 10, 1)

    # é‡åŠ›ã‚’é©ç”¨ï¼ˆ1ãƒã‚¹è½ã¡ã‚‹ï¼‰
    {has_fallen, stage} = Stage.apply_gravity(stage)
    assert has_fallen == true
    assert Stage.get_puyo(stage, 2, 11) == 1

    # ã‚‚ã†ä¸€åº¦é‡åŠ›ã‚’é©ç”¨ï¼ˆã‚‚ã†è½ã¡ãªã„ï¼‰
    {has_fallen, _stage} = Stage.apply_gravity(stage)
    assert has_fallen == false
  end

  test "stops puyo on other puyo", %{stage: stage} do
    # åœŸå°ã®ã·ã‚ˆã¨ã€ãã®ä¸Šã®æµ®ã„ã¦ã„ã‚‹ã·ã‚ˆã‚’é…ç½®
    stage =
      stage
      |> Stage.set_puyo(2, 11, 1)  # åœŸå°
      |> Stage.set_puyo(2, 9, 2)   # æµ®ã„ã¦ã„ã‚‹ã·ã‚ˆ

    # é‡åŠ›ã‚’é©ç”¨ï¼ˆ1ãƒã‚¹è½ã¡ã‚‹ï¼‰
    {has_fallen, stage} = Stage.apply_gravity(stage)
    assert has_fallen == true
    assert Stage.get_puyo(stage, 2, 10) == 2

    # ã‚‚ã†ä¸€åº¦é‡åŠ›ã‚’é©ç”¨ï¼ˆåœŸå°ã®ã·ã‚ˆã®ä¸Šã§åœæ­¢ï¼‰
    {has_fallen, _stage} = Stage.apply_gravity(stage)
    assert has_fallen == false
  end
end
```

### å®Ÿè£…: é‡åŠ›ã®é©ç”¨

```elixir
# lib/puyo_puyo/stage.exï¼ˆç¶šãï¼‰
@doc """
é‡åŠ›ã‚’é©ç”¨ã—ã¾ã™ï¼ˆ1ãƒ•ãƒ¬ãƒ¼ãƒ ã§1ãƒã‚¹è½ä¸‹ï¼‰

ã™ã¹ã¦ã®ã·ã‚ˆã«å¯¾ã—ã¦ã€ä¸‹ã«ç§»å‹•ã§ãã‚‹å ´åˆã¯1ãƒã‚¹è½ä¸‹ã•ã›ã¾ã™ã€‚

## Returns

  {ã·ã‚ˆãŒè½ä¸‹ã—ãŸã‹ã©ã†ã‹, æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¸}

## Examples

    iex> stage = PuyoPuyo.Stage.new([])
    iex> stage = PuyoPuyo.Stage.set_puyo(stage, 1, 5, 1)
    iex> {has_fallen, stage} = PuyoPuyo.Stage.apply_gravity(stage)
    iex> has_fallen
    true
    iex> PuyoPuyo.Stage.get_puyo(stage, 1, 6)
    1

"""
@spec apply_gravity(t()) :: {boolean(), t()}
def apply_gravity(%__MODULE__{rows: rows, cols: cols} = stage) do
  # ä¸‹ã‹ã‚‰ä¸Šã«å‘ã‹ã£ã¦å‡¦ç†ï¼ˆä¸‹ã®ã·ã‚ˆã‹ã‚‰å…ˆã«å‡¦ç†ã™ã‚‹ï¼‰
  {has_fallen, new_stage} =
    Enum.reduce((rows - 2)..0, {false, stage}, fn row, {fallen_acc, stage_acc} ->
      # å·¦ã‹ã‚‰å³ã«å‡¦ç†
      Enum.reduce(0..(cols - 1), {fallen_acc, stage_acc}, fn col, {fallen_inner, stage_inner} ->
        puyo_type = get_puyo(stage_inner, col, row)

        # ã·ã‚ˆãŒã‚ã‚Šã€ä¸‹ãŒç©ºã„ã¦ã„ã‚‹å ´åˆ
        if puyo_type > 0 and get_puyo(stage_inner, col, row + 1) == 0 do
          # 1ãƒã‚¹è½ä¸‹
          new_stage_inner =
            stage_inner
            |> set_puyo(col, row + 1, puyo_type)
            |> set_puyo(col, row, 0)

          {true, new_stage_inner}
        else
          {fallen_inner, stage_inner}
        end
      end)
    end)

  {has_fallen, new_stage}
end
```

### è§£èª¬: ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã¨ã®çµ±åˆ

`apply_gravity/1`ã¯ã€ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã®ä¸­ã§æ¯ãƒ•ãƒ¬ãƒ¼ãƒ å‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

- **æˆ»ã‚Šå€¤**: `{has_fallen, new_stage}` ã®ã‚¿ãƒ—ãƒ«ã‚’è¿”ã—ã¾ã™
  - `has_fallen`: ã·ã‚ˆãŒè½ä¸‹ã—ãŸã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
  - `new_stage`: é‡åŠ›é©ç”¨å¾Œã®æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¸

- **ä½¿ç”¨ä¾‹**ï¼ˆã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—å†…ï¼‰:
  ```elixir
  case apply_gravity(stage) do
    {true, new_stage} ->
      # ã¾ã è½ä¸‹ä¸­
      {:cont, new_stage}
    {false, new_stage} ->
      # è½ä¸‹å®Œäº†ã€æ¬¡ã®å‡¦ç†ã¸
      {:halt, new_stage}
  end
  ```

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

å®Ÿè£…ãŒå®Œäº†ã—ãŸã®ã§ã€ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```bash
mix test test/puyo_puyo/stage_test.exs
```

ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ï¼ˆGreenï¼‰ã€‚

### LiveViewã¨ã®çµ±åˆ

Stageãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå®Œæˆã—ãŸã®ã§ã€GameLiveã¨çµ±åˆã—ã¾ã™ã€‚

```elixir
# lib/puyo_puyo_web/live/game_live.exï¼ˆæ›´æ–°ï¼‰
defmodule PuyoPuyoWeb.GameLive do
  use PuyoPuyoWeb, :live_view

  alias PuyoPuyo.Stage

  # ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ ...

  @impl true
  def mount(_params, _session, socket) do
    # Stageãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨
    stage = Stage.new([])

    socket =
      socket
      |> assign(:mode, :start)
      |> assign(:score, 0)
      |> assign(:chain, 0)
      |> assign(:stage, stage)

    {:ok, socket}
  end

  @impl true
  def render(assigns) do
    ~H"""
    <div id="game-container" class="flex gap-8 p-8">
      <div id="game-board" class="relative bg-gray-100 border-2 border-gray-800 rounded-lg">
        <div class="grid" style={"grid-template-columns: repeat(#{@stage.cols}, 32px);"}>
          <%= for row <- 0..(@stage.rows - 1) do %>
            <%= for col <- 0..(@stage.cols - 1) do %>
              <div
                class="border border-gray-300"
                style="width: 32px; height: 32px;"
              >
                <%= render_puyo(Stage.get_puyo(@stage, col, row)) %>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>

      <div id="info-panel" class="bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-bold mb-4">ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ </h2>

        <div class="mb-4">
          <h3 class="text-lg font-semibold">ã‚¹ã‚³ã‚¢</h3>
          <p id="score" class="text-3xl font-bold text-blue-600"><%= @score %></p>
        </div>

        <div class="mb-4">
          <h3 class="text-lg font-semibold">é€£é–æ•°</h3>
          <p id="chain" class="text-3xl font-bold text-red-600"><%= @chain %></p>
        </div>

        <div class="mt-6 text-sm text-gray-600">
          <h3 class="font-semibold mb-2">æ“ä½œæ–¹æ³•</h3>
          <ul class="space-y-1">
            <li>â† â†’: ç§»å‹•</li>
            <li>â†‘: å›è»¢</li>
            <li>â†“: é«˜é€Ÿè½ä¸‹</li>
          </ul>
        </div>
      </div>
    </div>
    """
  end

  # ... æ—¢å­˜ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆé–¢æ•° ...
end
```

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆçµ±åˆãƒ†ã‚¹ãƒˆï¼‰

æœ€å¾Œã«ã€ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã€çµ±åˆãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ï¼š

```bash
mix test
```

ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ï¼ˆGreenï¼‰ã€‚

### ã‚³ãƒŸãƒƒãƒˆ

æ©Ÿèƒ½ãŒå®Œæˆã—ãŸã®ã§ã€ã‚³ãƒŸãƒƒãƒˆã—ã¾ã—ã‚‡ã†ï¼š

```bash
git add -A
git commit -m "feat: ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å®Ÿè£…

- Stageãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆï¼ˆlib/puyo_puyo/stage.exï¼‰
- ä¸å¤‰ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«ã‚ˆã‚‹ã‚¹ãƒ†ãƒ¼ã‚¸çŠ¶æ…‹ç®¡ç†
- ã·ã‚ˆã®é…ç½®ãƒ»å–å¾—æ©Ÿèƒ½ï¼ˆset_puyo/4, get_puyo/3ï¼‰
- æ¶ˆå»åˆ¤å®šæ©Ÿèƒ½ï¼ˆcheck_erase/1ï¼‰
  - æ·±ã•å„ªå…ˆæ¢ç´¢ï¼ˆDFSï¼‰ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
  - 4ã¤ä»¥ä¸Šã®åŒè‰²ã·ã‚ˆã®æ¥ç¶šåˆ¤å®š
- ã·ã‚ˆã®æ¶ˆå»æ©Ÿèƒ½ï¼ˆerase_puyos/2ï¼‰
- è½ä¸‹å‡¦ç†ï¼ˆfall/1ï¼‰
- é‡åŠ›é©ç”¨ï¼ˆapply_gravity/1ï¼‰
  - 1ãƒ•ãƒ¬ãƒ¼ãƒ ã§1ãƒã‚¹è½ä¸‹
- GameLiveã¨ã®çµ±åˆ
- åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ï¼ˆ11ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼‰

ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³2å®Œäº†"
```

### ã¾ã¨ã‚

ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³2ã§ä»¥ä¸‹ã‚’é”æˆã—ã¾ã—ãŸï¼š

#### å¾—ã‚‰ã‚ŒãŸã‚‚ã®

1. **Stageãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**
   - ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤ã®åˆ†é›¢
   - ä¸å¤‰ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«ã‚ˆã‚‹çŠ¶æ…‹ç®¡ç†
   - æ§‹é€ ä½“ã¨ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã®æ´»ç”¨

2. **ã·ã‚ˆã®é…ç½®ãƒ»å–å¾—æ©Ÿèƒ½**
   - `set_puyo/4`: ã·ã‚ˆã‚’è¨­å®š
   - `get_puyo/3`: ã·ã‚ˆã‚’å–å¾—
   - ç¯„å›²å¤–ãƒã‚§ãƒƒã‚¯

3. **æ¶ˆå»åˆ¤å®šæ©Ÿèƒ½**
   - æ·±ã•å„ªå…ˆæ¢ç´¢ï¼ˆDFSï¼‰ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
   - MapSetã«ã‚ˆã‚‹è¨ªå•æ¸ˆã¿ç®¡ç†
   - 4ã¤ä»¥ä¸Šã®åŒè‰²ã·ã‚ˆã®æ¤œå‡º

4. **æ¶ˆå»ã¨è½ä¸‹æ©Ÿèƒ½**
   - `erase_puyos/2`: ã·ã‚ˆã®æ¶ˆå»
   - `fall/1`: æ¶ˆå»å¾Œã®è½ä¸‹å‡¦ç†
   - `apply_gravity/1`: 1ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã®é‡åŠ›é©ç”¨

5. **LiveViewã¨ã®çµ±åˆ**
   - GameLiveã§Stageãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨
   - ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã®ã‚¹ãƒ†ãƒ¼ã‚¸çŠ¶æ…‹ç®¡ç†

#### å­¦ã‚“ã ã“ã¨

1. **ä¸å¤‰ãƒ‡ãƒ¼ã‚¿æ§‹é€ **
   - Elixirã®ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸å¤‰
   - æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™ã“ã¨ã§çŠ¶æ…‹ã‚’æ›´æ–°
   - äºˆæ¸¬å¯èƒ½ã§å®‰å…¨ãªã‚³ãƒ¼ãƒ‰

2. **ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°**
   - é–¢æ•°ã®å¼•æ•°ã§ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°
   - æ§‹é€ ä½“ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹
   - æ¡ä»¶åˆ†å²ã®ç°¡æ½”ãªè¡¨ç¾

3. **ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ¼”ç®—å­**
   - `|>` ã§ãƒ‡ãƒ¼ã‚¿å¤‰æ›ã‚’é€£é–
   - å¯èª­æ€§ã®å‘ä¸Š
   - é–¢æ•°å‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®ã‚¹ã‚¿ã‚¤ãƒ«

4. **æ·±ã•å„ªå…ˆæ¢ç´¢ï¼ˆDFSï¼‰**
   - ã‚°ãƒ©ãƒ•æ¢ç´¢ã®åŸºæœ¬ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
   - å†å¸°çš„ãªå®Ÿè£…
   - è¨ªå•æ¸ˆã¿ç®¡ç†ã®é‡è¦æ€§

5. **ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™º**
   - Red-Green-Refactorã‚µã‚¤ã‚¯ãƒ«
   - å°ã•ãªã‚¹ãƒ†ãƒƒãƒ—ã§ç¢ºå®Ÿã«
   - åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

#### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

ã‚¹ãƒ†ãƒ¼ã‚¸ã®åŸºæœ¬æ©Ÿèƒ½ãŒå®Œæˆã—ã¾ã—ãŸã€‚æ¬¡ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ä»¥ä¸‹ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ï¼š

- **ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³3**: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å®Ÿè£…ï¼ˆã·ã‚ˆã®ç§»å‹•ã¨å›è»¢ï¼‰
- **ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³4**: ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã®å®Ÿè£…ï¼ˆé‡åŠ›ã¨è½ä¸‹ï¼‰
- **ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³5**: ã‚¹ã‚³ã‚¢ã¨é€£é–ã®å®Ÿè£…
- **ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³6**: ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã®å®Ÿè£…

ã“ã‚Œã‚‰ã‚’ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®ã‚µã‚¤ã‚¯ãƒ«ã«å¾“ã£ã¦ã€ä¸€ã¤ãšã¤å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã†ï¼

## å‚è€ƒè³‡æ–™

### å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [Phoenix Framework](https://www.phoenixframework.org/)
- [Phoenix LiveView](https://hexdocs.pm/phoenix_live_view/Phoenix.LiveView.html)
- [Elixirå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://elixir-lang.org/docs.html)
- [Mix documentation](https://hexdocs.pm/mix/Mix.html)

### ä½¿ç”¨ãƒ„ãƒ¼ãƒ«
- [Credo](https://github.com/rrrene/credo) - é™çš„ã‚³ãƒ¼ãƒ‰è§£æ
- [ExCoveralls](https://github.com/parroty/excoveralls) - ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸
- [mix_test_watch](https://github.com/lpil/mix-test.watch) - ãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦–
- [Dialyxir](https://github.com/jeremyjh/dialyxir) - å‹è§£æ

### å‚è€ƒè¨˜äº‹
- [Angularã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´„](https://github.com/angular/angular/blob/master/CONTRIBUTING.md#commit)
- [Phoenix LiveViewå…¥é–€](https://hexdocs.pm/phoenix_live_view/Phoenix.LiveView.html#module-bindings)

---

## ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³3: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å®Ÿè£…

ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³2ã§ã‚¹ãƒ†ãƒ¼ã‚¸ã®å®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸã€‚æ¬¡ã¯ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ“ä½œã™ã‚‹ã€Œè½ã¡ã¦ãã‚‹ã·ã‚ˆãƒšã‚¢ã€ã®å®Ÿè£…ã§ã™ã€‚ã“ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç§»å‹•ã€å›è»¢ã€ç€åœ°ã¨ã„ã£ãŸæ“ä½œã«é–¢ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

> å˜ä¸€è²¬ä»»ã®åŸå‰‡
>
> ã‚¯ãƒ©ã‚¹ã‚’å¤‰æ›´ã™ã‚‹ç†ç”±ã¯1ã¤ä»¥ä¸Šå­˜åœ¨ã—ã¦ã¯ãªã‚‰ãªã„ã€‚
>
> â€” Robert C. Martin ã€Clean Architectureã€

ä»Šå›å®Ÿè£…ã™ã‚‹Playerãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ã€ã€Œãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ“ä½œã™ã‚‹ã·ã‚ˆãƒšã‚¢ã®çŠ¶æ…‹ã¨æŒ¯ã‚‹èˆã„ã€ã¨ã„ã†å˜ä¸€ã®è²¬ä»»ã‚’æŒã¡ã¾ã™ã€‚ã‚¹ãƒ†ãƒ¼ã‚¸ã®ç®¡ç†ã¯Stageãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒã€ã‚¹ã‚³ã‚¢ã®ç®¡ç†ã¯Scoreãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒæ‹…å½“ã—ã€ãã‚Œãã‚ŒãŒæ˜ç¢ºã«åˆ†é›¢ã•ã‚Œã¦ã„ã¾ã™ã€‚

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼

ã“ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å®Ÿè£…ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ï¼š

> ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ã€è½ã¡ã¦ãã‚‹ã·ã‚ˆãƒšã‚¢ã‚’å·¦å³ã«ç§»å‹•ã—ã€å›è»¢ã§ãã‚‹

ã“ã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã«ã¯ã€ä»¥ä¸‹ã®æ©Ÿèƒ½ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼š

1. ã·ã‚ˆãƒšã‚¢ã®ç”Ÿæˆï¼ˆè»¸ã·ã‚ˆã¨æ¬¡ã·ã‚ˆã®2ã¤ï¼‰
2. å·¦å³ã¸ã®ç§»å‹•
3. å›è»¢ï¼ˆå£ã‚­ãƒƒã‚¯å‡¦ç†ã‚’å«ã‚€ï¼‰
4. ç€åœ°åˆ¤å®šã¨ç€åœ°å‡¦ç†

ãã‚Œã§ã¯ã€ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã‚’ä¸€ã¤ãšã¤ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã§å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã†ï¼

### TODOãƒªã‚¹ãƒˆ

ã€Œãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å®Ÿè£…ã€ã¨ã„ã†ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®ã‚¿ã‚¹ã‚¯ãŒå¿…è¦ã§ã™ï¼š

- Playerãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹ï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤ï¼‰
- ã·ã‚ˆãƒšã‚¢ã®ç”Ÿæˆæ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹
- å·¦å³ç§»å‹•æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ï¼ˆå¢ƒç•Œãƒã‚§ãƒƒã‚¯ã€è¡çªåˆ¤å®šï¼‰
- å›è»¢æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ï¼ˆå£ã‚­ãƒƒã‚¯å‡¦ç†ï¼‰
- ç€åœ°åˆ¤å®šã¨ç€åœ°å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹
- GameLiveã¨çµ±åˆã™ã‚‹ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›ï¼‰
- ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã¨çµ±åˆã™ã‚‹

ã“ã‚Œã‚‰ã®ã‚¿ã‚¹ã‚¯ã‚’ä¸€ã¤ãšã¤å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚ã¾ãšã¯ã€Œã·ã‚ˆãƒšã‚¢ã®ç”Ÿæˆã€ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†ï¼

### ãƒ†ã‚¹ãƒˆ: ã·ã‚ˆãƒšã‚¢ã®ç”Ÿæˆ

ã¾ãšã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ“ä½œã™ã‚‹ã€Œã·ã‚ˆãƒšã‚¢ã€ã‚’ç”Ÿæˆã™ã‚‹æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚ã·ã‚ˆãƒšã‚¢ã¯ã€è»¸ã·ã‚ˆï¼ˆå›è»¢ã®ä¸­å¿ƒï¼‰ã¨æ¬¡ã·ã‚ˆï¼ˆè»¸ã·ã‚ˆã«å¯¾ã—ã¦ç›¸å¯¾ä½ç½®ã‚’æŒã¤ï¼‰ã®2ã¤ã§æ§‹æˆã•ã‚Œã¾ã™ã€‚

```elixir
# test/puyo_puyo/player_test.exs
defmodule PuyoPuyo.PlayerTest do
  use ExUnit.Case, async: true

  alias PuyoPuyo.{Player, Stage}

  describe "Player.new/1" do
    test "creates a new player with default position" do
      stage = Stage.new([])
      player = Player.new(stage)

      # åˆæœŸä½ç½®ã¯x=2, y=0
      assert player.puyo_x == 2
      assert player.puyo_y == 0
      # åˆæœŸå›è»¢çŠ¶æ…‹ã¯0ï¼ˆä¸Šå‘ãï¼‰
      assert player.rotation == 0
      # æœªç€åœ°
      assert player.landed == false
    end

    test "creates a player with random puyo types" do
      stage = Stage.new([])
      player = Player.new(stage)

      # ã·ã‚ˆã®ç¨®é¡ã¯1-4ã®ç¯„å›²
      assert player.puyo_type in 1..4
      assert player.next_puyo_type in 1..4
    end
  end

  describe "Player.can_spawn?/1" do
    test "returns true when spawn position is empty" do
      stage = Stage.new([])
      player = Player.new(stage)

      assert Player.can_spawn?(player, stage) == true
    end

    test "returns false when spawn position is occupied" do
      stage = Stage.new([])
      # åˆæœŸä½ç½®(2, 0)ã«ã·ã‚ˆã‚’é…ç½®
      stage = Stage.set_puyo(stage, 2, 0, 1)

      player = Player.new(stage)

      assert Player.can_spawn?(player, stage) == false
    end
  end
end
```

### å®Ÿè£…: Player ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®åŸºæœ¬æ§‹é€ 

ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨å¤±æ•—ã—ã¾ã™ï¼ˆRedï¼‰ã€‚ã§ã¯ã€ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã‚ˆã†ã«æœ€å°é™ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã—ã¾ã—ã‚‡ã†ï¼ˆGreenï¼‰ã€‚

```elixir
# lib/puyo_puyo/player.ex
defmodule PuyoPuyo.Player do
  @moduledoc """
  ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆæ“ä½œã™ã‚‹ã·ã‚ˆãƒšã‚¢ï¼‰ã‚’ç®¡ç†ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

  ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã€è»¸ã·ã‚ˆã¨æ¬¡ã·ã‚ˆã®2ã¤ã®ã·ã‚ˆã§æ§‹æˆã•ã‚Œã¾ã™ã€‚
  è»¸ã·ã‚ˆã‚’ä¸­å¿ƒã«å›è»¢ã—ã€å·¦å³ã«ç§»å‹•ã§ãã¾ã™ã€‚
  """

  alias PuyoPuyo.Stage

  @type t :: %__MODULE__{
          puyo_x: non_neg_integer(),
          puyo_y: integer(),
          puyo_type: non_neg_integer(),
          next_puyo_type: non_neg_integer(),
          rotation: 0..3,
          landed: boolean()
        }

  defstruct [
    :puyo_x,
    :puyo_y,
    :puyo_type,
    :next_puyo_type,
    :rotation,
    :landed
  ]

  # åˆæœŸä½ç½®
  @initial_x 2
  @initial_y 0

  # ã·ã‚ˆã®ç¨®é¡ã®ç¯„å›²
  @min_puyo_type 1
  @max_puyo_type 4

  # å›è»¢çŠ¶æ…‹ã”ã¨ã®2ã¤ç›®ã®ã·ã‚ˆã®ã‚ªãƒ•ã‚»ãƒƒãƒˆ
  # 0: ä¸Š, 1: å³, 2: ä¸‹, 3: å·¦
  @offset_x [0, 1, 0, -1]
  @offset_y [-1, 0, 1, 0]

  @doc """
  æ–°ã—ã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½œæˆã—ã¾ã™

  ## Examples

      iex> stage = PuyoPuyo.Stage.new([])
      iex> player = PuyoPuyo.Player.new(stage)
      iex> player.puyo_x
      2

  """
  @spec new(Stage.t()) :: t()
  def new(_stage) do
    %__MODULE__{
      puyo_x: @initial_x,
      puyo_y: @initial_y,
      puyo_type: random_puyo_type(),
      next_puyo_type: random_puyo_type(),
      rotation: 0,
      landed: false
    }
  end

  @doc """
  ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç”Ÿæˆå¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯ã—ã¾ã™

  åˆæœŸä½ç½®ã«ã·ã‚ˆãŒå­˜åœ¨ã—ãªã„ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚

  ## Examples

      iex> stage = PuyoPuyo.Stage.new([])
      iex> player = PuyoPuyo.Player.new(stage)
      iex> PuyoPuyo.Player.can_spawn?(player, stage)
      true

  """
  @spec can_spawn?(t(), Stage.t()) :: boolean()
  def can_spawn?(%__MODULE__{puyo_x: x, puyo_y: y}, stage) do
    Stage.get_puyo(stage, x, y) == 0
  end

  # ãƒ©ãƒ³ãƒ€ãƒ ãªã·ã‚ˆã®ç¨®é¡ã‚’ç”Ÿæˆ
  @spec random_puyo_type() :: non_neg_integer()
  defp random_puyo_type do
    Enum.random(@min_puyo_type..@max_puyo_type)
  end
end
```

### è§£èª¬: ã·ã‚ˆãƒšã‚¢ã®è¨­è¨ˆ

å®Ÿè£…ã—ãŸPlayerãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã¤ã„ã¦ã€ã„ãã¤ã‹é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’è§£èª¬ã—ã¾ã™ã€‚

#### ã·ã‚ˆãƒšã‚¢ã®æ§‹æˆ

```elixir
defstruct [
  :puyo_x,           # è»¸ã·ã‚ˆã®Xåº§æ¨™
  :puyo_y,           # è»¸ã·ã‚ˆã®Yåº§æ¨™
  :puyo_type,        # è»¸ã·ã‚ˆã®ç¨®é¡
  :next_puyo_type,   # æ¬¡ã·ã‚ˆã®ç¨®é¡
  :rotation,         # å›è»¢çŠ¶æ…‹ï¼ˆ0-3ï¼‰
  :landed            # ç€åœ°ãƒ•ãƒ©ã‚°
]
```

ã·ã‚ˆãƒšã‚¢ã¯ã€ä»¥ä¸‹ã®æƒ…å ±ã‚’æŒã¡ã¾ã™ï¼š

- **è»¸ã·ã‚ˆ**: å›è»¢ã®ä¸­å¿ƒã¨ãªã‚‹ã·ã‚ˆ
- **æ¬¡ã·ã‚ˆ**: è»¸ã·ã‚ˆã«å¯¾ã—ã¦ç›¸å¯¾çš„ãªä½ç½®ã‚’æŒã¤ã·ã‚ˆ
- **å›è»¢çŠ¶æ…‹**: 0ï¼ˆä¸Šï¼‰ã€1ï¼ˆå³ï¼‰ã€2ï¼ˆä¸‹ï¼‰ã€3ï¼ˆå·¦ï¼‰ã®4ã¤ã®çŠ¶æ…‹

#### ã‚ªãƒ•ã‚»ãƒƒãƒˆé…åˆ—

```elixir
@offset_x [0, 1, 0, -1]
@offset_y [-1, 0, 1, 0]
```

å›è»¢çŠ¶æ…‹ã«å¿œã˜ãŸ2ã¤ç›®ã®ã·ã‚ˆã®ç›¸å¯¾ä½ç½®ã‚’å®šç¾©ã—ã¾ã™ï¼š

- **å›è»¢0ï¼ˆä¸Šï¼‰**: (0, -1) - è»¸ã·ã‚ˆã®ä¸Š
- **å›è»¢1ï¼ˆå³ï¼‰**: (1, 0) - è»¸ã·ã‚ˆã®å³
- **å›è»¢2ï¼ˆä¸‹ï¼‰**: (0, 1) - è»¸ã·ã‚ˆã®ä¸‹
- **å›è»¢3ï¼ˆå·¦ï¼‰**: (-1, 0) - è»¸ã·ã‚ˆã®å·¦

#### ãƒ©ãƒ³ãƒ€ãƒ ãªã·ã‚ˆã®ç”Ÿæˆ

```elixir
defp random_puyo_type do
  Enum.random(@min_puyo_type..@max_puyo_type)
end
```

`Enum.random/1`ã‚’ä½¿ã£ã¦ã€1-4ã®ãƒ©ãƒ³ãƒ€ãƒ ãªã·ã‚ˆã®ç¨®é¡ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

å®Ÿè£…ãŒå®Œäº†ã—ãŸã®ã§ã€ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```bash
mix test test/puyo_puyo/player_test.exs
```

ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ï¼ˆGreenï¼‰ã€‚

### ãƒ†ã‚¹ãƒˆ: å·¦å³ç§»å‹•

æ¬¡ã«ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã·ã‚ˆãƒšã‚¢ã‚’å·¦å³ã«ç§»å‹•ã™ã‚‹æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

```elixir
# test/puyo_puyo/player_test.exsï¼ˆç¶šãï¼‰
describe "Player.move_left/2" do
  setup do
    stage = Stage.new([])
    player = Player.new(stage)
    {:ok, stage: stage, player: player}
  end

  test "moves player left", %{stage: stage, player: player} do
    initial_x = player.puyo_x
    player = Player.move_left(player, stage)

    assert player.puyo_x == initial_x - 1
  end

  test "does not move left beyond left boundary", %{stage: stage, player: player} do
    # å·¦ç«¯ã¾ã§ç§»å‹•
    player = %{player | puyo_x: 0}

    # ã•ã‚‰ã«å·¦ã«ç§»å‹•ã—ã‚ˆã†ã¨ã™ã‚‹
    player = Player.move_left(player, stage)

    # ä½ç½®ãŒå¤‰ã‚ã‚‰ãªã„ã“ã¨ã‚’ç¢ºèª
    assert player.puyo_x == 0
  end

  test "does not move left when collision with puyo", %{stage: stage, player: player} do
    # å·¦éš£ã«ã·ã‚ˆã‚’é…ç½®
    stage = Stage.set_puyo(stage, player.puyo_x - 1, player.puyo_y, 1)

    initial_x = player.puyo_x
    player = Player.move_left(player, stage)

    # ä½ç½®ãŒå¤‰ã‚ã‚‰ãªã„ã“ã¨ã‚’ç¢ºèª
    assert player.puyo_x == initial_x
  end

  test "does not move left when second puyo would collide", %{stage: stage, player: player} do
    # æ¨ªå‘ãï¼ˆå›è»¢çŠ¶æ…‹1ï¼‰ã«ã™ã‚‹
    player = %{player | rotation: 1}

    # 2ã¤ç›®ã®ã·ã‚ˆã®å·¦éš£ï¼ˆè»¸ã·ã‚ˆã®ä½ç½®ï¼‰ã«ã·ã‚ˆã‚’é…ç½®
    stage = Stage.set_puyo(stage, player.puyo_x, player.puyo_y, 1)

    # å·¦ã«ç§»å‹•ã—ã‚ˆã†ã¨ã™ã‚‹
    player = Player.move_left(player, stage)

    # ç§»å‹•ã§ããªã„ã“ã¨ã‚’ç¢ºèªï¼ˆ2ã¤ç›®ã®ã·ã‚ˆã®ä½ç½®ã«æ—¢ã«ã·ã‚ˆãŒã‚ã‚‹ï¼‰
    assert player.puyo_x == @initial_x
  end
end

describe "Player.move_right/2" do
  setup do
    stage = Stage.new([])
    player = Player.new(stage)
    {:ok, stage: stage, player: player}
  end

  test "moves player right", %{stage: stage, player: player} do
    initial_x = player.puyo_x
    player = Player.move_right(player, stage)

    assert player.puyo_x == initial_x + 1
  end

  test "does not move right beyond right boundary", %{stage: stage, player: player} do
    # å³ç«¯ã¾ã§ç§»å‹•ï¼ˆåˆ—æ•°ã¯6ãªã®ã§ã€x=5ãŒå³ç«¯ï¼‰
    player = %{player | puyo_x: 5}

    # ã•ã‚‰ã«å³ã«ç§»å‹•ã—ã‚ˆã†ã¨ã™ã‚‹
    player = Player.move_right(player, stage)

    # ä½ç½®ãŒå¤‰ã‚ã‚‰ãªã„ã“ã¨ã‚’ç¢ºèª
    assert player.puyo_x == 5
  end

  test "does not move right when collision with puyo", %{stage: stage, player: player} do
    # å³éš£ã«ã·ã‚ˆã‚’é…ç½®
    stage = Stage.set_puyo(stage, player.puyo_x + 1, player.puyo_y, 1)

    initial_x = player.puyo_x
    player = Player.move_right(player, stage)

    # ä½ç½®ãŒå¤‰ã‚ã‚‰ãªã„ã“ã¨ã‚’ç¢ºèª
    assert player.puyo_x == initial_x
  end
end
```

### å®Ÿè£…: å·¦å³ç§»å‹•

```elixir
# lib/puyo_puyo/player.exï¼ˆç¶šãï¼‰
@doc """
ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å·¦ã«ç§»å‹•ã—ã¾ã™

## Examples

    iex> stage = PuyoPuyo.Stage.new([])
    iex> player = PuyoPuyo.Player.new(stage)
    iex> player = PuyoPuyo.Player.move_left(player, stage)
    iex> player.puyo_x
    1

"""
@spec move_left(t(), Stage.t()) :: t()
def move_left(%__MODULE__{puyo_x: x, puyo_y: y, rotation: rotation} = player, stage) do
  next_x = x - 1
  second_puyo_x = next_x + Enum.at(@offset_x, rotation)
  second_puyo_y = y + Enum.at(@offset_y, rotation)

  # ç¯„å›²ãƒã‚§ãƒƒã‚¯
  if next_x >= 0 and second_puyo_x >= 0 and second_puyo_x < stage.cols do
    # è¡çªãƒã‚§ãƒƒã‚¯
    axis_puyo_clear = if y >= 0 and y < stage.rows, do: Stage.get_puyo(stage, next_x, y) == 0, else: true
    second_puyo_clear = if second_puyo_y >= 0 and second_puyo_y < stage.rows, do: Stage.get_puyo(stage, second_puyo_x, second_puyo_y) == 0, else: true

    if axis_puyo_clear and second_puyo_clear do
      %{player | puyo_x: next_x}
    else
      player
    end
  else
    player
  end
end

@doc """
ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å³ã«ç§»å‹•ã—ã¾ã™

## Examples

    iex> stage = PuyoPuyo.Stage.new([])
    iex> player = PuyoPuyo.Player.new(stage)
    iex> player = PuyoPuyo.Player.move_right(player, stage)
    iex> player.puyo_x
    3

"""
@spec move_right(t(), Stage.t()) :: t()
def move_right(%__MODULE__{puyo_x: x, puyo_y: y, rotation: rotation} = player, stage) do
  next_x = x + 1
  second_puyo_x = next_x + Enum.at(@offset_x, rotation)
  second_puyo_y = y + Enum.at(@offset_y, rotation)

  # ç¯„å›²ãƒã‚§ãƒƒã‚¯
  if next_x < stage.cols and second_puyo_x >= 0 and second_puyo_x < stage.cols do
    # è¡çªãƒã‚§ãƒƒã‚¯
    axis_puyo_clear = if y >= 0 and y < stage.rows, do: Stage.get_puyo(stage, next_x, y) == 0, else: true
    second_puyo_clear = if second_puyo_y >= 0 and second_puyo_y < stage.rows, do: Stage.get_puyo(stage, second_puyo_x, second_puyo_y) == 0, else: true

    if axis_puyo_clear and second_puyo_clear do
      %{player | puyo_x: next_x}
    else
      player
    end
  else
    player
  end
end
```

### è§£èª¬: è¡çªåˆ¤å®š

å·¦å³ç§»å‹•ã®å®Ÿè£…ã§ã¯ã€ä»¥ä¸‹ã®3ã¤ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã„ã¾ã™ï¼š

1. **ç¯„å›²ãƒã‚§ãƒƒã‚¯**: ç§»å‹•å…ˆãŒã‚¹ãƒ†ãƒ¼ã‚¸ã®ç¯„å›²å†…ã‹
2. **è»¸ã·ã‚ˆã®è¡çªãƒã‚§ãƒƒã‚¯**: ç§»å‹•å…ˆã«æ—¢ã«ã·ã‚ˆãŒå­˜åœ¨ã—ãªã„ã‹
3. **æ¬¡ã·ã‚ˆã®è¡çªãƒã‚§ãƒƒã‚¯**: æ¬¡ã·ã‚ˆã®ç§»å‹•å…ˆã«æ—¢ã«ã·ã‚ˆãŒå­˜åœ¨ã—ãªã„ã‹

```elixir
axis_puyo_clear = if y >= 0 and y < stage.rows, do: Stage.get_puyo(stage, next_x, y) == 0, else: true
second_puyo_clear = if second_puyo_y >= 0 and second_puyo_y < stage.rows, do: Stage.get_puyo(stage, second_puyo_x, second_puyo_y) == 0, else: true
```

ç¯„å›²å¤–ã®å ´åˆã¯è¡çªãªã—ã¨ã—ã¦æ‰±ã„ï¼ˆ`else: true`ï¼‰ã€ç¯„å›²å†…ã®å ´åˆã®ã¿è¡çªãƒã‚§ãƒƒã‚¯ã‚’è¡Œã„ã¾ã™ã€‚

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

å®Ÿè£…ãŒå®Œäº†ã—ãŸã®ã§ã€ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```bash
mix test test/puyo_puyo/player_test.exs
```

ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ï¼ˆGreenï¼‰ã€‚

### ãƒ†ã‚¹ãƒˆ: å›è»¢

æ¬¡ã«ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã·ã‚ˆãƒšã‚¢ã‚’å›è»¢ã™ã‚‹æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚å›è»¢ã§ã¯ã€Œå£ã‚­ãƒƒã‚¯ã€ã¨ã„ã†å‡¦ç†ãŒé‡è¦ã«ãªã‚Šã¾ã™ã€‚

```elixir
# test/puyo_puyo/player_test.exsï¼ˆç¶šãï¼‰
describe "Player.rotate_right/2" do
  setup do
    stage = Stage.new([])
    player = Player.new(stage)
    {:ok, stage: stage, player: player}
  end

  test "rotates player right", %{stage: stage, player: player} do
    # åˆæœŸçŠ¶æ…‹ã¯0ï¼ˆä¸Šå‘ãï¼‰
    assert player.rotation == 0

    # å³å›è»¢
    player = Player.rotate_right(player, stage)
    assert player.rotation == 1

    player = Player.rotate_right(player, stage)
    assert player.rotation == 2

    player = Player.rotate_right(player, stage)
    assert player.rotation == 3

    player = Player.rotate_right(player, stage)
    assert player.rotation == 0
  end

  test "does not rotate when collision", %{stage: stage, player: player} do
    # å³å´ã«ã·ã‚ˆã‚’é…ç½®ï¼ˆå›è»¢ã™ã‚‹ã¨å³å´ã«æ¬¡ã·ã‚ˆãŒæ¥ã‚‹ï¼‰
    stage = Stage.set_puyo(stage, player.puyo_x + 1, player.puyo_y, 1)

    initial_rotation = player.rotation
    player = Player.rotate_right(player, stage)

    # å›è»¢ã§ããªã„ã“ã¨ã‚’ç¢ºèª
    assert player.rotation == initial_rotation
  end

  test "performs wall kick when rotating at right edge", %{stage: stage, player: player} do
    # å³ç«¯ã«ç§»å‹•
    player = %{player | puyo_x: 5}

    # å³å›è»¢ã™ã‚‹ã¨ã€æ¬¡ã·ã‚ˆãŒå³ç«¯å¤–ã«ãªã‚‹ãŒã€å£ã‚­ãƒƒã‚¯ã§å·¦ã«1ãƒã‚¹ç§»å‹•
    player = Player.rotate_right(player, stage)

    # å›è»¢æˆåŠŸã—ã€è»¸ã·ã‚ˆãŒå·¦ã«1ãƒã‚¹ç§»å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    assert player.rotation == 1
    assert player.puyo_x == 4
  end
end
```

### å®Ÿè£…: å›è»¢ã¨å£ã‚­ãƒƒã‚¯

å›è»¢æ©Ÿèƒ½ã§ã¯ã€ã€Œå£ã‚­ãƒƒã‚¯ã€ã¨ã„ã†å‡¦ç†ãŒé‡è¦ã«ãªã‚Šã¾ã™ã€‚å£ã‚­ãƒƒã‚¯ã¨ã¯ã€å›è»¢ã—ãŸçµæœãŒå£ã‚„ã‚¹ãƒ†ãƒ¼ã‚¸ã®å¤–å´ã«å‡ºã¦ã—ã¾ã†å ´åˆã«ã€è‡ªå‹•çš„ã«ä½ç½®ã‚’èª¿æ•´ã™ã‚‹å‡¦ç†ã§ã™ã€‚

```elixir
# lib/puyo_puyo/player.exï¼ˆç¶šãï¼‰
@doc """
ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å³å›è»¢ã—ã¾ã™

å£ã‚­ãƒƒã‚¯å‡¦ç†ã‚’å«ã¿ã¾ã™ã€‚å›è»¢å¾Œã«å£ã‚„ã·ã‚ˆã«è¡çªã™ã‚‹å ´åˆã¯ã€
è‡ªå‹•çš„ã«ä½ç½®ã‚’èª¿æ•´ã—ã¾ã™ã€‚

## Examples

    iex> stage = PuyoPuyo.Stage.new([])
    iex> player = PuyoPuyo.Player.new(stage)
    iex> player = PuyoPuyo.Player.rotate_right(player, stage)
    iex> player.rotation
    1

"""
@spec rotate_right(t(), Stage.t()) :: t()
def rotate_right(%__MODULE__{rotation: rotation} = player, stage) do
  # æ–°ã—ã„å›è»¢çŠ¶æ…‹
  new_rotation = rem(rotation + 1, 4)

  # å›è»¢å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆå£ã‚­ãƒƒã‚¯å‡¦ç†ã‚’å«ã‚€ï¼‰
  case check_rotation_with_wall_kick(player, new_rotation, stage) do
    {:ok, new_x} ->
      %{player | rotation: new_rotation, puyo_x: new_x}

    :error ->
      player
  end
end

# å›è»¢å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆå£ã‚­ãƒƒã‚¯å‡¦ç†ã‚’å«ã‚€ï¼‰
@spec check_rotation_with_wall_kick(t(), 0..3, Stage.t()) :: {:ok, non_neg_integer()} | :error
defp check_rotation_with_wall_kick(%__MODULE__{puyo_x: x, puyo_y: y}, new_rotation, stage) do
  # 2ã¤ç›®ã®ã·ã‚ˆã®ä½ç½®ã‚’è¨ˆç®—
  second_x = x + Enum.at(@offset_x, new_rotation)
  second_y = y + Enum.at(@offset_y, new_rotation)

  # å£ã‚­ãƒƒã‚¯å‡¦ç†
  adjusted_x = cond do
    # å³ç«¯ã§å³å›è»¢ã—ãŸå ´åˆï¼ˆ2ã¤ç›®ã®ã·ã‚ˆãŒå³ã«ãã‚‹å ´åˆï¼‰
    second_x >= stage.cols -> x - 1

    # å·¦ç«¯ã§å·¦å›è»¢ã—ãŸå ´åˆï¼ˆ2ã¤ç›®ã®ã·ã‚ˆãŒå·¦ã«ãã‚‹å ´åˆï¼‰
    second_x < 0 -> x + 1

    # å£ã‚­ãƒƒã‚¯ä¸è¦
    true -> x
  end

  # å£ã‚­ãƒƒã‚¯å¾Œã®ä½ç½®ã‚’å†è¨ˆç®—
  adjusted_second_x = adjusted_x + Enum.at(@offset_x, new_rotation)

  # ç¯„å›²ãƒã‚§ãƒƒã‚¯
  if adjusted_x >= 0 and adjusted_x < stage.cols and adjusted_second_x >= 0 and adjusted_second_x < stage.cols do
    # è¡çªãƒã‚§ãƒƒã‚¯
    axis_puyo_clear = if y >= 0 and y < stage.rows, do: Stage.get_puyo(stage, adjusted_x, y) == 0, else: true
    second_puyo_clear = if second_y >= 0 and second_y < stage.rows, do: Stage.get_puyo(stage, adjusted_second_x, second_y) == 0, else: true

    if axis_puyo_clear and second_puyo_clear do
      {:ok, adjusted_x}
    else
      :error
    end
  else
    :error
  end
end
```

### è§£èª¬: å£ã‚­ãƒƒã‚¯å‡¦ç†

å£ã‚­ãƒƒã‚¯å‡¦ç†ã¯ã€ã·ã‚ˆã·ã‚ˆã«ãŠã„ã¦é‡è¦ãªæ“ä½œæ€§ã®æ”¹å–„ã§ã™ã€‚

#### å£ã‚­ãƒƒã‚¯ã®ç›®çš„

å›è»¢ã—ãŸçµæœãŒå£ã®å¤–ã«å‡ºã¦ã—ã¾ã†å ´åˆã§ã‚‚ã€è‡ªå‹•çš„ã«ä½ç½®ã‚’èª¿æ•´ã™ã‚‹ã“ã¨ã§ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ„å›³ã—ãŸå›è»¢ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

#### å£ã‚­ãƒƒã‚¯ã®å‡¦ç†

```elixir
adjusted_x = cond do
  # å³ç«¯ã§å³å›è»¢ã—ãŸå ´åˆï¼ˆ2ã¤ç›®ã®ã·ã‚ˆãŒå³ã«ãã‚‹å ´åˆï¼‰
  second_x >= stage.cols -> x - 1

  # å·¦ç«¯ã§å·¦å›è»¢ã—ãŸå ´åˆï¼ˆ2ã¤ç›®ã®ã·ã‚ˆãŒå·¦ã«ãã‚‹å ´åˆï¼‰
  second_x < 0 -> x + 1

  # å£ã‚­ãƒƒã‚¯ä¸è¦
  true -> x
end
```

- **å³ç«¯ã§ã®å›è»¢**: 2ã¤ç›®ã®ã·ã‚ˆãŒå³ç«¯å¤–ã«å‡ºã‚‹å ´åˆã€è»¸ã·ã‚ˆã‚’1ãƒã‚¹å·¦ã«ç§»å‹•
- **å·¦ç«¯ã§ã®å›è»¢**: 2ã¤ç›®ã®ã·ã‚ˆãŒå·¦ç«¯å¤–ã«å‡ºã‚‹å ´åˆã€è»¸ã·ã‚ˆã‚’1ãƒã‚¹å³ã«ç§»å‹•

#### çµæœã®è¿”ã—æ–¹

```elixir
case check_rotation_with_wall_kick(player, new_rotation, stage) do
  {:ok, new_x} -> %{player | rotation: new_rotation, puyo_x: new_x}
  :error -> player
end
```

`{:ok, value}` | `:error` ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ã£ã¦ã€å›è»¢ã®æˆåŠŸãƒ»å¤±æ•—ã‚’è¡¨ç¾ã—ã¾ã™ã€‚ã“ã‚Œã¯Elixirã§ã‚ˆãä½¿ã‚ã‚Œã‚‹æ…£ç”¨çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

å®Ÿè£…ãŒå®Œäº†ã—ãŸã®ã§ã€ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```bash
mix test test/puyo_puyo/player_test.exs
```

ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ï¼ˆGreenï¼‰ã€‚

### ãƒ†ã‚¹ãƒˆ: ç€åœ°åˆ¤å®šã¨ç€åœ°å‡¦ç†

æ¬¡ã«ã€ã·ã‚ˆãƒšã‚¢ã®ç€åœ°åˆ¤å®šã¨ç€åœ°å‡¦ç†ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

```elixir
# test/puyo_puyo/player_test.exsï¼ˆç¶šãï¼‰
describe "Player.can_move_down?/2" do
  setup do
    stage = Stage.new([])
    player = Player.new(stage)
    {:ok, stage: stage, player: player}
  end

  test "returns true when can move down", %{stage: stage, player: player} do
    assert Player.can_move_down?(player, stage) == true
  end

  test "returns false when at bottom", %{stage: stage, player: player} do
    # æœ€ä¸‹æ®µã«ç§»å‹•
    player = %{player | puyo_y: 11}

    assert Player.can_move_down?(player, stage) == false
  end

  test "returns false when puyo below", %{stage: stage, player: player} do
    # ä¸‹ã«ã·ã‚ˆã‚’é…ç½®
    stage = Stage.set_puyo(stage, player.puyo_x, player.puyo_y + 1, 1)

    assert Player.can_move_down?(player, stage) == false
  end

  test "checks second puyo when it is below", %{stage: stage, player: player} do
    # ä¸‹å‘ãï¼ˆå›è»¢çŠ¶æ…‹2ï¼‰ã«ã™ã‚‹
    player = %{player | rotation: 2, puyo_y: 5}

    # 2ã¤ç›®ã®ã·ã‚ˆã®ä¸‹ã«ã·ã‚ˆã‚’é…ç½®
    # 2ã¤ç›®ã®ã·ã‚ˆã¯ (puyo_x, puyo_y + 1) ã«ã‚ã‚‹ã®ã§ã€
    # ãã®ä¸‹ (puyo_x, puyo_y + 2) ã«ã·ã‚ˆã‚’é…ç½®
    stage = Stage.set_puyo(stage, player.puyo_x, player.puyo_y + 2, 1)

    assert Player.can_move_down?(player, stage) == false
  end
end

describe "Player.land/2" do
  setup do
    stage = Stage.new([])
    player = Player.new(stage)
    {:ok, stage: stage, player: player}
  end

  test "places puyos on stage", %{stage: stage, player: player} do
    player = %{player | puyo_y: 10}

    stage = Player.land(player, stage)

    # è»¸ã·ã‚ˆãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    assert Stage.get_puyo(stage, player.puyo_x, player.puyo_y) == player.puyo_type

    # 2ã¤ç›®ã®ã·ã‚ˆãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆä¸Šå‘ããªã®ã§y-1ï¼‰
    assert Stage.get_puyo(stage, player.puyo_x, player.puyo_y - 1) == player.next_puyo_type
  end

  test "places second puyo at correct rotated position", %{stage: stage, player: player} do
    # æ¨ªå‘ãï¼ˆå›è»¢çŠ¶æ…‹1ï¼‰ã«ã™ã‚‹
    player = %{player | rotation: 1, puyo_y: 10}

    stage = Player.land(player, stage)

    # è»¸ã·ã‚ˆãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    assert Stage.get_puyo(stage, player.puyo_x, player.puyo_y) == player.puyo_type

    # 2ã¤ç›®ã®ã·ã‚ˆãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆå³å‘ããªã®ã§x+1ï¼‰
    assert Stage.get_puyo(stage, player.puyo_x + 1, player.puyo_y) == player.next_puyo_type
  end
end
```

### å®Ÿè£…: ç€åœ°åˆ¤å®šã¨ç€åœ°å‡¦ç†

```elixir
# lib/puyo_puyo/player.exï¼ˆç¶šãï¼‰
@doc """
ä¸‹ã«ç§»å‹•ã§ãã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã¾ã™

## Examples

    iex> stage = PuyoPuyo.Stage.new([])
    iex> player = PuyoPuyo.Player.new(stage)
    iex> PuyoPuyo.Player.can_move_down?(player, stage)
    true

"""
@spec can_move_down?(t(), Stage.t()) :: boolean()
def can_move_down?(%__MODULE__{puyo_x: x, puyo_y: y, rotation: rotation}, stage) do
  second_puyo_x = x + Enum.at(@offset_x, rotation)
  second_puyo_y = y + Enum.at(@offset_y, rotation)

  # 2ã¤ç›®ã®ã·ã‚ˆãŒä¸‹å‘ãï¼ˆoffsetY == 1ï¼‰ã®å ´åˆ
  if Enum.at(@offset_y, rotation) == 1 do
    # 2ã¤ç›®ã®ã·ã‚ˆã®ä¸‹ç«¯ãƒã‚§ãƒƒã‚¯
    if second_puyo_y >= stage.rows - 1 do
      false
    else
      # 2ã¤ç›®ã®ã·ã‚ˆã®ä¸‹ã«ã·ã‚ˆãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      Stage.get_puyo(stage, second_puyo_x, second_puyo_y + 1) == 0
    end
  else
    # è»¸ã·ã‚ˆã®ä¸‹ç«¯ãƒã‚§ãƒƒã‚¯
    if y >= stage.rows - 1 do
      false
    else
      # è»¸ã·ã‚ˆã®ä¸‹ã«ã·ã‚ˆãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      axis_puyo_clear = Stage.get_puyo(stage, x, y + 1) == 0

      # 2ã¤ç›®ã®ã·ã‚ˆã®ä¸‹ç«¯ã¨è¡çªãƒã‚§ãƒƒã‚¯
      second_puyo_clear =
        if second_puyo_y >= stage.rows - 1 do
          false
        else
          Stage.get_puyo(stage, second_puyo_x, second_puyo_y + 1) == 0
        end

      axis_puyo_clear and second_puyo_clear
    end
  end
end

@doc """
ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã·ã‚ˆãƒšã‚¢ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ã«é…ç½®ã—ã¾ã™

## Examples

    iex> stage = PuyoPuyo.Stage.new([])
    iex> player = PuyoPuyo.Player.new(stage)
    iex> player = %{player | puyo_y: 10}
    iex> stage = PuyoPuyo.Player.land(player, stage)
    iex> PuyoPuyo.Stage.get_puyo(stage, player.puyo_x, player.puyo_y)
    player.puyo_type

"""
@spec land(t(), Stage.t()) :: Stage.t()
def land(%__MODULE__{puyo_x: x, puyo_y: y, puyo_type: puyo_type, next_puyo_type: next_puyo_type, rotation: rotation}, stage) do
  second_puyo_x = x + Enum.at(@offset_x, rotation)
  second_puyo_y = y + Enum.at(@offset_y, rotation)

  stage
  |> Stage.set_puyo(x, y, puyo_type)
  |> Stage.set_puyo(second_puyo_x, second_puyo_y, next_puyo_type)
end
```

### è§£èª¬: ç€åœ°åˆ¤å®šã®è¤‡é›‘ã•

ç€åœ°åˆ¤å®šã§ã¯ã€å›è»¢çŠ¶æ…‹ã«å¿œã˜ã¦ç•°ãªã‚‹ãƒã‚§ãƒƒã‚¯ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

#### ä¸‹å‘ãã®å ´åˆ

```elixir
if Enum.at(@offset_y, rotation) == 1 do
  # 2ã¤ç›®ã®ã·ã‚ˆã®ä¸‹ç«¯ãƒã‚§ãƒƒã‚¯
  if second_puyo_y >= stage.rows - 1 do
    false
  else
    Stage.get_puyo(stage, second_puyo_x, second_puyo_y + 1) == 0
  end
```

2ã¤ç›®ã®ã·ã‚ˆãŒä¸‹å‘ãã®å ´åˆã€2ã¤ç›®ã®ã·ã‚ˆã®ä¸‹ã ã‘ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚Œã°ã‚ˆã„ï¼ˆè»¸ã·ã‚ˆã¯2ã¤ç›®ã®ã·ã‚ˆã®ä¸Šã«ã‚ã‚‹ãŸã‚ï¼‰ã€‚

#### ãã®ä»–ã®æ–¹å‘ã®å ´åˆ

```elixir
# è»¸ã·ã‚ˆã®ä¸‹ã«ã·ã‚ˆãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
axis_puyo_clear = Stage.get_puyo(stage, x, y + 1) == 0

# 2ã¤ç›®ã®ã·ã‚ˆã®ä¸‹ç«¯ã¨è¡çªãƒã‚§ãƒƒã‚¯
second_puyo_clear =
  if second_puyo_y >= stage.rows - 1 do
    false
  else
    Stage.get_puyo(stage, second_puyo_x, second_puyo_y + 1) == 0
  end

axis_puyo_clear and second_puyo_clear
```

ä¸Šã€å³ã€å·¦å‘ãã®å ´åˆã€è»¸ã·ã‚ˆã¨2ã¤ç›®ã®ã·ã‚ˆã®ä¸¡æ–¹ã®ä¸‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

å®Ÿè£…ãŒå®Œäº†ã—ãŸã®ã§ã€ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```bash
mix test test/puyo_puyo/player_test.exs
```

ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ï¼ˆGreenï¼‰ã€‚

### LiveViewã¨ã®çµ±åˆ: ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›

Playerãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå®Œæˆã—ãŸã®ã§ã€GameLiveã¨çµ±åˆã—ã¦ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›ã‚’å‡¦ç†ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

Phoenix LiveViewã§ã¯ã€`phx-window-keydown`ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½¿ã£ã¦ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›ã‚’å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```elixir
# lib/puyo_puyo_web/live/game_live.exï¼ˆæ›´æ–°ï¼‰
defmodule PuyoPuyoWeb.GameLive do
  use PuyoPuyoWeb, :live_view

  alias PuyoPuyo.{Stage, Player}

  # ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ ...

  @impl true
  def mount(_params, _session, socket) do
    stage = Stage.new([])
    player = Player.new(stage)

    socket =
      socket
      |> assign(:mode, :playing)
      |> assign(:score, 0)
      |> assign(:chain, 0)
      |> assign(:stage, stage)
      |> assign(:player, player)

    {:ok, socket}
  end

  @impl true
  def render(assigns) do
    ~H"""
    <div
      id="game-container"
      class="flex gap-8 p-8"
      phx-window-keydown="keydown"
      phx-throttle="100"
    >
      <div id="game-board" class="relative bg-gray-100 border-2 border-gray-800 rounded-lg">
        <div class="grid" style={"grid-template-columns: repeat(#{@stage.cols}, 32px);"}>
          <%= for row <- 0..(@stage.rows - 1) do %>
            <%= for col <- 0..(@stage.cols - 1) do %>
              <div
                class="border border-gray-300"
                style="width: 32px; height: 32px;"
              >
                <%= render_puyo(Stage.get_puyo(@stage, col, row)) %>
              </div>
            <% end %>
          <% end %>
        </div>

        <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã·ã‚ˆãƒšã‚¢ã‚’æç”» -->
        <%= if @mode == :playing do %>
          <%= render_player_puyo(@player, 0) %>
          <%= render_player_puyo(@player, 1) %>
        <% end %>
      </div>

      <div id="info-panel" class="bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-bold mb-4">ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ </h2>

        <div class="mb-4">
          <h3 class="text-lg font-semibold">ã‚¹ã‚³ã‚¢</h3>
          <p id="score" class="text-3xl font-bold text-blue-600"><%= @score %></p>
        </div>

        <div class="mb-4">
          <h3 class="text-lg font-semibold">é€£é–æ•°</h3>
          <p id="chain" class="text-3xl font-bold text-red-600"><%= @chain %></p>
        </div>

        <div class="mt-6 text-sm text-gray-600">
          <h3 class="font-semibold mb-2">æ“ä½œæ–¹æ³•</h3>
          <ul class="space-y-1">
            <li>â† â†’: ç§»å‹•</li>
            <li>â†‘: å›è»¢</li>
            <li>â†“: é«˜é€Ÿè½ä¸‹</li>
          </ul>
        </div>
      </div>
    </div>
    """
  end

  # ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†
  @impl true
  def handle_event("keydown", %{"key" => key}, socket) do
    socket = handle_key_input(socket, key)
    {:noreply, socket}
  end

  # ã‚­ãƒ¼å…¥åŠ›ã®å‡¦ç†
  defp handle_key_input(socket, "ArrowLeft") do
    player = socket.assigns.player
    stage = socket.assigns.stage
    player = Player.move_left(player, stage)
    assign(socket, :player, player)
  end

  defp handle_key_input(socket, "ArrowRight") do
    player = socket.assigns.player
    stage = socket.assigns.stage
    player = Player.move_right(player, stage)
    assign(socket, :player, player)
  end

  defp handle_key_input(socket, "ArrowUp") do
    player = socket.assigns.player
    stage = socket.assigns.stage
    player = Player.rotate_right(player, stage)
    assign(socket, :player, player)
  end

  defp handle_key_input(socket, _key) do
    socket
  end

  # ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã·ã‚ˆã‚’æç”»
  defp render_player_puyo(player, index) do
    {x, y, type} =
      case index do
        0 ->
          {player.puyo_x, player.puyo_y, player.puyo_type}

        1 ->
          offset_x = Enum.at([0, 1, 0, -1], player.rotation)
          offset_y = Enum.at([-1, 0, 1, 0], player.rotation)
          {player.puyo_x + offset_x, player.puyo_y + offset_y, player.next_puyo_type}
      end

    color = puyo_color(type)

    assigns = %{x: x, y: y, color: color}

    ~H"""
    <div
      class="absolute rounded-full"
      style={"
        left: #{@x * 32}px;
        top: #{@y * 32}px;
        width: 32px;
        height: 32px;
        background-color: #{@color};
        border: 2px solid rgba(0,0,0,0.2);
        z-index: 10;
      "}
    >
    </div>
    """
  end

  # ... æ—¢å­˜ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆé–¢æ•° ...
end
```

### è§£èª¬: Phoenix LiveViewã®ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†

#### ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°

```elixir
phx-window-keydown="keydown"
phx-throttle="100"
```

- `phx-window-keydown="keydown"`: ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦å…¨ä½“ã®ã‚­ãƒ¼ãƒ€ã‚¦ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã‚’`keydown`ã¨ã„ã†åå‰ã§LiveViewã«é€ä¿¡
- `phx-throttle="100"`: ã‚¤ãƒ™ãƒ³ãƒˆã‚’100msé–“éš”ã§ã‚¹ãƒ­ãƒƒãƒˆãƒ«ï¼ˆé€£ç¶šå…¥åŠ›ã®åˆ¶å¾¡ï¼‰

#### ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼

```elixir
def handle_event("keydown", %{"key" => key}, socket) do
  socket = handle_key_input(socket, key)
  {:noreply, socket}
end
```

`handle_event/3`ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ã—ã¾ã™ã€‚

#### çŠ¶æ…‹ã®æ›´æ–°

```elixir
defp handle_key_input(socket, "ArrowLeft") do
  player = socket.assigns.player
  stage = socket.assigns.stage
  player = Player.move_left(player, stage)
  assign(socket, :player, player)
end
```

- `socket.assigns`ã‹ã‚‰ç¾åœ¨ã®çŠ¶æ…‹ã‚’å–å¾—
- Playerãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦æ–°ã—ã„çŠ¶æ…‹ã‚’å–å¾—
- `assign/3`ã§æ–°ã—ã„çŠ¶æ…‹ã‚’socketã«è¨­å®š

Phoenix LiveViewã¯ã€çŠ¶æ…‹ãŒå¤‰æ›´ã•ã‚Œã‚‹ã¨è‡ªå‹•çš„ã«`render/1`ã‚’å†å®Ÿè¡Œã—ã€å¤‰æ›´ã•ã‚ŒãŸéƒ¨åˆ†ã ã‘ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€ä¿¡ã—ã¾ã™ã€‚

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆçµ±åˆãƒ†ã‚¹ãƒˆï¼‰

æœ€å¾Œã«ã€ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã€çµ±åˆãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ï¼š

```bash
mix test
```

ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ï¼ˆGreenï¼‰ã€‚

### å‹•ä½œç¢ºèª

ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```bash
mix phx.server
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://localhost:4000/game` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¾ã™ï¼š

- ç”»é¢ä¸Šéƒ¨ã«ã·ã‚ˆãƒšã‚¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- çŸ¢å°ã‚­ãƒ¼â†â†’ã§ã·ã‚ˆãƒšã‚¢ãŒå·¦å³ã«ç§»å‹•ã™ã‚‹
- çŸ¢å°ã‚­ãƒ¼â†‘ã§ã·ã‚ˆãƒšã‚¢ãŒå›è»¢ã™ã‚‹
- å£éš›ã§å›è»¢ã™ã‚‹ã¨å£ã‚­ãƒƒã‚¯ãŒå‹•ä½œã™ã‚‹

### ã‚³ãƒŸãƒƒãƒˆ

æ©Ÿèƒ½ãŒå®Œæˆã—ãŸã®ã§ã€ã‚³ãƒŸãƒƒãƒˆã—ã¾ã—ã‚‡ã†ï¼š

```bash
git add -A
git commit -m "feat: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å®Ÿè£…

- Playerãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆï¼ˆlib/puyo_puyo/player.exï¼‰
- ã·ã‚ˆãƒšã‚¢ã®ç”Ÿæˆï¼ˆè»¸ã·ã‚ˆã¨æ¬¡ã·ã‚ˆï¼‰
- å·¦å³ç§»å‹•æ©Ÿèƒ½ï¼ˆmove_left/2, move_right/2ï¼‰
  - å¢ƒç•Œãƒã‚§ãƒƒã‚¯
  - è¡çªåˆ¤å®šï¼ˆè»¸ã·ã‚ˆã¨æ¬¡ã·ã‚ˆã®ä¸¡æ–¹ï¼‰
- å›è»¢æ©Ÿèƒ½ï¼ˆrotate_right/2ï¼‰
  - å£ã‚­ãƒƒã‚¯å‡¦ç†
  - {:ok, value} | :error ãƒ‘ã‚¿ãƒ¼ãƒ³
- ç€åœ°åˆ¤å®šï¼ˆcan_move_down?/2ï¼‰
  - å›è»¢çŠ¶æ…‹ã«å¿œã˜ãŸåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
- ç€åœ°å‡¦ç†ï¼ˆland/2ï¼‰
- GameLiveã¨ã®çµ±åˆ
  - phx-window-keydown ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°
  - handle_event/3 ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
  - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã·ã‚ˆã®æç”»
- åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ï¼ˆ13ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼‰

ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³3å®Œäº†"
```

### ã¾ã¨ã‚

ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³3ã§ä»¥ä¸‹ã‚’é”æˆã—ã¾ã—ãŸï¼š

#### å¾—ã‚‰ã‚ŒãŸã‚‚ã®

1. **Playerãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**
   - ã·ã‚ˆãƒšã‚¢ã®çŠ¶æ…‹ç®¡ç†
   - è»¸ã·ã‚ˆã¨æ¬¡ã·ã‚ˆã®æ§‹æˆ
   - å›è»¢çŠ¶æ…‹ï¼ˆ0-3ï¼‰ã®ç®¡ç†

2. **ç§»å‹•æ©Ÿèƒ½**
   - `move_left/2`: å·¦ç§»å‹•
   - `move_right/2`: å³ç§»å‹•
   - å¢ƒç•Œãƒã‚§ãƒƒã‚¯ã¨è¡çªåˆ¤å®š
   - è»¸ã·ã‚ˆã¨æ¬¡ã·ã‚ˆã®ä¸¡æ–¹ã‚’ãƒã‚§ãƒƒã‚¯

3. **å›è»¢æ©Ÿèƒ½**
   - `rotate_right/2`: å³å›è»¢
   - å£ã‚­ãƒƒã‚¯å‡¦ç†ï¼ˆè‡ªå‹•ä½ç½®èª¿æ•´ï¼‰
   - `{:ok, value}` | `:error` ãƒ‘ã‚¿ãƒ¼ãƒ³

4. **ç€åœ°æ©Ÿèƒ½**
   - `can_move_down?/2`: ä¸‹ã«ç§»å‹•å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
   - `land/2`: ã‚¹ãƒ†ãƒ¼ã‚¸ã«ã·ã‚ˆãƒšã‚¢ã‚’é…ç½®
   - å›è»¢çŠ¶æ…‹ã«å¿œã˜ãŸç€åœ°åˆ¤å®š

5. **LiveViewã¨ã®çµ±åˆ**
   - `phx-window-keydown` ã‚¤ãƒ™ãƒ³ãƒˆ
   - `handle_event/3` ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
   - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãªçŠ¶æ…‹æ›´æ–°
   - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã·ã‚ˆã®æç”»

#### å­¦ã‚“ã ã“ã¨

1. **Elixirã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°**
   ```elixir
   case check_rotation_with_wall_kick(player, new_rotation, stage) do
     {:ok, new_x} -> %{player | rotation: new_rotation, puyo_x: new_x}
     :error -> player
   end
   ```

2. **Phoenix LiveViewã®ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†**
   - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã‚µãƒ¼ãƒãƒ¼ã¸ã®ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡
   - ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã®çŠ¶æ…‹æ›´æ–°
   - è‡ªå‹•çš„ãªç”»é¢æ›´æ–°

3. **å£ã‚­ãƒƒã‚¯å‡¦ç†**
   - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½“é¨“ã®å‘ä¸Š
   - `cond`å¼ã«ã‚ˆã‚‹æ¡ä»¶åˆ†å²
   - æ®µéšçš„ãªä½ç½®èª¿æ•´

4. **å˜ä¸€è²¬ä»»ã®åŸå‰‡**
   - Playerãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ“ä½œ
   - Stageãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«: ã‚¹ãƒ†ãƒ¼ã‚¸ã®ç®¡ç†
   - GameLive: UIã¨çµ±åˆ

5. **ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™º**
   - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®æ´—ã„å‡ºã—
   - å¢ƒç•Œæ¡ä»¶ã®ãƒ†ã‚¹ãƒˆ
   - çµ±åˆãƒ†ã‚¹ãƒˆã«ã‚ˆã‚‹å‹•ä½œç¢ºèª

#### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åŸºæœ¬æ“ä½œãŒå®Œæˆã—ã¾ã—ãŸã€‚æ¬¡ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ä»¥ä¸‹ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ï¼š

- **ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³4**: ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã®å®Ÿè£…ï¼ˆé‡åŠ›ã¨è‡ªå‹•è½ä¸‹ï¼‰
- **ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³5**: ã‚¹ã‚³ã‚¢ã¨é€£é–ã®å®Ÿè£…
- **ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³6**: ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã®å®Ÿè£…

ã“ã‚Œã‚‰ã‚’ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®ã‚µã‚¤ã‚¯ãƒ«ã«å¾“ã£ã¦ã€ä¸€ã¤ãšã¤å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã†ï¼

---

## ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³4: ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã®å®Ÿè£…

ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³3ã§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ“ä½œãŒå®Œæˆã—ã¾ã—ãŸã€‚æ¬¡ã¯ã€ã€Œã‚²ãƒ¼ãƒ ãŒè‡ªå‹•çš„ã«é€²è¡Œã™ã‚‹ã€æ©Ÿèƒ½ã®å®Ÿè£…ã§ã™ã€‚ã“ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã€é‡åŠ›ã«ã‚ˆã‚‹è‡ªå‹•è½ä¸‹ã€ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹é·ç§»ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

> ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
>
> ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã¯ã€ã‚²ãƒ¼ãƒ ã®å¿ƒè‡“éƒ¨ã§ã™ã€‚æ™‚é–“ã®çµŒéã¨ã¨ã‚‚ã«ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’æ›´æ–°ã—ã€ç”»é¢ã‚’å†æç”»ã™ã‚‹å‡¦ç†ã‚’ç¹°ã‚Šè¿”ã™ã“ã¨ã§ã€å‹•ãã®ã‚ã‚‹ã‚²ãƒ¼ãƒ ã‚’å®Ÿç¾ã—ã¾ã™ã€‚
>
> â€” Robert Nystrom ã€Game Programming Patternsã€

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼

ã“ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å®Ÿè£…ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ï¼š

> ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ã€ã·ã‚ˆãƒšã‚¢ãŒè‡ªå‹•çš„ã«è½ä¸‹ã—ã€ç€åœ°å¾Œã¯è‡ªå‹•çš„ã«æ¬¡ã®ã·ã‚ˆãƒšã‚¢ãŒç”Ÿæˆã•ã‚Œã‚‹

ã“ã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã«ã¯ã€ä»¥ä¸‹ã®æ©Ÿèƒ½ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼š

1. å®šæœŸçš„ãªæ›´æ–°å‡¦ç†ï¼ˆã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ï¼‰
2. é‡åŠ›ã«ã‚ˆã‚‹è‡ªå‹•è½ä¸‹
3. ç€åœ°åˆ¤å®šã¨ç€åœ°å‡¦ç†
4. æ–°ã—ã„ã·ã‚ˆãƒšã‚¢ã®è‡ªå‹•ç”Ÿæˆ
5. ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹é·ç§»

ãã‚Œã§ã¯ã€ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã‚’ä¸€ã¤ãšã¤ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã§å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã†ï¼

### TODOãƒªã‚¹ãƒˆ

ã€Œã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã®å®Ÿè£…ã€ã¨ã„ã†ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®ã‚¿ã‚¹ã‚¯ãŒå¿…è¦ã§ã™ï¼š

- ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã‚’å®šç¾©ã™ã‚‹ï¼ˆæ–°ã·ã‚ˆã€ãƒ—ãƒ¬ã‚¤ä¸­ã€æ¶ˆå»ç¢ºèªãªã©ï¼‰
- Gameãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹ï¼ˆã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ç®¡ç†ï¼‰
- Process.send_afterã‚’ä½¿ã£ãŸã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã‚’å®Ÿè£…ã™ã‚‹
- handle_info/2ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§å®šæœŸæ›´æ–°ã‚’å®Ÿè£…ã™ã‚‹
- ãƒ‡ãƒ«ã‚¿æ™‚é–“ãƒ™ãƒ¼ã‚¹ã®æ›´æ–°ã‚’å®Ÿè£…ã™ã‚‹
- é‡åŠ›ã‚’é©ç”¨ã™ã‚‹å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹ï¼ˆ1ãƒ•ãƒ¬ãƒ¼ãƒ ã§1ãƒã‚¹è½ä¸‹ï¼‰
- ç€åœ°å¾Œã®å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹
- GameLiveã¨çµ±åˆã™ã‚‹

ã“ã‚Œã‚‰ã®ã‚¿ã‚¹ã‚¯ã‚’ä¸€ã¤ãšã¤å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚ã¾ãšã¯ã€Œã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã®å®šç¾©ã€ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†ï¼

### ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã®è¨­è¨ˆ

ã¾ãšã€ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’è¡¨ã™ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã‚’è¨­è¨ˆã—ã¾ã™ã€‚ã·ã‚ˆã·ã‚ˆã®ã‚²ãƒ¼ãƒ ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªçŠ¶æ…‹é·ç§»ã‚’æŒã¡ã¾ã™ï¼š

```
æ–°ã·ã‚ˆ â†’ ãƒ—ãƒ¬ã‚¤ä¸­ â†’ æ¶ˆå»ç¢ºèª â†’ è½ä¸‹ç¢ºèª â†’ è½ä¸‹ä¸­ â†’ æ¶ˆå»ç¢ºèª â†’ ... â†’ æ–°ã·ã‚ˆ
                                  â†“
                             ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
```

#### ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã®ç¨®é¡

- **`:new_puyo`ï¼ˆæ–°ã·ã‚ˆï¼‰**: æ–°ã—ã„ã·ã‚ˆãƒšã‚¢ã‚’ç”Ÿæˆã™ã‚‹çŠ¶æ…‹
- **`:playing`ï¼ˆãƒ—ãƒ¬ã‚¤ä¸­ï¼‰**: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã·ã‚ˆã‚’æ“ä½œã—ã¦ã„ã‚‹çŠ¶æ…‹
- **`:check_erase`ï¼ˆæ¶ˆå»ç¢ºèªï¼‰**: ã·ã‚ˆã®æ¶ˆå»åˆ¤å®šã‚’è¡Œã†çŠ¶æ…‹
- **`:check_fall`ï¼ˆè½ä¸‹ç¢ºèªï¼‰**: æµ®ã„ã¦ã„ã‚‹ã·ã‚ˆãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹çŠ¶æ…‹
- **`:falling`ï¼ˆè½ä¸‹ä¸­ï¼‰**: ã·ã‚ˆãŒè½ä¸‹ã—ã¦ã„ã‚‹çŠ¶æ…‹
- **`:game_over`ï¼ˆã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼‰**: ã‚²ãƒ¼ãƒ çµ‚äº†çŠ¶æ…‹

### ãƒ†ã‚¹ãƒˆ: Gameãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®åˆæœŸåŒ–

ã¾ãšã€ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹Gameãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

```elixir
# test/puyo_puyo/game_test.exs
defmodule PuyoPuyo.GameTest do
  use ExUnit.Case, async: true

  alias PuyoPuyo.Game

  describe "Game.new/0" do
    test "creates a new game with initial state" do
      game = Game.new()

      # åˆæœŸãƒ¢ãƒ¼ãƒ‰ã¯:new_puyo
      assert game.mode == :new_puyo
      # é€£é–æ•°ã¯0
      assert game.chain == 0
      # ã‚¹ãƒ†ãƒ¼ã‚¸ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
      assert game.stage != nil
    end
  end

  describe "Game.update/2" do
    test "spawns new puyo in :new_puyo mode" do
      game = Game.new()

      # æ›´æ–°ã‚’å®Ÿè¡Œ
      game = Game.update(game, 16.0)

      # ãƒ—ãƒ¬ã‚¤ä¸­ãƒ¢ãƒ¼ãƒ‰ã«ç§»è¡Œ
      assert game.mode == :playing
      # ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹
      assert game.player != nil
    end

    test "transitions to :game_over when cannot spawn" do
      game = Game.new()

      # åˆæœŸä½ç½®(2, 0)ã«ã·ã‚ˆã‚’é…ç½®ã—ã¦ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã‚’å¼•ãèµ·ã“ã™
      stage = PuyoPuyo.Stage.set_puyo(game.stage, 2, 0, 1)
      game = %{game | stage: stage}

      # æ›´æ–°ã‚’å®Ÿè¡Œ
      game = Game.update(game, 16.0)

      # ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ¢ãƒ¼ãƒ‰ã«ç§»è¡Œ
      assert game.mode == :game_over
    end
  end
end
```

### å®Ÿè£…: Gameãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®åŸºæœ¬æ§‹é€ 

ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨å¤±æ•—ã—ã¾ã™ï¼ˆRedï¼‰ã€‚ã§ã¯ã€ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã‚ˆã†ã«æœ€å°é™ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã—ã¾ã—ã‚‡ã†ï¼ˆGreenï¼‰ã€‚

```elixir
# lib/puyo_puyo/game.ex
defmodule PuyoPuyo.Game do
  @moduledoc """
  ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

  ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã€é€£é–æ•°ã€å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®çŠ¶æ…‹ã‚’ç®¡ç†ã—ã¾ã™ã€‚
  """

  alias PuyoPuyo.{Stage, Player}

  @type game_mode :: :new_puyo | :playing | :check_erase | :check_fall | :falling | :game_over

  @type t :: %__MODULE__{
          mode: game_mode(),
          chain: non_neg_integer(),
          stage: Stage.t(),
          player: Player.t() | nil,
          last_update: integer()
        }

  defstruct [
    :mode,
    :chain,
    :stage,
    :player,
    :last_update
  ]

  @doc """
  æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã™

  ## Examples

      iex> game = PuyoPuyo.Game.new()
      iex> game.mode
      :new_puyo

  """
  @spec new() :: t()
  def new do
    %__MODULE__{
      mode: :new_puyo,
      chain: 0,
      stage: Stage.new([]),
      player: nil,
      last_update: System.monotonic_time(:millisecond)
    }
  end

  @doc """
  ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¾ã™

  ãƒ‡ãƒ«ã‚¿æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰ã‚’å—ã‘å–ã‚Šã€ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

  ## Examples

      iex> game = PuyoPuyo.Game.new()
      iex> game = PuyoPuyo.Game.update(game, 16.0)
      iex> game.mode
      :playing

  """
  @spec update(t(), float()) :: t()
  def update(%__MODULE__{mode: mode} = game, delta_time) do
    case mode do
      :new_puyo ->
        handle_new_puyo(game)

      :playing ->
        handle_playing(game, delta_time)

      :check_erase ->
        handle_check_erase(game)

      :check_fall ->
        handle_check_fall(game)

      :falling ->
        handle_falling(game)

      :game_over ->
        game
    end
  end

  # æ–°ã·ã‚ˆãƒ¢ãƒ¼ãƒ‰ã®å‡¦ç†
  @spec handle_new_puyo(t()) :: t()
  defp handle_new_puyo(%__MODULE__{stage: stage} = game) do
    player = Player.new(stage)

    if Player.can_spawn?(player, stage) do
      # ã·ã‚ˆãƒšã‚¢ã‚’ç”Ÿæˆã§ãã‚‹å ´åˆ
      %{game | mode: :playing, player: player}
    else
      # ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
      %{game | mode: :game_over}
    end
  end

  # ãƒ—ãƒ¬ã‚¤ä¸­ãƒ¢ãƒ¼ãƒ‰ã®å‡¦ç†
  @spec handle_playing(t(), float()) :: t()
  defp handle_playing(%__MODULE__{player: player, stage: stage} = game, delta_time) do
    # ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æ›´æ–°ï¼ˆé‡åŠ›ã‚’é©ç”¨ï¼‰
    {player, landed} = update_player_gravity(player, stage, delta_time)

    if landed do
      # ç€åœ°ã—ãŸå ´åˆã€ã·ã‚ˆã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ã«é…ç½®
      stage = Player.land(player, stage)
      %{game | mode: :check_erase, stage: stage, player: nil}
    else
      %{game | player: player}
    end
  end

  # ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«é‡åŠ›ã‚’é©ç”¨
  @spec update_player_gravity(Player.t(), Stage.t(), float()) :: {Player.t(), boolean()}
  defp update_player_gravity(player, stage, delta_time) do
    # ç°¡æ˜“çš„ãªå®Ÿè£…ï¼šä¸€å®šæ™‚é–“ã”ã¨ã«1ãƒã‚¹è½ä¸‹
    # å®Ÿéš›ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«è½ä¸‹ã‚¿ã‚¤ãƒãƒ¼ã‚’æŒãŸã›ã‚‹ã¹ã
    if Player.can_move_down?(player, stage) do
      # ä¸‹ã«ç§»å‹•ã§ãã‚‹å ´åˆã€Yåº§æ¨™ã‚’1å¢—ã‚„ã™
      player = %{player | puyo_y: player.puyo_y + 1}
      {player, false}
    else
      # ä¸‹ã«ç§»å‹•ã§ããªã„å ´åˆã€ç€åœ°
      {player, true}
    end
  end

  # æ¶ˆå»ç¢ºèªãƒ¢ãƒ¼ãƒ‰ã®å‡¦ç†
  @spec handle_check_erase(t()) :: t()
  defp handle_check_erase(%__MODULE__{stage: stage, chain: chain} = game) do
    {erase_count, positions} = Stage.check_erase(stage)

    if erase_count > 0 do
      # æ¶ˆå»å¯¾è±¡ãŒã‚ã‚‹å ´åˆ
      stage = Stage.erase_puyos(stage, positions)
      chain = chain + 1

      %{game | stage: stage, chain: chain, mode: :check_fall}
    else
      # æ¶ˆå»å¯¾è±¡ãŒãªã„å ´åˆ
      if chain == 0 do
        # ç€åœ°ç›´å¾Œã§æ¶ˆå»ãªã—â†’è½ä¸‹ç¢ºèªï¼ˆæµ®ã„ã¦ã„ã‚‹ã·ã‚ˆã‚’è½ã¨ã™ï¼‰
        %{game | mode: :check_fall}
      else
        # é€£é–å¾Œã§æ¶ˆå»ãªã—â†’é€£é–çµ‚äº†
        %{game | mode: :new_puyo, chain: 0}
      end
    end
  end

  # è½ä¸‹ç¢ºèªãƒ¢ãƒ¼ãƒ‰ã®å‡¦ç†
  @spec handle_check_fall(t()) :: t()
  defp handle_check_fall(%__MODULE__{stage: stage, chain: chain} = game) do
    {has_fallen, stage} = Stage.apply_gravity(stage)

    if has_fallen do
      # ã·ã‚ˆãŒè½ä¸‹ã—ãŸå ´åˆã€è½ä¸‹ä¸­ãƒ¢ãƒ¼ãƒ‰ã¸
      %{game | stage: stage, mode: :falling}
    else
      # è½ä¸‹ã™ã‚‹ã·ã‚ˆãŒãªã„å ´åˆ
      if chain == 0 do
        # ç€åœ°å¾Œã®åˆå›è½ä¸‹ã§è½ä¸‹ãªã—â†’æ–°ã·ã‚ˆã¸
        %{game | mode: :new_puyo}
      else
        # é€£é–ä¸­ã®è½ä¸‹ã§è½ä¸‹ãªã—â†’æ¶ˆå»ç¢ºèªã§æœ€å¾Œã®ãƒã‚§ãƒƒã‚¯
        %{game | mode: :check_erase}
      end
    end
  end

  # è½ä¸‹ä¸­ãƒ¢ãƒ¼ãƒ‰ã®å‡¦ç†
  @spec handle_falling(t()) :: t()
  defp handle_falling(game) do
    # è½ä¸‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼ˆç°¡ç•¥åŒ–ã®ãŸã‚ã€ã™ãã«è½ä¸‹ç¢ºèªã«æˆ»ã‚‹ï¼‰
    %{game | mode: :check_fall}
  end
end
```

### è§£èª¬: ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹é·ç§»

å®Ÿè£…ã—ãŸGameãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã¤ã„ã¦ã€é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’è§£èª¬ã—ã¾ã™ã€‚

#### ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã‚‹å‡¦ç†ã®åˆ†å²

```elixir
def update(%__MODULE__{mode: mode} = game, delta_time) do
  case mode do
    :new_puyo -> handle_new_puyo(game)
    :playing -> handle_playing(game, delta_time)
    :check_erase -> handle_check_erase(game)
    # ...
  end
end
```

`case`å¼ã§ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸå‡¦ç†ã‚’æŒ¯ã‚Šåˆ†ã‘ã¾ã™ã€‚å„ãƒ¢ãƒ¼ãƒ‰ã¯ç‹¬ç«‹ã—ãŸé–¢æ•°ã¨ã—ã¦å®Ÿè£…ã•ã‚Œã¦ãŠã‚Šã€å˜ä¸€è²¬ä»»ã®åŸå‰‡ã«å¾“ã£ã¦ã„ã¾ã™ã€‚

#### çŠ¶æ…‹é·ç§»ã®ä¾‹

```elixir
defp handle_new_puyo(%__MODULE__{stage: stage} = game) do
  player = Player.new(stage)

  if Player.can_spawn?(player, stage) do
    %{game | mode: :playing, player: player}
  else
    %{game | mode: :game_over}
  end
end
```

æ–°ã·ã‚ˆãƒ¢ãƒ¼ãƒ‰ã§ã¯ï¼š
1. æ–°ã—ã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ç”Ÿæˆ
2. ç”Ÿæˆå¯èƒ½ãªã‚‰`:playing`ãƒ¢ãƒ¼ãƒ‰ã¸ç§»è¡Œ
3. ç”Ÿæˆä¸å¯èƒ½ãªã‚‰`:game_over`ãƒ¢ãƒ¼ãƒ‰ã¸ç§»è¡Œ

#### é€£é–æ•°ã®ç®¡ç†

```elixir
defp handle_check_erase(%__MODULE__{stage: stage, chain: chain} = game) do
  {erase_count, positions} = Stage.check_erase(stage)

  if erase_count > 0 do
    chain = chain + 1
    %{game | stage: stage, chain: chain, mode: :check_fall}
  else
    if chain == 0 do
      %{game | mode: :check_fall}
    else
      %{game | mode: :new_puyo, chain: 0}
    end
  end
end
```

é€£é–æ•°ã¯ã€æ¶ˆå»ãŒç™ºç”Ÿã™ã‚‹ãŸã³ã«å¢—åŠ ã—ã¾ã™ã€‚æ¶ˆå»ãŒãªããªã£ãŸã‚‰é€£é–çµ‚äº†ã¨ã—ã¦é€£é–æ•°ã‚’0ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

å®Ÿè£…ãŒå®Œäº†ã—ãŸã®ã§ã€ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```bash
mix test test/puyo_puyo/game_test.exs
```

ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ï¼ˆGreenï¼‰ã€‚

### LiveViewã¨ã®çµ±åˆ: ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—

Gameãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå®Œæˆã—ãŸã®ã§ã€GameLiveã¨çµ±åˆã—ã¦ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

Phoenix LiveViewã§ã¯ã€`Process.send_after/3`ã‚’ä½¿ã£ã¦ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã‚’å®Ÿè£…ã§ãã¾ã™ã€‚

```elixir
# lib/puyo_puyo_web/live/game_live.exï¼ˆæ›´æ–°ï¼‰
defmodule PuyoPuyoWeb.GameLive do
  use PuyoPuyoWeb, :live_view

  alias PuyoPuyo.{Stage, Player, Game}

  # ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã®æ›´æ–°é–“éš”ï¼ˆãƒŸãƒªç§’ï¼‰
  @game_tick_interval 16

  @impl true
  def mount(_params, _session, socket) do
    # ã‚²ãƒ¼ãƒ ã‚’åˆæœŸåŒ–
    game = Game.new()

    socket =
      socket
      |> assign(:game, game)
      |> assign(:score, 0)

    # ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹ï¼ˆLiveViewæ¥ç¶šå®Œäº†å¾Œã«é–‹å§‹ï¼‰
    if connected?(socket) do
      schedule_game_tick()
    end

    {:ok, socket}
  end

  @impl true
  def render(assigns) do
    ~H"""
    <div
      id="game-container"
      class="flex gap-8 p-8"
      phx-window-keydown="keydown"
      phx-throttle="100"
    >
      <div id="game-board" class="relative bg-gray-100 border-2 border-gray-800 rounded-lg">
        <div class="grid" style={"grid-template-columns: repeat(#{@game.stage.cols}, 32px);"}>
          <%= for row <- 0..(@game.stage.rows - 1) do %>
            <%= for col <- 0..(@game.stage.cols - 1) do %>
              <div
                class="border border-gray-300"
                style="width: 32px; height: 32px;"
              >
                <%= render_puyo(Stage.get_puyo(@game.stage, col, row)) %>
              </div>
            <% end %>
          <% end %>
        </div>

        <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã·ã‚ˆãƒšã‚¢ã‚’æç”» -->
        <%= if @game.mode == :playing && @game.player do %>
          <%= render_player_puyo(@game.player, 0) %>
          <%= render_player_puyo(@game.player, 1) %>
        <% end %>

        <!-- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ -->
        <%= if @game.mode == :game_over do %>
          <div class="absolute inset-0 bg-black bg-opacity-75 flex items-center justify-center">
            <div class="bg-white p-8 rounded-lg text-center">
              <h2 class="text-3xl font-bold mb-4">ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</h2>
              <p class="text-xl mb-4">ã‚¹ã‚³ã‚¢: <%= @score %></p>
              <button
                phx-click="restart"
                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
              >
                ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤
              </button>
            </div>
          </div>
        <% end %>
      </div>

      <div id="info-panel" class="bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-bold mb-4">ã·ã‚ˆã·ã‚ˆã‚²ãƒ¼ãƒ </h2>

        <div class="mb-4">
          <h3 class="text-lg font-semibold">ã‚¹ã‚³ã‚¢</h3>
          <p id="score" class="text-3xl font-bold text-blue-600"><%= @score %></p>
        </div>

        <div class="mb-4">
          <h3 class="text-lg font-semibold">é€£é–æ•°</h3>
          <p id="chain" class="text-3xl font-bold text-red-600"><%= @game.chain %></p>
        </div>

        <div class="mb-4">
          <h3 class="text-lg font-semibold">ãƒ¢ãƒ¼ãƒ‰</h3>
          <p class="text-sm text-gray-600"><%= format_mode(@game.mode) %></p>
        </div>

        <div class="mt-6 text-sm text-gray-600">
          <h3 class="font-semibold mb-2">æ“ä½œæ–¹æ³•</h3>
          <ul class="space-y-1">
            <li>â† â†’: ç§»å‹•</li>
            <li>â†‘: å›è»¢</li>
            <li>â†“: é«˜é€Ÿè½ä¸‹</li>
          </ul>
        </div>
      </div>
    </div>
    """
  end

  # ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã®ãƒ†ã‚£ãƒƒã‚¯
  @impl true
  def handle_info(:game_tick, socket) do
    game = socket.assigns.game

    # ã‚²ãƒ¼ãƒ ã‚’æ›´æ–°
    game = Game.update(game, @game_tick_interval)

    socket = assign(socket, :game, game)

    # æ¬¡ã®ãƒ†ã‚£ãƒƒã‚¯ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
    schedule_game_tick()

    {:noreply, socket}
  end

  # ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†
  @impl true
  def handle_event("keydown", %{"key" => key}, socket) do
    game = socket.assigns.game

    # ãƒ—ãƒ¬ã‚¤ä¸­ã®ã¿ã‚­ãƒ¼å…¥åŠ›ã‚’å‡¦ç†
    game =
      if game.mode == :playing && game.player do
        player = handle_key_input(game.player, game.stage, key)
        %{game | player: player}
      else
        game
      end

    {:noreply, assign(socket, :game, game)}
  end

  # ãƒªã‚¹ã‚¿ãƒ¼ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†
  @impl true
  def handle_event("restart", _params, socket) do
    game = Game.new()
    socket = assign(socket, game: game, score: 0)
    {:noreply, socket}
  end

  # ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆé–¢æ•°

  # ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
  defp schedule_game_tick do
    Process.send_after(self(), :game_tick, @game_tick_interval)
  end

  # ã‚­ãƒ¼å…¥åŠ›ã®å‡¦ç†
  defp handle_key_input(player, stage, "ArrowLeft") do
    Player.move_left(player, stage)
  end

  defp handle_key_input(player, stage, "ArrowRight") do
    Player.move_right(player, stage)
  end

  defp handle_key_input(player, stage, "ArrowUp") do
    Player.rotate_right(player, stage)
  end

  defp handle_key_input(player, _stage, _key) do
    player
  end

  # ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
  defp format_mode(:new_puyo), do: "æ–°ã·ã‚ˆç”Ÿæˆä¸­"
  defp format_mode(:playing), do: "ãƒ—ãƒ¬ã‚¤ä¸­"
  defp format_mode(:check_erase), do: "æ¶ˆå»ç¢ºèªä¸­"
  defp format_mode(:check_fall), do: "è½ä¸‹ç¢ºèªä¸­"
  defp format_mode(:falling), do: "è½ä¸‹ä¸­"
  defp format_mode(:game_over), do: "ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼"

  # ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã·ã‚ˆã‚’æç”»
  defp render_player_puyo(player, index) do
    {x, y, type} =
      case index do
        0 ->
          {player.puyo_x, player.puyo_y, player.puyo_type}

        1 ->
          offset_x = Enum.at([0, 1, 0, -1], player.rotation)
          offset_y = Enum.at([-1, 0, 1, 0], player.rotation)
          {player.puyo_x + offset_x, player.puyo_y + offset_y, player.next_puyo_type}
      end

    color = puyo_color(type)

    assigns = %{x: x, y: y, color: color}

    ~H"""
    <div
      class="absolute rounded-full"
      style={"
        left: #{@x * 32}px;
        top: #{@y * 32}px;
        width: 32px;
        height: 32px;
        background-color: #{@color};
        border: 2px solid rgba(0,0,0,0.2);
        z-index: 10;
      "}
    >
    </div>
    """
  end

  # ã·ã‚ˆã®æç”»ï¼ˆ0ã¯ç©ºã€1-4ã¯ã·ã‚ˆã®ç¨®é¡ï¼‰
  defp render_puyo(0), do: nil

  defp render_puyo(type) when type in 1..4 do
    color = puyo_color(type)
    assigns = %{color: color}

    ~H"""
    <div class="w-full h-full rounded-full" style={"background-color: #{@color}; border: 2px solid rgba(0,0,0,0.2);"}></div>
    """
  end

  # ã·ã‚ˆã®è‰²ã‚’è¿”ã™
  defp puyo_color(1), do: "#FF0000"  # èµ¤
  defp puyo_color(2), do: "#00FF00"  # ç·‘
  defp puyo_color(3), do: "#0000FF"  # é’
  defp puyo_color(4), do: "#FFFF00"  # é»„
end
```

### è§£èª¬: Phoenix LiveViewã®ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—

#### Process.send_after/3ã‚’ä½¿ã£ãŸãƒ«ãƒ¼ãƒ—

```elixir
defp schedule_game_tick do
  Process.send_after(self(), :game_tick, @game_tick_interval)
end
```

`Process.send_after/3`ã‚’ä½¿ã£ã¦ã€ä¸€å®šé–“éš”ï¼ˆ16ms â‰ˆ 60FPSï¼‰ã§`:game_tick`ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è‡ªåˆ†è‡ªèº«ã«é€ä¿¡ã—ã¾ã™ã€‚

#### handle_info/2ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯

```elixir
def handle_info(:game_tick, socket) do
  game = socket.assigns.game
  game = Game.update(game, @game_tick_interval)
  socket = assign(socket, :game, game)
  schedule_game_tick()
  {:noreply, socket}
end
```

`:game_tick`ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã£ãŸã‚‰ï¼š
1. ã‚²ãƒ¼ãƒ ã‚’æ›´æ–°
2. çŠ¶æ…‹ã‚’socketã«è¨­å®š
3. æ¬¡ã®ãƒ†ã‚£ãƒƒã‚¯ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
4. LiveViewãŒè‡ªå‹•çš„ã«ç”»é¢ã‚’æ›´æ–°

#### connected?/1ã«ã‚ˆã‚‹é…å»¶é–‹å§‹

```elixir
if connected?(socket) do
  schedule_game_tick()
end
```

`connected?/1`ã¯ã€LiveViewãŒWebSocketæ¥ç¶šã‚’ç¢ºç«‹ã—ãŸã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚åˆå›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚ã¯`false`ã§ã€WebSocketæ¥ç¶šå¾Œã«`true`ã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚ã«ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ãŒé–‹å§‹ã•ã‚Œã‚‹ã®ã‚’é˜²ãã¾ã™ã€‚

#### ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã‚‹æç”»åˆ¶å¾¡

```elixir
<%= if @game.mode == :playing && @game.player do %>
  <%= render_player_puyo(@game.player, 0) %>
  <%= render_player_puyo(@game.player, 1) %>
<% end %>
```

ãƒ—ãƒ¬ã‚¤ä¸­ãƒ¢ãƒ¼ãƒ‰ã§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ã€ã·ã‚ˆãƒšã‚¢ã‚’æç”»ã—ã¾ã™ã€‚

### ãƒ†ã‚¹ãƒˆ: é€£é–åå¿œ

æ¬¡ã«ã€é€£é–åå¿œãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‹ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

```elixir
# test/puyo_puyo/game_test.exsï¼ˆç¶šãï¼‰
describe "Game chain reaction" do
  test "chain reaction occurs when erasable puyos fall" do
    game = Game.new()
    stage = game.stage

    # èµ¤ã·ã‚ˆã‚’2Ã—2ã®æ­£æ–¹å½¢ã«é…ç½®ï¼ˆæ¶ˆå»å¯¾è±¡ï¼‰
    stage =
      stage
      |> Stage.set_puyo(1, 10, 1)
      |> Stage.set_puyo(2, 10, 1)
      |> Stage.set_puyo(1, 11, 1)
      |> Stage.set_puyo(2, 11, 1)

    # é’ã·ã‚ˆã‚’é…ç½®ï¼ˆèµ¤ã·ã‚ˆæ¶ˆå»å¾Œã«è½ä¸‹ã—ã¦é€£é–ã‚’èµ·ã“ã™ï¼‰
    stage =
      stage
      |> Stage.set_puyo(3, 10, 2)  # æ¨ªã«1ã¤
      |> Stage.set_puyo(2, 7, 2)   # ä¸Šã‹ã‚‰ç¸¦ã«3ã¤
      |> Stage.set_puyo(2, 8, 2)
      |> Stage.set_puyo(2, 9, 2)

    game = %{game | stage: stage, mode: :check_erase}

    # 1å›ç›®ã®æ›´æ–°ï¼šæ¶ˆå»ç¢ºèªï¼ˆèµ¤ã·ã‚ˆãŒæ¶ˆå»ã•ã‚Œã‚‹ï¼‰
    game = Game.update(game, 16.0)
    assert game.mode == :check_fall
    assert game.chain == 1

    # 2å›ç›®ã®æ›´æ–°ï¼šè½ä¸‹ç¢ºèªï¼ˆé’ã·ã‚ˆãŒè½ä¸‹ï¼‰
    game = Game.update(game, 16.0)
    assert game.mode == :falling

    # è½ä¸‹ãŒå®Œäº†ã™ã‚‹ã¾ã§æ›´æ–°ã‚’ç¹°ã‚Šè¿”ã™
    game = repeat_update_until_mode(game, :check_erase, 10)

    # 3å›ç›®ã®æ¶ˆå»ç¢ºèªï¼ˆé’ã·ã‚ˆãŒ4ã¤æƒã£ã¦æ¶ˆå»ï¼‰
    assert game.chain == 1
    game = Game.update(game, 16.0)

    # é€£é–ãŒç™ºç”Ÿã—ãŸã“ã¨ã‚’ç¢ºèª
    assert game.chain == 2
  end
end

# ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
defp repeat_update_until_mode(game, target_mode, max_iterations) do
  Enum.reduce_while(1..max_iterations, game, fn _, game_acc ->
    if game_acc.mode == target_mode do
      {:halt, game_acc}
    else
      {:cont, Game.update(game_acc, 16.0)}
    end
  end)
end
```

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆçµ±åˆãƒ†ã‚¹ãƒˆï¼‰

æœ€å¾Œã«ã€ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã€çµ±åˆãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ï¼š

```bash
mix test
```

ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ï¼ˆGreenï¼‰ã€‚

### å‹•ä½œç¢ºèª

ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```bash
mix phx.server
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://localhost:4000/game` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¾ã™ï¼š

- ã·ã‚ˆãƒšã‚¢ãŒè‡ªå‹•çš„ã«è½ä¸‹ã™ã‚‹
- çŸ¢å°ã‚­ãƒ¼ã§ã·ã‚ˆãƒšã‚¢ã‚’æ“ä½œã§ãã‚‹
- ç€åœ°å¾Œã€è‡ªå‹•çš„ã«æ¬¡ã®ã·ã‚ˆãƒšã‚¢ãŒç”Ÿæˆã•ã‚Œã‚‹
- åŒã˜è‰²ã®ã·ã‚ˆãŒ4ã¤ã¤ãªãŒã‚‹ã¨æ¶ˆå»ã•ã‚Œã‚‹
- æ¶ˆå»å¾Œã«ä¸Šã®ã·ã‚ˆãŒè½ä¸‹ã™ã‚‹
- é€£é–ãŒç™ºç”Ÿã™ã‚‹

### ã‚³ãƒŸãƒƒãƒˆ

æ©Ÿèƒ½ãŒå®Œæˆã—ãŸã®ã§ã€ã‚³ãƒŸãƒƒãƒˆã—ã¾ã—ã‚‡ã†ï¼š

```bash
git add -A
git commit -m "feat: ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã¨ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã®å®Ÿè£…

- Gameãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆï¼ˆlib/puyo_puyo/game.exï¼‰
- ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã®å®šç¾©ï¼ˆ:new_puyo, :playing, :check_erase, :check_fall, :falling, :game_overï¼‰
- çŠ¶æ…‹é·ç§»ã®å®Ÿè£…
  - æ–°ã·ã‚ˆç”Ÿæˆ
  - ãƒ—ãƒ¬ã‚¤ä¸­ã®å‡¦ç†
  - æ¶ˆå»ç¢ºèªã¨å®Ÿè¡Œ
  - è½ä¸‹ç¢ºèªã¨å®Ÿè¡Œ
- Process.send_afterã‚’ä½¿ã£ãŸã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
  - handle_info/2ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
  - 16msé–“éš”ã®å®šæœŸæ›´æ–°ï¼ˆ60FPSï¼‰
- ãƒ‡ãƒ«ã‚¿æ™‚é–“ãƒ™ãƒ¼ã‚¹ã®æ›´æ–°
- é‡åŠ›ã®è‡ªå‹•é©ç”¨
- é€£é–åå¿œã®å®Ÿè£…
- GameLiveã¨ã®çµ±åˆ
  - ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã®é–‹å§‹
  - ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º
  - ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢
  - ãƒªã‚¹ã‚¿ãƒ¼ãƒˆæ©Ÿèƒ½
- åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ï¼ˆé€£é–ãƒ†ã‚¹ãƒˆã‚’å«ã‚€ï¼‰

ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³4å®Œäº†"
```

### ã¾ã¨ã‚

ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³4ã§ä»¥ä¸‹ã‚’é”æˆã—ã¾ã—ãŸï¼š

#### å¾—ã‚‰ã‚ŒãŸã‚‚ã®

1. **Gameãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**
   - ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ç®¡ç†
   - ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã‚‹å‡¦ç†ã®åˆ†å²
   - é€£é–æ•°ã®ç®¡ç†

2. **ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰**
   - `:new_puyo`: æ–°ã—ã„ã·ã‚ˆãƒšã‚¢ç”Ÿæˆ
   - `:playing`: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œ
   - `:check_erase`: æ¶ˆå»åˆ¤å®š
   - `:check_fall`: è½ä¸‹ç¢ºèª
   - `:falling`: è½ä¸‹ä¸­
   - `:game_over`: ã‚²ãƒ¼ãƒ çµ‚äº†

3. **ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—**
   - `Process.send_after/3`ã«ã‚ˆã‚‹å®šæœŸæ›´æ–°
   - `handle_info/2`ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
   - 16msé–“éš”ã®æ›´æ–°ï¼ˆ60FPSï¼‰
   - `connected?/1`ã«ã‚ˆã‚‹é…å»¶é–‹å§‹

4. **çŠ¶æ…‹é·ç§»**
   - æ–°ã·ã‚ˆ â†’ ãƒ—ãƒ¬ã‚¤ä¸­ â†’ æ¶ˆå»ç¢ºèª â†’ è½ä¸‹ç¢ºèª â†’ ...
   - é€£é–åå¿œã®å®Ÿè£…
   - ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®š

5. **LiveViewã¨ã®çµ±åˆ**
   - ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
   - è‡ªå‹•çš„ãªç”»é¢æ›´æ–°
   - ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º
   - ãƒªã‚¹ã‚¿ãƒ¼ãƒˆæ©Ÿèƒ½

#### å­¦ã‚“ã ã“ã¨

1. **Process.send_after/3**
   ```elixir
   Process.send_after(self(), :game_tick, @game_tick_interval)
   ```
   è‡ªåˆ†è‡ªèº«ã«é…å»¶ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ã§ã€å®šæœŸçš„ãªå‡¦ç†ã‚’å®Ÿç¾

2. **handle_info/2ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯**
   ```elixir
   def handle_info(:game_tick, socket) do
     # ã‚²ãƒ¼ãƒ ã‚’æ›´æ–°
     schedule_game_tick()
     {:noreply, socket}
   end
   ```
   ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã£ã¦å‡¦ç†ã™ã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯

3. **ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã®ãƒ‘ã‚¿ãƒ¼ãƒ³**
   - æ›´æ–°ï¼ˆUpdateï¼‰: çŠ¶æ…‹ã®å¤‰æ›´
   - æç”»ï¼ˆRenderï¼‰: LiveViewãŒè‡ªå‹•çš„ã«å®Ÿè¡Œ
   - ãƒ«ãƒ¼ãƒ—ï¼ˆLoopï¼‰: Process.send_afterã§å®Ÿç¾

4. **çŠ¶æ…‹é·ç§»ãƒ‘ã‚¿ãƒ¼ãƒ³**
   ```elixir
   case mode do
     :new_puyo -> handle_new_puyo(game)
     :playing -> handle_playing(game, delta_time)
     # ...
   end
   ```
   ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã«ã‚ˆã‚‹çŠ¶æ…‹é·ç§»ã®å®Ÿè£…

5. **connected?/1ã«ã‚ˆã‚‹åˆ¶å¾¡**
   - åˆå›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¨WebSocketæ¥ç¶šå¾Œã®å‡¦ç†ã‚’åˆ†é›¢
   - ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚ã®ä¸è¦ãªå‡¦ç†ã‚’é˜²ã

#### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

ã‚²ãƒ¼ãƒ ã®åŸºæœ¬çš„ãªæµã‚ŒãŒå®Œæˆã—ã¾ã—ãŸã€‚æ¬¡ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ä»¥ä¸‹ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ï¼š

- **ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³5**: ã‚¹ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…ï¼ˆã‚¹ã‚³ã‚¢è¨ˆç®—ã€é€£é–ãƒœãƒ¼ãƒŠã‚¹ï¼‰
- **ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³6**: UI/UXã®æ”¹å–„ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼‰

ã“ã‚Œã‚‰ã‚’ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®ã‚µã‚¤ã‚¯ãƒ«ã«å¾“ã£ã¦ã€ä¸€ã¤ãšã¤å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã†ï¼

---

## ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³5: ã‚¹ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…

ã‚²ãƒ¼ãƒ ã®åŸºæœ¬çš„ãªæµã‚ŒãŒå®Œæˆã—ã¾ã—ãŸãŒã€ã·ã‚ˆã·ã‚ˆã®é†é†å‘³ã®ä¸€ã¤ã¯ã€Œã‚¹ã‚³ã‚¢ã€ã¨ã€Œé€£é–ãƒœãƒ¼ãƒŠã‚¹ã€ã§ã™ï¼ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯é«˜ã„ã‚¹ã‚³ã‚¢ã‚’ç›®æŒ‡ã—ã¦ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã€ã‚¹ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ ã¯ã‚²ãƒ¼ãƒ ã®é¢ç™½ã•ã‚’å¤§ããå·¦å³ã—ã¾ã™ã€‚ã“ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ã‚¹ã‚³ã‚¢è¨ˆç®—ã¨é€£é–ãƒœãƒ¼ãƒŠã‚¹ã®å®Ÿè£…ã«ç„¦ç‚¹ã‚’å½“ã¦ã¾ã™ã€‚

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼

ã¾ãšã¯ã€ã“ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å®Ÿè£…ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ï¼š

> ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ã€ã·ã‚ˆã‚’æ¶ˆå»ã—ãŸã¨ãã«ã‚¹ã‚³ã‚¢ãŒåŠ ç®—ã•ã‚Œã€é€£é–ãŒç™ºç”Ÿã™ã‚‹ã¨é«˜ã„é€£é–ãƒœãƒ¼ãƒŠã‚¹ãŒå¾—ã‚‰ã‚Œã‚‹

ã€Œã‚¹ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ ãŒã‚ã‚‹ã¨ã‚²ãƒ¼ãƒ ãŒã‚‚ã£ã¨é¢ç™½ããªã‚Šã¾ã™ã­ï¼ã€ãã†ã§ã™ï¼ã‚¹ã‚³ã‚¢ã¨é€£é–ãƒœãƒ¼ãƒŠã‚¹ã¯ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é«˜ã‚ã‚‹é‡è¦ãªè¦ç´ ã§ã™ã€‚

### TODOãƒªã‚¹ãƒˆ

ã€Œã©ã‚“ãªä½œæ¥­ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã‹ï¼Ÿã€ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã€TODOãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

> TODOãƒªã‚¹ãƒˆã¯ã€å®Ÿè£…å‰ã«å¿…è¦ãªã‚¿ã‚¹ã‚¯ã‚’æ˜ç¢ºã«ã™ã‚‹ã“ã¨ã§ã€é–‹ç™ºã®æ–¹å‘æ€§ã‚’ä¿ã¡ã€ä½•ã‚‚è¦‹è½ã¨ã•ãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚
>
> â€” Kent Beck ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã€

ã‚¹ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¿ã‚¹ã‚¯ãŒå¿…è¦ãã†ã§ã™ã­ï¼š

- Scoreãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ
- ã‚¹ã‚³ã‚¢è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…ï¼ˆåŸºæœ¬ç‚¹ + é€£é–ãƒœãƒ¼ãƒŠã‚¹ï¼‰
- Gameãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã®çµ±åˆï¼ˆæ¶ˆå»æ™‚ã®ã‚¹ã‚³ã‚¢è¨˜éŒ²ï¼‰
- LiveViewã§ã®ã‚¹ã‚³ã‚¢è¡¨ç¤º
- ã‚¹ã‚³ã‚¢ã®ãƒ†ã‚¹ãƒˆä½œæˆ

ã€Œãªã‚‹ã»ã©ã€é †ç•ªã«å®Ÿè£…ã—ã¦ã„ã‘ã°ã„ã„ã‚“ã§ã™ã­ï¼ã€ãã†ã§ã™ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®æµã‚Œã«æ²¿ã£ã¦ã€ã¾ãšã¯ãƒ†ã‚¹ãƒˆã‹ã‚‰æ›¸ã„ã¦ã„ãã¾ã™ã‚ˆã€‚

### ãƒ†ã‚¹ãƒˆ: Scoreãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

ã€Œæœ€åˆã«ä½•ã‚’ãƒ†ã‚¹ãƒˆã™ã‚Œã°ã„ã„ã‚“ã§ã—ã‚‡ã†ã‹ï¼Ÿã€ã¾ãšã¯ã€Scoreãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®åŸºæœ¬çš„ãªæ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã—ã‚‡ã†ã€‚ã‚¹ã‚³ã‚¢è¨ˆç®—ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

#### test/puyo_puyo/score_test.exs

```elixir
defmodule PuyoPuyo.ScoreTest do
  use ExUnit.Case, async: true
  alias PuyoPuyo.Score

  describe "Score.new/0" do
    test "creates a new score with zero values" do
      score = Score.new()
      assert score.current_score == 0
      assert score.current_chain == 0
    end
  end

  describe "Score.record_erase/3" do
    test "calculates score from erase count" do
      score = Score.new()
      # 4å€‹æ¶ˆå»ã€é€£é–ãªã—ï¼ˆ1é€£é–ç›®ï¼‰
      score = Score.record_erase(score, 4, 1)

      # åŸºæœ¬ç‚¹ = 4 Ã— 10 = 40
      assert score.current_score == 40
      assert score.current_chain == 1
    end

    test "adds chain bonus for multiple chains" do
      score = Score.new()
      # 1é€£é–ç›®: 4å€‹æ¶ˆå»
      score = Score.record_erase(score, 4, 1)
      # åŸºæœ¬ç‚¹ = 4 Ã— 10 = 40
      assert score.current_score == 40

      # 2é€£é–ç›®: 4å€‹æ¶ˆå»
      score = Score.record_erase(score, 4, 2)
      # åŸºæœ¬ç‚¹ = 4 Ã— 10 = 40
      # é€£é–ãƒœãƒ¼ãƒŠã‚¹ = 2 Ã— 2 Ã— 50 = 200
      # åˆè¨ˆ = 40 + (40 + 200) = 280
      assert score.current_score == 280
      assert score.current_chain == 2
    end

    test "calculates higher bonus for longer chains" do
      score = Score.new()
      # 1é€£é–ç›®: 4å€‹æ¶ˆå»
      score = Score.record_erase(score, 4, 1)
      # 2é€£é–ç›®: 4å€‹æ¶ˆå»
      score = Score.record_erase(score, 4, 2)
      # 3é€£é–ç›®: 4å€‹æ¶ˆå»
      score = Score.record_erase(score, 4, 3)
      # åŸºæœ¬ç‚¹ = 40 + (40 + 200) + (40 + 450) = 770
      # 3é€£é–ã®ãƒœãƒ¼ãƒŠã‚¹ = 3 Ã— 3 Ã— 50 = 450
      assert score.current_score == 770
      assert score.current_chain == 3
    end
  end

  describe "Score.end_chain/1" do
    test "resets current chain to zero" do
      score = Score.new()
      score = Score.record_erase(score, 4, 2)
      assert score.current_chain == 2

      score = Score.end_chain(score)
      assert score.current_chain == 0
      # ã‚¹ã‚³ã‚¢ã¯ä¿æŒã•ã‚Œã‚‹
      assert score.current_score > 0
    end
  end

  describe "Score.reset/1" do
    test "resets both score and chain to zero" do
      score = Score.new()
      score = Score.record_erase(score, 4, 2)

      score = Score.reset(score)
      assert score.current_score == 0
      assert score.current_chain == 0
    end
  end
end
```

ã€Œã“ã®ãƒ†ã‚¹ãƒˆã§ã¯ä½•ã‚’ç¢ºèªã—ã¦ã„ã‚‹ã‚“ã§ã™ã‹ï¼Ÿã€ã“ã®ãƒ†ã‚¹ãƒˆã§ã¯ã€ä»¥ä¸‹ã®ã‚±ãƒ¼ã‚¹ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ï¼š

1. **Score.new/0**: åˆæœŸåŒ–æ™‚ã«ã‚¹ã‚³ã‚¢ã¨é€£é–æ•°ãŒ0ã§ã‚ã‚‹ã“ã¨
2. **Score.record_erase/3**: æ¶ˆå»æ•°ã‹ã‚‰ã‚¹ã‚³ã‚¢ã‚’æ­£ã—ãè¨ˆç®—ã™ã‚‹ã“ã¨
   - åŸºæœ¬ç‚¹ = æ¶ˆå»æ•° Ã— 10
   - é€£é–ãƒœãƒ¼ãƒŠã‚¹ = é€£é–æ•° Ã— é€£é–æ•° Ã— 50ï¼ˆ2é€£é–ä»¥ä¸Šã®å ´åˆï¼‰
3. **Score.end_chain/1**: é€£é–çµ‚äº†æ™‚ã«é€£é–æ•°ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã“ã¨
4. **Score.reset/1**: ã‚¹ã‚³ã‚¢ã¨é€£é–æ•°ã®ä¸¡æ–¹ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã“ã¨

ã€Œã‚¹ã‚³ã‚¢è¨ˆç®—ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯ã©ã†ãªã£ã¦ã„ã‚‹ã‚“ã§ã™ã‹ï¼Ÿã€è‰¯ã„è³ªå•ã§ã™ã­ï¼ã‚¹ã‚³ã‚¢è¨ˆç®—ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ï¼š

```
ç²å¾—ç‚¹ = åŸºæœ¬ç‚¹ + é€£é–ãƒœãƒ¼ãƒŠã‚¹
åŸºæœ¬ç‚¹ = æ¶ˆå»æ•° Ã— 10
é€£é–ãƒœãƒ¼ãƒŠã‚¹ = (é€£é–æ•° â‰¥ 2 ã®å ´åˆ) é€£é–æ•° Ã— é€£é–æ•° Ã— 50
```

ä¾‹ãˆã°ã€2é€£é–ã§4å€‹æ¶ˆå»ã™ã‚‹ã¨ï¼š
- åŸºæœ¬ç‚¹ = 4 Ã— 10 = 40
- é€£é–ãƒœãƒ¼ãƒŠã‚¹ = 2 Ã— 2 Ã— 50 = 200
- ç²å¾—ç‚¹ = 40 + 200 = 240

ã€Œãªã‚‹ã»ã©ã€é€£é–ãŒé•·ããªã‚‹ã»ã©ãƒœãƒ¼ãƒŠã‚¹ãŒå¤§ãããªã‚‹ã‚“ã§ã™ã­ï¼ã€ãã†ã§ã™ï¼ã§ã¯ã€ã“ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

### å®Ÿè£…: Scoreãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

ã€Œãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸã‚‰ã€å®Ÿè£…ã«é€²ã¿ã¾ã—ã‚‡ã†ï¼ã€ãã†ã§ã™ã­ã€‚ã§ã¯ã€Scoreãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

> æœ€å°é™ã®å®Ÿè£…
>
> ãƒ†ã‚¹ãƒˆã‚’é€šã™ãŸã‚ã«ã€ã©ã‚Œã ã‘ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã‘ã°ã‚ˆã„ã ã‚ã†ã‹â€”â€”ãƒ†ã‚¹ãƒˆãŒé€šã‚‹æœ€å°é™ã®ã‚³ãƒ¼ãƒ‰ã ã‘ã‚’æ›¸ã“ã†ã€‚
>
> â€” Kent Beck ã€ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã€

#### lib/puyo_puyo/score.ex

```elixir
defmodule PuyoPuyo.Score do
  @moduledoc """
  ã‚¹ã‚³ã‚¢ç®¡ç†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

  ã·ã‚ˆã®æ¶ˆå»ã¨ã‚¹ã‚³ã‚¢è¨ˆç®—ã‚’è¡Œã„ã¾ã™ã€‚
  """

  @type t :: %__MODULE__{
    current_score: non_neg_integer(),
    current_chain: non_neg_integer()
  }

  defstruct current_score: 0,
            current_chain: 0

  @doc """
  æ–°ã—ã„ã‚¹ã‚³ã‚¢ã‚’ä½œæˆã—ã¾ã™ã€‚

  ## Examples

      iex> score = Score.new()
      iex> score.current_score
      0
      iex> score.current_chain
      0
  """
  @spec new() :: t()
  def new do
    %__MODULE__{
      current_score: 0,
      current_chain: 0
    }
  end

  @doc """
  æ¶ˆå»ã‚’è¨˜éŒ²ã—ã¦ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ã—ã¾ã™ã€‚

  ## ã‚¹ã‚³ã‚¢è¨ˆç®—å¼

  - åŸºæœ¬ç‚¹ = æ¶ˆå»æ•° Ã— 10
  - é€£é–ãƒœãƒ¼ãƒŠã‚¹ = (é€£é–æ•° â‰¥ 2 ã®å ´åˆ) é€£é–æ•° Ã— é€£é–æ•° Ã— 50
  - ç²å¾—ç‚¹ = åŸºæœ¬ç‚¹ + é€£é–ãƒœãƒ¼ãƒŠã‚¹

  ## Examples

      iex> score = Score.new()
      iex> score = Score.record_erase(score, 4, 1)
      iex> score.current_score
      40

      iex> score = Score.new()
      iex> score = Score.record_erase(score, 4, 1)
      iex> score = Score.record_erase(score, 4, 2)
      iex> score.current_score
      280
  """
  @spec record_erase(t(), non_neg_integer(), non_neg_integer()) :: t()
  def record_erase(%__MODULE__{} = score, erase_count, chain) do
    # ã‚¹ã‚³ã‚¢è¨ˆç®—
    base_points = erase_count * 10
    chain_bonus = if chain >= 2, do: chain * chain * 50, else: 0
    gained_points = base_points + chain_bonus

    %{score |
      current_score: score.current_score + gained_points,
      current_chain: chain
    }
  end

  @doc """
  é€£é–ã‚’çµ‚äº†ã—ã¾ã™ã€‚

  é€£é–æ•°ã‚’0ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ãŒã€ã‚¹ã‚³ã‚¢ã¯ä¿æŒã•ã‚Œã¾ã™ã€‚

  ## Examples

      iex> score = Score.new()
      iex> score = Score.record_erase(score, 4, 2)
      iex> score = Score.end_chain(score)
      iex> score.current_chain
      0
  """
  @spec end_chain(t()) :: t()
  def end_chain(%__MODULE__{} = score) do
    %{score | current_chain: 0}
  end

  @doc """
  ã‚¹ã‚³ã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚

  ã‚¹ã‚³ã‚¢ã¨é€£é–æ•°ã®ä¸¡æ–¹ã‚’0ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚

  ## Examples

      iex> score = Score.new()
      iex> score = Score.record_erase(score, 4, 2)
      iex> score = Score.reset(score)
      iex> score.current_score
      0
      iex> score.current_chain
      0
  """
  @spec reset(t()) :: t()
  def reset(%__MODULE__{}) do
    new()
  end
end
```

ã€Œå®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆã¯ã©ã“ã§ã™ã‹ï¼Ÿã€è‰¯ã„è³ªå•ã§ã™ã­ï¼ä»¥ä¸‹ã®ãƒã‚¤ãƒ³ãƒˆã«æ³¨ç›®ã—ã¦ãã ã•ã„ï¼š

1. **æ§‹é€ ä½“ã®å®šç¾©**
   ```elixir
   defstruct current_score: 0,
             current_chain: 0
   ```
   ç¾åœ¨ã®ã‚¹ã‚³ã‚¢ã¨é€£é–æ•°ã‚’ä¿æŒã™ã‚‹æ§‹é€ ä½“ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

2. **ã‚¹ã‚³ã‚¢è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯**
   ```elixir
   base_points = erase_count * 10
   chain_bonus = if chain >= 2, do: chain * chain * 50, else: 0
   gained_points = base_points + chain_bonus
   ```
   åŸºæœ¬ç‚¹ã¨é€£é–ãƒœãƒ¼ãƒŠã‚¹ã‚’è¨ˆç®—ã—ã€ç²å¾—ç‚¹ã‚’ç®—å‡ºã—ã¦ã„ã¾ã™ã€‚

3. **ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ãªæ›´æ–°**
   ```elixir
   %{score |
     current_score: score.current_score + gained_points,
     current_chain: chain
   }
   ```
   æ—¢å­˜ã®æ§‹é€ ä½“ã‚’å¤‰æ›´ã™ã‚‹ã®ã§ã¯ãªãã€æ–°ã—ã„æ§‹é€ ä½“ã‚’ä½œæˆã—ã¦è¿”ã—ã¦ã„ã¾ã™ã€‚

ã€Œãªã‚‹ã»ã©ã€Elixirã®ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ãªç‰¹æ€§ã‚’æ´»ã‹ã—ãŸå®Ÿè£…ãªã‚“ã§ã™ã­ï¼ã€ãã†ã§ã™ï¼ã§ã¯ã€ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

### ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

```bash
mix test test/puyo_puyo/score_test.exs
```

ãƒ†ã‚¹ãƒˆãŒå…¨ã¦é€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

```
Compiling 1 file (.ex)
.....

Finished in 0.03 seconds (0.00s async, 0.03s sync)
5 tests, 0 failures
```

ã€Œå…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚Šã¾ã—ãŸï¼ã€ç´ æ™´ã‚‰ã—ã„ï¼ã“ã‚Œã§ã€Scoreãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®åŸºæœ¬çš„ãªæ©Ÿèƒ½ãŒå®Œæˆã—ã¾ã—ãŸã€‚

### Gameãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã®çµ±åˆ

ã€Œæ¬¡ã¯ä½•ã‚’ã™ã‚Œã°ã„ã„ã§ã™ã‹ï¼Ÿã€æ¬¡ã¯ã€Gameãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«Scoreã‚’çµ±åˆã—ã¦ã€æ¶ˆå»ãŒç™ºç”Ÿã—ãŸã¨ãã«ã‚¹ã‚³ã‚¢ã‚’è¨˜éŒ²ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

#### test/puyo_puyo/game_test.exsï¼ˆè¿½åŠ ï¼‰

```elixir
describe "Game with score" do
  test "records score when puyos are erased" do
    game = Game.new()
    stage = game.stage

    # èµ¤ã·ã‚ˆã‚’2Ã—2ã®æ­£æ–¹å½¢ã«é…ç½®ï¼ˆæ¶ˆå»å¯¾è±¡ï¼‰
    stage = stage
      |> Stage.set_puyo(1, 10, 1)
      |> Stage.set_puyo(2, 10, 1)
      |> Stage.set_puyo(1, 11, 1)
      |> Stage.set_puyo(2, 11, 1)

    game = %{game | stage: stage, mode: :check_erase}

    # æ¶ˆå»ç¢ºèªã‚’å®Ÿè¡Œ
    game = Game.update(game, 0)

    # ã‚¹ã‚³ã‚¢ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    # åŸºæœ¬ç‚¹ = 4 Ã— 10 = 40
    assert game.score.current_score == 40
    assert game.score.current_chain == 1
  end

  test "adds chain bonus when chain occurs" do
    game = Game.new()
    stage = game.stage

    # èµ¤ã·ã‚ˆã‚’2Ã—2ã®æ­£æ–¹å½¢ã«é…ç½®ï¼ˆæ¶ˆå»å¯¾è±¡ï¼‰
    stage = stage
      |> Stage.set_puyo(1, 10, 1)
      |> Stage.set_puyo(2, 10, 1)
      |> Stage.set_puyo(1, 11, 1)
      |> Stage.set_puyo(2, 11, 1)

    # é’ã·ã‚ˆã‚’é…ç½®ï¼ˆèµ¤ã·ã‚ˆæ¶ˆå»å¾Œã«è½ä¸‹ã—ã¦é€£é–ã‚’èµ·ã“ã™ï¼‰
    stage = stage
      |> Stage.set_puyo(3, 10, 2) # æ¨ªã«1ã¤
      |> Stage.set_puyo(2, 7, 2)  # ä¸Šã‹ã‚‰ç¸¦ã«3ã¤
      |> Stage.set_puyo(2, 8, 2)
      |> Stage.set_puyo(2, 9, 2)

    game = %{game | stage: stage, mode: :check_erase}

    # é€£é–ãŒå®Œäº†ã™ã‚‹ã¾ã§æ›´æ–°ã‚’ç¹°ã‚Šè¿”ã™
    game = Enum.reduce_while(1..20, game, fn _, acc ->
      acc = Game.update(acc, 0)
      if acc.mode == :new_puyo do
        {:halt, acc}
      else
        {:cont, acc}
      end
    end)

    # 2é€£é–åˆ†ã®ã‚¹ã‚³ã‚¢ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    # 1é€£é–ç›®: 4 Ã— 10 = 40
    # 2é€£é–ç›®: 4 Ã— 10 + 2 Ã— 2 Ã— 50 = 40 + 200 = 240
    # åˆè¨ˆ: 40 + 240 = 280
    assert game.score.current_score == 280
    assert game.score.current_chain == 0  # é€£é–çµ‚äº†ã§ãƒªã‚»ãƒƒãƒˆ
  end
end
```

ã€Œã“ã®ãƒ†ã‚¹ãƒˆã§ã¯ä½•ã‚’ç¢ºèªã—ã¦ã„ã‚‹ã‚“ã§ã™ã‹ï¼Ÿã€ã“ã®ãƒ†ã‚¹ãƒˆã§ã¯ã€ä»¥ä¸‹ã®ã‚±ãƒ¼ã‚¹ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ï¼š

1. **å˜ç´”ãªæ¶ˆå»**: 4å€‹æ¶ˆå»ã—ãŸã¨ãã«ã‚¹ã‚³ã‚¢ãŒæ­£ã—ãè¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨
2. **é€£é–ç™ºç”Ÿ**: é€£é–ãŒç™ºç”Ÿã—ãŸã¨ãã«é€£é–ãƒœãƒ¼ãƒŠã‚¹ãŒåŠ ç®—ã•ã‚Œã‚‹ã“ã¨

ã€Œé€£é–çµ‚äº†æ™‚ã«é€£é–æ•°ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ã®ã¯ã©ã†ã—ã¦ã§ã™ã‹ï¼Ÿã€è‰¯ã„è³ªå•ã§ã™ã­ï¼é€£é–ã¯ä¸€é€£ã®æµã‚ŒãŒçµ‚ã‚ã£ãŸã‚‰ãƒªã‚»ãƒƒãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚æ¬¡ã®æ–°ã—ã„ã·ã‚ˆãŒç”Ÿæˆã•ã‚Œã‚‹ã¨ãã«ã¯ã€é€£é–ã‚«ã‚¦ãƒ³ãƒˆã¯0ã‹ã‚‰å§‹ã¾ã‚Šã¾ã™ã€‚

### å®Ÿè£…: Gameãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ›´æ–°

ã€Œã§ã¯ã€Gameãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¦ã‚¹ã‚³ã‚¢ã‚’çµ±åˆã—ã¾ã—ã‚‡ã†ï¼ã€ãã†ã§ã™ã­ã€‚ä»¥ä¸‹ã®å¤‰æ›´ã‚’åŠ ãˆã¾ã™ï¼š

#### lib/puyo_puyo/game.exï¼ˆæ›´æ–°ï¼‰

```elixir
defmodule PuyoPuyo.Game do
  @moduledoc """
  ã‚²ãƒ¼ãƒ å…¨ä½“ã®çŠ¶æ…‹ã¨ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç®¡ç†ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
  """

  alias PuyoPuyo.{Stage, Player, Score}

  @type game_mode :: :new_puyo | :playing | :check_erase | :check_fall | :falling | :game_over

  @type t :: %__MODULE__{
    mode: game_mode(),
    chain: non_neg_integer(),
    stage: Stage.t(),
    player: Player.t(),
    score: Score.t(),
    last_update: integer()
  }

  defstruct mode: :new_puyo,
            chain: 0,
            stage: nil,
            player: nil,
            score: nil,
            last_update: 0

  @doc """
  æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã™ã€‚
  """
  @spec new() :: t()
  def new do
    stage = Stage.new()
    player = Player.new(stage)
    score = Score.new()

    %__MODULE__{
      mode: :new_puyo,
      chain: 0,
      stage: stage,
      player: player,
      score: score,
      last_update: System.monotonic_time(:millisecond)
    }
  end

  @doc """
  ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¾ã™ã€‚
  """
  @spec update(t(), number()) :: t()
  def update(%__MODULE__{mode: mode} = game, delta_time) do
    case mode do
      :new_puyo -> handle_new_puyo(game)
      :playing -> handle_playing(game, delta_time)
      :check_erase -> handle_check_erase(game)
      :check_fall -> handle_check_fall(game)
      :falling -> handle_falling(game)
      :game_over -> game
    end
  end

  # æ–°ã—ã„ã·ã‚ˆã‚’ç”Ÿæˆ
  defp handle_new_puyo(%__MODULE__{} = game) do
    if Player.can_generate_new_puyo?(game.player) do
      player = Player.generate_new_puyo(game.player)
      %{game | player: player, mode: :playing}
    else
      %{game | mode: :game_over}
    end
  end

  # ãƒ—ãƒ¬ã‚¤ä¸­ã®å‡¦ç†
  defp handle_playing(%__MODULE__{} = game, delta_time) do
    player = Player.update(game.player, delta_time)

    if Player.has_landed?(player) do
      # ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã·ã‚ˆã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ã«å›ºå®š
      stage = Player.fix_puyo_to_stage(player, game.stage)
      %{game | stage: stage, mode: :check_erase}
    else
      %{game | player: player}
    end
  end

  # æ¶ˆå»ç¢ºèª
  defp handle_check_erase(%__MODULE__{} = game) do
    erase_result = Stage.check_erase(game.stage)

    if erase_result.erase_puyo_count > 0 do
      # é€£é–æ•°ã‚’å¢—åŠ 
      chain = game.chain + 1

      # ã‚¹ã‚³ã‚¢ã‚’è¨˜éŒ²
      score = Score.record_erase(game.score, erase_result.erase_puyo_count, chain)

      # ã·ã‚ˆã‚’æ¶ˆå»
      stage = Stage.erase_boards(game.stage, erase_result.erase_info)

      %{game | stage: stage, chain: chain, score: score, mode: :check_fall}
    else
      # æ¶ˆå»ã™ã‚‹ã·ã‚ˆãŒãªã„å ´åˆ
      if game.chain == 0 do
        # é€£é–ãŒç™ºç”Ÿã—ã¦ã„ãªã„å ´åˆã¯è½ä¸‹ç¢ºèªã¸
        %{game | mode: :check_fall}
      else
        # é€£é–çµ‚äº†
        score = Score.end_chain(game.score)
        %{game | chain: 0, score: score, mode: :new_puyo}
      end
    end
  end

  # è½ä¸‹ç¢ºèª
  defp handle_check_fall(%__MODULE__{} = game) do
    if Stage.has_floating_puyo?(game.stage) do
      %{game | mode: :falling}
    else
      if game.chain > 0 do
        # é€£é–ä¸­ã®å ´åˆã¯å†åº¦æ¶ˆå»ç¢ºèªã¸
        %{game | mode: :check_erase}
      else
        # é€£é–ã—ã¦ã„ãªã„å ´åˆã¯æ–°ã·ã‚ˆã¸
        %{game | mode: :new_puyo}
      end
    end
  end

  # è½ä¸‹ä¸­
  defp handle_falling(%__MODULE__{} = game) do
    stage = Stage.apply_gravity(game.stage)

    if Stage.has_floating_puyo?(stage) do
      %{game | stage: stage, mode: :falling}
    else
      %{game | stage: stage, mode: :check_erase}
    end
  end
end
```

ã€Œã©ã“ãŒå¤‰æ›´ã•ã‚ŒãŸã‚“ã§ã™ã‹ï¼Ÿã€ä¸»ãªå¤‰æ›´ç‚¹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š

1. **Scoreæ§‹é€ ä½“ã®è¿½åŠ **
   ```elixir
   defstruct mode: :new_puyo,
             chain: 0,
             stage: nil,
             player: nil,
             score: nil,  # è¿½åŠ 
             last_update: 0
   ```

2. **åˆæœŸåŒ–æ™‚ã«Scoreã‚’ä½œæˆ**
   ```elixir
   def new do
     stage = Stage.new()
     player = Player.new(stage)
     score = Score.new()  # è¿½åŠ 

     %__MODULE__{
       mode: :new_puyo,
       chain: 0,
       stage: stage,
       player: player,
       score: score,  # è¿½åŠ 
       last_update: System.monotonic_time(:millisecond)
     }
   end
   ```

3. **æ¶ˆå»ç¢ºèªæ™‚ã«ã‚¹ã‚³ã‚¢ã‚’è¨˜éŒ²**
   ```elixir
   defp handle_check_erase(%__MODULE__{} = game) do
     erase_result = Stage.check_erase(game.stage)

     if erase_result.erase_puyo_count > 0 do
       chain = game.chain + 1

       # ã‚¹ã‚³ã‚¢ã‚’è¨˜éŒ²ï¼ˆè¿½åŠ ï¼‰
       score = Score.record_erase(game.score, erase_result.erase_puyo_count, chain)

       stage = Stage.erase_boards(game.stage, erase_result.erase_info)

       %{game | stage: stage, chain: chain, score: score, mode: :check_fall}
     else
       if game.chain == 0 do
         %{game | mode: :check_fall}
       else
         # é€£é–çµ‚äº†æ™‚ã«ã‚¹ã‚³ã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆè¿½åŠ ï¼‰
         score = Score.end_chain(game.score)
         %{game | chain: 0, score: score, mode: :new_puyo}
       end
     end
   end
   ```

ã€Œãªã‚‹ã»ã©ã€æ¶ˆå»ãŒç™ºç”Ÿã—ãŸã¨ãã«ã‚¹ã‚³ã‚¢ã‚’è¨˜éŒ²ã—ã€é€£é–ãŒçµ‚äº†ã—ãŸã¨ãã«é€£é–æ•°ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã„ã‚‹ã‚“ã§ã™ã­ï¼ã€ãã†ã§ã™ï¼ã§ã¯ã€ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

### ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

```bash
mix test test/puyo_puyo/game_test.exs
```

æ–°ã—ã„ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

```
Compiling 1 file (.ex)
.......

Finished in 0.05 seconds (0.00s async, 0.05s sync)
7 tests, 0 failures
```

ã€Œå…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚Šã¾ã—ãŸï¼ã€ç´ æ™´ã‚‰ã—ã„ï¼ã“ã‚Œã§ã€Gameãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã®çµ±åˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚

### LiveViewã§ã®ã‚¹ã‚³ã‚¢è¡¨ç¤º

ã€Œæœ€å¾Œã«ã€ç”»é¢ã«ã‚¹ã‚³ã‚¢ã‚’è¡¨ç¤ºã—ãŸã„ã§ã™ï¼ã€ã‚‚ã¡ã‚ã‚“ã§ã™ï¼LiveViewã‚’æ›´æ–°ã—ã¦ã‚¹ã‚³ã‚¢ã‚’è¡¨ç¤ºã—ã¾ã—ã‚‡ã†ã€‚

#### lib/puyo_puyo_web/live/game_live.exï¼ˆæ›´æ–°ï¼‰

```elixir
defmodule PuyoPuyoWeb.GameLive do
  use PuyoPuyoWeb, :live_view
  alias PuyoPuyo.Game

  @game_tick_interval 16

  @impl true
  def mount(_params, _session, socket) do
    game = Game.new()

    socket =
      socket
      |> assign(:game, game)
      |> assign(:game_tick_interval, @game_tick_interval)

    if connected?(socket) do
      schedule_game_tick()
    end

    {:ok, socket}
  end

  @impl true
  def handle_info(:game_tick, socket) do
    game = socket.assigns.game
    game = Game.update(game, @game_tick_interval)

    socket = assign(socket, :game, game)
    schedule_game_tick()

    {:noreply, socket}
  end

  @impl true
  def handle_event("restart", _params, socket) do
    game = Game.new()
    {:noreply, assign(socket, :game, game)}
  end

  @impl true
  def handle_event("keydown", %{"key" => key}, socket) do
    game = socket.assigns.game
    player = game.player

    player =
      case key do
        "ArrowLeft" -> Player.move_left(player)
        "ArrowRight" -> Player.move_right(player)
        "ArrowUp" -> Player.rotate_right(player)
        "ArrowDown" -> Player.set_fast_fall(player, true)
        _ -> player
      end

    game = %{game | player: player}
    {:noreply, assign(socket, :game, game)}
  end

  @impl true
  def handle_event("keyup", %{"key" => key}, socket) do
    game = socket.assigns.game
    player = game.player

    player =
      case key do
        "ArrowDown" -> Player.set_fast_fall(player, false)
        _ -> player
      end

    game = %{game | player: player}
    {:noreply, assign(socket, :game, game)}
  end

  @impl true
  def render(assigns) do
    ~H"""
    <div class="game-container" phx-window-keydown="keydown" phx-window-keyup="keyup">
      <div class="game-header">
        <h1>ã·ã‚ˆã·ã‚ˆ</h1>
        <div class="game-info">
          <div class="score-display">
            <span class="label">ã‚¹ã‚³ã‚¢:</span>
            <span class="value" id="score"><%= @game.score.current_score %></span>
          </div>
          <div class="chain-display">
            <span class="label">é€£é–:</span>
            <span class="value" id="chain"><%= @game.score.current_chain %></span>
          </div>
          <div class="mode-display">
            <span class="label">ãƒ¢ãƒ¼ãƒ‰:</span>
            <span class="value"><%= format_mode(@game.mode) %></span>
          </div>
        </div>
      </div>

      <div class="game-stage">
        <%= for y <- 0..(@game.stage.config.stage_rows - 1) do %>
          <div class="stage-row">
            <%= for x <- 0..(@game.stage.config.stage_cols - 1) do %>
              <% puyo_type = get_puyo_at(@game, x, y) %>
              <div class={"stage-cell puyo-#{puyo_type}"}>
                <%= if puyo_type > 0 do %>
                  <div class="puyo"></div>
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>

      <div class="game-controls">
        <button phx-click="restart">ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      </div>
    </div>
    """
  end

  defp format_mode(:new_puyo), do: "æ–°ã·ã‚ˆ"
  defp format_mode(:playing), do: "ãƒ—ãƒ¬ã‚¤ä¸­"
  defp format_mode(:check_erase), do: "æ¶ˆå»ç¢ºèª"
  defp format_mode(:check_fall), do: "è½ä¸‹ç¢ºèª"
  defp format_mode(:falling), do: "è½ä¸‹ä¸­"
  defp format_mode(:game_over), do: "ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼"

  defp get_puyo_at(game, x, y) do
    if game.mode == :playing do
      # ãƒ—ãƒ¬ã‚¤ä¸­ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã·ã‚ˆã‚‚è¡¨ç¤º
      player_puyo = Player.get_puyo_at(game.player, x, y)
      if player_puyo > 0 do
        player_puyo
      else
        Stage.get_puyo(game.stage, x, y)
      end
    else
      Stage.get_puyo(game.stage, x, y)
    end
  end
end
```

ã€Œã©ã“ãŒå¤‰æ›´ã•ã‚ŒãŸã‚“ã§ã™ã‹ï¼Ÿã€ä¸»ãªå¤‰æ›´ç‚¹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š

1. **ã‚¹ã‚³ã‚¢è¡¨ç¤ºã®è¿½åŠ **
   ```elixir
   <div class="score-display">
     <span class="label">ã‚¹ã‚³ã‚¢:</span>
     <span class="value" id="score"><%= @game.score.current_score %></span>
   </div>
   <div class="chain-display">
     <span class="label">é€£é–:</span>
     <span class="value" id="chain"><%= @game.score.current_chain %></span>
   </div>
   ```

2. **ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®æ”¹å–„**
   ```elixir
   <div class="game-header">
     <h1>ã·ã‚ˆã·ã‚ˆ</h1>
     <div class="game-info">
       <!-- ã‚¹ã‚³ã‚¢ã€é€£é–ã€ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º -->
     </div>
   </div>
   ```

ã€Œã‚¹ã‚³ã‚¢ã¨é€£é–ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã‚“ã§ã™ã­ï¼ã€ãã†ã§ã™ï¼ã“ã‚Œã§ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã‚¹ã‚³ã‚¢ã¨é€£é–æ•°ã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

### CSSã®æ›´æ–°

ã€Œã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’ã‚‚ã£ã¨è¦‹ã‚„ã™ãã—ãŸã„ã§ã™ï¼ã€ã‚‚ã¡ã‚ã‚“ã§ã™ï¼CSSã‚’è¿½åŠ ã—ã¦ã€ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’è¦‹ã‚„ã™ãã—ã¾ã—ã‚‡ã†ã€‚

#### assets/css/app.cssï¼ˆè¿½åŠ ï¼‰

```css
.game-header {
  text-align: center;
  margin-bottom: 20px;
}

.game-header h1 {
  margin: 0;
  padding: 10px;
  font-size: 2rem;
  color: #333;
}

.game-info {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin: 10px 0;
  padding: 10px;
  background-color: #f0f0f0;
  border-radius: 8px;
}

.score-display,
.chain-display,
.mode-display {
  display: flex;
  align-items: center;
  gap: 8px;
}

.score-display .label,
.chain-display .label,
.mode-display .label {
  font-weight: bold;
  color: #555;
}

.score-display .value {
  font-size: 1.5rem;
  font-weight: bold;
  color: #ff6b6b;
  min-width: 80px;
  text-align: right;
}

.chain-display .value {
  font-size: 1.5rem;
  font-weight: bold;
  color: #4ecdc4;
  min-width: 40px;
  text-align: right;
}

.mode-display .value {
  font-size: 1rem;
  color: #95a5a6;
  min-width: 100px;
}
```

ã€Œã“ã‚Œã§è¦‹ãŸç›®ã‚‚ã‚ˆããªã‚Šã¾ã—ãŸï¼ã€ãã†ã§ã™ã­ï¼ãã‚Œã§ã¯ã€ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦å‹•ä½œã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

### å‹•ä½œç¢ºèª

```bash
mix phx.server
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://localhost:4000` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

1. ç”»é¢ä¸Šéƒ¨ã«ã‚¹ã‚³ã‚¢ã¨é€£é–æ•°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨
2. ã·ã‚ˆã‚’æ¶ˆå»ã™ã‚‹ã¨ã‚¹ã‚³ã‚¢ãŒåŠ ç®—ã•ã‚Œã‚‹ã“ã¨
3. é€£é–ãŒç™ºç”Ÿã™ã‚‹ã¨é€£é–ãƒœãƒ¼ãƒŠã‚¹ãŒåŠ ç®—ã•ã‚Œã‚‹ã“ã¨
4. é€£é–çµ‚äº†å¾Œã€é€£é–æ•°ãŒ0ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ã“ã¨

ã€Œå®Ÿéš›ã«å‹•ã‹ã—ã¦ã¿ãŸã‚‰ã€é€£é–ãŒç™ºç”Ÿã™ã‚‹ã¨ã‚¹ã‚³ã‚¢ãŒã©ã‚“ã©ã‚“ä¸ŠãŒã£ã¦ã„ãã¾ã—ãŸï¼ã€ç´ æ™´ã‚‰ã—ã„ï¼ãã‚ŒãŒã·ã‚ˆã·ã‚ˆã®é¢ç™½ã•ã§ã™ã­ã€‚

### ã‚³ãƒŸãƒƒãƒˆ

ãã‚Œã§ã¯ã€ã“ã“ã¾ã§ã®å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¾ã—ã‚‡ã†ã€‚

```bash
git add .
git commit -m "feat: ã‚¹ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…

- Scoreãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ
- ã‚¹ã‚³ã‚¢è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆåŸºæœ¬ç‚¹ + é€£é–ãƒœãƒ¼ãƒŠã‚¹ï¼‰
- Gameãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã®çµ±åˆ
- LiveViewã§ã®ã‚¹ã‚³ã‚¢è¡¨ç¤º
- ã‚¹ã‚³ã‚¢è¡¨ç¤ºã®CSSè¿½åŠ 
- åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹
"
```

### ã¾ã¨ã‚

ã“ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ä»¥ä¸‹ã‚’å®Ÿè£…ã—ã¾ã—ãŸï¼š

#### å®Ÿè£…å†…å®¹

1. **Scoreãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**
   ```elixir
   defmodule PuyoPuyo.Score do
     defstruct current_score: 0, current_chain: 0

     def record_erase(score, erase_count, chain)
     def end_chain(score)
     def reset(score)
   end
   ```

2. **ã‚¹ã‚³ã‚¢è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯**
   - åŸºæœ¬ç‚¹ = æ¶ˆå»æ•° Ã— 10
   - é€£é–ãƒœãƒ¼ãƒŠã‚¹ = é€£é–æ•° Ã— é€£é–æ•° Ã— 50ï¼ˆ2é€£é–ä»¥ä¸Šï¼‰
   - ç²å¾—ç‚¹ = åŸºæœ¬ç‚¹ + é€£é–ãƒœãƒ¼ãƒŠã‚¹

3. **Gameãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã®çµ±åˆ**
   - æ¶ˆå»æ™‚ã®ã‚¹ã‚³ã‚¢è¨˜éŒ²
   - é€£é–çµ‚äº†æ™‚ã®é€£é–æ•°ãƒªã‚»ãƒƒãƒˆ

4. **LiveViewã§ã®ã‚¹ã‚³ã‚¢è¡¨ç¤º**
   - ã‚¹ã‚³ã‚¢ã¨é€£é–æ•°ã®è¡¨ç¤º
   - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°

5. **åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆ**
   - Scoreãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å˜ä½“ãƒ†ã‚¹ãƒˆ
   - Gameãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã®çµ±åˆãƒ†ã‚¹ãƒˆ

#### å­¦ã‚“ã ã“ã¨

1. **ã‚¹ã‚³ã‚¢è¨ˆç®—ã®ãƒ­ã‚¸ãƒƒã‚¯**
   ```elixir
   base_points = erase_count * 10
   chain_bonus = if chain >= 2, do: chain * chain * 50, else: 0
   gained_points = base_points + chain_bonus
   ```

2. **æ§‹é€ ä½“ã®æ›´æ–°ãƒ‘ã‚¿ãƒ¼ãƒ³**
   ```elixir
   %{score |
     current_score: score.current_score + gained_points,
     current_chain: chain
   }
   ```

3. **LiveViewã§ã®å‹•çš„ãªè¡¨ç¤º**
   ```elixir
   <span class="value" id="score"><%= @game.score.current_score %></span>
   ```

4. **é€£é–ãƒœãƒ¼ãƒŠã‚¹ã®é‡è¦æ€§**
   - 1é€£é–: 40ç‚¹
   - 2é€£é–: 40 + (40 + 200) = 280ç‚¹
   - 3é€£é–: 40 + (40 + 200) + (40 + 450) = 770ç‚¹

   é€£é–ãŒé•·ããªã‚‹ã»ã©ã€çˆ†ç™ºçš„ã«ã‚¹ã‚³ã‚¢ãŒä¼¸ã³ã‚‹ï¼

5. **ã‚²ãƒ¼ãƒ ãƒ‡ã‚¶ã‚¤ãƒ³ã®åŸå‰‡**
   - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æ˜ç¢ºãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æä¾›
   - é«˜åº¦ãªãƒ—ãƒ¬ã‚¤ã«å¯¾ã—ã¦å ±é…¬ã‚’ä¸ãˆã‚‹
   - è¦–è¦šçš„ã«æƒ…å ±ã‚’ä¼ãˆã‚‹

#### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

ã‚¹ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ ãŒå®Œæˆã—ã¾ã—ãŸï¼æ¬¡ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ä»¥ä¸‹ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ï¼š

- **ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³6**: UI/UXã®æ”¹å–„ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã€ã‚µã‚¦ãƒ³ãƒ‰ï¼‰

ã“ã‚Œã§ã‚²ãƒ¼ãƒ ã¨ã—ã¦ã®åŸºæœ¬çš„ãªæ©Ÿèƒ½ã¯å…¨ã¦æƒã„ã¾ã—ãŸã€‚æ¬¡ã¯ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½“é¨“ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã®æ¼”å‡ºã‚’è¿½åŠ ã—ã¦ã„ãã¾ã—ã‚‡ã†ï¼

