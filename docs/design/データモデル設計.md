# データモデル設計

## 概要

ぷよぷよゲームのデータモデル設計では、ゲームの状態、ぷよの情報、フィールドの状態、スコア情報などを適切に管理する必要があります。

## エンティティ一覧

### 1. ゲーム (Game)

ゲーム全体の状態を管理するルートエンティティ

```plantuml
@startuml "ゲームエンティティ"

class Game {
  -gameState: GameState
  -score: number
  -field: Field
  -currentPuyo: PuyoPair | null
  -nextPuyo: PuyoPair
  -chainCount: number
  -isGameOver: boolean
  
  +startNewGame(): void
  +resetGame(): void
  +updateGame(): void
  +isGameOver(): boolean
  +getScore(): number
  +getCurrentPuyo(): PuyoPair | null
  +getField(): Field
}

enum GameState {
  READY
  PLAYING
  CHAIN_ANIMATION
  GAME_OVER
}

@enduml
```

**属性**:
- `gameState`: ゲームの現在の状態
- `score`: 現在のスコア
- `field`: ゲームフィールド
- `currentPuyo`: 現在操作中のぷよペア
- `nextPuyo`: 次に生成されるぷよペア
- `chainCount`: 現在の連鎖数
- `isGameOver`: ゲームオーバーフラグ

### 2. フィールド (Field)

ぷよが配置されるゲームフィールドを管理

```plantuml
@startuml "フィールドエンティティ"

class Field {
  -width: number = 6
  -height: number = 13
  -cells: (Puyo | null)[][]
  
  +constructor(width: number, height: number)
  +getPuyo(x: number, y: number): Puyo | null
  +setPuyo(x: number, y: number, puyo: Puyo | null): void
  +isValidPosition(x: number, y: number): boolean
  +isEmpty(x: number, y: number): boolean
  +clear(): void
  +findConnectedPuyos(x: number, y: number, color: PuyoColor): Position[]
  +applyGravity(): boolean
  +isEmpty(): boolean
}

class Position {
  +x: number
  +y: number
  
  +constructor(x: number, y: number)
  +equals(other: Position): boolean
}

@enduml
```

**属性**:
- `width`: フィールドの幅（列数）
- `height`: フィールドの高さ（行数）
- `cells`: ぷよを格納する2次元配列

### 3. ぷよ (Puyo)

個々のぷよを表現するエンティティ

```plantuml
@startuml "ぷよエンティティ"

class Puyo {
  -color: PuyoColor
  -position: Position
  
  +constructor(color: PuyoColor, position: Position)
  +getColor(): PuyoColor
  +getPosition(): Position
  +setPosition(position: Position): void
  +equals(other: Puyo): boolean
}

enum PuyoColor {
  RED
  BLUE
  GREEN
  YELLOW
  PURPLE
}

@enduml
```

**属性**:
- `color`: ぷよの色
- `position`: ぷよの位置

### 4. ぷよペア (PuyoPair)

操作単位となる2個1組のぷよ

```plantuml
@startuml "ぷよペアエンティティ"

class PuyoPair {
  -mainPuyo: Puyo
  -subPuyo: Puyo
  -rotation: Rotation
  
  +constructor(mainColor: PuyoColor, subColor: PuyoColor, x: number, y: number)
  +getMainPuyo(): Puyo
  +getSubPuyo(): Puyo
  +moveLeft(): boolean
  +moveRight(): boolean
  +moveDown(): boolean
  +rotateClockwise(): boolean
  +rotateCounterClockwise(): boolean
  +getPositions(): Position[]
  +canMove(field: Field, dx: number, dy: number): boolean
  +canRotate(field: Field, newRotation: Rotation): boolean
}

enum Rotation {
  UP = 0
  RIGHT = 1
  DOWN = 2
  LEFT = 3
}

@enduml
```

**属性**:
- `mainPuyo`: メインのぷよ（回転の中心）
- `subPuyo`: サブのぷよ（回転する側）
- `rotation`: 現在の回転状態

### 5. スコア (Score)

スコア計算とボーナス管理

```plantuml
@startuml "スコアエンティティ"

class Score {
  -totalScore: number
  -chainBonus: number
  -zenkeshiBonus: number = 2000
  
  +constructor()
  +addPuyoScore(puyoCount: number): void
  +addChainBonus(chainCount: number): void
  +addZenkeshiBonus(): void
  +getTotalScore(): number
  +reset(): void
  +calculateChainMultiplier(chainCount: number): number
}

@enduml
```

**属性**:
- `totalScore`: 総スコア
- `chainBonus`: 連鎖ボーナス
- `zenkeshiBonus`: 全消しボーナス

### 6. 入力管理 (InputManager)

プレイヤーの入力を管理

```plantuml
@startuml "入力管理エンティティ"

class InputManager {
  -keyState: Map<string, boolean>
  -lastInputTime: Map<string, number>
  -repeatDelay: number = 150
  
  +constructor()
  +onKeyDown(key: string): void
  +onKeyUp(key: string): void
  +isKeyPressed(key: string): boolean
  +isKeyJustPressed(key: string): boolean
  +update(): void
}

@enduml
```

### 7. レンダラー (Renderer)

画面描画を管理

```plantuml
@startuml "レンダラーエンティティ"

class Renderer {
  -canvas: HTMLCanvasElement
  -context: CanvasRenderingContext2D
  -cellSize: number = 32
  -colors: Map<PuyoColor, string>
  
  +constructor(canvas: HTMLCanvasElement)
  +render(game: Game): void
  +renderField(field: Field): void
  +renderPuyo(puyo: Puyo): void
  +renderScore(score: number): void
  +renderGameOver(): void
  +clear(): void
}

@enduml
```

## データフロー図

```plantuml
@startuml "データフロー図"

skinparam linetype ortho

rectangle "Input Layer" {
  [InputManager] as input
}

rectangle "Game Logic Layer" {
  [Game] as game
  [PuyoPair] as pair
  [Field] as field
  [Score] as score
}

rectangle "Render Layer" {
  [Renderer] as render
}

rectangle "Data Layer" {
  [Puyo] as puyo
  [Position] as pos
}

input --> game : "ユーザー入力"
game --> pair : "ぷよ操作"
game --> field : "フィールド操作"
game --> score : "スコア更新"
pair --> puyo : "ぷよ生成・移動"
field --> puyo : "ぷよ配置・取得"
puyo --> pos : "位置管理"
game --> render : "描画要求"
render --> field : "フィールド状態取得"
render --> puyo : "ぷよ情報取得"

@enduml
```

## エンティティ関係図

```plantuml
@startuml "エンティティ関係図"

Game ||--|| Field : contains
Game ||--o| PuyoPair : controls
Game ||--|| Score : manages
Game ||--|| InputManager : uses
Game ||--|| Renderer : uses

Field ||--o{ Puyo : contains
PuyoPair ||--|| Puyo : "main puyo"
PuyoPair ||--|| Puyo : "sub puyo"
Puyo ||--|| Position : has
Puyo ||--|| PuyoColor : has

@enduml
```

## 制約と規則

### フィールド制約
- フィールドサイズ: 6列 × 13行 (標準ぷよぷよサイズ)
- インデックス範囲: x=[0,5], y=[0,12]
- 初期位置: x=2, y=1 (列2, 行1)

### ぷよ制約
- 色数: 5色 (赤、青、緑、黄、紫)
- 消去条件: 同色4個以上の隣接
- ペア構成: メイン1個 + サブ1個

### スコア計算規則
- 基本点: 消去ぷよ数 × 10点
- 連鎖ボーナス: 2^(連鎖数-1) 倍
- 全消しボーナス: 2000点

### 操作制約
- 移動: 左右のみ（フィールド境界制限あり）
- 回転: 時計回り・反時計回り（壁キック対応）
- 落下: 自動落下 + 高速落下

## データ永続化

このゲームでは以下のデータを永続化します：

- **セッション中**: メモリ上でゲーム状態を管理
- **ゲーム終了時**: 最高スコアをローカルストレージに保存（オプション）

## パフォーマンス考慮事項

- **フィールド探索**: 深度優先探索（DFS）による接続ぷよ検索
- **描画最適化**: 変更された部分のみ再描画
- **メモリ管理**: 不要なオブジェクトの適切な解放
- **計算最適化**: 連鎖処理時の効率的なアルゴリズム使用