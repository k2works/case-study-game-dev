# アーキテクチャ設計

## 概要

ぷよぷよゲームは、レイヤードアーキテクチャを採用し、関心事の分離と依存関係の明確化を図ります。TypeScriptとReactを使用したWebアプリケーションとして実装します。

## アーキテクチャ全体図

```plantuml
@startuml "ぷよぷよゲームアーキテクチャ"
!define RECTANGLE class

' プレゼンテーション層
package "Presentation Layer" #FFDAB9 {
  RECTANGLE App
  RECTANGLE GameBoard
  RECTANGLE ScoreDisplay
  RECTANGLE Controls
  RECTANGLE GameOverScreen
}

' アプリケーション層
package "Application Layer" #E0E0FF {
  RECTANGLE GameController
  RECTANGLE InputHandler
  RECTANGLE ScoreCalculator
  RECTANGLE ChainDetector
}

' ドメイン層
package "Domain Layer" #FFE0E0 {
  RECTANGLE Game
  RECTANGLE Field
  RECTANGLE Puyo
  RECTANGLE PuyoPair
  RECTANGLE Chain
  RECTANGLE Score
}

' インフラストラクチャ層
package "Infrastructure Layer" #E0FFE0 {
  RECTANGLE LocalStorage
  RECTANGLE AnimationEngine
  RECTANGLE SoundManager
  RECTANGLE TouchEventAdapter
}

' 依存関係
App --> GameController
GameBoard --> Field
ScoreDisplay --> Score
Controls --> InputHandler
GameOverScreen --> Game

GameController --> Game
GameController --> Field
GameController --> Score
InputHandler --> PuyoPair
ScoreCalculator --> Chain
ScoreCalculator --> Score
ChainDetector --> Field
ChainDetector --> Chain

Game --> Field
Game --> PuyoPair
Game --> Score
Field --> Puyo
PuyoPair --> Puyo
Chain --> Puyo

GameController ..> LocalStorage : use
GameBoard ..> AnimationEngine : use
Controls ..> TouchEventAdapter : use
GameController ..> SoundManager : use

@enduml
```

## レイヤー構成

### 1. プレゼンテーション層（Presentation Layer）

**責任:**

- ユーザーインターフェースの表示
- ユーザー入力の受け付け
- ゲーム状態の視覚的表現

**主要コンポーネント:**

- `App`: アプリケーションのルートコンポーネント
- `GameBoard`: ゲームフィールドの表示
- `ScoreDisplay`: スコア・連鎖数の表示
- `Controls`: 操作ボタン（モバイル用）
- `GameOverScreen`: ゲームオーバー画面

### 2. アプリケーション層（Application Layer）

**責任:**
- ユースケースの実装
- ドメインロジックの調整
- 入力の変換と検証

**主要コンポーネント:**

- `GameController`: ゲーム全体の制御
- `InputHandler`: キーボード・タッチ入力の処理
- `ScoreCalculator`: スコア計算ロジック
- `ChainDetector`: 連鎖検出ロジック

### 3. ドメイン層（Domain Layer）

**責任:**
- ビジネスロジックの実装
- ゲームルールの表現
- ドメインモデルの管理

**主要コンポーネント:**

- `Game`: ゲーム全体の状態管理
- `Field`: フィールドの状態管理
- `Puyo`: 個々のぷよ
- `PuyoPair`: 落下中のぷよペア
- `Chain`: 連鎖情報
- `Score`: スコア情報

### 4. インフラストラクチャ層（Infrastructure Layer）

**責任:**
- 外部システムとの連携
- 技術的な実装詳細
- クロスカッティングな関心事

**主要コンポーネント:**

- `LocalStorage`: ハイスコアの保存
- `AnimationEngine`: アニメーション制御
- `SoundManager`: 効果音・BGMの管理
- `TouchEventAdapter`: タッチイベントの抽象化

## 設計原則

### 1. 依存関係逆転の原則（DIP）
- 上位レイヤーは下位レイヤーに依存しない
- 具象クラスではなくインターフェースに依存する
- ドメイン層は他のレイヤーに依存しない

### 2. 単一責任の原則（SRP）
- 各クラスは単一の責任を持つ
- 変更理由は1つに限定される

### 3. 開放閉鎖の原則（OCP）
- 拡張に対して開いている
- 修正に対して閉じている

### 4. インターフェース分離の原則（ISP）
- クライアントが使用しないメソッドに依存しない
- 特定の目的に特化したインターフェースを提供

### 5. リスコフの置換原則（LSP）
- 派生クラスは基底クラスと置換可能

## データフロー

```plantuml
@startuml "データフロー図"
actor Player
participant "Presentation\nLayer" as P
participant "Application\nLayer" as A
participant "Domain\nLayer" as D
participant "Infrastructure\nLayer" as I

Player -> P: キー入力/タッチ
P -> A: 入力イベント
A -> D: コマンド実行
D -> D: 状態更新
D --> A: 状態変更通知
A -> A: 連鎖検出・スコア計算
A --> P: 表示更新
P -> I: アニメーション要求
I --> P: アニメーション実行
P --> Player: 画面更新

@enduml
```

## 技術選定

### フロントエンド
- **TypeScript**: 型安全性とIDEサポート
- **React**: コンポーネントベースUI
- **CSS Modules**: スタイルのスコープ管理
- **Canvas API**: ゲームグラフィックス描画

### 状態管理
- **React Context API**: グローバル状態管理
- **useReducer**: 複雑な状態更新ロジック

### ビルドツール
- **Vite**: 高速な開発サーバーとビルド
- **ESLint**: コード品質管理
- **Prettier**: コードフォーマット

### テスティング
- **Vitest**: 単体テスト
- **React Testing Library**: コンポーネントテスト
- **Playwright**: E2Eテスト

## 非技術的な設計決定

### パフォーマンス最適化
- Reactの仮想DOMを活用した効率的な再描画
- Canvas APIを使用したゲームフィールドの描画
- requestAnimationFrameを使用したスムーズなアニメーション

### 拡張性
- 新しいぷよの色や特殊ぷよの追加が容易
- ゲームモードの追加が可能
- AIプレイヤーの実装が可能な設計

### メンテナンス性
- レイヤー間の明確な境界
- 依存性注入によるテスタビリティの向上
- ドキュメントとコメントの充実