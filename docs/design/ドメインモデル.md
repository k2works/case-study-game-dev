# ドメインモデル設計

## 概要

ドメイン駆動設計（DDD）の原則に基づき、ぷよぷよゲームのドメインモデルを設計します。ビジネスロジックを集約し、ドメインの知識を表現します。

## ドメインモデル全体図

```plantuml
@startuml "ドメインモデル図"

' 集約の定義
package "Game Aggregate" #FFE0E0 {
  class Game <<Aggregate Root>> {
    - id: GameId
    - status: GameStatus
    - field: Field
    - currentPair: PuyoPair
    - nextQueue: NextQueue
    - score: Score
    - chainCounter: ChainCounter
    + start(): void
    + pause(): void
    + resume(): void
    + end(): void
    + movePair(direction: Direction): void
    + rotatePair(): void
    + dropPair(): void
    + hardDrop(): void
  }
  
  class GameStatus <<Value Object>> {
    - value: string
    + isPlaying(): boolean
    + isGameOver(): boolean
    + canAcceptInput(): boolean
  }
  
  class Score <<Entity>> {
    - value: number
    - chainBonus: number
    - zenkeshiBonus: number
    + add(points: number): void
    + addChainBonus(chain: number): void
    + addZenkeshiBonus(): void
    + getValue(): number
  }
  
  class NextQueue <<Entity>> {
    - queue: PuyoPair[]
    + peek(): PuyoPair
    + dequeue(): PuyoPair
    + enqueue(pair: PuyoPair): void
    + getVisible(): PuyoPair[]
  }
}

package "Puyo Aggregate" #E0FFE0 {
  class Field <<Aggregate Root>> {
    - grid: Grid
    - width: number
    - height: number
    + placePuyo(puyo: Puyo, x: number, y: number): void
    + removePuyo(x: number, y: number): void
    + findConnectedPuyos(x: number, y: number): Puyo[]
    + applyGravity(): void
    + isEmpty(): boolean
    + isValidPosition(x: number, y: number): boolean
    + getAt(x: number, y: number): Puyo | null
  }
  
  class Puyo <<Entity>> {
    - id: PuyoId
    - color: PuyoColor
    - position: Position
    + getColor(): PuyoColor
    + setPosition(position: Position): void
    + isSameColor(other: Puyo): boolean
  }
  
  class PuyoPair <<Entity>> {
    - centerPuyo: Puyo
    - rotatePuyo: Puyo
    - rotation: Rotation
    - position: Position
    + rotate(): void
    + move(direction: Direction): void
    + getPositions(): Position[]
    + canRotate(field: Field): boolean
    + canMove(direction: Direction, field: Field): boolean
  }
  
  class PuyoColor <<Value Object>> {
    - value: string
    + equals(other: PuyoColor): boolean
    + toString(): string
  }
  
  class Position <<Value Object>> {
    - x: number
    - y: number
    + add(offset: Position): Position
    + equals(other: Position): boolean
    + isValid(width: number, height: number): boolean
  }
  
  class Rotation <<Value Object>> {
    - degree: number
    + next(): Rotation
    + getOffset(): Position
  }
}

package "Chain Aggregate" #E0E0FF {
  class ChainDetector <<Domain Service>> {
    + detectChains(field: Field): Chain[]
    + findErasablePuyos(field: Field): Puyo[][]
  }
  
  class Chain <<Entity>> {
    - chainNumber: number
    - erasedGroups: PuyoGroup[]
    - bonus: ChainBonus
    + getChainNumber(): number
    + getErasedCount(): number
    + calculateBonus(): number
  }
  
  class PuyoGroup <<Value Object>> {
    - puyos: Puyo[]
    - color: PuyoColor
    + size(): number
    + isErasable(): boolean
    + getPuyos(): Puyo[]
  }
  
  class ChainBonus <<Value Object>> {
    - chainMultiplier: number
    - colorBonus: number
    - connectionBonus: number
    + calculate(): number
  }
  
  class ChainCounter <<Entity>> {
    - currentChain: number
    - maxChain: number
    + increment(): void
    + reset(): void
    + getMax(): number
  }
}

' 関係の定義
Game *-- GameStatus
Game *-- Score
Game *-- NextQueue
Game --> Field
Game --> PuyoPair
Game --> ChainCounter

Field *-- Puyo
Field --> Position

Puyo *-- PuyoColor
Puyo *-- Position

PuyoPair *-- Puyo
PuyoPair *-- Rotation
PuyoPair --> Position

ChainDetector --> Field
ChainDetector --> Chain

Chain *-- PuyoGroup
Chain *-- ChainBonus

PuyoGroup --> Puyo
PuyoGroup --> PuyoColor

@enduml
```

## 集約（Aggregate）詳細

### 1. Game集約

**責任:**

- ゲーム全体の状態管理
- ゲームフローの制御
- プレイヤー操作の受付と実行

**主要メソッド:**

```typescript
interface Game {
  // ゲーム制御
  start(): void;
  pause(): void;
  resume(): void;
  end(): void;
  
  // プレイヤー操作
  movePair(direction: Direction): void;
  rotatePair(): void;
  dropPair(): void;
  hardDrop(): void;
  
  // 状態確認
  getStatus(): GameStatus;
  getScore(): number;
  canAcceptInput(): boolean;
}
```

### 2. Puyo集約

**責任:**
- フィールドの状態管理
- ぷよの配置と削除
- 物理演算（重力）の適用

**主要メソッド:**

```typescript
interface Field {
  // ぷよ操作
  placePuyo(puyo: Puyo, x: number, y: number): void;
  removePuyo(x: number, y: number): void;
  
  // 状態確認
  getAt(x: number, y: number): Puyo | null;
  isEmpty(): boolean;
  isValidPosition(x: number, y: number): boolean;
  
  // 連結検出
  findConnectedPuyos(x: number, y: number): Puyo[];
  
  // 物理演算
  applyGravity(): void;
}
```

### 3. Chain集約

**責任:**

- 連鎖の検出
- 消去対象の特定
- ボーナス計算

**主要メソッド:**

```typescript
interface ChainDetector {
  detectChains(field: Field): Chain[];
  findErasablePuyos(field: Field): Puyo[][];
}

interface Chain {
  getChainNumber(): number;
  getErasedCount(): number;
  calculateBonus(): number;
}
```

## ドメインサービス

### ChainDetector
フィールドの状態から連鎖を検出する責任を持つドメインサービス。複数の集約にまたがるロジックを実装。

```typescript
class ChainDetector {
  detectChains(field: Field): Chain[] {
    const chains: Chain[] = [];
    let chainNumber = 0;
    
    while (true) {
      const erasableGroups = this.findErasablePuyos(field);
      if (erasableGroups.length === 0) break;
      
      chainNumber++;
      const chain = new Chain(chainNumber, erasableGroups);
      chains.push(chain);
      
      // ぷよを消去
      erasableGroups.forEach(group => {
        group.forEach(puyo => field.removePuyo(puyo.x, puyo.y));
      });
      
      // 重力を適用
      field.applyGravity();
    }
    
    return chains;
  }
}
```

## ドメインイベント

```plantuml
@startuml "ドメインイベント"

class DomainEvent <<interface>> {
  + eventId: string
  + occurredAt: Date
  + aggregateId: string
}

class GameStarted implements DomainEvent {
  + gameId: string
}

class PuyoPlaced implements DomainEvent {
  + gameId: string
  + position: Position
  + color: PuyoColor
}

class PuyosErased implements DomainEvent {
  + gameId: string
  + erasedPuyos: Puyo[]
  + chainNumber: number
}

class ChainOccurred implements DomainEvent {
  + gameId: string
  + chainNumber: number
  + bonus: number
}

class GameOver implements DomainEvent {
  + gameId: string
  + finalScore: number
  + maxChain: number
}

class ZenkeshiAchieved implements DomainEvent {
  + gameId: string
  + bonus: number
}

@enduml
```

## ユビキタス言語

| 用語 | 説明 |
|------|------|
| ぷよ (Puyo) | ゲームの基本単位となる色付きブロック |
| 組ぷよ (PuyoPair) | 2個1組で落下するぷよのペア |
| フィールド (Field) | ぷよを配置する6×13のグリッド |
| 連鎖 (Chain) | ぷよ消去後の落下により新たな消去が発生すること |
| 全消し (Zenkeshi) | フィールド上のすべてのぷよを消去すること |
| ネクスト (Next) | 次に落下するぷよの予告 |
| ゴースト (Ghost) | 落下予測位置の表示 |
| 壁蹴り (Wall Kick) | 回転時の位置調整 |
| ハードドロップ (Hard Drop) | 即座に着地させる操作 |

## エラー処理戦略

### ドメイン例外

```typescript
class DomainException extends Error {
  constructor(message: string) {
    super(message);
    this.name = this.constructor.name;
  }
}

class InvalidMoveException extends DomainException {}
class InvalidRotationException extends DomainException {}
class GameOverException extends DomainException {}
class InvalidPositionException extends DomainException {}
```

### エラー処理方針

1. **不正な操作**: 例外をスローせず、操作を無視
2. **ゲームオーバー**: GameOverExceptionをスロー
3. **システムエラー**: 上位層でキャッチして適切に処理
4. **状態不整合**: ログ記録して安全な状態にロールバック

## パフォーマンス最適化

### 連結検出の最適化
- Union-Findアルゴリズムを使用した効率的な連結検出
- メモ化による重複計算の削減

### イベント処理の最適化
- イベントのバッチ処理
- 非同期イベント処理によるUI応答性の向上

### メモリ使用の最適化
- 不要になったぷよオブジェクトの即座の削除
- オブジェクトプールパターンによる頻繁な生成・破棄の回避