import type { GamePort } from './application/ports/GamePort'
import type { GameViewModel } from './application/viewmodels/GameViewModel'
import type { AISettings } from './domain/models/ai'
import { defaultContainer } from './infrastructure/di/DefaultContainer'
import { GameBoard } from './presentation/components/GameBoard'
import { GameInfo } from './presentation/components/GameInfo'
import { AIControlPanel } from './presentation/components/ai/AIControlPanel'
import { AutoLearningGameDashboard } from './presentation/components/ai/AutoLearningGameDashboard'
import { LearningDashboard } from './presentation/components/ai/LearningDashboard'
import { PerformanceAnalysis } from './presentation/components/ai/PerformanceAnalysis'
import { useAutoFall } from './presentation/hooks/useAutoFall'
import { useGameSystem } from './presentation/hooks/useGameSystem'
import { useKeyboard } from './presentation/hooks/useKeyboard'
import { useLearningSystem } from './presentation/hooks/useLearningSystem'

// сѓ▓сЃ╝сЃатѕХтЙАсЃюсѓ┐сЃ│сѓ│сЃ│сЃЮсЃ╝сЃЇсЃ│сЃѕ
const GameControlButtons = ({
  game,
  gameService,
  updateGame,
}: {
  game: GameViewModel
  gameService: GamePort
  updateGame: (game: GameViewModel) => void
}) => {
  return (
    <div className="mt-4 space-y-2">
      {game.state === 'ready' && (
        <button
          className="w-full py-2 px-4 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors"
          onClick={() => {
            const newGame = gameService.startNewGame()
            updateGame(newGame)
          }}
        >
          сѓ▓сЃ╝сЃажќІтДІ
        </button>
      )}
      {game.state === 'gameOver' && (
        <button
          className="w-full py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
          onClick={() => {
            const newGame = gameService.createReadyGame()
            updateGame(newGame)
          }}
        >
          сЃфсѓ╗сЃЃсЃѕ
        </button>
      )}
    </div>
  )
}

// сѓ┐сЃќсЃісЃЊсѓ▓сЃ╝сѓисЃДсЃ│сѓ│сЃ│сЃЮсЃ╝сЃЇсЃ│сЃѕ
const TabNavigation = ({
  currentTab,
  onTabChange,
}: {
  currentTab: 'game' | 'learning' | 'autoLearning' | 'analysis'
  onTabChange: (tab: 'game' | 'learning' | 'autoLearning' | 'analysis') => void
}) => {
  return (
    <div className="mb-8">
      <nav className="flex space-x-8">
        <button
          onClick={() => onTabChange('game')}
          className={`py-4 px-6 text-lg font-semibold rounded-t-lg transition-colors ${
            currentTab === 'game'
              ? 'bg-white/20 text-white border-b-2 border-blue-400'
              : 'text-white/60 hover:text-white/80 hover:bg-white/10'
          }`}
        >
          ­Ъј« сѓ▓сЃ╝сЃа
        </button>
        <button
          onClick={() => onTabChange('analysis')}
          className={`py-4 px-6 text-lg font-semibold rounded-t-lg transition-colors ${
            currentTab === 'analysis'
              ? 'bg-white/20 text-white border-b-2 border-purple-400'
              : 'text-white/60 hover:text-white/80 hover:bg-white/10'
          }`}
        >
          ­ЪЊі сЃЉсЃЋсѓЕсЃ╝сЃъсЃ│сѓ╣тѕєТъљ
        </button>
        <button
          onClick={() => onTabChange('autoLearning')}
          className={`py-4 px-6 text-lg font-semibold rounded-t-lg transition-colors ${
            currentTab === 'autoLearning'
              ? 'bg-white/20 text-white border-b-2 border-green-400'
              : 'text-white/60 hover:text-white/80 hover:bg-white/10'
          }`}
        >
          ­Ъџђ тГду┐њсЃЄсЃ╝сѓ┐
        </button>
        <button
          onClick={() => onTabChange('learning')}
          className={`py-4 px-6 text-lg font-semibold rounded-t-lg transition-colors ${
            currentTab === 'learning'
              ? 'bg-white/20 text-white border-b-2 border-blue-400'
              : 'text-white/60 hover:text-white/80 hover:bg-white/10'
          }`}
        >
          ­ЪДа AIтГду┐њ
        </button>
      </nav>
    </div>
  )
}

// сѓ▓сЃ╝сЃасЃгсѓцсѓбсѓдсЃѕсѓ│сЃ│сЃЮсЃ╝сЃЇсЃ│сЃѕ
const GameLayout = ({
  game,
  gameService,
  updateGame,
  handleReset,
  aiEnabled,
  aiSettings,
  onToggleAI,
  onAISettingsChange,
}: {
  game: GameViewModel
  gameService: GamePort
  updateGame: (game: GameViewModel) => void
  handleReset: () => void
  aiEnabled: boolean
  aiSettings: AISettings
  onToggleAI: () => void
  onAISettingsChange: (settings: AISettings) => void
}) => {
  return (
    <div className="max-w-4xl mx-auto">
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        {/* сѓ▓сЃ╝сЃаТЃЁта▒сЃЉсЃЇсЃФ */}
        <div className="lg:col-span-1">
          <div className="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
            <GameInfo game={game} onRestart={handleReset} />

            {/* AIсѓ│сЃ│сЃѕсЃГсЃ╝сЃФсЃЉсЃЇсЃФ */}
            <AIControlPanel
              aiEnabled={aiEnabled}
              aiSettings={aiSettings}
              onToggleAI={onToggleAI}
              onSettingsChange={onAISettingsChange}
            />

            {/* сѓ▓сЃ╝сЃатѕХтЙАсЃюсѓ┐сЃ│ */}
            <GameControlButtons
              game={game}
              gameService={gameService}
              updateGame={updateGame}
            />
          </div>
        </div>

        {/* сѓ▓сЃ╝сЃасЃюсЃ╝сЃЅ */}
        <div className="lg:col-span-2">
          <div className="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
            <GameBoard game={game} />
          </div>
        </div>
      </div>

      <footer className="text-center mt-8">
        <div className="bg-white/10 backdrop-blur-md rounded-xl p-4 border border-white/20 mb-4">
          <h3 className="text-white font-semibold mb-2">сѓГсЃ╝сЃюсЃ╝сЃЅТЊЇСйю</h3>
          <div className="grid grid-cols-2 gap-4 text-sm text-white/80">
            <div>
              <p>РєљРєњ: тидтЈ│уД╗тІЋ</p>
              <p>РєЊ: жФўжђЪУљйСИІ</p>
            </div>
            <div>
              <p>РєЉ/Space: тЏъУ╗б</p>
              <p>P: сЃЮсЃ╝сѓ║/тєЇжќІ</p>
              <p>R: сЃфсѓ╗сЃЃсЃѕ</p>
            </div>
          </div>
        </div>
        <p className="text-white/60 text-sm">
          сЃєсѓ╣сЃѕжДєтІЋжќІуЎ║сЂДСйюсѓЅсѓїсЂЪсЂисѓѕсЂисѓѕсѓ▓сЃ╝сЃа
        </p>
      </footer>
    </div>
  )
}

function App() {
  // DIсѓ│сЃ│сЃєсЃісЂІсѓЅсѓхсЃ╝сЃЊсѓ╣сѓњтЈќтЙЌ
  const gameService = defaultContainer.getGameService()
  const inputService = defaultContainer.getInputService()
  const aiService = defaultContainer.getAIService()
  const performanceService = defaultContainer.getPerformanceAnalysisService()
  const learningService = defaultContainer.getLearningService()
  const autoLearningGameService = defaultContainer.getAutoLearningGameService()

  // сѓ▓сЃ╝сЃасѓисѓ╣сЃєсЃа
  const gameSystem = useGameSystem(
    gameService,
    inputService,
    aiService,
    performanceService,
  )

  // тГду┐њсѓисѓ╣сЃєсЃа
  const learningSystem = useLearningSystem(learningService)

  // сЃЄсЃљсЃЃсѓ░ућесЂФE2EсЃєсѓ╣сЃѕсЂІсѓЅсѓбсѓ»сѓ╗сѓ╣тЈ»УЃйсЂФсЂЎсѓІ
  if (
    typeof window !== 'undefined' &&
    import.meta.env.NODE_ENV !== 'production'
  ) {
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    ;(window as any).gameService = gameService
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    ;(window as any).game = gameSystem.game
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    ;(window as any).setGame = gameSystem.updateGame
  }

  // УЄфтІЋУљйСИІТЕЪУЃйсѓњСй┐уће
  useAutoFall({
    game: gameSystem.game,
    updateGame: gameSystem.updateGame,
    fallSpeed: 1000, // 1уДњжќЊжџћсЂДУљйСИІ
  })

  // сѓГсЃ╝сЃюсЃ╝сЃЅтЁЦтіЏтЄдуљє№╝ѕAIуёАті╣ТЎѓсЂ«сЂ┐№╝Ѕ
  useKeyboard({
    onLeft: () => {
      if (!gameSystem.aiEnabled && gameSystem.game.state === 'playing') {
        const newGame = gameSystem.gameService.updateGameState(
          gameSystem.game,
          { type: 'MOVE_LEFT' },
        )
        gameSystem.updateGame(newGame)
      }
    },
    onRight: () => {
      if (!gameSystem.aiEnabled && gameSystem.game.state === 'playing') {
        const newGame = gameSystem.gameService.updateGameState(
          gameSystem.game,
          { type: 'MOVE_RIGHT' },
        )
        gameSystem.updateGame(newGame)
      }
    },
    onDown: () => {
      if (!gameSystem.aiEnabled && gameSystem.game.state === 'playing') {
        const newGame = gameSystem.gameService.updateGameState(
          gameSystem.game,
          { type: 'SOFT_DROP' },
        )
        gameSystem.updateGame(newGame)
      }
    },
    onRotate: () => {
      if (!gameSystem.aiEnabled && gameSystem.game.state === 'playing') {
        const newGame = gameSystem.gameService.updateGameState(
          gameSystem.game,
          { type: 'ROTATE_CLOCKWISE' },
        )
        gameSystem.updateGame(newGame)
      }
    },
    onPause: () => {
      if (gameSystem.game.state === 'playing') {
        const newGame = gameSystem.gameService.updateGameState(
          gameSystem.game,
          { type: 'PAUSE' },
        )
        gameSystem.updateGame(newGame)
      } else if (gameSystem.game.state === 'paused') {
        const newGame = gameSystem.gameService.updateGameState(
          gameSystem.game,
          { type: 'RESUME' },
        )
        gameSystem.updateGame(newGame)
      }
    },
    onReset: () => {
      gameSystem.handleReset()
    },
  })

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900 p-4">
      <div className="max-w-7xl mx-auto">
        <header className="text-center mb-8">
          <h1 className="text-4xl font-bold text-white mb-2">сЂисѓѕсЂисѓѕ</h1>
          <p className="text-blue-200">AIт»ЙТѕдсЂисѓѕсЂисѓѕсѓ▓сЃ╝сЃа & тГду┐њсѓисѓ╣сЃєсЃа</p>
        </header>

        <TabNavigation
          currentTab={learningSystem.currentTab}
          onTabChange={learningSystem.setCurrentTab}
        />

        {learningSystem.currentTab === 'game' ? (
          <GameLayout
            game={gameSystem.game}
            gameService={gameSystem.gameService}
            updateGame={gameSystem.updateGame}
            handleReset={gameSystem.handleReset}
            aiEnabled={gameSystem.aiEnabled}
            aiSettings={gameSystem.aiSettings}
            onToggleAI={gameSystem.handleToggleAI}
            onAISettingsChange={gameSystem.handleAISettingsChange}
          />
        ) : learningSystem.currentTab === 'learning' ? (
          <LearningDashboard
            isLearning={learningSystem.isLearning}
            learningProgress={learningSystem.learningProgress}
            currentModel={learningSystem.currentModel}
            latestPerformance={learningSystem.latestPerformance}
            learningHistory={learningSystem.learningHistory}
            onStartLearning={learningSystem.handleStartLearning}
            onStopLearning={learningSystem.handleStopLearning}
            onModelSelect={learningSystem.handleModelSelect}
            models={learningSystem.models}
            abTests={learningSystem.abTests}
            performanceStatistics={gameSystem.statistics}
            comparisonReport={gameSystem.comparisonReport}
            onStartABTest={learningSystem.handleStartABTest}
            onStopABTest={learningSystem.handleStopABTest}
            onCompareModels={learningSystem.handleCompareModels}
          />
        ) : learningSystem.currentTab === 'analysis' ? (
          <PerformanceAnalysis
            statistics={gameSystem.statistics}
            comparisonReport={gameSystem.comparisonReport}
            onResetData={gameSystem.resetData}
          />
        ) : (
          <AutoLearningGameDashboard
            autoLearningGameService={autoLearningGameService}
            className="max-w-7xl mx-auto"
          />
        )}
      </div>
    </div>
  )
}

export default App
