<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ぷよぷよ TDD</title>
    <!-- Google Fonts で日本語フォントを読み込む -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f0f0;
            font-family: 'Noto Sans JP', sans-serif;
        }
        #root {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        canvas {
            border: 1px solid #ccc;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Skiko が使用するフォントを指定 */
        @font-face {
            font-family: 'sans-serif';
            src: local('Noto Sans JP'), local('Meiryo'), local('MS Gothic'), local('Yu Gothic');
        }
    </style>
</head>
<body>
    <div id="root">
        <canvas id="ComposeTarget"></canvas>
    </div>
    <!-- Skiko を通常のスクリプトとして読み込む -->
    <script src="skiko.js"></script>
    <script>
        // Skiko の WASM 初期化を待つ
        console.log('Waiting for Skiko initialization...');

        // Skiko のグローバルオブジェクトから初期化完了を待つ
        function waitForSkiko() {
            // skiko オブジェクトと _initialize 関数が存在する場合は初期化を実行
            if (typeof window.skiko !== 'undefined' && typeof window.skiko._initialize === 'function') {
                console.log('Calling skiko._initialize()');
                const initPromise = window.skiko._initialize();
                if (initPromise && typeof initPromise.then === 'function') {
                    return initPromise;
                }
            }

            // WebAssembly.instantiateStreaming が完了するまで待つ
            return new Promise((resolve) => {
                const checkInterval = setInterval(() => {
                    // Paint 関数が利用可能になったか確認
                    if (typeof org_jetbrains_skia_Paint__1nMake !== 'undefined') {
                        console.log('Skiko WASM functions are available');
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 50);

                // タイムアウト (10秒)
                setTimeout(() => {
                    clearInterval(checkInterval);
                    console.log('Timeout waiting for Skiko, proceeding anyway...');
                    resolve();
                }, 10000);
            });
        }

        // 初期化を待ってからアプリケーションを読み込む
        waitForSkiko().then(() => {
            console.log('Skiko ready, loading application...');
            const script = document.createElement('script');
            script.src = './puyo-puyo-tdd.js';
            script.onload = () => console.log('Application loaded');
            script.onerror = (err) => console.error('Failed to load application:', err);
            document.body.appendChild(script);
        }).catch(err => {
            console.error('Skiko initialization failed:', err);
            document.getElementById('root').innerHTML = '<div style="padding: 20px; color: red;">Failed to initialize: ' + err.message + '</div>';
        });
    </script>
</body>
</html>
