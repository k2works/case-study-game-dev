module PuyoPuyo.Tests.Domain.ゲームロジックテスト

open Xunit
open FsUnit.Xunit
open PuyoPuyo.Domain

[<Fact>]
let ``ぷよペアを左に移動できる`` () =
    // Arrange
    let 盤面 = 盤面.作成 6<列> 13<行>
    let ぷよペア = ぷよペア.作成 3<列> 5<行> 赤 緑 0

    // Act
    let 結果 = ゲームロジック.ぷよペア移動を試行 盤面 ぷよペア 左

    // Assert
    match 結果 with
    | Some 移動後のペア ->
        移動後のペア.X座標 |> should equal 2
        移動後のペア.Y座標 |> should equal 5
    | None -> failwith "移動できるはずです"

[<Fact>]
let ``ぷよペアを右に移動できる`` () =
    // Arrange
    let 盤面 = 盤面.作成 6<列> 13<行>
    let ぷよペア = ぷよペア.作成 2<列> 5<行> 赤 緑 0

    // Act
    let 結果 = ゲームロジック.ぷよペア移動を試行 盤面 ぷよペア 右

    // Assert
    match 結果 with
    | Some 移動後のペア ->
        移動後のペア.X座標 |> should equal 3
        移動後のペア.Y座標 |> should equal 5
    | None -> failwith "移動できるはずです"

[<Fact>]
let ``左端では左に移動できない`` () =
    // Arrange
    let 盤面 = 盤面.作成 6<列> 13<行>
    let ぷよペア = ぷよペア.作成 0<列> 5<行> 赤 緑 0

    // Act
    let 結果 = ゲームロジック.ぷよペア移動を試行 盤面 ぷよペア 左

    // Assert
    結果 |> should equal None

[<Fact>]
let ``右端では右に移動できない`` () =
    // Arrange
    let 盤面 = 盤面.作成 6<列> 13<行>
    let ぷよペア = ぷよペア.作成 5<列> 5<行> 赤 緑 0

    // Act
    let 結果 = ゲームロジック.ぷよペア移動を試行 盤面 ぷよペア 右

    // Assert
    結果 |> should equal None

[<Fact>]
let ``空いている位置では回転できる`` () =
    // Arrange
    let 盤面 = 盤面.作成 6<列> 13<行>
    let ペア = ぷよペア.作成 2<列> 5<行> 赤 緑 0 // 回転状態0（上）

    // Act
    let 回転後 = ぷよペア.時計回り回転 ペア
    let 結果 = ゲームロジック.ぷよペア回転を試行 盤面 ペア 回転後

    // Assert
    match 結果 with
    | Some 回転後のペア -> 回転後のペア.回転状態 |> should equal 1
    | None -> failwith "回転できるはずです"

[<Fact>]
let ``壁に当たる位置では回転できない`` () =
    // Arrange
    let 盤面 = 盤面.作成 6<列> 13<行>
    let ペア = ぷよペア.作成 5<列> 5<行> 赤 緑 0 // 回転状態0（上）

    // Act
    let 回転後 = ぷよペア.時計回り回転 ペア // 回転状態1（右）になると列6になり範囲外
    let 結果 = ゲームロジック.ぷよペア回転を試行 盤面 ペア 回転後

    // Assert
    結果 |> should equal None

[<Fact>]
let ``右端で右向き回転のとき左にずらして回転できる`` () =
    // Arrange
    let 盤面 = 盤面.作成 6<列> 13<行>
    let ペア = ぷよペア.作成 5<列> 5<行> 赤 緑 0 // 回転状態0（上）、列5（右端）

    // Act
    let 結果 = ゲームロジック.ぷよペア壁キック回転 盤面 ペア ぷよペア.時計回り回転

    // Assert
    match 結果 with
    | Some 回転後のペア ->
        回転後のペア.回転状態 |> should equal 1 // 回転状態1（右）
        回転後のペア.X座標 |> should equal 4 // 左に1マスずらす
    | None -> failwith "壁キックで回転できるはずです"

[<Fact>]
let ``左端で左向き回転のとき右にずらして回転できる`` () =
    // Arrange
    let 盤面 = 盤面.作成 6<列> 13<行>
    let ペア = ぷよペア.作成 0<列> 5<行> 赤 緑 2 // 回転状態2（下）、列0（左端）

    // Act
    let 結果 = ゲームロジック.ぷよペア壁キック回転 盤面 ペア ぷよペア.時計回り回転

    // Assert
    match 結果 with
    | Some 回転後のペア ->
        回転後のペア.回転状態 |> should equal 3 // 回転状態3（左）
        回転後のペア.X座標 |> should equal 1 // 右に1マスずらす
    | None -> failwith "壁キックで回転できるはずです"

[<Fact>]
let ``ぷよペアを下に移動できる`` () =
    // Arrange
    let 盤面 = 盤面.作成 6<列> 13<行>
    let ペア = ぷよペア.作成 3<列> 5<行> 赤 緑 0

    // Act
    let 結果 = ゲームロジック.ぷよペア移動を試行 盤面 ペア 下

    // Assert
    match 結果 with
    | Some 移動後のペア ->
        移動後のペア.X座標 |> should equal 3
        移動後のペア.Y座標 |> should equal 6
    | None -> failwith "下に移動できるはずです"

[<Fact>]
let ``下端では下に移動できない`` () =
    // Arrange
    let 盤面 = 盤面.作成 6<列> 13<行>
    let ペア = ぷよペア.作成 3<列> 12<行> 赤 緑 0 // 回転状態0（上）、軸ぷよが y=12（下端）

    // Act
    let 結果 = ゲームロジック.ぷよペア移動を試行 盤面 ペア 下

    // Assert
    結果 |> should equal None

[<Fact>]
let ``下にぷよがある場合は移動できない`` () =
    // Arrange
    let 初期盤面 = 盤面.作成 6<列> 13<行>
    let 盤面 = 盤面.セル設定 初期盤面 3<列> 6<行> (埋まっている 青) // 軸ぷよの下（y=6）に障害物
    let ペア = ぷよペア.作成 3<列> 5<行> 赤 緑 0 // 軸ぷよ (3,5)、2つ目 (3,4)

    // Act
    let 結果 = ゲームロジック.ぷよペア移動を試行 盤面 ペア 下

    // Assert
    結果 |> should equal None

[<Fact>]
let ``新しいぷよを配置できない場合、ゲームオーバーになる`` () =
    // Arrange - ボードの上部（新しいぷよが配置される位置）にぷよを配置
    let _盤面 = 盤面.作成 6<列> 13<行>

    let 盤面 =
        _盤面
        |> (fun 盤 -> 盤面.セル設定 盤 2<列> 0<行> (埋まっている 赤))
        |> (fun 盤 -> 盤面.セル設定 盤 2<列> 1<行> (埋まっている 赤))

    // 新しいぷよペア（回転状態0: 軸ぷよ(2,1)、ぷよ2(2,0)）
    let newPiece = ぷよペア.作成 2<列> 1<行> 青 緑 0

    // Act - ゲームオーバー判定
    let ゲームオーバーか = ゲームロジック.ゲームオーバー判定 盤面 newPiece

    // Assert - ゲームオーバーになっていることを確認
    ゲームオーバーか |> should equal true

[<Fact>]
let ``新しいぷよを配置できる場合、ゲームオーバーにならない`` () =
    // Arrange - 空のボード
    let 盤面 = 盤面.作成 6<列> 13<行>

    // 新しいぷよペア（回転状態0: 軸ぷよ(2,1)、ぷよ2(2,0)）
    let newPiece = ぷよペア.作成 2<列> 1<行> 青 緑 0

    // Act - ゲームオーバー判定
    let ゲームオーバーか = ゲームロジック.ゲームオーバー判定 盤面 newPiece

    // Assert - ゲームオーバーにならないことを確認
    ゲームオーバーか |> should equal false

[<Fact>]
let ``ぷよペアの回転位置も考慮してゲームオーバー判定する`` () =
    // Arrange - ボードの上部にぷよを配置
    let _盤面 = 盤面.作成 6<列> 13<行>

    let 盤面 =
        _盤面
        |> (fun 盤 -> 盤面.セル設定 盤 2<列> 1<行> (埋まっている 赤)) // 回転後の位置にぷよがある

    // 新しいぷよペア（回転状態0: 軸ぷよ(2,1)、ぷよ2(2,0)）
    let newPiece = ぷよペア.作成 2<列> 1<行> 青 緑 0

    // Act - ゲームオーバー判定
    let ゲームオーバーか = ゲームロジック.ゲームオーバー判定 盤面 newPiece

    // Assert - ゲームオーバーになっていることを確認
    ゲームオーバーか |> should equal true

[<Fact>]
let ``ぷよが盤面の上部ギリギリでもゲームオーバーにならない`` () =
    // Arrange - ボードの下の方にぷよを配置
    let _盤面 = 盤面.作成 6<列> 13<行>

    let 盤面 =
        _盤面
        |> (fun 盤 -> 盤面.セル設定 盤 2<列> 11<行> (埋まっている 赤))

    // 新しいぷよペア（上部に配置される: 軸ぷよ(2,1)、ぷよ2(2,0)）
    let newPiece = ぷよペア.作成 2<列> 1<行> 青 緑 0

    // Act - ゲームオーバー判定
    let ゲームオーバーか = ゲームロジック.ゲームオーバー判定 盤面 newPiece

    // Assert - ゲームオーバーにならないことを確認
    ゲームオーバーか |> should equal false
