namespace PuyoPuyo.Domain

/// 移動方向
type 方向 =
    | 左
    | 右
    | 下

module ゲームロジック =
    open PuyoPuyo.Domain

    /// ぷよペアが指定位置に配置可能かチェック
    let private 位置が有効 (盤面: 盤面) (列: int<列>) (行: int<行>) : bool =
        行 >= 0<行>
        && 行 < 盤面.行数
        && 列 >= 0<列>
        && 列 < 盤面.列数
        && PuyoPuyo.Domain.盤面.セル取得 盤面 列 行 = 空

    /// ぷよペアが配置可能かチェック
    let ぷよペア配置可能 (盤面: 盤面) (ぷよペア: ぷよペア) : bool =
        let (位置1, 位置2) = PuyoPuyo.Domain.ぷよペア.位置取得 ぷよペア
        let (列1, 行1) = 位置1
        let (列2, 行2) = 位置2
        位置が有効 盤面 列1 行1 && 位置が有効 盤面 列2 行2

    /// ぷよペアを指定方向に移動試行
    let ぷよペア移動を試行 (盤面: 盤面) (ぷよペア: ぷよペア) (方向: 方向) : ぷよペア option =
        let (列差分, 行差分) =
            match 方向 with
            | 左 -> (-1<列>, 0<行>)
            | 右 -> (1<列>, 0<行>)
            | 下 -> (0<列>, 1<行>)

        let 新しいX座標 = ぷよペア.X座標 + 列差分
        let 新しいY座標 = ぷよペア.Y座標 + 行差分

        let 新しいぷよペア = { ぷよペア with X座標 = 新しいX座標; Y座標 = 新しいY座標 }

        if ぷよペア配置可能 盤面 新しいぷよペア then Some 新しいぷよペア else None

    /// ぷよペアの回転を試行
    let ぷよペア回転を試行 (盤面: 盤面) (元のぷよペア: ぷよペア) (回転後のぷよペア: ぷよペア) : ぷよペア option =
        if ぷよペア配置可能 盤面 回転後のぷよペア then Some 回転後のぷよペア else None

    /// ぷよペアの壁キック回転を試行
    let ぷよペア壁キック回転 (盤面: 盤面) (元のぷよペア: ぷよペア) (回転関数: ぷよペア -> ぷよペア) : ぷよペア option =
        let 回転後 = 回転関数 元のぷよペア

        // まず通常の回転を試す
        match ぷよペア回転を試行 盤面 元のぷよペア 回転後 with
        | Some _ as 結果 -> 結果
        | None ->
            // 左に1マスずらして回転を試す
            let 左にずらした回転後 = { 回転後 with X座標 = 回転後.X座標 - 1<列> }

            match ぷよペア回転を試行 盤面 元のぷよペア 左にずらした回転後 with
            | Some _ as 結果 -> 結果
            | None ->
                // 右に1マスずらして回転を試す
                let 右にずらした回転後 = { 回転後 with X座標 = 回転後.X座標 + 1<列> }

                ぷよペア回転を試行 盤面 元のぷよペア 右にずらした回転後

    /// 連鎖数に応じたスコアを計算
    let 連鎖スコア計算 (連鎖数: int) : int =
        match 連鎖数 with
        | 0 -> 0
        | 1 -> 40
        | 2 -> 80
        | 3 -> 160
        | 4 -> 320
        | n when n >= 5 -> 320 * (1 <<< (n - 5 + 1))
        | _ -> 0

    /// ゲームオーバー判定（新しいぷよを配置できるかチェック）
    let ゲームオーバー判定 (盤面: 盤面) (ぷよペア: ぷよペア) : bool =
        // 新しいぷよが配置できない場合はゲームオーバー
        not (ぷよペア配置可能 盤面 ぷよペア)
