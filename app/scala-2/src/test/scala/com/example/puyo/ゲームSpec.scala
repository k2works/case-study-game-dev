package com.example.puyo

import org.scalatest.flatspec.AnyFlatSpec
import org.scalatest.matchers.should.Matchers
import org.scalatest.BeforeAndAfterEach

class ゲームSpec extends AnyFlatSpec with Matchers with BeforeAndAfterEach:
  var ゲーム: ゲーム = _

  override def beforeEach(): Unit =
    ゲーム = new ゲーム()

  "ゲーム" should "初期化時に必要なコンポーネントを作成する" in {
    ゲーム.初期化()

    ゲーム.設定情報 should not be null
    ゲーム.ぷよ画像 should not be null
    ゲーム.ステージ should not be null
    ゲーム.プレイヤー should not be null
    ゲーム.スコア should not be null
  }

  it should "初期化時にゲームモードを新ぷよに設定する" in {
    ゲーム.初期化()

    ゲーム.モード shouldBe ゲームモード.新ぷよ
  }

  "連鎖反応" should "ぷよの消去と落下後、新たな消去パターンがあれば連鎖が発生する" in {
    ゲーム.初期化()

    val ステージ = ゲーム.ステージ

    // 赤ぷよを2×2の正方形に配置（消去対象）
    ステージ.ぷよを設定(1, 10, 1)
    ステージ.ぷよを設定(2, 10, 1)
    ステージ.ぷよを設定(1, 11, 1)
    ステージ.ぷよを設定(2, 11, 1)

    // 青ぷよを配置（赤ぷよ消去後に落下して連鎖を起こす）
    ステージ.ぷよを設定(3, 10, 2) // 横に1つ
    ステージ.ぷよを設定(2, 7, 2) // 上から縦に3つ
    ステージ.ぷよを設定(2, 8, 2)
    ステージ.ぷよを設定(2, 9, 2)

    // 最初の消去チェック（赤ぷよが4つ揃っている）
    val 初回消去情報 = ステージ.消去チェック()
    初回消去情報.erasePuyoCount shouldBe 4

    // 消去確認モードから開始
    ゲーム.モードを設定(ゲームモード.消去確認)

    // 1回目の更新：消去確認 → 落下確認（赤ぷよが消去される）
    ゲーム.更新を実行(0.0)
    ゲーム.モード shouldBe ゲームモード.落下確認

    // 落下と連鎖をループで実行
    var loopCount = 0
    var 連鎖が発生した = false
    while (ゲーム.モード != ゲームモード.新ぷよ) && loopCount < 20 do
      // 消去確認モードで2回目の消去をチェック
      if ゲーム.モード == ゲームモード.消去確認 then
        val 消去情報 = ステージ.消去チェック()
        if 消去情報.erasePuyoCount > 0 && loopCount > 0 then
          // 2回目以降の消去が発生したら連鎖成功
          連鎖が発生した = true
          消去情報.erasePuyoCount shouldBe 4

      ゲーム.更新を実行(0.0)
      loopCount += 1

    // 連鎖が発生したことを確認
    連鎖が発生した shouldBe true
  }

  it should "着地後、消去がない場合も浮いているぷよを落とす" in {
    ゲーム.初期化()

    val ステージ = ゲーム.ステージ

    // フィールドの最下行に赤ぷよを配置（軸ぷよの着地地点のみ）
    ステージ.ぷよを設定(2, 11, 1)
    // (3, 11)は空き → 2つ目のぷよが浮く

    // プレイヤーのぷよペアを手動で配置（横向き、回転状態1）
    // 軸ぷよ: (2, 10)、2つ目のぷよ: (3, 10)
    val 軸ぷよType = 2
    val 次ぷよType = 3
    ステージ.ぷよを設定(2, 10, 軸ぷよType)
    ステージ.ぷよを設定(3, 10, 次ぷよType)

    // 消去確認モードから開始（着地直後を模擬）
    ゲーム.モードを設定(ゲームモード.消去確認)

    // 1回目の更新：消去確認（消去なし、連鎖数==0）→ 落下確認
    ゲーム.更新を実行(0.0)
    ゲーム.モード shouldBe ゲームモード.落下確認

    // 2回目の更新：落下確認（浮いている2つ目のぷよが落ちる）→ 落下中
    ゲーム.更新を実行(0.0)
    ゲーム.モード shouldBe ゲームモード.落下中

    // 落下を繰り返して最終的にすべてのぷよが着地する
    var loopCount = 0
    while ゲーム.モード != ゲームモード.新ぷよ && loopCount < 10 do
      ゲーム.更新を実行(0.0)
      loopCount += 1

    // 最終的に新ぷよモードに移行することを確認
    ゲーム.モード shouldBe ゲームモード.新ぷよ

    // すべてのぷよが正しい位置に着地していることを確認
    ステージ.ぷよを取得(2, 11) shouldBe 1 // 元からあった赤ぷよ
    ステージ.ぷよを取得(2, 10) shouldBe 軸ぷよType // 軸ぷよは動かない
    ステージ.ぷよを取得(3, 10) shouldBe 0 // 2つ目のぷよは落ちた
    ステージ.ぷよを取得(3, 11) shouldBe 次ぷよType // 2つ目のぷよが最下段に着地
  }

  it should "新しいぷよを生成できない場合にゲームオーバーになる" in {
    ゲーム.初期化()

    val ステージ = ゲーム.ステージ
    val プレイヤー = ゲーム.プレイヤー

    // 初期位置 (2, 0) にぷよを配置してゲームオーバーを引き起こす
    ステージ.ぷよを設定(2, 0, 1)

    // 新ぷよモードから開始
    ゲーム.モードを設定(ゲームモード.新ぷよ)

    // 更新を実行
    ゲーム.更新を実行(0.0)

    // ゲームオーバーモードに移行していることを確認
    ゲーム.モード shouldBe ゲームモード.ゲームオーバー
  }
